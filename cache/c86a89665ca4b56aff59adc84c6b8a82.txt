<!----> <meta itemprop="headline" content="å‰ç«¯ä¹Ÿè¦æ‡‚ç‚¹k8s-ä¸Šç¯‡"> <meta itemprop="keywords" content="å‰ç«¯,Kubernetes"> <meta itemprop="datePublished" content="2025-05-03T11:19:44.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å»ä¼ªå­˜çœŸ"> <meta itemprop="url" content="https://juejin.cn/user/598569647873805"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å‰ç«¯ä¹Ÿè¦æ‡‚ç‚¹k8s-ä¸Šç¯‡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/598569647873805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å»ä¼ªå­˜çœŸ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-05-03T11:19:44.000Z" title="Sat May 03 2025 11:19:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-05-03
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""></circle></svg> <span class="views-count" data-v-61fb5e44="">
                    6,469
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""></path></svg>
                    é˜…è¯»9åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""></div> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><h3 data-id="heading-0">å‰è¨€</h3>
<p>æœ€è¿‘åœ¨é‡‡ç”¨Jenkinså®ç°å‰ç«¯é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²åŠŸèƒ½ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ­¥éª¤ç”¨åˆ°äº†k8s, è¿™ä¸€å—çŸ¥è¯†ä»¤æˆ‘æ„Ÿåˆ°æ¯”è¾ƒé™Œç”Ÿï¼Œçœ‹ä¸æ‡‚é…ç½®æ–‡ä»¶é‡Œçš„è¯­å¥å«ä¹‰ï¼Œä»¥åŠå¦‚ä½•è¢«å¤–éƒ¨çš„bashæŒ‡ä»¤ä¸²è”èµ·æ¥ï¼Œåˆšå¥½å‡æœŸæœ‰æ—¶é—´ï¼Œå†³å®šå­¦ä¹ ä¸€ä¸‹k8sã€‚å­¦å®Œç›®æ ‡æ˜¯å­¦å®Œä¹‹åè¦äº†è§£k8så¸¸ç”¨çš„æ“ä½œã€‚ç°åœ¨æˆ‘ä»¬è¿›å…¥ä»Šå¤©çš„ä¸»é¢˜:</p>
<h2 data-id="heading-1">ä¸€ã€Kubernetes ç®€ä»‹</h2>
<p>Kubernetesï¼ˆç®€ç§° K8sï¼‰æ˜¯ä¸€ä¸ªç”¨äº<strong>è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åº</strong>çš„å¼€æºç³»ç»Ÿã€‚ä¸‹å›¾å±•ç¤ºäº†Kubernetesé›†ç¾¤çš„æ¶æ„åŠå…¶ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’æ–¹å¼ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75697f0f9417479a8d3d1c3418f27b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675Lyq5a2Y55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1751896988&amp;x-signature=LB66Yb6CPgRB0%2F33Mnuz1Bce6v4%3D" alt="image.png" loading="lazy"></p>
<h3 data-id="heading-2">1.1 å¤–éƒ¨ç³»ç»Ÿï¼ˆExternal Systemsï¼‰</h3>
<ul>
<li>kubectl: è¿™æ˜¯Kubernetesçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å®ƒä¸Kubernetes APIæœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œå„ç§æ“ä½œå¦‚åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°èµ„æºã€‚</li>
<li>CI/CD Systems: æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ç³»ç»Ÿå¯ä»¥ä½¿ç”¨Kubernetes APIæ¥è‡ªåŠ¨åŒ–åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚</li>
<li>Apps Use SDK to connect to API server: åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨SDKè¿æ¥åˆ°Kubernetes APIæœåŠ¡å™¨ï¼Œä»¥å®ç°æ›´å¤æ‚çš„é›†æˆå’Œè‡ªåŠ¨åŒ–ã€‚</li>
</ul>
<h3 data-id="heading-3">1.2 Kubernetes é›†ç¾¤ï¼ˆKubernetes Clusterï¼‰</h3>
<p>Kubernetesé›†ç¾¤é‡‡ç”¨çš„æ˜¯<strong>ä¸»ä»æ¶æ„ï¼ˆMaster-Slave Architectureï¼‰</strong> ï¼Œä¸»è¦ç”±ä¸¤ä¸ªè§’è‰²ç»„æˆï¼š</p>
<ul>
<li><strong>æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰</strong> ï¼šè´Ÿè´£é›†ç¾¤çš„æ•´ä½“ç®¡ç†å’Œè°ƒåº¦ã€‚</li>
<li><strong>å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰</strong> ï¼šè´Ÿè´£å®é™…è¿è¡Œåº”ç”¨å®¹å™¨ã€‚</li>
</ul>
<h4 data-id="heading-4">1.2.1 æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰</h4>
<p>æ§åˆ¶å¹³é¢æ˜¯ Kubernetes çš„â€œå¤§è„‘â€ï¼Œä¸»è¦è´Ÿè´£æ¥æ”¶ç”¨æˆ·æŒ‡ä»¤ã€è°ƒåº¦ä»»åŠ¡ã€ç›‘æ§è¿è¡ŒçŠ¶æ€ã€‚å®ƒåŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š</p>





























<table><thead><tr><th>ç»„ä»¶</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>kube-apiserver</strong></td><td>Kubernetes APIæœåŠ¡å™¨ï¼Œæ‰€æœ‰è¯·æ±‚çš„ç»Ÿä¸€å…¥å£ï¼Œæä¾› HTTP REST æ¥å£ï¼Œå¤„ç†è®¤è¯ã€æˆæƒã€é€šä¿¡ç­‰</td></tr><tr><td><strong>etcd</strong></td><td>åˆ†å¸ƒå¼ Key-Value æ•°æ®åº“ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨é›†ç¾¤æ‰€æœ‰çŠ¶æ€æ•°æ®</td></tr><tr><td><strong>kube-scheduler</strong></td><td>è°ƒåº¦å™¨è´Ÿè´£å°†æ–°å»º Pod åˆ†é…åˆ°åˆé€‚çš„ Node</td></tr><tr><td><strong>kube-controller-manager</strong></td><td>æ§åˆ¶å™¨ç®¡ç†å™¨æ‰§è¡Œå„ç§æ§åˆ¶é€»è¾‘ï¼Œæ¯”å¦‚è¿è¡Œå¤šä¸ªæ§åˆ¶å™¨(å‰¯æœ¬æ§åˆ¶å™¨ï¼ˆReplicaSetï¼‰ã€èŠ‚ç‚¹æ§åˆ¶å™¨ã€Jobæ§åˆ¶å™¨ç­‰)</td></tr><tr><td><strong>cloud-controller-manager</strong></td><td>äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œç®¡ç†ä¸äº‘æœåŠ¡å¹³å°çš„é›†æˆï¼ˆå¦‚è´Ÿè½½å‡è¡¡ã€å­˜å‚¨å·ç­‰ï¼‰</td></tr></tbody></table>
<p>æ‰€æœ‰è¿™äº›ç»„ä»¶é€šå¸¸è¿è¡Œåœ¨ Master èŠ‚ç‚¹ä¸Šã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ§åˆ¶å¹³é¢å¯ä»¥åšé«˜å¯ç”¨éƒ¨ç½²ï¼ˆå³å¤šä¸ª Master èŠ‚ç‚¹ï¼‰ï¼š</p>
<ul>
<li>ä¿è¯ apiserver çš„å¯ç”¨æ€§ï¼ˆé€šè¿‡è´Ÿè½½å‡è¡¡ï¼‰</li>
<li>ä¿è¯ etcd çš„æ•°æ®å†—ä½™ä¸é«˜ä¸€è‡´æ€§ï¼ˆé€šå¸¸éƒ¨ç½² 3 ä¸ªåŠä»¥ä¸ŠèŠ‚ç‚¹ï¼‰</li>
<li>é¿å…å•ç‚¹æ•…éšœï¼Œå¢å¼ºå®¹ç¾èƒ½åŠ›</li>
</ul>
<h4 data-id="heading-5">1.2.2 å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰</h4>
<p>æ¯ä¸ª Node æ˜¯å®é™…è¿è¡Œå®¹å™¨çš„æœºå™¨ï¼ˆè™šæ‹Ÿæœºæˆ–ç‰©ç†æœºï¼‰ï¼Œå…¶æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š</p>





















<table><thead><tr><th>ç»„ä»¶</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>kubelet</strong></td><td>è´Ÿè´£ä¸ apiserver é€šä¿¡ï¼Œæ¥æ”¶ä»»åŠ¡å¹¶åœ¨æœ¬åœ°å¯åŠ¨ Pod</td></tr><tr><td><strong>kube-proxy</strong></td><td>ç»´æŠ¤æœåŠ¡ä¸ Pod ä¹‹é—´çš„ç½‘ç»œè§„åˆ™ï¼Œå®ç°è´Ÿè½½å‡è¡¡</td></tr><tr><td><strong>Container Runtime</strong></td><td>è¿è¡Œå®¹å™¨çš„å®é™…å¼•æ“ï¼Œå¦‚ Dockerã€containerdã€CRI-O</td></tr></tbody></table>
<h4 data-id="heading-6">1.2.3 äº‘æä¾›å•†APIs</h4>
<p>Kuberneteså¯ä»¥é€šè¿‡äº‘æä¾›å•†APIsä¸äº‘æœåŠ¡è¿›è¡Œé›†æˆï¼Œä¾‹å¦‚è´Ÿè½½å‡è¡¡å™¨ã€å­˜å‚¨å·å’Œèº«ä»½è®¤è¯ç­‰ã€‚è¿™ä½¿å¾—Kubernetesèƒ½å¤Ÿåˆ©ç”¨äº‘å¹³å°æä¾›çš„å„ç§æœåŠ¡æ¥å¢å¼ºå…¶åŠŸèƒ½ã€‚</p>
<h3 data-id="heading-7">1.3 k8så’Œdockerçš„å…³ç³»?</h3>
<p>k8så’Œdockerçš„ç”¨é€”éƒ½å«æœ‰å®¹å™¨ç®¡ç†ï¼Œåˆå­¦è€…ä¸€èˆ¬éƒ½æä¸æ¸…æ¥šä¸¤è€…ä¹‹é—´çš„å…³ç³»ã€‚å¯ä»¥ç†è§£ä¸ºï¼š<strong>Docker è´Ÿè´£é€ è½¦ï¼ŒKubernetes è´Ÿè´£è°ƒåº¦è½¦é˜Ÿè·‘èµ·æ¥å¹¶ä¿æŒç§©åº</strong>ã€‚</p>

















<table><thead><tr><th>åç§°</th><th>å®šä¹‰</th></tr></thead><tbody><tr><td><strong>Docker</strong></td><td>æ˜¯ä¸€ä¸ª<strong>å®¹å™¨å¼•æ“</strong>ï¼Œç”¨äºæ‰“åŒ…ã€åˆ†å‘å’Œè¿è¡Œå®¹å™¨åŒ–åº”ç”¨ã€‚</td></tr><tr><td><strong>Kubernetes</strong></td><td>æ˜¯ä¸€ä¸ª<strong>å®¹å™¨ç¼–æ’å¹³å°</strong>ï¼Œç”¨äºè‡ªåŠ¨åŒ–ç®¡ç†å¤§é‡å®¹å™¨çš„éƒ¨ç½²ã€è°ƒåº¦ã€ä¼¸ç¼©å’Œç»´æŠ¤ã€‚</td></tr></tbody></table>
<p><strong>Docker ç®¡ç†å•ä¸ªå®¹å™¨ï¼ŒKubernetes ç®¡ç†å®¹å™¨çš„é›†ç¾¤</strong>ï¼›å®ƒä»¬å„å¸å…¶èŒï¼Œå…±åŒæ„æˆäº†ç°ä»£äº‘åŸç”Ÿåº”ç”¨çš„åŸºçŸ³ã€‚</p>






























<table><thead><tr><th>ç»´åº¦</th><th>Docker</th><th>Kubernetes</th></tr></thead><tbody><tr><td>ç±»å‹</td><td>å®¹å™¨è¿è¡Œæ—¶</td><td>å®¹å™¨ç¼–æ’å¹³å°</td></tr><tr><td>æ˜¯å¦ä¾èµ–å¯¹æ–¹</td><td>ä¸ä¾èµ–</td><td>æ—©æœŸä¾èµ– Dockerï¼ŒåæœŸä¾èµ– CRI æ¥å£</td></tr><tr><td>ç®¡ç†ç²’åº¦</td><td>å•ä¸ªå®¹å™¨</td><td>å¤šä¸ªæœåŠ¡æˆ–å®¹å™¨ç»„æˆçš„é›†ç¾¤</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å¼€å‘ã€æµ‹è¯•ã€å•æœºéƒ¨ç½²</td><td>ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤éƒ¨ç½²</td></tr></tbody></table>
<h3 data-id="heading-8">1.4 å·¥ä½œæµç¨‹</h3>
<ol>
<li>å¼€å‘è€…é€šè¿‡ kubectl æäº¤ YAML æ¸…å•åˆ° apiserverã€‚</li>
<li>apiserver éªŒè¯è¯·æ±‚ï¼Œå¹¶å°†ä¿¡æ¯å­˜å‚¨åˆ° etcdã€‚</li>
<li>scheduler ç›‘å¬åˆ°æ–° Pod åˆ›å»ºè¯·æ±‚ï¼Œå¹¶æ ¹æ®è°ƒåº¦ç®—æ³•åˆ†é…åˆ°åˆé€‚çš„ Nodeã€‚</li>
<li>å¯¹åº” Node ä¸Šçš„ kubelet æ¥æ”¶åˆ°ä»»åŠ¡ï¼Œè°ƒç”¨ Container Runtime å¯åŠ¨å®¹å™¨ã€‚</li>
<li>kube-proxy è®¾ç½®å¥½æœåŠ¡å‘ç°å’Œè®¿é—®è§„åˆ™ï¼Œç¡®ä¿å†…éƒ¨é€šä¿¡æ­£å¸¸ã€‚</li>
</ol>
<h2 data-id="heading-9">äºŒã€æ­å»º Kubernetes ç¯å¢ƒ</h2>
<p>æ ¹æ®ä½¿ç”¨åœºæ™¯ä¸åŒ,k8sæœ‰ä¸‰ç§æ­å»ºæ–¹å¼ã€‚ä¸‰ç§æ­å»ºæ–¹å¼çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>





























<table><thead><tr><th>æ­å»ºæ–¹å¼</th><th>åœºæ™¯</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>1. ä½¿ç”¨ Minikube æˆ– kind</td><td>å­¦ä¹ å’Œå¼€å‘</td><td>å¿«é€Ÿå¯åŠ¨ã€èµ„æºå ç”¨å°‘</td><td>éçœŸå®ç”Ÿäº§ç¯å¢ƒ</td></tr><tr><td>2. ä½¿ç”¨ kubeadm è‡ªå»ºé›†ç¾¤</td><td>ä¸­å°å‹ç”Ÿäº§ç¯å¢ƒæˆ–æµ‹è¯•</td><td>å¯æ§æ€§å¼ºã€æ¥è¿‘ç”Ÿäº§</td><td>é…ç½®å¤æ‚ï¼Œéœ€è‡ªè¡Œè¿ç»´</td></tr><tr><td>3. ä½¿ç”¨äº‘å‚å•†æ‰˜ç®¡æœåŠ¡ï¼ˆå¦‚ ACKã€GKEã€EKSï¼‰</td><td>ç”Ÿäº§</td><td>ç®€å•å¯é ã€é«˜å¯ç”¨</td><td>æˆæœ¬è¾ƒé«˜ã€ä¾èµ–å‚å•†</td></tr></tbody></table>
<p>ç”±äºç¯‡å¹…æ‰€é™ï¼Œæœ¬æ–‡åªæ¼”ç¤ºä¸€ä¸‹ç¬¬ä¸€ç§æ­å»ºk8sç¯å¢ƒçš„æ–¹å¼ï¼ˆä»¥ macOS / Linux ä¸ºä¾‹ï¼‰:</p>
<h3 data-id="heading-10">2.1 å®‰è£… kubectlï¼ˆKubernetes å‘½ä»¤è¡Œå·¥å…·ï¼‰</h3>
<pre><code class="hljs language-bash" lang="bash">curl -LO <span class="hljs-string">"https://dl.k8s.io/release/<span class="hljs-subst">$(curl -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl"</span>
<span class="hljs-built_in">chmod</span> +x kubectl
sudo <span class="hljs-built_in">mv</span> kubectl /usr/local/bin/
kubectl version --client
</code></pre>
<h3 data-id="heading-11">2.2 å®‰è£… Minikube</h3>
<pre><code class="hljs language-bash" lang="bash">curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
</code></pre>
<h3 data-id="heading-12">2.3 å¯åŠ¨ Minikube é›†ç¾¤</h3>
<pre><code class="hljs language-bash" lang="bash">minikube start
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e4415c9ea2b4173b12876aabd40f935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675Lyq5a2Y55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1751896988&amp;x-signature=ezH4U6PnFBw1nW2wrkRyLzg0bl8%3D" alt="image.png" loading="lazy"></p>
<h3 data-id="heading-13">2.4 æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€</h3>
<pre><code class="hljs language-bash" lang="bash">kubectl get nodes
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/529bbd74734f4d1f93d9896082b7f45c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675Lyq5a2Y55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1751896988&amp;x-signature=7G0RraYDPaK55beL7Iw%2FlD4ACno%3D" alt="image.png" loading="lazy"></p>
<h2 data-id="heading-14">ä¸‰ã€å¸¸ç”¨èµ„æºå¯¹è±¡ä»‹ç»</h2>
<p>Kubernetes ä¸­èµ„æºç§ç±»å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ï¼š</p>

































<table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Pod</td><td>æœ€å°éƒ¨ç½²å•å…ƒ</td></tr><tr><td>Deployment</td><td>éƒ¨ç½²ä¸ç‰ˆæœ¬æ§åˆ¶</td></tr><tr><td>Service</td><td>ç½‘ç»œè®¿é—®å…¥å£</td></tr><tr><td>ConfigMap / Secret</td><td>é…ç½®å’Œå¯†é’¥</td></tr><tr><td>PersistentVolume / Claim</td><td>å­˜å‚¨</td></tr><tr><td>Namespace</td><td>å‘½åç©ºé—´ç®¡ç†</td></tr></tbody></table>
<h3 data-id="heading-15">3.1 Podï¼šæœ€å°éƒ¨ç½²å•å…ƒ</h3>
<h4 data-id="heading-16">3.1.1 ä»€ä¹ˆæ˜¯Podï¼Ÿ</h4>
<p>Pod æ˜¯ K8s ä¸­æœ€å°çš„å¯è°ƒåº¦å•å…ƒã€‚ä¸€ä¸ª Pod åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª <strong>å®¹å™¨ï¼ˆé€šå¸¸æ˜¯ Docker å®¹å™¨ï¼‰</strong> ï¼Œè¿™äº›å®¹å™¨å…±äº«ï¼š</p>
<ul>
<li>ç½‘ç»œï¼ˆIP å’Œç«¯å£ç©ºé—´ï¼‰</li>
<li>å­˜å‚¨ï¼ˆVolume å·ï¼‰</li>
<li>ç”Ÿå‘½å‘¨æœŸï¼ˆè¢«è§†ä¸ºä¸€ä¸ªæ•´ä½“ï¼‰</li>
</ul>
<p>Pod çš„å…¸å‹ç”¨é€”æ˜¯è¿è¡Œä¸€ä¸ªåº”ç”¨æˆ–æœåŠ¡çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸€ä¸ª Pod è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼ˆæœ€å¸¸è§åœºæ™¯ï¼‰ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.24</span>
      <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
</code></pre>
<p>è¿™ä¸ª Pod ä¼šå¯åŠ¨ä¸€ä¸ª Nginx å®¹å™¨ï¼Œå¹¶æš´éœ² 80 ç«¯å£ã€‚</p>
<h4 data-id="heading-17">3.1.2 Pod ç”Ÿå‘½å‘¨æœŸ</h4>
<p>Pod çš„çŠ¶æ€åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>Pending</code>: ç­‰å¾…è°ƒåº¦èµ„æº</li>
<li><code>Running</code>: æ­£åœ¨è¿è¡Œ</li>
<li><code>Succeeded</code>: è¿è¡ŒæˆåŠŸåé€€å‡º</li>
<li><code>Failed</code>: è¿è¡Œå¤±è´¥</li>
<li><code>Unknown</code>: çŠ¶æ€æ— æ³•è·å–</li>
</ul>
<h4 data-id="heading-18">3.1.3 Podçš„åˆ›å»ºï¼ŒæŸ¥çœ‹ä¸åˆ é™¤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># åˆ›å»º</span>
kubectl apply -f nginx-pod.yaml
<span class="hljs-comment"># æŸ¥çœ‹æ‰€æœ‰pod</span>
kubectl get pods
<span class="hljs-comment"># æŸ¥çœ‹æŸä¸ªpod</span>
kubectl describe pod nginx-pod
<span class="hljs-comment"># åˆ é™¤</span>
kubectl delete pod nginx-pod
</code></pre>
<p>ä¸Šé¢ç»™å‡ºçš„éƒ½æ˜¯ç‹¬ç«‹çš„podçš„åˆ›å»ºä¸ç®¡ç†æ–¹å¼ï¼Œè™½ç„¶ä½ å¯ä»¥æ‰‹åŠ¨ç®¡ç† Podï¼Œä½† <strong>æ›´æ¨èä½¿ç”¨ Deployment æ§åˆ¶å™¨</strong> ï¼Œåˆ›å»ºPodï¼Œè‡ªåŠ¨ç®¡ç† Pod çš„å‰¯æœ¬æ•°é‡ã€è‡ªæ„ˆèƒ½åŠ›å’Œå‡çº§ç­–ç•¥ã€‚</p>
<h3 data-id="heading-19">3.2 Deploymentï¼šæ— çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²æ§åˆ¶å™¨</h3>
<p>Deployment æ˜¯ Kubernetes ä¸­æœ€å¸¸ç”¨çš„æ§åˆ¶å™¨ä¹‹ä¸€ï¼Œä¸“é—¨ç”¨äºç®¡ç† <strong>æ— çŠ¶æ€åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚å®ƒç¡®ä¿ä½ çš„ Pod å‰¯æœ¬åœ¨é›†ç¾¤ä¸­å§‹ç»ˆæŒ‰é¢„æœŸè¿è¡Œï¼Œå¹¶å…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>ä¿è¯æŒ‡å®šæ•°é‡çš„ Pod å§‹ç»ˆå¤„äºè¿è¡ŒçŠ¶æ€ï¼ˆå‰¯æœ¬æ§åˆ¶ï¼‰</li>
<li>æ”¯æŒåº”ç”¨çš„æ»šåŠ¨å‡çº§å’Œå›æ»š</li>
<li>æ”¯æŒ declarative å¼çš„é…ç½®å’Œæ›´æ–°</li>
<li>è‡ªåŠ¨é‡å»ºå¤±è´¥çš„ Podï¼ˆå…·å¤‡è‡ªæ„ˆèƒ½åŠ›ï¼‰</li>
</ul>
<h4 data-id="heading-20">3.2.1 å…¸å‹ Deployment ç¤ºä¾‹</h4>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>replicas</code>: è®¾ç½®è¿è¡Œçš„ Pod æ•°é‡ä¸º 3</li>
<li><code>selector</code>: ç”¨äºåŒ¹é…ç®¡ç†å“ªäº› Pod</li>
<li><code>template</code>: å®šä¹‰ Pod çš„å†…å®¹ï¼ˆé•œåƒã€ç«¯å£ç­‰ï¼‰</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-nginx</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.24</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
</code></pre>
<h4 data-id="heading-21">3.2.2 Deployment çš„å·¥ä½œé€»è¾‘</h4>
<ul>
<li>å¯»æ‰¾æ‰€æœ‰æ ‡ç­¾åŒ¹é… <code>selector.matchLabels</code> çš„ Pod</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce3bddf45c0b40818f93ef08e9726f5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675Lyq5a2Y55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1751896988&amp;x-signature=a7D9sJU6sRUNNWJ5jxOtCsdnoKs%3D" alt="image.png" loading="lazy"></p>
<ul>
<li>å¦‚æœæ•°é‡ä¸è¶³ <code>replicas</code>ï¼Œåˆ™æ–°å»º Pod</li>
<li>å¦‚æœæ•°é‡è¿‡å¤šï¼Œåˆ™åˆ é™¤å¤šä½™çš„ Pod</li>
<li>å¦‚æœæ ‡ç­¾ç›¸åŒä½†é•œåƒç­‰é…ç½®ä¸åŒï¼Œåˆ™æ›´æ–° Pod</li>
<li>Deployment ä¸ç›´æ¥æ§åˆ¶ Podï¼Œè€Œæ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ª ReplicaSetï¼Œå†ç”± ReplicaSet å…·ä½“å»åˆ›å»º Podï¼Œç»´æŠ¤å‰¯æœ¬æ•°é‡ï¼Œåšæ»šåŠ¨æ›´æ–°ã€‚</li>
</ul>
<h4 data-id="heading-22">3.2.3 Deploymentæ“ä½œå‘½ä»¤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># åˆ›å»º Deployment</span>
kubectl apply -f nginx-deploy.yaml
<span class="hljs-comment"># æŸ¥çœ‹çŠ¶æ€</span>
kubectl get deployments
kubectl describe deployment nginx-deploy
<span class="hljs-comment"># æŸ¥çœ‹ç®¡ç†çš„ Pod</span>
kubectl get pods -l app=nginx
</code></pre>
<p>ä¿®æ”¹é•œåƒå¹¶æ»šåŠ¨å‡çº§ï¼Œå°†nginxä»1.24å‡çº§åˆ°1.25</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.25</span>

</code></pre>
<pre><code class="hljs language-basn" lang="basn"># å‡çº§
kubectl apply -f nginx-deploy.yaml
# æŸ¥çœ‹å†å²è®°å½•
kubectl rollout history deployment nginx-deploy
# å›æ»š
kubectl rollout undo deployment nginx-deploy
</code></pre>
<h3 data-id="heading-23">3.3  Serviceï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h3>
<p>åœ¨ Kubernetes ä¸­ï¼Œ<strong>Pod æ˜¯ä¼šå˜åŒ–çš„</strong> â€”â€” å½“ Deployment æ»šåŠ¨æ›´æ–°ã€Pod é‡å¯æ—¶ï¼ŒPod çš„ IP ä¼šå˜ã€‚æ‰€ä»¥ä¸èƒ½ä¾èµ– Pod çš„ IP åœ°å€æ¥é€šä¿¡ã€‚</p>
<p>è¿™å°±æ˜¯ Service å‡ºåœºçš„åŸå› ï¼Œå®ƒä¸ºä¸€ç»„ Pod æä¾›äº†ä¸€ä¸ª <strong>ç¨³å®šçš„ç½‘ç»œè®¿é—®å…¥å£</strong>ï¼Œå®ç°äº†ï¼š</p>
<ul>
<li><strong>æœåŠ¡å‘ç°</strong>ï¼ˆPod åŠ¨æ€å˜åŠ¨ä¹Ÿèƒ½æ‰¾åˆ°ï¼‰</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼ˆå¤šä¸ª Pod é—´è‡ªåŠ¨åˆ†æµè¯·æ±‚ï¼‰</li>
</ul>
<h4 data-id="heading-24">3.3.1 Serviceå®ä¾‹</h4>
<p>å®ä¾‹ï¼šä¸º nginx Pod æš´éœ²ä¸€ä¸ª Service</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>  <span class="hljs-comment"># åŒ¹é…è¢«ç®¡ç†çš„ Podï¼ˆDeployment åˆ›å»ºçš„ï¼‰</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>          <span class="hljs-comment"># Service å¯¹å¤–æš´éœ²çš„ç«¯å£</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span>    <span class="hljs-comment"># Pod å†…éƒ¨å®¹å™¨ç›‘å¬çš„ç«¯å£</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>       <span class="hljs-comment"># é›†ç¾¤å†…è®¿é—®ï¼ˆé»˜è®¤ï¼‰</span>
</code></pre>
<p>å¸¸è§ Service ç±»å‹ï¼š</p>

























<table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ClusterIP</td><td>é»˜è®¤ç±»å‹ï¼Œä»…åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡è™šæ‹Ÿ IP è®¿é—®</td></tr><tr><td>NodePort</td><td>å°† Service æš´éœ²åœ¨æ¯ä¸ª Node çš„æŸä¸ªç«¯å£ï¼Œå¤–éƒ¨å¯ä»¥é€šè¿‡ IP:Port è®¿é—®</td></tr><tr><td>LoadBalancer</td><td>äº‘ç¯å¢ƒä¸‹è‡ªåŠ¨åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆé˜¿é‡Œäº‘ã€AWS ç­‰ï¼‰</td></tr><tr><td>ExternalName</td><td>æŠŠè¯·æ±‚é‡å®šå‘åˆ°å¤–éƒ¨ DNS åŸŸå</td></tr></tbody></table>
<h4 data-id="heading-25">3.3.2 Service å¦‚ä½•åšæœåŠ¡å‘ç°ï¼Ÿ</h4>
<p>Kubernetes å†…ç½® <strong>DNS æœåŠ¡</strong>ï¼Œä¼šä¸ºæ¯ä¸ª Service åˆ†é…ä¸€ä¸ª DNS åç§°ï¼š
ä¾‹å¦‚</p>
<pre><code class="hljs language-bash" lang="bash">http://nginx-service.default.svc.cluster.local
</code></pre>
<p>å®¹å™¨ä¸­çš„å…¶ä»– Pod åªéœ€ç”¨è¿™ä¸ª DNS åç§°å°±èƒ½è®¿é—® nginx æœåŠ¡ï¼Œå®Œå…¨ä¸éœ€è¦å…³å¿ƒ Pod IPã€‚</p>
<h4 data-id="heading-26">3.3.3 åˆ›å»ºå¹¶è®¿é—® Service ç¤ºä¾‹</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># åˆ›å»º Deployment</span>
kubectl apply -f nginx-deployment.yaml

<span class="hljs-comment"># åˆ›å»º Service</span>
kubectl apply -f nginx-service.yaml

<span class="hljs-comment"># æŸ¥çœ‹ Service IP å’Œç«¯å£ï¼š</span>
kubectl get svc

<span class="hljs-comment"># åœ¨é›†ç¾¤ä¸­è®¿é—® Serviceï¼š</span>
curl http://nginx-service
</code></pre>
<h3 data-id="heading-27">3.4 Ingress</h3>
<p>åœ¨ Kubernetes ä¸­ï¼ŒIngressæ˜¯ä¸€ç§ API å¯¹è±¡ï¼Œç”¨äºç®¡ç†å¤–éƒ¨ç”¨æˆ·å¦‚ä½•é€šè¿‡ HTTP æˆ– HTTPS è®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼ˆServiceï¼‰ ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒIngress æä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼ï¼Œå°†åŸŸåæˆ–è·¯å¾„æ˜ å°„åˆ°é›†ç¾¤ä¸­çš„æœåŠ¡ä¸Šï¼Œå¹¶æ”¯æŒè´Ÿè½½å‡è¡¡ã€SSL ç»ˆç«¯å’ŒåŸºäºè·¯å¾„/ä¸»æœºçš„è·¯ç”±ã€‚</p>
<h4 data-id="heading-28">3.4.1 ä¸ºä»€ä¹ˆéœ€è¦ Ingressï¼Ÿ</h4>
<p>åœ¨æ²¡æœ‰ Ingress çš„æƒ…å†µä¸‹ï¼Œé›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡åªèƒ½é€šè¿‡ï¼š</p>
<ul>
<li><strong>NodePort</strong>ï¼šæ¯ä¸ª Service æš´éœ²ä¸€ä¸ªç«¯å£ï¼Œè®¿é—®åœ°å€ä¸º <code>NodeIP:Port</code>ï¼Œéš¾ç®¡ç†ã€‚</li>
<li><strong>LoadBalancer</strong>ï¼šä¸ºæ¯ä¸ªæœåŠ¡ç”³è¯·ä¸€ä¸ªäº‘è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆæœ¬é«˜ã€‚</li>
<li><strong>Port-forward / kubectl proxy</strong>ï¼šä¸´æ—¶è°ƒè¯•ç”¨ï¼Œä¸é€‚åˆç”Ÿäº§ã€‚</li>
</ul>
<p>è€Œ Ingress é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ï¼Œæ ¹æ®åŸŸåæˆ–è·¯å¾„æ¥è½¬å‘è¯·æ±‚ï¼Œæˆæœ¬ä½ã€é…ç½®çµæ´»ã€å¯ç»´æŠ¤æ€§å¼ºã€‚Ingress åŠŸèƒ½ç‚¹å¦‚ä¸‹:</p>

































<table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åŸŸåè·¯ç”±</td><td>æ ¹æ®ä¸»æœºåå°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒæœåŠ¡</td></tr><tr><td>è·¯å¾„è·¯ç”±</td><td>æ ¹æ®è·¯å¾„å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒæœåŠ¡</td></tr><tr><td>HTTPS æ”¯æŒ</td><td>å¯ä»¥é…ç½®è¯ä¹¦ï¼Œå®ç° TLS ç»ˆç«¯</td></tr><tr><td>è´Ÿè½½å‡è¡¡</td><td>å¤šä¸ª Pod é—´è‡ªåŠ¨è´Ÿè½½å‡è¡¡</td></tr><tr><td>æ”¯æŒé‡å®šå‘ä¸é‡å†™</td><td>å¯ä»¥é…ç½® URL é‡å®šå‘æˆ–è·¯å¾„é‡å†™</td></tr><tr><td>èº«ä»½éªŒè¯ã€é™é€Ÿç­‰</td><td>å€ŸåŠ© Ingress Controller æ’ä»¶å¯å®ç°æ›´é«˜çº§åŠŸèƒ½</td></tr></tbody></table>
<h4 data-id="heading-29">3.4.2 ç»„æˆç»“æ„</h4>
<p>Ingress æœ¬èº«ä¸ç›´æ¥å¤„ç†è¯·æ±‚ï¼Œå®ƒä¾èµ– <strong>Ingress Controller</strong> æ¥å·¥ä½œã€‚å¸¸è§ Ingress Controller:</p>





























<table><thead><tr><th>Controller ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Nginx</td><td>æœ€æµè¡Œçš„å¼€æºé€‰æ‹©ï¼Œæ”¯æŒå¤šæ•°åŠŸèƒ½</td></tr><tr><td>Traefik</td><td>è½»é‡çº§ã€é«˜æ€§èƒ½ï¼Œæ”¯æŒå¾®æœåŠ¡å’Œè‡ªåŠ¨å‘ç°</td></tr><tr><td>HAProxy</td><td>é«˜æ€§èƒ½ã€ä¼ä¸šçº§é€‰æ‹©</td></tr><tr><td>Istio Gateway</td><td>ç”¨äºæœåŠ¡ç½‘æ ¼åœºæ™¯</td></tr><tr><td>AWS/GCP/ALB</td><td>äº‘å¹³å°åŸç”Ÿè´Ÿè½½å‡è¡¡é›†æˆ</td></tr></tbody></table>
<p>ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº† Ingress åœ¨ Kubernetes ä¸­è¿›è¡Œæµé‡è½¬å‘çš„å®Œæ•´æ¶æ„æµç¨‹</p>
<ol>
<li>
<p>ç”¨æˆ·è®¿é—® <code>example.com/web</code>ï¼›</p>
</li>
<li>
<p>Ingress ä¸­å®šä¹‰äº† <code>/web</code> è·¯å¾„æŒ‡å‘ <code>my-web</code> Serviceï¼›</p>
</li>
<li>
<p>Ingress Controllerï¼ˆå¦‚ nginx-ingressï¼‰è¯»å– Ingress è§„åˆ™ï¼›</p>
</li>
<li>
<p>Ingress Controller æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†å…¶è½¬å‘ç»™ <code>my-web</code> Serviceï¼›</p>
</li>
<li>
<p>Service æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ Podï¼ˆä¾‹å¦‚æ ‡ç­¾ä¸º <code>app=web</code>ï¼‰ï¼›</p>
</li>
<li>
<p>è¯·æ±‚æœ€ç»ˆåˆ°è¾¾ Podï¼Œå¾—åˆ°ä¸šåŠ¡å“åº”ã€‚</p>
<pre><code class="hljs language-lua" lang="lua">   +<span class="hljs-comment">--------------+</span>
   |   Internet   |
   +<span class="hljs-comment">------+-------+</span>
          |
  +<span class="hljs-comment">-------v--------+</span>
  | Ingress        |  â† é…ç½®è·¯ç”±è§„åˆ™çš„èµ„æº
  | (å®šä¹‰è§„åˆ™)     |
  +<span class="hljs-comment">-------+--------+</span>
          |
 +<span class="hljs-comment">--------v---------+</span>
 | Ingress Controller| â† å®é™…è´Ÿè´£è½¬å‘æµé‡
 | (å¦‚ Nginx, Traefik)|
 +<span class="hljs-comment">--------+---------+</span>
          |
    +<span class="hljs-comment">-----v------+</span>
    | Kubernetes |
    |  Services  |
    +<span class="hljs-comment">-----+------+</span>
          |
       +<span class="hljs-comment">--v--+</span>
       | Pod |
       +<span class="hljs-comment">-----+</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-30">3.4.3 é…ç½®ä¸€ä¸ªç®€å•çš„ Ingress</h4>
<p>Ingress å¦‚ä½•è¿æ¥ Serviceï¼Ÿ å‡è®¾ä½ æœ‰ä¸€ä¸ªåä¸º <code>my-web</code> çš„ Serviceï¼Œç›‘å¬ç«¯å£ä¸º 80ï¼š</p>
<p><code>service.yaml</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-web</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<p>service.yamlå¯¹åº”çš„my-web-deployment.yamlé…ç½®å¦‚ä¸‹:</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-web</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">web</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.24</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<p>è¿™ä¸ª Service å°†æµé‡ä»ç«¯å£ 80 è½¬å‘åˆ°é€‰ä¸­ Pod çš„ 8080 ç«¯å£ã€‚Ingress é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">web-ingress</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">example.com</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">paths:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/web</span>
            <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
            <span class="hljs-attr">backend:</span>
              <span class="hljs-attr">service:</span>
                <span class="hljs-attr">name:</span> <span class="hljs-string">my-web</span>        <span class="hljs-comment"># æŒ‡å‘ Service çš„åå­—</span>
                <span class="hljs-attr">port:</span>
                  <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>        <span class="hljs-comment"># æŒ‡å‘ Service çš„ port å­—æ®µ</span>
</code></pre>
<blockquote>
<p>å½“ç”¨æˆ·è®¿é—® <code>http://example.com/web</code> æ—¶ï¼š</p>
<ol>
<li>è¯·æ±‚è¢« Ingress Controller æ•è·ï¼›</li>
<li>æ ¹æ® <code>/web</code> è·¯å¾„åŒ¹é…åˆ°è§„åˆ™ï¼›</li>
<li>å°†è¯·æ±‚è½¬å‘åˆ° <code>my-web</code> Serviceï¼›</li>
<li>Service æ ¹æ® selector æ‰¾åˆ°å¯¹åº”çš„ Podï¼ˆå¦‚ <code>app=web</code>ï¼‰ï¼›</li>
<li>å°†è¯·æ±‚è½¬å‘ç»™è¿™äº› Pod çš„ <code>targetPort: 8080</code>ã€‚</li>
</ol>
</blockquote>
<h4 data-id="heading-31">3.4.4 é…ç½® HTTPS Ingress</h4>
<p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªåŒ…å« TLS è¯ä¹¦çš„ Secretï¼šè¿™ä¸ª Secret åŒ…å«å…¬é’¥è¯ä¹¦ï¼ˆCRTï¼‰å’Œç§é’¥ï¼ˆKEYï¼‰ï¼Œåç§°ä¸º <code>tls-secret</code>ï¼Œä½äº <code>default</code> å‘½åç©ºé—´ä¸­.</p>
<pre><code class="hljs language-bash" lang="bash">kubectl create secret tls tls-secret \
  --cert=example.com.crt \
  --key=example.com.key \
  -n default
</code></pre>
<p>åœ¨Ingress é…ç½®å¯ç”¨ HTTPS</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">web-ingress</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">tls:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">example.com</span>
      <span class="hljs-attr">secretName:</span> <span class="hljs-string">tls-secret</span>  <span class="hljs-comment"># æŒ‡å‘æˆ‘ä»¬é¢„å…ˆåˆ›å»ºçš„ TLS Secret</span>

  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">example.com</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">paths:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>
            <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
            <span class="hljs-attr">backend:</span>
              <span class="hljs-attr">service:</span>
                <span class="hljs-attr">name:</span> <span class="hljs-string">my-web</span>
                <span class="hljs-attr">port:</span>
                  <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>

</code></pre>
<p>æ•ˆæœéªŒè¯ï¼š</p>
<ul>
<li>
<p>æœ¬åœ°é…ç½® DNSï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"INGRESS_IP  example.com"</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/hosts
</code></pre>
<p><code>INGRESS_IP</code> æ˜¯ä½ çš„ Ingress Controller çš„å¤–ç½‘ IP åœ°å€ã€‚</p>
</li>
<li>
<p>æµè§ˆå™¨è®¿é—®ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">https://example.com/
</code></pre>
</li>
</ul>
<p>è‹¥é…ç½®æ— è¯¯ï¼Œå°†è‡ªåŠ¨è·³è½¬å¹¶çœ‹åˆ°ä½ éƒ¨ç½²çš„ nginx é¡µé¢ã€‚</p>
<h3 data-id="heading-32">3.5 ConfigMap ä¸ Secret</h3>
<p>åœ¨ Kubernetes ä¸­ï¼Œ<strong>ConfigMap å’Œ Secret</strong> æ˜¯ç”¨äº<strong>é…ç½®ç®¡ç†</strong>çš„ä¸¤ç§æ ¸å¿ƒèµ„æºç±»å‹ï¼Œå®ƒä»¬ç”¨äºå°†é…ç½®å’Œæ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç ã€API å¯†é’¥ï¼‰ä¸å®¹å™¨è§£è€¦ï¼Œè®©ä½ çš„åº”ç”¨éƒ¨ç½²æ›´åŠ çµæ´»ã€å®‰å…¨ã€‚</p>



































<table><thead><tr><th>ç‰¹æ€§</th><th>ConfigMap</th><th>Secret</th></tr></thead><tbody><tr><td>ç”¨é€”</td><td>å­˜å‚¨æ™®é€šé…ç½®ï¼ˆä¸æ•æ„Ÿï¼‰</td><td>å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç ã€Tokenï¼‰</td></tr><tr><td>æ•°æ®æ˜¯å¦åŠ å¯†</td><td>âŒ å¦ï¼ˆæ˜æ–‡ï¼‰</td><td>âœ… æ˜¯ï¼ˆBase64 ç¼–ç ï¼Œé€‚åˆåŠ å¯†ä¼ è¾“ï¼‰</td></tr><tr><td>å¯æŒ‚è½½åˆ° Pod</td><td>âœ… æ˜¯</td><td>âœ… æ˜¯</td></tr><tr><td>ä½¿ç”¨æ–¹å¼</td><td>ç¯å¢ƒå˜é‡ã€æŒ‚è½½ä¸ºæ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°ç­‰</td><td>ç¯å¢ƒå˜é‡ã€æŒ‚è½½ä¸ºæ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°ç­‰</td></tr><tr><td>æ¨èç”¨é€”</td><td>é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤å‚æ•°ç­‰</td><td>å¯†ç ã€è¯ä¹¦ã€æ•°æ®åº“å¯†é’¥ã€Token ç­‰</td></tr></tbody></table>
<h4 data-id="heading-33">3.5.1 ConfigMapï¼šå­˜å‚¨éæ•æ„Ÿé…ç½®</h4>
<h5 data-id="heading-34">åˆ›å»º ConfigMap çš„æ–¹å¼</h5>
<p>æ–¹æ³• 1ï¼šä½¿ç”¨ <code>kubectl</code> å‘½ä»¤è¡Œåˆ›å»º</p>
<pre><code class="hljs language-bash" lang="bash">kubectl create configmap my-config --from-literal=color=blue --from-literal=lang=zh
</code></pre>
<p>æ–¹æ³• 2ï¼šä½¿ç”¨ YAML åˆ›å»º</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">color:</span> <span class="hljs-string">blue</span>
  <span class="hljs-attr">lang:</span> <span class="hljs-string">zh</span>
</code></pre>
<h5 data-id="heading-35">ä½¿ç”¨ ConfigMap çš„æ–¹å¼</h5>
<p>æ–¹æ³• 1ï¼šä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥å®¹å™¨</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">env:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">COLOR</span>
    <span class="hljs-attr">valueFrom:</span>
      <span class="hljs-attr">configMapKeyRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">my-config</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">color</span>
</code></pre>
<p>æ–¹æ³• 2ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">volumeMounts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span>
    <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/config</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span>
    <span class="hljs-attr">configMap:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">my-config</span>
</code></pre>
<h4 data-id="heading-36">3.5.2 Secretï¼šå­˜å‚¨æ•æ„Ÿé…ç½®</h4>
<p>Secret çš„æ•°æ®ä¼šä»¥ Base64 ç¼–ç å­˜å‚¨ï¼ˆå¯ä»¥ç»“åˆåŠ å¯†å­˜å‚¨åç«¯å®ç°æ›´é«˜å®‰å…¨æ€§ï¼‰ã€‚</p>
<h5 data-id="heading-37">åˆ›å»º Secret çš„æ–¹å¼</h5>
<p>æ–¹æ³• 1ï¼šå‘½ä»¤è¡Œç›´æ¥åˆ›å»º</p>
<pre><code class="hljs language-bash" lang="bash">kubectl create secret generic my-secret --from-literal=password=123456
</code></pre>
<p>æ–¹æ³• 2ï¼šYAML æ–‡ä»¶åˆ›å»ºï¼ˆæ³¨æ„ Base64 ç¼–ç ï¼‰</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-secret</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">MTIzNDU2</span>  <span class="hljs-comment"># Base64 ç¼–ç åçš„ "123456"</span>
</code></pre>
<p>å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨ç¼–ç ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">"123456"</span> | <span class="hljs-built_in">base64</span>
</code></pre>
<h5 data-id="heading-38">ä½¿ç”¨ Secret çš„æ–¹å¼</h5>
<p>æ–¹æ³• 1ï¼šä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">env:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_PASSWORD</span>
    <span class="hljs-attr">valueFrom:</span>
      <span class="hljs-attr">secretKeyRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">my-secret</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">password</span>
</code></pre>
<p>æ–¹æ³• 2ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">volumeMounts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span>
    <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/secret</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span>
    <span class="hljs-attr">secret:</span>
      <span class="hljs-attr">secretName:</span> <span class="hljs-string">my-secret</span>
</code></pre>
<h3 data-id="heading-39">3.6 PersistentVolumeClaim</h3>
<p>PersistentVolumeClaimï¼ˆPVCï¼‰ æ˜¯ä¸€ç§èµ„æºå¯¹è±¡ï¼Œç”¨äºç”³è¯·æŒä¹…åŒ–å­˜å‚¨ç©ºé—´ï¼ˆPersistentVolumeï¼ŒPVï¼‰ ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯ Pod ä¸åº•å±‚å­˜å‚¨ä¹‹é—´çš„æ¡¥æ¢ï¼Œç”¨æˆ·é€šè¿‡ PVC æ¥è¯·æ±‚ç£ç›˜ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»‘å®šç¡¬ç›˜èµ„æºã€‚</p>
<h4 data-id="heading-40">3.6.1 ä»€ä¹ˆæ˜¯ PersistentVolume ä¸ PersistentVolumeClaimï¼Ÿ</h4>
<ul>
<li><strong>PersistentVolumeï¼ˆPVï¼‰</strong> ï¼šç”±ç®¡ç†å‘˜åˆ›å»ºæˆ–è‡ªåŠ¨åˆ›å»ºçš„<strong>å­˜å‚¨èµ„æº</strong>ï¼Œç±»ä¼¼â€œç¡¬ç›˜â€ã€‚</li>
<li><strong>PersistentVolumeClaimï¼ˆPVCï¼‰</strong> ï¼šç”¨æˆ·ç”³è¯·ä½¿ç”¨ PV çš„æ–¹å¼ï¼Œç±»ä¼¼â€œç§Ÿç”¨ç¡¬ç›˜â€ã€‚</li>
</ul>
<blockquote>
<p>ğŸ§© ç±»æ¯”ç†è§£ï¼š</p>
<ul>
<li><strong>PV = æˆ¿ä¸œæä¾›çš„æˆ¿å­</strong></li>
<li><strong>PVC = ç§Ÿå®¢å‘å‡ºçš„ç§Ÿæˆ¿ç”³è¯·</strong></li>
<li>Kubernetes åŒ¹é… PVC ä¸ PVï¼Œå®ç°ç§Ÿæˆ¿åŠ¨ä½œ</li>
</ul>
</blockquote>
<p>ä¸ºä»€ä¹ˆéœ€è¦ PVCï¼Ÿåœ¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå®¹å™¨å†…çš„æ•°æ®æ˜¯<strong>ä¸´æ—¶çš„ï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰</strong> ï¼Œå®¹å™¨é‡å¯æˆ–è¿ç§»åä¼šä¸¢å¤±ã€‚å¦‚æœéœ€è¦ä¿å­˜æ•°æ®åº“ã€æ–‡ä»¶ä¸Šä¼ ç­‰æ•°æ®ï¼Œå°±å¿…é¡»ä½¿ç”¨ PVC æ¥ç»‘å®šåˆ°ç¨³å®šçš„ç¡¬ç›˜ã€‚</p>
<h4 data-id="heading-41">3.6.2 PVC ä½¿ç”¨æµç¨‹</h4>
<ul>
<li>ç®¡ç†å‘˜é…ç½® StorageClass æˆ– PV</li>
<li>å¼€å‘è€…åœ¨ Pod ä¸­å£°æ˜ PVC</li>
<li>ç³»ç»Ÿè‡ªåŠ¨åŒ¹é…åˆé€‚çš„ PV ç»™ PVC</li>
<li>Pod ä½¿ç”¨ PVC æä¾›çš„å­˜å‚¨æŒ‚è½½è·¯å¾„</li>
</ul>
<h4 data-id="heading-42">3.6.3 PVC ä½¿ç”¨ç¤ºä¾‹</h4>
<h5 data-id="heading-43">Step1ï¼šå®šä¹‰ PVC</h5>
<p>ç”³è¯·ä¸€ä¸ª 1Gi çš„å­˜å‚¨ç©ºé—´</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-pvc</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>      <span class="hljs-comment"># åªå…è®¸ä¸€ä¸ª Pod æŒ‚è½½è¯»å†™</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span>        <span class="hljs-comment"># è¯·æ±‚ 1Gi å­˜å‚¨ç©ºé—´</span>
</code></pre>
<p>è®¿é—®æ¨¡å¼è¯´æ˜ï¼š</p>





















<table><thead><tr><th>æ¨¡å¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ReadWriteOnce</td><td>åªèƒ½è¢«å•ä¸ª Node ä¸Šçš„ä¸€ä¸ª Pod è¯»å†™ï¼ˆæœ€å¸¸ç”¨ï¼‰</td></tr><tr><td>ReadOnlyMany</td><td>å¤šä¸ª Pod å¯è¯»ï¼Œä½†ä¸å¯å†™</td></tr><tr><td>ReadWriteMany</td><td>å¤šä¸ª Pod å¯è¯»å†™ï¼ˆéœ€ç‰¹å®šå­˜å‚¨æ”¯æŒï¼Œå¦‚ NFSï¼‰</td></tr></tbody></table>
<h5 data-id="heading-44">Step 2ï¼šPod ä¸­ä½¿ç”¨ PVC</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-with-pvc</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">"/usr/share/nginx/html"</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">web-data</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web-data</span>
      <span class="hljs-attr">persistentVolumeClaim:</span>
        <span class="hljs-attr">claimName:</span> <span class="hljs-string">my-pvc</span>
</code></pre>
<p>è¿™æ ·ï¼ŒPod å°±èƒ½æŠŠ <code>/usr/share/nginx/html</code> ç›®å½•çš„æ•°æ®å­˜å‚¨åˆ°æŒä¹…åŒ–å·ä¸­ã€‚ä¹Ÿå¯ä»¥ç”¨ PVC æ­é… StorageClassï¼Œè®© K8s è‡ªåŠ¨å‘äº‘å‚å•†ï¼ˆå¦‚ AWSã€GCPï¼‰åŠ¨æ€åˆ›å»ºç£ç›˜èµ„æºï¼Œæ— éœ€ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»º PVã€‚</p>
<h3 data-id="heading-45">3.7 Namespace</h3>
<p><strong>Namespaceï¼ˆå‘½åç©ºé—´ï¼‰</strong> æ˜¯ä¸€ç§ç”¨äºå¯¹é›†ç¾¤ä¸­çš„èµ„æºè¿›è¡Œ<strong>é€»è¾‘éš”ç¦»å’Œåˆ†ç»„ç®¡ç†</strong>çš„æœºåˆ¶ã€‚å¯ä»¥æŠŠå®ƒç†è§£ä¸ºé›†ç¾¤ä¸­çš„ã€Œè™šæ‹Ÿå­é›†ç¾¤ã€ï¼Œç”¨äºå°†èµ„æºåˆ’åˆ†ä¸ºå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„ç©ºé—´ã€‚å¹¶éæ‰€æœ‰çš„èµ„æºéƒ½å¯ä»¥ç”¨å‘½åç©ºé—´è¿›è¡Œéš”ç¦»ã€‚</p>

























<table><thead><tr><th>ç‰¹æ€§</th><th>æ˜¯å¦ä½œç”¨äº Namespace</th></tr></thead><tbody><tr><td>Podã€Service</td><td>âœ… æ˜¯ï¼Œå±äºæŸä¸ªå‘½åç©ºé—´</td></tr><tr><td>Nodeã€PV</td><td>âŒ å¦ï¼Œå…¨å±€èµ„æº</td></tr><tr><td>Roleã€Quota</td><td>âœ… æ˜¯ï¼Œä½œç”¨äºæŒ‡å®šå‘½åç©ºé—´</td></tr><tr><td>ClusterRole</td><td>âŒ å¦ï¼Œä½œç”¨äºå…¨é›†ç¾¤</td></tr></tbody></table>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹Nodeå’ŒPodçš„åŒºåˆ«ï¼š</p>



































<table><thead><tr><th>ç±»ç›®</th><th><strong>Nodeï¼ˆèŠ‚ç‚¹ï¼‰</strong></th><th><strong>Pod</strong></th></tr></thead><tbody><tr><td><strong>å®šä¹‰</strong></td><td>é›†ç¾¤ä¸­çš„ä¸€å°å·¥ä½œæœºå™¨ï¼ˆç‰©ç†æœºæˆ–è™šæ‹Ÿæœºï¼‰</td><td>Kubernetes ä¸­å¯è°ƒåº¦çš„æœ€å°è®¡ç®—å•å…ƒï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼‰</td></tr><tr><td><strong>å±‚çº§å…³ç³»</strong></td><td>Node æ˜¯è¿è¡Œ Pod çš„å®¿ä¸»æœº</td><td>Pod è¿è¡Œåœ¨ Node ä¸Š</td></tr><tr><td><strong>æ•°é‡</strong></td><td>é›†ç¾¤ä¸­é€šå¸¸åªæœ‰å°‘æ•°å‡ ä¸ª Nodeï¼ˆå¦‚3ä¸ªã€5ä¸ªï¼‰</td><td>å¯ä»¥è°ƒåº¦æˆåƒä¸Šä¸‡ä¸ª Pod</td></tr><tr><td><strong>ä½œç”¨</strong></td><td>æä¾›è®¡ç®—èµ„æºï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œï¼‰</td><td>å°è£…åº”ç”¨å®¹å™¨åŠå…¶è¿è¡Œç¯å¢ƒ</td></tr><tr><td><strong>ç»„æˆéƒ¨åˆ†</strong></td><td>kubeletã€kube-proxyã€å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ containerdï¼‰</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€å…±äº«ç½‘ç»œå’Œå­˜å‚¨å·</td></tr></tbody></table>
<p>é€šä¿—ç†è§£<strong>Node æ˜¯å®¿èˆæ¥¼</strong>ï¼Œé‡Œé¢ä½ç€å¤šä¸ª <strong>Podï¼ˆå®¿èˆé—´ï¼‰</strong> ä¸€ä¸ª Node å¯ä»¥è¿è¡Œå¤šä¸ª Podï¼Œä½† Pod ä¸èƒ½è„±ç¦» Node ç‹¬ç«‹å­˜åœ¨ã€‚</p>
<h4 data-id="heading-46">3.7.1 Namespace æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h4>
<h5 data-id="heading-47">1. <strong>èµ„æºéš”ç¦»</strong></h5>
<ul>
<li>æ¯ä¸ª Namespace é‡Œçš„èµ„æºå½¼æ­¤éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚</li>
<li>æ¯”å¦‚ä½ åœ¨ <code>dev</code> å’Œ <code>prod</code> ä¸­åˆ†åˆ«éƒ¨ç½²äº†ä¸¤ä¸ª <code>nginx</code>ï¼Œå®ƒä»¬ä¸ä¼šå†²çªï¼Œå› ä¸ºåœ¨å„è‡ªçš„å‘½åç©ºé—´ä¸­æ˜¯å”¯ä¸€çš„ã€‚</li>
</ul>
<h5 data-id="heading-48">2. <strong>æƒé™æ§åˆ¶ï¼ˆRBACï¼‰</strong></h5>
<p>å¯ä»¥åŸºäº Namespace åˆ†é…ä¸åŒçš„æƒé™ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>å¼ ä¸‰</code> åªèƒ½ç®¡ç† <code>dev</code> å‘½åç©ºé—´ï¼›</li>
<li><code>æå››</code> åªèƒ½æŸ¥çœ‹ <code>prod</code> å‘½å</li>
</ul>
<p>ä¾¿äºä¼ä¸šå¤šå›¢é˜Ÿåä½œæ—¶çš„æƒé™è¾¹ç•Œç®¡ç†ã€‚</p>
<h5 data-id="heading-49">3. <strong>èµ„æºé…é¢é™åˆ¶ï¼ˆResourceQuotaï¼‰</strong></h5>
<p>å¯ä»¥ä¸ºä¸åŒ Namespace è®¾ç½®èµ„æºé…é¢é™åˆ¶ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>dev</code> Namespace æœ€å¤šä½¿ç”¨ 4 ä¸ª CPUã€8G å†…å­˜ï¼›</li>
<li><code>prod</code> Namespace å¯ä»¥ä½¿ç”¨æ›´å¤šèµ„æºï¼›</li>
</ul>
<p>è¿™æ ·å¯ä»¥é¿å…æŸä¸ªé¡¹ç›®â€œåƒå…‰â€æ•´ä¸ªé›†ç¾¤èµ„æºã€‚</p>
<h5 data-id="heading-50">4. <strong>ä¾¿äºç¯å¢ƒåˆ†ç¦»</strong></h5>
<p>å¸¸è§å®è·µï¼šæŒ‰ç¯å¢ƒåˆ’åˆ† Namespaceï¼š</p>
<ul>
<li><code>dev</code>ï¼šå¼€å‘ç¯å¢ƒ</li>
<li><code>test</code>ï¼šæµ‹è¯•ç¯å¢ƒ</li>
<li><code>prod</code>ï¼šç”Ÿäº§ç¯å¢ƒ</li>
</ul>
<p>åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­éƒ¨ç½²å¤šå¥—ç³»ç»Ÿè€Œäº’ä¸å¹²æ‰°ã€‚æ­¤å¤–Kubernetes é»˜è®¤æä¾›äº†å‡ ä¸ªå†…ç½®å‘½åç©ºé—´ï¼š</p>

























<table><thead><tr><th>å‘½åç©ºé—´</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><code>default</code></td><td>é»˜è®¤å‘½åç©ºé—´ï¼Œç”¨æˆ·ä¸æŒ‡å®šæ—¶èµ„æºä¼šåˆ›å»ºåœ¨è¿™é‡Œ</td></tr><tr><td><code>kube-system</code></td><td>Kubernetes ç³»ç»Ÿç»„ä»¶è¿è¡Œçš„åœ°æ–¹ï¼ˆå¦‚ kube-dnsï¼‰</td></tr><tr><td><code>kube-public</code></td><td>æ‰€æœ‰äººéƒ½å¯è®¿é—®ï¼Œä¸»è¦ç”¨äºå…¬å¼€ä¿¡æ¯</td></tr><tr><td><code>kube-node-lease</code></td><td>èŠ‚ç‚¹çŠ¶æ€å¿ƒè·³ç›¸å…³</td></tr></tbody></table>
<h4 data-id="heading-51">3.7.2 åˆ›å»ºå‘½åç©ºé—´å¹¶éƒ¨ç½²èµ„æºç¤ºä¾‹</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># åˆ›å»ºå‘½åç©ºé—´</span>
kubectl create namespace dev

<span class="hljs-comment"># åœ¨ dev å‘½åç©ºé—´éƒ¨ç½² nginx</span>
kubectl run nginx --image=nginx -n dev

<span class="hljs-comment"># æŸ¥çœ‹ dev å‘½åç©ºé—´ä¸‹çš„ Pod</span>
kubectl get pods -n dev
</code></pre>
<p>å‘½åç©ºé—´çš„é€»è¾‘éš”ç¦»:</p>
<pre><code class="hljs language-bash" lang="bash">+------------------------+
|     Kubernetes é›†ç¾¤     |
|                        |
| +--------+  +--------+ |
| | dev    |  | prod   | |
| |        |  |        | |
| | nginx  |  | nginx  | |
| | redis  |  | mysql  | |
| +--------+  +--------+ |
+------------------------+

</code></pre>
<h3 data-id="heading-52">3.8 RBAC</h3>
<p><strong>RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ŒRole-Based Access Controlï¼‰</strong> æ˜¯ä¸€ç§æƒé™ç®¡ç†æœºåˆ¶ï¼Œç”¨æ¥æ§åˆ¶<strong>è°å¯ä»¥å¯¹å“ªäº›èµ„æºæ‰§è¡Œå“ªäº›æ“ä½œ</strong>ã€‚RBAC å°±åƒå…¬å¸ä¸­çš„æƒé™ç³»ç»Ÿï¼šä¸åŒçš„å²—ä½ï¼ˆè§’è‰²ï¼‰æœ‰ä¸åŒçš„æƒé™ï¼Œä¸åŒçš„å‘˜å·¥ï¼ˆç”¨æˆ·ï¼‰åªèƒ½åšä»–ä»¬è¢«æˆæƒçš„äº‹æƒ…ã€‚</p>
<h4 data-id="heading-53">3.8.1 RBAC çš„æ ¸å¿ƒç»„ä»¶</h4>
<p>RBAC ä¸€å…±ç”± 4 ä¸ªå…³é”®å¯¹è±¡ç»„æˆï¼š</p>

























<table><thead><tr><th>å¯¹è±¡</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>Role</strong></td><td>å®šä¹‰åœ¨æŸä¸ª Namespace ä¸­èƒ½è¿›è¡Œå“ªäº›æ“ä½œï¼ˆæ¯”å¦‚ï¼šå¯ä»¥æŸ¥çœ‹ Podï¼‰</td></tr><tr><td><strong>ClusterRole</strong></td><td>ç±»ä¼¼ Roleï¼Œä½†ä½œç”¨äºæ‰€æœ‰å‘½åç©ºé—´æˆ–é›†ç¾¤çº§èµ„æºï¼ˆå¦‚èŠ‚ç‚¹ã€å­˜å‚¨ç­‰ï¼‰</td></tr><tr><td><strong>RoleBinding</strong></td><td>å°† Role ç»‘å®šåˆ°å…·ä½“ç”¨æˆ·ã€ç»„æˆ– ServiceAccountï¼ˆé™æŸå‘½åç©ºé—´ï¼‰</td></tr><tr><td><strong>ClusterRoleBinding</strong></td><td>å°† ClusterRole ç»‘å®šåˆ°ç”¨æˆ·ã€ç»„æˆ–æœåŠ¡è´¦å·ï¼ˆå…¨å±€ä½œç”¨ï¼‰</td></tr></tbody></table>
<p>å¸¸è§çš„æ“ä½œï¼š</p>

































<table><thead><tr><th>åŠ¨ä½œ</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>get</code></td><td>è·å–èµ„æº</td></tr><tr><td><code>list</code></td><td>åˆ—å‡ºèµ„æºåˆ—è¡¨</td></tr><tr><td><code>watch</code></td><td>ç›‘å¬èµ„æºå˜åŒ–</td></tr><tr><td><code>create</code></td><td>åˆ›å»ºèµ„æº</td></tr><tr><td><code>update</code></td><td>æ›´æ–°èµ„æº</td></tr><tr><td><code>delete</code></td><td>åˆ é™¤èµ„æº</td></tr></tbody></table>
<h4 data-id="heading-54">3.8.2 åˆ›å»ºä¸€ä¸ªåªè¯»è§’è‰²</h4>
<p>åˆ›å»º Roleï¼šåªèƒ½æŸ¥çœ‹ Pod å’Œ Service</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">""</span>]
    <span class="hljs-attr">resources:</span> [<span class="hljs-string">"pods"</span>, <span class="hljs-string">"services"</span>]
    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
</code></pre>
<p>åˆ›å»º RoleBindingï¼šæŠŠè¿™ä¸ªæƒé™ç»‘å®šç»™æŸä¸ªç”¨æˆ·</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">read-pods-binding</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev</span>
<span class="hljs-attr">subjects:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">alice</span>
    <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span>
<span class="hljs-attr">roleRef:</span>
  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-reader</span>
  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span>
</code></pre>
<p>è¡¨ç¤ºï¼šç”¨æˆ· <code>alice</code> åœ¨ <code>dev</code> å‘½åç©ºé—´å†…ï¼Œå¯ä»¥è¯»å– Pod å’Œ Serviceï¼Œä½†ä¸èƒ½åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ã€‚</p>
<p>å¸¸ç”¨å‘½ä»¤:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æŸ¥çœ‹æ‰€æœ‰ ClusterRole</span>
kubectl get clusterroles

<span class="hljs-comment"># æŸ¥çœ‹ç»‘å®šå…³ç³»</span>
kubectl get rolebindings -n dev

<span class="hljs-comment"># æˆäºˆæŸç”¨æˆ·é›†ç¾¤ç®¡ç†å‘˜æƒé™ï¼ˆç¤ºä¾‹ï¼‰</span>
kubectl create clusterrolebinding admin-binding \
  --clusterrole=cluster-admin \
  --user=alice@example.com
</code></pre>
<h3 data-id="heading-55">3.9 CronJob</h3>
<p><strong><code>CronJob</code></strong> æ˜¯ç”¨æ¥æŒ‰è®¡åˆ’å‘¨æœŸæ€§è¿è¡Œä»»åŠ¡çš„èµ„æºç±»å‹ï¼Œç±»ä¼¼äº Linux ä¸­çš„ <code>crontab</code>ã€‚å®ƒé€‚ç”¨äºé‚£äº›éœ€è¦å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ•°æ®åº“å¤‡ä»½ã€å®šæœŸæ•°æ®æ¸…ç†ã€å®šæ—¶é‚®ä»¶å‘é€ç­‰ã€‚</p>
<p>é…ç½®å­—æ®µè¯´æ˜ï¼š</p>





























<table><thead><tr><th>åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>CronJob</code></td><td>æŒ‰æ—¶é—´è°ƒåº¦ï¼Œå‘¨æœŸæ€§è¿è¡Œä»»åŠ¡</td></tr><tr><td><code>Job</code></td><td>CronJob æ¯æ¬¡è§¦å‘éƒ½ä¼šç”Ÿæˆä¸€ä¸ª Jobï¼Œå®ƒæ˜¯ä¸€æ¬¡æ€§ä»»åŠ¡</td></tr><tr><td><code>Pod</code></td><td>Job åˆ›å»ºçš„ Pod æ‰§è¡Œä»»åŠ¡è„šæœ¬</td></tr><tr><td><code>restartPolicy</code></td><td>é€šå¸¸è®¾ç½®ä¸º <code>OnFailure</code>ï¼Œå¤±è´¥æ—¶é‡è¯•</td></tr><tr><td><code>suspend</code></td><td>å¯è®¾ä¸º <code>true</code> æš‚åœ CronJob æ‰§è¡Œ</td></tr></tbody></table>
<p>ç¤ºä¾‹ï¼šæ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡ä»»åŠ¡</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CronJob</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">hello-cronjob</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">schedule:</span> <span class="hljs-string">"0 0 * * *"</span>  <span class="hljs-comment"># crontab æ ¼å¼ï¼šæ¯å¤©0ç‚¹</span>
  <span class="hljs-attr">jobTemplate:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">template:</span>
        <span class="hljs-attr">spec:</span>
          <span class="hljs-attr">containers:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span>
              <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
              <span class="hljs-attr">args:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Hello from CronJob at $(date)"</span>
          <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">OnFailure</span>

</code></pre>
<p><code>schedule</code> ä½¿ç”¨çš„æ˜¯ç±» Unix çš„ cron è¡¨è¾¾å¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs">åˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
</code></pre>





















<table><thead><tr><th>ç¤ºä¾‹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>*/5 * * * *</code></td><td>æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</td></tr><tr><td><code>0 0 * * *</code></td><td>æ¯å¤©åˆå¤œ 0 ç‚¹æ‰§è¡Œ</td></tr><tr><td><code>0 9 * * 1</code></td><td>æ¯å‘¨ä¸€æ—©ä¸Š 9 ç‚¹æ‰§è¡Œ</td></tr></tbody></table>
<p>CronJob çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<pre><code class="hljs language-lua" lang="lua">æ—¶é—´è§¦å‘å™¨ (schedule)
        â†“
   +<span class="hljs-comment">-----------+</span>
   |  CronJob  | â† è´Ÿè´£æŒ‰ç…§ schedule è§¦å‘ Job
   +<span class="hljs-comment">-----------+</span>
        â†“
   +<span class="hljs-comment">-----------+</span>
   |   Job     | â† ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆæ§åˆ¶å™¨ï¼‰
   +<span class="hljs-comment">-----------+</span>
        â†“
   +<span class="hljs-comment">-----------+</span>
   |   Pod     | â† å®é™…æ‰§è¡Œä»»åŠ¡çš„å®¹å™¨
   +<span class="hljs-comment">-----------+</span>

</code></pre>
<p>å¸¸ç”¨å‘½ä»¤ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># è·å–é›†ç¾¤ä¸­æ‰€æœ‰CronJobèµ„æºçš„åˆ—è¡¨</span>
kubectl get cronjob
<span class="hljs-comment"># æŸ¥çœ‹åä¸º hello-cronjob çš„ CronJob èµ„æºçš„è¯¦ç»†ä¿¡æ¯</span>
kubectl describe cronjob hello-cronjob
<span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰çš„ Job èµ„æº</span>
kubectl get <span class="hljs-built_in">jobs</span>
<span class="hljs-comment"># æŸ¥çœ‹ä¸æŒ‡å®š Job ç›¸å…³çš„ Pod çš„æ—¥å¿—</span>
kubectl logs &lt;job-created-pod-name&gt;

</code></pre>
<h2 data-id="heading-56">å››ã€è‡ªåŠ¨ä¼¸ç¼©ï¼ˆHPAï¼‰</h2>
<p><strong>HPAï¼ˆHorizontal Pod Autoscalerï¼Œæ°´å¹³ Pod è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰</strong> æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®ƒä¼šæ ¹æ®CPUã€å†…å­˜æˆ–è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œè‡ªåŠ¨è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°é‡ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒè´Ÿè½½æƒ…å†µä¸‹éƒ½èƒ½å¹³ç¨³è¿è¡Œã€‚</p>
<h3 data-id="heading-57">4.1 HPA çš„å·¥ä½œåŸç†</h3>
<ul>
<li>HPA ç›‘æµ‹ç›®æ ‡ Pod èµ„æºä½¿ç”¨æƒ…å†µï¼ˆé»˜è®¤ç›‘æµ‹ CPUï¼‰ã€‚</li>
<li>å¦‚æœ CPU æˆ–å…¶ä»–æŒ‡æ ‡é«˜äºè®¾å®šé˜ˆå€¼ï¼Œå°±è‡ªåŠ¨<strong>å¢åŠ </strong> Pod å‰¯æœ¬æ•°ã€‚</li>
<li>å¦‚æœ CPU æˆ–å…¶ä»–æŒ‡æ ‡ä½äºè®¾å®šé˜ˆå€¼ï¼Œå°±è‡ªåŠ¨<strong>å‡å°‘</strong> Pod å‰¯æœ¬æ•°ã€‚</li>
</ul>
<h3 data-id="heading-58">4.2 å¦‚ä½•ä½¿ç”¨ HPAï¼Ÿ</h3>
<h4 data-id="heading-59">4.2.1 ç¡®ä¿ Metrics Server å·²å®‰è£…</h4>
<p>HPA éœ€è¦ <code>metrics-server</code> æä¾› Pod èµ„æºä½¿ç”¨æ•°æ®ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get apiservices | grep metrics
</code></pre>
<p>å¦‚æœ <code>metrics.k8s.io</code> æ²¡æœ‰è¿è¡Œï¼Œéœ€è¦å®‰è£…ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</code></pre>
<h4 data-id="heading-60">4.2.2 åˆ›å»ºä¸€ä¸ª Deployment</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">php-apache</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">php-apache</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/hpa-example</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>
            <span class="hljs-attr">limits:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span>
</code></pre>
<p>æ³¨æ„ï¼šHPA éœ€è¦ <code>resources.requests.cpu</code> è¿›è¡Œåˆ¤æ–­ï¼Œå› æ­¤ Pod å¿…é¡»æŒ‡å®š <code>cpu requests</code> å€¼ï¼Œå¦åˆ™ HPA ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<h4 data-id="heading-61">4.2.3 åˆ›å»º HPA è§„åˆ™ï¼ˆåŸºäº CPU è‡ªåŠ¨æ‰©ç¼©ï¼‰</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache-hpa</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scaleTargetRef:</span>
    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache</span>   <span class="hljs-comment"># å…³è”çš„ Deployment</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># æœ€å°‘ 1 ä¸ªå‰¯æœ¬</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>       <span class="hljs-comment"># æœ€å¤š 10 ä¸ªå‰¯æœ¬</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span>
      <span class="hljs-attr">resource:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">cpu</span>
        <span class="hljs-attr">target:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">Utilization</span>
          <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">50</span>  <span class="hljs-comment"># CPU ä½¿ç”¨ç‡è¶…è¿‡ 50% æ—¶æ‰©å®¹</span>
</code></pre>
<h4 data-id="heading-62">4.2.4 åº”ç”¨ä¸æŸ¥çœ‹ HPA è§„åˆ™</h4>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f hpa.yaml
kubectl get hpa
</code></pre>
<p>ç¤ºä¾‹è¾“å‡ºï¼š</p>
<pre><code class="hljs language-bash" lang="bash">NAME            REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache-hpa  Deployment/php-apache  60%/50%  1         10        3         5m
</code></pre>
<ul>
<li><code>TARGETS 60%/50%</code>ï¼šå½“å‰ CPU ä½¿ç”¨ç‡ 60%ï¼ŒHPA ç›®æ ‡æ˜¯ 50%ã€‚</li>
<li><code>REPLICAS 3</code>ï¼šHPA è‡ªåŠ¨æ‰©å±•äº† 3 ä¸ª Podã€‚</li>
</ul>
<hr>
<h4 data-id="heading-63">4.2.5 æ¨¡æ‹Ÿé«˜è´Ÿè½½ï¼ˆæµ‹è¯• HPAï¼‰</h4>
<p>å¯ä»¥ä½¿ç”¨ <code>busybox</code> æŒç»­å‹æµ‹ Pod çš„ CPUï¼š</p>
<pre><code class="hljs language-bash" lang="bash">kubectl run -i --<span class="hljs-built_in">tty</span> busybox --image=busybox -- sh
<span class="hljs-comment"># åœ¨ BusyBox ç»ˆç«¯é‡Œæ‰§è¡Œ</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span> wget -q -O- http://php-apache; <span class="hljs-keyword">done</span>
</code></pre>
<p>è§‚å¯Ÿ HPA å˜åŒ–ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get hpa -w
</code></pre>
<h4 data-id="heading-64">4.2.6 è¿›é˜¶-åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡æ‰©ç¼©å®¹</h4>
<p>HPA ä¹Ÿå¯ä»¥åŸºäº<strong>å†…å­˜ä½¿ç”¨é‡</strong>æˆ–<strong>Prometheus è‡ªå®šä¹‰æŒ‡æ ‡</strong>è¿›è¡Œæ‰©ç¼©å®¹ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">metrics:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span>
    <span class="hljs-attr">resource:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">memory</span>
      <span class="hljs-attr">target:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Utilization</span>
        <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">70</span>  <span class="hljs-comment"># å½“å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 70% æ—¶æ‰©å®¹</span>
</code></pre>
<p>æˆ–è€…åŸºäº <strong>Prometheus ç›‘æ§æŒ‡æ ‡</strong> è¿›è¡Œæ‰©å®¹ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">metrics:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">External</span>
    <span class="hljs-attr">external:</span>
      <span class="hljs-attr">metric:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">requests_per_second</span> 
      <span class="hljs-attr">target:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">AverageValue</span>
        <span class="hljs-attr">averageValue:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># æ¯ç§’è¯·æ±‚è¶…è¿‡1000æ¬¡æ‰©å®¹</span>
</code></pre>
<h3 data-id="heading-65">4.3 æ€ä¹ˆè§£å†³èµ„æºä¸è¶³é—®é¢˜ï¼Ÿ</h3>
<p>HPA æ‰©å±•çš„ Pod æ‰€éœ€çš„ç¡¬ä»¶èµ„æºï¼Œæ¥è‡ªé›†ç¾¤ä¸­å·²æœ‰çš„ Nodeï¼ˆèŠ‚ç‚¹ï¼‰èµ„æºæ± ã€‚å¦‚æœ Nodeä¸Šæ²¡æœ‰è¶³å¤Ÿèµ„æºå®¹çº³æ–°çš„ Podï¼ŒPod ä¼š<strong>å¤„äº Pending çŠ¶æ€</strong>ï¼Œç›´åˆ°æœ‰èµ„æºè°ƒåº¦ã€‚ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<ol>
<li>é›†ç¾¤ä¸­æœ‰ 3 ä¸ª Nodeï¼Œæ¯ä¸ª Node æœ‰ 2 æ ¸ CPU å’Œ 4G å†…å­˜ã€‚</li>
<li>æ¯ä¸ª Pod è¦æ±‚ <code>cpu: 500m</code>ã€‚</li>
<li>åˆå§‹çŠ¶æ€è¿è¡Œäº† 6 ä¸ª Podï¼Œæ­£å¥½å æ»¡èµ„æº(ç†è®ºä¸Šæœ€å¤šèƒ½è¿è¡Œ <strong>12 ä¸ª Pod</strong>ï¼Œä½†æˆ‘ä»¬è¯´<strong>6 ä¸ª Pod å°±å æ»¡èµ„æº</strong>ï¼Œæ˜¯å› ä¸ºç°å®ä¸­ä¸èƒ½è¿™ä¹ˆç†æƒ³åŒ–è®¡ç®—ï¼Œç³»ç»Ÿç»„ä»¶ä¹Ÿå èµ„æºï¼Œå†é¢„ç•™ä¸€äº› buffer æ¥åº”å¯¹æ³¢åŠ¨ã€è°ƒåº¦ç­–ç•¥ç­‰ï¼Œ6~8 ä¸ª Pod å°±å¯èƒ½æ¥è¿‘æé™äº†)ã€‚</li>
<li>è´Ÿè½½å‡é«˜ï¼ŒHPA è§¦å‘æ‰©å®¹ä¸º 8 ä¸ª Podã€‚</li>
</ol>
<p>ç»“æœï¼šæ–°åˆ›å»ºçš„ 2 ä¸ª Pod ä¼š <strong>Pendingï¼ˆç­‰å¾…ï¼‰</strong> ï¼Œå› ä¸ºæ²¡æœ‰ Node æœ‰è¶³å¤Ÿèµ„æºè¿è¡Œå®ƒä»¬ã€‚</p>
<p>æ€ä¹ˆè§£å†³èµ„æºä¸è¶³é—®é¢˜ï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<h4 data-id="heading-66">4.3.1 æ‰‹åŠ¨æ·»åŠ èŠ‚ç‚¹ï¼ˆæ‰©å®¹é›†ç¾¤ï¼‰</h4>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºæ­å»ºçš„é›†ç¾¤ï¼Œå¯ä»¥æ‰‹åŠ¨åŠ å…¥æ›´å¤š Nodeã€‚</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æ·»åŠ æ–°èŠ‚ç‚¹åï¼Œkubelet ä¼šå°†å…¶æ³¨å†Œè¿›é›†ç¾¤</span>
kubectl get nodes
</code></pre>
<h4 data-id="heading-67">4.3.2 ä½¿ç”¨ Cluster Autoscalerï¼ˆé›†ç¾¤è‡ªåŠ¨æ‰©å®¹ï¼‰</h4>
<blockquote>
<p>Cluster Autoscaler æ˜¯ Kubernetes å®˜æ–¹æä¾›çš„<strong>è‡ªåŠ¨æ·»åŠ /ç§»é™¤ Node çš„ç»„ä»¶</strong>ã€‚</p>
</blockquote>
<ul>
<li>å½“ Pod æ— æ³•è°ƒåº¦æ—¶ï¼ŒCluster Autoscaler ä¼šè‡ªåŠ¨å‘äº‘æœåŠ¡ç”³è¯·æ·»åŠ  Nodeã€‚</li>
<li>å½“æŸäº› Node ä¸Šæ²¡æœ‰è¿è¡Œä»»ä½• Pod å¹¶ç»´æŒä¸€æ®µæ—¶é—´ï¼Œè‡ªåŠ¨é‡Šæ”¾è¿™äº› Nodeã€‚</li>
</ul>
<p>æ”¯æŒçš„äº‘å¹³å°ï¼š</p>
<ul>
<li>GKEï¼ˆGoogleï¼‰</li>
<li>EKSï¼ˆAWSï¼‰</li>
<li>AKSï¼ˆAzureï¼‰</li>
<li>é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ä¹Ÿæœ‰ç±»ä¼¼ç»„ä»¶</li>
</ul>
<h4 data-id="heading-68">4.3.3 æœ€ä½³æ–¹æ¡ˆ</h4>
<p>æœ€ä½³å®è·µï¼šHPA + Cluster Autoscaler è”ç”¨ æ˜¯ç”Ÿäº§ç¯å¢ƒæœ€å¸¸è§åšæ³•ï¼š</p>
<ul>
<li>HPA æ ¹æ® CPU/å†…å­˜/è‡ªå®šä¹‰æŒ‡æ ‡è‡ªåŠ¨è°ƒæ•´ Pod æ•°é‡ã€‚</li>
<li>å¦‚æœèµ„æºä¸è¶³ï¼ŒCluster Autoscaler è‡ªåŠ¨ç”³è¯·èŠ‚ç‚¹ï¼Œä¿éšœ Pod æ­£å¸¸è¿è¡Œã€‚</li>
</ul>






























<table><thead><tr><th>ç±»åˆ«</th><th>HPA</th><th>Cluster Autoscaler</th></tr></thead><tbody><tr><td>æ§åˆ¶å¯¹è±¡</td><td>Pod å‰¯æœ¬æ•°é‡</td><td>Node æ•°é‡ï¼ˆç¡¬ä»¶èµ„æºï¼‰</td></tr><tr><td>æ˜¯å¦è‡ªåŠ¨</td><td>æ˜¯</td><td>æ˜¯ï¼ˆéœ€é…ç½®ï¼‰</td></tr><tr><td>æ˜¯å¦ç«‹å³ç”Ÿæ•ˆ</td><td>å¿«é€Ÿ</td><td>äº‘å¹³å°èµ„æºç”³è¯·ç•¥æ…¢</td></tr><tr><td>è§£å†³é—®é¢˜</td><td>åº”å¯¹åº”ç”¨å±‚è´Ÿè½½å˜åŒ–</td><td>åº”å¯¹ç‰©ç†èµ„æºä¸è¶³</td></tr></tbody></table>
<h2 data-id="heading-69">ç»“è¯­</h2>
<p>è‚šå­æœ‰ç‚¹é¥¿ï¼Œä»Šå¤©å…ˆå†™åˆ°è¿™é‡Œï¼Œä¸‹ç¯‡æ˜å¤©å†ç»­å†™ã€‚</p></div></div>