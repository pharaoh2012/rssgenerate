
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/starlitnightly/p/18919221" title="发布于 2025-06-08 11:40">
    <span role="heading" aria-level="2">单细胞最好的教程(十八): 细胞类型映射到细胞本体论：让你的单细胞注释更专业！</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="细胞类型映射到细胞本体论让你的单细胞注释更专业">细胞类型映射到细胞本体论：让你的单细胞注释更专业！</h1>
<blockquote>
<p>作者按</p>
<p>在单细胞数据分析领域，标准化的细胞类型注释对于数据整合和比较研究至关重要。本文将介绍如何使用Cell Ontology（细胞本体论）来规范化你的细胞类型注释，提高研究的可重复性和可比性。本教程首发于<a href="https://single-cell-tutorial.readthedocs.io/zh/latest/" target="_blank" rel="noopener nofollow">单细胞最好的中文教程</a>，未经授权许可，禁止转载。</p>
<p><strong>全文字数|预计阅读时间</strong>: ～4000 | 5min</p>
<p>——Starlitnightly（星夜）</p>
</blockquote>
<h2 id="-什么是细胞本体论cell-ontology">🔍 什么是细胞本体论（Cell Ontology）？</h2>
<p>细胞本体论（CL）是一个专门用于分类和描述不同生物体中细胞类型的标准化系统。作为模式生物和生物信息学数据库的重要资源，它具有以下特点：</p>
<ul>
<li>📚 包含超过2700种动物细胞类型的详细分类</li>
<li>提供高层次的细胞类型分类标准</li>
<li>可以作为其他物种（如植物本体论或果蝇解剖学本体论）中细胞类型的映射参考</li>
<li>与其他本体论（如Uberon、GO、CHEBI、PR和PATO）无缝集成</li>
<li>能够将细胞类型与解剖结构、生物过程等相关概念建立联系</li>
</ul>
<blockquote>
<p>💡 提示：使用标准化的细胞本体论可以大大提高你的研究结果在国际上的认可度和引用率！</p>
<p>细胞本体 (CL) 创建于 2004 年，自 OBO Foundry 成立以来一直是其核心本体。自那时起，CL 已被各种项目采用，包括 HuBMAP 项目、人类细胞图谱 (HCA)、cellxgene 平台、单细胞表达图谱、BRAIN 倡议细胞普查网络 (BICCN)、ArrayExpress、细胞图像库 (The Cell Image Library)、ENCODE 和 FANTOM5，用于注释细胞类型并促进细胞参考图谱绘制</p>
</blockquote>
<p>在这里，我们提供了几个强大的函数，可以将你注释的细胞名称智能转换为对应的细胞本体论名称和ID。所有分析都通过<code>omicverse.single.CellOntologyMapper</code>类来完成。让我们开始动手实践吧！</p>
<pre><code class="language-python">import scanpy as sc
#import pertpy as pt
import omicverse as ov
ov.plot_set()

%load_ext autoreload
%autoreload 2
</code></pre>
<h2 id="-数据准备">📊 数据准备</h2>
<p>在开始转换细胞名称之前，你需要先完成细胞注释。在本教程中，我们使用了来自<code>pertpy</code>的haber_2017_regions数据集作为示例。这是一个来自小肠的单细胞测序数据集，包含了多种上皮细胞类型。</p>
<pre><code class="language-python">import pertpy as pt
adata = pt.dt.haber_2017_regions()
adata.obs['cell_label'].unique()
</code></pre>
<pre><code>['Enterocyte.Progenitor', 'Stem', 'TA.Early', 'TA', 'Tuft', 'Enterocyte', 'Goblet', 'Endocrine']
Categories (8, object): ['Endocrine', 'Enterocyte', 'Enterocyte.Progenitor', 'Goblet', 'Stem', 'TA', 'TA.Early', 'Tuft']
</code></pre>
<h2 id="️-下载cl模型">⬇️ 下载CL模型</h2>
<p>在开始分析之前，我们需要从Cell Ontology下载<code>cl.json</code>文件。这个文件包含了完整的细胞本体论数据库。我们提供了多种下载方式：</p>
<h3 id="方式一命令行下载">方式一：命令行下载</h3>
<pre><code class="language-shell"># 从OBO页面下载cl.ono
!mkdir new_ontology
!wget http://purl.obolibrary.org/obo/cl/cl.json -O new_ontology/cl.json
</code></pre>
<h3 id="方式二自动下载推荐新手">方式二：自动下载（推荐新手）</h3>
<p>我们提供了一个名为<code>omicverse.single.download_cl()</code>的函数来自动完成下载过程。这个函数特别智能，即使遇到网络问题，它也能自动选择最佳的下载源。</p>
<h3 id="方式三手动下载网络受限时的备选方案">方式三：手动下载（网络受限时的备选方案）</h3>
<p>如果你的网络访问受限，可以使用以下链接手动下载：</p>
<ul>
<li>🌏 Google Drive链接：<a href="https://drive.google.com/uc?export=download&amp;id=1niokr5INjWFVjiXHfdCoWioh0ZEYCPkv" target="_blank" rel="noopener nofollow">https://drive.google.com/uc?export=download&amp;id=1niokr5INjWFVjiXHfdCoWioh0ZEYCPkv</a></li>
<li>🇨🇳 蓝奏云链接（国内用户推荐）：<a href="https://www.lanzoup.com/iN6CX2ybh48h" target="_blank" rel="noopener nofollow">https://www.lanzoup.com/iN6CX2ybh48h</a></li>
</ul>
<pre><code class="language-python">ov.single.download_cl(output_dir="new_ontology", filename="cl.json")
</code></pre>
<pre><code>Downloading Cell Ontology to: new_ontology/cl.json
============================================================

[1/3] Trying Official OBO Library...
    URL: http://purl.obolibrary.org/obo/cl/cl.json
    Description: Direct download from official Cell Ontology
    → Downloading...
</code></pre>
<h2 id="️-配置cellontologymapper">🛠️ 配置CellOntologyMapper</h2>
<p>CellOntologyMapper的核心是基于SentenceTransformer的NLP嵌入模型。选择合适的模型对于映射效果至关重要：</p>
<table>
<thead>
<tr>
<th>模型名称</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>BAAI/bge-base-en-v1.5</td>
<td>性能最优</td>
<td>需要高精度的正式分析</td>
</tr>
<tr>
<td>BAAI/bge-small-en-v1.5</td>
<td>速度快</td>
<td>快速测试或小规模数据</td>
</tr>
<tr>
<td>sentence-transformers/all-MiniLM-L6-v2</td>
<td>平衡型</td>
<td>日常分析使用</td>
</tr>
</tbody>
</table>
<p>你也可以在huggingface的官网找到更多的模型：<a href="https://hf-mirror.com/models?library=sentence-transformers" target="_blank" rel="noopener nofollow">https://hf-mirror.com/models?library=sentence-transformers</a></p>
<blockquote>
<p>💡 小贴士：如果你的计算资源充足，建议使用BAAI/bge-base-en-v1.5获得最佳效果。</p>
</blockquote>
<pre><code class="language-python"># 
mapper = ov.single.CellOntologyMapper(
    cl_obo_file="new_ontology/cl.json",
    model_name="sentence-transformers/all-MiniLM-L6-v2",
    local_model_dir="./my_models"
)
</code></pre>
<pre><code>🔨 Creating ontology resources from OBO file...
📖 Parsing ontology file...
🧠 Creating NLP embeddings...
🔄 Loading model sentence-transformers/all-MiniLM-L6-v2...
🌐 Checking network connectivity...
✓ Network connection available
🇨🇳 Using HF-Mirror (hf-mirror.com) for faster downloads in China
📁 Models will be saved to: ./my_models
🪞 Downloading model from HF-Mirror: sentence-transformers/all-MiniLM-L6-v2
✓ Model loaded successfully from HF-Mirror!
🔄 Encoding 16841 ontology labels...
</code></pre>
<p>你也可以直接加载运行计算好的细胞本体的嵌入，这对于cpu用户而言特别有帮助。</p>
<pre><code class="language-python">mapper = ov.single.CellOntologyMapper(
    cl_obo_file="new_ontology/cl.json",
    embeddings_path='new_ontology/ontology_embeddings.pkl',
    local_model_dir="./my_models"
)
</code></pre>
<pre><code>📥 Loading existing ontology embeddings...
📥 Loaded embeddings for 16841 ontology labels
📋 Ontology mappings loaded: 16841 cell types
</code></pre>
<h2 id="细胞类型名称映射">细胞类型名称映射</h2>
<p>我们可以使用 <code>map_adata</code> 来直接映射我们的细胞类型，并且我们可以可视化</p>
<pre><code class="language-python">mapping_results = mapper.map_adata(
    adata, 
    cell_name_col='cell_label'
)
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/3469728/202506/3469728-20250608113709643-154588352.png" alt="" loading="lazy"></p>
<h2 id="-使用llm辅助细胞类型映射">🤖 使用LLM辅助细胞类型映射</h2>
<p>在实际工作中，研究者经常使用缩写来命名细胞类型（比如<code>TA</code>代表Transit Amplifying cell，<code>EC</code>代表Endothelial cell）。这些缩写可能会影响与细胞本体论的匹配效果。为解决这个问题，我们创新性地引入了LLM（大语言模型）来智能解析这些缩写。</p>
<h3 id="配置参数说明">配置参数说明：</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>api_type</td>
<td>API类型</td>
<td>openai, anthropic, ollama</td>
</tr>
<tr>
<td>tissue_context</td>
<td>组织来源</td>
<td>"gut", "brain", "liver"</td>
</tr>
<tr>
<td>species</td>
<td>研究物种</td>
<td>"mouse", "human", "rat"</td>
</tr>
<tr>
<td>study_context</td>
<td>研究背景</td>
<td>"肠道上皮细胞单细胞测序"</td>
</tr>
<tr>
<td>api_key</td>
<td>API密钥</td>
<td>"sk-..."</td>
</tr>
</tbody>
</table>
<blockquote>
<p>⚠️ 安全提示：请妥善保管你的API密钥，不要将其暴露在公开环境中。</p>
</blockquote>
<pre><code class="language-python">mapper.setup_llm_expansion(
    api_type="openai", model='gpt-4o-2024-11-20',
    tissue_context="gut",    # 组织上下文
    species="mouse",                   # 物种信息
    study_context="Epithelial cells from the small intestine and organoids of mice. Some of the cells were also subject to Salmonella or Heligmosomoides polygyrus infection",
    api_key="sk-*"
)

</code></pre>
<pre><code>✓ Loaded 10 cached abbreviation expansions
✓ LLM expansion functionality setup complete (Type: openai, Model: gpt-4o-2024-11-20)
🧬 Tissue context: gut
🔬 Study context: Epithelial cells from the small intestine and organoids of mice. Some of the cells were also subject to Salmonella or Heligmosomoides polygyrus infection
🐭 Species: mouse
</code></pre>
<p>你可以选择任何符合openai规则的api作为输入，例如<code>ohmygpt</code>.</p>
<pre><code class="language-python">mapper.setup_llm_expansion(
    api_type="custom_openai",
    api_key="sk-*",
    model="gpt-4.1-2025-04-14",
    base_url="https://api.ohmygpt.com/v1"
)
</code></pre>
<h2 id="大语言模型辅助映射">大语言模型辅助映射</h2>
<pre><code class="language-python">mapping_results = mapper.map_adata_with_expansion(
    adata=adata,
    cell_name_col='cell_label',
    threshold=0.5,
    expand_abbreviations=True  # 启用缩写扩展
)
mapper.print_mapping_summary(mapping_results, top_n=15)
</code></pre>
<pre><code>  🔤 Identified potential abbreviation: Stem
  🔤 Identified potential abbreviation: TA.Early
  🔤 Identified potential abbreviation: TA
  🔤 Identified potential abbreviation: Tuft
  🔤 Identified potential abbreviation: Goblet

🤖 Expanding 5 abbreviations using LLM...
  📝 [1/5] Expanding: Stem
    ✓ → Intestinal stem cell (Confidence: high)
    💡 Alternatives: Stem cell, Crypt stem cell
  📝 [2/5] Expanding: TA.Early
    ✓ → Transit Amplifying Early cell (Confidence: high)
    💡 Alternatives: Transit Amplifying progenitor cell (early stage), Transient Amplifying Early cell
  📝 [3/5] Expanding: TA
    ✓ → Transit amplifying cell (Confidence: high)
    💡 Alternatives: Tumor-associated cell, T cell activation-related cell
  📝 [4/5] Expanding: Tuft
    ✓ → Tuft cell (Confidence: high)
    💡 Alternatives: Brush cell
  📝 [5/5] Expanding: Goblet
    ✓ → Goblet cell (Confidence: high)


✓ Tuft -&gt; tuft cell (Similarity: 0.787)
✓ Enterocyte -&gt; enterocyte (Similarity: 0.776)
✓ TA -&gt; transit amplifying cell of appendix (Similarity: 0.741)
✓ Stem -&gt; intestinal crypt stem cell (Similarity: 0.735)
✓ Goblet -&gt; small intestine goblet cell (Similarity: 0.734)
✓ Enterocyte.Progenitor -&gt; enterocyte differentiation (Similarity: 0.688)
✓ TA.Early -&gt; transit amplifying cell (Similarity: 0.688)
✓ Endocrine -&gt; endocrine hormone secretion (Similarity: 0.643)
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/3469728/202506/3469728-20250608113723148-458826044.png" alt="" loading="lazy"></p>
<p>我们可以发现<code>TA</code> 和 <code>TA.Early</code>在扩写了细胞名称后，被成功映射到了对应的细胞。</p>
<pre><code class="language-python">adata.obs[['cell_label','cell_ontology','cell_ontology_similarity',
          'cell_ontology_ontology_id','cell_ontology_ontology_id','cell_ontology_cl_id']].head()
</code></pre>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right">
      <th></th>
      <th>cell_label</th>
      <th>cell_ontology</th>
      <th>cell_ontology_similarity</th>
      <th>cell_ontology_ontology_id</th>
      <th>cell_ontology_ontology_id</th>
      <th>cell_ontology_cl_id</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B1_AAACATACCACAAC_Control_Enterocyte.Progenitor</th>
      <td>Enterocyte.Progenitor</td>
      <td>enterocyte differentiation</td>
      <td>0.688446</td>
      <td>http://purl.obolibrary.org/obo/GO_1903703</td>
      <td>http://purl.obolibrary.org/obo/GO_1903703</td>
      <td>None</td>
    </tr>
    <tr>
      <th>B1_AAACGCACGAGGAC_Control_Stem</th>
      <td>Stem</td>
      <td>intestinal crypt stem cell</td>
      <td>0.735365</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>CL:0002250</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTAGCCA_Control_Stem</th>
      <td>Stem</td>
      <td>intestinal crypt stem cell</td>
      <td>0.735365</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>CL:0002250</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTGTCCC_Control_Stem</th>
      <td>Stem</td>
      <td>intestinal crypt stem cell</td>
      <td>0.735365</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>http://purl.obolibrary.org/obo/CL_0002250</td>
      <td>CL:0002250</td>
    </tr>
    <tr>
      <th>B1_AAACTTGACCACCT_Control_Enterocyte.Progenitor</th>
      <td>Enterocyte.Progenitor</td>
      <td>enterocyte differentiation</td>
      <td>0.688446</td>
      <td>http://purl.obolibrary.org/obo/GO_1903703</td>
      <td>http://purl.obolibrary.org/obo/GO_1903703</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
<h2 id="-映射结果检验">🔍 映射结果检验</h2>
<p>为确保映射结果的准确性，我们提供了多种验证方法：</p>
<ol>
<li>手动查询匹配结果</li>
<li>检查相似度分数</li>
<li>验证本体论ID</li>
</ol>
<h3 id="实用技巧">实用技巧：</h3>
<ul>
<li>相似度分数 &gt; 0.7：高度可信</li>
<li>相似度分数 0.5-0.7：需要人工核验</li>
<li>相似度分数 &lt; 0.5：建议使用LLM辅助或手动映射</li>
</ul>
<pre><code class="language-python">res=mapper.find_similar_cells("T helper cell", top_k=10)
res=mapper.find_similar_cells("Macrophage", top_k=8)

</code></pre>
<pre><code>🎯 Ontology cell types most similar to 'T helper cell':
 1. helper T cell                            (Similarity: 0.780)
 2. T-helper 1 cell activation               (Similarity: 0.738)
 3. T-helper 2 cell activation               (Similarity: 0.709)
 4. T-helper 9 cell                          (Similarity: 0.707)
 5. T-helper 2 cell                          (Similarity: 0.690)
 6. T-helper 1 cell                          (Similarity: 0.687)
 7. T cell domain                            (Similarity: 0.678)
 8. regulation of T-helper 1 cell activation (Similarity: 0.675)
 9. CD4-positive helper T cell               (Similarity: 0.664)
10. T-helper 1 cell cytokine production      (Similarity: 0.660)

🎯 Ontology cell types most similar to 'Macrophage':
 1. cycling macrophage                       (Similarity: 0.786)
 2. tissue-resident macrophage               (Similarity: 0.735)
 3. macrophage differentiation               (Similarity: 0.729)
 4. macrophage                               (Similarity: 0.719)
 5. epithelioid macrophage                   (Similarity: 0.718)
 6. macrophage migration                     (Similarity: 0.692)
 7. kidney interstitial alternatively activated macrophage (Similarity: 0.686)
 8. central nervous system macrophage        (Similarity: 0.685)
</code></pre>
<h3 id="获取本体论中的细胞信息">获取本体论中的细胞信息</h3>
<pre><code class="language-python">mapper.get_cell_info("regulatory T cell")
</code></pre>
<pre><code>ℹ️  === regulatory T cell ===
🆔 Ontology ID: http://purl.obolibrary.org/obo/CL_0000815
📝 Description: regulatory T cell: A T cell which regulates overall immune responses as well as the responses of other T cell subsets through direct cell-cell contact and cytokine release. This cell type may express FoxP3 and CD25 and secretes IL-10 and TGF-beta.
</code></pre>
<h3 id="获取本体论中的细胞信息-1">获取本体论中的细胞信息</h3>
<pre><code class="language-python">mapper.get_cell_info("regulatory T cells")
</code></pre>
<pre><code>✗ Cell type not found: regulatory T cells
🔍 Found 0 cell types containing 'regulatory t cells':
</code></pre>
<h3 id="获取本体论中的细胞类别的信息">获取本体论中的细胞类别的信息</h3>
<pre><code class="language-python">my_categories = ["immune cell", "epithelial"]
mapper.browse_ontology_by_category(categories=my_categories, max_per_category=5)
</code></pre>
<pre><code>📂 === Browse Ontology Cell Types by Category ===

🔍 Found 0 cell types containing 'immune cell':
--------------------------------------------------
🔍 Found 395 cell types containing 'epithelial':
  1. NS forest marker set of airway submucosal gland collecting duct epithelial cell (Human Lung).
  2. epithelial fate stem cell
  3. epithelial cell
  4. ciliated epithelial cell
  5. duct epithelial cell
... 390 more results

🏷️  【epithelial related】 (Showing top 5):
  1. NS forest marker set of airway submucosal gland collecting duct epithelial cell (Human Lung).
  2. epithelial fate stem cell
  3. epithelial cell
  4. ciliated epithelial cell
  5. duct epithelial cell
--------------------------------------------------
</code></pre>
<h3 id="查看本体论中的细胞信息">查看本体论中的细胞信息</h3>
<pre><code class="language-python"># 查看前50个细胞类型
res=mapper.list_ontology_cells(max_display=10)

</code></pre>
<pre><code>📊 Total 16841 cell types in ontology

📋 First 10 cell types:
  1. TAC1
  2. STAB1
  3. TLL1
  4. MSR1
  5. TNC
  6. ROS1
  7. TNIP3
  8. HOMER3
  9. FCGR2B
 10. BPIFB2
... 16831 more cell types
💡 Use return_all=True to get complete list
</code></pre>
<h3 id="了解本体论的整体情况">了解本体论的整体情况</h3>
<pre><code class="language-python"># 了解本体论的整体情况
stats = mapper.get_ontology_statistics()
</code></pre>
<pre><code>📊 === Ontology Statistics ===
📝 Total cell types: 16841
📏 Average name length: 31.7 characters
📏 Shortest name length: 3 characters
📏 Longest name length: 144 characters

🔤 Most common words:
  of: 5473 times
  cell: 3857 times
  regulation: 3168 times
  negative: 1009 times
  positive: 1003 times
  process: 980 times
  development: 875 times
  differentiation: 727 times
  muscle: 639 times
  in: 571 times
</code></pre>
<h2 id="-总结与展望">📈 总结与展望</h2>
<p>通过使用细胞本体论进行细胞类型映射，我们可以：</p>
<ol>
<li>🎯 实现细胞类型注释的标准化</li>
<li>📊 提高数据的可比性和可重复性</li>
<li>🔗 促进不同数据集之间的整合分析</li>
<li>🧬 发现细胞类型之间的生物学联系</li>
</ol>
<h3 id="最佳实践建议">最佳实践建议：</h3>
<ol>
<li>在发表论文时，同时提供原始注释和映射后的细胞本体论ID</li>
<li>定期更新细胞本体论数据库，保持与最新研究同步</li>
<li>建立标准化的细胞类型注释流程，提高研究效率</li>
</ol>
<blockquote>
<p>🎉 恭喜你完成了本教程！现在你已经掌握了专业的细胞类型映射方法。</p>
</blockquote>

</div>
<div id="MySignature" role="contentinfo">
    <p>本文来自博客园，作者：<a href="https://www.cnblogs.com/starlitnightly/" target="_blank">Starlitnightly</a>，转载请注明原文链接：<a href="https://www.cnblogs.com/starlitnightly/p/18919221" target="_blank">https://www.cnblogs.com/starlitnightly/p/18919221</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.031972123251157405" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-06-08 11:41">2025-06-08 11:40</span>&nbsp;
<a href="https://www.cnblogs.com/starlitnightly">Starlitnightly</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18919221);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18919221', targetLink: 'https://www.cnblogs.com/starlitnightly/p/18919221', title: '单细胞最好的教程(十八): 细胞类型映射到细胞本体论：让你的单细胞注释更专业！' })">举报</a>
</div>
        