
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/data-analytics/p/18880722" title="å‘å¸ƒäº 2025-05-16 22:11">
    <span role="heading" aria-level="2">ã€SQLå‘¨å‘¨ç»ƒã€‘ï¼šåˆ©ç”¨è¡Œè½¦è½¨è¿¹åˆ†æçŠ¯ç½ªåˆ†å­ä½œæ¡ˆåœ°ç‚¹</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250516221009090-900666690.png" alt="ã€SQLå‘¨å‘¨ç»ƒã€‘ï¼šåˆ©ç”¨è¡Œè½¦è½¨è¿¹åˆ†æçŠ¯ç½ªåˆ†å­ä½œæ¡ˆåœ°ç‚¹" class="desc_img">
        ã€SQLç ´æ¡ˆç³»åˆ—ã€‘ç¬¬ä¸€ç¯‡ï¼šå¦‚æœç›‘æ§æ‘„åƒå¤´æ‹ä¸‹äº†å¾ˆå¤šè½¦è¾†çš„è¡Œè½¦è½¨è¿¹ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ©ç”¨è¿™äº›è¡Œè½¦è½¨è¿¹æ¥åˆ†æè½¦è¾†è¿è¡Œçš„ç‰¹å¾ï¼Œæ˜¯ä¸æ˜¯èƒ½å¤Ÿåˆ†æå‡ºçŠ¯ç½ªåˆ†å­â€œè¸©ç‚¹â€çš„ä½ç½®
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯â€œè’‹ç‚¹æ•°åˆ†â€ï¼Œå¤šå¹´ä»¥æ¥ä¸€ç›´ä»äº‹æ•°æ®åˆ†æå·¥ä½œã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œä¸å¤§å®¶æŒç»­åˆ†äº«å…³äºæ•°æ®åˆ†æçš„å­¦ä¹ å†…å®¹ã€‚</p>
<p>æœ¬æ–‡æ˜¯ç¬¬ 7 ç¯‡ï¼Œä¹Ÿæ˜¯ã€SQL å‘¨å‘¨ç»ƒã€‘ç³»åˆ—çš„ç¬¬ 6 ç¯‡ã€‚è¯¥ç³»åˆ—æ˜¯æŒ‘é€‰æˆ–è‡ªåˆ›å…·æœ‰ä¸€äº›éš¾åº¦çš„ SQL é¢˜ç›®ï¼Œä¸€å‘¨è‡³å°‘æ›´æ–°ä¸€ç¯‡ã€‚åç»­åˆ›ä½œçš„å†…å®¹ï¼Œåˆæ­¥è§„åˆ’çš„æ–¹å‘åŒ…æ‹¬ï¼š</p>
<h2 id="åç»­å†…å®¹è§„åˆ’">åç»­å†…å®¹è§„åˆ’</h2>
<p>1.åˆ©ç”¨ <strong>Streamlit</strong> å®ç° <code>Hive å…ƒæ•°æ®å±•ç¤º</code>ã€<code>SQL ç¼–è¾‘å™¨</code>ã€ ç»“åˆ<code>Docker æ²™ç®±å®ç°æ•°æ®åˆ†æ Agent</code><br>
2.æ—¶é—´åºåˆ—å¼‚å¸¸è¯†åˆ«ã€å¼‚åŠ¨å½’å› ç®—æ³•<br>
3.ç•™å­˜ç‡æ‹Ÿåˆã€é¢„æµ‹ã€å»ºæ¨¡<br>
4.å­¦ä¹  <code>AB å®éªŒ</code>ã€å¤æ‚å®éªŒè®¾è®¡ç­‰<br>
5.<code>è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ </code>ã€è‡ªåŠ¨åŒ–ç‰¹å¾å·¥ç¨‹<br>
6.<code>å› æœæ¨æ–­</code>å­¦ä¹ <br>
7. â€¦â€¦</p>
<p><strong>æ¬¢è¿å…³æ³¨</strong>ï¼Œä¸€èµ·å­¦ä¹ ã€‚</p>
<h2 id="ç¬¬-6-æœŸé¢˜ç›®">ç¬¬ 6 æœŸé¢˜ç›®</h2>
<p>é¢˜ç›®æ¥æºï¼šçº¯è‡ªåˆ›é¢˜ç›®ï¼Œå—åˆ°ã€ŠThe SQL Murder Mysteryã€‹çš„å¯å‘ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨ SQL æ¥å¯»æ‰¾å‡¶æ‰‹çš„é¢˜ç›®ï¼›æˆ‘ç©è¿‡ä¹‹åï¼Œå¾ˆå—å¯å‘ï¼Œæƒ³å‡ºä¸€ä¸ªã€SQL ç ´æ¡ˆç³»åˆ—ã€‘ï¼Œä½†æ˜¯æˆ‘æƒ³è±¡åŠ›ä¸å¤Ÿã€æ–‡ç¬”ä¸€èˆ¬ã€‚å‰§æƒ…åˆè¦è®¾è®¡ä¸º SQL è§£é¢˜ï¼Œåªèƒ½æ”¾å¼ƒè¿™ä¸ªæ–¹å‘ã€‚ä»Šå¤©æ‹¿å‡ºæ¥ä¸€é“ä¹‹å‰è®¾è®¡çš„é¢˜ç›®ï¼šå°½ç®¡æ–‡ç¬”å’Œè®¾è®¡ä¸Šæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†æœ‰ç‚¹æ„æ€ã€‚æœ€å…³é”®ï¼Œæˆ‘åœ¨ 8 å¹´çš„æ•°æ®åˆ†æç»å†ï¼Œä»æ¥æ²¡æœ‰åœ¨ SQL ä¸­ä½¿ç”¨è¿‡ä¸‰è§’å‡½æ•°ï¼Œè€Œè¿™é“é¢˜ç›®å°±éœ€è¦ä½¿ç”¨ä¸‰è§’å‡½æ•°</p>
<h3 id="ä¸€é¢˜ç›®ä»‹ç»">ä¸€ã€é¢˜ç›®ä»‹ç»</h3>
<p>å¤§å®¶å¯ä»¥å…ˆçœ‹çœ‹æ•…äº‹èƒŒæ™¯ï¼Œè¿™æ˜¯ä¸¤ä¸ªå¤šæœˆå‰å†™çš„ã€‚å†™ä½œæ–¹æ³•æ˜¯æˆ‘æä¸€ä¸ªæ¢—æ¦‚ï¼Œç„¶åè®© Deepseek æˆ–è€… Qwen æ¶¦è‰²å’Œå‘æ•£ï¼›ç­‰å®ƒä»¬è¿”å›æ¥ç»“æœï¼Œæˆ‘å†å¸æ”¶å’Œæ›´æ”¹ï¼›ç„¶åå†æé—®å†æ›´æ”¹ï¼Œå¦‚æ­¤å¾€å¤äº”æ¬¡ä»¥ä¸Šã€‚æˆ‘è¿˜æ²¡æœ‰å°è¯•è¿‡ Gemini 2.5 pro æˆ– GPT æ¥å†™ã€‚</p>
<p>å¯¹æ•…äº‹ä¸æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è·³è¿‡ï¼Œåªæ˜¯æ•…äº‹æƒ…èŠ‚å¯¹é¢˜ç›®ç†è§£ç•¥æœ‰å¸®åŠ©ï¼š</p>
<pre><code class="language-text">å‡Œæ™¨ä¸‰ç‚¹ï¼ŒT å¸‚è¥¿éƒŠåˆ†å±€çš„èµ°å»Šæ˜ ç€æƒ¨ç™½çš„è§å…‰ï¼Œè¢­æ¥ä¸€ç§ä¸çœŸå®æ„Ÿã€‚åˆ‘è­¦é˜Ÿé•¿ç‹æ³½å®‡è„šæ­¥æ€¥ä¿ƒï¼Œå¾„ç›´èµ°å‘æ‹˜ç•™å®¤åŒºåŸŸï¼Œå€¼ç­å°çš„è­¦å‘˜å°ææ­£åœ¨è¸±æ­¥æŠµæŠ—å›°æ„ã€‚
â€œç‹é˜Ÿï¼Œæ‚¨äº²è‡ªæ¥äº†ï¼Œè¦æå®¡è°ï¼Ÿâ€ å°æçœ‹åˆ°ç‹é˜Ÿåä¸€ä¸ªæ¿€çµã€‚è¯éŸ³æœªè½ï¼Œè­¦å‘˜è€å¼ é»˜é»˜åœ°æ‹‰å¼€é€šé“çš„é“é—¨ã€‚
å‘ä¸¤åå€¼ç­è­¦å¯Ÿç‚¹å¤´ç¤ºæ„åï¼Œç‹é˜Ÿèµ°å…¥äº†é€šé“ï¼Œè„šæ­¥å£°ä¸å¤šæ—¶ä¾¿è¢«èµ°å»Šåå™¬ã€‚åªå‰©ä¸‹å¾®å¼±çš„ç”µæµå£°åœ¨ç©ºæ—·ä¸­å›è¡ã€‚
ä¸ƒæ‹å…«æ‹çš„ï¼Œç‹é˜Ÿåœåœ¨äº†ä¸€é—´éšè”½çš„æ‹˜ç•™å®¤ï¼Œè¿™ç‰‡åŒºåŸŸåªå…³æŠ¼ç€ç™½è¾‰ â€”â€” ä¸€ä¸ªæ¸¸èµ°åœ¨ç°è‰²åœ°å¸¦çš„å°æ··æ··ï¼Œä¹Ÿæ˜¯ç‹é˜Ÿçš„çº¿äººã€‚
éš”ç€é“æ …æ æœ›è¿‡å»ï¼Œç™½è¾‰ä»°é¢èººåœ¨åºŠæ¿ä¸Šï¼ŒåŒçœ¼ç›¯ç€å¤©èŠ±æ¿ã€‚æ˜¾ç„¶ï¼Œå·²ç»å¯Ÿè§‰åˆ°äº†æœ‰äººè¿‡æ¥ã€‚

â€œæ€ä¹ˆï¼Œä»€ä¹ˆè¯ä¸èƒ½åœ¨å¤–è¾¹è¯´ï¼Ÿéå¾—å–é…’é—¹äº‹ï¼Œè¿™ä¸ªç‚¹åœ¨è¿™å„¿è§é¢ã€‚â€ ç‹é˜Ÿæœ‰äº›å—”æ€ªã€‚
ç™½è¾‰ä½å»ç€èƒŒåèµ·èº«æ¥ï¼Œæ— å¥ˆç¬‘é“ï¼Œâ€œé“ä¸Šå…„å¼Ÿæ‰“ä¸ªå–·åšï¼Œéš”å¤©ä¸€åœˆå…¨å¾—æµæ„Ÿã€‚ä»Šå¤©æˆ‘æ”¶åˆ«äººçš„é£ï¼Œæ˜å¤©åˆ«äººå°±æ”¾æˆ‘çš„æ–™ã€‚â€
ç‹é˜Ÿè·¨å‰åŠæ­¥ï¼Œä½™å…‰æ’‡äº†çœ¼èµ°å»Šçš„æ‘„åƒå¤´ï¼Œå‹ä½å£°éŸ³ï¼Œâ€œè¯´å§ã€‚â€
â€œæ¥äº†æ‰¹è¿‡æ±Ÿé¾™ï¼Œç¡¬ç‚¹å­ã€‚å¯èƒ½ H çœçš„ã€‚â€ ç™½è¾‰é¡¿äº†é¡¿ï¼Œâ€œè€ K æ‚¨çŸ¥é“å§ï¼Ÿâ€
ç‹æ³½å®‡ç‚¹å¤´ç¤ºæ„ä»–ç»§ç»­ï¼Œâ€œè€ K çš„æ¶ç”Ÿå’ŒçƒŸèŠ±ç”Ÿæ„åˆ«è¯´åœ¨ T å¸‚ï¼ŒåŒ—æ–¹ä¹Ÿæ˜¯ä¸€å·å•Šã€‚é‡åˆ°è¿™å¸®äººï¼Œä¹Ÿæ€•äº†ã€‚â€
â€œè¿™ä¼™äººæ‰¾è€ K ä¹°æªå¼¹å’Œç‚¸Yï¼Œæé»‘åƒé»‘ï¼Ÿâ€ç‹é˜Ÿçœ‰å¤´ç´§é”ï¼Œè„‘æµ·ä¸­é£é€Ÿæ€è€ƒã€‚
ç™½è¾‰å’§å’§å˜´ï¼Œâ€œè€ K è¿™ç§è€ç‹ç‹¸ï¼Œå–æ¶ç”Ÿï¼Œå°å¼Ÿä»¬éƒ½èƒŒç€é›·ç®¡ã€‚â€
â€œè¿™ç§äº¤æ˜“é’±è´§ä¸¤æ¸…å¿…é¡»å¿«ï¼Œæ²¡æƒ³åˆ°è¿™ä¼™äººåœ¨äº¤æ˜“åœ°ç‚¹é™„è¿‘å¼€è½¦ç»•åœˆã€‚â€ ç™½è¾‰é£ŸæŒ‡åˆ’äº†ä¸¤ä¸ªåœˆï¼Œâ€œå¤–å›´æœ›é£å°å¼Ÿç«‹åˆ»é€šçŸ¥è€ Kï¼Œè€ K éƒ½å‡†å¤‡æ’¤äº†â€
â€œç»“æœä¸€é“çº¢è‰²æ¿€å…‰ç„å‡†äº†è€ K çš„èƒ¸å£â€¦â€¦ â€œ ç™½è¾‰å·®ç‚¹å‘›ä½ â€è™½ç„¶æœ€åäº¤æ˜“æˆåŠŸäº†ï¼Œä½†è€ K åˆ°å®¶è…¿è¿˜è½¯ç€ã€‚â€œ 
â€œä¸æ˜¯è€ K å“åï¼Œè¿™æ¶ˆæ¯èƒ½èµ°æ¼ä¹ˆã€‚â€ ç™½è¾‰å˜˜äº†å£æ°”ã€‚

ç‹é˜Ÿè¿½é—®â€œè¿˜æœ‰ä»€ä¹ˆæ¶ˆæ¯ã€‚â€ï¼Œç„¦æ€¥æƒ…ç»ªæº¢äºè¨€è¡¨ã€‚
ç™½è¾‰æ‘‡æ‘‡å¤´ï¼Œâ€œåªå¬è¯´æœ‰ä¸€ä¼™äººå®šäº†ä¸¤æ¡å¤§é£ï¼Œä¸‰å¤©åã€‚â€

ä¸‰åˆ†é’Ÿåï¼Œç‹é˜Ÿå·²ç»èµ¶åˆ°äº†æŠ€æœ¯ç§‘ï¼Œåˆ†æå¸ˆ J æ­£æ‰ç€å‘é…¸çš„åé¢ˆã€‚
â€œæƒ…å†µç´§æ€¥ï¼Œå° Jâ€¦â€¦ ä½ ç«‹åˆ»ç”¨é“è·¯ç›‘æ§ç³»ç»Ÿåˆ†æè¿‘æœŸå…¨å¸‚è½¦è¾†çš„è½¨è¿¹ï¼Œæ’æŸ¥å¯ç–‘è½¦è¾†ã€‚â€ è€ç‹è¯­æ°”æ€¥ä¿ƒã€‚
â€œæˆ‘åˆšæ‰å·²ç»é€šçŸ¥äº†å±€é•¿ï¼Œå±€é•¿å‘½ä»¤åŠå°æ—¶åå¼€ä¼šâ€ã€‚

åˆ†æå¸ˆ J é£é€Ÿæ•²ç€é”®ç›˜ï¼Œé“è·¯ç›‘è§†ç³»ç»Ÿé‡‡é›†çš„æµ·é‡è§†é¢‘å½±åƒï¼Œç»è¿‡ç®—æ³•é€æ¸è½¬ä¸ºç»“æ„åŒ–æ•°æ®æµå…¥é›†ç¾¤ã€‚
â€œè¿˜æœ‰ 10 åˆ†é’Ÿâ€ï¼ŒJ æ’‡äº†çœ¼å±å¹•å³ä¸‹è§’çš„æ—¶é—´ï¼Œæ²¡æ³¨æ„åˆ°ç‹æ³½å®‡å·²ç»ç¦»å¼€ï¼Œå¿ƒæƒ³ã€‚â€œç”¨è¿™ä¼™äººè¸©ç‚¹çš„ç‰¹å¾å»è¿½è¸ªâ€¦â€¦â€
</code></pre>
<p>æœ‰ä¸€å¼ æ•°æ®ä»“åº“çš„è¡¨ï¼Œé‡Œé¢æ˜¯é“è·¯å½±åƒè§†é¢‘èµ„æ–™æ ¹æ® CV ç®—æ³•åˆ†æå¾—åˆ°çš„ï¼ˆå’±è¿™å„¿å°±å½“å°è¯´ä¸ç®¡ç°å®å¯è¡Œæ€§ï¼‰ã€‚è¡¨é‡Œæœ‰å¦‚ä¸‹çš„æ•°æ®ï¼š<code>æ—¶é—´</code>ï¼Œ<code>è½¦ç‰Œå·</code>ï¼Œ<code>çº¬åº¦</code>ï¼Œ<code>ç»åº¦</code>ï¼ˆå‡è®¾æ‘„åƒå¤´æ‹åˆ°è½¦ç‰Œåï¼Œæ ¹æ®å•ç›®æµ‹è·ç®—æ³•å’Œæ‘„åƒå¤´æœ¬èº«çš„åæ ‡è®¡ç®—å‡ºè½¦è¾†çš„åæ ‡ï¼‰</p>
<p>æˆ‘ä»¬å‡è®¾è¿™ä¸ªæ•…äº‹ä¸­æ‘„åƒå¤´å¯†åº¦å¾ˆé«˜ï¼Œåˆ©ç”¨ä¸åŒæ‘„åƒå¤´è®°å½•çš„è½¦è¾†çš„åæ ‡å’Œæ—¶é—´å·®ï¼Œè®¡ç®—è¿™ä¸€å°æ®µè·ç¦»çš„å¹³å‡é€Ÿåº¦ã€‚å¦‚æœå¹³å‡é€Ÿåº¦åœ¨æŸä¸ªèŒƒå›´å†…è§†ä¸ºâ€œç–‘ä¼¼è¸©ç‚¹â€ï¼Œåœ¨å¦ä¸€ä¸ªèŒƒå›´è§†ä¸ºâ€œæ­£å¸¸è¡Œé©¶â€ï¼›å¹¶ä¸”æ•…äº‹è®¾è®¡çŠ¯ç½ªåˆ†å­ä¼šé©¾è½¦ä¸å¤šä¸å°‘åˆšå¥½å›´ç€ä½œæ¡ˆåœ°ç‚¹é™„è¿‘ç»•è¡Œä¸€åœˆï¼Œè¿™æ ·åˆ©ç”¨åæ ‡çš„å‡å€¼å°±å¯ä»¥æ±‚å¾—â€œè´¨å¿ƒ/ä¸­å¿ƒç‚¹â€ã€‚</p>
<p>é¢˜ç›®è§„å®šå°±æ˜¯æ±‚å‡ºè¿™ä¸ªâ€œè´¨å¿ƒ/ä¸­å¿ƒç‚¹â€ â€”â€” ä¹Ÿå°±æ˜¯è°‹åˆ’çŠ¯ç½ªçš„åœ°ç‚¹ã€‚</p>
<table>
<thead>
<tr>
<th>åˆ—å</th>
<th>æ•°æ®ç±»å‹</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>ts</td>
<td>string</td>
<td>æ—¶é—´<br>ï¼ˆä¸ºäº†è®¡ç®—å‡†ç¡®ï¼Œè¿™é‡Œç²¾ç¡®åˆ°å¾®ç§’ï¼‰</td>
</tr>
<tr>
<td>licence_plate</td>
<td>string</td>
<td>è½¦ç‰Œ</td>
</tr>
<tr>
<td>lagtitude</td>
<td>double</td>
<td>çº¬åº¦</td>
</tr>
<tr>
<td>longtitude</td>
<td>double</td>
<td>ç»åº¦</td>
</tr>
<tr>
<td>is_case_the_join</td>
<td>tinyint</td>
<td>æ˜¯å¦æœ‰ä¸ºè¸©ç‚¹<br>ï¼ˆåšé¢˜æ—¶ä¸ç”¨ï¼Œä¸ºäº†éªŒè¯æ•°æ®çš„<br>1-æ˜¯ï¼Œ0-å¦ï¼‰</td>
</tr>
</tbody>
</table>
<p>éƒ¨åˆ†æ ·ä¾‹æ•°æ®ï¼ˆå®Œæ•´ç”Ÿæˆé€»è¾‘å‚è§ç¬¬ä¸‰èŠ‚ï¼‰</p>
<table>
<thead>
<tr>
<th>ts</th>
<th>licence_plate</th>
<th>lagtitude</th>
<th>longtitude</th>
<th>is_case_the_joint</th>
</tr>
</thead>
<tbody>
<tr>
<td>2025-06-01 09:45:40.846060</td>
<td>J-9876</td>
<td>39.116034</td>
<td>117.194557</td>
<td>0</td>
</tr>
<tr>
<td>2025-06-01 09:45:44.176520</td>
<td>J-9876</td>
<td>39.116105</td>
<td>117.194074</td>
<td>0</td>
</tr>
<tr>
<td>2025-06-01 09:45:47.831298</td>
<td>J-9876</td>
<td>39.116346</td>
<td>117.194396</td>
<td>0</td>
</tr>
<tr>
<td>2025-06-01 09:45:52.131025</td>
<td>J-9876</td>
<td>39.116621</td>
<td>117.194836</td>
<td>0</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>2025-06-01 10:13:39.177957</td>
<td>J-9876</td>
<td>39.115997</td>
<td>117.195361</td>
<td>0</td>
</tr>
<tr>
<td>2025-06-01 10:13:43.865901</td>
<td>J-9876</td>
<td>39.11603</td>
<td>117.194675</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>æ³¨æ„ï¼Œæ¨¡æ‹Ÿæ•°æ®æ—¶ä¸ºäº†ç®€åŒ–ï¼Œåªè®¾ç½®äº†ä¸€ä¸ªè¾†è½¦å³ä¸€ä¸ªè½¦ç‰Œï¼Œä½†æ˜¯æˆ‘å†™ SQL çš„æ—¶å€™æ²¡æœ‰å¿½ç•¥æ‰è¿™ä¸ªç»´åº¦ï¼ŒæŒ‰ç…§æœ‰å¤šè¾†è½¦çš„å†™æ³•æ¥å¤„ç†ã€‚<br>
å¦å¤–ï¼Œæˆ‘åœ¨æ¨¡æ‹Ÿæ•°æ®æ—¶ï¼Œè®©è¿™ä¸ªè½¦ç»•äº†å¤šä¸ªåœ°ç‚¹ â€”â€” å¤šä¸ªåœ°æ–¹â€œè¸©ç‚¹â€ã€‚</p>
<h3 id="äºŒé¢˜ç›®æ€è·¯">äºŒã€é¢˜ç›®æ€è·¯</h3>
<p>æƒ³è¦ç­”é¢˜çš„åŒå­¦ï¼Œå¯ä»¥å…ˆæ€è€ƒç­”æ¡ˆğŸ¤”ã€‚<br>
.â€¦â€¦</p>
<p>.â€¦â€¦</p>
<p>.â€¦â€¦</p>
<p>æˆ‘æ¥è°ˆè°ˆæˆ‘çš„æ€è·¯ï¼Œè¿™é“é¢˜ç›®å…¶å®è¿˜æ˜¯â€œæ–­ç‚¹åˆ†ç»„â€ç±»é—®é¢˜<br>
1.â€œæ–­ç‚¹åˆ†ç»„â€ç±»é—®é¢˜ï¼Œé¡¾åæ€ä¹‰ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªè¯ä¸€ä¸ªæ˜¯â€œæ–­ç‚¹â€ä¸€ä¸ªæ˜¯â€œåˆ†ç»„â€ã€‚â€œåˆ†ç»„â€æœ€å®¹æ˜“æƒ³åˆ°å°†ä¸€ç±»æœ‰ç›¸åŒâ€œç»´åº¦â€ï¼ˆåˆ†ç»„æ ‡è¯†ï¼‰çš„æ•°æ®æ”¾åœ¨ä¸€èµ·ç»Ÿè®¡ï¼Œå¯¹äºè¿™é“é¢˜ç›®æ¥è¯´ï¼Œå°±æ˜¯â€œè¸©ç‚¹â€çš„æŸä¸ªâ€œç‚¹â€ï¼Œé‚£ä¹ˆè¿™ä¸ªå±äºè¿™ä¸ªâ€œè¸©ç‚¹â€çš„æ‰€æœ‰è½¨è¿¹ç‚¹åº”è¯¥æ”¾åœ¨åŒä¸€ç»„ï¼Œè¿›è€Œæ±‚å¹³å‡å¾—åˆ°â€œä¸­å¿ƒç‚¹â€</p>
<p>2.â€œæ–­ç‚¹â€ä½“ç°åœ¨å“ªé‡Œï¼Ÿé¢˜ç›®è®¾è®¡æ—¶ï¼Œè§„å®šäº†çŠ¯ç½ªåˆ†å­é©¾è½¦ä¼šæœ‰ä¸¤ä¸ªé€Ÿåº¦èŒƒå›´ï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸é©¾é©¶èŒƒå›´ï¼Œä¸€ä¸ªæ˜¯â€œè¸©ç‚¹â€ä½é€Ÿé©¾é©¶è¡Œä¸ºï¼ˆå¿½ç•¥åœ¨ç°å®ä¸­çš„ä¸åˆç†æ€§ï¼Œå› ä¸ºè¿™é“é¢˜è®¾è®¡æ›´åè¶£å‘³ï¼‰ã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªé€Ÿåº¦èŒƒå›´çš„åˆ‡æ¢ç‚¹ï¼Œå°±æ˜¯é‚£ä¸ªâ€œæ–­ç‚¹â€ã€‚å°±éœ€è¦å…ˆæ±‚å‡ºæ¥é€Ÿåº¦</p>
<p>3.æ‘„åƒå¤´æ‹åˆ°è½¦ï¼Œå¹¶ç»™å‡ºåæ ‡å’Œæ—¶åˆ» â€”â€” é€Ÿåº¦å°±æ˜¯è·ç¦»é™¤ä»¥æ—¶é—´å·®ï¼Œè€Œè·ç¦»éœ€è¦ç”¨åæ ‡æ¥è®¡ç®—ã€‚å¦‚æœæ˜¯ <code>Postgre</code>ã€<code>SQL Server</code> æˆ–è€…æŸäº›æ•°æ®åº“ï¼Œå¯èƒ½åˆ©ç”¨ <code>GIS</code> çš„æ’ä»¶/å‡½æ•°æ¥è®¡ç®—ï¼Œæˆ‘æ²¡æœ‰ç”¨è¿‡ã€‚è€Œä¸”æ­¤é¢˜ç›®æœ¬æ„ä¹Ÿæ˜¯ä¸ºäº†ç»ƒä¹  <code>Hive</code> ä¸‰è§’å‡½æ•°ï¼Œæ ¹æ®æœç´¢ï¼Œæ¨èä½¿ç”¨ <code>Haversineå…¬å¼</code> æ¥å¤„ç†ã€‚</p>
<p></p><div class="math display">\[d = 2R \cdot \text{argsin} \left(\sqrt{\sin^2{ \left( \frac{\text{lat2}-\text{lat1}}{2} \right)} + \cos{(\text{lat2})} \cos{(\text{lat1})} \sin^2{ \left( \frac{\text{lon2}-\text{lon1}}{2} \right)}} \right) 
\]</div><p></p><p>å…¶ä¸­ <span class="math inline">\(R\)</span> æ˜¯åœ°çƒåŠå¾„</p>
<p>å¯¹è¿™ä¸ªå…¬å¼è¯æ˜æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥è‡ªè¡Œæœç´¢ã€‚è¯´å®è¯ï¼Œæˆ‘æ²¡çœ‹è¯æ˜ã€‚æˆ‘è¿˜å°è¯•äº†ç±»ä¼¼å¹³é¢åæ ‡ç³»ä¸­è®¡ç®—æ¬§å¼è·ç¦»å’Œæ›¼å“ˆé¡¿è·ç¦»çš„æ–¹æ³•ï¼šåœ¨ Python ä¸­æˆ‘éªŒè¯äº†åä¸¤è€…çš„ <code>Haversine</code> çš„å·®è·ï¼Œå› ä¸ºè¿™äº›åæ ‡ä¹‹é—´æœ¬èº«å°±å¾ˆè¿‘ï¼Œä½¿ç”¨æ¬§å¼è·ç¦»ä¹Ÿå¯ä»¥å¤„ç†ã€‚</p>
<p>æœ‰äººè®ºè¿°è¿‡åæ­£åˆ‡è®¡ç®—å¼€é”€å¤§ï¼Œè‹¥éå¿…è¦å¯ä»¥è¿‘ä¼¼æ±‚è§£ â€”â€” æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œæœç´¢</p>
<p>ä¸‹é¢ï¼Œæˆ‘ç”¨ <code>NumPy</code> å’Œ <code>Scipy</code> ç”Ÿæˆæ¨¡æ‹Ÿçš„æ•°æ®é›†ï¼š</p>
<h3 id="ä¸‰ç”¨-python-ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®">ä¸‰ã€ç”¨ Python ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</h3>
<p>åªå…³å¿ƒ SQL ä»£ç çš„åŒå­¦ï¼Œå¯ä»¥è·³è½¬åˆ°ç¬¬å››èŠ‚ï¼ˆæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨ <code>Hive</code> è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨ <code>Hive</code> çš„è¯­æ³•ï¼‰</p>
<p>æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹ï¼š<br>
1.å¼•å…¥å¿…è¦çš„åŒ…ï¼Œå®šä¹‰â€œè¸©ç‚¹â€å’Œæ­£å¸¸çš„é€Ÿåº¦èŒƒå›´ï¼Œå‰è€…<strong>4ï½6m/s</strong>ï¼Œåè€…<strong>8~16m/s</strong>ï¼š</p>
<pre><code class="language-python">import math
from datetime import datetime

import numpy as np
import pandas as pd
import scipy

# scipy çš„éšæœºæ•°ç§å­
RANDOM_SEED = 2025

# è¸©ç‚¹é€Ÿåº¦å’Œæ­£å¸¸é€Ÿåº¦
SPEED_CASE = (4, 6)
SPEED_NORMAL = (8, 16)

# èµ·å§‹ç‚¹æ—¥æœŸèŒƒå›´
DATE_BEGIN = ("2025-06-01 08:00:00.000", "2025-06-01 21:00:00.000")

TIMESTAMP_BEGIN = [
    datetime.strptime(d, "%Y-%m-%d %H:%M:%S.%f").timestamp() 
    for d in DATE_BEGIN
]
</code></pre>
<p>2.<code>path</code> æŒ‡å‘çš„æ–‡ä»¶ï¼Œé‡Œé¢å­˜çš„æ•°æ®æ˜¯æˆ‘åœ¨æŸç½‘ç«™ä¸€ä¸ªä¸€ä¸ªç‚¹çš„åæ ‡è½¨è¿¹ã€‚ä½¿ç”¨ <code>shift</code> å‡½æ•°ç§»åŠ¨ä¸€è¡Œï¼Œæ–¹ä¾¿è®¡ç®—ä¸¤ä¸ªç›¸é‚»è¡Œçš„è·ç¦»ï¼š</p>
<pre><code class="language-python">path = "sqlé¢˜ç›®ç»çº¬åº¦.xlsx"
df = pd.read_excel(
    path,
    sheet_name="Sheet1",
    header=None,
    names=["licencePlate", "lagtitude", "longtitude", "isCaseTheJoint"],
)

# ä¸‹ç§»ä¸€è¡Œï¼Œä½¿å¾—æ¯ä¸€è¡Œæ‹¥æœ‰ä¸Šä¸€è¡Œçš„åæ ‡æ•°æ®
df[["lastLagtitude", "lastLongtitude"]] = df.groupby(by=["licencePlate"])[
    ["lagtitude", "longtitude"]
].shift(1)
</code></pre>
<p>3.å®šä¹‰ <code>haversine</code> å’Œè¿‘ä¼¼è®¡ç®— <code>approx_distance</code>çš„å‡½æ•°ï¼Œå¹¶æ±‚ç»“æœè¿›è¡Œå¯¹æ¯”ã€‚å…¶ä¸­ <code>haversine</code> çš„ä»£ç ï¼ŒæŠ„çš„ â€”â€” æ¥æºæ˜¯ï¼Œâ€œæ¨¡å‹è§†è§’â€çš„ã€Šå­¦ç‚¹å‡ ä½• | è®¡ç®—çƒé¢è·ç¦»çš„å“ˆå¼—å¡æ©å…¬å¼ã€‹ï¼›<code>approx_distance</code> è¿‘ä¼¼è®¡ç®—çš„æ–¹æ³•ï¼Œæ˜¯æˆ‘è‡ªå·±å†™çš„ï¼š</p>
<pre><code class="language-python"># å®šä¹‰å“ˆå¼—èµ›æ©å…¬å¼å‡½æ•°
def haversine_distance(gps1, gps2):
    lat1, lon1 = gps1
    lat2, lon2 = gps2

    R = 6371 * 1000  # åœ°çƒåŠå¾„ï¼Œå•ä½ä¸ºå…¬é‡Œ

    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)

    a = (
        math.sin(dlat / 2) ** 2
        + math.cos(math.radians(lat1))
        * math.cos(math.radians(lat2))
        * math.sin(dlon / 2) ** 2
    )

    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    # c2 = 2 * math.asin(math.sqrt(a))

    distance = R * c
    return distance


# è®¡ç®—è¿‘ä¼¼è·ç¦»
def approx_distance(gps1, gps2):
    lat1, lon1 = gps1
    lat2, lon2 = gps2

    R = 6371 * 1000

    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)

    avg_lat = math.radians((lat1 + lat2) / 2)

    dx = dlon * math.cos(avg_lat) * R
    dy = dlat * R

    euclidean_approx = math.sqrt(pow(dx, 2) + pow(dy, 2))
    manhattan_approx = abs(dx) + abs(dy)

    return euclidean_approx, manhattan_approx


df["haversineDistance"] = df.apply(
    lambda row: haversine_distance(
        (row["lagtitude"], row["longtitude"]),
        (row["lastLagtitude"], row["lastLongtitude"]),
    ),
    axis=1,
)

# å¦‚æœè·¯æœ¬èº«æ˜¯æ–œçš„ï¼Œæ›¼å“ˆé¡¿è·ç¦»æ¯”æ¬§å¼è·ç¦»è¦â€œè™šé«˜â€è¾ƒå¤š
# ä½†ç±»ä¼¼è·¯å£æ‹è§’ï¼Œæ›¼å“ˆé¡¿è·ç¦»æ›´åŠ å‡†ç¡®
df["approxDistance"] = df.apply(
    lambda row: approx_distance(
        (row["lagtitude"], row["longtitude"]),
        (row["lastLagtitude"], row["lastLongtitude"]),
    ),
    axis=1,
)


df["euclideanDistance"] = df["approxDistance"].apply(lambda row: row[0])
df["manhattanDistance"] = df["approxDistance"].apply(lambda row: row[1])
df.drop(columns=["approxDistance"], inplace=True)
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250516220801968-734038387.png" alt="" loading="lazy"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå¯ä»¥çœ‹å‡º haversine å’Œæ¬§å¼è·ç¦»ï¼Œåœ¨å‡ åç±³çš„è·ç¦»ä¸­ï¼Œç»“æœå‡ ä¹ä¸€æ ·ï¼ˆè‡³å°‘è®¡ç®—ç»“æœå°æ•°ç‚¹å 6 ä½ä¸€è‡´ï¼‰</p>
<p>4.ä½¿ç”¨æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼Œå¹¶ä½¿ç”¨çº¿æ€§å˜æ¢ï¼Œéšæœºç”Ÿæˆè¸©ç‚¹å’Œæ­£å¸¸é©¾é©¶çš„é€Ÿåº¦ï¼Œä½¿ç”¨ <code>clip</code> è£å‰ªé¿å…æ•°æ®è¶…å‡ºè¿™ä¸ªèŒƒå›´ï¼›å‡è®¾ 4~6m/s ä¹‹é—´æ˜¯è¸©ç‚¹çš„é€Ÿåº¦ï¼Œ8ï½16m/s ä¹‹é—´æ˜¯æ­£å¸¸é©¾é©¶çš„é€Ÿåº¦ï¼š</p>
<pre><code class="language-python"># å‡è®¾ 4 ~6m/s ä¹‹é—´æ˜¯è¸©ç‚¹çš„é€Ÿåº¦ï¼Œ8ï½16m/s ä¹‹é—´æ˜¯æ­£å¸¸é©¾é©¶çš„é€Ÿåº¦
# ç”¨ havsersineDistance æ¥æ±‚ï¼Œä¸è€ƒè™‘çº¢ç»¿ç¯æˆ–è€…å µè½¦ç­‰æƒ…å†µ
# å…ˆä¸å•ç‹¬å¤„ç†èµ·å§‹ç‚¹ï¼Œå³ lastLagtitude ä¸º NaN çš„ç‚¹ï¼Œè¿™æ ·ä»£ç å†™ç€æ›´ç®€æ´ï¼Œæœ€åå†èµ‹ NaN
df["speed"] = scipy.stats.norm.rvs(
    loc=0, scale=1, size=df.shape[0], random_state=RANDOM_SEED
)

# æ­£æ€åˆ†å¸ƒçº¿æ€§å˜æ¢
df.loc[df["isCaseTheJoint"] == 1, "speed"] = (
    df["speed"] * (SPEED_CASE[1] - SPEED_CASE[0]) / 8
    + (SPEED_CASE[0] + SPEED_CASE[1]) / 2
)

df.loc[df["isCaseTheJoint"] == 0, "speed"] = (
    df["speed"] * (SPEED_NORMAL[1] - SPEED_NORMAL[0]) / 8
    + (SPEED_NORMAL[0] + SPEED_NORMAL[1]) / 2
)

# ä½¿ç”¨ clip è£å‰ªé€Ÿåº¦æ•°æ®
df.loc[df["isCaseTheJoint"] == 1, "speed"] = df.loc[
    df["isCaseTheJoint"] == 1, "speed"
].clip(lower=SPEED_CASE[0], upper=SPEED_CASE[1])
df.loc[df["isCaseTheJoint"] == 0, "speed"] = df.loc[
    df["isCaseTheJoint"] == 0, "speed"
].clip(lower=SPEED_NORMAL[0], upper=SPEED_NORMAL[1])
</code></pre>
<p>5.åˆ©ç”¨è·ç¦»å’Œé€Ÿåº¦ï¼Œæ±‚å‡ºæ—¶é—´å·®ã€‚éšæœºç”Ÿæˆèµ·å§‹ç‚¹å‡ºå‘çš„æ—¶é—´ï¼Œå¹¶ç”¨ <code>cumsum</code> å®ç°ç´¯åŠ ï¼Œç”Ÿæˆ <code>csv</code> æ–‡ä»¶ï¼š</p>
<pre><code class="language-python"># æ³¨æ„å•ä½æ˜¯æ¯«ç§’
df["ts"] = df["haversineDistance"] / df["speed"]

df.loc[df["lastLagtitude"].isna(), "ts"] = scipy.stats.uniform.rvs(
    loc=TIMESTAMP_BEGIN[0],
    scale=TIMESTAMP_BEGIN[1]-TIMESTAMP_BEGIN[0],
    size=df["lastLagtitude"].isna().sum(),
    random_state=RANDOM_SEED,
)

df["ts"] = df.groupby(by=["licencePlate"])["ts"].cumsum()


def timestamp_to_datestr(ts: int) -&gt; str:
    """
    æ³¨æ„ ts æ˜¯æ¯«ç§’ï¼Œéœ€è¦é™¤ä»¥ 1000
    """
    date = datetime.fromtimestamp(ts)
    date_str = date.strftime("%Y-%m-%d %H:%M:%S.%f")
    return date_str


df["ts"] = df["ts"].apply(timestamp_to_datestr)

out_csv_path = "dwd_vehicle_track.csv"

df[["ts", "licencePlate", "lagtitude", "longtitude", "isCaseTheJoint"]].to_csv(
    out_csv_path, encoding="utf-8-sig", header=False, index=False
)

# åœ¨ Jupyter ç¯å¢ƒä¸‹å±•ç¤º dataframeï¼Œå…¶ä»–ç¯å¢ƒæ‰§è¡Œå¯èƒ½æŠ¥é”™
display(df[["ts", "licencePlate", "lagtitude", "longtitude", "isCaseTheJoint"]])
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250516220813464-599499105.png" alt="" loading="lazy"></p>
<p>å›¾ä¸­çš„æ•°æ®æ˜¯æˆ‘åœ¨ <code>Streamlit</code> ä¸­ä½¿ç”¨ <code>st.map</code> ç»˜åˆ¶ï¼Œè¯¥éƒ¨åˆ†ä»£ç æˆ‘æ²¡æœ‰è´´è¿›æ¥ï¼Œåœ¨å¦å¤– <code>py</code> æ–‡ä»¶ä¸­ã€‚<code>st.map</code> åº•å±‚ç”¨çš„ <code>mapbox</code>ï¼Œè€Œåè€…è¿™é‡Œç”¨çš„ <code>OpenStreetMap</code>ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°é«˜å¾·ä½¿ç”¨çš„æ˜¯ <code>GCJ02</code> åæ ‡ç³»ï¼Œå›½å¤–æ˜¯ <code>WGS84</code> åæ ‡ç³»ã€‚éœ€è¦è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä¹Ÿæ˜¯ç½‘ä¸Šæ‰¾çš„è½¬æ¢ä»£ç ï¼ˆæˆ‘å°†åœ¨æœ€åç»“æœå±•ç¤ºæ—¶ï¼Œè¿›è¡Œè½¬æ¢ï¼‰ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼ˆå› ä¸ºæš‚æ—¶æ²¡æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ï¼Œæ²¡æœ‰ç”³è¯·ï¼›åç»­æœ‰éœ€æ±‚å†è¯´ | æˆ‘æ˜¯åœ¨ç½‘ä¸Šåˆ«äººå¼€å‘çš„ç½‘ç«™æ‰‹å·¥ç‚¹çš„åæ ‡ï¼Œäººå®¶çš„åº•å›¾ç”¨çš„æ˜¯é«˜å¾·ï¼‰</p>
<p>6.åˆ©ç”¨ <code>pyhive</code> åˆ›å»ºæ–°çš„ <code>Hive</code> è¡¨ï¼Œå¹¶å°†æ•°æ® <code>load</code> åˆ°è¡¨ä¸­ï¼š</p>
<pre><code class="language-python">from pyhive import hive

# é…ç½®è¿æ¥å‚æ•°
host_ip = "127.0.0.1"
port = 10000
username = "Jiang"

with hive.Connection(host=host_ip, port=port) as conn:
    cursor = conn.cursor()

    hive_table_name = "data_exercise.dwd_vehicle_track"

    drop_table_sql = f"""
    drop table if exists {hive_table_name}
    """

    print('åˆ é™¤è¡¨è¯­å¥ï¼š\n', drop_table_sql)
    cursor.execute(drop_table_sql)


    create_table_sql = f"""
    create table if not exists `{hive_table_name}`(
        ts string comment "æ—¶é—´",
        licence_plate string comment "è½¦ç‰Œ",
        lagtitude double comment "çº¬åº¦",
        longtitude double comment "ç»åº¦",
        is_case_the_joint tinyint comment "æ˜¯å¦ä¸ºè¸©ç‚¹ï¼ˆ1-æ˜¯ï¼Œ0-å¦ï¼‰"
    )
    comment "åˆ©ç”¨è¡Œè½¦è½¨è¿¹åˆ†æçŠ¯ç½ªåˆ†å­ä½œæ¡ˆåœ°ç‚¹ | authorï¼šè’‹ç‚¹æ•°åˆ† | æ–‡ç« ç¼–å·ï¼šc9029700"
    row format delimited fields terminated by ","
    stored as textfile
    """
    
    print('åˆ›å»ºè¡¨è¯­å¥ï¼š\n', create_table_sql)
    cursor.execute(create_table_sql)
    
    import os
    
    load_data_sql = f"""
    load data local inpath "{os.path.abspath(out_csv_path)}" 
    overwrite into table {hive_table_name}
    """
    
    print('è¦†ç›–å¼å¯¼å…¥æ•°æ®è¯­å¥ï¼š\n',load_data_sql)
    cursor.execute(load_data_sql)

    cursor.close()
</code></pre>
<blockquote>
<p>æˆ‘é€šè¿‡ä½¿ç”¨ <code>PyHive</code> åŒ…å®ç° Python æ“ä½œ <code>Hive</code>ã€‚æˆ‘ä¸ªäººç”µè„‘éƒ¨ç½²äº† <code>Hadoop</code> åŠ <code>Hive</code>ï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯è®¤è¯ï¼Œä¼ä¸šé‡Œä¸€èˆ¬å¸¸ç”¨ <code>Kerberos</code> æ¥è¿›è¡Œå¤§æ•°æ®é›†ç¾¤çš„è®¤è¯ã€‚</p>
</blockquote>
<h3 id="å››sql-è§£ç­”">å››ã€SQL è§£ç­”</h3>
<p>æˆ‘ä½¿ç”¨ <code>CTE</code> çš„è¯­æ³•ï¼Œè¿™æ ·å°†æ­¥éª¤ä¸²è¡Œå±•ç¤ºï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œä¸‹é¢åˆ†æˆå‡ éƒ¨åˆ†è§£é‡Š SQL è¯­å¥ï¼š</p>
<p>1.è¿™éƒ¨åˆ†ä»£ç çš„é€»è¾‘æ˜¯ï¼Œå…ˆåšåŸºæœ¬çš„æ•°æ®å¤„ç†ï¼šæ¯”å¦‚å°†å­—ç¬¦ä¸²æ ¼å¼çš„æ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³ï¼Œ<code>unix_timestamp</code> è¿”å›<strong>ç²¾åº¦åˆ°ç§’</strong>ï¼Œå› æ­¤éœ€è¦å°†å¾®ç§’éƒ¨åˆ†çš„æå–å‡ºæ¥å•ç‹¬è½¬æ¢ï¼›ä½¿ç”¨ <code>lag</code> æå–ä¸Šä¸€è¡Œçš„åæ ‡ï¼Œç”¨æ¥åç»­è®¡ç®—ï¼›ç¬¬äºŒéƒ¨åˆ†ä½¿ç”¨ <code>haversine</code> å…¬å¼è®¡ç®—è·ç¦»ï¼Œæ³¨æ„ä¸‰è§’å‡½æ•°ä½¿ç”¨å‰è¦å°†åæ ‡ç”¨ <code>radians</code> è½¬æ¢ä¸ºå¼§åº¦</p>
<p><code>split</code> å‡½æ•°çš„å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼Œâ€œSplits str around pat (pat is a regular expression)â€ã€‚å³å®ƒæ˜¯ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥åˆ‡åˆ†ï¼Œè€Œä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥éœ€è¦å¯¹'.'è½¬ä¹‰ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ä¸¤ä¸ªåæ–œæ æ¥è½¬ä¹‰ï¼Œå¯ä»¥è‡ªè¡Œæœç´¢åŸå› ã€‚</p>
<pre><code class="language-sql">-- è¸©ç‚¹é€Ÿåº¦å’Œæ­£å¸¸é€Ÿåº¦
-- SPEED_CASE = (4, 6)
-- SPEED_NORMAL = (8, 16)

with calc_last_gps_and_convert_ts as (
    select
      -- unix_timestamp è¿”å›çš„ç²¾åº¦æ˜¯ç§’çº§ï¼Œéœ€è¦å°†å¾®å¦™ç²¾åº¦çš„æ•°æ®å•ç‹¬æå–å‡ºæ¥
      -- split(string str, string pat)	 (pat is a regular expression)
      -- split å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå•çº¯çš„å­—ç¬¦ä¸²
      -- æ‰€ä»¥ "." éœ€è¦è½¬ä¹‰ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ä¸¤ä¸ªåæ–œæ è½¬ä¹‰ï¼Œè¯·è‡ªè¡Œæœç´¢
      unix_timestamp(ts) + cast(concat('0.',split(ts,'\\.')[1]) as double) as ts
    , licence_plate, lagtitude, longtitude, is_case_the_joint
    , lag(lagtitude, 1, null) over(partition by licence_plate order by ts asc) as last_lagtitude
    , lag(longtitude, 1, null) over(partition by licence_plate order by ts asc) as last_longtitude
    from data_exercise.dwd_vehicle_track
)

, calc_haversine_distance as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , lag(ts, 1, null) over(partition by licence_plate order by ts asc) as lastts
    , last_lagtitude, last_longtitude
    -- haversine å…¬å¼ï¼Œæ³¨æ„è¦ç”¨ radians è½¬ä¸ºå¼§åº¦å†ç”¨ä¸‰è§’å‡½æ•°
    , 2 * 6371 * 1000 * asin( 
        sqrt(
            pow( sin( radians(lagtitude-last_lagtitude)/2 ), 2 ) + cos( radians(last_lagtitude) ) * 
            cos( radians(lagtitude) ) * pow( sin( radians(longtitude-last_longtitude)/2 ), 2 ) 
        )  
      ) as haversine_distance
    from calc_last_gps_and_convert_ts
)
â€¦â€¦
</code></pre>
<p>2.è¿™éƒ¨åˆ†ä»£ç è®¡ç®—é€Ÿåº¦ï¼Œå¹¶æ‰“æ ‡ï¼Œæ²¡å•¥è¯´çš„ï¼š</p>
<pre><code class="language-sql">â€¦â€¦
, calc_speed_table as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance
    , haversine_distance / (ts - lastts) as speed
    from calc_haversine_distance
)

, classify_speed_table as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed
    , (case
        when speed between 4 and 6 then 1
        when speed between 8 and 16 then 0
        when speed is null then 0 -- èµ·å§‹ç‚¹å½“æˆæ™®é€šç‚¹
        else -1
    end) as calc_case
    from calc_speed_table

)
â€¦â€¦
</code></pre>
<p>3.å®ç°â€œæ–­ç‚¹åˆ†ç»„â€çš„é€»è¾‘ï¼Œä¹Ÿæ˜¯ SQL å¸¸è§çš„è€ƒé¢˜ã€‚å¥—è·¯è¿˜æ˜¯é‚£ä¸ªå¥—è·¯ï¼Œæœ€åå°†åæ ‡ç‚¹æ±‚å¹³å‡å°±å¾—åˆ°ä¸­å¿ƒç‚¹ â€”â€” è¿™éœ€è¦åæ ‡å‡åŒ€åˆ†å¸ƒï¼ˆè½¬æ•´æ•°åœˆæ˜¯åŸºæœ¬è¦æ±‚ï¼‰ï¼š</p>
<pre><code class="language-sql">â€¦â€¦
, mark_group_cut_point as (
  -- å°†æ™®é€šç‚¹å’Œè¸©ç‚¹çš„åˆ†éš”ä½ç½®æ ‡è®°å‡ºæ¥
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed, calc_case
    , (case
        when calc_case &lt;&gt; lag(calc_case, 1, null) over(partition by licence_plate order by ts)  then 1
        else 0
    end ) as cut_point
    from classify_speed_table
)

, mark_group_number as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed, calc_case, cut_point
    , sum(cut_point) over(partition by licence_plate order by ts) as group_number
    from mark_group_cut_point
)

select
  licence_plate, group_number
--, collect_list(lagtitude) as lagtitude_list
--, collect_list(longtitude) as longtitude_list
, avg(lagtitude) as center_lagtitude
, avg(longtitude) as center_longtitude
from mark_group_number
where calc_case = 1
group by licence_plate, group_number
</code></pre>
<p>4.å®Œæ•´çš„ SQL è¯­å¥ï¼š</p>
<pre><code class="language-sql">with calc_last_gps_and_convert_ts as (
    select
      -- unix_timestamp è¿”å›çš„ç²¾åº¦æ˜¯ç§’çº§ï¼Œéœ€è¦å°†å¾®å¦™ç²¾åº¦çš„æ•°æ®å•ç‹¬æå–å‡ºæ¥
      -- split(string str, string pat)	 (pat is a regular expression)
      -- split å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå•çº¯çš„å­—ç¬¦ä¸²
      -- æ‰€ä»¥ "." éœ€è¦è½¬ä¹‰ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ä¸¤ä¸ªåæ–œæ è½¬ä¹‰ï¼Œè¯·è‡ªè¡Œæœç´¢
      unix_timestamp(ts) + cast(concat('0.',split(ts,'\\.')[1]) as double) as ts
    , licence_plate, lagtitude, longtitude, is_case_the_joint
    , lag(lagtitude, 1, null) over(partition by licence_plate order by ts asc) as last_lagtitude
    , lag(longtitude, 1, null) over(partition by licence_plate order by ts asc) as last_longtitude
    from data_exercise.dwd_vehicle_track
)

, calc_haversine_distance as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , lag(ts, 1, null) over(partition by licence_plate order by ts asc) as lastts
    , last_lagtitude, last_longtitude
    -- haversine å…¬å¼ï¼Œæ³¨æ„è¦ç”¨ radians è½¬ä¸ºå¼§åº¦å†ç”¨ä¸‰è§’å‡½æ•°
    , 2 * 6371 * 1000 * asin( 
        sqrt(
            pow( sin( radians(lagtitude-last_lagtitude)/2 ), 2 ) + cos( radians(last_lagtitude) ) * 
            cos( radians(lagtitude) ) * pow( sin( radians(longtitude-last_longtitude)/2 ), 2 ) 
        )  
      ) as haversine_distance
    from calc_last_gps_and_convert_ts
)

, calc_speed_table as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance
    , haversine_distance / (ts - lastts) as speed
    from calc_haversine_distance
)

, classify_speed_table as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed
    , (case
        when speed between 4 and 6 then 1
        when speed between 8 and 16 then 0
        when speed is null then 0 -- èµ·å§‹ç‚¹å½“æˆæ™®é€šç‚¹
        else -1
    end) as calc_case
    from calc_speed_table

)

, mark_group_cut_point as (
  -- å°†æ™®é€šç‚¹å’Œè¸©ç‚¹çš„åˆ†éš”ä½ç½®æ ‡è®°å‡ºæ¥
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed, calc_case
    , (case
        when calc_case &lt;&gt; lag(calc_case, 1, null) over(partition by licence_plate order by ts)  then 1
        else 0
    end ) as cut_point
    from classify_speed_table
)

, mark_group_number as (
    select
      ts, licence_plate, lagtitude, longtitude, is_case_the_joint
    , haversine_distance, speed, calc_case, cut_point
    , sum(cut_point) over(partition by licence_plate order by ts) as group_number
    from mark_group_cut_point
)

select
  licence_plate, group_number
--, collect_list(lagtitude) as lagtitude_list
--, collect_list(longtitude) as longtitude_list
, avg(lagtitude) as center_lagtitude
, avg(longtitude) as center_longtitude
from mark_group_number
where calc_case = 1
group by licence_plate, group_number
</code></pre>
<p>æœ€ç»ˆç»“æœå¯è§†åŒ–å±•ç¤ºï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250516220827272-533622795.png" alt="" loading="lazy"></p>
<p>ç»¿è‰²ç‚¹æ˜¯æ­£å¸¸è¡Œé©¶ï¼Œçº¢è‰²ç‚¹æ˜¯è¸©ç‚¹æ•°æ®ï¼›æ©™è‰²ç‚¹å°±æ˜¯ SQL æ±‚å¾—â€œä¸­å¿ƒç‚¹â€</p>
<hr>
<p>ğŸ˜ğŸ˜ğŸ˜<br>
<strong>æˆ‘ç°åœ¨æ­£åœ¨æ±‚èŒæ•°æ®ç±»å·¥ä½œ</strong>ï¼ˆä¸»è¦æ˜¯æ•°æ®åˆ†ææˆ–æ•°æ®ç§‘å­¦ï¼‰ï¼›å¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼Œå³æ—¶åˆ°å²—ï¼Œä¸é™åŸå¸‚ã€‚</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.5881042783356482" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-16 22:12">2025-05-16 22:11</span>&nbsp;
<a href="https://www.cnblogs.com/data-analytics">è’‹ç‚¹æ•°åˆ†</a>&nbsp;
é˜…è¯»(<span id="post_view_count">38</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18880722);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18880722', targetLink: 'https://www.cnblogs.com/data-analytics/p/18880722', title: 'ã€SQLå‘¨å‘¨ç»ƒã€‘ï¼šåˆ©ç”¨è¡Œè½¦è½¨è¿¹åˆ†æçŠ¯ç½ªåˆ†å­ä½œæ¡ˆåœ°ç‚¹' })">ä¸¾æŠ¥</a>
</div>
        