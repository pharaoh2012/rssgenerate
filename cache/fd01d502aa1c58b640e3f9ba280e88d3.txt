
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wucy/p/18864044/dotnet_webapi_mcp" title="å‘å¸ƒäº 2025-05-08 09:45">
    <span role="heading" aria-level="2">å¦‚ä½•æŠŠASP.NET Core WebApiæ‰“é€ æˆMcp Server</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h3 id="å‰è¨€">å‰è¨€</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;MCP (Model Context Protocol)å³æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ç›®å‰ä¸è¦å¤ªç«çˆ†äº†ï¼Œå…³äºå®ƒæ˜¯ä»€ä¹ˆç›¸ä¿¡å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰äº†ã€‚ç›®å‰ä¸»æµçš„AIå¼€å‘æ¡†æ¶å’ŒAIå·¥å…·éƒ½æ”¯æŒé›†æˆ<code>MCP</code>ï¼Œè¿™ä¹Ÿæ­£æ˜¯å®ƒçš„æ„ä¹‰æ‰€åœ¨ã€‚æ¯•ç«Ÿä½œä¸ºä¸€ä¸ªæ ‡å‡†çš„åè®®ï¼Œå½“ç„¶æ˜¯æ›´å¤šçš„ç”Ÿæ€æ¥å…¥è¿›æ¥æ‰ä¼šæœ‰æ„ä¹‰ã€‚ä½¿ç”¨MCPæˆ‘ä»¬å¯ä»¥æŠŠ<code>Toolsè°ƒç”¨æ ‡å‡†åŒ–</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯­è¨€ã€æ¡†æ¶å¿«é€ŸæŠŠå·¥å…·èåˆåˆ°ä¸åŒçš„æ¨¡å‹ä¸­å»ã€‚ç°åœ¨ï¼Œå¦‚ä½•æŠŠç°æœ‰çš„ä¸šåŠ¡é€»è¾‘å¿«é€Ÿçš„æ¥å…¥åˆ°æ¨¡å‹ä¸­ï¼Œæˆä¸ºæ¨¡å‹è½åœ°å¾ˆå…³é”®çš„ä¸€æ­¥ï¼Œä»Šå¤©æˆ‘ä»¬å°±å€ŸåŠ©å¾®è½¯çš„<code>Semantic Kernel</code>å’Œ<code>Microsoft.Extensions.AI</code>æ¡†æ¶ï¼Œé€šè¿‡ç®€å•çš„ç¤ºä¾‹å±•ç¤ºï¼Œå¦‚ä½•æŠŠç°æœ‰çš„<code>ASP NET Core WebApi</code>è½¬æ¢æˆ<code>MCP Server</code>ã€‚</p>
<h3 id="æ¦‚å¿µç›¸å…³">æ¦‚å¿µç›¸å…³</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¤§è‡´ä»‹ç»ä¸€ä¸‹æœ¬æ–‡è®¾è®¡åˆ°çš„ç›¸å…³çš„æ¦‚å¿µä»¥åŠæ¶‰åŠåˆ°çš„ç›¸å…³ç±»åº“</p>
<h4 id="mcp">MCP</h4>
<p>MCPæ˜¯ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œå®ƒä¸ºåº”ç”¨ç¨‹åºå‘ LLM æä¾›ä¸Šä¸‹æ–‡çš„æ–¹å¼è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚å®ƒçš„é‡ç‚¹æ˜¯æ ‡å‡†åŒ–ï¼Œè€Œä¸æ˜¯å–ä»£è°ã€‚å®ƒæ¶‰åŠåˆ°å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µ</p>
<ul>
<li>MCP Hosts: å¦‚<code>Claude Desktop</code>ã€<code>IDE</code>ã€<code>AI</code>å·¥å…·ã€æˆ–è€…æ˜¯ä½ å¼€å‘çš„AIç¨‹åºç­‰</li>
<li>MCP Clients: ç»´æŠ¤ä¸<code>MCP Servers</code>ä¸€å¯¹ä¸€è¿æ¥çš„åè®®å®¢æˆ·ç«¯</li>
<li>MCP Servers: è½»é‡çº§ç¨‹åºï¼Œé€šè¿‡æ ‡å‡†çš„<code>Model Context Protocol</code>æä¾›ç‰¹å®šèƒ½åŠ›</li>
</ul>
<p>ç®€å•æ¥è¯´å°±æ˜¯ä½ å†™çš„AIåº”ç”¨å°±æ˜¯<code>MCP Hosts</code>ï¼Œå› ä¸º<code>MCP</code>æ˜¯ä¸€ä¸ªåè®®ï¼Œæ‰€ä»¥ä½ éœ€è¦é€šè¿‡<code>MCP Clients</code>è®¿é—®<code>MCP Servers</code>ï¼Œ<code>MCP Servers</code>æä¾›çš„å°±æ˜¯å·¥å…·æˆ–è€…ä¸€äº›å…¶ä»–èƒ½åŠ›ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœæƒ³åœ¨AIåº”ç”¨ä¸­ä½¿ç”¨<code>MCP</code>ï¼Œæ¨¡å‹éœ€è¦æ”¯æŒ<code>Function Calling</code>ï¼Œå½“ç„¶å¦‚æœä½ èƒ½é€šè¿‡<code>æç¤ºè¯</code>çš„æ–¹å¼è°ƒè¯•å‡ºæ¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æ•ˆæœè‚¯å®šä¸å¦‚æœ¬èº«å°±æ”¯æŒ<code>Function Calling</code>ã€‚</p>
<p>å› ä¸ºMCPæ˜¯ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠåŸæ¥å›ºå®šåœ¨AIåº”ç”¨é‡Œçš„å·¥å…·ä»£ç å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œä½¿ç”¨ä¸åŒçš„å¼€å‘è¯­è¨€å½¢æˆç‹¬ç«‹çš„åº”ç”¨ï¼Œè¿™æ ·è¿™ä¸ªToolsåº”ç”¨å°±å¯ä»¥å’ŒAIåº”ç”¨éš”ç¦»ï¼Œä»–ä»¬å¯ä»¥ä¸æ˜¯åŒä¸€ç§è¯­è¨€ï¼Œç”šè‡³å¯ä»¥åœ¨ä¸åŒçš„æœºå™¨ä¸Šã€‚æ‰€ä»¥ç°åœ¨å¾ˆå¤šå¼€æºçš„ç»„ä»¶å’Œå¹³å°éƒ½å¯ä»¥æä¾›è‡ªå·±çš„<code>MCP Server</code>äº†ã€‚å°±å’Œæ²¡æœ‰å¾®æœåŠ¡æ¦‚å¿µä¹‹å‰æˆ‘ä»¬ä»£ç éƒ½å†™åˆ°ä¸€ä¸ªé¡¹ç›®é‡Œï¼Œæœ‰äº†å¾®æœåŠ¡ä¹‹åæˆ‘ä»¬å¯ä»¥æŠŠä¸åŒçš„æ¨¡å—å½¢æˆå•ç‹¬çš„é¡¹ç›®ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¼€å‘è¯­è¨€ã€‚å¯ä»¥é€šè¿‡HTTPã€RPCç­‰å¤šç§æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚</p>
<h4 id="æ¡†æ¶">æ¡†æ¶</h4>
<p>ç®€å•ä»‹ç»ä¸€ä¸‹æœ¬æ–‡æ¶‰åŠåˆ°çš„ç›¸å…³æ¡†æ¶åŠåœ°å€ï¼š</p>
<ul>
<li>
<p>Microsoft.Extensions.AIï¼šå¾®è½¯æä¾›çš„é€šè¿‡.NETå®ç°AIGCæ“ä½œçš„å¼€å‘åŸºç¡€æ¡†æ¶ï¼Œæä¾›äº†åŸºç¡€<code>å¯¹è¯</code>å’Œ<code>Function Calling</code>ç­‰åŸºç¡€æ“ä½œï¼Œä½¿ç”¨ç®€å•æ‰©å±•æ€§å¼ºï¼Œæ”¯æŒOTELè¦æµ‹åè®®ç›‘æ§æ¨¡å‹è°ƒç”¨æƒ…å†µã€‚ç›®å‰å·²é€‚é…Ollamaã€OpenAIã€Azure OpenAIç­‰ã€‚é¡¹ç›®åœ°å€<a href="https://github.com/dotnet/extensions/tree/main/src/Libraries/Microsoft.Extensions.AI" target="_blank" rel="noopener nofollow">https://github.com/dotnet/extensions/tree/main/src/Libraries/Microsoft.Extensions.AI</a></p>
</li>
<li>
<p>Semantic Kernelï¼šä»¥<code>Microsoft.Extensions.AI</code>ä¸ºåŸºç¡€(ä½ç‰ˆæœ¬çš„ä¸æ˜¯)æ‰“é€ çš„æ›´å¼ºå¤§çš„AIå¼€å‘æ¡†æ¶ï¼Œæä¾›äº†åŸºç¡€<code>å¯¹è¯</code>å’Œ<code>Function Calling</code>åŠŸèƒ½çš„åŒæ—¶ï¼Œè¿˜æä¾›äº†å¤šæ¨¡æ€ã€RAGã€æ™ºèƒ½ä½“ã€æµç¨‹å¤„ç†ç­‰å¼ºå¤§çš„åº”ç”¨çº§åŠŸèƒ½,æœ‰.NETã€Pythonã€Javaä¸‰ç§è¯­è¨€ç‰ˆæœ¬ã€‚é¡¹ç›®åœ°å€<a href="https://github.com/microsoft/semantic-kernel" target="_blank" rel="noopener nofollow">https://github.com/microsoft/semantic-kernel</a></p>
</li>
<li>
<p>mcpdotnet(modelcontextprotocol/csharp-sdk)ï¼šåŸåä¸ºmcpdotnetï¼Œç°åœ¨æ˜¯.NETæ„å»ºMCPçš„å®˜æ–¹é¡¹ç›®ï¼Œå¯ä»¥ä½¿çš„Microsoft.Extensions.AIå’ŒSemantic Kernelå¿«é€Ÿçš„é€‚é…åˆ°MCPã€‚é¡¹ç›®åœ°å€<a href="https://github.com/modelcontextprotocol/csharp-sdk" target="_blank" rel="noopener nofollow">https://github.com/modelcontextprotocol/csharp-sdk</a></p>
</li>
</ul>
<h3 id="å®ç°">å®ç°</h3>
<p>æ•´ä½“æ¥è¯´å®ç°çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸º<code>Semantic Kernel</code>æ”¯æŒåŠ è½½<code>OpenAPI</code>æ ¼å¼çš„æ•°æ®åŠ è½½æˆå®ƒçš„<code>Plugins</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ<code>Plugins</code>è½¬æ¢æˆ<code>Microsoft.Extensions.AI</code>æä¾›çš„æ ‡å‡†çš„<code>AIFunction</code>ç±»å‹ï¼Œé€šè¿‡<code>mcpdotnet</code>å¯ä»¥æŠŠ<code>AIFunction</code>æ ‡å‡†ç±»å‹è½¬æ¢æˆ<code>mcpdotnet</code>çš„<code>Tools</code>ã€‚</p>
<h4 id="webapi">WebApi</h4>
<p>æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ª<code>ASP.NET Core WebAPI</code>é¡¹ç›®ï¼Œç”¨æ¥å®ŒæˆæŸ¥è¯¢å¤©æ°”çš„åŠŸèƒ½ã€‚é¦–å…ˆï¼Œæ·»åŠ <code>Swagger</code>æ”¯æŒã€‚å½“ç„¶ä½ ä½¿ç”¨åˆ«çš„åº“ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œçš„é‡ç‚¹å°±æ˜¯å¯ä»¥å¾—åˆ°è¯¥é¡¹ç›®æ¥å£çš„<code>OpenAPI</code>æ•°æ®ä¿¡æ¯ã€‚</p>
<pre><code>&lt;PackageReference Include="Swashbuckle.AspNetCore" Version="8.1.1" /&gt;
</code></pre>
<p>å…¶æ¬¡ï¼Œæ·»åŠ æ ¹æ®IPæŸ¥è¯¢åœ°å€ä¿¡æ¯çš„åŠŸèƒ½</p>
<pre><code>&lt;PackageReference Include="IPTools.China" Version="1.6.0" /&gt;
</code></pre>
<p>å› ä¸º<code>IPTools</code>ä½¿ç”¨çš„æ˜¯<code>sqlite</code>æ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦æŠŠdbåŠ è½½åˆ°é¡¹ç›®é‡Œã€‚å…·ä½“ä½¿ç”¨ç»†èŠ‚å¯ä»¥æŸ¥çœ‹è¯¥åº“çš„å…·ä½“åœ°å€<a href="https://github.com/stulzq/IPTools" target="_blank" rel="noopener nofollow">https://github.com/stulzq/IPTools</a></p>
<pre><code>&lt;ItemGroup&gt;
 &lt;None Update="ip2region.db"&gt;
    &lt;CopyToOutputDirectory&gt;Always&lt;/CopyToOutputDirectory&gt;
  &lt;/None&gt;
&lt;/ItemGroup&gt;
</code></pre>
<p>æ¥ä¸‹æ¥å®ç°å…·ä½“åŠŸèƒ½çš„<code>Controller</code>ä»£ç </p>
<pre><code class="language-csharp"> /// &lt;summary&gt;
 /// è·å–åŸå¸‚å¤©æ°”
 /// &lt;/summary&gt;
 [ApiController]
 [Route("api/[controller]/[action]")]
 public class WeatherController(IHttpClientFactory _httpClientFactory) : ControllerBase
 {
     /// &lt;summary&gt;
     /// è·å–å½“å‰æ—¶é—´
     /// &lt;/summary&gt;
     /// &lt;returns&gt;å½“å‰æ—¶é—´&lt;/returns&gt;
     [HttpGet]
     public string GetCurrentDate()
     {
         return DateTime.Now.ToString("MM/dd");
     }

     /// &lt;summary&gt;
     /// è·å–å½“å‰åŸå¸‚ä¿¡æ¯
     /// &lt;/summary&gt;
     /// &lt;returns&gt;å½“å‰åŸå¸‚ä¿¡æ¯&lt;/returns&gt;
     [HttpGet]
     public async Task&lt;IpInfo&gt; GetLocation()
     {
         var httpClient = _httpClientFactory.CreateClient();
         IpData ipInfo = await httpClient.GetFromJsonAsync&lt;IpData&gt;("https://ipinfo.io/json");
         var ipinfo = IpTool.Search(ipInfo!.ip);
         return ipinfo;
     }

     /// &lt;summary&gt;
     /// è·å–å¤©æ°”ä¿¡æ¯
     /// &lt;/summary&gt;
     /// &lt;param name="region"&gt;çœä»½&lt;/param&gt;
     /// &lt;param name="city"&gt;åŸå¸‚&lt;/param&gt;
     /// &lt;param name="currentDate"&gt;æ—¥æœŸ(æ ¼å¼ï¼šæœˆä»½/æ—¥æœŸ)&lt;/param&gt;
     /// &lt;returns&gt;å¤©æ°”ä¿¡æ¯&lt;/returns&gt;
     [HttpGet]
     public async Task&lt;string&gt; GetCurrentWeather(string region, string city, string currentDate)
     {
         var httpClient = _httpClientFactory.CreateClient();
         WeatherRoot weatherRoot = await httpClient.GetFromJsonAsync&lt;WeatherRoot&gt;($"https://cn.apihz.cn/api/tianqi/tqybmoji15.php?id=88888888&amp;key=88888888&amp;sheng={region!}&amp;place={city!}")!;
         DataItem today = weatherRoot!.data!.FirstOrDefault(i =&gt; i.week2 == currentDate)!;
         return $"{today!.week2} {today.week1},å¤©æ°”{today.wea1}è½¬{today.wea2}ã€‚æœ€é«˜æ°”æ¸©{today.wendu1}æ‘„æ°åº¦,æœ€ä½æ°”æ¸©{today.wendu2}æ‘„æ°åº¦ã€‚";
     }
 }

public class IpData
{
    public string ip { get; set; }
    public string city { get; set; }
    public string region { get; set; }
    public string country { get; set; }
    public string loc { get; set; }
    public string org { get; set; }
    public string postal { get; set; }
    public string timezone { get; set; }
    public string readme { get; set; }
}

public class DataItem
{
    public string week1 { get; set; }
    public string week2 { get; set; }
    public string wea1 { get; set; }
    public string wea2 { get; set; }
    public string wendu1 { get; set; }
    public string wendu2 { get; set; }
    public string img1 { get; set; }
    public string img2 { get; set; }
}

public class WeatherRoot
{
    public List&lt;DataItem&gt; data { get; set; }
    public int code { get; set; }
    public string place { get; set; }
}
</code></pre>
<p>ä»£ç é‡Œå®ç°äº†ä¸‰ä¸ªactionï¼Œåˆ†åˆ«æ˜¯è·å–åŸå¸‚å¤©æ°”ã€è·å–å½“å‰åŸå¸‚ä¿¡æ¯ã€è·å–å¤©æ°”ä¿¡æ¯æ¥å£ã€‚æ¥ä¸‹æ¥æ·»åŠ é¡¹ç›®é…ç½®</p>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =&gt;
{
    options.SwaggerDoc("v1", new OpenApiInfo
    {
        Version = "v1",
        Title = "",
        Description = "",
    });

    var xmlFilename = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";
    options.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory, xmlFilename));
});
builder.Services.AddHttpClient();

var app = builder.Build();

//ä½¿ç”¨OpenApiçš„ç‰ˆæœ¬ä¿¡æ¯
app.UseSwagger(options =&gt;
{
    options.OpenApiVersion = Microsoft.OpenApi.OpenApiSpecVersion.OpenApi3_0;
});
app.UseSwaggerUI(options =&gt;
{
    options.SwaggerEndpoint("/swagger/v1/swagger.json", "v1");
});

app.UseAuthorization();

app.MapControllers();

app.Run();
</code></pre>
<p>å®Œæˆä¸Šé¢çš„ä»£ç ä¹‹åï¼Œå¯ä»¥è¿è¡Œèµ·æ¥è¯¥é¡¹ç›®ã€‚é€šè¿‡<code>http://é¡¹ç›®åœ°å€:ç«¯å£/swagger/v1/swagger.json</code>è·å–<code>WebApi</code>æ¥å£çš„<code>OpenAPI</code>çš„æ•°æ®æ ¼å¼ã€‚</p>
<h4 id="mcp-server">MCP Server</h4>
<p>æ¥ä¸‹æ¥æ­å»º<code>MCP Server</code>é¡¹ç›®ï¼Œæ¥æŠŠä¸Šé¢çš„<code>WebApi</code>é¡¹ç›®è½¬æ¢æˆ<code>MCP Server</code>ã€‚é¦–å…ˆæ·»åŠ <code>MCP</code>å’Œ<code>SemanticKernel OpenApi</code>æ¶‰åŠåˆ°çš„ç±»åº“ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>SemanticKernel</code>æ¥æŠŠ<code>swagger.json</code>åŠ è½½æˆ<code>Plugins</code></p>
<pre><code>&lt;ItemGroup&gt;
  &lt;PackageReference Include="Microsoft.Extensions.Hosting" Version="8.0.0" /&gt;
  &lt;PackageReference Include="Microsoft.SemanticKernel.Plugins.OpenApi" Version="1.47.0" /&gt;
  &lt;PackageReference Include="ModelContextProtocol" Version="0.1.0-preview.11" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç¼–å†™å…·ä½“çš„ä»£ç å®ç°</p>
<pre><code class="language-csharp">IKernelBuilder kernelBuilder = Kernel.CreateBuilder();;
Kernel kernel = kernelBuilder.Build();

#pragma warning disable SKEXP0040

//æŠŠswagger.jsonåŠ è½½æˆPlugin
//è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°è·¯å¾„æˆ–è€…æ˜¯æ–‡ä»¶æµ
await kernel.ImportPluginFromOpenApiAsync(
   pluginName: "city_date_weather",
   uri: new Uri("http://localhost:5021/swagger/v1/swagger.json"),
   executionParameters: new OpenApiFunctionExecutionParameters 
   { 
       EnablePayloadNamespacing = true
   }
 );

#pragma warning restore SKEXP0040

var builder = Host.CreateEmptyApplicationBuilder(settings: null);
builder.Services
    //æ·»åŠ MCP Server
    .AddMcpServer()
    //ä½¿ç”¨Stdioæ¨¡å¼
    .WithStdioServerTransport()
    //æŠŠPluginsè½¬æ¢æˆMcpServerTool
    .WithTools(kernel.Plugins);

await builder.Build().RunAsync();


public static class McpServerBuilderExtensions
{
    /// &lt;summary&gt;
    /// æŠŠPluginsè½¬æ¢æˆMcpServerTool
    /// &lt;/summary&gt;
    public static IMcpServerBuilder WithTools(this IMcpServerBuilder builder, KernelPluginCollection plugins)
    {
        foreach (var plugin in plugins)
        {
            foreach (var function in plugin)
            {
                builder.Services.AddSingleton(services =&gt; McpServerTool.Create(function.AsAIFunction()));
            }
        }

        return builder;
    }
}
</code></pre>
<blockquote>
<p>MCPçš„ä¼ è¾“å±‚åè®®å¯ä»¥ä½¿ç”¨<code>stdio(æ—¢æ ‡å‡†è¾“å…¥è¾“å‡º)</code>ã€<code>sse</code>æˆ–è€…æ˜¯<code>streamable</code>ï¼Œç”šè‡³æ˜¯è‡ªå®šä¹‰çš„æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚å…¶ä¸­<code>stdio</code>å¯ä»¥æœ¬æœºè¿›ç¨‹é—´é€šä¿¡ï¼Œ<code>sse</code>æˆ–è€…æ˜¯<code>streamable</code>è¿›è¡Œè¿œç¨‹é€šä¿¡ã€‚å®ƒçš„æ¶ˆæ¯æ ¼å¼ï¼Œæˆ–è€…ç†è§£ä¸ºæ•°æ®ä¼ è¾“çš„æ ¼å¼æ˜¯<code>JSON-RPC 2.0</code>ã€‚</p>
</blockquote>
<p>å…¶ä¸­<code>ImportPluginFromOpenApiAsync</code>æ–¹æ³•æ˜¯å…¶ä¸­æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼Œå®ƒæ˜¯æŠŠ<code>OpenApi</code>æ¥å£ä¿¡æ¯è½¬æ¢æˆ<code>Kernel Plugins</code>ã€‚å®ƒé€šè¿‡è¯»å–<code>swagger.json</code>é‡Œçš„æ¥å£ä¿¡æ¯çš„å…ƒæ•°æ®æ„å»ºæˆ<code>KernelFunction</code>å®ä¾‹ï¼Œè€Œå…·ä½“çš„è§¦å‘æ“ä½œåˆ™è½¬æ¢æˆHttpè°ƒç”¨ã€‚å…·ä½“çš„å®ç°æ–¹å¼å¯ä»¥é€šè¿‡é˜…è¯»<a href="https://github.com/microsoft/semantic-kernel/blob/main/dotnet/src/Functions/Functions.OpenApi/OpenApiKernelPluginFactory.cs#L251" target="_blank" rel="noopener nofollow">CreateRestApiFunction</a>æ–¹æ³•æºç çš„å®ç°ã€‚</p>
<p>å†æ¬¡<code>AsAIFunction</code>æ–¹æ³•åˆ™æ˜¯æŠŠ<code>KernelFunctionFromMethod</code>è½¬æ¢æˆ<code>KernelAIFunction</code>ï¼Œå› ä¸º<code>KernelFunctionFromMethod</code>æ˜¯ç»§æ‰¿äº†<code>KernelFunction</code>ç±»ï¼Œ<code>KernelAIFunction</code>åˆ™æ˜¯ç»§æ‰¿äº†<code>AIFunction</code>ç±»ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œæ˜¯æŠŠ<code>KernelFunction</code>è½¬æ¢æˆ<code>AIFunction</code>ã€‚å¯ä»¥æŠŠ<code>KernelAIFunction</code>ç†è§£æˆ<code>KernelFunction</code>çš„å¤–è§‚ç±»ï¼Œå®ƒåªæ˜¯åŒ…è£…äº†<code>KernelFunction</code>çš„æ“ä½œï¼Œæ‰€ä»¥è§¦å‘çš„æ—¶å€™è¿˜æ˜¯<code>KernelFunctionFromMethod</code>é‡Œçš„æ“ä½œã€‚å…·ä½“çš„å®ç°å¯ä»¥æŸ¥çœ‹<a href="https://github.com/microsoft/semantic-kernel/blob/main/dotnet/src/SemanticKernel.Abstractions/Functions/KernelFunction.cs#L529" target="_blank" rel="noopener nofollow"> KernelAIFunction</a>ç±»çš„å®ç°ã€‚</p>
<p>å‡ å¥ç®€å•çš„ä»£ç æ—¢å¯ä»¥å®ç°ä¸€ä¸ª<code>Mcp Server</code>ï¼Œè™½ç„¶ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>Uri</code>çš„æ–¹å¼åŠ è½½çš„<code>OpenAPI</code>æ–‡æ¡£åœ°å€ï¼Œä½†æ˜¯å®ƒä¹Ÿæ”¯æŒ<code>æœ¬åœ°æ–‡ä»¶åœ°å€</code>æˆ–è€…<code>æ–‡ä»¶æµ</code>çš„æ–¹å¼ã€‚ä¸å¾—ä¸è¯´å¾®è½¯ä½“ç³»ä¸‹çš„æ¡†æ¶åœ¨å…·ä½“çš„è½åœ°æ–¹é¢åšå¾—ç¡®å®å¤Ÿå®ç”¨ï¼Œå› ä¸ºå…·ä½“çš„é€»è¾‘éƒ½æ˜¯<code>WebApi</code>å®ç°çš„ï¼Œ<code>Mcp Server</code>åªæ˜¯ä¸€ä¸ªåª’ä»‹ã€‚</p>
<h4 id="mcp-client">MCP Client</h4>
<p>æœ€åå®ç°çš„æ˜¯<code>MCP Client</code>æ˜¯ä¸ºäº†éªŒè¯<code>Mcp Server</code>æ•ˆæœç”¨çš„ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ä»»ä½•æ¡†æ¶æ¥å®ç°ï¼Œéœ€è¦å¼•å…¥<code>ModelContextProtocol</code>å’Œå…·ä½“çš„AIæ¡†æ¶ï¼ŒAIæ¡†æ¶å¯ä»¥æ˜¯<code>Microsoft.Extensions.AI</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>Semantic Kernel</code>ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>Microsoft.Extensions.AI</code>ï¼Œå› ä¸ºå®ƒè¶³å¤Ÿç®€å•ä¹Ÿè¶³å¤Ÿç®€æ´ï¼Œå¼•å…¥ç›¸å…³çš„ç±»åº“</p>
<pre><code class="language-csharp">&lt;ItemGroup&gt;
    &lt;PackageReference Include="Microsoft.Extensions.AI.OpenAI" Version="9.4.3-preview.1.25230.7" /&gt;
    &lt;PackageReference Include="ModelContextProtocol" Version="0.1.0-preview.12" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
<p>å…¶ä¸­<code>ModelContextProtocol</code>æä¾›äº†<code>McpClient</code>åŠŸèƒ½ï¼Œ<code>Microsoft.Extensions.AI</code>æä¾›å…·ä½“çš„AIåŠŸèƒ½é›†æˆã€‚å…·ä½“å®ç°å¦‚ä¸‹æ‰€ç¤º</p>
<pre><code class="language-csharp">//åŠ è½½McpServerï¼Œä»¥ä¸ºæˆ‘ä»¬æ„å»ºçš„æ˜¯ä½¿ç”¨Stdioçš„æ–¹å¼ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä½¿ç”¨McpServerè·¯å¾„å³å¯
await using IMcpClient mcpClient = await McpClientFactory.CreateAsync(new StdioClientTransport(new()
{
    Name = "city_date_weather",
    Command = "..\\..\\..\\..\\McpServerDemo\\bin\\Debug\\net9.0\\McpServerDemo.exe"
}));

//åŠ è½½MCP Tools
var tools = await mcpClient.ListToolsAsync();
foreach (AIFunction tool in tools)
{
    Console.WriteLine($"Tool Name: {tool.Name}");
    Console.WriteLine($"Tool Description: {tool.Description}");
    Console.WriteLine();
}

//ä¸­æ–‡çš„function callingï¼Œå›½å†…ä½¿ç”¨qwen-maxç³»åˆ—æ•ˆæœæœ€å¥½
string apiKey = "sk-****";
var chatClient = new ChatClient("qwen-max-2025-01-25", new ApiKeyCredential(apiKey), new OpenAIClientOptions
{
    Endpoint = new Uri("https://dashscope.aliyuncs.com/compatible-mode/v1")
}).AsIChatClient();

IChatClient client = new ChatClientBuilder(chatClient)
    //å¼€å¯function callingæ”¯æŒ
    .UseFunctionInvocation()
    .Build();

//æ„å»ºTools
ChatOptions chatOptions = new()
{
    Tools = [.. tools],
};

//åˆ›å»ºå¯¹è¯ä»£ç 
List&lt;Microsoft.Extensions.AI.ChatMessage&gt; chatList = [];

string question = "";
do
{
    Console.Write($"User:");
    question = Console.ReadLine();

    if (string.IsNullOrWhiteSpace(question) || question == "exists")
    {
        break;
    }

    chatList.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.User, question));

    Console.Write($"Assistant:");
    StringBuilder sb = new StringBuilder();
    await foreach (var update in client.GetStreamingResponseAsync(chatList, chatOptions))
    {
        if (string.IsNullOrWhiteSpace(update.Text))
        {
            continue;
        }
        sb.Append(update.Text);

        Console.Write(update.Text);
    }

    chatList.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.Assistant, sb.ToString()));

    Console.WriteLine();

} while (true);

Console.ReadLine();
</code></pre>
<p>ä¸Šé¢çš„ä»£ç å®ç°äº†<code>McpClient</code>æ¥å…¥AIåº”ç”¨</p>
<ul>
<li>é¦–å…ˆï¼Œé€šè¿‡<code>McpClient</code>åŠ è½½<code>McpServer</code>é‡Œçš„å·¥å…·</li>
<li>å…¶æ¬¡ï¼ŒæŠŠ<code>MCP Tools</code>åŠ è½½åˆ°<code>Microsoft.Extensions.AI</code>é‡Œ</li>
<li>æœ€åï¼Œåœ¨å’ŒAIæ¨¡å‹å¯¹è¯çš„æ—¶å€™æŠŠToolsè½¬æ¢æˆ<code>function calling</code>ã€‚ä¸­æ–‡çš„<code>function calling</code>ï¼Œä¸ªäººä½“éªŒä¸‹æ¥å›½å†…ä½¿ç”¨<code>qwen-max</code>ç³»åˆ—æ•ˆæœæœ€å¥½</li>
</ul>
<p>å…¶ä¸­<code>mcpClient.ListToolsAsync()</code>è·å–åˆ°çš„æ˜¯<code>McpClientTool</code>é›†åˆï¼Œè€Œ<code>McpClientTool</code>ç»§æ‰¿è‡ª<code>AIFunction</code>ç±»ï¼Œå…·ä½“å¯æŸ¥çœ‹<a href="https://github.com/modelcontextprotocol/csharp-sdk/blob/main/src/ModelContextProtocol/Client/McpClientTool.cs#L28" target="_blank" rel="noopener nofollow">McpClientTool</a>å®ç°æºç ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºå¾®è½¯å°è£…<code>Microsoft.Extensions.AI</code>åŸºåº§çš„é‡è¦æ€§ï¼Œä»¥åæ›´å¤šçš„æ¡†æ¶éƒ½å¯ä»¥å›´ç»•<code>Microsoft.Extensions.AI</code>è¿›è¡Œå°è£…ç»Ÿä¸€æ“ä½œï¼Œè¿™æ ·å¤§å¤§æå‡äº†æ‰©å±•çš„ä¾¿æ·æ€§ã€‚</p>
<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>Semantic Kernel</code>æ¡†æ¶è¿›è¡Œä¸Šé¢çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç›´æ¥ä¸Šä»£ç </p>
<pre><code class="language-csharp">//åŠ è½½McpServerï¼Œä»¥ä¸ºæˆ‘ä»¬æ„å»ºçš„æ˜¯ä½¿ç”¨Stdioçš„æ–¹å¼ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä½¿ç”¨McpServerè·¯å¾„å³å¯
await using IMcpClient mcpClient = await McpClientFactory.CreateAsync(new StdioClientTransport(new()
{
    Name = "city_date_weather",
    Command = "..\\..\\..\\..\\McpServerDemo\\bin\\Debug\\net9.0\\McpServerDemo.exe"
}));

//åŠ è½½MCP Tools
var tools = await mcpClient.ListToolsAsync();

using HttpClientHandler handler = new HttpClientHandler
{
    ClientCertificateOptions = ClientCertificateOption.Automatic
};

using HttpClient httpClient = new(handler)
{
    BaseAddress = new Uri("https://dashscope.aliyuncs.com/compatible-mode/v1")
};

#pragma warning disable SKEXP0070
IKernelBuilder kernelBuilder = Kernel.CreateBuilder();
kernelBuilder.AddOpenAIChatCompletion("qwen-max-2025-01-25", "sk-***", httpClient: httpClient);
//æŠŠToolsåŠ è½½æˆskçš„Plugins
kernelBuilder.Plugins.AddFromFunctions("weather", tools.Select(aiFunction =&gt; aiFunction.AsKernelFunction()));

Kernel kernel = kernelBuilder.Build();
var chatCompletionService = kernel.GetRequiredService&lt;IChatCompletionService&gt;();

PromptExecutionSettings promptExecutionSettings = new()
{
    FunctionChoiceBehavior = FunctionChoiceBehavior.Auto()
};

var history = new ChatHistory();

while (true)
{
    Console.Write($"User:");
    string input = Console.ReadLine();

    if (string.IsNullOrWhiteSpace(input) || input == "exists")
    {
        break;
    }

    history.AddUserMessage(input);
    var chatMessage = await chatCompletionService.GetChatMessageContentAsync(
    history,
    executionSettings: promptExecutionSettings,
    kernel: kernel);

    Console.WriteLine("Assistant:" + chatMessage.Content);

    history.AddAssistantMessage(chatMessage.Content);
}

Console.ReadLine();
</code></pre>
<p>å› ä¸º<code>MCP</code>æ˜¯ä¸€ä¸ªåè®®æ ‡å‡†ï¼Œæ‰€ä»¥<code>MCP Server</code>å¯ä»¥åšåˆ°ä¸€æ¬¡æ„å»ºï¼Œåˆ°å¤„ä½¿ç”¨ã€‚</p>
<h4 id="è¿è¡Œæ•ˆæœ">è¿è¡Œæ•ˆæœ</h4>
<p>è¿è¡Œçš„æ—¶å€™éœ€è¦å…ˆè¿è¡Œèµ·æ¥<code>WebApi</code>é¡¹ç›®ï¼Œç„¶åæŠŠ<code>McpServer</code>ç¼–è¯‘æˆ<code>exe</code>æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ<code>McpClient</code>é¡¹ç›®ï¼Œæˆ‘ä»¬æ‰“å°å‡ºæ¥äº†å¯ç”¨çš„<code>Tools</code>åˆ—è¡¨ã€‚åœ¨Clienté¡¹ç›®è¿›è¡Œå¯¹è¯ï¼Œè¯¢é—®å½“å‰å¤©æ°”æ•ˆæœå¦‚ä¸‹</p>
<p><img src="https://img2024.cnblogs.com/blog/2042116/202505/2042116-20250507112852579-1003140213.png" alt="" loading="lazy"></p>
<p>æ„Ÿå…´è¶£çš„å¦‚æœæƒ³è¿è¡Œå…·ä½“çš„ä»£ç ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ä¸Šä¼ çš„ä»£ç ç¤ºä¾‹<a href="https://github.com/softlgl/McpDemo" target="_blank" rel="noopener nofollow">https://github.com/softlgl/McpDemo</a></p>
<h4 id="æ€»ç»“">æ€»ç»“</h4>
<p>&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡æ¼”ç¤ºäº†å¦‚ä½•æŠŠASP.NET Core WebApiæ‰“é€ æˆMcp Serverï¼Œé€šè¿‡è®²è§£åŸºæœ¬æ¦‚å¿µï¼Œä»‹ç»ä½¿ç”¨çš„æ¡†æ¶ï¼Œä»¥åŠç®€å•çš„ç¤ºä¾‹å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ï¼Œæ•´ä½“æ¥è¯´æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚<code>MCP</code>çš„é‡ç‚¹æ˜¯æ ‡å‡†åŒ–ï¼Œè€Œä¸æ˜¯å–ä»£ã€‚å¦‚æœæƒ³åœ¨AIåº”ç”¨ä¸­ä½¿ç”¨<code>MCP</code>ï¼Œæ¨¡å‹éœ€è¦æ”¯æŒ<code>Function Calling</code>.æˆ‘ä»¬å¯ä»¥æŠŠåŸæ¥å›ºå®šåœ¨AIåº”ç”¨é‡Œçš„å·¥å…·ä»£ç å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œå½¢æˆç‹¬ç«‹çš„åº”ç”¨ï¼Œè¿™æ ·è¿™ä¸ªToolsåº”ç”¨å°±å¯ä»¥å’ŒAIåº”ç”¨éš”ç¦»ï¼Œå½¢æˆç‹¬ç«‹å¯å¤ç”¨çš„å·¥å…·ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨AIå¤§éƒ¨åˆ†æ—¶å€™ç¡®å®å¾ˆå¥½ç”¨ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸æ˜¯é“¶å¼¹ã€‚è‡³äºå®ƒçš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Œåªæœ‰ä¸æ–­åœ°ä½¿ç”¨å®è·µã€‚ä½ èº«è¾¹çš„äº‹æƒ…éƒ½å¯ä»¥å…ˆç”¨AIå°è¯•å»åšï¼Œä¸æ–­åœ°è¯•æ¢å®ƒçš„èƒ½åŠ›ã€‚AIå¸®ä½ åšå®Œçš„äº‹æƒ…ï¼Œå¦‚æœèƒ½è¾¾åˆ°ä½ çš„é¢„æœŸï¼Œä½ å¯ä»¥çœ‹å®ƒçš„å®ç°æ–¹å¼æ–¹æ³•ï¼Œè®©è‡ªå·±å­¦ä¹ åˆ°æ›´å¥½çš„æ€è·¯ã€‚å¦‚æœæ˜¯å®Œå…¨ä¾èµ–AIï¼Œè€Œè‡ªå·±ä¸å»æ€è€ƒï¼Œé‚£çœŸçš„å¯èƒ½ä¼šè¢«AIå–ä»£æ‰ã€‚åªæœ‰ä½ è‡ªå·±ä¸æ–­çš„è¿›æ­¥ï¼Œæ‰èƒ½è¿›ä¸€æ­¥çš„æ¢ç´¢AIï¼Œè®©å®ƒæˆä¸ºä½ çš„å¥½å·¥å…·ã€‚<br>
<br></p>
<div align="center">
  <span style="font-size: 15px">ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡</span>
  <img src="https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png">
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.059055609956018516" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-08 09:46">2025-05-08 09:45</span>&nbsp;
<a href="https://www.cnblogs.com/wucy">yiå¿µä¹‹é—´</a>&nbsp;
é˜…è¯»(<span id="post_view_count">38</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18864044);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18864044', targetLink: 'https://www.cnblogs.com/wucy/p/18864044/dotnet_webapi_mcp', title: 'å¦‚ä½•æŠŠASP.NET Core WebApiæ‰“é€ æˆMcp Server' })">ä¸¾æŠ¥</a>
</div>
        