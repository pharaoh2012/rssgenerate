
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/WindrunnerMax/p/18842271" title="å‘å¸ƒäº 2025-04-23 10:12">
    <span role="heading" aria-level="2">åŸºäº OT-JSON ä¸ Immer è®¾è®¡ä½ä»£ç /å¯Œæ–‡æœ¬åœºæ™¯çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åœ¨å¤æ‚åº”ç”¨ä¸­ï¼Œä¾‹å¦‚ä½ä»£ç ã€å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„åœºæ™¯ä¸‹ï¼Œæ•°æ®ç»“æ„çš„è®¾è®¡å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œè¿™ç§æƒ…å†µä¸‹çš„çŠ¶æ€ç®¡ç†å¹¶éæ˜¯<code>redux</code>ã€<code>mobx</code>ç­‰é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯éœ€è¦é’ˆå¯¹å…·ä½“åœºæ™¯è¿›è¡Œå®šåˆ¶åŒ–è®¾è®¡ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘ä»¬æ¥å°è¯•åŸºäº<code>Immer</code>ä»¥åŠ<code>OT-JSON</code>å®ç°åŸå­åŒ–ã€å¯ååŒã€é«˜æ‰©å±•çš„åº”ç”¨çº§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚</p>
<h2 id="æè¿°">æè¿°</h2>
<p>å°†<code>Immer</code>ä¸<code>OT-JSON</code>ç»“åˆçš„æƒ³æ³•æ¥è‡ªäº<code>slate</code>ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹<code>slate</code>çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯é«˜äº®å—çš„æè¿°ã€‚è¿™ä¸ªæ•°æ®ç»“æ„çœ‹èµ·æ¥éå¸¸åƒé›¶ä»£ç /ä½ä»£ç çš„ç»“æ„ï¼Œå› ä¸ºå…¶å«æœ‰å¾ˆå¤š<code>children</code>ï¼Œè€Œä¸”å­˜åœ¨å¯¹èŠ‚ç‚¹çš„è£…é¥°æè¿°ï¼Œå³<code>bold</code>ã€<code>border</code>ã€<code>background</code>ç­‰å±æ€§å€¼ã€‚</p>
<pre><code class="language-js">[
  {
    "highlight-block": {
      border: "var(--arcoblue-6)",
      background: "var(--arcoblue-3)",
    },
    children: [
      { children: [{ text: "ğŸŒ° " }, { text: "ä¸¾ä¸ªæ —å­", bold: true }] },
      { children: [{ text: "æ”¯æŒé«˜äº®å— å¯ä»¥ç”¨äºæç¤ºæ–‡æ¡£ä¸­çš„é‡è¦å†…å®¹ã€‚" }] },
    ],
  },
];
</code></pre>
<p>é‚£ä¹ˆè¿™é‡Œçš„è®¾è®¡å°±å¾ˆæœ‰è¶£ï¼Œä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬å°±èŠè¿‡ï¼Œæœ¬è´¨ä¸Šä½ä»£ç å’Œå¯Œæ–‡æœ¬éƒ½æ˜¯åŸºäº<code>DSL</code>çš„æè¿°æ¥æ“ä½œ<code>DOM</code>ç»“æ„ï¼Œåªä¸è¿‡å¯Œæ–‡æœ¬ä¸»è¦æ˜¯é€šè¿‡é”®ç›˜è¾“å…¥æ¥æ“ä½œ<code>DOM</code>ï¼Œè€Œæ— ä»£ç åˆ™æ˜¯é€šè¿‡æ‹–æ‹½ç­‰æ–¹å¼æ¥æ“ä½œ<code>DOM</code>ï¼Œè¿™é‡Œå½“ç„¶æ˜¯æœ‰äº›å…±é€šçš„è®¾è®¡æ€è·¯ï¼Œè¿™ä¸ªç»“è®ºå…¶å®å°±æ˜¯æ¥è‡ªäº<code>slate</code>çš„çŠ¶æ€ç®¡ç†ã€‚</p>
<p>æœ¬æ–‡å®ç°çš„ç›¸å…³<code>DEMO</code>éƒ½åœ¨<code>https://github.com/WindRunnerMax/webpack-simple-environment/tree/master/packages/immer-ot-json</code>ä¸­ã€‚</p>
<h3 id="åŸºæœ¬åŸåˆ™">åŸºæœ¬åŸåˆ™</h3>
<p>å‰è¾¹æˆ‘ä»¬ä¹Ÿæåˆ°äº†æ•°æ®ç»“æ„çš„å…·ä½“åœºæ™¯è¿›è¡Œå®šåˆ¶åŒ–è®¾è®¡ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æŒ‡çš„æ˜¯<code>JSON</code>çš„ç»“æ„éå¸¸çµæ´»ï¼Œåƒæ˜¯é«˜äº®å—çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è®¾è®¡ä¸ºå•ç‹¬çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å°†å…¶æ‹å¹³ï¼Œä»¥<code>Map</code>çš„å½¢å¼æ¥æè¿°èŠ‚ç‚¹çš„è£…é¥°ï¼Œå†ä¾‹å¦‚ä¸Šè¿°æ–‡æœ¬å†…å®¹åˆ™è§„å®šäº†éœ€è¦ç”¨<code>text</code>å±æ€§æè¿°ã€‚</p>
<p>åŸå­åŒ–çš„è®¾è®¡éå¸¸é‡è¦ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†åŸå­åŒ–åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç»“æ„çš„åŸå­åŒ–ä¸æ“ä½œçš„åŸå­åŒ–ã€‚ç»“æ„çš„åŸå­åŒ–æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†èŠ‚ç‚¹è‡ªç”±ç»„åˆï¼Œè€Œæ“ä½œçš„åŸå­åŒ–åˆ™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡æè¿°æ¥æ“ä½œèŠ‚ç‚¹çŠ¶æ€ï¼Œè¿™ä¸¤è€…çš„ç»„åˆå¯ä»¥æ–¹ä¾¿åœ°å®ç°ç»„ä»¶æ¸²æŸ“ã€çŠ¶æ€å˜æ›´ã€å†å²æ“ä½œç­‰ç­‰ã€‚</p>
<p>èŠ‚ç‚¹çš„è‡ªç”±ç»„åˆå¯ä»¥åº”ç”¨åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œä¾‹å¦‚è¡¨å•ç»“æ„ä¸­ï¼Œä»»ä½•ä¸€ä¸ªè¡¨å•é¡¹éƒ½å¯ä»¥éƒ½å¯ä»¥å˜ä¸ºå…¶ä»–è¡¨å•é¡¹çš„åµŒå¥—ç»“æ„ï¼Œç»„åˆæ¨¡å¼å¯ä»¥è®¾å®šéƒ¨åˆ†è§„åˆ™æ¥é™åˆ¶ã€‚æ“ä½œçš„åŸå­åŒ–å¯ä»¥æ›´æ–¹ä¾¿åœ°å¤„ç†çŠ¶æ€å˜æ›´ï¼ŒåŒæ ·æ˜¯åœ¨è¡¨å•ä¸­ï¼ŒåµŒå¥—çš„è¡¨å•é¡¹å±•å¼€/æŠ˜å çŠ¶æ€å°±éœ€è¦é€šè¿‡çŠ¶æ€å˜æ›´å®ç°ã€‚</p>
<p>å½“ç„¶ï¼ŒåŸå­åŒ–æ‰§è¡Œæ“ä½œçš„æ—¶å€™å¯èƒ½å¹¶æ²¡æœ‰é‚£ä¹ˆç†æƒ³ï¼Œç»„åˆ<code>ops</code>æ¥æ‰§è¡Œæ“ä½œè¡¨è¾¾ç±»ä¼¼<code>action</code>èŒƒå¼çš„æ“ä½œä¹Ÿæ˜¯å¾ˆå¸¸è§„çš„æ“ä½œï¼Œè¿™éƒ¨åˆ†å°±æ˜¯éœ€è¦<code>compose</code>çš„å¤„ç†æ–¹å¼ã€‚å¹¶ä¸”çŠ¶æ€ç®¡ç†å¯èƒ½å¹¶ä¸æ˜¯éƒ½éœ€è¦æŒä¹…åŒ–ï¼Œåœ¨ä¸´æ—¶çŠ¶æ€ç®¡ç†ä¸­ï¼Œ<code>client-side-xxx</code>å±æ€§å¤„ç†å¾ˆå®¹æ˜“å®ç°ï¼Œ<code>AXY+Z</code>å€¼å¤„ç†åˆ™ä¼šæ›´åŠ å¤æ‚ã€‚</p>
<p>ååŒç®—æ³•çš„åŸºç¡€åŒæ ·æ˜¯åŸå­åŒ–çš„æ“ä½œï¼Œç±»ä¼¼äº<code>redux</code>çš„èŒƒå¼<code>action</code>æ“ä½œéå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯å´æ— æ³•å¤„ç†ååŒå†²çªï¼ŒåŒæ ·ä¹Ÿä¸å®¹æ˜“å¤„ç†å†å²æ“ä½œç­‰ã€‚è¿™ä¸€å±€é™æ€§æºäºå…¶å•å‘ã€ç¦»æ•£çš„æ“ä½œæ¨¡å‹ï¼Œæ¯ä¸ª<code>action</code>ä»…è¡¨è¾¾ç‹¬ç«‹æ„å›¾ï¼Œè€Œç¼ºä¹å¯¹å…¨å±€çŠ¶æ€å› æœå…³ç³»(æ“ä½œ<code>A</code>å½±å“æ“ä½œ<code>B</code>çŠ¶æ€)çš„æ˜¾å¼ç»´æŠ¤ã€‚</p>
<p><code>OT-JSON</code>åˆ™å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†åŸå­åŒ–çš„æ“ä½œï¼Œæ‰©å±•åˆ°ååŒç¼–è¾‘çš„å¤æ‚åœºæ™¯ä¸­ï¼Œé€šè¿‡å¼•å…¥æ“ä½œå˜æ¢<code>OT</code>ï¼Œä»¥æ­¤æ¥è§£å†³å†²çªã€‚å½“ç„¶ä»…ä»…æ˜¯å‰ç«¯å¼•å…¥æ“ä½œå˜æ¢æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å¼•å…¥åç«¯çš„ååŒæ¡†æ¶ï¼Œä¾‹å¦‚<code>ShareDB</code>ç­‰ã€‚å½“ç„¶ï¼Œ<code>CRDT</code>çš„ååŒç®—æ³•ä¹Ÿæ˜¯å¯è¡Œçš„é€‰æ‹©ï¼Œè¿™å±äºåº”ç”¨çš„é€‰å‹é—®é¢˜äº†ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>OT-JSON</code>å¤©ç„¶å¯ä»¥æ”¯æŒæ“ä½œå†å²çš„ç»´æŠ¤ï¼Œæ¯ä¸ªæ“ä½œéƒ½æºå¸¦äº†è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿè¿½æº¯çŠ¶æ€å˜åŒ–çš„å®Œæ•´é“¾æ¡ï¼Œä¸ºæ’¤é”€/é‡åšã€ç‰ˆæœ¬å›æº¯ç­‰é«˜çº§åŠŸèƒ½æä¾›äº†åŸºç¡€ã€‚æ“ä½œä¹‹é—´çš„å› æœå…³ç³»ä¹Ÿè¢«æ˜¾å¼åœ°è®°å½•ä¸‹æ¥ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿåšåˆ°æ“ä½œ<code>A</code>å¿…é¡»åœ¨æ“ä½œ<code>B</code>ä¹‹å‰åº”ç”¨è¿™æ ·çš„çº¦æŸæ¡ä»¶ã€‚</p>
<p>æ‰©å±•æ€§è¿™éƒ¨åˆ†çš„è®¾è®¡å¯ä»¥æ˜¯æ¯”è¾ƒä¸°å¯Œçš„ï¼Œï¼Œæ ‘å½¢ç»“æ„å¤©ç„¶é€‚åˆæ‰¿è½½åµŒå¥—å¼æ•°æ®äº¤äº’ã€‚ä¾‹å¦‚é£ä¹¦æ–‡æ¡£çš„å„ç§æ¨¡å—ï¼Œéƒ½æ˜¯ä»¥<code>Blocks</code>çš„å½¢å¼æ‰©å±•å‡ºæ¥çš„ã€‚æ°å¥½é£ä¹¦çš„æ•°æ®ç»“æ„ååŒä¹Ÿæ˜¯ä½¿ç”¨<code>OT-JSON</code>æ¥å®ç°çš„ï¼Œæ–‡æœ¬çš„ååŒåˆ™æ˜¯å€ŸåŠ©äº†<code>EasySync</code>ä½œä¸º<code>OT-JSON</code>çš„å­ç±»å‹æ¥å®ç°çš„ï¼Œä»¥æ­¤æ¥æä¾›æ›´é«˜çš„æ‰©å±•æ€§ã€‚</p>
<p>å½“ç„¶ï¼Œæ‰©å±•æ€§å¹¶ä¸æ˜¯è¯´å¯ä»¥å®Œå…¨è‡ªç”±åœ°æ¥å…¥æ’ä»¶ï¼Œæ’ä»¶å†…çš„æ•°æ®ç»“æ„è¿˜æ˜¯éœ€è¦æ•´ä½“æ¥å—<code>OT-JSON</code>çš„è°ƒåº¦ï¼Œå¹¶ä¸”æ–‡æœ¬è¿™ç§ç‰¹æ®Šçš„å­ç±»å‹ä¹Ÿè¦å•ç‹¬è°ƒåº¦ã€‚ä»¥æ­¤ç³»ç»Ÿæ¡†æ¶èƒ½å¤Ÿå°†å„ç§å¼‚æ„å†…å®¹æ¨¡å—ç»Ÿä¸€çº³å…¥ååŒä½“ç³»ï¼Œå¹¶ä¸”å¯ä»¥å®ç°ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†ã€ååŒç¼–è¾‘ã€å†å²è®°å½•ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="immer">Immer</h3>
<p><code>Immer</code>ç®€åŒ–äº†ä¸å¯å˜æ•°æ®çš„æ“ä½œï¼Œå¼•å…¥ä¸€ç§ç§°ä¸ºè‰ç¨¿çŠ¶æ€çš„æ¦‚å¿µï¼Œä»¥æ­¤å…è®¸å¼€å‘è€…ä»¥ç›´è§‚çš„å¯å˜æ–¹å¼ç¼–å†™ä»£ç ï¼ŒåŒæ—¶åº•å±‚è‡ªåŠ¨ç”Ÿæˆå…¨æ–°çš„ä¸å¯å˜å¯¹è±¡ã€‚ä¼ ç»Ÿæ–¹å¼ä¸­ï¼Œä¿®æ”¹æ·±å±‚åµŒå¥—çš„æ•°æ®éœ€è¦å°å¿ƒç¿¼ç¿¼åœ°å±•å¼€æ¯ä¸€å±‚ç»“æ„ï¼Œæ—¢å®¹æ˜“å‡ºé”™åˆè®©ä»£ç æ˜¾å¾—å¤æ‚ã€‚</p>
<pre><code class="language-js">const reducer = (state, action) =&gt; {
  return {
    ...state,
    first: {
      ...state.first,
      second: {
        ...state.first.second,
        value: action,
      },
    },
  };
};
</code></pre>
<p>è€Œ<code>Immer</code>é€šè¿‡åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„è‰ç¨¿å¯¹è±¡ï¼Œè®©å¼€å‘è€…åƒæ“ä½œæ™®é€šå¯¹è±¡ä¸€æ ·ç›´æ¥èµ‹å€¼ã€å¢åˆ å±æ€§ï¼Œç”šè‡³ä½¿ç”¨æ•°ç»„çš„<code>push</code>ã€<code>pop</code>ç­‰æ–¹æ³•ã€‚å®Œæˆæ‰€æœ‰ä¿®æ”¹åï¼Œä¾¿åŸºäºè‰ç¨¿çŠ¶æ€çš„å˜æ›´è®°å½•ï¼Œç”Ÿæˆå˜æ›´åä¸åŸå§‹æ•°æ®ç»“æ„å…±äº«æœªä¿®æ”¹éƒ¨åˆ†çš„æ–°å¯¹è±¡ã€‚è¿™ç§æœºåˆ¶æ—¢é¿å…äº†æ·±æ‹·è´çš„æ€§èƒ½æŸè€—ï¼Œåˆä¿è¯äº†æ•°æ®çš„ä¸å¯å˜æ€§ã€‚</p>
<pre><code class="language-js">const reducer = (state, action) =&gt; {
  state.first.second.value = action;
};
</code></pre>
<p>åœ¨<code>Immer</code>ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨ä½¿ç”¨<code>Proxy</code>ä»£ç†ä¿®æ”¹è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä»…åœ¨è®¿é—®åˆ°æ•°æ®çš„æ—¶å€™æ‰ä¼šåˆ›å»º<code>Proxy</code>å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯ä¸€ç§æŒ‰éœ€ä»£ç†çš„æ‡’ä»£ç†æœºåˆ¶ï¼Œè¿™æ ·å°±ä¸éœ€è¦åˆ›å»ºè‰ç¨¿æ—¶éå†åˆ›å»ºæ‰€æœ‰ä»£ç†ã€‚è¿™ç§æœºåˆ¶æå¤§åœ°å‡å°‘äº†ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œå°¤å…¶å½“å¤„ç†å¤§å‹å¤æ‚å¯¹è±¡æ—¶ã€‚</p>
<p>ä¾‹å¦‚ä¿®æ”¹äº†ä¸€ä¸ªæ·±å±‚åµŒå¥—å±æ€§<code>draft.a.b.c = 1</code>ï¼Œ<code>Immer</code>ä¼šæ²¿ç€è®¿é—®è·¯å¾„é€å±‚ç”Ÿæˆä»£ç†ï¼Œ<code>Proxy(a)</code>ã€<code>Proxy(a.b)</code>ã€<code>Proxy(a.b.c)</code>ã€‚å› æ­¤ä½¿ç”¨<code>Immer</code>çš„æ—¶å€™è¿˜éœ€è¦æ³¨æ„ï¼Œåœ¨ä¿®æ”¹å¯¹è±¡çš„æ—¶å€™å°½å¯èƒ½ä¿æŒä»…è¯»å–éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œå…¶ä»–çš„ä»£ç†æ“ä½œè¦åœ¨è‰ç¨¿ï¼Œé¿å…ä¸å¿…è¦çš„ä»£ç†ç”Ÿæˆã€‚</p>
<h3 id="ot-json">OT-JSON</h3>
<p>åœ¨<code>slate</code>ä¸­å®ç°äº†<code>9</code>ç§åŸå­æ“ä½œæ¥æè¿°å˜æ›´ï¼Œè¿™å…¶ä¸­åŒ…å«äº†æ–‡æœ¬å¤„ç†<code>insert_text</code>ã€èŠ‚ç‚¹å¤„ç†<code>insert_node</code>ã€é€‰åŒºå˜æ¢<code>set_selection</code>çš„æ“ä½œç­‰ã€‚ä½†æ˜¯åœ¨<code>slate</code>ä¸­è™½ç„¶å®ç°äº†æ“ä½œå˜æ¢ä¸æ“ä½œåè½¬ç­‰ï¼Œä½†æ˜¯å¹¶æœªå•ç‹¬æŠ½ç¦»ç‹¬ç«‹çš„åŒ…ï¼Œå› æ­¤å¾ˆå¤šè®¾è®¡éƒ½æ˜¯å†…éƒ¨å®ç°çš„ï¼Œä¸å…·æœ‰é€šç”¨æ€§ã€‚</p>
<ul>
<li><code>insert_node</code>: æ’å…¥èŠ‚ç‚¹ã€‚</li>
<li><code>insert_text</code>: æ’å…¥æ–‡æœ¬ã€‚</li>
<li><code>merge_node</code>: åˆå¹¶èŠ‚ç‚¹ã€‚</li>
<li><code>move_node</code>: ç§»åŠ¨èŠ‚ç‚¹ã€‚</li>
<li><code>remove_node</code>: ç§»é™¤èŠ‚ç‚¹ã€‚</li>
<li><code>remove_text</code>: ç§»é™¤æ–‡æœ¬ã€‚</li>
<li><code>set_node</code>: è®¾ç½®èŠ‚ç‚¹ã€‚</li>
<li><code>set_selection</code>: è®¾ç½®é€‰åŒºã€‚</li>
<li><code>split_node</code>: åˆ†å‰²èŠ‚ç‚¹ã€‚</li>
</ul>
<p>ç±»ä¼¼çš„ï¼Œåœ¨<code>OT-JSON</code>ä¸­å®ç°äº†<code>11</code>ç§æ“ä½œï¼Œä¸”<code>json0</code>çš„ç»“æ„è®¾è®¡å·²ç»è¿‡äº†å¹¿æ³›çš„ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯é€šè¿‡ç»“æ„åŒ–çš„æ•°æ®è¡¨è¾¾ï¼Œç¡®ä¿ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚æ­¤å¤–ï¼Œå¯Œæ–‡æœ¬åœºæ™¯ä¸­<code>SubType</code>ä»ç„¶éœ€è¦æ‰©å±•ï¼Œä¾‹å¦‚é£ä¹¦çš„<code>EasySync</code>ç±»å‹æ‰©å±•ï¼Œé‚£è‡ªç„¶å°±éœ€è¦æ›´å¤šçš„æ“ä½œæ¥æè¿°å˜æ›´ã€‚</p>
<ul>
<li><code>{p:[path], na:x}</code>: åœ¨æŒ‡å®šçš„è·¯å¾„<code>[path]</code>å€¼ä¸ŠåŠ <code>x</code>æ•°å€¼ã€‚</li>
<li><code>{p:[path,idx], li:obj}</code>: åœ¨åˆ—è¡¨<code>[path]</code>çš„ç´¢å¼•<code>idx</code>å‰æ’å…¥å¯¹è±¡<code>obj</code>ã€‚</li>
<li><code>{p:[path,idx], ld:obj}</code>: ä»åˆ—è¡¨<code>[path]</code>çš„ç´¢å¼•<code>idx</code>ä¸­åˆ é™¤å¯¹è±¡<code>obj</code>ã€‚</li>
<li><code>{p:[path,idx], ld:before, li:after}</code>: ç”¨å¯¹è±¡<code>after</code>æ›¿æ¢åˆ—è¡¨<code>[path]</code>ä¸­ç´¢å¼•<code>idx</code>çš„å¯¹è±¡<code>before</code>ã€‚</li>
<li><code>{p:[path,idx1], lm:idx2}</code>: å°†åˆ—è¡¨<code>[path]</code>ä¸­ç´¢å¼•<code>idx1</code>çš„å¯¹è±¡ç§»åŠ¨åˆ°ç´¢å¼•<code>idx2</code>å¤„ã€‚</li>
<li><code>{p:[path,key], oi:obj}</code>: å‘è·¯å¾„<code>[path]</code>ä¸­çš„å¯¹è±¡æ·»åŠ é”®<code>key</code>å’Œå¯¹è±¡<code>obj</code>ã€‚</li>
<li><code>{p:[path,key], od:obj}</code>: ä»è·¯å¾„<code>[path]</code>ä¸­çš„å¯¹è±¡ä¸­åˆ é™¤é”®<code>key</code>å’Œå€¼<code>obj</code>ã€‚</li>
<li><code>{p:[path,key], od:before, oi:after}</code>: ç”¨å¯¹è±¡<code>after</code>æ›¿æ¢è·¯å¾„<code>[path]</code>ä¸­é”®<code>key</code>çš„å¯¹è±¡<code>before</code>ã€‚</li>
<li><code>{p:[path], t:subtype, o:subtypeOp}</code>: å¯¹è·¯å¾„<code>[path]</code>ä¸­çš„å¯¹è±¡åº”ç”¨ç±»å‹ä¸º<code>t</code>çš„å­æ“ä½œ<code>o</code>ï¼Œå­ç±»å‹æ“ä½œã€‚</li>
<li><code>{p:[path,offset], si:s}</code>: åœ¨è·¯å¾„<code>[path]</code>çš„å­—ç¬¦ä¸²çš„åç§»é‡<code>offset</code>å¤„æ’å…¥å­—ç¬¦ä¸²<code>s</code>ï¼Œå†…éƒ¨ä½¿ç”¨å­ç±»å‹ã€‚</li>
<li><code>{p:[path,offset], sd:s}</code>: ä»è·¯å¾„<code>[path]</code>çš„å­—ç¬¦ä¸²çš„åç§»é‡<code>offset</code>å¤„åˆ é™¤å­—ç¬¦ä¸²<code>s</code>ï¼Œå†…éƒ¨ä½¿ç”¨å­ç±»å‹ã€‚</li>
</ul>
<p>é™¤äº†åŸå­åŒ–çš„æ“ä½œä¹‹å¤–ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯æ“ä½œå˜æ¢çš„ç®—æ³•å®ç°ï¼Œè¿™éƒ¨åˆ†æ˜¯ååŒçš„åŸºç¡€ã€‚<code>JSON</code>çš„åŸå­æ“ä½œå¹¶éå®Œå…¨ç‹¬ç«‹çš„ï¼Œå¿…é¡»è¦é€šè¿‡æ“ä½œå˜æ¢æ¥ä¿è¯æ“ä½œçš„æ‰§è¡Œé¡ºåºå¯ä»¥éµå¾ªå…¶å› æœä¾èµ–ã€‚åŒæ—¶ï¼Œå¯¹äºæ“ä½œåè½¬çš„å®ç°ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œè¿™éƒ¨åˆ†æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®ç°æ’¤é”€ã€é‡åšç­‰åŠŸèƒ½ã€‚</p>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>åœ¨ä½ä»£ç ã€å¯Œæ–‡æœ¬ã€ç”»æ¿/ç™½æ¿ã€è¡¨å•å¼•æ“ç­‰ç­‰ç¼–è¾‘å™¨åº”ç”¨åœºæ™¯ä¸­ï¼Œä»…ä»…æ˜¯ä½¿ç”¨<code>JSON</code>æ•°æ®ç»“æ„æ¥æè¿°å†…å®¹æ˜¯ä¸å¤Ÿçš„ã€‚ç±»æ¯”åœ¨ç»„ä»¶ä¸­ï¼Œ<code>div</code>æ˜¯æè¿°è§†å›¾çš„ï¼ŒçŠ¶æ€æ˜¯éœ€è¦é¢å¤–å®šä¹‰çš„ï¼Œå¹¶ä¸”é€šè¿‡äº‹ä»¶é©±åŠ¨æ¥æ”¹å˜çŠ¶æ€ã€‚è€Œåœ¨ç¼–è¾‘å™¨åœºæ™¯ä¸­ï¼Œ<code>JSON</code>æ—¢æ˜¯è§†å›¾æè¿°ä¹Ÿæ˜¯è¦æ“ä½œçš„çŠ¶æ€ã€‚</p>
<p>é‚£ä¹ˆåŸºäº<code>JSON</code>æ¥æ¸²æŸ“è§†å›¾è¿™ä»¶äº‹å¹¶ä¸å¤æ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨è¡¨æ ¼æ¸²æŸ“ä¸­çš„åœºæ™¯ä¼šå¾ˆå¸¸è§ã€‚è€Œé€šè¿‡æ“ä½œæ¥å˜æ›´æ•°æ®ç»“æ„åˆ™å¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œé‚£ä¹ˆåŸºäº<code>OT-JSON</code>æˆ‘ä»¬å¯ä»¥å®ç°åŸå­åŒ–çš„æ•°æ®å˜æ›´ï¼Œä¸<code>Immer</code>ç»“åˆåˆ™å¯ä»¥é…åˆè§†å›¾çš„æ¸²æŸ“åˆ·æ–°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…ˆä»¥å•å…ƒæµ‹è¯•çš„æ–¹å¼æµ‹è¯•æ•°æ®ç»“æ„çš„æ“ä½œå˜æ¢ã€‚</p>
<h3 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</h3>
<p>é’ˆå¯¹æ•°æ®çš„åŸºæœ¬æ“ä½œï¼Œæ— éå°±æ˜¯å¢åˆ æ”¹æŸ¥ï¼ŒæŸ¥è¿™éƒ¨åˆ†ä¸»è¦å°±æ˜¯æ ¹æ®<code>path</code>è¯»æ•°æ®å³å¯ï¼Œè€Œæˆ‘ä»¬å…³æ³¨çš„ä¸»è¦æ˜¯å¢åˆ æ”¹è¿™éƒ¨åˆ†ä¸<code>Immer</code>çš„ç»“åˆã€‚é¦–å…ˆæ˜¯<code>insert</code>æ“ä½œï¼Œ<code>p</code>è¡¨ç¤ºè·¯å¾„ï¼Œ<code>li</code>è¡¨ç¤ºæ’å…¥å€¼ï¼Œåœ¨å˜æ›´ä¹‹åå°±å¯ä»¥æ£€æŸ¥å˜æ›´åçš„å€¼æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæœªä¿®æ”¹å¯¹è±¡çš„å¼•ç”¨å¤ç”¨ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/insert.test.ts
const baseState = {
  a: {
    b: [1] as number[],
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", 0],
  li: 0,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b[0]).toBe(0);
expect(nextState.a.b[1]).toBe(1);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
</code></pre>
<p>åˆ é™¤æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„å®ç°ï¼Œ<code>ld</code>è¡¨ç¤ºåˆ é™¤å€¼ï¼Œæ³¨æ„è¿™é‡Œæ˜¯åˆ é™¤çš„å…·ä½“å€¼è€Œä¸æ˜¯ç´¢å¼•ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†<code>invert</code>è½¬æ¢çš„æ–¹ä¾¿ã€‚åŒæ ·å¯ä»¥çœ‹åˆ°ï¼Œ<code>Immer</code>çš„<code>draft</code>å¯¹è±¡åœ¨å˜æ›´ä¹‹åï¼Œåªæœ‰å˜æ›´çš„éƒ¨åˆ†æ˜¯æ–°çš„å¯¹è±¡ï¼Œå…¶ä»–éƒ¨åˆ†æ˜¯å¼•ç”¨å¤ç”¨çš„ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/delete.test.ts
const baseState = {
  a: {
    b: [0, 1, 2] as number[],
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", 1],
  ld: 1,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b[0]).toBe(0);
expect(nextState.a.b[1]).toBe(2);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
</code></pre>
<p>æ›´æ–°æ“ä½œåœ¨<code>OT-JSON</code>ä¸­å®é™…ä¸Šéœ€è¦åŒæ—¶å®šä¹‰<code>oi</code>å’Œ<code>od</code>ï¼Œç›¸å½“äºä¸¤ä¸ªåŸå­æ“ä½œçš„ç»„åˆï¼Œå…·ä½“çš„å®ç°æ˜¯å…ˆæ’å…¥ååˆ é™¤ã€‚åŒæ ·çš„ï¼Œå°†ä¸¤è€…çš„å€¼éƒ½æ”¾ç½®å‡ºæ¥è€Œä¸æ˜¯ä»…å¤„ç†ç´¢å¼•ï¼Œåœ¨<code>invert</code>æ—¶å°±ä¸éœ€è¦<code>snapshot</code>æ¥è¾…åŠ©å¾—åˆ°åŸå§‹å€¼ï¼Œå¹¶ä¸”<code>Immer</code>çš„å¤ç”¨æ•ˆæœä»ç„¶æ²¡æœ‰é—®é¢˜ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/update.test.ts
const baseState = {
  a: {
    b: { c: 1 },
  },
  d: { e: 2 },
};
const draft = createDraft(baseState);
const op: Op = {
  p: ["a", "b", "c"],
  // åº”ç”¨æ—¶æœªæ ¡éªŒ, ä½†ä¸ºäº†ä¿è¯ invert çš„æ­£ç¡®æ€§, è¿™é‡Œéœ€è¦ç¡®å®šåŸå§‹å€¼
  // https://github.com/ottypes/json0/blob/master/lib/json0.js#L237
  od: 1,
  oi: 3,
};
json.type.apply(draft, [op]);
const nextState = finishDraft(draft);
expect(nextState.a.b.c).toBe(3);
expect(nextState.a).not.toBe(baseState.a);
expect(nextState.a.b).not.toBe(baseState.a.b);
expect(nextState.d).toBe(baseState.d);
expect(nextState.d.e).toBe(baseState.d.e);
</code></pre>
<h3 id="æ“ä½œå˜æ¢">æ“ä½œå˜æ¢</h3>
<p>æ“ä½œå˜æ¢çš„åº”ç”¨åœºæ™¯ä¸»è¦æ˜¯åœ¨ååŒç¼–è¾‘ä¸­ï¼Œä½†æ˜¯åœ¨éååŒçš„æƒ…å†µä¸‹ä¹Ÿæœ‰ç€å¤§é‡åº”ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸Šä¼ å›¾ç‰‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å°†ä¸Šä¼ ä¸­çš„è¿™ä¸ªçŠ¶æ€æ”¾ç½®åœ¨<code>undo</code>æ ˆä¸­ï¼Œè€Œæ— è®ºæ˜¯å°†å…¶ä½œä¸ºä¸å¯æ’¤é”€çš„æ“ä½œï¼Œè¿˜æ˜¯åˆå¹¶å…ˆå‰<code>undo</code>æ ˆä¸­å·²æœ‰çš„æ“ä½œï¼Œéƒ½éœ€è¦æ“ä½œå˜æ¢çš„å®ç°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç†è§£<code>b'=transform(a, b)</code>çš„æ„æ€æ˜¯ï¼Œå‡è®¾<code>a</code>å’Œ<code>b</code>éƒ½æ˜¯ä»ç›¸åŒçš„<code>draft</code>åˆ†æ”¯å‡ºæ¥çš„ï¼Œé‚£ä¹ˆ<code>b'</code>å°±æ˜¯å‡è®¾<code>a</code>å·²ç»åº”ç”¨äº†ï¼Œæ­¤æ—¶<code>b</code>éœ€è¦åœ¨<code>a</code>çš„åŸºç¡€ä¸Šå˜æ¢å‡º<code>b'</code>æ‰èƒ½ç›´æ¥åº”ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸º<code>transform</code>è§£å†³äº†<code>a</code>æ“ä½œå¯¹<code>b</code>æ“ä½œé€ æˆçš„å½±å“ï¼Œå³ç»´æŠ¤å› æœå…³ç³»ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä»ç„¶æµ‹è¯•æœ€åŸºæœ¬çš„<code>insert</code>ã€<code>delete</code>ã€<code>retain</code>çš„æ“ä½œå˜æ¢ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå› æœå…³ç³»ä¸­ä½ç½®çš„åç§»æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä¾‹å¦‚è¿œç¨‹çš„<code>b</code>æ“ä½œä¸å³å°†åº”ç”¨çš„<code>a</code>æ“ä½œéƒ½æ˜¯åˆ é™¤æ“ä½œï¼Œå½“<code>b</code>æ“ä½œæ‰§è¡Œæ—¶<code>a</code>æ“ä½œè¦åˆ é™¤çš„å†…å®¹éœ€è¦åœ¨<code>b</code>çš„æ“ä½œç»“æœåé‡æ–°è®¡ç®—ç´¢å¼•ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/transform.test.ts
// insert
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [0], li: 1 }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [2] }]);

// delete
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [0], ld: 1 }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [0] }]);

// retain
const base: Op[] = [{ p: [1] }];
const op: Op[] = [{ p: [1, "key"], oi: "value" }];
const tf = type.transform(base, op, "left");
expect(tf).toEqual([{ p: [1] }]);
</code></pre>
<h3 id="åè½¬æ“ä½œ">åè½¬æ“ä½œ</h3>
<p>åè½¬æ“ä½œå³<code>invert</code>æ–¹æ³•ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°<code>undo</code>ã€<code>redo</code>ç­‰åŠŸèƒ½ã€‚å‰è¾¹æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œè¿›è¡Œ<code>apply</code>çš„æ—¶å€™å¾ˆå¤šæ“ä½œæ˜¯éœ€è¦æ‹¿åˆ°åŸå§‹å€¼çš„ï¼Œè¿™äº›å€¼åœ¨æ‰§è¡Œæ—¶å¹¶æœªå®é™…æ ¡éªŒï¼Œä½†æ˜¯è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨<code>invert</code>æ—¶ç›´æ¥è½¬æ¢ï¼Œä¸éœ€è¦<code>snapshot</code>æ¥è¾…åŠ©è®¡ç®—å€¼ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>invert</code>æ”¯æŒçš„æ˜¯æ‰¹é‡çš„æ“ä½œåè½¬ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ”¶çš„å‚æ•°æ˜¯<code>Op[]</code>ã€‚è¿™é‡Œå¯ä»¥ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œåº”ç”¨æ—¶æ•°æ®æ“ä½œæ­£å‘çš„ï¼Œè€Œåè½¬æ—¶çš„æ‰§è¡Œé¡ºåºæ˜¯éœ€è¦åè½¬çš„ï¼Œä¾‹å¦‚<code>abc</code>çš„ä¸‰ä¸ªæ“ä½œï¼Œåœ¨<code>invert</code>åå¯¹åº”çš„åº”è¯¥æ˜¯<code>cba</code>çš„åè½¬<code>op</code>ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/invert.test.ts
// insert
const op: Op[] = [{ p: [0], li: 1 }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [0], ld: 1 }]);

// delete
const op: Op[] = [{ p: [0], ld: 1 }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [0], li: 1 }]);

// retain
const op: Op[] = [{ p: [1, "key"], oi: "value2", od: "value1" }];
const inverted = type.invert(op);
expect(inverted).toEqual([{ p: [1, "key"], od: "value2", oi: "value1" }]);
</code></pre>
<h3 id="æ‰¹é‡åº”ç”¨">æ‰¹é‡åº”ç”¨</h3>
<p>æ‰¹é‡åº”ç”¨æ“ä½œæ˜¯ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ï¼Œ<code>OT-JSON</code>æ˜¯æ”¯æŒå¤šä¸ª<code>op</code>åŒæ—¶åº”ç”¨çš„ï¼Œç„¶è€Œåœ¨<code>apply</code>æ—¶æ•°æ®æ˜¯å•ä¸ªæ“ä½œæ‰§è¡Œçš„ã€‚è¿™ä¸ªåœºæ™¯è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚åœ¨å®ç°ç”»æ¿æ—¶ï¼ŒæŒ‰ä½<code>shift</code>å¹¶ä¸”å•å‡»å›¾å½¢èŠ‚ç‚¹å¯ä»¥å¤šé€‰ï¼Œç„¶åæ‰§è¡Œåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªåŒæ—¶åŸºäº<code>draft</code>çš„æ‰¹é‡æ“ä½œï¼Œç†è®ºä¸Šä¼šå­˜åœ¨å› æœå…³ç³»ã€‚</p>
<p>åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç°åœ¨æœ‰<code>4</code>ä¸ª<code>op</code>ï¼Œå¹¶ä¸”å­˜åœ¨é‡å¤çš„ç´¢å¼•å€¼å¤„ç†ã€‚é‚£ä¹ˆåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç†è®ºä¸ŠæœŸå¾…çš„ç»“æœåº”è¯¥æ˜¯å°†<code>1/2/3</code>çš„å€¼åˆ é™¤æ‰ï¼Œå³æœ€ç»ˆç»“æœæ˜¯<code>[0, 4, 5, 6]</code>ï¼Œç„¶è€Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœå´æ˜¯<code>[0, 2, 4]</code>ï¼Œè¿™å°±æ˜¯<code>apply</code>æ˜¯ç‹¬ç«‹æ‰§è¡Œï¼Œä¸”æ²¡æœ‰å¤„ç†<code>op</code>é—´çš„å…³è”æ€§å¼•èµ·çš„ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const nextState = type.apply(baseState, ops);
expect(nextState.a.b).toEqual([0, 2, 4]);
</code></pre>
<p>é‚£ä¹ˆç”±äºå…ˆå‰æåˆ°è¿‡äº†ï¼Œ<code>transform</code>è§£å†³äº†<code>a</code>æ“ä½œå¯¹<code>b</code>æ“ä½œé€ æˆçš„å½±å“ï¼Œå³ç»´æŠ¤å› æœå…³ç³»ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡<code>transform</code>æ¥å¤„ç†æ“ä½œä¹‹é—´çš„å…³è”æ€§é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°è¯•è°ƒç”¨<code>transform</code>æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç„¶è€Œ<code>transform</code>çš„å‡½æ•°ç­¾åæ˜¯<code>transform(op1, op2, side)</code>ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸¤ç»„æ“ä½œä¹‹é—´è¿›è¡Œå˜æ¢ï¼Œç„¶è€Œæˆ‘ä»¬ç°åœ¨çš„<code>ops</code>æ˜¯ä»…å•ç»„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™éƒ¨åˆ†åº”è¯¥å¦‚ä½•ç»“åˆã€‚å¦‚æœä»¥ç©ºç»„å˜æ¢<code>ops</code>ç»„çš„è¯ï¼Œè¿”å›çš„ç»“æœæ˜¯<code>[]</code>æ˜¯ä¸æ­£ç¡®çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°è¯•å•<code>op</code>æ¥å¤„ç†ã€‚</p>
<p>å› æ­¤ï¼Œæœ€å¼€å§‹æˆ‘å‡†å¤‡è€ƒè™‘ä½¿ç”¨å°†å·²ç»åº”ç”¨è¿‡çš„<code>ops</code>æ“ä½œè£å‰ªå‡ºæ¥ï¼Œç„¶åå°†å…¶ç›´æ¥å½±å“çš„å€¼é€šè¿‡<code>transform</code>æ¥ç§»é™¤ï¼Œè¿™é‡Œè¿˜éœ€è¦è€ƒè™‘æ˜¯å¦éœ€è¦å°†åº”ç”¨è¿‡çš„æ“ä½œé¡ºåºåè½¬å†å˜æ¢ï¼Œè€Œä¸”è¿™é‡Œä¹Ÿèƒ½å¤Ÿçœ‹åˆ°åˆ é™¤çš„å€¼æ²¡æœ‰é—®é¢˜ï¼Œä¸”é‡å¤çš„æ“ä½œä¹Ÿèƒ½å¤Ÿæ­£ç¡®å¤„ç†ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const tfOps = ops.map((op, index) =&gt; {
  const appliedOps = ops.slice(0, index);
  appliedOps.reverse();
  const nextOps = type.transform([op], appliedOps, "left");
  return nextOps[0];
});
expect(tfOps[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(tfOps[1]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(tfOps[2]).toEqual({ p: ["a", "b", 1], ld: 3 });
expect(tfOps[3]).toEqual(undefined);
const nextState = type.apply(baseState, tfOps.filter(Boolean));
expect(nextState.a.b).toEqual([0, 4, 5, 6]);
</code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†å…¶ç®€å•å°è£…ä¸€ä¸‹ï¼Œç„¶åç›´æ¥è°ƒç”¨å‡½æ•°å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œè¿™æ ·å°±ä¸éœ€è¦å°†é€»è¾‘å…¨éƒ¨æ··æ‚åœ¨æ•´ä¸ªåº”ç”¨çš„è¿‡ç¨‹ä¸­ã€‚è¿™é‡Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹<code>Delta</code>çš„<code>OT</code>å®ç°ï¼Œå•æ¬¡<code>Delta</code>çš„<code>ops</code>æ˜¯ä»¥ç›¸å¯¹ä½ç½®å¤„ç†çš„æ•°æ®ï¼Œè€Œ<code>OT-JSON</code>æ˜¯ç»å¯¹ä½ç½®ï¼Œå› æ­¤åœ¨æ‰¹é‡å¤„ç†æ—¶éœ€è¦è¿›è¡Œè½¬æ¢ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 3], ld: 3 },
];
const transformLocal = (op1: Op, base: Op[], dir: "left" | "right"): Op =&gt; {
  let transformedOp = op1;
  const reversed = [...base].reverse();
  for (const op of reversed) {
    const [result] = type.transformComponent([], transformedOp, op, dir);
    if (!result) return result;
    transformedOp = result;
  }
  return transformedOp;
};
ops.forEach((op, index) =&gt; {
  const appliedOps = ops.slice(0, index);
  const a1 = transformLocal(op, appliedOps, "left");
  appliedOps.reverse();
  const b1 = type.transform([op], appliedOps, "left");
  expect(a1).toEqual(b1[0]);
});
</code></pre>
<p>ç„¶è€Œçœ‹èµ·æ¥ä¸Šè¿°çš„ä¾‹å­è¡¨ç°æ˜¯æ²¡é—®é¢˜çš„ï¼Œç„¶è€Œè€ƒè™‘åˆ°å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹æ‰§è¡Œé¡ºåºçš„é—®é¢˜ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶ä»…ä»…æ˜¯è°ƒæ•´äº†<code>ops</code>çš„é¡ºåºï¼Œä½†æœ€ç»ˆå´å¾—åˆ°äº†é”™è¯¯çš„ç»“æœã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const tfOps = ops.map((op, index) =&gt; {
  const appliedOps = ops.slice(0, index);
  appliedOps.reverse();
  const nextOps = type.transform([op], appliedOps, "left");
  return nextOps[0];
});
expect(tfOps[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(tfOps[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(tfOps[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
// è¿™é‡Œæ˜¯å­˜åœ¨é—®é¢˜çš„ å¸Œæœ›å¾—åˆ°çš„ç»“æœæ˜¯ undefined
expect(tfOps[3]).toEqual({ p: ["a", "b", 1], ld: 3 });
</code></pre>
<p>æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ç©¶ç«Ÿåº”è¯¥å¦‚ä½•æ‹æ¸…æ¥šè¿™ä¸ªå› æœå…³ç³»é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åˆ°è¿™ä»¶äº‹æœ¬èº«å°±åº”è¯¥æ˜¯ç”±<code>a</code>åº”ç”¨åï¼Œ<code>b</code>å‘ç”Ÿäº†å˜æ›´ã€‚é‚£ä¹ˆåœ¨<code>abcd</code>è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯ä»¥<code>a</code>ä¸ºåŸºå‡†ï¼Œå˜æ¢<code>b/c/d</code>ï¼Œç„¶åä»¥<code>b</code>ä¸ºåŸºå‡†ï¼Œå˜æ¢<code>c/d</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const copied: Op[] = [...ops];
const len = copied.length;
for (let i = 0; i &lt; len; i++) {
  // è¿™é‡Œæ˜¯ copied è€Œä¸æ˜¯ ops, æ˜¯åº”ç”¨åçš„æ“ä½œ
  // å¦åˆ™ä¼šå¯¼è‡´å®é™…è½®è½¬çš„æ“ä½œå˜æ¢äº§ç”Ÿé”™è¯¯
  // ä¾‹å¦‚ [1,2,3] ä¸‹ä¼šå‡ºç° [1,1,undefined] çš„æƒ…å†µ
  const base = copied[i];
  for (let k = i + 1; k &lt; len; k++) {
    const op = copied[k];
    if (!op) continue;
    const nextOp = type.transformComponent([], op, base, "left");
    copied[k] = nextOp[0];
  }
}
expect(copied[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(copied[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(copied[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(copied[3]).toEqual(undefined);
</code></pre>
<p>è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨å®é™…ä¸Šæ˜¯å¤šä¸ª<code>op</code>ç»„åˆçš„æ—¶å€™ï¼Œå…¶æ¯ä¸ªæ“ä½œéƒ½æ˜¯ç‹¬ç«‹çš„ç»å¯¹ä½ç½®ï¼Œå¹¶éä¼šå°†å…¶å®ç°ä¸ºç›¸å¯¹çš„ä½ç½®ï¼Œä¾‹å¦‚åœ¨<code>Delta</code>ä¸­ï¼Œ<code>compose</code>æ“ä½œæ˜¯ä¼šè®¡ç®—ä¸ºç›¸å¯¹ä½ç½®çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶ä¹Ÿå¯ä»¥å°†å…¶å°è£…ä¸º<code>composeWith</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åˆå¹¶<code>ops</code>æ—¶ï¼Œä¾‹å¦‚å†å²æ“ä½œçš„åˆå¹¶ä¼šéå¸¸æœ‰ç”¨ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const ops: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 3], ld: 3 },
  { p: ["a", "b", 2], ld: 2 },
  { p: ["a", "b", 3], ld: 3 },
];
const composeWith = (base: Op[], ops: Op[]) =&gt; {
  const waiting: Op[] = [];
  for (const opa of ops) {
    let nextOp = opa;
    for (const opb of base) {
      nextOp = type.transformComponent([], nextOp, opb, "left")[0];
      if (!nextOp) break;
    }
    nextOp &amp;&amp; waiting.push(nextOp);
  }
  return base.concat(waiting.filter(Boolean));
};
const copied = ops.reduce((acc, op) =&gt; composeWith(acc, [op]), [] as Op[]);
expect(copied[0]).toEqual({ p: ["a", "b", 1], ld: 1 });
expect(copied[1]).toEqual({ p: ["a", "b", 2], ld: 3 });
expect(copied[2]).toEqual({ p: ["a", "b", 1], ld: 2 });
expect(copied[3]).toEqual(undefined);
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘åˆ°ä¸€ä¸ªè·¯å¾„æŒæœ‰çš„åœºæ™¯ï¼Œç±»ä¼¼äºæˆ‘ä»¬å®ç°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„<code>Ref</code>æ¨¡å—ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œ<code>loading</code>çŠ¶æ€æ—¶å¯èƒ½ä¼šæœ‰ç”¨æˆ·æ“ä½œæ”¹å˜äº†åŸå§‹è·¯å¾„ï¼Œè¿™ä¸ªæƒ…å†µä¸‹å½“ä¸Šä¼ ç»“æŸåå°†å®é™…åœ°å€å†™å…¥èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦æ‹¿åˆ°æœ€æ–°çš„<code>path</code>ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/test/batch.test.ts
const baseState = {
  a: {
    b: [0, 1, 2, 3, 4, 5, 6] as number[],
  },
};
// æŒæœ‰ä¸”å˜æ¢åçš„æ“ä½œ ç›®çš„æ˜¯å˜æ¢ path
// ä¾‹å¦‚å¦‚æœæ˜¯ ld çš„è¯ åˆ™åº”è¯¥å…ˆå˜æ¢ [5,6] =&gt; [5,5]
const refOps: Op[] = [
  { p: ["a", "b", 5, "attrs"], od: "k", oi: "v" },
  { p: ["a", "b", 6, "attrs"], od: "k1", oi: "v1" },
];
const apply = (snapshot: typeof baseState, ops: Op[]) =&gt; {
  for (let i = 0, n = ops.length; i &lt; n; ++i) {
    const tfOp = ops[i];
    if (!tfOp) continue;
    // å˜æ¢å‡ºå¯ç›´æ¥åº”ç”¨çš„ ops å, ref module å¯ä»¥æŒæœ‰æŒ‰åºå˜æ¢
    for (let k = 0, n = refOps.length; k &lt; n; ++k) {
      const refOp = refOps[k];
      if (!refOp) continue;
      const [result] = type.transformComponent([], refOp, tfOp, "left");
      refOps[k] = result;
    }
  }
  return type.apply(snapshot, ops);
};
const tfOps: Op[] = [
  { p: ["a", "b", 1], ld: 1 },
  { p: ["a", "b", 2], ld: 3 },
  { p: ["a", "b", 1], ld: 2 },
];
const nextState = apply(baseState, tfOps);
expect(nextState.a.b).toEqual([0, 4, 5, 6]);
expect(refOps[0]).toEqual({ p: ["a", "b", 2, "attrs"], od: "k", oi: "v" });
expect(refOps[1]).toEqual({ p: ["a", "b", 3, "attrs"], od: "k1", oi: "v1" });
</code></pre>
<h2 id="ä½ä»£ç åœºæ™¯">ä½ä»£ç åœºæ™¯</h2>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä»¥ç®€å•çš„åˆ—è¡¨åœºæ™¯ä¸ºç¤ºä¾‹ï¼ŒåŸºäº<code>Immer</code>ä»¥åŠ<code>OT-JSON</code>å®ç°åŸºæœ¬çš„çŠ¶æ€ç®¡ç†ã€‚åˆ—è¡¨çš„åœºæ™¯ä¼šæ˜¯æ¯”è¾ƒé€šç”¨çš„å®ç°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå®ç°åˆ—è¡¨çš„å¢åˆ ã€é€‰åŒºå¤„ç†ã€å†å²æ“ä½œç­‰åŠŸèƒ½ï¼Œè¿™å…¶ä¸­å¾ˆå¤šè®¾è®¡æ˜¯å‚è€ƒ<code>slate</code>çš„çŠ¶æ€ç®¡ç†å®ç°ã€‚</p>
<h3 id="æ•°æ®æ“ä½œ">æ•°æ®æ“ä½œ</h3>
<p><code>OT-JSON</code>è¿›è¡Œ<code>apply</code>çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ–¹æ¡ˆæ˜¯é€ä¸ªæ‰§è¡Œ<code>op</code>ã€‚é‚£ä¹ˆä½¿ç”¨<code>OT-JSON</code>æ¥ç®¡ç†çŠ¶æ€çš„æ—¶å€™ï¼Œä¼šå¾ˆå®¹æ˜“æ€è€ƒå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ›´æ”¹äº†æ¯”è¾ƒå†…éƒ¨çš„æ•°æ®çŠ¶æ€ï¼Œ<code>provider</code>æä¾›çš„<code>value</code>åœ¨æœ€é¡¶å±‚çš„å¯¹è±¡å¼•ç”¨å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå¯èƒ½ä¸ä¼šå¼•èµ·<code>render</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¯´å¯èƒ½ä¸å¼•èµ·<code>render</code>ï¼Œå¦‚æœæˆ‘ä»¬åœ¨çŠ¶æ€å˜æ›´ä¹‹åï¼Œç›´æ¥å¼•ç”¨çš„å¯¹è±¡ä¸å‘ç”Ÿæ”¹å˜ï¼Œ<code>setState</code>ä¸ä¼šå¼•èµ·æ¸²æŸ“è¡Œä¸ºã€‚ä½†æ˜¯å¦‚æœç»„ä»¶çŠ¶æ€è¾ƒå¤šï¼Œå…¶ä»–çš„çŠ¶æ€å˜æ›´ä»ç„¶ä¼šå¼•èµ·æ•´ä¸ªç»„ä»¶çš„çŠ¶æ€åˆ·æ–°ï¼Œä¾‹å¦‚ä¸‹é¢çš„<code>Child</code>ç»„ä»¶æœ¬èº«æ²¡æœ‰<code>props</code>å‘ç”Ÿæ”¹å˜ï¼Œä½†<code>count</code>å€¼çš„å˜åŒ–è¿˜æ˜¯ä¼šå¯¼è‡´å‡½æ•°ç»„ä»¶æ‰§è¡Œã€‚</p>
<pre><code class="language-js">// https://reactplayground.vercel.app/
import React, { useState, Fragment } from 'react';

const Child = () =&gt; {
  console.log("render child");
  return &lt;div&gt;Child&lt;/div&gt;;
}

const App = () =&gt; {
  const [count, setCount] = useState(0)
  const handleClick = () =&gt; {
    setCount(c =&gt; c + 1);
  }
  return (
    &lt;Fragment&gt;
      &lt;button onClick={handleClick}&gt;{count}&lt;/button&gt;
      &lt;Child&gt;&lt;/Child&gt;
    &lt;/Fragment&gt;
  );
}

export default App;
</code></pre>
<p>å½“ç„¶æˆ‘ä»¬åœ¨ä¸è€ƒè™‘å…¶ä»–çŠ¶æ€å˜æ›´çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶æœ€é¡¶å±‚çš„å¯¹è±¡å¼•ç”¨ä¸å˜ï¼Œé‚£ä¹ˆè‡ªç„¶æ•´ä¸ªè§†å›¾éƒ½ä¸ä¼šåˆ·æ–°ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¦ä»å˜æ›´çš„èŠ‚ç‚¹å¼€å§‹ï¼Œä»¥æ­¤å‘ä¸Šçš„èŠ‚ç‚¹éƒ½éœ€è¦å˜æ›´å¼•ç”¨å€¼ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè‹¥<code>C</code>å‘ç”Ÿæ”¹å˜ï¼Œåˆ™<code>A</code>ã€<code>C</code>çš„å¼•ç”¨éœ€è¦å˜æ›´ï¼Œå…¶ä»–å¯¹è±¡ä¿æŒåŸå§‹å€¼ï¼Œ<code>Immer</code>æ°å¥½èƒ½å¤Ÿå¸®æˆ‘ä»¬å®ç°è¿™ä¸ªèƒ½åŠ›ã€‚</p>
<pre><code>   A
  / \
 B   C
    / \
   D   E
</code></pre>
<p>å½“ç„¶ï¼Œåœ¨å…ˆå‰çš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥å‘ç°ï¼Œå³ä½¿<code>props</code>çš„å€¼ä¸å˜ï¼Œåœ¨æœ€é¡¶å±‚çš„å€¼å˜æ›´ä¹‹åè¿˜æ˜¯ä¼šå¯¼è‡´æ•´ä¸ªå‡½æ•°ç»„ä»¶é‡æ–°æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯éœ€è¦é…åˆ<code>React.memo</code>ä½¿ç”¨ï¼Œä»¥æ­¤æ¥æ§åˆ¶å‡½æ•°ç»„ä»¶æ˜¯å¦éœ€è¦é‡æ–°æ‰§è¡Œï¼Œå°†ä¸Šé¢ä¾‹å­ä¸­çš„<code>Child</code>ç»„ä»¶åŒ…è£…<code>memo</code>ï¼Œå°±å¯ä»¥é¿å…åœ¨<code>count</code>å€¼å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œç»„ä»¶ã€‚</p>
<pre><code class="language-js">const Child = React.memo(() =&gt; {
  console.log("render child");
  return &lt;div&gt;Child&lt;/div&gt;;
})
</code></pre>
<h3 id="è·¯å¾„æŸ¥æ‰¾">è·¯å¾„æŸ¥æ‰¾</h3>
<p>é€šå¸¸æ¥è¯´ï¼Œåœ¨æ‰§è¡Œå˜æ›´æ—¶æˆ‘ä»¬éœ€è¦å¾—åˆ°è¦å¤„ç†çš„ç›®æ ‡<code>path</code>ï¼Œç‰¹åˆ«æ˜¯æ¸²æŸ“åç»„ä»¶è¦æ“ä½œæœ¬èº«æ—¶ã€‚åœ¨æ™®é€šçš„å˜æ›´ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½æ›´å¤šçš„æ˜¯ä¾èµ–é€‰åŒºèŠ‚ç‚¹çš„è¡¨è¾¾ï¼Œæ¥å¾—åˆ°è¦å¤„ç†çš„ç›®æ ‡èŠ‚ç‚¹ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æƒ³å®ç°æ¯”è¾ƒå¤æ‚çš„æ¨¡å—æˆ–è€…äº¤äº’æ—¶ï¼Œä¾‹å¦‚å›¾ç‰‡çš„å¼‚æ­¥ä¸Šä¼ ç­‰åœºæ™¯æ—¶ï¼Œè¿™å¯èƒ½å¹¶ä¸è¶³ä»¥è®©æˆ‘ä»¬å®Œæˆè¿™äº›åŠŸèƒ½ã€‚</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨<code>React.memo</code>æ¥æ§åˆ¶ç»„ä»¶æ¸²æŸ“åï¼Œå…¶å®ä¼šéšå¼åœ°å¼•å…¥ä¸€ä¸ªé—®é¢˜ã€‚ä¾‹å¦‚æ­¤æ—¶æˆ‘ä»¬æœ‰äºŒçº§åˆ—è¡¨åµŒå¥—ï¼Œä»¥åŠå†…å®¹èŠ‚ç‚¹<code>[1,2]</code>ï¼Œå¦‚æœåœ¨<code>[1]</code>è¿™ä¸ªä½ç½®ä¸Šæ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç†è®ºä¸ŠåŸå§‹çš„å€¼åº”è¯¥å˜ä¸º<code>[2,2]</code>ï¼Œç„¶è€Œç”±äºå‡½æ•°ç»„ä»¶å¹¶æœªæ‰§è¡Œï¼Œå…¶ä¾ç„¶ä¼šä¿æŒåŸå§‹çš„<code>[1,2]</code>ã€‚</p>
<pre><code class="language-js">[
  [0,   0,   0]
  [1,   1,   1(*)]   
]
// insert [1] [0,0,0] =&gt;
[
  [0,   0,   0]
  [0,   0,   0]
  [1,   1,   1(*)]   
]
</code></pre>
<p>è¿™é‡Œä¿æŒåŸå§‹çš„<code>[1,2]</code>å…·ä½“æŒ‡çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°†<code>path</code>åœ¨æ¸²æŸ“æ—¶ä¼ é€’ç»™<code>props</code>ï¼Œå¹¶ä¸”è‡ªå®šä¹‰<code>memo</code>çš„<code>equal</code>å‡½æ•°å¹¶ä¸”ä¼ é€’<code>path</code>ï¼Œé‚£ä¹ˆä½ç´¢å¼•å€¼çš„å˜æ›´ä¼šå¯¼è‡´å¤§é‡èŠ‚ç‚¹çš„ç»„ä»¶é‡æ–°æ‰§è¡Œï¼Œæ€§èƒ½ä¼šé‡æ–°åŠ£åŒ–ã€‚è€Œå¦‚æœä¸ä¼ é€’ç»™<code>props</code>çš„è¯ï¼Œåœ¨ç»„ä»¶å†…éƒ¨è‡ªç„¶æ— æ³•æ‹¿åˆ°èŠ‚ç‚¹æ¸²æŸ“çš„<code>path</code>ã€‚</p>
<p>åœ¨æˆ‘ä»¬å®ç°æ’ä»¶åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªæ’ä»¶æ¥å®ç°å¤šä¸ªç»„ä»¶çš„æ¸²æŸ“ï¼Œè¿™äº›ç»„ä»¶éƒ½æ˜¯åŒä¸€ç§ç±»å‹ï¼Œå´æ˜¯æ¸²æŸ“åœ¨ä¸åŒ<code>path</code>ä¸‹çš„ã€‚å› æ­¤é€šè¿‡æ’ä»¶æ¥è·å–ç”±è¯¥æ’ä»¶æ¸²æŸ“å‡ºç»„ä»¶çš„<code>path</code>è¿˜æ˜¯éœ€è¦é€šè¿‡å¤–å±‚æ¸²æŸ“çŠ¶æ€æ¥ä¼ é€’ï¼Œä¸Šè¿°çš„<code>props</code>ä¼ é€’æ–¹æ¡ˆè‡ªç„¶ä¸åˆé€‚ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é€šè¿‡<code>WeakMap</code>æ¥å®ç°<code>path</code>è·å–ã€‚</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸¤ä¸ª<code>WeakMap</code>å°±å¯ä»¥å®ç°<code>findPath</code>çš„åŠŸèƒ½ï¼Œ<code>NODE_TO_INDEX</code>ç”¨äºå­˜å‚¨èŠ‚ç‚¹ä¸ç´¢å¼•çš„æ˜ å°„å…³ç³»ï¼Œ<code>NODE_TO_PARENT</code>ç”¨äºå­˜å‚¨èŠ‚ç‚¹ä¸çˆ¶èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ã€‚é€šè¿‡è¿™ä¸¤ä¸ª<code>WeakMap</code>å°±å¯ä»¥å®ç°<code>path</code>çš„æŸ¥æ‰¾ï¼Œæ¯æ¬¡æ›´æ–°èŠ‚ç‚¹æ—¶ï¼Œè¾ƒä½ç´¢å¼•çš„æ˜ å°„å…³ç³»éƒ½å¯ä»¥æ›´æ–°ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/components/list.tsx
const children = useMemo(() =&gt; {
  const children: JSX.Element[] = [];
  const path = findPath(currentNode);
  for (let i = 0; i &lt; nodes.length; ++i) {
    const p = path.concat(i);
    const n = nodes[i];
    NODE_TO_INDEX.set(n, i);
    NODE_TO_PARENT.set(n, currentNode);
    children.push(&lt;NodeModel node={n}&gt;&lt;/NodeModel&gt;);
  }
  return children;
}, [currentNode, nodes, selection]);
</code></pre>
<p>é‚£ä¹ˆåœ¨å®é™…æŸ¥æ‰¾<code>path</code>çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä»ç›®æ ‡èŠ‚ç‚¹é€šè¿‡<code>NODE_TO_PARENT</code>å¼€å§‹ä¸æ–­æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹ä¸ºæ­¢ã€‚è€Œåœ¨è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡<code>NODE_TO_INDEX</code>æ¥è·å–<code>path</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦é€šè¿‡å±‚çº§çº§åˆ«çš„éå†å°±å¯ä»¥æŸ¥æ‰¾åˆ°<code>path</code>ï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªçŠ¶æ€æ ‘ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/utils/path.ts
export const findPath = (node: Node | Editor) =&gt; {
  const path: number[] = [];
  let child = node;
  // eslint-disable-next-line no-constant-condition
  while (true) {
    if (child instanceof Editor) {
      return path;
    }
    const parent = NODE_TO_PARENT.get(child);
    if (isNil(parent)) {
      break;
    }
    const i = NODE_TO_INDEX.get(child);
    if (isNil(i)) {
      break;
    }
    path.unshift(i);
    child = parent as Node;
  }
  throw new Error("Unable To Find Path");
};
</code></pre>
<p>é‚£ä¹ˆå®é™…ä¸Šæˆ‘ä»¬ä¹Ÿå¯ä»¥æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ›´æ–°<code>path</code>å€¼æ—¶æ˜¯éœ€è¦æ¸²æŸ“è¿‡ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æƒ³è¦è·å–æœ€æ–°çš„<code>path</code>ï¼Œå¿…é¡»è¦åœ¨æ¸²æŸ“å®Œæˆåæ‰å¯ä»¥ã€‚å› æ­¤æˆ‘ä»¬çš„æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹æ—¶åºå¿…é¡»è¦æ§åˆ¶å¥½ï¼Œå¦åˆ™ä¼šå¯¼è‡´è·å–ä¸åˆ°æœ€æ–°çš„<code>path</code>ï¼Œå› æ­¤é€šå¸¸æˆ‘ä»¬è¿˜éœ€è¦åœ¨<code>useEffect</code>æ¥åˆ†å‘æ¸²æŸ“å®Œæˆäº‹ä»¶ã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œç”±äºå®é™…ç¼–è¾‘å™¨å¼•æ“æ˜¯éœ€è¦ä¾èµ–<code>useEffect</code>æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»è¦æ‰€æœ‰çš„å­ç»„ä»¶æ¸²æŸ“å®Œæˆåæ‰è§¦å‘çˆ¶ç»„ä»¶çš„<code>effect</code>å‰¯ä½œç”¨ã€‚å› æ­¤åœ¨æ•´ä¸ªèŠ‚ç‚¹å¤–å±‚çš„<code>Context</code>çº§åˆ«æ¸²æŸ“èŠ‚ç‚¹ä¸èƒ½æ˜¯<code>React.lazy</code>çš„å®ç°ï¼Œå½“ç„¶å®é™…æ’ä»¶æ¸²æŸ“çš„å†…å®¹æ˜¯å¯ä»¥æ‡’åŠ è½½çš„ã€‚</p>
<pre><code class="language-js">/**
 * è§†å›¾æ›´æ–°éœ€è¦è§¦å‘è§†å›¾ç»˜åˆ¶å®Œæˆäº‹ä»¶ æ— ä¾èµ–æ•°ç»„
 * state  -&gt; parent -&gt; node -&gt; child -&gt;|
 * effect &lt;- parent &lt;- node &lt;- child &lt;-|
 */
useEffect(() =&gt; {
  editor.logger.debug("OnPaint");
  editor.state.set(EDITOR_STATE.PAINTING, false);
  Promise.resolve().then(() =&gt; {
    editor.event.trigger(EDITOR_EVENT.PAINT, {});
  });
});
</code></pre>
<h3 id="é€‰åŒºçŠ¶æ€">é€‰åŒºçŠ¶æ€</h3>
<p>é€‰åŒºçŠ¶æ€<code>selection</code>çš„æ¨¡å—åŒæ ·ä¾èµ–äº<code>React</code>çš„çŠ¶æ€ç»´æŠ¤ï¼Œä¸»è¦æ˜¯å°†å…¶ä½œä¸º<code>Provider</code>æ¥ä½¿ç”¨ã€‚è€Œé€‰åŒºè¡¨è¾¾æœ¬èº«çš„ç»´æŠ¤æ˜¯ä¾èµ–äº<code>path</code>çš„ï¼Œå› æ­¤åœ¨ç‚¹å‡»èŠ‚ç‚¹æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šè¿°çš„<code>findPath</code>æ¥å†™å…¥é€‰åŒºçŠ¶æ€å³å¯ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/components/node.tsx
const onMouseDown = () =&gt; {
  const path = findPath(node);
  editor.selection.set(path);
};
</code></pre>
<p>ä¸ä¸Šè¿°çš„è·¯å¾„æŸ¥æ‰¾ç±»ä¼¼ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šå°†èŠ‚ç‚¹æœ¬èº«çš„<code>path</code>ä½œä¸º<code>props</code>ä¼ é€’åˆ°èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤èŠ‚ç‚¹éœ€è¦å¾—çŸ¥æœ¬èº«æ˜¯å¦å¤„äºé€‰ä¸­çŠ¶æ€åŒæ ·éœ€è¦è®¾è®¡ã€‚è¿™é‡Œçš„è®¾è®¡éœ€è¦è€ƒè™‘ä¸¤éƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯å…¨å±€çš„é€‰åŒºçŠ¶æ€ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨<code>Context</code>æä¾›<code>value</code>ï¼Œå…¶æ¬¡æ˜¯èŠ‚ç‚¹æœ¬èº«çš„çŠ¶æ€ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ç‹¬ç«‹çš„<code>Context</code>ã€‚</p>
<p>å…¨å±€çš„é€‰åŒºçŠ¶æ€ç®¡ç†æœ¬èº«ä¹Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…¨å±€çš„<code>hooks</code>æ˜¯ç”¨äºæä¾›æ‰€æœ‰å­ç»„ä»¶çš„é€‰åŒºå€¼ï¼Œå­ç»„ä»¶ä¸­ç›´æ¥<code>useContext</code>å³å¯ï¼Œåº”ç”¨å…¥å£è¿˜éœ€è¦ä½¿ç”¨ç¼–è¾‘å™¨æœ¬èº«çš„äº‹ä»¶æ¥ç®¡ç†<code>Context</code>çš„é€‰åŒºçŠ¶æ€å€¼ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/hooks/use-selection.ts
export const SelectionContext = React.createContext&lt;Range | null&gt;(null);
export const useSelection = () =&gt; {
  return useContext(SelectionContext);
};
// packages/immer-ot-json/src/components/app.tsx
const onSelectionChange = useMemoFn((e: SelectionChangeEvent) =&gt; {
  const { current } = e;
  setSelection(current);
});
useEffect(() =&gt; {
  editor.event.on(EVENTS.SELECTION_CHANGE, onSelectionChange);
  return () =&gt; {
    editor.event.off(EVENTS.SELECTION_CHANGE, onSelectionChange);
  };
}, [editor, onSelectionChange]);
</code></pre>
<p>å•ä¸ªç»„ä»¶çš„é€‰ä¸­çŠ¶æ€çš„è®¾è®¡æ¯”è¾ƒæœ‰è¶£ï¼Œé¦–å…ˆè€ƒè™‘åˆ°é€‰åŒºçŠ¶æ€åªæœ‰ä¸¤ç§ï¼Œå³é€‰ä¸­/éé€‰ä¸­çŠ¶æ€ï¼Œå› æ­¤æ¯ä¸ªèŠ‚ç‚¹å¤–å±‚éƒ½åº”è¯¥æ”¾ç½®ä¸€ä¸ª<code>Provider</code>æ¥ç®¡ç†çŠ¶æ€ã€‚é‚£ä¹ˆå¦‚æœæ˜¯ä¸€ä¸ªæ·±å±‚æ¬¡åµŒå¥—çš„ç»„ä»¶é€‰ä¸­çŠ¶æ€ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦æ”¹å˜æœ€æ·±å±‚æ¬¡çš„<code>Provider</code>å€¼æ‰å¯ä»¥æ”¹å˜é€‰ä¸­çŠ¶æ€ã€‚</p>
<p>é‚£ä¹ˆè¿™é‡Œå°±éœ€è¦ä¾èµ–æœ€é¡¶å±‚<code>selection</code>çš„çŠ¶æ€å˜æ›´æ¥è§¦å‘æœ€é¡¶å±‚çš„<code>Provider</code>å˜æ›´ï¼Œç„¶åæ¯ä¸€çº§çš„çŠ¶æ€å˜æ›´éƒ½éœ€è¦é‡æ–°æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œä»¥æ­¤æ¥æŒ‰éœ€åœ°å¤„ç†é€‰ä¸­çŠ¶æ€çš„å˜æ›´ä»¥åŠ<code>render</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ·±å±‚æ¬¡èŠ‚ç‚¹å¤„äºé€‰ä¸­çŠ¶æ€æ—¶ï¼Œå…¶æ²¿ç€æ‰€æœ‰<code>path</code>ä½ç´¢å¼•çš„èŠ‚ç‚¹éƒ½ä¼šå¤„äºé€‰ä¸­çŠ¶æ€ã€‚</p>
<p>è¿™é‡Œå…¶å®ä»ç„¶æ˜¯éœ€è¦é…åˆ<code>React.memo</code>æ¥ä½¿ç”¨çš„ï¼Œç”±äº<code>selected</code>ä¼šä½œä¸º<code>props</code>ä¼ é€’ç»™å­ç»„ä»¶ï¼Œå› æ­¤åœ¨<code>selected</code>å€¼å˜æ›´æ—¶ï¼Œå­ç»„ä»¶ä¼šé‡æ–°æ‰§è¡Œã€‚å› æ­¤è¿™é‡Œçš„å˜æ¢æ˜¯ä»é¡¶å±‚å¼€å§‹ï¼Œæ¯ä¸ªé€‰ä¸­çŠ¶æ€ç”±é€‰ä¸­åˆ°éé€‰ä¸­ï¼Œæˆ–è€…æ˜¯ä»éé€‰ä¸­åˆ°é€‰ä¸­çŠ¶æ€ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡<code>rerender</code>ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/hooks/use-selected.ts
export const SelectedContext = createContext&lt;boolean&gt;(false);
export const useSelected = () =&gt; {
  return useContext(SelectedContext);
};
// packages/immer-ot-json/src/components/list.tsx
const children = useMemo(() =&gt; {
  const children: JSX.Element[] = [];
  const path = findPath(editor);
  for (let i = 0; i &lt; nodes.length; ++i) {
    const p = path.concat(i);
    const n = nodes[i];
    const isSelected = selection &amp;&amp; isEqual(selection, p);
    children.push(
      &lt;SelectedContext.Provider key={n.key} value={!!isSelected}&gt;
        &lt;NodeModel selected={!!isSelected} node={n}&gt;&lt;/NodeModel&gt;
      &lt;/SelectedContext.Provider&gt;
    );
  }
  return children;
}, [editor, nodes, selection]);
// packages/immer-ot-json/src/components/node.tsx
const isSelected = useSelected();
</code></pre>
<h3 id="history">History</h3>
<p><code>History</code>æ¨¡å—æ˜¯ä¸<code>OT-JSON</code>å¯¹äºæ•°æ®æ“ä½œçš„éƒ¨åˆ†ç»“åˆæ¯”è¾ƒç´§å¯†çš„æ¨¡å—ï¼Œä¼šæ·±åº¦åº”ç”¨<code>transform</code>è¿›è¡Œæ“ä½œå˜æ¢ï¼ŒåŒ…æ‹¬é€‰åŒºå’Œæ•°æ®çš„å˜æ¢ã€‚æ­¤å¤–<code>invert</code>æ–¹æ³•ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œé€†è½¬æ“ä½œæ˜¯<code>undo</code>ã€<code>redo</code>çš„åŸºç¡€ã€‚</p>
<p>é¦–å…ˆéœ€è¦å…³æ³¨åœ¨ä½•æ—¶å¤„ç†<code>undo</code>ï¼Œæ˜æ˜¾æˆ‘ä»¬ä»…éœ€è¦åœ¨<code>apply</code>æ“ä½œæ—¶æ‰éœ€è¦å¤„ç†æ ˆæ•°æ®ï¼Œè€Œåœ¨<code>apply</code>çš„æ—¶å€™è¿˜éœ€è¦æ³¨æ„ä»…æœ‰ç”¨æˆ·è§¦å‘çš„å†…å®¹æ‰éœ€è¦å¤„ç†ã€‚å½“æ“ä½œæºæ˜¯<code>History</code>æ¨¡å—æœ¬èº«ï¼Œç”šè‡³æ˜¯æ¥æºä¸è¿œç¨‹ååŒçš„æ•°æ®æ—¶ï¼Œè‡ªç„¶æ˜¯ä¸åº”è¯¥å°†æ–°çš„æ•°æ®æ¨å…¥æ ˆä¸­çš„ã€‚</p>
<p>ä¸è¦å¿˜è®°äº†é€‰åŒºçš„è®°å½•ï¼Œå½“è§¦å‘äº†æ’¤é”€ä¹‹åï¼Œæˆ‘ä»¬çš„é€‰åŒºä¹Ÿåº”è¯¥è¦å›å½’åˆ°å‰ä¸€ä¸ªçŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬å®é™…å¤„ç†çš„å®é™…æœ‰ä¸¤ä¸ªï¼Œåœ¨<code>will apply</code>çš„æ—¶æœºè®°å½•å½“å‰é€‰åŒºçš„å€¼ï¼Œåœ¨å®é™…<code>apply</code>çš„æ—¶å€™å†å°†æœ€æ–°çš„å˜æ›´<code>changes</code>æ¨å…¥æ ˆä¸­ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/editor/history.ts
const { changes, source } = event;
if (!changes.length || source === "history") {
  return void 0;
}
this.redoStack = [];
let inverted = type.invert(changes);
let undoRange = this.currentRange;
this.undoStack.push({ ops: inverted, range: undoRange });
</code></pre>
<p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ¯æ¬¡æ‰§è¡Œå˜æ›´çš„æ—¶å€™éƒ½å…¥æ ˆï¼Œç‰¹åˆ«æ˜¯ä¸€äº›é«˜é¢‘æ“ä½œï¼Œä¾‹å¦‚è¾“å…¥æ–‡æœ¬ã€æ‹–æ‹½èŠ‚ç‚¹ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨æ—¶é—´ç‰‡ä¹‹å†…çš„æ“ä½œåˆå¹¶ï¼Œå°†å…¶è§„æ•´ä¸ºåŒä¸€ä¸ª<code>undo ops</code>ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±éœ€è¦è€ƒè™‘å¦‚ä½•å°†æ ˆé¡¶çš„<code>ops</code>ä¸å½“å‰çš„<code>changes</code>åˆå¹¶ï¼Œè¿™å…¶å®å°±ç”¨åˆ°äº†ä¹‹å‰æˆ‘ä»¬çš„<code>composeWith</code>æ–¹æ³•ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/editor/history.ts
if (
  // å¦‚æœè§¦å‘æ—¶é—´åœ¨ delay æ—¶é—´ç‰‡å†… éœ€è¦åˆå¹¶ä¸Šä¸€ä¸ªè®°å½•
  this.lastRecord + this.DELAY &gt; timestamp &amp;&amp;
  this.undoStack.length &gt; 0
) {
  const item = this.undoStack.pop();
  if (item) {
    for (const base of item.ops) {
      for (let k = 0; k &lt; inverted.length; k++) {
        const op = inverted[k];
        if (!op) continue;
        const nextOp = type.transformComponent([], op, base, "left");
        inverted[k] = nextOp[0];
      }
    }
    inverted = type.compose(item.ops, inverted);
    undoRange = item.range;
  }
} else {
  this.lastRecord = timestamp;
}
</code></pre>
<p><code>undo</code>ä¸<code>redo</code>çš„ä¸¤ä¸ªæ–¹æ³•é€šå¸¸æ˜¯éœ€è¦é…åˆä½¿ç”¨çš„ï¼Œåœ¨ä¸æ‰§è¡Œç”¨æˆ·æ€çš„æ“ä½œæ—¶ï¼Œé€šè¿‡<code>history</code>æ¨¡å—æœ¬èº«ç›¸äº’åº”ç”¨çš„<code>changes</code>æ˜¯éœ€è¦è¿›è¡Œå˜æ¢ç„¶åå…¥å¦ä¸€ä¸ªæ ˆã€‚å³<code>undo</code>æ‰§è¡Œçš„<code>changes</code>éœ€è¦å†<code>invert</code>ä¹‹åå…¥<code>redo</code>æ ˆï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/editor/history.ts
public undo() {
  if (!this.undoStack.length) return void 0;
  const item = this.undoStack.pop();
  if (!item) return void 0;
  const inverted = type.invert(item.ops);
  this.redoStack.push({ ops: inverted, range: this.transformRange(item.range, inverted) });
  this.lastRecord = 0;
  this.editor.state.apply(item.ops, "history");
  this.restoreSelection(item);
}

public redo() {
  if (!this.redoStack.length) return void 0;
  const item = this.redoStack.pop();
  if (!item) return void 0;
  const inverted = type.invert(item.ops);
  this.undoStack.push({ ops: inverted, range: this.transformRange(item.range, inverted) });
  this.lastRecord = 0;
  this.editor.state.apply(item.ops, "history");
  this.restoreSelection(item);
}
</code></pre>
<p>é’ˆå¯¹äºé€‰åŒºçš„å˜æ¢åŒæ ·ä¹Ÿä¼šä¾èµ–ä¸<code>transform</code>ï¼Œè¿™é‡Œä»…éœ€è¦ä¾èµ–<code>path</code>å‚æ•°çš„æ”¹å˜å³å¯ã€‚é€‰åŒºå˜æ¢çš„åŸå› æ˜¯æ­¤å‰å­˜å‚¨çš„<code>range</code>æ˜¯åŸºäºæœªå˜æ›´çš„å€¼çš„ï¼Œè€Œæ­¤æ—¶å‡ºæ ˆäº†å°±æ„å‘³ç€å·²ç»æ‰§è¡Œäº†è¿™äº›å˜æ›´ï¼Œå› æ­¤éœ€è¦å˜æ¢æ¥è·å–æœ€æ–°çš„é€‰åŒºã€‚æ­¤å¤–ï¼Œæ¢å¤é€‰åŒºè¿™é‡Œå…¶å®åº”è¯¥å°½å¯èƒ½å°è¯•æ¢å¤åˆ°å˜æ›´é™„è¿‘çš„é€‰åŒºã€‚</p>
<pre><code class="language-js">// packages/immer-ot-json/src/editor/history.ts
protected transformRange(range: Range | null, changes: Op[]) {
  if (!range) return range;
  const nextSelOp = type.transform([{ p: range }], changes, "left");
  return nextSelOp ? (nextSelOp[0].p as Range) : null;
}

protected restoreSelection(stackItem: StackItem) {
  if (stackItem.range) {
    this.editor.selection.set(stackItem.range);
  }
}
</code></pre>
<p>å®é™…ä¸Š<code>History</code>è¿™éƒ¨åˆ†ç”¨åˆ°çš„æ“ä½œå˜æ¢è¿œä¸æ­¢è¿™äº›ï¼Œåœ¨ååŒåœºæ™¯ä¸­æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•åº”å¯¹<code>remote</code>çš„æ“ä½œï¼Œæ¯•ç«ŸåŸåˆ™æ˜¯æˆ‘ä»¬ä»…èƒ½æ’¤é”€è‡ªå·±çš„æ“ä½œã€‚è¿˜æœ‰è¯¸å¦‚å›¾ç‰‡ä¸Šä¼ ç­‰åœºæ™¯æ˜¯éœ€è¦åˆå¹¶æŸ<code>undo</code>æ ˆçš„æ“ä½œçš„ï¼Œè¿™é‡Œä¹Ÿéœ€è¦æ“ä½œå˜æ¢æ¥åº”å¯¹<code>ops</code>ç§»åŠ¨æ‰€å¸¦æ¥çš„å‰¯ä½œç”¨ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬æ”¾ä¸ªåŸºäº<code>Delta</code>çš„å®ç°ã€‚</p>
<pre><code class="language-js">/**
 * å°† mergeId è®°å½•åˆå¹¶åˆ° baseId è®°å½•
 * - æš‚æ—¶ä»…æ”¯æŒåˆå¹¶ retain æ“ä½œ, éœ€ä¿è¯ baseId &lt; mergeId
 * - å…¶ä»–æ“ä½œæš‚æ—¶æ²¡æœ‰åœºæ™¯, å¯æŸ¥é˜… NOTE çš„ History Merge ä¸€èŠ‚
 * @param baseId
 * @param mergeId
 */
public mergeRecord(baseId: string, mergeId: string): boolean {
  const baseIndex = this.undoStack.findIndex(item =&gt; item.id.has(baseId));
  const mergeIndex = this.undoStack.findIndex(item =&gt; item.id.has(mergeId));
  if (baseIndex === -1 || mergeIndex === -1 || baseIndex &gt;= mergeIndex) {
    return false;
  }
  const baseItem = this.undoStack[baseIndex];
  const mergeItem = this.undoStack[mergeIndex];
  let mergeDelta = mergeItem.delta;
  for (let i = mergeIndex - 1; i &gt; baseIndex; i--) {
    const item = this.undoStack[i];
    mergeDelta = item.delta.transform(mergeDelta);
  }
  this.undoStack[baseIndex] = {
    id: new Set([...baseItem.id, ...mergeItem.id]),
    // è¿™é‡Œæ˜¯ merge.compose(base) è€Œä¸æ˜¯ç›¸å
    // å› ä¸º undo åçš„æ‰§è¡Œé¡ºåºæ˜¯ merge -&gt; base
    delta: mergeDelta.compose(baseItem.delta),
    range: baseItem.range,
  };
  this.undoStack.splice(mergeIndex, 1);
  return true;
}

/**
 * å˜æ¢è¿œç¨‹å †æ ˆ
 * @param stack
 * @param delta
 */
protected transformStack(stack: StackItem[], delta: Delta) {
  let remoteDelta = delta;
  for (let i = stack.length - 1; i &gt;= 0; i--) {
    const prevItem = stack[i];
    stack[i] = {
      id: prevItem.id,
      delta: remoteDelta.transform(prevItem.delta, true),
      range: prevItem.range &amp;&amp; this.transformRange(prevItem.range, remoteDelta),
    };
    remoteDelta = prevItem.delta.transform(remoteDelta);
    if (!stack[i].delta.ops.length) {
      stack.splice(i, 1);
    }
  }
}
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬åŸºäº<code>Immer</code>å’Œ<code>OT-JSON</code>è®¾è®¡äº†ä¸€å¥—åº”ç”¨çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œé€šè¿‡<code>Immer</code>çš„è‰ç¨¿æœºåˆ¶ç®€åŒ–ä¸å¯å˜æ•°æ®æ“ä½œï¼Œç»“åˆ<code>OT-JSON</code>çš„åŸå­åŒ–æ“ä½œä¸ååŒç®—æ³•ï¼Œå®ç°åŸå­åŒ–ã€å¯ååŒã€é«˜æ‰©å±•çš„åº”ç”¨çº§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œä»¥åŠæŒ‰éœ€æ¸²æŸ“çš„è§†å›¾æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆã€‚æ•´ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ¯”è¾ƒé€‚ç”¨äºåµŒå¥—æ•°æ®ç»“æ„çš„åŠ¨æ€ç»„åˆä¸çŠ¶æ€ç®¡ç†ã€‚</p>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ ¹æ®åœºæ™¯æ¥é€‰æ‹©åˆé€‚çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚åœ¨åº”ç”¨çº§åˆ«çš„åœºæ™¯ä¸­ï¼Œä¾‹å¦‚å¯Œæ–‡æœ¬ã€ç”»æ¿ã€ä½ä»£ç ä¸­ï¼Œé¡¶å±‚çš„æ¶æ„è®¾è®¡è¿˜æ˜¯éå¸¸é‡è¦çš„ï¼Œæ‰€æœ‰çš„çŠ¶æ€å˜æ›´ã€èŠ‚ç‚¹ç±»å‹éƒ½åº”è¯¥ç”±è¿™å±‚æ¶æ„è®¾è®¡æ‰©å±•å‡ºæ¥ã€‚è€Œåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡å±‚é¢ä¸Šï¼Œåˆ™æ›´æ³¨é‡çš„æ˜¯ä¸šåŠ¡é€»è¾‘çš„åŠŸèƒ½å®ç°ï¼Œè¿™éƒ¨åˆ†å…¶å®å°±æ˜¾å¾—ç›¸å¯¹æ›´è‡ªç”±ä¸€äº›ï¼Œç»å¤§éƒ¨åˆ†å®ç°éƒ½æ˜¯é¢å‘è¿‡ç¨‹çš„é€»è¾‘ï¼Œæ›´å…³æ³¨çš„åˆ™æ˜¯ä»£ç çš„ç»„ç»‡å½¢å¼äº†ã€‚</p>
<h2 id="æ¯æ—¥ä¸€é¢˜">æ¯æ—¥ä¸€é¢˜</h2>
<ul>
<li><a href="https://github.com/WindRunnerMax/EveryDay" target="_blank" rel="noopener nofollow">https://github.com/WindRunnerMax/EveryDay</a></li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://github.com/ottypes/docs" target="_blank" rel="noopener nofollow">https://github.com/ottypes/docs</a></li>
<li><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener nofollow">https://github.com/immerjs/immer</a></li>
<li><a href="https://github.com/ottypes/json0" target="_blank" rel="noopener nofollow">https://github.com/ottypes/json0</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/602961293" target="_blank" rel="noopener nofollow">https://zhuanlan.zhihu.com/p/602961293</a></li>
<li><a href="https://github.com/ianstormtaylor/slate/" target="_blank" rel="noopener nofollow">https://github.com/ianstormtaylor/slate/</a></li>
<li><a href="https://stackoverflow.com/questions/34385243/why-is-immutability-so-important-or-needed-in-javascript" target="_blank" rel="noopener nofollow">https://stackoverflow.com/questions/34385243/why-is-immutability-so-important-or-needed-in-javascript</a></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.17348968590393518" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-23 10:13">2025-04-23 10:12</span>&nbsp;
<a href="https://www.cnblogs.com/WindrunnerMax">WindRunnerMax</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18842271);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18842271', targetLink: 'https://www.cnblogs.com/WindrunnerMax/p/18842271', title: 'åŸºäº OT-JSON ä¸ Immer è®¾è®¡ä½ä»£ç /å¯Œæ–‡æœ¬åœºæ™¯çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ' })">ä¸¾æŠ¥</a>
</div>
        