
	<div class="postTitle">
		<h1><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/cnsharp/p/18819771" title="发布于 2025-04-10 23:29">
    <span role="heading" aria-level="2">C# 多项目打包时如何将项目引用转为包依赖</span>
    

</a>
</h1>
	</div>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1 class="pgc-h-arrow-right" spellcheck="false" data-track="1" data-pm-slice="0 0 []">项目背景</h1>
<p data-track="2">最近开发一组类库，大约会有五六个项目。一个Core，加上若干面向不同产品的实现库，A/B/C/D...它们都依赖Core.</p>
<p data-track="3">首先，我想统一版本号，这个容易，通过Directory.Build.props设置。</p>
<p data-track="4">其次，每个库要单独发包。</p>
<p data-track="5">问题是在开发阶段，子项目都是通过项目引用Core的，便于调试，怎么实现在打包时自动加上对Core包的依赖？</p>
<p data-track="6">经过试验，可以总结三种方法：</p>
<p data-track="7"><strong>一、生成时将 ProjectReference 转为 NuGet 依赖项 (Not Work)</strong></p>
<p data-track="10">这个DeepSeek推荐的方案，但很遗憾，我没试验成功。</p>
<p data-track="11">它的项目结构是这样的：</p>
<pre class="highlighter-hljs"><code>&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\Core\MyProject.Core.csproj" &gt;
    &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;
    &lt;Publish&gt;true&lt;/Publish&gt;
    &lt;Version&gt;$(PackageVersion)&lt;/Version&gt;
    &lt;PackageId&gt;MyProject.Core&lt;/PackageId&gt;
  &lt;/ProjectReference&gt;
&lt;/ItemGroup&gt;


&lt;Target Name="ForcePackageReferenceConversion" BeforeTargets="GenerateNuspec"&gt;
  &lt;ItemGroup&gt;
    &lt;_PackageReferencesToAdd Include="@(ProjectReference-&gt;WithMetadataValue('Publish', 'true'))"&gt;
      &lt;PackageId&gt;%(PackageId)&lt;/PackageId&gt;
      &lt;Version&gt;%(Version)&lt;/Version&gt;
    &lt;/_PackageReferencesToAdd&gt;
    &lt;PackageReference Include="@(_PackageReferencesToAdd-&gt;'%(PackageId)')" Version="%(Version)" /&gt;
  &lt;/ItemGroup&gt;
&lt;/Target&gt;</code></pre>
<p data-track="8">它的核心思路是生成.nuspec前将项目引用强制转换在包引用。</p>
<p data-track="14">我也问了Github Copilot，它也说行，but...请有经验的园友不吝赐教。</p>
<p data-track="13"><strong>二、按条件引用</strong></p>
<p data-track="16">项目结构：</p>
<pre class="highlighter-hljs"><code>&lt;ItemGroup&gt;
  &lt;!-- 开发时使用 ProjectReference --&gt;
  &lt;ProjectReference Include="..\Core\MyProject.Core.csproj"
                    Condition="'$(IsPackaging)' != 'true'" /&gt;

  &lt;!-- 打包时使用 PackageReference --&gt;
  &lt;PackageReference Include="MyProject.Core"
                    Version="$(PackageVersion)"
                    Condition="'$(IsPackaging)' == 'true'" /&gt;
&lt;/ItemGroup&gt;</code></pre>
<p data-track="9">然后使用命令生成：</p>
<pre class="highlighter-hljs"><code>dotnet pack -p:IsPackaging=true</code></pre>
<p data-track="17">此法可行。</p>
<p data-track="20"><strong>三、指定.nuspec文件</strong></p>
<p data-track="19">最后，我又想到了用传统的.nuspec文件。（我很喜欢以前的包管理方式，packages.config/nuspec，不理解为什么MS非要把所有的东西都往project文件里塞。）</p>
<p data-track="21">项目结构：</p>
<pre class="highlighter-hljs"><code>  &lt;!-- 指定自定义 nuspec 文件路径 --&gt;
    &lt;NuspecFile&gt;My.nuspec&lt;/NuspecFile&gt;
    &lt;!-- 传递 MSBuild 属性到 nuspec 中的变量 --&gt;
    &lt;NuspecProperties&gt;$(NuspecProperties);
      id=$(PackageId);
      version=$(Version);
      company=$(Company);
      authors=$(Authors);
      product=$(Product);
      copyright=$(Copyright);
      license=$(PackageLicenseExpression);
      projectUrl=$(PackageProjectUrl);
      repositoryUrl=$(RepositoryUrl);
      repositoryType=$(RepositoryType);
      icon=$(PackageIcon);
      config=$(Configuration)
    &lt;/NuspecProperties&gt;</code></pre>
<p data-track="24">它将Directory.Build.props中定义的属性一一赋给nuspec.</p>
<p data-track="25">验证可行。</p>
<p>&nbsp;</p>
</div>
<div id="MySignature" role="contentinfo">
    <div id="AllanboltSignature">          

 <div>作者：<a href="http://cnsharp.com/" target="_blank">CnSharp工作室</a></div>        

<div>出处：<a href="http://www.cnblogs.com/cnsharp/" target="_blank">http://www.cnblogs.com/cnsharp/</a></div>        

<div>本文版权归CnSharp.com和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.</div>      


</div>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="3.875028257837963" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-10 23:30">2025-04-10 23:29</span>&nbsp;
<a href="https://www.cnblogs.com/cnsharp">Cn#工作室</a>&nbsp;
阅读(<span id="post_view_count">1009</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18819771);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18819771', targetLink: 'https://www.cnblogs.com/cnsharp/p/18819771', title: 'C# 多项目打包时如何将项目引用转为包依赖' })">举报</a>
</div>
