
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zhujiqian/p/18800881" title="发布于 2025-03-30 17:49">
    <span role="heading" aria-level="2">Hive SQL实现近N周的数据统计查询</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>文/朱季谦<br>
先前遇到过一个需求，需要基于HIVE统计近N周范围的数据，例如，统计近7周范围的数据指标。</p>
<p>需要用HIVE SQL去实现该功能，而HIVE SQL并没有PostgreSQL那样例如通过函数to_char((to_date('202550', 'YYYWW') - INTERVAL '5 weeks'), 'yyyyww'))就可以实现202550和往前5周的202545周的查询（这里的50和45分别表示2025年的50周和45周）。</p>
<p>我当时通过百度和DeepSeek都没有找到合适的答案，还是思考了好几天才想明白怎么解决。</p>
<p>既然HIVE SQL没有函数可以直接实现取指定周与近N周的条件范围查询，是否可以有其他方式呢？</p>
<p>答案是肯定的。</p>
<p>我当时是通过额外建一个时间表，该表有天以及天对应的所在周，可以直接通过代码生成这样一张表date_week_table，直接 从2020年一直自动映射到2030年，该表的数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>Day</th>
<th>Week</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2020-01-01</td>
<td>202001</td>
</tr>
<tr>
<td>2</td>
<td>2020-01-02</td>
<td>202001</td>
</tr>
<tr>
<td>3</td>
<td>2020-01-03</td>
<td>202001</td>
</tr>
<tr>
<td>4</td>
<td>2020-01-04</td>
<td>202001</td>
</tr>
<tr>
<td>5</td>
<td>2020-01-05</td>
<td>202001</td>
</tr>
<tr>
<td>6</td>
<td>2020-01-06</td>
<td>202002</td>
</tr>
<tr>
<td>7</td>
<td>2020-01-07</td>
<td>202002</td>
</tr>
<tr>
<td>8</td>
<td>2020-01-08</td>
<td>202002</td>
</tr>
<tr>
<td>.......</td>
<td>......</td>
<td>......</td>
</tr>
</tbody>
</table>
<p>当有这一张周表，而需要查询近N周范围数据的主表由有week字段，例如主表commerce_data是这样的——</p>
<table>
<thead>
<tr>
<th>id</th>
<th>order_id</th>
<th>customer_id</th>
<th>product_id</th>
<th>week</th>
<th>total_amount</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ORD202315001</td>
<td>1001</td>
<td>5001</td>
<td>202501</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>ORD202315002</td>
<td>1002</td>
<td>5002</td>
<td>202452</td>
<td>10</td>
</tr>
<tr>
<td>3</td>
<td>ORD202315003</td>
<td>1003</td>
<td>5003</td>
<td>202451</td>
<td>22</td>
</tr>
<tr>
<td>4</td>
<td>ORD202315004</td>
<td>1004</td>
<td>5004</td>
<td>202450</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>......</td>
<td>......</td>
<td>......</td>
<td>......</td>
<td>......</td>
</tr>
</tbody>
</table>
<p>这时，如果需要统计指定周和前N周的数据，就可以基于这两张表去实现。</p>
<p>例如，查出2025年第1周往前近4周的数据。</p>
<p>可以基于date_week_table周表计算2025年第1周往前近4周都有哪些周，HIVE SQL如下：</p>
<pre><code class="language-sql">select distinct week from date_week_table where week &lt;= '202501' order by week desc limit 3
</code></pre>
<p>然后再基于commerce_data主表计算在2025年第1周往前近4周的数据——</p>
<pre><code class="language-sql">select 
sum(total_amount) 
from commerce_data 
where week in(select distinct week from date_week_table where week &lt;= '202501' order by week desc limit 3) 
group by order_id
</code></pre>
<p>这样，就可以实现查询出指定周及指定周近N周的HIVE SQL查询了。</p>
<p>当然，也有童鞋可能会说，既然只是查询近N周范围，是否可以直接使用指定周，再减去N来差呢？</p>
<p>这里会有一个问题，2025年第一周，即202501，往前两周，分别是202452和202451，如果用指定周202501直接减2，得到的并不是202451。</p>
<p>以上，只是我个人的一个思路，如果还有其他基于HIVE SQL来计算指定周及近N周的计算，可以留言区一块分享讨论。</p>

</div>
<div id="MySignature" role="contentinfo">
    <div>作者：<a href="https://www.cnblogs.com/zhujiqian/" target="_blank">朱季谦</a></div>
<div>出处：<a href="https://www.cnblogs.com/zhujiqian/" target="_blank">https://www.cnblogs.com/zhujiqian/</a></div>
<div>本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须在文章页面给出原文链接，否则保留追究法律责任的权利。 </div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.35328271142592593" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-30 17:50">2025-03-30 17:49</span>&nbsp;
<a href="https://www.cnblogs.com/zhujiqian">朱季谦</a>&nbsp;
阅读(<span id="post_view_count">9</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18800881" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18800881);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18800881', targetLink: 'https://www.cnblogs.com/zhujiqian/p/18800881', title: 'Hive SQL实现近N周的数据统计查询' })">举报</a>
</div>
        