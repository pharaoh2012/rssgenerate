
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lsy131479/p/18659629" title="发布于 2025-01-08 14:42">
    <span role="heading" aria-level="2">Discord技术架构调研（IM即时通讯技术架构分析）</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<div data-page-id="VYG5d4txho3slNxdwFKcFC6qnsg" data-lark-html-role="root" data-docx-has-block-data="true">
<p class="heading-1 ace-line old-record-id-F8MbdoKfYoFgaxxlCp7c20YMnWf">&nbsp;</p>
<h1 class="heading-1 ace-line old-record-id-F8MbdoKfYoFgaxxlCp7c20YMnWf">一、目标</h1>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-TboPdzmvLo0g2CxTo5Mc7jd1nph" data-list="bullet">调研 discord 的整体架构，发掘可为所用的设计思想</li>
</ul>
<h1 class="heading-1 ace-line old-record-id-G9GddlBvHoh6EExYTOMc6bmYnXs">二、调研背景</h1>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-WemxdL1eWoe4htx0lyPcYywAnib" data-list="bullet">Discord作为目前比较火的一个在线聊天和语音通信平台且具有丰富的功能。另外其 “超级”群 概念号称可支持百万级群聊 以及 永久保留用户聊天记录。探究其相关技术架构与技术实现</li>
</ul>
<h1 class="heading-1 ace-line old-record-id-PqfPd3322oFLFyxH4a9cVfX3njZ">三、产品介绍</h1>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-RMcBdhGQtown1mxF61tciZmbnwf" data-list="bullet">目前广泛使用的在线聊天和语音通信平台。最初于2015年发布，旨在为游戏社区提供一个交流和协作的平台，但现在已经扩展到各种不同的领域。</li>
</ul>
<div class="image-uploaded gallery old-record-id-MyWvdCZ3WoKiHixruIJcvg0Zngf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;2d946543-5b72-44ab-8504-6e8d397853ed&quot;,&quot;height&quot;:720,&quot;width&quot;:1280,&quot;currHeight&quot;:720,&quot;currWidth&quot;:1280,&quot;natrualHeight&quot;:720,&quot;natrualWidth&quot;:1280,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FGsF6biTSmoGUL8xmDUuc0mI2nQf%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;GsF6biTSmoGUL8xmDUuc0mI2nQf&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:427349,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164034322-509664114.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h2 class="heading-2 ace-line old-record-id-RUmsdpMlFoHrdXxPXJmccpmpneK">3.1、主要功能</h2>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-XgfDd7yR7ouUNmxla8Dc2GIJnfe" data-list="number">文字聊天：用户可以在频道中发送消息，与其他成员进行实时交流。这些消息可以包含文字、表情符号、图片、链接等。</li>
<li class="ace-line ace-line old-record-id-Pl5UdAOe4oX6MCxoN4Pcl0Z7nSe" data-list="number">语音通话：用户可以通过Discord内置的语音通话功能与其他成员进行语音交流。这对于组织游戏团队、进行远程会议或与朋友进行语音聊天非常有用。</li>
<li class="ace-line ace-line old-record-id-OX2EdrIdYo78obxU1n4cwGo5nAh" data-list="number">视频通话：除了语音通话，Discord还提供了视频通话功能，使用户可以进行面对面的视频交流。</li>
<li class="ace-line ace-line old-record-id-QGi4d6CzDoCB1DxlMQfcjBxlnBw" data-list="number">服务器和频道：用户可以创建自己的服务器，并在服务器内创建不同的频道，以便根据主题或目的进行组织和交流。</li>
<li class="ace-line ace-line old-record-id-Uo5CdjbIXo7OfOxH7NpcXgdJnkh" data-list="number">社交功能：Discord具有添加好友、私信、创建群组等社交功能，让用户可以与其他用户建立联系和交流。</li>
<li class="ace-line ace-line old-record-id-MccxdJGqFoeLGhxNwOac8SxHnOc" data-list="number">权限和角色管理：服务器所有者可以设置不同的权限和角色，以控制成员对频道和服务器的访问和操作权限。</li>
<li class="ace-line ace-line old-record-id-Jq3yd3qsUoONuUxD9Qcchk2hnWb" data-list="number">集成和插件：Discord可以与其他应用程序和服务进行集成，例如Twitch、YouTube、Spotify等，以便在聊天中共享内容或接收通知。</li>
<li class="ace-line ace-line old-record-id-ZKAWdi493o6MNqxvoSwcfpRXnkc" data-list="number">Bots（机器人）：用户可以添加各种机器人来执行各种任务，例如管理服务器、播放音乐、提供实用工具等。</li>
</ol>
<h2 class="heading-2 ace-line old-record-id-Louwdd11IoxkHXxlge5cu2gDneX">3.2、发展历程</h2>
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108142236962-72938842.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<h2 class="heading-2 ace-line old-record-id-PywPdynepondphxOUKgccudDnqh">3.3、数据情况</h2>
<h3 class="heading-3 ace-line old-record-id-XwJQdNS0qoPzlQxsJUhcs48Fnbc">3.3.1、用户及群数据</h3>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-UMnMdTEmXoiKDSxswjbcijOln6g" data-list="bullet">总用户数未知，预计1.5 亿月活跃用户，平台上有 1900 万个服务器，涵盖游戏、投资、政治、动漫等领域。2020 年，Discord 每周有 670 万服务器处于活跃状态，基本上每周都有某个给定话题的对话讨论。2021 年，Discord 每周活跃服务器数据增长到了 1900 万。</li>
</ul>
<div class="image-uploaded gallery old-record-id-Ic1Nd4pVroQawaxO1HUcn2Mqn4c" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;91d0dd06-6c37-4b85-9eb2-ecfd24408cb0&quot;,&quot;height&quot;:291,&quot;width&quot;:398,&quot;currHeight&quot;:291,&quot;currWidth&quot;:398,&quot;natrualHeight&quot;:291,&quot;natrualWidth&quot;:398,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FMYEUbis5eocE6Ux4aKnczExWn0b%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;MYEUbis5eocE6Ux4aKnczExWn0b&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:56191,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164042708-1926187609.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h3 class="heading-3 ace-line old-record-id-SUYEdcJNYoh2cwxjyv5cTskPnBe">3.3.2、活跃数据</h3>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-DXP7d1GioolqqexfLWNcBMeCnYf" data-list="bullet">Discord 平台上单个日活跃用户（DAU）与平台的平均互动时长，是游戏直播平台 Twitch 的两倍，同时还是 Facebook Gaming、TikTok、Reddit 以及 Snap 等头部社交平台的两倍以上。</li>
</ul>
<div class="image-uploaded gallery old-record-id-OyETduDiTo3fp1xuwqPc1T2Unoh" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;2f0bf848-2df8-473b-a274-4648e80ce768&quot;,&quot;height&quot;:188,&quot;width&quot;:655,&quot;currHeight&quot;:188,&quot;currWidth&quot;:655,&quot;natrualHeight&quot;:188,&quot;natrualWidth&quot;:655,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FPNA9bDR3EofijmxhuR3cuum9nde%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;PNA9bDR3EofijmxhuR3cuum9nde&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:40608,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164048614-910418476.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h3 class="heading-3 ace-line old-record-id-Ud74dOz1WoYszJxLuIwcTQ1gnnD">3.3.3、收入情况</h3>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-EbNld6DZ2ousqUxfbticZL0cnkc" data-list="bullet">较少的商业化的动作，Discord 的每用户平均收入 (ARPU) 仅为 1.30 美元，在公共社交媒体公司中排名非常靠后。</li>
</ul>
<div class="image-uploaded gallery old-record-id-T0gKdZnYNopUufxBkDgc6dvwnZg" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;60c47652-9a14-4847-a83f-b93ca5c4cfe0&quot;,&quot;height&quot;:369,&quot;width&quot;:480,&quot;currHeight&quot;:369,&quot;currWidth&quot;:480,&quot;natrualHeight&quot;:369,&quot;natrualWidth&quot;:480,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FGsYhbrNtoogT5lxShYLcGlyCnxd%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;GsYhbrNtoogT5lxShYLcGlyCnxd&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:79469,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164055284-714488318.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h1 class="heading-1 ace-line old-record-id-FcgOd59Kbo12WexHnCscLuxinDb">四、调研方向</h1>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-K0XZdNXkboLXlrxN2mGcFcPrnHd" data-list="number">整体技术架构</li>
<li class="ace-line ace-line old-record-id-UdgSd7HWbo2c96xWcTGccNnbnug" data-list="number">外部集成&amp;开放能力</li>
<li class="ace-line ace-line old-record-id-GO1gdD7izoIes3xjOECcLQpynN2" data-list="number">技术栈应用情况</li>
<li class="ace-line ace-line old-record-id-FBlGdDJQHoV9l6xgAQvce5lhnid" data-list="number">核心业务模块设计</li>
<li class="ace-line ace-line old-record-id-QkAfdhSswohU99xxLR9cI74hnmd" data-list="number">核心基础组件设计与基础建设</li>
</ol>
<h1 class="heading-1 ace-line old-record-id-Np9ydQma8oo5x7x1iTqcSNKUncb">五、调研内容来源</h1>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-QqTAdePSEoor2pxi1WgcF9cqniN" data-list="bullet">因discord是一个商业产品且并未开源，国内相关资料也较少。所以只能通过阅读官方博客与开发者平台进行分析、推导与猜想</li>
<li class="ace-line ace-line old-record-id-VZPUdGsjmosCNYx0UgRclwv6nCh" data-list="bullet">官方博客：https://discord.com/blog</li>
<li class="ace-line ace-line old-record-id-H6ZldbQQKoe0vdx4tcocdKOenjf" data-list="bullet">开发者平台：https://discord.com/developers/docs/reference</li>
</ul>
<h1 class="heading-1 ace-line old-record-id-Io0ddgNgnoF22SxSuE4c7sx8ncb">六、调研内容</h1>
<h2 class="heading-2 ace-line old-record-id-TGHZd4VtfotIbNxd99EcCTw6nwg">6.1、 整体架构</h2>
<div class=" old-record-id-Tmj1dXp9FouKrBxvaTgc6NscnDb" data-type="whiteboard">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108140817906-2131370053.png" alt="" width="1866" height="867" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-Izq8dHWlcofItHxZyW9c6YjBnPd"><strong>discord开发团队核心理念</strong></div>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-UVbBdjHneoWVawxvZIicEkhynUD" data-list="number">拥抱开源的同时，对开源中间件做自己的特定优化与增强</li>
<li class="ace-line ace-line old-record-id-AMcrdw4FtoHvidxEeBIcZS5knKc" data-list="number">随时保持基建可替换</li>
<li class="ace-line ace-line old-record-id-UVoqdTvcZoLvOyxpb1UcmZUdnqh" data-list="number">尽可能降低架构与业务开发复杂度</li>
</ol>
<h2 class="heading-2 ace-line old-record-id-InmGdgBGRojA6AxsDp9cv8qLnj9">6.2、 外部集成&amp;开放能力</h2>
<h3 class="heading-3 ace-line old-record-id-KIpcdMA2Qo7A7oxf9UEcGCADnrg">6.2.1、open api</h3>
<div class="image-uploaded gallery old-record-id-RDrwdQ9Yyoeaa8xLOwEcOsBkn5d" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;d70458fd-1b2c-4b7f-896d-64158f4a9086&quot;,&quot;height&quot;:276,&quot;width&quot;:696,&quot;currHeight&quot;:276,&quot;currWidth&quot;:696,&quot;natrualHeight&quot;:276,&quot;natrualWidth&quot;:696,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FQGmabvlcDoMKtbxsdZScHtljnNd%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;QGmabvlcDoMKtbxsdZScHtljnNd&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:74007,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164103788-724792215.png" alt="" loading="lazy"></p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-AjeCdWroeoG21mxDHf8cgeOInKg" data-list="bullet">开放接口，其中主要包括 公会相关操作、表情符号、webhook等开放能力</li>
</ul>
<div class="ace-line ace-line old-record-id-SjQmdjcXWoTVvuxCGmJcXyU7nIf"><strong>6.2.1.1、公会相关操作</strong></div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-RyZXd9g4jo3zW2xJEu5cVMcen4d" data-list="bullet">
<div>在Discord 中的公会（一般也叫“服务器”）代表用户和频道的集合</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-CUCudGCVyo5aU7xzt2ncUVMQnEb" data-list="bullet">一个公会下可以有多个频道，每个频道消息隔离，成员共享</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-GJbbd9yvXoo7c1xrctdcZZ5Knsf" data-list="bullet">提供了公会增删改查、语音状态等管理接口</li>
</ul>
<div class="ace-line ace-line old-record-id-MRtkdymvVoCVAnx2oLfcw7Eenkg"><strong>6.2.1.2、表情符号</strong></div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Wwywdt2T1oX9l8xERricep2Hndh" data-list="bullet">支持开发者可自定义表情包与符号。并提供其管理能力</li>
</ul>
<div class="ace-line ace-line old-record-id-BjWeder5woy8IaxqIs7cekeunvg"><strong>6.2.1.3、webhook</strong></div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Wg6gd5J1Vop7ppxuQkbcxqTrnFc" data-list="bullet">Webhooks 是一种不需要用户主动发起或者机器人交互在 Discord 中向频道发布消息的方式</li>
<li class="ace-line ace-line old-record-id-BVWrdfkRGoXC8wxpvAbc1RIrnjc" data-list="bullet">主要用于系统消息的主动发送</li>
</ul>
<h3 class="heading-3 ace-line old-record-id-DzzudVQGKokJ3xxTbIdc7fglnMe">6.2.2、gateway</h3>
<div class="image-uploaded gallery old-record-id-MLbvd0dCtomZQsxVCiDcaRoFnec" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;f5d36f7e-9f13-4b7b-b93d-f09d8005aea3&quot;,&quot;height&quot;:382,&quot;width&quot;:472,&quot;currHeight&quot;:382,&quot;currWidth&quot;:472,&quot;natrualHeight&quot;:382,&quot;natrualWidth&quot;:472,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FH9I4bTnXmogpvNxpZRrc4cNhnPb%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;H9I4bTnXmogpvNxpZRrc4cNhnPb&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:33410,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164112966-943360484.png" alt="" loading="lazy"></p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-FmPtdXDyiozsbWx0388cWz0Jnff" data-list="bullet">允许开发者通过WebSocket对关键事件进行订阅与监听，最终推送给开发者</li>
<li class="ace-line ace-line old-record-id-Kelrd78w8odr8cxxtwechZ4kn8g" data-list="bullet">可以接收有关服务器/公会中发生的操作事件，例如更新频道或创建角色。在某些情况下，应用<em>还会</em>使用网关连接来更新或请求资源，例如更新语音状态时。</li>
</ul>
<h3 class="heading-3 ace-line old-record-id-VWoydJ1JtoiIhhxvF5OcjFFWn6f">6.2.3、机器人</h3>
<div class="image-uploaded gallery old-record-id-MKOrdQnyKoLvIDxPAaccA3UZnMe" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;25c93f70-bd8a-48b7-91c8-93cd90504390&quot;,&quot;height&quot;:276,&quot;width&quot;:696,&quot;currHeight&quot;:276,&quot;currWidth&quot;:696,&quot;natrualHeight&quot;:276,&quot;natrualWidth&quot;:696,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FAcdpbU0B6ogQAvx1rCmcty55n5P%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;AcdpbU0B6ogQAvx1rCmcty55n5P&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:74007,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164122056-44277031.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Ab2ndizuuo848dxDvt4cs6sGnlv" data-list="bullet">
<div>Discord 提供了机器人用户能力，这是一种自动化的用户类型（每个类型的机器人背后都有一个运行程序，可通过sdk方式进行集成）</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-R0dpdDxzgowlu6xYsUecSAXPn9c" data-list="bullet">类似于微信公众号的机器人功能</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-HxkCd0RCkoMTVjxqYBdcxFMgnSg" data-list="bullet">用户可通过斜杠“/”命令与机器人进行交互。</li>
</ul>
<h3 class="heading-3 ace-line old-record-id-Dj0ZdkjEvolVahxSETGcbyxKn4e">6.2.4、GameSDK</h3>
<div class="image-uploaded gallery old-record-id-OFpodTh28olgp1xDyyTcIPHlnWc" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;58dc64ec-248c-4d06-abde-5c9701a74dc6&quot;,&quot;height&quot;:358,&quot;width&quot;:576,&quot;currHeight&quot;:358,&quot;currWidth&quot;:576,&quot;natrualHeight&quot;:358,&quot;natrualWidth&quot;:576,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FXKGQb6DZSoIr3YxrjOTcSUgRnKc%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;XKGQb6DZSoIr3YxrjOTcSUgRnKc&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:52178,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164128503-1865003492.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-JLgCdKLmHovU7Dx3TiJczIdQn1f" data-list="bullet">通过提供GameSDK让游戏开发者进行集成，来帮助游戏开发与discord进行交互</li>
<li class="ace-line ace-line old-record-id-Shr9dHOwyo4BL8xXLAXcLjC0nL8" data-list="bullet">如：游戏状态管理、网络组件、用户关系、邀请等相关交互功能</li>
</ul>
<h3 class="heading-3 ace-line old-record-id-UFFudKD9AodRupxAAjPcoCxhnWb">6.2.5、RPC（内测中）</h3>
<div class="image-uploaded gallery old-record-id-QwucdWIpkoncRExBZ78cRNNJnyf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;a343182c-92e0-433c-babc-402f5d64aeb9&quot;,&quot;height&quot;:402,&quot;width&quot;:406,&quot;currHeight&quot;:402,&quot;currWidth&quot;:406,&quot;natrualHeight&quot;:402,&quot;natrualWidth&quot;:406,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FTLbqbE4s4o41pYxbF9XcoNT2npb%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;TLbqbE4s4o41pYxbF9XcoNT2npb&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:38612,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164134737-1922178966.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-RuVjdyvShomZQDxTz6icHUR4ncc" data-list="bullet">Discord 客户端会提供一个在本地主机上运行的 RPC 服务器，允许开发者在客户端来控制本地 Discord</li>
<li class="ace-line ace-line old-record-id-IsfSdZA7RovzKRx1pURcxpbHnWh" data-list="bullet">
<div>通过本地调用无服务器方式让游戏开发的客户端可直接与本地discord客户端进行交互</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-QrL0dPThtoB3QpxCAqWcK8kVntb" data-list="bullet">如：rtc控制、公会/频道 管理等</li>
</ul>
</li>
</ul>
<h2 class="heading-2 ace-line old-record-id-Jc9ZdP6K0oEPMVxepufc5aiTnCb">6.3、 技术栈说明</h2>
<h3 class="heading-3 ace-line old-record-id-Nq5Wd9A3VoYvRrxMEbncv8ijnyh">6.3.1、客户端</h3>
<div class="image-uploaded gallery old-record-id-JSZddcP0SojCi0xzP16cT0ywnad" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;5b155711-e39a-4e4c-bcd0-1aa675a466bb&quot;,&quot;height&quot;:158,&quot;width&quot;:1029,&quot;currHeight&quot;:158,&quot;currWidth&quot;:1029,&quot;natrualHeight&quot;:158,&quot;natrualWidth&quot;:1029,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FJgI9bRflnoBvruxZ0Btcg9xJnjg%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;JgI9bRflnoBvruxZ0Btcg9xJnjg&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:16625,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164141763-1800204901.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-UQdxdjkqCoS1sZx6tVScViCYn6c" data-list="bullet">提供移动端与桌面端两种 客户端形式供用户使用</li>
<li class="ace-line ace-line old-record-id-QGeodbaFso6QyGx6B9ZcL6SDnnb" data-list="bullet">移动端使用react native进行跨端业务实现</li>
<li class="ace-line ace-line old-record-id-XeFOdZB6FoVBvExkceFc15dKnAc" data-list="bullet">桌面端使用electron进行的web套壳实现</li>
<li class="ace-line ace-line old-record-id-JeCzd2w65ohaCGxB3kZc2b7QnDf" data-list="bullet">底层组件使用rust进行开发</li>
</ul>
<h3 class="heading-3 ace-line old-record-id-V1IbdjT6OoORfEx9laLcIZRMnBb">6.3.2、服务端</h3>
<h4 class="heading-4 ace-line old-record-id-KYnDdw25qoN9a4x9S02cMY1knOc">6.3.2.1、语言相关</h4>
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108141155994-1695655878.png" alt="" loading="lazy"></p>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-G0yidPmcVoWBmuxVmvvcU5gcnQu" data-list="bullet">多种主流语言进行混合开发</li>
<li class="ace-line ace-line old-record-id-RCHmdT1eNoiuoGxLVzycd19Tndb" data-list="bullet">短链api使用python进行快速迭代</li>
<li class="ace-line ace-line old-record-id-CnBZd2De6obo89xWNnGcraCSnsc" data-list="bullet">长链gateway使用erlang的变种语言Elixir进行开发</li>
<li class="ace-line ace-line old-record-id-YvhNdN8VHoYcjFxO9sgcMEgHnAf" data-list="bullet">
<div>核心业务早期使用Elixir与golang两种语言进行开发</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-Asz4dKOMUo1uXVx2OGDc7nadnfe" data-list="bullet">其中golang主要实现rtc与音频相关业务服务</li>
<li class="ace-line ace-line old-record-id-MVVBd6rTXo7AhwxNKawcqzeRnhV" data-list="bullet">
<div>Elixir主要实现im、工会等核心业务相关服务</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-LLsgdKz8VomUZ3xR4B5cUcSznKf" data-list="bullet">其中一些性能优化，组件迭代使用rust增强实现，Elixir通过NIF方式进行调用</li>
</ul>
</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-VwGcdUFwOojvUTxeXxTcs48OnJe" data-list="bullet">经过长久迭代，discord开发团队认为golang gc问题是个诟病，正在逐步进行迁移至rust语言</li>
<li class="ace-line ace-line old-record-id-LxmgdVMJAoTF16x712PcL0Minlf" data-list="bullet">底层组件服务使用rust实现，以达到高性能服务提供</li>
<li class="ace-line ace-line old-record-id-VdPndtOmto3GgMxE10gcia0Xn4f" data-list="bullet">内部服务使用grpc进行通信</li>
</ul>
<h4 class="heading-4 ace-line old-record-id-JdEAd0gc1obgIfxxJvKcnpynnnd">6.3.2.2、应用系统架构</h4>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-ELT5dgYLWoAZvHxsTAAcjSKnnD2" data-list="bullet">整体通过响应式架构进行设计开发</li>
<li class="ace-line ace-line old-record-id-Hyx4dhbeLou7JnxSCiHcgTAanIb" data-list="bullet">
<div>响应式架构特点：</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-KDsXdtOfQoMbsOxMBGOc87Imnxd" data-list="bullet">“流”式编程 （连续、异步、可观察）</li>
<li class="ace-line ace-line old-record-id-BoeVdNLlMod0YRxfbEtcJ8ajnqb" data-list="bullet">有效地处理并发请求，提高系统的吞吐量</li>
<li class="ace-line ace-line old-record-id-SmtcdnuRGoMSHoxjQETcv9Flnth" data-list="bullet">消息/事件驱动，有助于系统的解耦，提高系统的扩展性和弹性。</li>
</ul>
</li>
</ul>
<h4 class="heading-4 ace-line old-record-id-LJzudFOdDoQaVQx28nPcjpNinkb">6.3.2.3、基建相关</h4>
<div class="image-uploaded gallery old-record-id-KqG3dOEC4oPfpZxMo13czAdEnfb" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;9a29853b-53c8-4c2b-9ee0-7692d3680b64&quot;,&quot;height&quot;:147,&quot;width&quot;:1248,&quot;currHeight&quot;:147,&quot;currWidth&quot;:1248,&quot;natrualHeight&quot;:147,&quot;natrualWidth&quot;:1248,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FS7dcbZDXXojUnBx68OYcp5HlnKe%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;S7dcbZDXXojUnBx68OYcp5HlnKe&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:15740,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164149582-1042886319.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-TObFd5om6oNLUDxgAtwc2IEunnf" data-list="bullet">
<div>ETCD：</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-YPxqdcoKeovdRFxkOajc9SAInIK" data-list="bullet">grpc注册中心与服务发现</li>
<li class="ace-line ace-line old-record-id-M9NodbN52ojzASxauYccQG6pnsd" data-list="bullet">组件集群注册管理（如消息检索es管理，后面会详细说）</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-IOREdooyJoWs8FxzcQZcb87pnI5" data-list="bullet">redis： es负载信息存储与缓存</li>
<li class="ace-line ace-line old-record-id-QNNndLhJQoSFV6x7XMRcmk2lnnd" data-list="bullet">
<div>数据存储</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-GGr6dNzUQoyjE5xtxCvcmzLLnGg" data-list="bullet">Mongo -&gt; <em>Cassandra -&gt; ScyllaDB （</em>存在演进过程，后面会详细说<em>）</em></li>
</ul>
</li>
</ul>
<h2 class="heading-2 ace-line old-record-id-U6dMdCfz0oR0R5xiz71cTSuJnWe">6.4、核心业务模块</h2>
<h3 class="heading-3 ace-line old-record-id-PoeWdLihRov6Emxk3AFcsFr2nmd">6.4.1、消息模块</h3>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-NTsYdd2fAojPDzx23Fucs2a1nFe" data-list="bullet">discord消息相关有两个比较关键的点，一个是支持非常灵活的消息样式，另外一个就是其“超级”群消息是如何扇出的</li>
</ul>
<h4 class="heading-4 ace-line old-record-id-WSQsdkN1HoD5DCxWCHEcyvUvnbd">6.4.1.1、 消息组件（协议）</h4>
<h5 class="heading-5 ace-line old-record-id-GjEJdLLVMogFx6xm0kAcYNVUnQg">关键协议摘取</h5>
<div>
<table class="ace-table" data-ace-table-col-widths="204;140;285;342"><colgroup><col width="204"><col width="140"><col width="285"><col width="342"></colgroup>
<tbody>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-TRCjdsaTWoX6MVxen4AcY7ydnLg">字段名</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-GjoWdOWWnoUoDPxCVoxcJgDUnRo">类型</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-XoVDd6l3pobJrgx5aMIcd2wsn8b">作用</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-BDQXdEmjroJUczxZuZhcykNUncG">描述</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-QidjdmIFuoeLBox6p7acCWWanKc">mention_everyone</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-BFlvda4efoaw2nxVEC5cru6RnKh">bool</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Nl3QdFrkFoMxh8xr5uvcLismnPb">是否提及所有人</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-B3irdX7Q2oytbNxYTIkcK8CZnGb">at所有人</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-McnSdeX5OoCkqxxaDWFckawHnPc">mentions</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Lps9d8MoBov53yxMTqbcftKnnFe">user数组</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Fw0Kd6BjUoOKhuxuRUyc1lDAnEe">提及到的人</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-ZijIddOMjoXVGux65rwcjdxBncf">at的所有人</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-WXSudDAx3oJjwaxKcQtcC7fdn5R">attachments</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-XmhbdZRU6on9gtxeVQtcK4oZnEd">消息附件实体数组</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-L24ddInbOoQLUJxZoQccGUENngf">附件</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-E5eQdi9k6oGf66xm9ECcGWdVnUh">主要描述消息内携带的文件内容</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-VM20dpKpeoFMmQxtETScnz2YnMe">pinned</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-PP1AdWTPjoJ5tXx1a7ucab5FneD">bool</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-AovgdOJesojYKAxV362clCcznsf">是否置顶</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-TvERdUVsNoCXOqxKm55ckLW7nFd">消息置顶</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Vd4ad91f7o0XQbxQE20cBb2bngc">message_reference</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Y2URd15O8oWcu3xZOAfc8aJAnph">消息实体</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Q4gqdtIc2ozejTxwKwGcp7Onnab">引用的消息</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-S7YYd2MMSoIGg6xZ7wVc9ycPnmE">被引用的历史消息</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-NCCvdVpJFoqG7Rx06BEcxHPfnef">embeds</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-TdCgd7dXBoXJWAx5mdXcbOfFnUb">消息嵌入实体数组</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-QH5cdmuaeosT8bxUmhmcXUW8ndB">嵌入信息</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-LmVzdQn8holk0Lx3UlwcMa3mnMb">主要描述消息内嵌入的图片、视频等内容</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-TQKXd5BItoFTpSxZfwscp02rn7e">type</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-ZjvUdL61WoLrt9x01MbcC0zcnKd">integer</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-R5qgdZ9ogoM0Bwx6CG2cLXjRnpg">消息类型</div>
<div class="ace-line ace-line old-record-id-VZ0YdiaknoExccxWYBac5UjIn6X">&nbsp;</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Vn96dcd8xoesZHxc0idcijXznhd">消息的类型，详情可看下文。</div>
<div class="ace-line ace-line old-record-id-CZP0dVbI2oAF3SxffSLcjsiWn5c">https://discord.com/developers/docs/resources/channel#message-object-message-types</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-NP27dvZ4wooRONxkwWecGvMxnuf">content</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-J3bRduJjroX2OOxzooicfmTrnTg">string</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-K9pidS2duoDWPJxi6HpcOuJwnSf">消息内容</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Q9IWdEyd0ojLlBxSohjcNlhdn5d">消息内容</div>
</td>
</tr>
<tr>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-E0TsdkjmKo5WXRxYLj9cSAuMnCe">components</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Br6cdtKdtoeHcrxlRpKcCIgnnCf">消息组件实体数组</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-Wh6fd9njGooNUkxDDfJc5IKyn0g">组件</div>
</td>
<td rowspan="1" colspan="1">
<div class="ace-line ace-line old-record-id-MeVbdqRdooIXPTxODacchTUZnfh">消息内嵌入的既定组件。下面会想说</div>
</td>
</tr>
</tbody>
</table>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Tc5hdiPwRoOyP0x9KGVcwsrRnPf" data-list="bullet">其中components代表的是消息的定义扩展（消息组件），如消息卡片、选择按钮等都是基于此实现。其余字段均为关键业务字段。</li>
<li class="ace-line ace-line old-record-id-CmpDdGDdSoLDdZxJboBcjtU9noW" data-list="bullet">此处只摘取了关键字段，次要未进行摘取。如有兴趣可祥看：https://discord.com/developers/docs/resources/channel#message-object</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-RErmdkEXIodZf9xoST9cLvlanPg">消息组件</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-OkQVdgzWNo0219xPrHXcuksZnRc" data-list="bullet">
<div>消息组件主要由组件类型与嵌入组件两个属性，具体的组件内容不同组件类型均不一样。</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-NF8vdvNCPoWm9txLjawc213pnyb" data-list="bullet">组件可以嵌入组件。如多选下拉菜单</li>
</ul>
</li>
</ul>
<div class="ace-line ace-line old-record-id-UymEdKqNWovqZzx4EIucorTpnAb"><strong>eg：</strong></div>
<pre class="ace-line ace-line old-record-id-FxFvdKplWo2xmFxQ77OcO7yEnnf"></pre>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">{
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">content</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">This is a message with components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: [
        {
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">type</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">,
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: []
        }
    ]
}</span></pre>
</div>
<pre class="ace-line ace-line old-record-id-FxFvdKplWo2xmFxQ77OcO7yEnnf"></pre>
<p>&nbsp;</p>
<pre class="ace-line ace-line old-record-id-FxFvdKplWo2xmFxQ77OcO7yEnnf"><span style="font-family: monospace">&nbsp;</span></pre>
<h6 class="heading-6 ace-line old-record-id-E2e4dyPdEoQ71fxPb17c39Lcnnc"><strong>目前支持的组件类型</strong></h6>
<div class="image-uploaded gallery old-record-id-CzexdBgiMo9H12xJAOBcjLFHnwc" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;8f65465e-5ce3-4d10-b6a8-8e93cd0d94fc&quot;,&quot;height&quot;:397,&quot;width&quot;:1390,&quot;currHeight&quot;:397,&quot;currWidth&quot;:1390,&quot;natrualHeight&quot;:397,&quot;natrualWidth&quot;:1390,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FToANbzrTfo48i8xHfy3c93q7ntd%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;ToANbzrTfo48i8xHfy3c93q7ntd&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:54242,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164159581-960683548.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-GZFNdFdAKotv6exN9ZVcfZZUnxc" data-list="bullet">下面会对主要组件类型进行单一分析，因为其components字段是个数组所以实际应用场景可进行组装</li>
<li class="ace-line ace-line old-record-id-SFLMdt7SyoevRcxo6mec6x1nnCc" data-list="bullet">下文会对主要类型进行分析，其他组件可祥见：https://discord.com/developers/docs/interactions/message-components</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-Miqmdv90toK4b4xXKtscw7Fonhf">组件交互</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-HOJ3dzI2Ioqqa9xzjEccPcyNnZe" data-list="bullet">组件分为交互与非交互组件</li>
<li class="ace-line ace-line old-record-id-BK5vdCvFqoJEcYxCWHJcrd2XnSc" data-list="bullet">
<div>其中交互组件会与开发者服务进行交互，交互形式有两种方式可选</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-JY6id0n7toGQPVxzA3XcE1iUn4d" data-list="bullet">上面提到的gateway进行监听与回复</li>
<li class="ace-line ace-line old-record-id-GrPAdrBWDojYpNx7xuscnzljnTh" data-list="bullet">上面提到的open api中的webhook进行接收与返回</li>
</ul>
</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-NaxTd1PWIowFaYxcxHdcLvk7n3f">Action Row （嵌入组件）</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Q3LRdnQaJoJwdNxRUlscth3cnvb" data-list="bullet">
<div>是其他类型组件的非action row组件的容器。</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-CDhJdVAflo57h0xz9XbcvOnnnKb" data-list="bullet">每条消息最多可以有 5 个Action Row</li>
<li class="ace-line ace-line old-record-id-G8f6dmhD3o3O3ax1K0ccf9oFnJe" data-list="bullet">一个Action Row不能包含另一个Action Row</li>
</ul>
</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-P3bLd9Laco9ZZUxWFIJca6u9nNb">Button （按钮组件）</h6>
<div class="ace-line ace-line old-record-id-UTYfdGWUToopDZxX0JRcVuKKnNd"><strong>组件协议</strong></div>
<div class="image-uploaded gallery old-record-id-Jv7qdzLdroMs7ExUC8DcR0wZnGc" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;9310b288-d9d6-40b6-ab54-f284e31d954f&quot;,&quot;height&quot;:341,&quot;width&quot;:1387,&quot;currHeight&quot;:341,&quot;currWidth&quot;:1387,&quot;natrualHeight&quot;:341,&quot;natrualWidth&quot;:1387,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FI6t5biY0YoZlYixb2iTcucgJnhf%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;I6t5biY0YoZlYixb2iTcucgJnhf&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:51542,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164207817-329787927.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-C0MrdSgJ2oedKfx8Se8cAbs1neI"><strong>说明</strong></div>
<div class="ace-line ace-line old-record-id-EmZ4dqD21ojguOxFxMWcFktmnZd">按钮有多种样式来传达不同类型的操作。这些样式还定义哪些字段对按钮有效。</div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Yqs6d2Ocnoar4TxzoA4cjyXBnZb" data-list="bullet">非链接按钮<strong>必须</strong>有<code>custom_id</code>，并且不能有<code>url</code></li>
<li class="ace-line ace-line old-record-id-QRhPdvs79oCQ2rxkxWacqNcenkd" data-list="bullet">链接按钮<strong>必须</strong>有<code>url</code>，并且不能有<code>custom_id</code></li>
<li class="ace-line ace-line old-record-id-QqkKdcsqUosTW1xclqAc0J6cnSa" data-list="bullet">链接按钮在点击时不会向开发者的服务发起交互，仅会做链接跳转</li>
</ul>
<div class="ace-line ace-line old-record-id-A3JUdCni3oj11SxyBaccpTZSnvd"><strong>按钮可选样式</strong></div>
<div class="image-uploaded gallery old-record-id-Fl64dAqWAotDxuxDc8Ycp08dnHt" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;a3142dae-6883-4324-bc41-0ce370c0a1d0&quot;,&quot;height&quot;:223,&quot;width&quot;:1430,&quot;currHeight&quot;:223,&quot;currWidth&quot;:1430,&quot;natrualHeight&quot;:223,&quot;natrualWidth&quot;:1430,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FNtt7b6MMloIMx8xStsOc7IV6nEd%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;Ntt7b6MMloIMx8xStsOc7IV6nEd&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:31411,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164212983-1003426295.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-KQ00dOyVro7U3fxDDi8cl9Upnif"><strong>eg</strong></div>
<pre class="ace-line ace-line old-record-id-NC85dZuyroGk07xKc4Nc4S47nlh"></pre>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">{
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">content</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">This is a message with components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: [
        {
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">type</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">,
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: [
                {
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">type</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">label</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Click me!</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">style</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">custom_id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">click_one</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
                }
            ]

        }
    ]
}</span></pre>
</div>
<pre class="ace-line ace-line old-record-id-NC85dZuyroGk07xKc4Nc4S47nlh"></pre>
<p>&nbsp;</p>
<pre class="ace-line ace-line old-record-id-NC85dZuyroGk07xKc4Nc4S47nlh"><span style="font-family: monospace">&nbsp;</span></pre>
<h6 class="heading-6 ace-line old-record-id-TjaddB8SaoRgXixG1wncuhQGnBh">Select Menus（多选下拉菜单）</h6>
<div class="ace-line ace-line old-record-id-AuaUddzCXo7RbexFZ3McuhA5nSh"><strong>组件协议</strong></div>
<div class="image-uploaded gallery old-record-id-ZTlydx0NLoVIBwxlX0Tco4LCnZf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;f16f716c-8aec-414a-ae0f-f47a1c3397e6&quot;,&quot;height&quot;:447,&quot;width&quot;:1416,&quot;currHeight&quot;:447,&quot;currWidth&quot;:1416,&quot;natrualHeight&quot;:447,&quot;natrualWidth&quot;:1416,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FPeBzbtHdeourD0xalrActJNgnyf%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;PeBzbtHdeourD0xalrActJNgnyf&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:104017,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164220842-1694051420.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-RaqMdl5hMoCOuhxxGUjct1n5nNg"><strong>说明</strong></div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-H43Nd7I1NoUfMqxHgy8c3WRqnre" data-list="bullet">比较关键的就是options该属性是多选下拉菜单的关键参数，该参数定义了每个选项的具体内容</li>
</ul>
<div class="ace-line ace-line old-record-id-DAg5dzqOioj5jzxkPe3cyyUGnr5"><strong>option结构</strong></div>
<div class="image-uploaded gallery old-record-id-TJpndM5ZnoA7AvxpxNUcqZXZnke" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;aaaaac21-d5f3-4591-adb7-f80941b9f1a6&quot;,&quot;height&quot;:258,&quot;width&quot;:1431,&quot;currHeight&quot;:258,&quot;currWidth&quot;:1431,&quot;natrualHeight&quot;:258,&quot;natrualWidth&quot;:1431,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FWNcUbTNnNoSTBvxTQlMcv1MMnlb%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;WNcUbTNnNoSTBvxTQlMcv1MMnlb&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:47815,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164227063-342226983.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-QIxVdadZXocjg6x5q0mcGhRan4g"><strong>eg：</strong></div>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> This is a message</span>
<span style="color: rgba(0, 0, 0, 1)">{
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">content</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Mason is looking for new arena partners. What classes do you play?</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: [
        {
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">type</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">,
            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">components</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: [
                {
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">type</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">3</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">custom_id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">class_select_1</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">options</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:[
                        {
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">label</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Rogue</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">value</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rogue</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">description</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Sneak n stab</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">emoji</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: {
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">name</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rogue</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">625891304148303894</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
                            }
                        },
                        {
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">label</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Mage</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">value</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">mage</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">description</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Turn 'em into a sheep</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">emoji</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: {
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">name</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">mage</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">625891304081063986</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
                            }
                        },
                        {
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">label</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Priest</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">value</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">priest</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">description</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">You get heals when I'm done doing damage</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                            </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">emoji</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: {
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">name</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">priest</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">625891303795982337</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
                            }
                        }
                    ],
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">placeholder</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Choose a class</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">min_values</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">,
                    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">max_values</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 128, 1)">3</span><span style="color: rgba(0, 0, 0, 1)">
                }
            ]
        }
    ]
}</span></pre>
</div>
<p>&nbsp;</p>
<pre class="ace-line ace-line old-record-id-V2IDdNRMnoSGrBxXKMOcC9vinMv"><span style="font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px">&nbsp;</span></pre>
<h4 class="heading-4 ace-line old-record-id-RNu8d7ksXoCHrOxjS2kc1w6FnKd">6.4.1.2、 消息扇出流程</h4>
<h5 class="heading-5 ace-line old-record-id-COqLdl3eHojYCaxQ6wycwAhVnzh">整体架构</h5>
<div class="image-uploaded gallery old-record-id-TRasdMayVoNW0yxm96lcQzvMnjb" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;f645d9f1-6f60-46d7-95f3-1fd7b1763f6c&quot;,&quot;height&quot;:2256,&quot;width&quot;:3936,&quot;currHeight&quot;:2256,&quot;currWidth&quot;:3936,&quot;natrualHeight&quot;:2256,&quot;natrualWidth&quot;:3936,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FCCnIbU2CfoZdoIxwjmtc0i7WnMf%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;CCnIbU2CfoZdoIxwjmtc0i7WnMf&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:227126,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164234584-134778983.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h5 class="heading-5 ace-line old-record-id-Eq7Ld6u7boa87FxPyL1cqIGDnmL">说明</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-MQwvd4MXyoEvQsxXSJRcMILyny0" data-list="bullet">一条消息从发出到扇出的流程是：api服务将消息发送到工会服务（有状态节点，与公会进行绑定），工会服务将消息均匀发到中继节点。中继节点将消息发送给session网关。最终推送到用户手机</li>
<li class="ace-line ace-line old-record-id-Y7bPdINgoobigGx8NB9cQbSvnGe" data-list="bullet">其中公会服务负责消息权限等基础功能校验（也就是校验该消息是否允许被发出）</li>
<li class="ace-line ace-line old-record-id-SCBNd3BNjohSBbxeygFcrxUznMP" data-list="bullet">公会服务校验完毕，将消息均匀分布到中继节点，由特定中继节点来处理具体的扇出流程</li>
<li class="ace-line ace-line old-record-id-BRfsdPeDqo9jRTx2SbWcGPXOnkf" data-list="bullet">其中扇出目标用户仅为在线用户，所以在用户登录后，discord相关服务会更新相关用户所有服务器的在线列表，此时中继服务仅需对在线成员进行扇出即可</li>
<li class="ace-line ace-line old-record-id-CTntdpO6Dohy3fx33jGcjxBonSd" data-list="bullet">中继节点获取到在线成员后，会校验该用户是否有权限进行接收，最终对可接受用户将消息发送给session网关。最终推送到用户手机</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-O9a1dOsvmoXkblx3Qgqc63KKnoe"><strong>ETS（项式存储）</strong></h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-ZWNrdZn7JoLge6xjl18cK7tDnNd" data-list="bullet">因为部分公会在线成员可能较多，远程获取也会有较大的损耗，discord在初期会在中继服务中缓存每个相关公会的成员信息，但这是恐怖的，在发展后期，达到了百万计的成员。机器内存成本极高，discord开发团队对该部分进行了优化</li>
<li class="ace-line ace-line old-record-id-EXd3dYHxDoYs2pxMY0hcafuInHg" data-list="bullet">其中主要是将中继服务内缓存的公会成员信息优化打到erlang 的ETS中进行存储缓存（Erlang虚拟机级别共享内存）</li>
<li class="ace-line ace-line old-record-id-Q8asdwomeoIQXexGo3kcViTunwh" data-list="bullet">并启动worker进行对ETS 中的数据进行统一管理（inserts, updates, deletes）</li>
</ul>
<div class=" old-record-id-BCRGdfD4NoU7NSxRISHcp0Jgnmf" data-type="whiteboard">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108142140808-1730162464.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<span class="block-paste-placeholder">&nbsp;</span></div>
<h3 class="heading-3 ace-line old-record-id-RB6PdEwnFoYGUNxFrYFcKNnEn2c">6.4.2、推送模块（genstage）</h3>
<h5 class="heading-5 ace-line old-record-id-XdxBdsOA7oOPd2xYNcOcJbIxnlz">背景</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Hmrqd31bAo61udxfL8wcXfrLnre" data-list="bullet">discord为应对突发通知过载问题，设计了genstage模块用于消息推送</li>
<li class="ace-line ace-line old-record-id-VXaxdX3ozohxpIxt8AJcds8enkm" data-list="bullet">
<div>当时主要瓶颈在于向谷歌的 Firebase 云消息服务发送推送通知。</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-ZxbGdTJsSoaFGxxqMxZcD3zCnph" data-list="bullet">Firebase 要求每个 XMPP 连接每次待处理的请求不得超过 100 个。如果有 100 个请求正在处理中，就必须等 Firebase 确认一个请求后再发送另一个请求。</li>
<li class="ace-line ace-line old-record-id-NRjRdLwf4oAEwrxSyztcwxtgnRc" data-list="bullet">由于一次只能有 100 个请求待处理，因此需要设计新系统，使 XMPP 连接在突发情况下不会过载。</li>
</ul>
</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-DXlcdZvOFovPggxvDjKcpJncnR7">整体架构</h5>
<div class="image-uploaded gallery old-record-id-Q0Ygdd7lGoTKuXxgFJfc0HLKnVf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;e69fe6b8-1234-47b2-99d6-c030d842d3e6&quot;,&quot;height&quot;:416,&quot;width&quot;:800,&quot;currHeight&quot;:416,&quot;currWidth&quot;:800,&quot;natrualHeight&quot;:416,&quot;natrualWidth&quot;:800,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FOrBsbqhlloZJPyxMY0UcmEFunJg%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;OrBsbqhlloZJPyxMY0UcmEFunJg&quot;,&quot;image_type&quot;:&quot;image/gif&quot;,&quot;size&quot;:1338820,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164309609-1764982949.gif" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
<h5 class="heading-5 ace-line old-record-id-U9vvdpj9LomvAjxWrW7cHpmmnaf">说明</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-YIrodLGfmo9idFxOflxcWH8MnYd" data-list="bullet">
<div>将系统分为两个 GenStage 阶段。一个source，一个sink</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-GV6Pd2zdEoABloxRtE2cK3jUnUb" data-list="bullet">
<div>阶段1 - source（推送收集器）</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-EGQod2wJRouDBwx2m9lckYMYnvh" data-list="bullet">是收集推送请求的生产者。每台机器都会有一个推送收集器 Erlang 进程。</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-B0FjdcTmaoxDO0xjigIcItyAnMd" data-list="bullet">
<div>阶段2 - sink（推送者）</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-IgCcdH8OOoxFIZxuT7ycNUPBnlf" data-list="bullet">是一个消费者，它从推送收集器获取推送请求，并将请求推送到 Firebase。它一次只需要 100 个请求，以确保不会超过 Firebase 的待处理请求限制。每台机器上有多个 Erlang 进程。</li>
</ul>
</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-Fb29dAGSUo6bXrxmrUMcyMPinTd" data-list="bullet">
<div>GenStage 还有有两个关键功能可在突发情况下提供帮助：背压与甩负荷。</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-L7aSduV6yoW2jkxBWeUcEdEgnCe" data-list="bullet">
<div>背压：</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-CKXsdPSwiohUGUxIyk2cDEkinrd" data-list="bullet">source会询问sink所能处理的最大请求数。这就确保了sink待处理的推送请求数量的上限。当 Firebase 确认请求时，sink会向source提出更多请求（sink知道 Firebase XMPP 连接所能处理的确切数量）。</li>
<li class="ace-line ace-line old-record-id-GI3LdHQ1ZooME8xtIafcVCtpnFf" data-list="bullet">除非sink提出请求，否则source绝不会向sink发送请求。这就保证了sink永远都是无压力的</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-GoeVd7UZsofwj2xHgtKcVmVXnfe" data-list="bullet">
<div>甩负荷：</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-SLSzdjGPCoxDu0xSSp4cg9einWg" data-list="bullet">由于 sink会对source产生反向压力，source就会有一个潜在的瓶颈。超大规模的突发可能会使source超载。</li>
<li class="ace-line ace-line old-record-id-HTn1dPJZHods6sxaHkvchO3dnPn" data-list="bullet">
<div>所以source 还会有一个内置功能可以处理这个问题：<span style="text-decoration: underline"><strong>缓冲事件</strong></span>。</div>
<ul class="list-bullet4">
<li class="ace-line ace-line old-record-id-PZpcdS41WoeRMaxvvdocF4p6nYb" data-list="bullet">在source中，可以指定缓冲多少个推送请求。一般情况下，缓冲区是空的，但在突发通知的情况下，缓冲区就会派上用场。用于缓冲sink无法处理的事件</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-FPqtdzm4dovUjjx6fHxcF99JnTh" data-list="bullet">
<div>如果系统中的消息太多，也就是缓冲区达到瓶颈，source就会停止接收推送请求<span style="text-decoration: underline"><strong>（丢弃或降级）</strong></span></div>
<ul class="list-bullet4">
<li class="ace-line ace-line old-record-id-Y0l2djdAQojSv8xXYYWcXFWnnUb" data-list="bullet">思考：此处可以基于业务策略进行降级，如部分不重要推送进行直接丢弃，重要推送进行降级缓冲</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-LoPIdjPLfoJtqRxF6cIc4SqWnIh">效果指标</h5>
<div class="ace-line ace-line old-record-id-YpXrdiZcXoMqSfxaZ91cJewEnwd"><strong>Sink推送数量/分钟</strong></div>
<div class="image-uploaded gallery old-record-id-XYead0aZRoNKHmxCiDAcvnLgnAb" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;574c198b-8d26-47db-9943-32c97212434e&quot;,&quot;height&quot;:360,&quot;width&quot;:800,&quot;currHeight&quot;:360,&quot;currWidth&quot;:800,&quot;natrualHeight&quot;:360,&quot;natrualWidth&quot;:800,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FW0f1bJSX1oadh0x2bhzcRCjynDH%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;W0f1bJSX1oadh0x2bhzcRCjynDH&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:37867,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164319202-1857583213.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-PflUdPnB6oW3uvx05d2c3WT6nfb"><strong>Source 缓冲事件数量/分钟</strong></div>
<div class="image-uploaded gallery old-record-id-P8uxdrRLqoFuFOxR8z6crpJWnrP" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;9d6b9335-6207-4eec-a635-3e018ef76931&quot;,&quot;height&quot;:360,&quot;width&quot;:800,&quot;currHeight&quot;:360,&quot;currWidth&quot;:800,&quot;natrualHeight&quot;:360,&quot;natrualWidth&quot;:800,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FU6zhbxmTpooqaMx7GV3ccAMbnXc%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;U6zhbxmTpooqaMx7GV3ccAMbnXc&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:46912,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164325617-1158941089.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h2 class="heading-2 ace-line old-record-id-RsMFdDKOIotl60xCBvrcoqBCnyc">6.5、核心基础组件与基础建设</h2>
<h3 class="heading-3 ace-line old-record-id-Hz7XdcOYyoRiLPx5giNcaWDFnnh">6.5.1、存储演进过程与 服务架构流程</h3>
<h4 class="heading-4 ace-line old-record-id-P8XedT56uoMC8mxYx8GczJxJn2c">6.5.1.1、 存储db演进过程</h4>
<div class=" old-record-id-O8aSdgrxVowDRvxX46JceAvDneg" data-type="whiteboard">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108142057811-1481076084.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h5 class="heading-5 ace-line old-record-id-B4UMdXQq2oayxsxqDQTc1AeKnnb">早期：mongo单分片</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Adi5dvi2DoXBLCxY8a7cc3E9nCb" data-list="bullet">单副本集的 MongoDB，没有使用 MongoDB 的分片，他们给出的理由是当时 MongoDB 分片很难用，而且不够稳定（这里就不去深究了）。消息数到达一亿条时，RAM 里已经存不下这么多数据和索引，MongoDB 的延时开始变得不可控。</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-Yk5VdJEhGoOmuKxIoPjcnQrnnve">中期：<strong>从 MongoDB 到 Cassandra</strong></h5>
<h6 class="heading-6 ace-line old-record-id-CKPydKrLIoqEamxN1tgcaM90nih">业务背景</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-GuNrdGF7iogRb9xmgxycTaZlnld" data-list="bullet">2017年，消息数过亿，mongo延时变得不可控。</li>
<li class="ace-line ace-line old-record-id-HhXNdqbQUoMtgYxqJcLcFCVWnBc" data-list="bullet">场景读取极其随机，读写比例整体大约为 50/50。不同业务场景群读取比例不同。但又不想对每个场景做独立解决方案，所以他们决定基于现有诉求，选择新的存储进行数据迁移</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-Wh5zd1009owduExtyyEcBidInCb">诉求</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-QXDxd6tHmoOecoxuea2cWUOnnsb" data-list="bullet">线性可扩展性： 不希望以后重新考虑解决方案或手动重新分拣数据。</li>
<li class="ace-line ace-line old-record-id-DDAgd2g4Ao2jNixL2t6ccQ35n5c" data-list="bullet">自动故障转移： 尽可能的进行自我修复</li>
<li class="ace-line ace-line old-record-id-MdLWds0xCohcSwxDElHcTsvMnsh" data-list="bullet">维护成本低： 一旦设置好，它就能正常工作。只需在数据增长时添加更多节点即可。</li>
<li class="ace-line ace-line old-record-id-CDGudGe6AoOhD7xCZcRcHyArnvc" data-list="bullet">经证明有效： 喜欢尝试新技术，但不能太新。</li>
<li class="ace-line ace-line old-record-id-KvbGdi4QDoNGS8xociwcjT4pnyd" data-list="bullet">可预测的性能： 延时达到一定水位就会发出警报。并且不希望缓存消息。</li>
<li class="ace-line ace-line old-record-id-QcordttaEo5r0ZxNKOAcrmSonlg" data-list="bullet">开源： 相信自己的命运自己掌握，不想依赖第三方公司。</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-ATgaddruGoM9bmxJs7ocQ4Epnhd">实施</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-B4zfdwFQMoPDMBxiHFYcjAaGn0b" data-list="bullet">基于以上诉求他们认为 Cassandra 是当时唯一能满足他们要求的数据库（后面也打脸了）</li>
</ul>
<div class="ace-line ace-line old-record-id-JRVWdSlnDoTufxxxZVccUc43n6f">
<h6 class="heading-6"><strong>Cassandra特性</strong></h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Rq4edtdWmozijmxfwg1cRxyCnEc" data-list="bullet">Ap database</li>
<li class="ace-line ace-line old-record-id-RoXVdUQTooDX07xHiFkcLsEunKb" data-list="bullet">是一个KKV 存储器。主键由两个 K 组成。第一个 K 是分区键，用于确定数据所在的节点以及在磁盘上的位置。分区中包含多条记录，分区内的记录由第二个 K（即聚类键）标识。聚类键既是分区内的主键，也是行的排序方式。你可以把分区看成一个有序的字典。这些属性结合在一起，可以实现非常强大的数据建模。</li>
<li class="ace-line ace-line old-record-id-ZwnrdDRisoTYyKxgPMWcReLendh" data-list="bullet">单分区大小不建议超过 100MB。Cassandra 宣称它可以支持 2GB 分区！但虽然可以支持，但并不意味着应该支持</li>
</ul>
</div>
</div>
<h6 class="heading-6 ace-line old-record-id-LMBJdfmjGoH82ex7jXLcvbYlnhc"><strong>数据建模</strong></h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-XUPxdlq3Noqa47xLyeGcNb03nef" data-list="bullet">关键数据结构</li>
</ul>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">CREATE</span> <span style="color: rgba(0, 0, 255, 1)">TABLE</span><span style="color: rgba(0, 0, 0, 1)"> messages (
  channel_id </span><span style="color: rgba(0, 0, 255, 1)">bigint</span><span style="color: rgba(0, 0, 0, 1)">,
  bucket </span><span style="color: rgba(0, 0, 255, 1)">bigint</span><span style="color: rgba(0, 0, 0, 1)">,
  message_id </span><span style="color: rgba(0, 0, 255, 1)">bigint</span><span style="color: rgba(0, 0, 0, 1)">,
  author_id </span><span style="color: rgba(0, 0, 255, 1)">bigint</span><span style="color: rgba(0, 0, 0, 1)">,
  content </span><span style="color: rgba(0, 0, 255, 1)">text</span><span style="color: rgba(0, 0, 0, 1)">,
  </span><span style="color: rgba(0, 0, 255, 1)">PRIMARY</span> <span style="color: rgba(0, 0, 255, 1)">KEY</span><span style="color: rgba(0, 0, 0, 1)"> ((channel_id, bucket), message_id)
) </span><span style="color: rgba(0, 0, 255, 1)">WITH</span> CLUSTERING <span style="color: rgba(0, 0, 255, 1)">ORDER</span> <span style="color: rgba(0, 0, 255, 1)">BY</span> (message_id <span style="color: rgba(0, 0, 255, 1)">DESC</span>);</pre>
</div>
<p>&nbsp;</p>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-SWyndCchTo0fbfxWeTCcaLQBnHe" data-list="bullet">
<div>基于Cassandra的特性他们将主键设计成（(channel_id, bucket), message_id）</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-WTluddRAIoLmIZxBgmlcYko1nUh" data-list="bullet">channel_id： 服务器频道id</li>
<li class="ace-line ace-line old-record-id-IdoddbuKPov7Orx9Nxxcesjfngc" data-list="bullet">bucket： 基于时间的数据分桶（基于他们的统计，大约10天的聊天消息约100MB）</li>
<li class="ace-line ace-line old-record-id-Nl92dMO84opqN1xUPbwceWyOnnf" data-list="bullet">
<div>message_id： 基于雪花算法的消息id</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-B2gSd51yJopZJ2x2g1Yc23h9nWh" data-list="bullet">这意味着在加载频道时，可以告诉 Cassandra 准确扫描消息的范围</li>
<li class="ace-line ace-line old-record-id-TXZzdxpIeoFFpGx6rHdcOtiznLb" data-list="bullet">消息发布时间与bucket可以通过message_id中提取【因为message_id是基于雪花算法的】</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 class="heading-6 ace-line old-record-id-VSOrdZxkOoM1p8xD05PcrL2DnQc">迁移期间与使用过程中遇到的问题</h6>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-LNcgdrAJOoraSRxLdHfchFU4nhh" data-list="number">
<div>第一个遇到的就是100MB问题</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-NEead3EopoEK9AxopqTcEg4ZnFe" data-list="number">discord最初使用Cassandra存储并没有bucket概念。但在运行与迁移过程中Cassandra发出了100MB警告</li>
<li class="ace-line ace-line old-record-id-DWdSdmEX5oI9wLx5KtlceQ3OnKh" data-list="number">discord开发者通过分析历史消息数据分布情况，定下来100MB可存储其10天消息数据，故将数据进行分桶</li>
</ol></li>
<li class="ace-line ace-line old-record-id-BRuxdq5wOop5SfxyJZBcVnsvnBb" data-list="number">
<div>写入顺序问题，Cassandra的数据写入处理逻辑是先读后写【本次写入会依赖上次写入结果】</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-GtXKd3Hfto9NdNx8AxBc6FnNnhl" data-list="number">
<div>在一个用户编辑一条消息的同时，另一个用户删除了同一条消息，由于 Cassandra 写入的所有内容都是向上插入的，因此最终会发现一条记录中除了主键和文本外，缺少其他所有数据</div>
<ol class="list-number3">
<li class="ace-line ace-line old-record-id-HJvidK0Z9ooTaBxkyo8csbLYn7f" data-list="number">如： 在t1时间，进行了消息删除。t2时间做了消息修改（消息体），此次修改会基于上次删除结果，所以其他字段都为空了</li>
<li class="ace-line ace-line old-record-id-IklvddNcwodFPYx7zAsclkP1nhc" data-list="number">他们采用的方案是启动一个反熵进程对脏数据进行清理与删除（可能是为了无锁化）</li>
</ol></li>
</ol></li>
</ol>
<h6 class="heading-6 ace-line old-record-id-QfwUdUcnAotZIIxcQT7cQiGYnge">迁移后指标情况</h6>
<div class="image-uploaded gallery old-record-id-Xzd1dHuaeoIG4rxQ8JycN3STnbu" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;d2dba4c6-d51c-4453-80a9-67a4f773b42c&quot;,&quot;height&quot;:415,&quot;width&quot;:800,&quot;currHeight&quot;:415,&quot;currWidth&quot;:800,&quot;natrualHeight&quot;:415,&quot;natrualWidth&quot;:800,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FZusdbQEXCouxAHxXYlLcCPshnhc%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;ZusdbQEXCouxAHxXYlLcCPshnhc&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:83675,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164339098-1930026151.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-EnENd20dVoZCiLxxaFFcXD92nzg">&nbsp;</div>
<h5 class="heading-5 ace-line old-record-id-QMDCdVA4ho7R23xChynchYdCnDe">现在：<strong>从 Cassandra 到 ScyllaDB</strong></h5>
<div class="ace-line ace-line old-record-id-JmV5dC5oKoWEK2xV2gJcJGX7nve">
<h6 class="heading-6">业务背景</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-XbigdaPBaotw1UxuuwmcXkefnFn" data-list="bullet">
<div>2022年，随着业务场景和消息规模的增长, Cassandra 有 177 个节点，拥有数万亿条消息 ，Cassandra 也出现了严重的性能问题</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-It9Nd3bClorwY6xXjCPctOFDnVW" data-list="bullet">热分区</li>
<li class="ace-line ace-line old-record-id-XR1XdQl5RoRTYSxHWTAc55qhnQ4" data-list="bullet">压缩问题导致请求级联延迟</li>
<li class="ace-line ace-line old-record-id-DVK5dF7YHo8oqsxVlRCcyPKJnbS" data-list="bullet">S-T-W （java）</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="ace-line ace-line old-record-id-Fq2qdda9RoH2x0xz0bgc1YDynkd">
<h6 class="heading-6">诉求</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-HMitdhlEHouzAPxwRpkczYOUn4e" data-list="bullet">可解决“热分区” 问题</li>
<li class="ace-line ace-line old-record-id-NP3cdj8HZoO3cfxjvwpceBhUnaf" data-list="bullet">数据压缩不会出现级联延迟</li>
<li class="ace-line ace-line old-record-id-NQJpdoxaGoRMntx7zGEcrZWEnCb" data-list="bullet">避免S-T-W</li>
</ul>
</div>
</div>
<div class="ace-line ace-line old-record-id-LO0hdZS0xohGTaxvy3DcxOdpnVf">
<h6 class="heading-6"><strong>ScyllaDB特性</strong></h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Pqd5dKg7qolonRxPm99ceCkmnzc" data-list="bullet">一般来说属于 AP database，更加侧重于可用性和分区容错性，但是 ScyllaDB 的一致性级别是可以调整的。</li>
<li class="ace-line ace-line old-record-id-Ud2KdFwsIoK93Kx9yQzc6AepnKh" data-list="bullet">
<div>完全兼容 Cassandra，号称是Cassandra CPP实现的替代品</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-Tcm3do0AOosUMRxmyzacO30tnSb" data-list="bullet">CPP编写，无GC，所以也就不会出现S-T-W</li>
<li class="ace-line ace-line old-record-id-D32Edl1RGo76zrxjWsBcwmK4nCf" data-list="bullet">
<div>相比Cassandra有更好的性能、更快的修复、通过每核分片架构实现更强的工作负载隔离。</div>
<ul class="list-bullet4">
<li class="ace-line ace-line old-record-id-JOSjdfvXQo7ytQxJzAOcRHQ4nWe" data-list="bullet">-- 避免出现级联延迟</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="ace-line ace-line old-record-id-UMRedPSIyoY9SFxA299ciEhinog">
<h6 class="heading-6">ScyllaDB如何解决的压缩问题？</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-BbETdwR3Vois7hxpIzvccILcn2c" data-list="bullet">Compaction Strategy：ScyllaDB 使用不同的算法（称为策略）来确定何时以及如何最好地运行压缩。该策略决定了写入、读取和空间放大之间的权衡。ScyllaDB Enterprise 甚至支持一种称为增量压缩策略的独特方法，该方法可以显著节省磁盘开销。</li>
</ul>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-CZdBdFHGNo4HNlxxucTc2ngCnJe" data-list="number">压缩和解压缩并行化：ScyllaDB 使用多线程并行化压缩和解压缩操作，以减少压缩和解压缩对整体性能的影响。这样可以更好地利用多核处理器的能力，并减少由于压缩和解压缩而引起的延迟。</li>
<li class="ace-line ace-line old-record-id-NyxOdmmruoP6a0xRFY8cFUVJnSh" data-list="number">压缩字典缓存：ScyllaDB 使用压缩字典缓存来提高压缩和解压缩的性能。字典缓存存储了一些常见的字符串和它们的压缩形式，这样可以减少压缩和解压缩时需要传输的数据量，从而降低延迟。</li>
<li class="ace-line ace-line old-record-id-I9P6dsQeeogxNQxFDHscSzRenDh" data-list="number">硬件加速：ScyllaDB 利用现代硬件特性，如 Intel 的 CPU 压缩指令集（Intel ISA-L），来加速压缩和解压缩操作。这些硬件加速技术可以显著提高压缩和解压缩的性能，从而减少级联延迟。</li>
</ol></div>
</div>
<div class="ace-line ace-line old-record-id-TnN1dhxoAo3QuWxIsEecHZ5znvg">
<h6 class="heading-6">缺点</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-RjhSdv3idoUduIxwTUVcUgTVn6g" data-list="bullet">
<div>当以与表排序相反的顺序扫描数据库时，有反向查询性能不足的问题</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-U18OdNLFBorQCjxo7t1cUC7PnBR" data-list="bullet">discord团队识别该缺点可接受</li>
</ul>
</li>
<li class="ace-line ace-line old-record-id-PPrSdieBhoRvUMxO9G2cc6EYnzf" data-list="bullet">
<div>未解决“热分区” 问题</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-NHkZdUuV0o9HvCx3AALccWCDnkc" data-list="bullet">通过建立“存储服务”进行解决</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="ace-line ace-line old-record-id-YMuWd0LxXoQkFexjoDMcxj4wnte">
<h6 class="heading-6">迁移方案</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-ObZJdBxr7owLTFxvmtmcX3PqnYc" data-list="bullet">因为ScyllaDB完全兼容 Cassandra，所以可以直接进行数据迁移</li>
<li class="ace-line ace-line old-record-id-ZYw8dUsJZo2akpxdvsucK2o2nwb" data-list="bullet">
<div>但因为其未解决“热分区” 问题。所以discord开发者基于ScyllaDB做了业务增强实现来解决该问题</div>
<ul class="list-bullet3">
<li class="ace-line ace-line old-record-id-Ove8dlx1fouPARxMybectY7Qnfb" data-list="bullet">-- “存储服务”</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="ace-line ace-line old-record-id-Lf5NdrWOIo0TeNx6tM1cSUntn9g">
<h6 class="heading-6">迁移效果</h6>
<div>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-X8GqdXa73onKGyxlbpwcZarRnXc" data-list="bullet">将运行 177 个 Cassandra 节点减少到仅运行 72 个 ScyllaDB 节点。每个 ScyllaDB 节点拥有 9TB 磁盘空间，高于每个 Cassandra 节点平均 4TB 的存储空间。1774-729=60T，这么看的话他们的存储空间也节省了一些。在 Cassandra 上获取历史消息的 p99 为 40-125 毫秒，而 ScyllaDB 的延迟为 15 毫秒，消息插入性能从 Cassandra 上的 5-70 毫秒 p99 到 ScyllaDB 上稳定的 5 毫秒 p99。</li>
<li class="ace-line ace-line old-record-id-ZK0YdYDSiojgKuxq3dDcf6snn1e" data-list="bullet">当然此处效果与指标存储服务也功不可没。下面会说存储服务的整体设计</li>
</ul>
</div>
</div>
<h4 class="heading-4 ace-line old-record-id-VfOudH7yfoputFxafwvcsOkhnSb">6.5.1.2、 存储服务架构及流程</h4>
<h5 class="heading-5 ace-line old-record-id-M0jAdTYJ9oVy9nxsIuxc9AoinUs">背景</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-G30Odr4DRoHmU0xPTj6cJzhLnXb" data-list="bullet">discord开发团队为了解决数据查询“热分区”问题，Discord 采用的方案是：在 ScyllaDB 和业务服务之间加了一个中介服务（Rust 语言编写），它不包含任何业务逻辑，主要功能就是合并请求。</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-WwtUdaJtoom9e0xJomlcdT1qnKb">整体架构</h5>
<div class=" old-record-id-CcVYd2P7Uon6NmxGzIpcnx3ynNc" data-type="whiteboard">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108141746035-1293478831.png" alt="" width="1897" height="1266" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h5 class="heading-5 ace-line old-record-id-DtNodwsBxov3dJxpXY3cBAvDnXb">架构说明</h5>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-SdKcdyfnAorOWTxUOWJc2b1rnRh" data-list="bullet">存储服务主要做了两部分功能。合并请求与收敛请求</li>
<li class="ace-line ace-line old-record-id-ZJp7dDwwCoIPs7x71sYcmyomnhb" data-list="bullet">是一个有状态 无数据 的中介服务</li>
</ul>
<h5 class="heading-5 ace-line old-record-id-B0WddKl5loNN1zxUFXIcxzwPnDd">模块设计</h5>
<h6 class="heading-6 ace-line old-record-id-GXDbdZ8lao81U2xCaEXc5sBInWp">合并请求</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-Vdpyd12WsoQeMvxv67ocr1F8nVg" data-list="bullet">如果多个用户同时请求数据库的同一行，那么只会查询数据库一次。</li>
<li class="ace-line ace-line old-record-id-IS1Adw5Yco0Pyzx0tByc2V1snAb" data-list="bullet">第一个发出请求的用户会在该服务中启动工作任务， 后续请求将检查该任务是否存在并订阅它， 该工作任务将查询数据库并将该行返回给所有订阅者。</li>
</ul>
<div class="image-uploaded gallery old-record-id-SNq4dUMhko6UWvxSlHMcm3Minuy" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;cc28345e-7cd9-43e6-b988-4683e8a4c5b0&quot;,&quot;height&quot;:1154,&quot;width&quot;:1806,&quot;currHeight&quot;:1154,&quot;currWidth&quot;:1806,&quot;natrualHeight&quot;:1154,&quot;natrualWidth&quot;:1806,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FNz58b67P8ouU7lxf94hcDKXWnQh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;Nz58b67P8ouU7lxf94hcDKXWnQh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:202972,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164354464-1759648021.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h6 class="heading-6 ace-line old-record-id-IGOCdllQ6o73hgxZs3hcJqSlnnc">收敛请求</h6>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-FOk0dng03oWD8JxJlxwchQgJn4e" data-list="bullet">同时根据一致性 hash 将同类查询请求，比如同一个频道的请求，进一步收敛到中介服务，这样可以让请求合并的效果更好。</li>
</ul>
<div class="image-uploaded gallery old-record-id-QiBWd4NdwoOx2qx2Q4McM615n5e" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;d67ce04e-d30f-4417-b145-7b6a8af5229b&quot;,&quot;height&quot;:1154,&quot;width&quot;:1806,&quot;currHeight&quot;:1154,&quot;currWidth&quot;:1806,&quot;natrualHeight&quot;:1154,&quot;natrualWidth&quot;:1806,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FRh1YbApqfocIOCxhb3McfzBBnih%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;Rh1YbApqfocIOCxhb3McfzBBnih&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:182748,&quot;comments&quot;:[]}]}">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108164400362-34922187.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="ace-line ace-line old-record-id-NUuEdudFUoPoG8xKJhqcBgCyn50">&nbsp;</div>
<h3 class="heading-3 ace-line old-record-id-P4NGdz9dpoZePqxuUsycZlFsnDh">6.5.2、 消息检索架构流程</h3>
<h4 class="heading-4 ace-line old-record-id-MTjrd0g7LohDlpx78ZVc0IlanAX">背景</h4>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-UrEWdHFnlovPPgxtg7lc4L08nsf" data-list="bullet">
<div>因discord业务发展迅速，在2017年要推出消息检索功能。其技术诉求如下</div>
<ul class="list-bullet2">
<li class="ace-line ace-line old-record-id-AVgbdsF6wo187kxz1KccNLtpnfg" data-list="bullet">经济高效：Discord 的核心用户体验是文字和语音聊天。搜索是一项附属功能，搜索的成本不应高于信息的实际存储成本。</li>
<li class="ace-line ace-line old-record-id-VU7ddAhZxoVSFNx4cJ7cJXdOnwg" data-list="bullet">自我修复：需要能够承受故障，只需极少的人为干预，甚至无需人为干预。</li>
<li class="ace-line ace-line old-record-id-FbmjdZoTKoBiiCxVPNUcka0hnvd" data-list="bullet">可线性扩展：就像存储信息一样，只需在数据增长时添加更多节点即可</li>
<li class="ace-line ace-line old-record-id-L7GMdmHAKo2c1sxzVgjcKNAbn8e" data-list="bullet">避免繁琐的大型集群： 在集群中断的情况下，只有受影响集群中包含的 消息无法用于搜索。或者一旦整个集群的数据无法恢复，可以将其丢弃（系统可以重新索引 Discord 服务器数据）。</li>
</ul>
</li>
</ul>
<h4 class="heading-4 ace-line old-record-id-RwYCd6sJaoCoTgxdhpHcLqVXnRh">整体架构</h4>
<ul class="list-bullet1">
<li class="ace-line ace-line old-record-id-BcYWdHAVeoBQX8x5sGKc4yMmnWe" data-list="bullet">基于以上背景，discord团队最终选用es来支持消息检索，但摒弃了es的分片能力（自行实现消息分区），因为使用es的分片能力以当时discord的数据量意味着要建立大型集群，这会带来较高的维护成本与恢复成本</li>
</ul>
<div class=" old-record-id-B2mUdiQNwoyT1KxI6HUcEmx5nAe" data-type="whiteboard">
<p><img src="https://img2024.cnblogs.com/blog/1211814/202501/1211814-20250108141720287-355890526.png" alt="" width="1913" height="1511" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<h4 class="heading-4 ace-line old-record-id-MUHIdJeM9oXIlUxcWOHcnp81nof">说明</h4>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-J6KRd1QmVogy3exiYQdcelbUnFh" data-list="number">
<div>应用层进行分区，分区维度为频道id， es采用多集群方式，不同频道id绑定不同es集群 （小集群）</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-ErWvdk70wosNdPxf9YjcbBiPnNh" data-list="number">这样特定频道数据就会被分到单一的es集群</li>
<li class="ace-line ace-line old-record-id-Y5jkdpwr7o6iFHx3kDkcrzH2nxh" data-list="number">es中采用无分片单副本的索引模式（因使用了应用分区，所以不需要es的分区功能了，副本是用于集群异常数据恢复使用）</li>
</ol></li>
<li class="ace-line ace-line old-record-id-YswwdtLdFoGycXxsX3eccaKSnZc" data-list="number">启动his index worker 来用于历史消息的索引与重新索引（如es集群产生故障，旧集群被摘除使用新的集群需要重新索引消息）</li>
<li class="ace-line ace-line old-record-id-ALyvdFPzhoskfMxLcf6cicUbn7e" data-list="number">
<div>业务 服务只负责向queue里发送消息信息，由index worker进行拉取并索引进es中</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-VPhadCJ6hot0c5xpPoXcQjpMnfh" data-list="number">能力解偶、提升主流程性能、消峰</li>
<li class="ace-line ace-line old-record-id-Wggod4EoQoXqifxGXU6ccAUCn0d" data-list="number">因检索场景大多数都是对历史消息进行检索，所以queue延迟与es的近实时特性是可接受的</li>
</ol></li>
<li class="ace-line ace-line old-record-id-WDCJd6hE7oHiAtxP4BBcvUiXnTc" data-list="number">es集群注册到etcd中来实现自动发现，然后会在redis中存储每个集群的负载情况，检索sdk会使用负载最低的进群进行实时绑定</li>
<li class="ace-line ace-line old-record-id-V2NqdoFOVo35RsxaCTMcVxqGnFb" data-list="number">
<div>绑定数据使用业务db进行关系存储并使用redis进行缓存</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-E9QJdSMzbox3tixCtIbczXfHnx6" data-list="number">因为其使用的业务db无论是cassandra还是scylladb都存在高成本读取，所以此处做了缓存 （与其前面说的不想使用缓存有出入）</li>
</ol></li>
<li class="ace-line ace-line old-record-id-YEmIdVN5HorcHixMFBFch55Dn8c" data-list="number">下次产生新的消息时，直接使用既定的绑定关系进行存储即可</li>
</ol>
<h1 class="heading-1 ace-line old-record-id-T4vzdDDoBoZ0mexP4YicHhCln8G">七、结论</h1>
<div class="ace-line ace-line old-record-id-IGxgdFIHuoPmLNxyDOxcTV5vnUc"><strong>通过上述对discord的调研分析，</strong><strong>获得的一些启发：</strong></div>
<h4 class="heading-4 ace-line old-record-id-Qi6SdwneBoouHnxay6IcgTfXnoe">功能上</h4>
<div class="ace-line ace-line old-record-id-UtZVd0iRiosxgvxYyTvcqxclnTf">discord 对开发者提供了丰富的集成方式：机器人、api、网关、client RPC（亮点）、GameSDK。</div>
<h4 class="heading-4 ace-line old-record-id-Ntk9dhWxeoQSd0xNKx0ckcYqnrh">设计上</h4>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-UsFUdX5ozoDibJxDLFjcKslCnO1" data-list="number">
<div>discord 使用了不同的技术栈来解决技术上的诉求，思路非常开阔</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-BxA0dxRXpobu5UxoSKFcuEGFnSd" data-list="number">使用erlang开发，因其天生的actor模型，故可以完美支持其响应式架构达到高吞吐目的</li>
<li class="ace-line ace-line old-record-id-XgaodovN8o58GTxL8U9cHVT1nug" data-list="number">但erlang对于某些特定场景存在性能问题，又使用rust来解决。在不变业务服务的情况通过NIF 的形式进行调用（业务无感）</li>
<li class="ace-line ace-line old-record-id-AQIVdssyioopWwxQrRDc0Bfjn1e" data-list="number">api入口使用python可以达到快速迭代，因为内部服务使用golang、rust、erlang又不会产生较大的性能问题</li>
</ol></li>
<li class="ace-line ace-line old-record-id-EaHqdJ1Vco8w0LxILP5c4SDDnlb" data-list="number">
<div>单一且高负载业务，可通过进程分离的形式进行优化。各司其职，压力分摊</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-Lo60dHMSYoueuExfhstc1JZ0nbg" data-list="number">消息扇出流程：发送与扇出分离</li>
<li class="ace-line ace-line old-record-id-JlBpdtaZjoyaRexUSu8czF9Inue" data-list="number">推送模块： 接收与推送分离</li>
</ol></li>
<li class="ace-line ace-line old-record-id-Y2s1dnr1LolbWIxdWH5cAXoJnWh" data-list="number">用户上线时把用户加入公会和在线状态进行绑定，维护了公会内的在线用户，消息扇出时极大的减少了消息处理量</li>
<li class="ace-line ace-line old-record-id-Ky7ed6FPwoCCRax641Jc5NSrnOc" data-list="number">
<div>拥抱开源，在开源基础上针对业务的诉求进行优化或增强</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-KxMkdMrRKo27Cxxsc14cRRosnsf" data-list="number">存储服务解决的热分区问题。不仅大大缓解了db压力，还降低了架构与业务开发复杂度 （无缓存设计）</li>
<li class="ace-line ace-line old-record-id-M0R4dLZHuoVSt0x9B1fc3nzBnId" data-list="number">消息检索业务，discord为了避免繁琐的大型集群实现了自己的分片/分区模式</li>
</ol></li>
<li class="ace-line ace-line old-record-id-OMcydezMYoqlFhxHQzrc3bgPnXb" data-list="number">随时保持基建可替换，降低随着业务迭代与数据发展带来的基建升级/演进 成本（架构一定是随时演进的 ）</li>
<li class="ace-line ace-line old-record-id-BGgUd5FlloPPI8xsr23c7jldnPe" data-list="number">
<div>基础架构与组件可作为未来参考</div>
<ol class="list-number2">
<li class="ace-line ace-line old-record-id-OHmWdSVbso9aI5xpj4fcKJ0Yntf" data-list="number">响应式架构来提升单机吞吐量</li>
<li class="ace-line ace-line old-record-id-HPx2djIJuofWtTx2GKdcFH1dnaf" data-list="number">
<div>db压力过载可通过合并请求&amp;收敛请求的方式进行优化，来缓解db压力</div>
<ol class="list-number3">
<li class="ace-line ace-line old-record-id-ARgldDXzeoYV0Mx4O0ncr1nunwh" data-list="number">不一定非要用于存储，比如我们客户端的一些非重要请求也可以作此优化来降低带宽使用与缓解服务器压力</li>
</ol></li>
</ol></li>
</ol>
<div class="ace-line ace-line old-record-id-X8Btd7Hi7oFzfwxiDjccNJVQnue">&nbsp;</div>
</div>
</div>
<div id="MySignature" role="contentinfo">
    <p>本文来自博客园，作者：<a href="https://www.cnblogs.com/lsy131479/" target="_blank">房上的猫</a>，转载请注明原文链接：<a href="https://www.cnblogs.com/lsy131479/p/18659629" target="_blank">https://www.cnblogs.com/lsy131479/p/18659629</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.15522175563541668" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-08 16:44">2025-01-08 14:42</span>&nbsp;
<a href="https://www.cnblogs.com/lsy131479">房上的猫</a>&nbsp;
阅读(<span id="post_view_count">99</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18659629" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18659629);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18659629', targetLink: 'https://www.cnblogs.com/lsy131479/p/18659629', title: 'Discord技术架构调研（IM即时通讯技术架构分析）' })">举报</a>
</div>
        