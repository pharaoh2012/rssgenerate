
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ACaiGarden/p/18903988" title="发布于 2025-05-30 11:25">
    <span role="heading" aria-level="2">20250528 - Usual 攻击事件: 价差兑换与请君入瓮</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="背景信息">背景信息</h1>
<h2 id="项目背景"><strong>项目背景</strong></h2>
<p>VaultRouter 合约有用<strong>特权身份</strong>，可以通过 Usd0PP 合约将 USD0++ 以 1:1 的比例兑换成 USD0，随后通过 UniV3 将 USD0 swap 成 sUSDS，并 deposit 成 usUSDS 发送给用户。</p>
<h2 id="攻击概述"><strong>攻击概述</strong></h2>
<p>在本次 Usual 攻击事件中，攻击者首先创建了<strong>恶意的 [USD0, sUSDS] 池子</strong>，然后利用 VaultRouter 合约的<strong>特权身份</strong>，将 1899838 USD0++ 以 1:1 的比例兑换成 USD0，并且在恶意池子中将  USD0 兑换为 sUSDS。随后攻击者通过移除流动性的方式获取所有的 USD0。最后通过 <strong>USD0USD0++ 市场</strong>将 1899838 USD0 兑换成 1943686 USD0++，兑换比例为 1 : 1.02，获利 43847 USD0++。</p>
<h2 id="漏洞成因"><strong>漏洞成因</strong></h2>
<ol>
<li>VaultRouter 合约可以将 USD0++ 以 1:1 的比例兑换成 USD0，与市场价 1 : 1.02 存在价差。</li>
<li>VaultRouter 和 Augustus 合约均没有对传入的 swapData 进行检查，使得攻击者可以操控 USD0 swap sUSDS 这一步骤在全部流动性均为自己添加的、且价格失衡的恶意池子中进行。</li>
</ol>
<h2 id="相关链接"><strong>相关链接</strong></h2>
<p>Alert：<a href="https://x.com/BlockSecTeam/status/1927607817378177316" target="_blank" rel="noopener nofollow">https://x.com/BlockSecTeam/status/1927607817378177316</a></p>
<p>攻击交易：<a href="https://app.blocksec.com/explorer/tx/eth/0x585d8be6a0b07ca2f94cfa1d7542f1a62b0d3af5fab7823cbcf69fb243f271f8" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0x585d8be6a0b07ca2f94cfa1d7542f1a62b0d3af5fab7823cbcf69fb243f271f8</a></p>
<p>漏洞合约：</p>
<ol>
<li>
<p>VaultRouter：<a href="https://etherscan.io/address/0xe033cb1bb400c0983fa60ce62f8ecdf6a16fce09#code" target="_blank" rel="noopener nofollow">https://etherscan.io/address/0xe033cb1bb400c0983fa60ce62f8ecdf6a16fce09#code</a></p>
</li>
<li>
<ol>
<li></li>
</ol>
<p>VaultRouter：<a href="https://etherscan.io/address/0xe033cb1bb400c0983fa60ce62f8ecdf6a16fce09#code" target="_blank" rel="noopener nofollow">https://etherscan.io/address/0xe033cb1bb400c0983fa60ce62f8ecdf6a16fce09#code</a></p>
</li>
</ol>
<h1 id="trace-分析">Trace 分析</h1>
<h2 id="trace-概览">Trace 概览</h2>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530100135211-1749904946.png" alt="image" loading="lazy"></p>
<ol>
<li>创建恶意的 [USD0, sUSDS] 池子，并向其添加了 10 wei 的 sUSDS</li>
<li>执行闪电贷</li>
<li>将获利资金兑换成 ETH</li>
</ol>
<h2 id="flashloan-分析">FlashLoan 分析</h2>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530100151562-435476034.png" alt="image" loading="lazy"></p>
<p>攻击者在闪电贷内执行了本次攻击，具体做了以下操作：</p>
<ol>
<li>VaultRouter.deposit()</li>
<li>移除 2.1 中创建的池子流动性</li>
<li>USD0USD0++.exchange() USD0 -&gt; USD0++</li>
<li>USD0USD0++.exchange() USD0++ -&gt; USD0</li>
<li>Uniswap V3: Router.exactInput() USD0 -&gt; ETH</li>
<li>归还闪电贷</li>
</ol>
<h3 id="vaultrouterdeposit">VaultRouter.deposit()</h3>
<ol>
<li>首先通过 Usd0PP.unwrapWithCap() 函数将 USD0++ 按照 1:1 的比例换成 USD0</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530111839453-1370247084.png" alt="image" loading="lazy"></p>
<ol start="2">
<li>VaultRouter 在攻击者创建的恶意池子中将 1899838 USD0 兑换成 5wei sUSDS</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530111856059-1796508886.png" alt="image" loading="lazy"></p>
<ol start="3">
<li>将兑换得到的 5wei sUSDS 通过 deposit() 质押成 usUSDS 并发送给攻击合约（不重要）</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530111918726-267015201.png" alt="image" loading="lazy"></p>
<h3 id="移除流动性">移除流动性</h3>
<p>攻击者将 VaultRouter 在 2.2.1 中 swap 进去的 1899838 USD0 通过移除流动性的方式取出</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530111933383-1480827202.png" alt="image" loading="lazy"></p>
<h3 id="exchange-usd0---usd0">exchange USD0 -&gt; USD0++</h3>
<p>攻击者通过 USD0USD0++.exchange() 将 1899838 USD0 兑换成 1943686 USD0++，兑换比例为 1 : 1.02，获利 43847 USD0++</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530111945885-1664554680.png" alt="image" loading="lazy"></p>
<h3 id="exchange-usd0---usd0-1">exchange USD0++ -&gt; USD0</h3>
<p>攻击者随后又将获利部分的 43847 USD0++ 兑换成 42973 USD0</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112207688-147913265.png" alt="image" loading="lazy"></p>
<h3 id="exactinput-usd0---eth">exactInput() USD0 -&gt; ETH</h3>
<p>42973 USD0 兑换成了 15 WETH</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112043446-2092450043.png" alt="image" loading="lazy"></p>
<h3 id="归还闪电贷">归还闪电贷</h3>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112059105-352769382.png" alt="image" loading="lazy"></p>
<h1 id="代码分析">代码分析</h1>
<p>Usd0PP 合约允许 VaultRouter 将 USD0++ 以 1:1 的比例兑换成 USD0</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112237009-1166832257.png" alt="image" loading="lazy"></p>
<p>VaultRouter 没有对 augustus 使用的参数 data 进行检查和限制，这使得攻击者可以传入自己构造的恶意池子（相同币种不同费率），从而在 USD0 -&gt; sUSDS 兑换完成后可以通过移除流动性的方法取回所有 USD0。<br>
<img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112256941-1110830982.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112308755-427095221.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202505/1483609-20250530112324372-1967053321.png" alt="image" loading="lazy"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="1.0381975510706019" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-30 11:25">2025-05-30 11:25</span>&nbsp;
<a href="https://www.cnblogs.com/ACaiGarden">ACai_sec</a>&nbsp;
阅读(<span id="post_view_count">104</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18903988);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18903988', targetLink: 'https://www.cnblogs.com/ACaiGarden/p/18903988', title: '20250528 - Usual 攻击事件: 价差兑换与请君入瓮' })">举报</a>
</div>
        