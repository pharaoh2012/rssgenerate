
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ggtc/p/19052348" title="å‘å¸ƒäº 2025-08-22 11:24">
    <span role="heading" aria-level="2">ä¸ºworkflow-coreæ‰©å±•å¤–æŠ›äº‹ä»¶</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="workflow-coreè‡ªå¸¦äº‹ä»¶çš„å±€é™æ€§">workflow-coreè‡ªå¸¦äº‹ä»¶çš„å±€é™æ€§</h1>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œworkflow-coreåªèƒ½ä»å¤–å‘å†…æŠ›äº‹ä»¶<br>
æ¯”å¦‚åœ¨apiæ¥å£ä¸­å¼•å‘äº‹ä»¶ï¼Œåœ¨å·¥ä½œæµä¸­ç­‰å¾…äº‹ä»¶å®Œæˆ</p>
<pre><code class="language-Csharp">//ç¬¬ä¸€æ­¥ï¼Œå¼€å¯æµç¨‹
public async Task&lt;IActionResult&gt; Add([FromBody] Dto parm)
{
    //å¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œæµ
    //ç”± Workflow-Core è‡ªåŠ¨ç”Ÿæˆï¼ˆé»˜è®¤æ˜¯ GUID æ ¼å¼,å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµå®ä¾‹
    //é€šè¿‡è¯¥IDå¯ä»¥æ§åˆ¶å·¥ä½œæµç”Ÿå‘½å‘¨æœŸ
    var workflowId = await _workflowHost.StartWorkflow("xxxFlow", 1, parm);
    return SUCCESS(1);
}

//ç¬¬äºŒæ­¥ï¼Œå®¡æ‰¹,å¼•å‘äº‹ä»¶
public async Task&lt;IActionResult&gt; Audit([FromBody] Dto parm)
{
    var modal = parm.Adapt&lt;Dto&gt;().ToUpdate(HttpContext);
    //é€šçŸ¥å·¥ä½œæµç»§ç»­æ‰§è¡Œ
    await _workflowHost.PublishEvent(
        "audit",  // å¿…é¡»ä¸WaitForEventçš„äº‹ä»¶åç§°åŒ¹é…
        parm.WorkflowId,  // å¿…é¡»ä¸WaitForEventçš„äº‹ä»¶KeyåŒ¹é…
        parm//æä¾›çš„æ•°æ®
    );
    return SUCCESS(1);
}
</code></pre>
<p>ä½†æ˜¯é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼Œè¦è·å¾—è¿”å›æ•°æ®ã€‚æ¯”å¦‚<code>Add</code>åè¦åˆ·æ–°ç•Œé¢ï¼Œçœ‹åˆ°è¡¨æ ¼ä¸­æ–°æ·»åŠ çš„ä¸€è¡Œè®°å½•ã€‚<br>
ç„¶è€Œç”±äºæˆ‘ä»¬ç¼ºä¹è¿™ç§æ‰‹æ®µæ¥ä»æµç¨‹ä¸­è·å¾—åé¦ˆï¼Œè€Œä¸”æ˜¯ç­‰å¾…å¼<code>await</code>çš„åé¦ˆã€‚æ‰€ä»¥<code>Add</code>å°±ç›´æ¥ä¿„è¿”å›äº†ï¼Œç•Œé¢ä¸Šåˆ·æ–°æ—¶ï¼Œæµç¨‹å¯èƒ½è¿˜æ²¡è·‘åˆ°æ’å…¥æ•°æ®åº“é‚£ä¸€æ­¥ï¼Œäºæ˜¯ç•Œé¢ä¸Šä¹Ÿçœ‹ä¸åˆ°æ–°æ•°æ®ã€‚</p>
<h1 id="äº‹ä»¶æ‰©å±•">äº‹ä»¶æ‰©å±•</h1>
<p>æˆ‘ç ”ç©¶äº†ä¸€å¤©åï¼Œåˆ©ç”¨<code>C#</code>çš„æ‰©å±•æ–¹æ³•è¯­æ³•ï¼Œç»™<code>workflow-core</code>æ‰©å±•äº†å¤–æŠ›äº‹ä»¶ï¼Œè¿™æ ·å¯ä»¥åœ¨æ¥å£ä¸­ç­‰å¾…æµç¨‹ä¸­æŸä¸ªæ­¥éª¤å®Œæˆã€‚</p>
<h2 id="è®¾æƒ³">è®¾æƒ³</h2>
<p>è®¾æƒ³è°ƒç”¨æ–¹æ³•åº”è¯¥è¿™æ ·</p>
<pre><code class="language-Csharp">//ç¬¬ä¸€æ­¥ï¼Œå¼€å¯æµç¨‹
public async Task&lt;IActionResult&gt; Add([FromBody] Dto parm)
{
    //å¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œæµ
    //ç”± Workflow-Core è‡ªåŠ¨ç”Ÿæˆï¼ˆé»˜è®¤æ˜¯ GUID æ ¼å¼,å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµå®ä¾‹
    //é€šè¿‡è¯¥IDå¯ä»¥æ§åˆ¶å·¥ä½œæµç”Ÿå‘½å‘¨æœŸ
    var workflowId = await _workflowHost.StartWorkflow("xxxFlow", 1, parm);
    //ç­‰å¾…ç¬æ—¶äº‹ä»¶ï¼ŒSubmitProblemStepæ­¥éª¤æ‰§è¡Œå®Œæˆ
    var response = await _workflowHost.WaitEvent&lt;Dto&gt;("SubmitStep", workflowId);
    return SUCCESS(response);
}
</code></pre>
<p>è€Œæµç¨‹ä¸­è¿™æ ·å¼•å‘äº‹ä»¶æ¯”è¾ƒä¼˜é›…</p>
<pre><code class="language-csharp">Action&lt;WaitFor, Dto&gt; outputAction = (edata, data) =&gt; {
    (edata.EventData as Dto).Adapt(data);//ä¿è¯å¼•ç”¨å¯¹è±¡dataä¸ä¸¢å¤±çš„æƒ…å†µä¸‹æ›´æ–°å¯¹è±¡data
};
//è¿™æ ·å¼•å‘äº‹ä»¶
builder
    // æäº¤è®°å½•
    .StartWith&lt;SubmitStep&gt;()
        .Input(step=&gt;step.Entity, data=&gt;data)
        .Output((step,data)=&gt; data=step.Entity)//å°†WorkflowIdèµ‹å€¼ç»™æµç¨‹ï¼Œä¾¿äºWaitForç›‘å¬äº‹ä»¶
    //RaiseEventæ‰©å±•çš„å‘å¤–æŠ›äº‹ä»¶ï¼ŒåµŒå…¥åŸæ¥fluentApiä¸­å¼•å‘äº‹ä»¶
    //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¡¨ç¤ºè®°å½•å·²åœ¨SubmitStepä¸­æ’å…¥åˆ°æ•°æ®åº“äº†
    .RaiseEvent("SubmitStep", data=&gt;data.WorkflowId)
    //workflow-coreè‡ªå¸¦çš„å‘å†…æŠ›äº‹ä»¶
    .WaitFor("AuditStep", data =&gt; data.WorkflowId, date =&gt; DateTime.Now)
</code></pre>
<h2 id="å®ç°">å®ç°</h2>
<p>æˆ‘è§‚å¯Ÿäº†å·²æœ‰çš„<code>.Then</code>,<code>.Input</code>è¿™äº›æ–¹æ³•ï¼Œç»ˆäºææ¸…æ¥šå®ç°å“ªä¸ªæ¥å£ï¼Œæ‰©å±•æˆ‘ä»¬çš„æ–¹æ³•ã€‚æŒ‰ç…§è®¾æƒ³ï¼Œéœ€è¦æš´éœ²ä¸¤ä¸ªæ–¹æ³•</p>
<ul>
<li><strong><code>RaiseEvent</code> ç»™å†…éƒ¨æµç¨‹ç”¨</strong></li>
<li><strong><code>WaitEvent</code> ç»™å¤–éƒ¨æ¥å£ç”¨</strong></li>
</ul>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// å·¥ä½œæµä»å†…-&gt;å¤–æŠ›å‡ºäº‹ä»¶æ‰©å±•
/// &lt;/summary&gt;
public static class WorkFlowEventExtensions
{

    /// &lt;summary&gt;
    /// ç¬æ—¶äº‹ä»¶é›†åˆ
    /// &lt;/summary&gt;
    public static List&lt;EventSource&gt; events = new List&lt;EventSource&gt;();

    /// &lt;summary&gt;
    /// æŠ›å‡ºäº‹ä»¶æ‰©å±•
    /// &lt;/summary&gt;
    /// &lt;typeparam name="TData"&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name="TStepBody"&gt;&lt;/typeparam&gt;
    /// &lt;param name="builder"&gt;&lt;/param&gt;
    /// &lt;param name="eventName"&gt;&lt;/param&gt;
    /// &lt;param name="eventKey"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IStepBuilder&lt;TData, ActionStepBody&gt; RaiseEvent&lt;TData, TStepBody&gt;(this IWorkflowModifier&lt;TData, TStepBody&gt; builder,
        string eventName, Func&lt;TData, string&gt; eventKey) where TStepBody : IStepBody
    {
        return builder
            .Delay(d =&gt; TimeSpan.FromMilliseconds(100))//å»¶è¿Ÿæµç¨‹å°ä¼šå„¿ï¼Œç­‰å¾…äº‹ä»¶eventså…ˆæ·»åŠ æˆåŠŸ
            .Then(ctx =&gt;
            {
                var key = eventKey.Invoke((TData)ctx.Workflow.Data);
                //é‡Šæ”¾äº’æ–¥é”ï¼Œè®©WaitEventç»§ç»­æ‰§è¡Œä¸‹å»
                var mu = events.FirstOrDefault(x =&gt; x.EventName == eventName &amp;&amp; x.EventKey == key);
                if (mu != null)
                {
                    mu.Data = ctx.Workflow.Data;
                    //å®Œæˆä»»åŠ¡
                    mu.Cts.TrySetResult(true);
                }
            });
    }

    /// &lt;summary&gt;
    /// ç­‰å¾…å†…éƒ¨äº‹ä»¶æ‰©å±•
    /// &lt;/summary&gt;
    /// &lt;typeparam name="TData"&gt;å¯ä»¥æ˜¯workflowçš„å®ä½“ç±»ï¼Œæ¯”å¦‚IWorkflow&amp;lt;TData&amp;gt;ä¸­çš„TDataç±»&lt;/typeparam&gt;
    /// &lt;param name="host"&gt;&lt;/param&gt;
    /// &lt;param name="eventName"&gt;äº‹ä»¶å&lt;/param&gt;
    /// &lt;param name="eventKey"&gt;äº‹ä»¶keyï¼Œä¸€èˆ¬æ˜¯WorkflowId,æµç¨‹å®ä¾‹Id&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static async Task&lt;TData&gt; WaitEvent&lt;TData&gt;(this IWorkflowHost host, string eventName, string eventKey)
    {
        TData data = default(TData);
        //ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œè¯´æ˜æ­¥éª¤å·²æ‰§è¡Œï¼Œå¯ä»¥å¾—åˆ°éœ€è¦çš„æ•°æ®
        await Task.Run(async () =&gt;
        {
            //å‘ä»»åŠ¡é›†åˆæ·»åŠ ä¸€ä¸ªä»»åŠ¡
            EventSource eventCts = new EventSource
            {
                EventName = eventName,
                EventKey = eventKey,
                Cts = new TaskCompletionSource&lt;bool&gt;(),
            };
            events.Add(eventCts);
            //ç­‰å¾…ä»»åŠ¡å®Œæˆ
            await eventCts.Cts.Task;
            //é€€å‡ºç­‰å¾…
            if (eventCts.Data != null &amp;&amp; eventCts.Data is TData)
            {
                //å–å¾—æ•°æ®
                data = (TData)eventCts.Data;
            }
            events.Remove(eventCts);
        });
        return data;
    }
}

/// &lt;summary&gt;
/// äº‹ä»¶æº
/// &lt;/summary&gt;
public class EventSource
{
    public string EventName { get; set; }
    public string EventKey { get; set; }

    /// &lt;summary&gt;
    /// ä»»åŠ¡å®Œæˆæº
    /// &lt;/summary&gt;
    public TaskCompletionSource&lt;bool&gt; Cts { get; set; }

    public object Data { get; set; }
}
</code></pre>
<h2 id="ç»“æœ">ç»“æœ</h2>
<p>curdäº†ä¸€ä¸‹ï¼Œå‘ç°å½“ç„¶æ˜¯è¾¾åˆ°äº†æƒ³è¦çš„ç»“æœğŸ˜ã€‚<br>
å…¶ä¸­çš„å…³é”®æ–­ç‚¹å‘½ä¸­å¦‚ä¸‹</p>
<ul>
<li>ç¬¬ä¸€æ­¥<br>
<img src="https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822111952988-593993786.png" alt="image" loading="lazy"></li>
<li>ç¬¬äºŒæ­¥<br>
<img src="https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822112043336-894782252.png" alt="image" loading="lazy"></li>
<li>ç¬¬ä¸‰æ­¥<br>
<img src="https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822112103047-1638813539.png" alt="image" loading="lazy"></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0020833333333333333" data-date-updated="2025-08-22 11:27">2025-08-22 11:24</span>&nbsp;
<a href="https://www.cnblogs.com/ggtc">ggtc</a>&nbsp;
é˜…è¯»(<span id="post_view_count">47</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19052348);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19052348', targetLink: 'https://www.cnblogs.com/ggtc/p/19052348', title: 'ä¸ºworkflow-coreæ‰©å±•å¤–æŠ›äº‹ä»¶' })">ä¸¾æŠ¥</a>
</div>
        