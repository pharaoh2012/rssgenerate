
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/guoxiaoyu/p/18665146" title="å‘å¸ƒäº 2025-01-14 10:29">
    <span role="heading" aria-level="2">æ·±å…¥è§£æ Spring AI ç³»åˆ—ï¼šè§£æOpenAIæ¥å£å¯¹æ¥</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>ä»Šå¤©æˆ‘ä»¬å°†ä¸»è¦æ¢è®¨OpenAIæ˜¯å¦‚ä½•è¿›è¡Œæ¥å£å¯¹æ¥çš„ï¼Œè™½ç„¶æˆ‘ä»¬ä¸æ‰“ç®—æ·±å…¥ç»†èŠ‚ï¼Œä½†ä¼šå¯¹æ•´ä½“æµç¨‹è¿›è¡Œä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚åç»­ä¼šé€æ­¥åˆ†æå…¶ä¸­çš„å…·ä½“ç»†èŠ‚ï¼Œå¤§å®¶å¯ä»¥è€å¿ƒç­‰å¾…ï¼Œé€æ­¥å±•å¼€ã€‚å¥½çš„ï¼Œç°åœ¨è®©æˆ‘ä»¬å¼€å§‹ï¼Œä¸‹é¢æ˜¯æˆ‘ç®€å•ç»˜åˆ¶çš„ä¸€å¼ å›¾ç¤ºï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£æ¥ä¸‹æ¥çš„åˆ†ææµç¨‹ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083925163-132594069.png" alt="image" loading="lazy"></p>
<h1 id="openaiapi">OpenAiApi</h1>
<p>æˆ‘ä»¬ç¬¬ä¸€æ­¥å°†ç›´æ¥æŸ¥çœ‹ OpenAIApi ç±»ï¼Œè¿™æ˜¯ä¸æ¥å£æœ€ä¸ºå¯†åˆ‡ç›¸å…³çš„æ ¸å¿ƒç±»ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä¼šå…³æ³¨å®ƒçš„æ„é€ å™¨éƒ¨åˆ†ï¼Œå› ä¸ºåœ¨æ„é€ å™¨ä¸­ï¼ŒåŸºæœ¬åŒ…å«äº†ä¸æ¥å£äº¤äº’æ‰€éœ€çš„æœ€ä¸»è¦ä¾èµ–å’Œé…ç½®ä¿¡æ¯ã€‚é€šè¿‡è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£è¯¥ç±»å¦‚ä½•åˆå§‹åŒ–å¹¶å‡†å¤‡å¥½ä¸ OpenAI æ¥å£è¿›è¡Œé€šä¿¡ã€‚æ¥ä¸‹æ¥ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<pre><code class="language-java">public OpenAiApi(String baseUrl, String apiKey, MultiValueMap&lt;String, String&gt; headers, String completionsPath,
    String embeddingsPath, RestClient.Builder restClientBuilder, WebClient.Builder webClientBuilder,
    ResponseErrorHandler responseErrorHandler) {

this.completionsPath = completionsPath;
this.embeddingsPath = embeddingsPath; 
Consumer&lt;HttpHeaders&gt; finalHeaders = h -&gt; {
    h.setBearerAuth(apiKey);
    h.setContentType(MediaType.APPLICATION_JSON);
    h.addAll(headers);
};
this.restClient = restClientBuilder.baseUrl(baseUrl)
    .defaultHeaders(finalHeaders)
    .defaultStatusHandler(responseErrorHandler)
    .build();

this.webClient = webClientBuilder
    .baseUrl(baseUrl)
    .defaultHeaders(finalHeaders)
.build(); 
}
</code></pre>
<p>è¿™æ®µæ„é€ å‡½æ•°ä»£ç ç›¸å¯¹ç®€å•ï¼Œä¸»è¦è´Ÿè´£åˆ›å»ºä¸€ä¸ªåŒ…å«è®¤è¯ä¿¡æ¯å’Œå†…å®¹ç±»å‹çš„HTTPå¤´é…ç½®ï¼Œå¹¶é€šè¿‡è¿™äº›é…ç½®åˆå§‹åŒ–RestClientå’ŒWebClientï¼Œä»è€Œä¸ºåç»­çš„ç½‘ç»œè¯·æ±‚æä¾›åŸºç¡€æ”¯æŒã€‚</p>
<h2 id="restclient">RestClient</h2>
<p>RestClientä¸»è¦ç”¨äºå¤„ç†éæµå¼çš„è¯·æ±‚å’Œå“åº”ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public ResponseEntity&lt;ChatCompletion&gt; chatCompletionEntity(ChatCompletionRequest chatRequest,
        MultiValueMap&lt;String, String&gt; additionalHttpHeader) {

    return this.restClient.post()
        .uri(this.completionsPath)
        .headers(headers -&gt; headers.addAll(additionalHttpHeader))
        .body(chatRequest)
        .retrieve()
        .toEntity(ChatCompletion.class);
}
</code></pre>
<h2 id="webclient">WebClient</h2>
<p>WebClientä¸»è¦å°±æ˜¯å¤„ç†æµå¼çš„è¯·æ±‚å’Œå“åº”ï¼Œä»£ç çœ‹ä¸‹ï¼š</p>
<pre><code class="language-java">    public Flux&lt;ChatCompletionChunk&gt; chatCompletionStream(ChatCompletionRequest chatRequest,
            MultiValueMap&lt;String, String&gt; additionalHttpHeader) {

        AtomicBoolean isInsideTool = new AtomicBoolean(false);

        return this.webClient.post()
            .uri(this.completionsPath)
            //æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç 
</code></pre>
<p>è¿™éƒ¨åˆ†ä»£ç å‚æ•°å¾ˆå¤šï¼Œæˆ‘ä»¬å°±çœ‹ä¸‹æ ¸å¿ƒé€»è¾‘å³å¯ã€‚</p>
<h2 id="ç±»å±æ€§">ç±»å±æ€§</h2>
<p>è¿™æ ·ï¼Œåœ¨ç†è§£äº†ä¸»è¦æµç¨‹ä¹‹åï¼Œä½ å°±èƒ½æ›´æ¸…æ™°åœ°ç†è§£æ¯ä¸ªå‚æ•°åœ¨å…·ä½“å®ç°ä¸­çš„è§’è‰²ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•å½±å“æ•´ä½“åŠŸèƒ½çš„æ‰§è¡Œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸€ä¸‹è¿™æ®µå…³é”®ä»£ç ï¼š</p>
<pre><code class="language-java">public static final OpenAiApi.ChatModel DEFAULT_CHAT_MODEL = ChatModel.GPT_4_O;
public static final String DEFAULT_EMBEDDING_MODEL = EmbeddingModel.TEXT_EMBEDDING_ADA_002.getValue();
private static final Predicate&lt;String&gt; SSE_DONE_PREDICATE = "[DONE]"::equals;
private final String completionsPath;
private final String embeddingsPath;
private final RestClient restClient;
private final WebClient webClient;
private OpenAiStreamFunctionCallingHelper chunkMerger = new OpenAiStreamFunctionCallingHelper();
</code></pre>
<p>åœ¨å»æ‰äº†å‘é‡çš„ç›¸å…³å±æ€§ä¹‹åï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯<code>chunkMerger</code>ï¼Œä¸è¿‡è¿™ä¸ªéƒ¨åˆ†æ¶‰åŠçš„æ˜¯å¤„ç†æµå¼å“åº”çš„é€»è¾‘ï¼Œæš‚æ—¶æˆ‘ä»¬å¯ä»¥å…ˆä¸å…³æ³¨å®ƒã€‚ä¸ºäº†ç®€åŒ–åˆ†æï¼Œå½“å‰æˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯æœ€åŸºæœ¬çš„ã€æ­£å¸¸çš„é˜»å¡å¼è¯·æ±‚å¤„ç†æµç¨‹ï¼Œå› ä¸ºè¿™ç§æ¨¡å¼æ›´åŠ ç›´è§‚æ˜“æ‡‚ï¼Œä¾¿äºæˆ‘ä»¬ç†è§£å’Œè°ƒè¯•ã€‚</p>
<h2 id="chatcompletionrequest">ChatCompletionRequest</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ·±å…¥åˆ†æä¹‹å‰æåˆ°çš„é˜»å¡è¯·æ±‚ <code>chatCompletionEntity</code>ã€‚è¯¥è¯·æ±‚çš„å‚æ•°åŒ…æ‹¬ä¸€ä¸ª <code>ChatCompletionRequest</code> å¯¹è±¡å’Œä¸€ä¸ªåŒ…å«é¢å¤–å¤´ä¿¡æ¯çš„ <code>Map</code> ç»“æ„ã€‚ç”±äºæˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯è¯·æ±‚çš„æ ¸å¿ƒå†…å®¹ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¸»è¦åˆ†æ <code>ChatCompletionRequest</code> çš„å®ç°ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083932428-1429949022.png" alt="image" loading="lazy"></p>
<p>è¿™éƒ¨åˆ†å†…å®¹ç›¸ä¿¡å¤§å®¶ä¸€å®šå¾ˆç†Ÿæ‚‰ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯æ¥å£è¯·æ±‚çš„å‚æ•°éƒ¨åˆ†ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªè®°å½•ç±»ï¼Œç”¨äºå°è£…æ¥å£è¯·æ±‚æ‰€éœ€çš„å„é¡¹ä¿¡æ¯ã€‚é€šè¿‡æŸ¥çœ‹åŸæœ‰æ¥å£å¹³å°ä¸Šå±•ç¤ºçš„å‚æ•°åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸ªè®°å½•ç±»æ˜¯å¦‚ä½•æ˜ å°„åˆ°å®é™…æ¥å£è¯·æ±‚ä¸­çš„å„ä¸ªå­—æ®µçš„ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083938387-2045897397.png" alt="image" loading="lazy"></p>
<h2 id="chatcompletion">ChatCompletion</h2>
<p>ä»–çš„è¿”å›å‚æ•°æ˜¯ResponseEntity<chatcompletion>ï¼Œä»–ä¼šå°†è¿”å›ä¿¡æ¯åŒ…è£…æˆä¸€ä¸ªChatCompletionå®ä½“ï¼ŒçŒœä¸€ä¸‹ä¹Ÿæ˜¯æ¥å£è¿”å›ç›¸å…³çš„å‚æ•°å°è£…ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</chatcompletion></p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083945038-1815779070.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083950154-534369151.png" alt="image" loading="lazy"></p>
<h2 id="usage">usage</h2>
<p>åœ¨ä¹‹å‰æˆ‘ä»¬è¯´è¿‡usageè¿™ä¸ªç±»ï¼Œä»–å…¶å®å°±æ˜¯è®¡ç®—tokenç”¨çš„ã€‚å¦‚æœä¸çœ‹ç»Ÿè®¡ç±»çš„ä¿¡æ¯ï¼Œä¹Ÿæ²¡å•¥å¤§ç”¨ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/1423484/202501/1423484-20250111083957336-1477611674.png" alt="image" loading="lazy"></p>
<p>è¿™é‡Œå°±ä¸æ‹¿å®˜æ–¹æ¥å£åšå¯¹æ¯”äº†ï¼Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>é€šè¿‡ä»Šå¤©çš„åˆ†æï¼Œæˆ‘ä»¬åˆæ­¥äº†è§£äº†OpenAIæ¥å£å¯¹æ¥çš„æ•´ä½“æµç¨‹ã€‚è™½ç„¶æˆ‘ä»¬æ²¡æœ‰æ·±å…¥ç»†èŠ‚ï¼Œä½†é€šè¿‡å¯¹OpenAiApiç±»ã€RestClientã€WebClientåŠç›¸å…³è¯·æ±‚å‚æ•°çš„åˆ†æï¼Œå¤§å®¶åº”è¯¥å¯¹æ¥å£çš„å·¥ä½œåŸç†æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†ã€‚åç»­ï¼Œæˆ‘ä»¬å°†ç»§ç»­ç»†åŒ–å…·ä½“å®ç°ï¼Œé€æ­¥æ­ç¤ºæ¯ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ä¸é€»è¾‘ã€‚å¸Œæœ›å¤§å®¶è€å¿ƒç­‰å¾…ï¼Œè·Ÿéšæˆ‘ä»¬ä¸€èµ·æ·±å…¥æ¢ç´¢æ›´å¤šçš„æŠ€æœ¯ç»†èŠ‚ã€‚è¿™ä¸€è¿‡ç¨‹å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å¦‚ä½•ä¸OpenAIçš„æ¥å£è¿›è¡Œé«˜æ•ˆå¯¹æ¥ä¸äº¤äº’ã€‚</p>
<hr>
<p>æˆ‘æ˜¯åŠªåŠ›çš„å°é›¨ï¼Œä¸€ä¸ªæ­£ç»çš„ Java ä¸œåŒ—æœåŠ¡ç«¯å¼€å‘ï¼Œæ•´å¤©ç¢ç£¨ç€ AI æŠ€æœ¯è¿™å—å„¿çš„å¥¥ç§˜ã€‚ç‰¹çˆ±è·Ÿäººäº¤æµæŠ€æœ¯ï¼Œå–œæ¬¢æŠŠè‡ªå·±çš„å¿ƒå¾—å’Œå¤§å®¶åˆ†äº«ã€‚è¿˜å½“ä¸Šäº†è…¾è®¯äº‘åˆ›ä½œä¹‹æ˜Ÿï¼Œé˜¿é‡Œäº‘ä¸“å®¶åšä¸»ï¼Œåä¸ºäº‘äº‘äº«ä¸“å®¶ï¼Œæ˜é‡‘ä¼˜ç§€ä½œè€…ã€‚å„ç§å¾æ–‡ã€å¼€æºæ¯”èµ›çš„ç‰Œå­ä¹Ÿæ‹¿äº†ã€‚</p>
<p>ğŸ’¡ æƒ³æŠŠæˆ‘åœ¨æŠ€æœ¯è·¯ä¸Šèµ°è¿‡çš„å¼¯è·¯å’Œç»éªŒå…¨éƒ½åˆ†äº«å‡ºæ¥ï¼Œç»™ä½ ä»¬çš„å­¦ä¹ å’Œæˆé•¿å¸¦æ¥ç‚¹å¯å‘ï¼Œå¸®ä¸€æŠŠã€‚</p>
<p>ğŸŒŸ æ¬¢è¿å…³æ³¨åŠªåŠ›çš„å°é›¨ï¼Œå’±ä¸€å—å„¿è¿›æ­¥ï¼ğŸŒŸ</p>

</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.007997741096064815" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-14 10:29">2025-01-14 10:29</span>&nbsp;
<a href="https://www.cnblogs.com/guoxiaoyu">åŠªåŠ›çš„å°é›¨</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18665146" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18665146);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18665146', targetLink: 'https://www.cnblogs.com/guoxiaoyu/p/18665146', title: 'æ·±å…¥è§£æ Spring AI ç³»åˆ—ï¼šè§£æOpenAIæ¥å£å¯¹æ¥' })">ä¸¾æŠ¥</a>
</div>
	