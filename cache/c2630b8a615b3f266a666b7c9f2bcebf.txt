<!----> <meta itemprop="headline" content="ğŸš€ å‰ç«¯æ— æ„Ÿåˆ·æ–°tokenæœºåˆ¶ï¼ˆä¸€æ–‡è¯´æ˜ç™½ï¼‰"> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,axios"> <meta itemprop="datePublished" content="2024-10-08T01:47:52.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lsx_"> <meta itemprop="url" content="https://juejin.cn/user/1442981392682829"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-7cdd11fb="">
            ğŸš€ å‰ç«¯æ— æ„Ÿåˆ·æ–°tokenæœºåˆ¶ï¼ˆä¸€æ–‡è¯´æ˜ç™½ï¼‰
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-7cdd11fb=""><div class="author-info-box" data-v-7cdd11fb=""><div class="author-name" data-v-7cdd11fb=""><a href="/user/1442981392682829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-1800aadb="" data-v-7cdd11fb=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-1800aadb="">
    Lsx_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-7cdd11fb=""><time datetime="2024-10-08T01:47:52.000Z" title="Tue Oct 08 2024 01:47:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-7cdd11fb="">
                    2024-10-08
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-7cdd11fb=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-7cdd11fb=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-7cdd11fb=""></circle></svg> <span class="views-count" data-v-7cdd11fb="">
                    10,480
                  </span> <span class="read-time" data-v-7cdd11fb=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-7cdd11fb=""><rect width="16" height="16" fill="none" data-v-7cdd11fb=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-7cdd11fb=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-7cdd11fb=""></path></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-7cdd11fb=""></div> <!----> <!----></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-7cdd11fb=""><div class="article-viewer markdown-body result"><h2 data-id="heading-0">å‰è¨€</h2>
<p>ç”¨æˆ·ç™»å½•ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªç”¨æˆ·çš„æ ‡è¯†ï¼Œä¹‹åå¸¦ä¸Šè¿™ä¸ªæ ‡è¯†è¯·æ±‚åˆ«çš„æ¥å£ï¼Œå°±èƒ½è¯†åˆ«å‡ºè¯¥ç”¨æˆ·ã€‚</p>
<p>æ ‡è¯†ç™»å½•çŠ¶æ€çš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š session å’Œ jwtã€‚è¿™ä¸¤ç§æ–¹æ¡ˆä¸€ä¸ªæœåŠ¡ç«¯å­˜å‚¨ï¼Œé€šè¿‡ cookie æºå¸¦æ ‡è¯†ï¼Œä¸€ä¸ªåœ¨å®¢æˆ·ç«¯å­˜å‚¨ï¼Œé€šè¿‡ header æºå¸¦æ ‡è¯†ã€‚</p>
<p>session æ˜¯é€šè¿‡ cookie è¿”å›ä¸€ä¸ª idï¼Œå…³è”æœåŠ¡ç«¯å†…å­˜é‡Œä¿å­˜çš„ session å¯¹è±¡ï¼Œè¯·æ±‚æ—¶æœåŠ¡ç«¯å–å‡º cookie é‡Œ id å¯¹åº”çš„ session å¯¹è±¡ï¼Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dac5f629d5004c088db67a72f4dd9bb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735634851&amp;x-signature=lCMibsEVJNtoX5ixFzTLandNFYA%3D" alt="image.png" loading="lazy"></p>
<p>jwt ä¸åœ¨æœåŠ¡ç«¯å­˜å‚¨ï¼Œä¼šç›´æ¥æŠŠç”¨æˆ·ä¿¡æ¯æ”¾åˆ° token é‡Œè¿”å›ï¼Œæ¯æ¬¡è¯·æ±‚å¸¦ä¸Šè¿™ä¸ª tokenï¼ŒæœåŠ¡ç«¯å°±èƒ½ä»ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p><strong>session çš„æ–¹æ¡ˆé»˜è®¤ä¸æ”¯æŒåˆ†å¸ƒå¼ï¼Œå› ä¸ºæ˜¯ä¿å­˜åœ¨ä¸€å°æœåŠ¡å™¨çš„å†…å­˜çš„ï¼Œå¦ä¸€å°æœåŠ¡å™¨æ²¡æœ‰ã€‚jwt çš„æ–¹æ¡ˆå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼ï¼Œå› ä¸ºä¿¡æ¯ä¿å­˜åœ¨ token é‡Œï¼Œåªè¦ä»ä¸­å–å‡ºæ¥å°±è¡Œã€‚</strong></p>
<h2 data-id="heading-1">ä¸ºä»€ä¹ˆéœ€è¦æ— æ„Ÿåˆ·æ–°tokenæœºåˆ¶</h2>
<p>æœåŠ¡ç«¯æŠŠç”¨æˆ·ä¿¡æ¯æ”¾å…¥ token é‡Œï¼Œè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™é€šè¿‡ authorization çš„ header æºå¸¦ tokenï¼ŒæœåŠ¡ç«¯éªŒè¯é€šè¿‡ï¼Œå°±å¯ä»¥ä»ä¸­å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>ä½†æ˜¯token æ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œæ¯”å¦‚ 3 å¤©ï¼Œé‚£è¿‡æœŸåå†è®¿é—®å°±éœ€è¦é‡æ–°ç™»å½•äº†ã€‚è¿™æ ·ä½“éªŒå¹¶ä¸å¥½ã€‚
æƒ³æƒ³ä½ åœ¨ç”¨æŸä¸ª app çš„æ—¶å€™ï¼Œç”¨ç€ç”¨ç€çªç„¶è·³åˆ°ç™»å½•é¡µäº†ï¼Œå‘Šè¯‰ä½ éœ€è¦é‡æ–°ç™»å½•äº†ã€‚æ˜¯ä¸æ˜¯ä½“éªŒå¾ˆå·®ï¼Ÿ</p>
<p>æ‰€ä»¥è¦åŠ ä¸Šç»­ç­¾æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å»¶é•¿ token è¿‡æœŸæ—¶é—´ã€‚</p>
<p>ä¸»æµçš„æ–¹æ¡ˆæ˜¯é€šè¿‡åŒ tokenï¼Œä¸€ä¸ª access_tokenã€ä¸€ä¸ª refresh_tokenï¼ˆä¸€ä¸ªçŸ­tokenï¼Œä¸€ä¸ªé•¿tokenï¼‰ã€‚</p>
<h2 data-id="heading-2">æ— æ„Ÿåˆ·æ–°tokenæœºåˆ¶</h2>
<p>ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œä¸¤ä¸ª tokenï¼ˆä¸€ä¸ª access_tokenã€ä¸€ä¸ª refresh_tokenï¼‰ï¼Œè®¿é—®æ¥å£æ—¶æºå¸¦ access_token è®¿é—®ï¼Œå½“ access_token è¿‡æœŸæ—¶ï¼Œé€šè¿‡ refresh_token æ¥åˆ·æ–°ï¼Œæ‹¿åˆ°æ–°çš„ access_token å’Œ refresh_tokenã€‚</p>
<p>è€Œ access_token ä¸€èˆ¬è¿‡æœŸæ—¶é—´è®¾ç½®çš„æ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ 30 åˆ†é’Ÿï¼Œrefresh_token è®¾ç½®çš„è¿‡æœŸæ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ¯”å¦‚ 7 å¤©ã€‚è¿™æ ·ï¼Œåªè¦ä½  7 å¤©å†…è®¿é—®ä¸€æ¬¡ï¼Œå°±èƒ½åˆ·æ–° tokenï¼Œå†ç»­ 7 å¤©ï¼Œä¸€ç›´ä¸éœ€è¦ç™»å½•ã€‚</p>
<p>ä½†å¦‚æœä½ è¶…è¿‡ 7 å¤©æ²¡è®¿é—®ï¼Œé‚£ refresh_token ä¹Ÿè¿‡æœŸäº†ï¼Œå°±éœ€è¦é‡æ–°ç™»å½•äº†ã€‚æƒ³æƒ³ä½ å¸¸ç”¨çš„ APPï¼Œæ˜¯ä¸æ˜¯æ²¡å†é‡æ–°ç™»å½•è¿‡ï¼Ÿè€Œä¸å¸¸ç”¨çš„ APPï¼Œå†æ¬¡æ‰“å¼€æ˜¯ä¸æ˜¯å°±åˆè¦é‡æ–°ç™»å½•äº†ï¼Ÿè¿™ç§ä¸€èˆ¬éƒ½æ˜¯åŒ token åšçš„ã€‚</p>
<h2 data-id="heading-3">å®ç°</h2>
<p>åœ¨axiosçš„å“åº”æ‹¦æˆªå™¨ä¸­åˆ·æ–°tokenã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦æ’é™¤ä¸‹ /refresh æ¥å£ï¼Œä¹Ÿå°±æ˜¯åˆ·æ–°å¤±è´¥ä¸ç»§ç»­åˆ·æ–°ï¼Œä¸ç„¶ä¼šè¿›å…¥æ­»å¾ªç¯ã€‚</p>
<p>åˆ·æ–° token æˆåŠŸï¼Œå°±é‡å‘ä¹‹å‰çš„è¯·æ±‚ï¼Œå¦åˆ™ï¼Œæç¤ºé‡æ–°ç™»å½•ã€‚å…¶ä»–é”™è¯¯ç›´æ¥è¿”å›ã€‚</p>
<p>åœ¨åˆ·æ–° token çš„æ¥å£é‡Œï¼Œæ‹¿åˆ°æ–°çš„ access_token å’Œ refresh_token åï¼Œæ›´æ–°æœ¬åœ°å­˜å‚¨çš„ tokenã€‚</p>
<pre><code class="hljs language-js" lang="js">axiosInstance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> response;
    },
    <span class="hljs-keyword">async</span> (error) =&gt; {
        <span class="hljs-keyword">let</span> { data, config } = error.<span class="hljs-property">response</span>;

        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">statusCode</span> === <span class="hljs-number">401</span> &amp;&amp; !config.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/refresh'</span>)) {
            
            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshToken</span>();

            <span class="hljs-keyword">if</span>(res.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_">axiosInstance</span>(config);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(data || <span class="hljs-string">'ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'</span>);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> error.<span class="hljs-property">response</span>;
        }
    }
)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">refreshToken</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axiosInstance.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/refresh'</span>, {
        <span class="hljs-attr">params</span>: {
          <span class="hljs-attr">token</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refresh_token'</span>)
        }
    });
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'access_token'</span>, res.<span class="hljs-property">data</span>.<span class="hljs-property">accessToken</span>);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'refresh_token'</span>, res.<span class="hljs-property">data</span>.<span class="hljs-property">refreshToken</span>);
    
    <span class="hljs-keyword">return</span> res;
}

</code></pre>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼Œå¦‚æœå¹¶å‘è¯·æ±‚ï¼Œå¤šæ¬¡è°ƒç”¨åç«¯æ¥å£ï¼Œä¼šåˆ·æ–°tokenå¤šæ¬¡ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<p>åŠ ä¸€ä¸ª refreshing çš„æ ‡è®°ï¼Œè®°å½•æ˜¯å¦æ­£åœ¨åˆ·æ–°tokenï¼Œå¦‚æœåœ¨åˆ·æ–°ï¼Œé‚£å°±è¿”å›ä¸€ä¸ª promiseï¼Œå¹¶ä¸”æŠŠå®ƒçš„ resolve æ–¹æ³•è¿˜æœ‰ config åŠ å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œã€‚</p>
<p>å½“ tokenåˆ·æ–° æˆåŠŸä¹‹åï¼Œé‡æ–°å‘é€é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼ˆå³åœ¨åˆ·æ–°æœŸé—´ç§¯å‹çš„è¯·æ±‚ï¼‰ï¼Œå¹¶ä¸”æŠŠç»“æœé€šè¿‡ resolve è¿”å›ï¼ˆå³é‡æ–°å‘èµ·è¯·æ±‚ï¼‰ã€‚</p>
<pre><code class="hljs language-js" lang="js">interface <span class="hljs-title class_">PendingTask</span> {
    <span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>
    <span class="hljs-attr">resolve</span>: <span class="hljs-title class_">Function</span>
}

<span class="hljs-keyword">let</span> refreshing = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">PendingTask</span>[] = [];

axiosInstance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> response;
    },
    <span class="hljs-keyword">async</span> (error) =&gt; {
        <span class="hljs-keyword">let</span> { data, config } = error.<span class="hljs-property">response</span>;

        <span class="hljs-keyword">if</span>(refreshing) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
                queue.<span class="hljs-title function_">push</span>({
                    config,
                    resolve
                });
            });
        }

        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">statusCode</span> === <span class="hljs-number">401</span> &amp;&amp; !config.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/refresh'</span>)) {
            refreshing = <span class="hljs-literal">true</span>;
            
            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshToken</span>();

            refreshing = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span>(res.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {

                queue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{config, resolve}</span>) =&gt;</span> {
                    <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">axiosInstance</span>(config))
                })

                <span class="hljs-keyword">return</span> <span class="hljs-title function_">axiosInstance</span>(config);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">alert</span>(data || <span class="hljs-string">'ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'</span>);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> error.<span class="hljs-property">response</span>;
        }
    }
)

axiosInstance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) {
    <span class="hljs-keyword">const</span> accessToken = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>);

    <span class="hljs-keyword">if</span>(accessToken) {
        config.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span> = <span class="hljs-string">'Bearer '</span> + accessToken;
    }
    <span class="hljs-keyword">return</span> config;
})

</code></pre></div></div>