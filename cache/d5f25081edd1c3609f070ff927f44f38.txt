<!----> <meta itemprop="headline" content="WebGL实现soul星球效果"> <meta itemprop="keywords" content="前端"> <meta itemprop="datePublished" content="2024-10-14T15:38:28.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小趴蔡"> <meta itemprop="url" content="https://juejin.cn/user/1992729125465511"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-7cdd11fb="">
            WebGL实现soul星球效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-7cdd11fb=""><div class="author-info-box" data-v-7cdd11fb=""><div class="author-name" data-v-7cdd11fb=""><a href="/user/1992729125465511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-1800aadb="" data-v-7cdd11fb=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-1800aadb="">
    前端小趴蔡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-7cdd11fb=""><time datetime="2024-10-14T15:38:28.000Z" title="Mon Oct 14 2024 15:38:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-7cdd11fb="">
                    2024-10-14
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-7cdd11fb=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-7cdd11fb=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-7cdd11fb=""></circle></svg> <span class="views-count" data-v-7cdd11fb="">
                    11,618
                  </span> <span class="read-time" data-v-7cdd11fb=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-7cdd11fb=""><rect width="16" height="16" fill="none" data-v-7cdd11fb=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-7cdd11fb=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-7cdd11fb=""></path></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-7cdd11fb=""></div> <!----> <!----></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-7cdd11fb=""><div class="article-viewer markdown-body result"><h2 data-id="heading-0">WebGL实现soul星球效果</h2>
<p>最近在研究webGL，觉得soul app的星球挺有意思的，于是就实现了一下，中间涉及的细节和知识点挺多的，写篇博客分享一下</p>
<h3 data-id="heading-1">soul原版</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fc29578217040fdb8f3e3922a3fed6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6La06JSh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735197421&amp;x-signature=xS6uPr0P6Poloic9aWDIDO2g1pQ%3D" alt="描述" width="500" loading="lazy">
<h3 data-id="heading-2">WebGL实现的</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b81fe092284abdac9f2ceb9e3a6bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6La06JSh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735197421&amp;x-signature=h2WD7KZ5Hims1qF%2FWpaLTR0HK58%3D" alt="描述" width="500" loading="lazy">
<p><span href="https://code.juejin.cn/pen/7426375936839024676" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7426375936839024676" data-src="https://code.juejin.cn/pen/7426375936839024676" style="display:none;" loading="lazy"></iframe><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"><span class="loading-logo"></span></span></span></p>
<h3 data-id="heading-3">主要技术要点</h3>
<h5 data-id="heading-4">1.使用<code>黄金分割数螺旋分配</code>使小球在球表面均匀分布</h5>
<p>使用不同的goldenRatio可以得到非常多分布效果，采用<code>黄金分割数在视觉上最匀称、舒服</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> goldenRatio = (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">5</span>)) / <span class="hljs-number">2</span> 
<span class="hljs-keyword">const</span> y = <span class="hljs-number">1</span> - (i / (numPoints - <span class="hljs-number">1</span>)) * <span class="hljs-number">2</span> 
<span class="hljs-keyword">const</span> radiusAtY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">1</span> - y * y) 
<span class="hljs-keyword">const</span> theta = (<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * i) / goldenRatio 
<span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * radiusAtY 
<span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * radiusAtY
</code></pre>
<h5 data-id="heading-5">2.自由转动</h5>
<p>因为要解决万向锁的问题，所以不能使用<code>rotateX</code>、<code>rotateY</code>、<code>rotateZ</code>来旋转，应当使用四元数<code>THREE.Quaternion</code></p>
<h5 data-id="heading-6">3.背面小球变暗</h5>
<p>这里通过内部放置了一个半透明的黑色小球来实现</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建半透明球体</span>
<span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">4.85</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
</code></pre>
<p>为了使小球从正面转动的背面的过程中可以平滑的变暗，这里还需要把半透明小球的边沿<code>处理成高斯模糊</code>，具体实现就是使用GLSL的插值函数<code>smoothstep</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
  uniform vec3 color;
  uniform float opacity;
  varying vec3 vNormal;
  void main() {
      float alpha = opacity * smoothstep(0.5, 1.0, vNormal.z);
      gl_FragColor = vec4(color, alpha);
  }
</span></code></pre>
<p>但是需要注意的是需要关闭小球的<code>深度测试</code>,否则会<code>遮挡小球</code></p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">FrontSide</span>,
<span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,

</code></pre>
<h5 data-id="heading-7">4.使用<code>THREE.Sprite</code>创建小球标签</h5>
<h5 data-id="heading-8">5.标签位置计算</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numPoints; i++) {
    <span class="hljs-keyword">const</span> y = <span class="hljs-number">1</span> - (i / (numPoints - <span class="hljs-number">1</span>)) * <span class="hljs-number">2</span>
    <span class="hljs-keyword">const</span> radiusAtY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">1</span> - y * y)

    <span class="hljs-keyword">const</span> theta = (<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * i) / goldenRatio

    <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * radiusAtY
    <span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * radiusAtY
    <span class="hljs-keyword">const</span> smallBallMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">color</span>: <span class="hljs-title function_">getRandomBrightColor</span>(),
      <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">FrontSide</span>,
    })
    <span class="hljs-keyword">const</span> smallBall = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(smallBallGeometry, smallBallMaterial)
    smallBall.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x * radius, y * radius, z * radius)

</code></pre>
<h5 data-id="heading-9">6.超出长度的标签采用<code>贴图采样位移</code>来实现跑马灯效果</h5>
<h5 data-id="heading-10">7.滚动阻尼,鼠标转动球体之后速度能衰减到转动旋转的速率</h5>
<h5 data-id="heading-11">8.自动旋转需要保持上一次滚动的方向</h5>
<h5 data-id="heading-12">9.使用<code>射线拾取</code>来实现点击交互</h5>
<h3 data-id="heading-13">完整代码</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>3D 半透明球体与可交互小球<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
      <span class="hljs-selector-tag">body</span> {
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">background-color</span>: black;
        touch-action: none;
      }
      <span class="hljs-selector-tag">canvas</span> {
        <span class="hljs-attribute">display</span>: block;
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
      <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js'</span>

      <span class="hljs-comment">// 创建场景</span>
      <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>()

      <span class="hljs-comment">// 创建相机</span>
      <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
        <span class="hljs-number">75</span>,
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
        <span class="hljs-number">0.1</span>,
        <span class="hljs-number">1000</span>
      )
      camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">14</span>)
      camera.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

      <span class="hljs-comment">// 创建渲染器</span>
      <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span> })
      renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>)
      renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>)
      renderer.<span class="hljs-title function_">setClearColor</span>(<span class="hljs-number">0x000000</span>, <span class="hljs-number">0</span>)
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>)

      <span class="hljs-comment">// 创建半透明球体</span>
      <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">4.85</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
      <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
        <span class="hljs-attr">uniforms</span>: {
          <span class="hljs-attr">color</span>: { <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0x000000</span>) },
          <span class="hljs-attr">opacity</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.8</span> },
        },
        <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
          varying vec3 vNormal;
          void main() {
              vNormal = normalize(normalMatrix * normal);
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
          }
        `</span>,
        <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
          uniform vec3 color;
          uniform float opacity;
          varying vec3 vNormal;
          void main() {
              float alpha = opacity * smoothstep(0.5, 1.0, vNormal.z);
              gl_FragColor = vec4(color, alpha);
          }
        `</span>,
        <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">FrontSide</span>,
        <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,
      })

      <span class="hljs-keyword">const</span> sphere = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(sphereGeometry, sphereMaterial)
      scene.<span class="hljs-title function_">add</span>(sphere)

      <span class="hljs-comment">// 创建小球体和标签数组</span>
      <span class="hljs-keyword">const</span> smallBallGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">0.15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
      <span class="hljs-keyword">const</span> smallBalls = []
      <span class="hljs-keyword">const</span> labelSprites = []

      <span class="hljs-keyword">const</span> radius = <span class="hljs-number">5</span>
      <span class="hljs-keyword">const</span> numPoints = <span class="hljs-number">88</span>
      <span class="hljs-keyword">const</span> goldenRatio = (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">5</span>)) / <span class="hljs-number">2</span>
      <span class="hljs-keyword">const</span> maxWidth = <span class="hljs-number">160</span>
      <span class="hljs-keyword">const</span> textSpeed = <span class="hljs-number">0.002</span>

      <span class="hljs-comment">// 创建射线投射器</span>
      <span class="hljs-keyword">const</span> raycaster = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Raycaster</span>()
      <span class="hljs-keyword">const</span> mouse = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector2</span>()

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextTexture</span>(<span class="hljs-params">text, parameters = {}</span>) {
        <span class="hljs-keyword">const</span> {
          fontSize = <span class="hljs-number">24</span>,
          fontFace = <span class="hljs-string">'PingFang SC, Microsoft YaHei, Noto Sans, Arial, sans-serif'</span>,
          textColor = <span class="hljs-string">'white'</span>,
          backgroundColor = <span class="hljs-string">'rgba(0,0,0,0)'</span>,
          maxWidth = <span class="hljs-number">160</span>,
        } = parameters

        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
        <span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
        context.<span class="hljs-property">font</span> = <span class="hljs-string">`<span class="hljs-subst">${fontSize}</span>px <span class="hljs-subst">${fontFace}</span>`</span>

        <span class="hljs-keyword">const</span> textMetrics = context.<span class="hljs-title function_">measureText</span>(text)
        <span class="hljs-keyword">const</span> textWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(textMetrics.<span class="hljs-property">width</span>)
        <span class="hljs-keyword">const</span> textHeight = fontSize * <span class="hljs-number">1.2</span>

        <span class="hljs-keyword">const</span> needMarquee = textWidth &gt; maxWidth

        <span class="hljs-keyword">let</span> canvasWidth = maxWidth
        <span class="hljs-keyword">if</span> (needMarquee) {
          canvasWidth = textWidth + <span class="hljs-number">60</span>
        }

        canvas.<span class="hljs-property">width</span> = canvasWidth
        canvas.<span class="hljs-property">height</span> = textHeight
        context.<span class="hljs-property">font</span> = <span class="hljs-string">`<span class="hljs-subst">${fontSize}</span>px <span class="hljs-subst">${fontFace}</span>`</span>
        context.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>)

        context.<span class="hljs-property">fillStyle</span> = backgroundColor
        context.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>)

        context.<span class="hljs-property">fillStyle</span> = textColor
        context.<span class="hljs-property">textAlign</span> = needMarquee ? <span class="hljs-string">'left'</span> : <span class="hljs-string">'center'</span>
        context.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>

        <span class="hljs-keyword">if</span> (needMarquee) {
          context.<span class="hljs-title function_">fillText</span>(text, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>)
        } <span class="hljs-keyword">else</span> {
          context.<span class="hljs-title function_">fillText</span>(text, maxWidth / <span class="hljs-number">2</span>, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>)
        }

        <span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CanvasTexture</span>(canvas)
        texture.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> (needMarquee) {
          texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>
          texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ClampToEdgeWrapping</span>
          texture.<span class="hljs-property">repeat</span>.<span class="hljs-property">x</span> = maxWidth / canvas.<span class="hljs-property">width</span>
        } <span class="hljs-keyword">else</span> {
          texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ClampToEdgeWrapping</span>
          texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ClampToEdgeWrapping</span>
        }

        texture.<span class="hljs-property">minFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">LinearFilter</span>
        texture.<span class="hljs-property">magFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">LinearFilter</span>
        texture.<span class="hljs-property">generateMipmaps</span> = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span> { texture, needMarquee, <span class="hljs-title class_">HWRate</span>: textHeight / maxWidth }
      }

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numPoints; i++) {
        <span class="hljs-keyword">const</span> y = <span class="hljs-number">1</span> - (i / (numPoints - <span class="hljs-number">1</span>)) * <span class="hljs-number">2</span>
        <span class="hljs-keyword">const</span> radiusAtY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">1</span> - y * y)

        <span class="hljs-keyword">const</span> theta = (<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * i) / goldenRatio

        <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta) * radiusAtY
        <span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta) * radiusAtY
        <span class="hljs-keyword">const</span> smallBallMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({
          <span class="hljs-attr">color</span>: <span class="hljs-title function_">getRandomBrightColor</span>(),
          <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">FrontSide</span>,
        })
        <span class="hljs-keyword">const</span> smallBall = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(smallBallGeometry, smallBallMaterial)
        smallBall.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x * radius, y * radius, z * radius)
        sphere.<span class="hljs-title function_">add</span>(smallBall)
        smallBalls.<span class="hljs-title function_">push</span>(smallBall)

        <span class="hljs-keyword">const</span> labelText = <span class="hljs-title function_">getRandomNickname</span>()
        <span class="hljs-keyword">const</span> { texture, needMarquee, <span class="hljs-title class_">HWRate</span> } = <span class="hljs-title function_">createTextTexture</span>(labelText, {
          <span class="hljs-attr">fontSize</span>: <span class="hljs-number">28</span>,
          <span class="hljs-attr">fontFace</span>: <span class="hljs-string">'PingFang SC, Microsoft YaHei, Noto Sans, Arial, sans-serif'</span>,
          <span class="hljs-attr">textColor</span>: <span class="hljs-string">'#bbbbbb'</span>,
          <span class="hljs-attr">maxWidth</span>: maxWidth,
        })

        <span class="hljs-keyword">const</span> spriteMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SpriteMaterial</span>({
          <span class="hljs-attr">map</span>: texture,
          <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NormalBlending</span>,
        })

        <span class="hljs-keyword">const</span> sprite = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Sprite</span>(spriteMaterial)
        sprite.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">HWRate</span>, <span class="hljs-number">1</span>)
        labelSprites.<span class="hljs-title function_">push</span>({ sprite, smallBall, texture, needMarquee, labelText })
        scene.<span class="hljs-title function_">add</span>(sprite)
      }

      <span class="hljs-comment">// 添加灯光</span>
      <span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>)
      scene.<span class="hljs-title function_">add</span>(light)
      <span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>)
      directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
      scene.<span class="hljs-title function_">add</span>(directionalLight)

      <span class="hljs-comment">// 定义自动旋转速度和轴</span>
      <span class="hljs-keyword">const</span> autoRotationSpeed = <span class="hljs-number">0.0005</span>
      <span class="hljs-keyword">let</span> autoRotationAxis = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_">normalize</span>()
      <span class="hljs-keyword">let</span> currentAngularVelocity = autoRotationAxis.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)

      <span class="hljs-keyword">let</span> isDragging = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">let</span> previousMousePosition = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }
      <span class="hljs-keyword">let</span> lastDragDelta = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }

      <span class="hljs-keyword">const</span> decayRate = <span class="hljs-number">0.92</span>
      <span class="hljs-keyword">const</span> increaseRate = <span class="hljs-number">1.02</span>

      <span class="hljs-comment">// 鼠标事件处理</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseDown</span> = (<span class="hljs-params">event</span>) =&gt; {
        isDragging = <span class="hljs-literal">true</span>
        previousMousePosition = {
          <span class="hljs-attr">x</span>: event.<span class="hljs-property">clientX</span>,
          <span class="hljs-attr">y</span>: event.<span class="hljs-property">clientY</span>,
        }
      }

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseMove</span> = (<span class="hljs-params">event</span>) =&gt; {
        <span class="hljs-keyword">if</span> (isDragging) {
          <span class="hljs-keyword">const</span> deltaX = event.<span class="hljs-property">clientX</span> - previousMousePosition.<span class="hljs-property">x</span>
          <span class="hljs-keyword">const</span> deltaY = event.<span class="hljs-property">clientY</span> - previousMousePosition.<span class="hljs-property">y</span>

          lastDragDelta = { <span class="hljs-attr">x</span>: deltaX, <span class="hljs-attr">y</span>: deltaY }

          <span class="hljs-keyword">const</span> rotationFactor = <span class="hljs-number">0.005</span>

          <span class="hljs-keyword">const</span> angleY = deltaX * rotationFactor
          <span class="hljs-keyword">const</span> angleX = deltaY * rotationFactor

          <span class="hljs-keyword">const</span> quaternionY = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">setFromAxisAngle</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
            angleY
          )
          <span class="hljs-keyword">const</span> quaternionX = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">setFromAxisAngle</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
            angleX
          )

          <span class="hljs-keyword">const</span> deltaQuat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">multiplyQuaternions</span>(quaternionY, quaternionX)

          sphere.<span class="hljs-property">quaternion</span>.<span class="hljs-title function_">multiplyQuaternions</span>(deltaQuat, sphere.<span class="hljs-property">quaternion</span>)

          <span class="hljs-keyword">const</span> dragRotationAxis = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(deltaY, deltaX, <span class="hljs-number">0</span>).<span class="hljs-title function_">normalize</span>()
          <span class="hljs-keyword">const</span> dragRotationSpeed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(deltaX * deltaX + deltaY * deltaY) * rotationFactor

          <span class="hljs-keyword">if</span> (dragRotationAxis.<span class="hljs-title function_">length</span>() &gt; <span class="hljs-number">0</span>) {
            currentAngularVelocity.<span class="hljs-title function_">copy</span>(dragRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(dragRotationSpeed)
          }

          previousMousePosition = {
            <span class="hljs-attr">x</span>: event.<span class="hljs-property">clientX</span>,
            <span class="hljs-attr">y</span>: event.<span class="hljs-property">clientY</span>,
          }
        }
      }

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseUp</span> = (<span class="hljs-params"></span>) =&gt; {
        <span class="hljs-keyword">if</span> (isDragging) {
          isDragging = <span class="hljs-literal">false</span>

          <span class="hljs-keyword">const</span> deltaX = lastDragDelta.<span class="hljs-property">x</span>
          <span class="hljs-keyword">const</span> deltaY = lastDragDelta.<span class="hljs-property">y</span>

          <span class="hljs-keyword">if</span> (deltaX !== <span class="hljs-number">0</span> || deltaY !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">const</span> newAxis = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(deltaY, deltaX, <span class="hljs-number">0</span>).<span class="hljs-title function_">normalize</span>()
            <span class="hljs-keyword">if</span> (newAxis.<span class="hljs-title function_">length</span>() &gt; <span class="hljs-number">0</span>) {
              autoRotationAxis.<span class="hljs-title function_">copy</span>(newAxis)
            }

            <span class="hljs-keyword">const</span> dragSpeed = currentAngularVelocity.<span class="hljs-title function_">length</span>()
            <span class="hljs-keyword">if</span> (dragSpeed &gt; autoRotationSpeed) {
              <span class="hljs-comment">// 维持当前旋转速度</span>
            } <span class="hljs-keyword">else</span> {
              currentAngularVelocity.<span class="hljs-title function_">copy</span>(autoRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)
            }
          }
        }
      }

      <span class="hljs-comment">// 触摸事件处理</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onTouchStart</span> = (<span class="hljs-params">event</span>) =&gt; {
        isDragging = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">const</span> touch = event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>]
        previousMousePosition = {
          <span class="hljs-attr">x</span>: touch.<span class="hljs-property">clientX</span>,
          <span class="hljs-attr">y</span>: touch.<span class="hljs-property">clientY</span>,
        }
      }

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onTouchMove</span> = (<span class="hljs-params">event</span>) =&gt; {
        event.<span class="hljs-title function_">preventDefault</span>()
        <span class="hljs-keyword">if</span> (isDragging) {
          <span class="hljs-keyword">const</span> touch = event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>]
          <span class="hljs-keyword">const</span> deltaX = touch.<span class="hljs-property">clientX</span> - previousMousePosition.<span class="hljs-property">x</span>
          <span class="hljs-keyword">const</span> deltaY = touch.<span class="hljs-property">clientY</span> - previousMousePosition.<span class="hljs-property">y</span>

          lastDragDelta = { <span class="hljs-attr">x</span>: deltaX, <span class="hljs-attr">y</span>: deltaY }

          <span class="hljs-keyword">const</span> rotationFactor = <span class="hljs-number">0.002</span>

          <span class="hljs-keyword">const</span> angleY = deltaX * rotationFactor
          <span class="hljs-keyword">const</span> angleX = deltaY * rotationFactor

          <span class="hljs-keyword">const</span> quaternionY = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">setFromAxisAngle</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
            angleY
          )
          <span class="hljs-keyword">const</span> quaternionX = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">setFromAxisAngle</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
            angleX
          )

          <span class="hljs-keyword">const</span> deltaQuat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">multiplyQuaternions</span>(quaternionY, quaternionX)

          sphere.<span class="hljs-property">quaternion</span>.<span class="hljs-title function_">multiplyQuaternions</span>(deltaQuat, sphere.<span class="hljs-property">quaternion</span>)

          <span class="hljs-keyword">const</span> dragRotationAxis = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(deltaY, deltaX, <span class="hljs-number">0</span>).<span class="hljs-title function_">normalize</span>()
          <span class="hljs-keyword">const</span> dragRotationSpeed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(deltaX * deltaX + deltaY * deltaY) * rotationFactor

          <span class="hljs-keyword">if</span> (dragRotationAxis.<span class="hljs-title function_">length</span>() &gt; <span class="hljs-number">0</span>) {
            currentAngularVelocity.<span class="hljs-title function_">copy</span>(dragRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(dragRotationSpeed)
          }

          previousMousePosition = {
            <span class="hljs-attr">x</span>: touch.<span class="hljs-property">clientX</span>,
            <span class="hljs-attr">y</span>: touch.<span class="hljs-property">clientY</span>,
          }
        }
      }

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onTouchEnd</span> = (<span class="hljs-params">event</span>) =&gt; {
        <span class="hljs-keyword">if</span> (isDragging) {
          isDragging = <span class="hljs-literal">false</span>

          <span class="hljs-keyword">const</span> deltaX = lastDragDelta.<span class="hljs-property">x</span>
          <span class="hljs-keyword">const</span> deltaY = lastDragDelta.<span class="hljs-property">y</span>

          <span class="hljs-keyword">if</span> (deltaX !== <span class="hljs-number">0</span> || deltaY !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">const</span> newAxis = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(deltaY, deltaX, <span class="hljs-number">0</span>).<span class="hljs-title function_">normalize</span>()
            <span class="hljs-keyword">if</span> (newAxis.<span class="hljs-title function_">length</span>() &gt; <span class="hljs-number">0</span>) {
              autoRotationAxis.<span class="hljs-title function_">copy</span>(newAxis)
            }

            <span class="hljs-keyword">const</span> dragSpeed = currentAngularVelocity.<span class="hljs-title function_">length</span>()
            <span class="hljs-keyword">if</span> (dragSpeed &gt; autoRotationSpeed) {
              <span class="hljs-comment">// 维持当前旋转速度</span>
            } <span class="hljs-keyword">else</span> {
              currentAngularVelocity.<span class="hljs-title function_">copy</span>(autoRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)
            }
          }
        }

        <span class="hljs-comment">// 检查点击事件</span>
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">changedTouches</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> touch = event.<span class="hljs-property">changedTouches</span>[<span class="hljs-number">0</span>]
          mouse.<span class="hljs-property">x</span> = (touch.<span class="hljs-property">clientX</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
          mouse.<span class="hljs-property">y</span> = -(touch.<span class="hljs-property">clientY</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>
          <span class="hljs-title function_">checkIntersection</span>()
        }
      }

      <span class="hljs-comment">// 事件监听</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, onMouseDown)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, onMouseMove)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, onMouseUp)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchstart'</span>, onTouchStart)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, onTouchMove)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchend'</span>, onTouchEnd)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'gesturestart'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        e.<span class="hljs-title function_">preventDefault</span>()
      })

      <span class="hljs-comment">// 添加点击事件监听</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, onMouseClick)

      <span class="hljs-comment">// 处理窗口大小调整</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
        camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>
        camera.<span class="hljs-title function_">updateProjectionMatrix</span>()
        renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>)
      })

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMouseClick</span>(<span class="hljs-params">event</span>) {
        event.<span class="hljs-title function_">preventDefault</span>()
        mouse.<span class="hljs-property">x</span> = (event.<span class="hljs-property">clientX</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
        mouse.<span class="hljs-property">y</span> = -(event.<span class="hljs-property">clientY</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">clientX</span>, mouse.<span class="hljs-property">x</span>, mouse.<span class="hljs-property">y</span>)

        <span class="hljs-title function_">checkIntersection</span>()
      }

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkIntersection</span>(<span class="hljs-params"></span>) {
        raycaster.<span class="hljs-title function_">setFromCamera</span>(mouse, camera)
        <span class="hljs-keyword">const</span> intersects = raycaster.<span class="hljs-title function_">intersectObjects</span>(smallBalls)

        <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> intersectedBall = intersects[<span class="hljs-number">0</span>].<span class="hljs-property">object</span>
          <span class="hljs-keyword">const</span> index = smallBalls.<span class="hljs-title function_">indexOf</span>(intersectedBall)
          <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">const</span> labelInfo = labelSprites[index]
            <span class="hljs-title function_">showLabelInfo</span>(labelInfo)
          }
        }
      }

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">showLabelInfo</span>(<span class="hljs-params">labelInfo</span>) {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">`点击的小球标签：<span class="hljs-subst">${labelInfo.labelText}</span>`</span>)
      }

      <span class="hljs-comment">// 动画循环</span>
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"></span>) {
        <span class="hljs-title function_">requestAnimationFrame</span>(animate)

        <span class="hljs-keyword">if</span> (!isDragging) {
          <span class="hljs-keyword">const</span> deltaQuat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Quaternion</span>().<span class="hljs-title function_">setFromEuler</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Euler</span>(
              currentAngularVelocity.<span class="hljs-property">x</span>,
              currentAngularVelocity.<span class="hljs-property">y</span>,
              currentAngularVelocity.<span class="hljs-property">z</span>,
              <span class="hljs-string">'XYZ'</span>
            )
          )
          sphere.<span class="hljs-property">quaternion</span>.<span class="hljs-title function_">multiplyQuaternions</span>(deltaQuat, sphere.<span class="hljs-property">quaternion</span>)

          <span class="hljs-keyword">const</span> currentSpeed = currentAngularVelocity.<span class="hljs-title function_">length</span>()

          <span class="hljs-keyword">if</span> (currentSpeed &gt; autoRotationSpeed) {
            currentAngularVelocity.<span class="hljs-title function_">multiplyScalar</span>(decayRate)

            <span class="hljs-keyword">if</span> (currentAngularVelocity.<span class="hljs-title function_">length</span>() &lt; autoRotationSpeed) {
              currentAngularVelocity.<span class="hljs-title function_">copy</span>(autoRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)
            }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentSpeed &lt; autoRotationSpeed) {
            currentAngularVelocity.<span class="hljs-title function_">multiplyScalar</span>(increaseRate)

            <span class="hljs-keyword">if</span> (currentAngularVelocity.<span class="hljs-title function_">length</span>() &gt; autoRotationSpeed) {
              currentAngularVelocity.<span class="hljs-title function_">copy</span>(autoRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)
            }
          } <span class="hljs-keyword">else</span> {
            currentAngularVelocity.<span class="hljs-title function_">copy</span>(autoRotationAxis).<span class="hljs-title function_">multiplyScalar</span>(autoRotationSpeed)
          }
        }

        <span class="hljs-comment">// 更新标签的位置和跑马灯效果</span>
        labelSprites.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ sprite, smallBall, texture, needMarquee }</span>) =&gt;</span> {
          smallBall.<span class="hljs-title function_">updateMatrixWorld</span>()
          <span class="hljs-keyword">const</span> smallBallWorldPos = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>()
          smallBall.<span class="hljs-title function_">getWorldPosition</span>(smallBallWorldPos)

          <span class="hljs-keyword">const</span> upOffset = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0</span>)

          sprite.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(smallBallWorldPos).<span class="hljs-title function_">add</span>(upOffset)

          <span class="hljs-keyword">if</span> (needMarquee) {
            texture.<span class="hljs-property">offset</span>.<span class="hljs-property">x</span> += textSpeed

            <span class="hljs-keyword">if</span> (texture.<span class="hljs-property">offset</span>.<span class="hljs-property">x</span> &gt; <span class="hljs-number">1</span>) {
              texture.<span class="hljs-property">offset</span>.<span class="hljs-property">x</span> = <span class="hljs-number">0</span>
            }
          }
        })

        renderer.<span class="hljs-title function_">render</span>(scene, camera)
      }

      <span class="hljs-title function_">animate</span>()

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">getRandomBrightColor</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> hue = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">360</span>)
        <span class="hljs-keyword">const</span> saturation = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">40</span> + <span class="hljs-number">10</span>)
        <span class="hljs-keyword">const</span> lightness = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">40</span> + <span class="hljs-number">40</span>)

        <span class="hljs-keyword">const</span> rgb = <span class="hljs-title function_">hslToRgb</span>(hue, saturation, lightness)

        <span class="hljs-keyword">return</span> (rgb.<span class="hljs-property">r</span> &lt;&lt; <span class="hljs-number">16</span>) | (rgb.<span class="hljs-property">g</span> &lt;&lt; <span class="hljs-number">8</span>) | rgb.<span class="hljs-property">b</span>
      }

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">hslToRgb</span>(<span class="hljs-params">h, s, l</span>) {
        s /= <span class="hljs-number">100</span>
        l /= <span class="hljs-number">100</span>

        <span class="hljs-keyword">const</span> c = (<span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-number">2</span> * l - <span class="hljs-number">1</span>)) * s
        <span class="hljs-keyword">const</span> x = c * (<span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(((h / <span class="hljs-number">60</span>) % <span class="hljs-number">2</span>) - <span class="hljs-number">1</span>))
        <span class="hljs-keyword">const</span> m = l - c / <span class="hljs-number">2</span>

        <span class="hljs-keyword">let</span> r, g, b
        <span class="hljs-keyword">if</span> (h &gt;= <span class="hljs-number">0</span> &amp;&amp; h &lt; <span class="hljs-number">60</span>) {
          r = c
          g = x
          b = <span class="hljs-number">0</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h &gt;= <span class="hljs-number">60</span> &amp;&amp; h &lt; <span class="hljs-number">120</span>) {
          r = x
          g = c
          b = <span class="hljs-number">0</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h &gt;= <span class="hljs-number">120</span> &amp;&amp; h &lt; <span class="hljs-number">180</span>) {
          r = <span class="hljs-number">0</span>
          g = c
          b = x
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h &gt;= <span class="hljs-number">180</span> &amp;&amp; h &lt; <span class="hljs-number">240</span>) {
          r = <span class="hljs-number">0</span>
          g = x
          b = c
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (h &gt;= <span class="hljs-number">240</span> &amp;&amp; h &lt; <span class="hljs-number">300</span>) {
          r = x
          g = <span class="hljs-number">0</span>
          b = c
        } <span class="hljs-keyword">else</span> {
          r = c
          g = <span class="hljs-number">0</span>
          b = x
        }

        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">r</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((r + m) * <span class="hljs-number">255</span>),
          <span class="hljs-attr">g</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((g + m) * <span class="hljs-number">255</span>),
          <span class="hljs-attr">b</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((b + m) * <span class="hljs-number">255</span>),
        }
      }

      <span class="hljs-keyword">function</span> <span class="hljs-title function_">getRandomNickname</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> adjectives = [
          <span class="hljs-string">'Cool'</span>,
          <span class="hljs-string">'Crazy'</span>,
          <span class="hljs-string">'Mysterious'</span>,
          <span class="hljs-string">'Happy'</span>,
          <span class="hljs-string">'Silly'</span>,
          <span class="hljs-string">'Brave'</span>,
          <span class="hljs-string">'Smart'</span>,
          <span class="hljs-string">'Swift'</span>,
          <span class="hljs-string">'Fierce'</span>,
          <span class="hljs-string">'Gentle'</span>,
        ]
        <span class="hljs-keyword">const</span> nouns = [
          <span class="hljs-string">'Tiger'</span>,
          <span class="hljs-string">'Lion'</span>,
          <span class="hljs-string">'Dragon'</span>,
          <span class="hljs-string">'Wizard'</span>,
          <span class="hljs-string">'Ninja'</span>,
          <span class="hljs-string">'Pirate'</span>,
          <span class="hljs-string">'Hero'</span>,
          <span class="hljs-string">'Ghost'</span>,
          <span class="hljs-string">'Phantom'</span>,
          <span class="hljs-string">'Knight'</span>,
        ]

        <span class="hljs-keyword">const</span> randomAdjective = adjectives[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * adjectives.<span class="hljs-property">length</span>)]
        <span class="hljs-keyword">const</span> randomNoun = nouns[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * nouns.<span class="hljs-property">length</span>)]

        <span class="hljs-keyword">const</span> nickname = <span class="hljs-string">`<span class="hljs-subst">${randomAdjective}</span> <span class="hljs-subst">${randomNoun}</span>`</span>

        <span class="hljs-keyword">if</span> (nickname.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">getRandomNickname</span>()
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nickname.<span class="hljs-property">length</span> &gt; <span class="hljs-number">22</span>) {
          <span class="hljs-keyword">return</span> nickname.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">22</span>)
        }

        <span class="hljs-keyword">return</span> nickname
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre></div></div>