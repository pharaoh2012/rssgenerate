
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/grey-wolf/p/18820484" title="发布于 2025-04-12 09:16">
    <span role="heading" aria-level="2">端口telnet不通排查过程</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="现状">现状</h1>
<p>简单描述下最近在做啥，我手里维护的一些系统的线上服务器，还在使用centos7，7.3/7.6/7.9都有，运维侧选定的替换系统是<code>openEuler20.03-LTS-SP1</code>。按理说，运维直接在线上升级系统就完了，但是，由于风险太大了（直接升级后可能导致应用异常），就还是需要研发出迁移方案、测试组进行测试后，比较保险。</p>
<p>于是，我就在本地虚拟机virtualbox先来折腾试试，先搭了个centos 7.3的系统，部署了个应用，监听端口9900，结果怎么都访问不了。</p>
<p>下面记录下排查过程。</p>
<h1 id="应用介绍">应用介绍</h1>
<p>我们这个服务器是centos7.3，上面的应用也比较老，是一种java servlet容器：resin，和tomcat类似，对外提供http接口。</p>
<p>配置监听端口的地方如下：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411104535813.png" alt="image-20250411104535813" loading="lazy"></p>
<p>程序启动后，我看端口是在监听的：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411104640445.png" alt="image-20250411104640445" loading="lazy"></p>
<p>我本机curl试了下，可以访问：</p>
<pre><code class="language-shell">[root@node7 my168_web]# curl localhost:9900
&lt;html&gt;
&lt;body&gt;
&lt;h2&gt;Hello World!&lt;/h2&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>我这个虚拟机的端口9900，需要暴露到windows宿主机进行访问，配置了下端口映射：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411104901122.png" alt="image-20250411104901122" loading="lazy"></p>
<p>然后，通过浏览器访问localhost:19900，发现失败：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105013245.png" alt="image-20250411105013245" loading="lazy"></p>
<h1 id="排查过程">排查过程</h1>
<h2 id="怀疑ipv6">怀疑ipv6</h2>
<p>我在虚拟机上，开了tcpdump，发现可以收到syn握手：</p>
<pre><code class="language-shell">tcpdump -i any tcp port 9900 -Ann
</code></pre>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105223762.png" alt="image-20250411105223762" loading="lazy"></p>
<p>我在虚拟机，又试了下：</p>
<pre><code class="language-shell">[root@node7 my168_web]# curl localhost:9900
&lt;html&gt;
&lt;body&gt;
&lt;h2&gt;Hello World!&lt;/h2&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>发现抓包如下：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105420467.png" alt="image-20250411105420467" loading="lazy"></p>
<p>此时，就看到通过localhost访问时，用的ipv6的地址，此时，开始怀疑是不是9900端口，仅监听了ipv6导致的。</p>
<p>下面这个输出，强化了我的猜测：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105610890.png" alt="image-20250411105610890" loading="lazy"></p>
<p>我又看了下其他环境，发现：</p>
<p>如果这个环境里，只有ipv4地址，netstat的输出就不一样</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105759812.png" alt="image-20250411105759812" loading="lazy"></p>
<p>另外一套环境，有ipv6地址，netstat输出就是inet6啥的。</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411105929962.png" alt="image-20250411105929962" loading="lazy"></p>
<h2 id="尝试修改配置文件监听ipv4">尝试修改配置文件，监听ipv4</h2>
<p>把配置改成了下面这样：</p>
<pre><code class="language-shell">&lt;http address="0.0.0.0" port="9900"/&gt;
</code></pre>
<p>重启后，netstat结果发现输出没啥变化：</p>
<pre><code class="language-shell">[root@node7 my168_web]# netstat -nltp|grep 9900
tcp6       0      0 :::9900                 :::*                    LISTEN      11992/java      
</code></pre>
<p>此时，在网上问大模型，大模型提到：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411110639245.png" alt="image-20250411110639245" loading="lazy"></p>
<p>大模型建议实际测试下，看看到底是否支持ipv4：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411110732643.png" alt="image-20250411110732643" loading="lazy"></p>
<p>测了之后，发现确实可以，那就说明对ipv4的支持没问题：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411110837192.png" alt="image-20250411110837192" loading="lazy"></p>
<h2 id="尝试从其他虚拟机telnet该端口">尝试从其他虚拟机telnet该端口</h2>
<p>我找了另一台同网段的机器10.0.2.8：</p>
<pre><code class="language-shell">[root@node-4 yum.repos.d]# telnet 10.0.2.12 9900
Trying 10.0.2.12...
telnet: connect to address 10.0.2.12: No route to host
</code></pre>
<p>很奇怪的是，你说no route我可以理解，就是找不到目标主机的路由项嘛，但是，我在目标主机开了抓包的，发现telnet的时候，能收到syn包：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111207640.png" alt="image-20250411111207640" loading="lazy"></p>
<p>而且，抓包到wireshark看的时候，发现mac地址也是正确的：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111450258.png" alt="image-20250411111450258" loading="lazy"></p>
<p>下图附两台机器的mac地址：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111607327.png" alt="image-20250411111607327" loading="lazy"></p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111630302.png" alt="image-20250411111630302" loading="lazy"></p>
<p>我于是在发起端的机器，查看下路由表：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111400569.png" alt="image-20250411111400569" loading="lazy"></p>
<p>发现路由表没错。</p>
<p>安装了个traceroute，发现就一跳，然后看看arp，发现这个ip对应的mac地址也是对的。</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111716475.png" alt="image-20250411111716475" loading="lazy"></p>
<p>此时，又去网上查了下，开始怀疑到了防火墙的身上。</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411111946672.png" alt="image-20250411111946672" loading="lazy"></p>
<h2 id="防火墙排查">防火墙排查</h2>
<p>找了下centos7.3中对应的防火墙相关命令：</p>
<p><a href="https://www.ctyun.cn/zhishi/p-330299" target="_blank" rel="noopener nofollow">https://www.ctyun.cn/zhishi/p-330299</a></p>
<p>发现目标服务器上，防火墙真的开着的：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411112126775.png" alt="image-20250411112126775" loading="lazy"></p>
<p>查了下，9900端口是否开放，发现没开放：</p>
<pre><code class="language-shell">[root@node7 my168_web]# firewall-cmd --query-port=9900/tcp
no
</code></pre>
<pre><code class="language-shell">9900加入开放：
firewall-cmd --permanent --add-port=9900/tcp

firewall-cmd --reload

[root@node7 my168_web]# firewall-cmd --permanent --add-port=9900/tcp
success
[root@node7 my168_web]# firewall-cmd --reload
success
[root@node7 my168_web]# firewall-cmd --query-port=9900/tcp
yes
</code></pre>
<p>然后再试试，果然就好了：</p>
<p><img src="https://dump-1252523945.cos.ap-shanghai.myqcloud.com/img/image-20250411112318814.png" alt="image-20250411112318814" loading="lazy"></p>
<h1 id="总结">总结</h1>
<p>这个centos7.3是新装的虚拟机，忘了防火墙会自动开启这回事了。</p>
<p>由于对netstat的输出也是半桶水，导致走了弯路，好歹最后还是找到了正确的路。</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.3733881279722222" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-12 09:17">2025-04-12 09:16</span>&nbsp;
<a href="https://www.cnblogs.com/grey-wolf">三国梦回</a>&nbsp;
阅读(<span id="post_view_count">43</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18820484" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18820484);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18820484', targetLink: 'https://www.cnblogs.com/grey-wolf/p/18820484', title: '端口telnet不通排查过程' })">举报</a>
</div>
        