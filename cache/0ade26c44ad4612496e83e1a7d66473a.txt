
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/JacobX/p/18908334" title="å‘å¸ƒäº 2025-06-03 14:58">
    <span role="heading" aria-level="2">é£ç‰›OSç»™å®¹å™¨é­”æ–¹ä¸Šè¡Œå®½å¸¦é™é€Ÿ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>ä¸‹é¢æˆ‘å°†è¯¦ç»†è®²è§£ï¼ˆå®¹å™¨ç½‘ç»œå‘½åç©ºé—´é™é€Ÿï¼‰çš„æŒä¹…åŒ–é…ç½®æ­¥éª¤ï¼Œç¡®ä¿åœ¨é£ç‰›OSé‡å¯åè‡ªåŠ¨ç”Ÿæ•ˆã€‚è¯·ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
</blockquote>
<h1 id="ï¸-å®Œæ•´æŒä¹…åŒ–é…ç½®æ•™ç¨‹å¸¦è¯¦ç»†è§£é‡Š">ğŸ› ï¸ å®Œæ•´æŒä¹…åŒ–é…ç½®æ•™ç¨‹ï¼ˆå¸¦è¯¦ç»†è§£é‡Šï¼‰</h1>
<h2 id="æ­¥éª¤1ç¡®è®¤å®¹å™¨é­”æ–¹åç§°">æ­¥éª¤1ï¼šç¡®è®¤å®¹å™¨é­”æ–¹åç§°</h2>
<pre><code># æŸ¥çœ‹è¿è¡Œçš„å®¹å™¨åˆ—è¡¨
docker ps

# ä»è¾“å‡ºä¸­æ‰¾åˆ°å®¹å™¨é­”æ–¹çš„åç§°ï¼ˆé€šå¸¸åœ¨NAMESåˆ—ï¼‰
# ç¤ºä¾‹è¾“å‡ºï¼š
# CONTAINER ID   IMAGE                   ...   NAMES
# a1b2c3d4e5f6   wxedge-image   ...   wxedge
</code></pre>
<p>ç¡®è®¤å®¹å™¨åç§°ï¼ˆå¦‚ä¸Šä¾‹çš„ â€‹â€‹wxedgeâ€‹â€‹ï¼‰ï¼Œåç»­æ­¥éª¤å°†ç”¨åˆ°è¿™ä¸ªåç§°ã€‚å®¹å™¨é­”æ–¹çš„åå­—é»˜è®¤<strong>wxedge</strong></p>
<h2 id="æ­¥éª¤2åˆ›å»ºé™é€Ÿè„šæœ¬">æ­¥éª¤2ï¼šåˆ›å»ºé™é€Ÿè„šæœ¬</h2>
<pre><code># åˆ›å»ºè„šæœ¬ç›®å½•
sudo mkdir -p /opt/scripts

# åˆ›å»ºè„šæœ¬æ–‡ä»¶
sudo nano /opt/scripts/limit_container_traffic.sh
</code></pre>
<p>åœ¨ç¼–è¾‘å™¨ä¸­ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆâ€‹â€‹è®°å¾—æ›¿æ¢ YOUR_CONTAINER_NAME ä¸ºä½ çš„å®é™…å®¹å™¨åç§°â€‹â€‹ï¼‰ï¼šå®¹å™¨é­”æ–¹çš„åå­—ä¸º<strong>wxedge</strong><br>
eth0æ˜¯ç½‘å¡åç§°ï¼Œå¯ä»¥åœ¨é£ç‰›OSä¸­çš„ç½‘ç»œè®¾ç½®ä¸­æŸ¥çœ‹è‡ªå·±çš„ç½‘å¡åç§°ï¼Œæ›¿æ¢è‡ªå·±çš„ä½¿ç”¨ç½‘å¡å³å¯</p>
<pre><code>#!/bin/bash
# å®¹å™¨åç§°ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
CONTAINER_NAME="wxedge"

# ç­‰å¾…å®¹å™¨å®Œå…¨å¯åŠ¨ï¼ˆé‡è¦ï¼ï¼‰
echo "ç­‰å¾…å®¹å™¨å¯åŠ¨..."
while ! docker inspect --format='{{.State.Running}}' $CONTAINER_NAME | grep -q "true"; do
    sleep 3
done

# é¢å¤–ç­‰å¾…5ç§’ç¡®ä¿ç½‘ç»œåˆå§‹åŒ–
sleep 5

# è·å–å®¹å™¨PID
PID=$(docker inspect -f '{{.State.Pid}}' "$CONTAINER_NAME")

if [ -z "$PID" ]; then
    echo "é”™è¯¯ï¼šæ— æ³•è·å–å®¹å™¨ $CONTAINER_NAME çš„PID"
    exit 1
fi

# åº”ç”¨ä¸Šè¡Œå¸¦å®½é™åˆ¶(20Mbps) æ³¨æ„ï¼Œå¦‚ä¸‹æ˜¯åœ¨é£ç‰›OSä¸­ç½‘ç»œè®¾ç½®ä¸­çœ‹åˆ°çš„ç½‘å¡åç§°ï¼Œæ­¤å¤„ä¸ºeth0
echo "ä¸ºå®¹å™¨ $CONTAINER_NAME (PID:$PID) è®¾ç½®ä¸Šè¡Œå¸¦å®½é™åˆ¶..."
nsenter -t $PID -n tc qdisc replace dev eth0 root tbf \
    rate 20mbit \
    burst 320kbit \
    latency 400ms

# æ£€æŸ¥ç»“æœ
if [ $? -eq 0 ]; then
    echo "æˆåŠŸè®¾ç½®ä¸Šè¡Œå¸¦å®½é™åˆ¶ï¼š20Mbps"
else
    echo "é™é€Ÿè®¾ç½®å¤±è´¥ï¼"
    exit 2
fi
</code></pre>
<p>æŒ‰ Ctrl+O ä¿å­˜æ–‡ä»¶ï¼Œç„¶å Ctrl+X é€€å‡ºç¼–è¾‘å™¨ã€‚</p>
<p>ç»™è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š</p>
<pre><code>sudo chmod +x /opt/scripts/limit_container_traffic.sh
</code></pre>
<h2 id="æ­¥éª¤3åˆ›å»ºsystemdæœåŠ¡å•å…ƒ">æ­¥éª¤3ï¼šåˆ›å»ºSystemdæœåŠ¡å•å…ƒ</h2>
<pre><code># åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶
sudo nano /etc/systemd/system/container-bandwidth.service
</code></pre>
<p>ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code>[Unit]
Description=Container Bandwidth Limiter for Magic Container
After=docker.service
Requires=docker.service

[Service]
Type=simple
ExecStart=/opt/scripts/limit_container_traffic.sh
Restart=on-failure
RestartSec=30
StartLimitInterval=0

[Install]
WantedBy=multi-user.target
</code></pre>
<p>ä¿å­˜å¹¶é€€å‡ºï¼ˆCtrl+O â†’ Enter â†’ Ctrl+Xï¼‰</p>
<h2 id="æ­¥éª¤4å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡">æ­¥éª¤4ï¼šå¯ç”¨å¹¶å¯åŠ¨æœåŠ¡</h2>
<pre><code># é‡è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
sudo systemctl enable container-bandwidth.service

# ç«‹å³å¯åŠ¨æœåŠ¡
sudo systemctl start container-bandwidth.service
</code></pre>
<h2 id="æ­¥éª¤5éªŒè¯æœåŠ¡çŠ¶æ€">æ­¥éª¤5ï¼šéªŒè¯æœåŠ¡çŠ¶æ€</h2>
<pre><code># æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status container-bandwidth.service

# é¢„æœŸçœ‹åˆ° "active (running)" çŠ¶æ€
# æ£€æŸ¥æ—¥å¿—ï¼ˆæŸ¥çœ‹é™é€Ÿæ˜¯å¦æˆåŠŸï¼‰
journalctl -u container-bandwidth.service -n 50 --no-pager
</code></pre>
<p>æ—¥å¿—ä¸­åº”çœ‹åˆ°ç±»ä¼¼ï¼š</p>
<pre><code>ç­‰å¾…å®¹å™¨å¯åŠ¨...
ä¸ºå®¹å™¨ container_magic (PID:12345) è®¾ç½®ä¸Šè¡Œå¸¦å®½é™åˆ¶...
æˆåŠŸè®¾ç½®ä¸Šè¡Œå¸¦å®½é™åˆ¶ï¼š20Mbps
</code></pre>
<h3 id="æ­¥éª¤6æµ‹è¯•é™é€Ÿæ•ˆæœç†è®ºä¸Šå¦‚æœå®¹å™¨é­”æ–¹æ­£åœ¨ä¸Šä¼ ä¸éœ€è¦æµ‹è¯•ç›´æ¥çœ‹æ•ˆæœç«‹ç«¿è§å½±">æ­¥éª¤6ï¼šæµ‹è¯•é™é€Ÿæ•ˆæœï¼Œç†è®ºä¸Šå¦‚æœå®¹å™¨é­”æ–¹æ­£åœ¨ä¸Šä¼ ï¼Œä¸éœ€è¦æµ‹è¯•ï¼Œç›´æ¥çœ‹æ•ˆæœï¼Œç«‹ç«¿è§å½±ã€‚</h3>
<blockquote>
<p>é£ç‰›OSç³»ç»Ÿä¸­çš„UIç•Œé¢æœ‰ç½‘é€Ÿï¼Œçœ‹é‚£ä¸ªå³å¯ã€‚æ¯”å¦‚ä¹‹å‰æ˜¯7Mb/sï¼Œé™åˆ¶å®Œä¸Šä¼ åå˜ä¸ºäº†2.4Mb/sï¼Œé€Ÿåº¦æ ¹æ®è‡ªå·±éœ€æ±‚è°ƒæ•´</p>
</blockquote>
<ol>
<li>â€‹â€‹åœ¨å®¹å™¨å†…å®‰è£…æµ‹è¯•å·¥å…·â€‹â€‹ï¼š</li>
</ol>
<pre><code># è¿›å…¥å®¹å™¨é­”æ–¹Shell
docker exec -it YOUR_CONTAINER_NAME /bin/bash

# åœ¨å®¹å™¨å†…å®‰è£…speedtest-cli
apt-get update &amp;&amp; apt-get install -y speedtest-cli  # å¯¹äºDebianç³»
# æˆ–ï¼ˆå¦‚æœä½¿ç”¨Alpineï¼‰ï¼š
# apk add curl
</code></pre>
<ol start="2">
<li>è¿è¡Œä¸Šè¡Œé€Ÿåº¦æµ‹è¯•â€‹â€‹ï¼š</li>
</ol>
<pre><code># æ–¹æ³•1: ä½¿ç”¨speedtest-cli
speedtest --simple

# æ–¹æ³•2: ä½¿ç”¨curlæµ‹è¯•ä¸Šä¼ 
curl -T /dev/zero http://speedtest.ftp.otenet.gr/files/test10Mb.db
# è§‚å¯Ÿè¾“å‡ºé€Ÿåº¦ï¼ˆåº”ç¨³å®šåœ¨~2.5MB/så·¦å³ï¼Œå› ä¸º20Mbps = 2.5MB/sï¼‰
</code></pre>
<h2 id="æ­¥éª¤7é‡å¯éªŒè¯æŒä¹…åŒ–">æ­¥éª¤7ï¼šé‡å¯éªŒè¯æŒä¹…åŒ–</h2>
<pre><code># é‡å¯é£ç‰›OS
sudo reboot

# é‡å¯åæ£€æŸ¥
sudo systemctl status container-bandwidth.service
docker exec YOUR_CONTAINER_NAME tc qdisc show dev eth0
</code></pre>
<p>åº”çœ‹åˆ°ç±»ä¼¼ï¼š</p>
<pre><code>qdisc tbf 800d: root refcnt 2 rate 20Mbit burst 32Kb lat 400.0ms
</code></pre>
<h2 id="-æ’é”™æŒ‡å—">ğŸš¨ æ’é”™æŒ‡å—</h2>
<table>
<thead>
<tr>
<th>é—®é¢˜ç°è±¡</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>"æ— æ³•è·å–å®¹å™¨PID"</td>
<td>æ£€æŸ¥å®¹å™¨åç§°æ˜¯å¦æ­£ç¡®ã€å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</td>
</tr>
<tr>
<td>"No such file or directory"</td>
<td>ç¡®è®¤å·²åˆ›å»º /opt/scripts/limit_container_traffic.sh å¹¶æœ‰æ‰§è¡Œæƒé™</td>
</tr>
<tr>
<td>"RTNETLINK answers: File exists"</td>
<td>æ·»åŠ  replace å…³é”®å­—ï¼štc qdisc replace...</td>
</tr>
<tr>
<td>ç½‘å¡åç§°ä¸æ˜¯eth0</td>
<td>ä¿®æ”¹è„šæœ¬ä¸­çš„ dev eth0 â†’ ä½¿ç”¨ docker exec å®¹å™¨å ip addr æŸ¥çœ‹æ­£ç¡®ç½‘å¡å</td>
</tr>
<tr>
<td>é™é€Ÿä¸ç²¾ç¡®</td>
<td>è°ƒæ•´ burst å€¼ï¼šburst = rate/8 * 1.5</td>
</tr>
<tr>
<td>æœåŠ¡å¯åŠ¨è¿‡æ—©</td>
<td>å¢åŠ è„šæœ¬ä¸­çš„ sleep æ—¶é—´</td>
</tr>
</tbody>
</table>
<h2 id="-æ›´æ–°é™é€Ÿé…ç½®">ğŸ”„ æ›´æ–°é™é€Ÿé…ç½®</h2>
<p>å¦‚éœ€ä¿®æ”¹å¸¦å®½é™åˆ¶ï¼ˆä¾‹å¦‚æ”¹ä¸º30Mbpsï¼‰ï¼š</p>
<p>ç¼–è¾‘è„šæœ¬æ–‡ä»¶ï¼š</p>
<pre><code>sudo nano /opt/scripts/limit_container_traffic.sh
</code></pre>
<p>ä¿®æ”¹ rate 20mbit â†’ rate 30mbit<br>
ä¿®æ”¹ burst 320kbit â†’ burst 480kbit (30Ã·8Ã—1.5=5.625ï¼Œçº¦480kbit)<br>
é‡å¯æœåŠ¡ï¼š</p>
<pre><code>sudo systemctl restart container-bandwidth.service
</code></pre>
<blockquote>
<p>ğŸ’¡ æ­¤æ–¹æ¡ˆé€šè¿‡Systemdåœ¨å®¿ä¸»æœºå±‚é¢è‡ªåŠ¨ç®¡ç†ï¼Œé¿å…ä¿®æ”¹å®¹å™¨å†…éƒ¨ï¼Œç¡®ä¿æ¯æ¬¡é‡å¯é£ç‰›OSåè‡ªåŠ¨ç”Ÿæ•ˆä¸”ä¸å½±å“å®¹å™¨é­”æ–¹çš„æ­£å¸¸åŠŸèƒ½ã€‚</p>
</blockquote>

</div>
<div id="MySignature" role="contentinfo">
    <p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href="https://www.cnblogs.com/JacobX/" target="_blank">JacobÂ·é›…å„å¸ƒ</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href="https://www.cnblogs.com/JacobX/p/18908334" target="_blank">https://www.cnblogs.com/JacobX/p/18908334</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.2311844581585648" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-06-03 14:58">2025-06-03 14:58</span>&nbsp;
<a href="https://www.cnblogs.com/JacobX">JacobÂ·é›…å„å¸ƒ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">111</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18908334);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18908334', targetLink: 'https://www.cnblogs.com/JacobX/p/18908334', title: 'é£ç‰›OSç»™å®¹å™¨é­”æ–¹ä¸Šè¡Œå®½å¸¦é™é€Ÿ' })">ä¸¾æŠ¥</a>
</div>
        