
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Johny-zhao/p/18858732" title="发布于 2025-05-03 22:14">
    <span role="heading" aria-level="2">在Ubuntu Server上安装Checkmk监控系统</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<div class="dad65929">
<div class="_4f9bf79 d7dc56a8 _43c05b5">
<div class="ds-markdown ds-markdown--block">
<h4><strong>一、安装前准备</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>更新系统并安装依赖</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo <span class="token function">apt update <span class="token operator">&amp;&amp; <span class="token function">sudo <span class="token function">apt upgrade <span class="token parameter variable">-y
<span class="token function">sudo <span class="token function">apt <span class="token function">install <span class="token parameter variable">-y <span class="token function">wget apt-transport-https</span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
</li>
</ol><hr>
<h4><strong>二、安装Checkmk（开源版）</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>添加Checkmk仓库</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">wget https://checkmk.com/support/1.6.0p30/check-mk-raw-2.1.0p30_0.jammy_amd64.deb
<span class="token function">sudo dpkg <span class="token parameter variable">-i check-mk-raw-2.1.0p30_0.jammy_amd64.deb
<span class="token function">sudo <span class="token function">apt <span class="token function">install <span class="token parameter variable">-f</span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>创建监控实例</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo omd create monitoring
<span class="token function">sudo omd start monitoring</span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>开放防火墙端口（HTTP/HTTPS）</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo ufw allow <span class="token number">80/tcp
<span class="token function">sudo ufw allow <span class="token number">443/tcp
<span class="token function">sudo ufw reload</span></span></span></span></span></pre>
</div>
</li>
</ol><hr>
<h4><strong>三、访问Web界面</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph">访问&nbsp;<code>http://your-server-ip/monitoring</code>，使用默认凭据登录：</p>
<ul>
<li>
<p class="ds-markdown-paragraph"><strong>用户名</strong>:&nbsp;<code>cmkadmin</code></p>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>密码</strong>: 安装时生成的密码（查看&nbsp;<code>/omd/sites/monitoring/etc/htpasswd</code>）。</p>
</li>
</ul>
</li>
</ol><hr>
<h3><strong>配置被监控设备</strong></h3>
<hr>
<h4><strong>一、监控Linux服务器</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>在目标服务器上安装Checkmk Agent</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">wget http://<span class="token operator">&lt;checkmk-server-ip<span class="token operator">&gt;/monitoring/check_mk/agents/check-mk-agent_2.1.0p30-1_all.deb
<span class="token function">sudo dpkg <span class="token parameter variable">-i check-mk-agent_*.deb
<span class="token function">sudo systemctl restart xinetd  <span class="token comment"># 确保xinetd服务运行</span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>在Checkmk Web界面添加主机</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">导航到&nbsp;<strong>Setup &gt; Hosts &gt; Add host</strong>。</p>
</li>
<li>
<p class="ds-markdown-paragraph">输入主机名、IP地址，选择&nbsp;<strong>Checkmk Agent</strong>&nbsp;监控方式。</p>
</li>
<li>
<p class="ds-markdown-paragraph">点击&nbsp;<strong>Save &amp; Run Service Discovery</strong>，应用更改。</p>
</li>
</ul>
</li>
</ol><hr>
<h4><strong>二、监控网络设备（交换机/路由器/防火墙）</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>在设备上启用SNMP</strong>（以Cisco设备为例）：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token operator">! 进入配置模式
configure terminal
snmp-server community YourCommunityString RO  <span class="token comment"># 设置只读社区字符串
snmp-server <span class="token function">host <span class="token operator">&lt;checkmk-server-ip<span class="token operator">&gt; version 2c YourCommunityString
<span class="token builtin class-name">exit</span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>在Checkmk中添加SNMP设备</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">导航到&nbsp;<strong>Setup &gt; Hosts &gt; Add host</strong>。</p>
</li>
<li>
<p class="ds-markdown-paragraph">输入设备名称、IP地址，选择&nbsp;<strong>SNMP</strong>&nbsp;监控方式。</p>
</li>
<li>
<p class="ds-markdown-paragraph">配置SNMP版本（如v2c）及社区字符串。</p>
</li>
<li>
<p class="ds-markdown-paragraph">点击&nbsp;<strong>Save &amp; Run Service Discovery</strong>，勾选接口流量监控项（如&nbsp;<code>Interface statistics</code>）。</p>
</li>
</ul>
</li>
</ol><hr>
<h4><strong>三、监控堡垒机（以Linux堡垒机为例）</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>通过SSH或Agent监控</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">若支持SNMP，按网络设备方式添加。</p>
</li>
<li>
<p class="ds-markdown-paragraph">若不支持SNMP，通过Checkmk Agent（同Linux服务器步骤）。</p>
</li>
</ul>
</li>
</ol><hr>
<h3><strong>配置接口流量监控</strong></h3>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>在服务发现结果中启用接口监控</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">在主机页面点击&nbsp;<strong>Service Discovery</strong>。</p>
</li>
<li>
<p class="ds-markdown-paragraph">勾选要监控的接口（如&nbsp;<code>Interface Ethernet0</code>）。</p>
</li>
<li>
<p class="ds-markdown-paragraph">点击&nbsp;<strong>Activate</strong>&nbsp;应用更改。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>自定义流量阈值</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">导航到&nbsp;<strong>Setup &gt; Hosts &gt; Services</strong>，选择接口服务。</p>
</li>
<li>
<p class="ds-markdown-paragraph">修改&nbsp;<strong>Check parameters</strong>&nbsp;设置告警阈值（如带宽利用率超80%告警）。</p>
</li>
</ul>
</li>
</ol><hr>
<h3><strong>定时备份平台数据</strong></h3>
<h4><strong>一、手动备份</strong></h4>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo omd backup monitoring  <span class="token comment"># 备份文件默认存储在 `/var/lib/omd/backups/`</span></span></pre>
</div>
<h4><strong>二、自动备份（Cron任务）</strong></h4>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>创建备份脚本</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo <span class="token function">nano /usr/local/bin/checkmk_backup.sh</span></span></pre>
</div>
<div class="md-code-block md-code-block-light">
<pre><span class="token shebang important">#!/bin/bash
omd backup monitoring <span class="token operator">&gt; /dev/null
<span class="token function">find /var/lib/omd/backups/ <span class="token parameter variable">-name <span class="token string">"*.tar.gz" <span class="token parameter variable">-mtime +30 <span class="token parameter variable">-exec <span class="token function">rm <span class="token punctuation">{<span class="token punctuation">} <span class="token punctuation">\<span class="token punctuation">;</span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>设置定时任务</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">crontab <span class="token parameter variable">-e</span></span></pre>
</div>
<div class="md-code-block md-code-block-light">
<pre>0 2 * * * /usr/local/bin/checkmk_backup.sh  # 每天凌晨2点备份</pre>
</div>
</li>
</ol><hr>
<h3><strong>日常维护事项</strong></h3>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>监控日志</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">Checkmk日志路径：<code>/omd/sites/monitoring/var/log/</code>.</p>
</li>
<li>
<p class="ds-markdown-paragraph">检查&nbsp;<code>nagios.log</code>&nbsp;和&nbsp;<code>cmc.log</code>&nbsp;是否有错误。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>更新Checkmk</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre><span class="token function">sudo <span class="token function">apt update
<span class="token function">sudo <span class="token function">apt <span class="token function">install check-mk-raw-<span class="token operator">&lt;新版本号<span class="token operator">&gt;
<span class="token function">sudo omd update monitoring</span></span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>清理旧数据</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">在Web界面调整数据保留策略：<strong>Setup &gt; General &gt; Global Settings &gt; History</strong>。</p>
</li>
</ul>
</li>
</ol><hr>
<h3><strong>注意事项</strong></h3>
<ol start="1">
<li>
<p class="ds-markdown-paragraph"><strong>SNMP安全</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">使用SNMPv3替代v2c（配置加密用户）。</p>
</li>
<li>
<p class="ds-markdown-paragraph">限制SNMP访问IP（通过设备ACL或防火墙）。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>权限管理</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">使用Checkmk的&nbsp;<strong>Roles &amp; Users</strong>&nbsp;功能分配最小权限。</p>
</li>
<li>
<p class="ds-markdown-paragraph">避免使用默认密码，定期更换凭据。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>高可用性</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">若监控设备超过500台，考虑分布式部署（主从监控节点）。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>资源监控</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">监控Checkmk服务器资源（CPU/内存/磁盘），避免因负载过高丢数据。</p>
</li>
</ul>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>防火墙规则</strong>：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">允许Checkmk服务器访问设备的SNMP（UDP 161）和Agent（TCP 6556）端口。</p>
</li>
</ul>
</li>
</ol><hr>
<h3><strong>故障排查示例</strong></h3>
<ul>
<li>
<p class="ds-markdown-paragraph"><strong>SNMP监控失败</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre>snmpwalk <span class="token parameter variable">-v2c <span class="token parameter variable">-c YourCommunityString <span class="token operator">&lt;设备IP<span class="token operator">&gt; <span class="token number">1.3.6.1.2.1.1.1.0  <span class="token comment"># 测试SNMP连通性</span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p class="ds-markdown-paragraph"><strong>Agent无数据</strong>：</p>
<div class="md-code-block md-code-block-light">
<pre>telnet <span class="token operator">&lt;目标服务器IP<span class="token operator">&gt; <span class="token number">6556  <span class="token comment"># 检查Agent端口是否开放</span></span></span></span></pre>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.18344127482291667" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-03 22:15">2025-05-03 22:14</span>&nbsp;
<a href="https://www.cnblogs.com/Johny-zhao">Johny_Zhao</a>&nbsp;
阅读(<span id="post_view_count">8</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18858732);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18858732', targetLink: 'https://www.cnblogs.com/Johny-zhao/p/18858732', title: '在Ubuntu Server上安装Checkmk监控系统' })">举报</a>
</div>
        