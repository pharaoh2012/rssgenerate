
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ACaiGarden/p/18654742" title="发布于 2025-01-06 10:32">
    <span role="heading" aria-level="2">【漏洞分析】20250105-SorraStaking：奖励金额计算错误，每次取款都有大收益</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="背景信息">背景信息</h1>
<p><strong>2024-12-21 11:58:11 (UTC)</strong></p>
<ol>
<li>准备交易：<a href="https://app.blocksec.com/explorer/tx/eth/0x72a252277e30ea6a37d2dc9905c280f3bc389b87f72b81a59aa8f50baebd8eaa" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0x72a252277e30ea6a37d2dc9905c280f3bc389b87f72b81a59aa8f50baebd8eaa</a></li>
</ol>
<p><strong>2025-01-04 11:59:23 (UTC)</strong></p>
<ol>
<li>攻击交易 1：<a href="https://app.blocksec.com/explorer/tx/eth/0x6439d63cc57fb68a32ea8ffd8f02496e8abad67292be94904c0b47a4d14ce90d" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0x6439d63cc57fb68a32ea8ffd8f02496e8abad67292be94904c0b47a4d14ce90d</a></li>
<li>攻击交易 2：<a href="https://app.blocksec.com/explorer/tx/eth/0xf1a494239af59cd4c1d649a1510f0beab8bb78c62f31e390ba161eb2c29fbf8b" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0xf1a494239af59cd4c1d649a1510f0beab8bb78c62f31e390ba161eb2c29fbf8b</a></li>
<li>攻击交易 3：<a href="https://app.blocksec.com/explorer/tx/eth/0x09b26b87a91c7aea3db05cfcf3718c827eba58c0da1f2bf481505e0c8dc0766b" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0x09b26b87a91c7aea3db05cfcf3718c827eba58c0da1f2bf481505e0c8dc0766b</a></li>
</ol>
<p>漏洞合约：<a href="https://vscode.blockscan.com/ethereum/0x5d16b8ba2a9a4eca6126635a6ffbf05b52727d50" target="_blank" rel="noopener nofollow">https://vscode.blockscan.com/ethereum/0x5d16b8ba2a9a4eca6126635a6ffbf05b52727d50</a></p>
<p><code>sorraStaking</code> 项目是一个质押奖励项目，用户质押 SOR 代币并锁定一段时间，解锁后获取 SOR 代币作为奖励。</p>
<h1 id="trace-分析">Trace 分析</h1>
<h2 id="准备交易">准备交易</h2>
<p>在 2024-12-21 11:58:11 (UTC)，攻击者进行了一笔 <code>deposit</code> 操作。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102638233-1468163946.png" alt="image" loading="lazy"></p>
<h2 id="攻击交易">攻击交易</h2>
<p>由于三笔攻击交易类似，所以只分析其中一笔。</p>
<p>在 <code>deposit</code> 操作的 13 天后，攻击者进行了后续的攻击操作。攻击者反复调用 <code>withdraw</code> 函数，虽然每次只取回 <code>_amount = 1</code>  的代币，但是能够获得大量的奖励代币。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102650297-238973866.png" alt="image" loading="lazy"></p>
<p>然后将获得的 SOR 代币进行出售，最后支付 bundler 的费用。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102701500-1577820943.png" alt="image" loading="lazy"></p>
<h1 id="代码分析">代码分析</h1>
<p>当用户执行 <code>deposit</code> 进行质押时，合约收取质押代币，并记录仓位</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102712843-468856361.png" alt="image" loading="lazy"></p>
<p>deposite → _updatePosition → _increasePosition</p>
<p><code>_increasePosition</code> 函数记录质押的数量，时间和利率等相关信息。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102724946-809166546.png" alt="image" loading="lazy"></p>
<p>在 <code>withdraw</code> 函数中，会先计算用户的奖励代币数量 <code>rewardAmount</code>，然后将 <code>(_amount + rewardAmount) </code>一同发给用户。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102739886-111758668.png" alt="image" loading="lazy"></p>
<p>通过 <code>_calculateRewards</code> 函数来计算奖励金额。</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202501/1483609-20250106102756295-976392901.png" alt="image" loading="lazy"></p>
<p>代码问题：</p>
<ol>
<li>每次所领取的奖励金额都是按照用户质押的总金额来计算的，而不是当前取款数额对应的奖励金额。</li>
<li><code>withdraw</code> 函数可以将质押金额进行分批提取。</li>
</ol>
<p>所以攻击者通过多次调用 <code>withdraw</code> 函数来赎回部分质押代币，却每次都能获取到对应所有质押金额的奖励代币，最终获得超额的收益。</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.1596279323287037" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-06 10:32">2025-01-06 10:32</span>&nbsp;
<a href="https://www.cnblogs.com/ACaiGarden">ACai_sec</a>&nbsp;
阅读(<span id="post_view_count">52</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18654742" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18654742);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18654742', targetLink: 'https://www.cnblogs.com/ACaiGarden/p/18654742', title: '【漏洞分析】20250105-SorraStaking：奖励金额计算错误，每次取款都有大收益' })">举报</a>
</div>
        