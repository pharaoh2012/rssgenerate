
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lyhabc/p/18691593/sql-server-s3-compatibility-backup-restore" title="发布于 2025-02-10 08:00">
    <span role="heading" aria-level="2">SQL Server 2022新功能：将数据库备份到S3兼容的对象存储</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1 style="text-align: center;">SQL Server 2022新功能：将数据库备份到S3兼容的对象存储</h1>
<p data-tool="mdnice编辑器">本文介绍将S3兼容的对象存储用作数据库备份目标所需的概念、要求和组件。 数据库备份和恢复功能在概念上类似于使用SQL Server备份到Azure Blob存储的URL作为备份设备类型。</p>
<p data-tool="mdnice编辑器"><strong><span style="color: #ff0000;">要注意的是，不只是amazon S3对象存储，只要兼容S3协议的对象存储都可以备份。</span></strong></p>
<h3 data-tool="mdnice编辑器">对象存储集成功能</h3>
<p data-tool="mdnice编辑器">SQL Server 2022（16.x）引入了对象存储集成功能，使您可以将SQL Server与S3兼容的对象存储集成。为了提供这种集成，SQL Server支持一个S3连接器，它使用S3 REST API连接到任何S3兼容的对象存储提供商。SQL Server 2022（16.x）通过增加对使用REST API的新S3连接器的支持，扩展了现有的BACKUP/RESTORE TO/FROM URL命令的语法。</p>
<ul class="list-paddingleft-1">
<li>
<p>指向S3兼容资源的URL以s3://为前缀，表示正在使用S3连接器。以s3://开头的URL始终假定底层协议为https。</p>
</li>
<li>
<p>文件编号和文件大小限制 为了存储数据，S3兼容对象存储提供商必须将文件分割成多个称为“部分”的块，这类似于微软Azure Blob存储中的块Blob。</p>
</li>
</ul>
<h4 data-tool="mdnice编辑器">S3端点的前提条件</h4>
<p data-tool="mdnice编辑器">S3端点必须按以下方式配置：</p>
<ul class="list-paddingleft-1">
<li>
<p>1、必须配置TLS。假定所有连接将通过HTTPS而非HTTP进行安全传输。端点通过安装在SQL Server操作系统主机上的证书进行验证。</p>
</li>
<li>
<p>2、在S3兼容的对象存储中创建凭据，具有执行操作所需的适当权限。在存储层上创建的用户和密码被称为访问密钥ID（Access Key ID）和秘密密钥ID（Secret Key ID）。您需要这两个密钥才能对S3端点进行身份验证。</p>
</li>
<li>
<p>3、至少配置了一个存储桶。</p>
</li>
</ul>
<h4 data-tool="mdnice编辑器">Linux平台支持</h4>
<p data-tool="mdnice编辑器">SQL Server使用 WinHttp 实现其所使用的HTTP REST API客户端。它依赖操作系统证书存储来验证由HTTP(S)端点提供的TLS证书。然而，在Linux平台上运行的SQL Server的CA证书必须放置在一个预定义的位置，即/var/opt/mssql/security/ca-certificates 文件夹中，且该文件夹最多只能存储和支持前50个证书。在启动SQL Server进程之前，必须将CA证书放置在该位置。SQL Server在启动时从该文件夹读取证书，并将它们添加到信任存储中。</p>
<h3 data-tool="mdnice编辑器">示例</h3>
<ul class="list-paddingleft-1">
<li>创建凭据</li>
</ul>
<p data-tool="mdnice编辑器">凭据的名称应提供存储路径，并且根据存储平台的不同有多个标准。</p>
<p data-tool="mdnice编辑器">当使用S3连接器时，IDENTITY应始终为 'S3 Access Key'。 Access Key ID和Secret Key ID中不得包含冒号。 Access Key ID和Secret Key ID是在S3兼容的对象存储上创建的用户名和密码。 Access Key ID 必须具有适当的权限来访问S3兼容的对象存储中的数据。 使用CREATE CREDENTIAL创建服务器级凭据以进行与S3兼容的对象存储端点的身份验证。</p>
<p data-tool="mdnice编辑器">AWS S3 支持两种不同的 URL 标准。</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>S3://&lt;BUCKET_NAME&gt;.S3.&lt;REGION&gt;.AMAZONAWS.COM/&lt;FOLDER&gt;（默认）
S3://S3.&lt;REGION&gt;.AMAZONAWS.COM/&lt;BUCKET_NAME&gt;/&lt;FOLDER&gt;</code></pre>
<p data-tool="mdnice编辑器">代码如下:</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>USE [master];
GO
CREATE CREDENTIAL [s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;]
WITH
&nbsp; &nbsp; &nbsp; &nbsp; IDENTITY &nbsp; &nbsp;=&nbsp;'S3 Access Key',
&nbsp; &nbsp; &nbsp; &nbsp; SECRET &nbsp; &nbsp; &nbsp;=&nbsp;'&lt;AccessKeyID&gt;:&lt;SecretKeyID&gt;';
GO

BACKUP DATABASE [SQLTestDB]
TO &nbsp; &nbsp; &nbsp;URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/SQLTestDB.bak'
WITH &nbsp; &nbsp;FORMAT ,STATS = 10, COMPRESSION;</code></pre>
<p data-tool="mdnice编辑器">有多种方法可以为AWS的S3对象存储创建凭据。</p>
<ul class="list-paddingleft-1">
<li>S3 存储桶名称：datavirtualizationsample</li>
<li>S3 存储桶区域：us-west-2</li>
<li>S3 存储桶文件夹：backup</li>
</ul>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>CREATE CREDENTIAL [s3://datavirtualizationsample.s3.us-west-2.amazonaws.com/backup]
WITH &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; IDENTITY &nbsp; &nbsp;=&nbsp;'S3 Access Key'
, &nbsp; &nbsp; &nbsp; SECRET &nbsp; &nbsp; &nbsp;=&nbsp;'accesskey:secretkey';
GO

BACKUP DATABASE [AdventureWorks2022]
TO URL &nbsp;=&nbsp;'s3://datavirtualizationsample.s3.us-west-2.amazonaws.com/backup/AdventureWorks2022.bak'
WITH COMPRESSION, FORMAT, MAXTRANSFERSIZE = 20971520;
GO
--或者
CREATE CREDENTIAL [s3://s3.us-west-2.amazonaws.com/datavirtualizationsample/backup]
WITH &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; IDENTITY &nbsp; &nbsp;=&nbsp;'S3 Access Key'
, &nbsp; &nbsp; &nbsp; SECRET &nbsp; &nbsp; &nbsp;=&nbsp;'accesskey:secretkey';
GO

BACKUP DATABASE [AdventureWorks2022]
TO URL &nbsp;=&nbsp;'s3://s3.us-west-2.amazonaws.com/datavirtualizationsample/backup/AdventureWorks2022.bak'
WITH COMPRESSION, FORMAT, MAXTRANSFERSIZE = 20971520;
GO</code></pre>
<h4 data-tool="mdnice编辑器">备份到 URL和从 URL 恢复</h4>
<p data-tool="mdnice编辑器">备份到 URL</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>以下示例将执行完整的数据库进行备份文件分割，然后备份到对象存储端点：
BACKUP DATABASE &lt;db_name&gt;
TO &nbsp; &nbsp; &nbsp;URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_01.bak'
, &nbsp; &nbsp; &nbsp; URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_02.bak'
, &nbsp; &nbsp; &nbsp; URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_03.bak'
WITH &nbsp; &nbsp;FORMAT ,STATS = 10, COMPRESSION;</code></pre>
<p data-tool="mdnice编辑器">从 URL 恢复</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>以下示例将从对象存储端点位置执行数据库恢复：
RESTORE DATABASE &lt;db_name&gt;
FROM &nbsp; &nbsp;URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_01.bak'
, &nbsp; &nbsp; &nbsp; URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_02.bak'
, &nbsp; &nbsp; &nbsp; URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/&lt;database&gt;_03.bak'
WITH &nbsp; &nbsp;REPLACE , &nbsp;STATS &nbsp;= 10;</code></pre>
<h4 data-tool="mdnice编辑器"><img src="https://img2024.cnblogs.com/blog/257159/202501/257159-20250126110117369-1281796698.png" alt="" width="900" height="239"></h4>
<p><img src="https://img2024.cnblogs.com/blog/257159/202501/257159-20250126110124832-608109406.png" alt="" width="902" height="430"></p>
<p id="1737860485474">&nbsp;</p>
<p id="1737860477833">&nbsp;</p>
<h4 data-tool="mdnice编辑器">加密和压缩备份选项</h4>
<p data-tool="mdnice编辑器">以下示例展示如何使用加密和压缩来备份和恢复 AdventureWorks2022 数据库：</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>CREATE MASTER KEY ENCRYPTION BY PASSWORD = &lt;password&gt;;
GO

CREATE CERTIFICATE AdventureWorks2022Cert
&nbsp; &nbsp; WITH SUBJECT =&nbsp;'AdventureWorks2022 Backup Certificate';
GO
-- 备份数据库
BACKUP DATABASE AdventureWorks2022
TO URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/AdventureWorks2022_Encrypt.bak'
WITH FORMAT, COMPRESSION,
ENCRYPTION (ALGORITHM = AES_256, SERVER CERTIFICATE = AdventureWorks2022Cert)
GO

-- 恢复数据库
RESTORE DATABASE AdventureWorks2022
FROM URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/AdventureWorks2022_Encrypt.bak'
WITH REPLACE</code></pre>
<h4 data-tool="mdnice编辑器">使用区域参数进行备份和恢复</h4>
<p data-tool="mdnice编辑器">以下示例展示如何使用REGION_OPTIONS选项进行备份和恢复 AdventureWorks2022 数据库：</p>
<p data-tool="mdnice编辑器">您可以在每个BACKUP / RESTORE命令中添加区域参数。 请注意，在BACKUP_OPTIONS和RESTORE_OPTIONS中使用了S3存储特定的区域字符串， 例如 '{"s3": {"region":"us-west-2"}}'。默认区域是 us-east-1。</p>
<pre class="highlighter-hljs" data-tool="mdnice编辑器"><code>-- 备份数据库
BACKUP DATABASE AdventureWorks2022
TO URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/AdventureWorks2022.bak'
WITH BACKUP_OPTIONS =&nbsp;'{"s3": {"region":"us-west-2"}}'

-- 恢复数据库
RESTORE DATABASE AdventureWorks2022
FROM URL =&nbsp;'s3://&lt;endpoint&gt;:&lt;port&gt;/&lt;bucket&gt;/AdventureWorks2022.bak'
WITH &nbsp;RESTORE_OPTIONS =&nbsp;'{"s3": {"region":"us-west-2"}}'</code></pre>
<h3 data-tool="mdnice编辑器">&nbsp;</h3>
<p>SQL Server 2008的压缩备份是一个新特性，根据实际使用中的观察，压缩比至少<span style="font-size: 18px; color: #ff0000;"><strong>在1:5左右</strong></span>，也就是备份时增加了压缩选项（COMPRESSION）后可以至少压缩到数据文件大小的20%甚至更低，<br>可以很大程度上加快备份执行时间，减轻IO压力和节省备份服务器的磁盘存储空间。</p>
<pre class="language-rust highlighter-hljs"><code>-- 备份数据库
BACKUP DATABASE SQLTestDB TO DISK = 'c:\tmp\SQLTestDB.bak'  WITH stats =5 , COMPRESSION 
GO</code></pre>
<h3 data-tool="mdnice编辑器">&nbsp;</h3>
<p>&nbsp;</p>
<h3 data-tool="mdnice编辑器">总结</h3>
<p data-tool="mdnice编辑器">SQL Server 2022通过新引入的S3连接器，SQL Server能够支持通过REST API与S3兼容存储集成。用户可以配置存储桶和凭据，通过URL指向存储位置进行备份和恢复。此外，还提供了加密、压缩等备份选项，以及在Linux平台上的特殊配置要求。示例展示了如何创建凭据、执行备份和恢复操作，支持区域参数指定备份和恢复的地域。</p>
<p data-tool="mdnice编辑器">&nbsp;</p>
<p data-tool="mdnice编辑器">&nbsp;</p>
<p><strong>参考文章</strong></p>
<p>https://learn.microsoft.com/en-us/sql/relational-databases/backup-restore/sql-server-backup-to-url-s3-compatible-object-storage?view=sql-server-ver16&amp;viewFallbackFrom=sql-server-ver15</p>
<p>https://aws.amazon.com/cn/blogs/modernizing-with-aws/backup-sql-server-to-amazon-s3/</p>
<p>https://www.mssqltips.com/sqlservertip/7302/backup-sql-server-2022-database-aws-s3-storage/</p>
<p>&nbsp;</p>
<p>&nbsp;<img src="https://img2024.cnblogs.com/blog/257159/202409/257159-20240908204310924-1005667056.png" alt="" class="medium-zoom-image"></p>
<p><strong>本文版权归作者所有，未经作者同意不得转载。</strong></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.04239337264120371" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-10 08:00">2025-02-10 08:00</span>&nbsp;
<a href="https://www.cnblogs.com/lyhabc">桦仔</a>&nbsp;
阅读(<span id="post_view_count">107</span>)&nbsp;
评论(<span id="post_comment_count">1</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18691593" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18691593);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18691593', targetLink: 'https://www.cnblogs.com/lyhabc/p/18691593/sql-server-s3-compatibility-backup-restore', title: 'SQL Server 2022新功能：将数据库备份到S3兼容的对象存储' })">举报</a>
</div>
        