
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/2YSP/p/18716104" title="å‘å¸ƒäº 2025-02-14 20:44">
    <span role="heading" aria-level="2">SpringCloudè‡ªå®šä¹‰loadbalancerå®ç°æ ‡ç­¾è·¯ç”±</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä¸€èƒŒæ™¯">ä¸€ã€èƒŒæ™¯</h1>
<p>&nbsp;&nbsp;æœ€è¿‘å‰ç«¯ååº”å¼€å‘ç¯å¢ƒæœ‰æ—¶å€™è°ƒæ¥å£ä¼šå¾ˆæ…¢ï¼ŒåŸå› æ˜¯æœ‰å¼€å‘å›¾æ–¹ä¾¿å°†æœ¬åœ°æœåŠ¡æ³¨å†Œåˆ°å¼€å‘ç¯å¢ƒï¼Œè¯·æ±‚è·¯ç”±åˆ°å¼€å‘æœ¬åœ°å¯¼è‡´ï¼Œ</p>
<p>ä¸ºäº†è§£å†³è¯¥é—®é¢˜æƒ³åˆ°å¯ä»¥é€šè¿‡æ ‡ç­¾è·¯ç”±çš„æ–¹å¼é¿å…è¯¥é—®é¢˜ï¼Œå®ç°å‰ç«¯è”è°ƒå’Œå¼€å‘è‡ªæµ‹äº’ä¸å¹²æ‰°ã€‚</p>
<p>&nbsp;&nbsp;è¯¥æ–¹æ¡ˆé™¤äº†ç”¨äºæœ¬åœ°è°ƒè¯•ï¼Œè¿˜å¯ä»¥ç”¨äºç”¨æˆ·ç°åº¦å‘å¸ƒã€‚</p>
<h1 id="äºŒå®ç°æ–¹æ¡ˆ">äºŒã€å®ç°æ–¹æ¡ˆ</h1>
<p>&nbsp;&nbsp;å…³äºè´Ÿè½½å‡è¡¡ï¼Œä½ç‰ˆæœ¬çš„SpringCloudç”¨çš„æ˜¯Spring Cloud Ribbonï¼Œé«˜ç‰ˆæœ¬ç”¨Spring Cloud LoadBalanceræ›¿ä»£äº†ï¼Œ</p>
<p>Ribbonå¯ä»¥é€šè¿‡å®ç°IRlueæ¥å£å®ç°ï¼Œè¿™é‡Œåªä»‹ç»é«˜ç‰ˆæœ¬çš„å®ç°æ–¹æ¡ˆã€‚</p>
<p><strong>å®ç°æ–¹æ¡ˆï¼š</strong></p>
<ol>
<li>
<p>ideaåœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®tagï¼Œæœ¬åœ°æœåŠ¡å¯åŠ¨æ—¶è¯»å–ç¯å¢ƒå˜é‡å°†tagæ³¨å†Œåˆ°nacosçš„å…ƒæ•°æ®</p>
</li>
<li>
<p>é‡å†™ç½‘å…³çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»è¯·æ±‚å¤´ä¸­è·å–åˆ°çš„request-tagå’ŒæœåŠ¡å®ä¾‹çš„å…ƒæ•°æ®è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°åˆ™è¿”å›å¯¹åº”çš„</p>
<p>æœåŠ¡å®ä¾‹ï¼Œå¦åˆ™æç¤ºæœåŠ¡æœªæ‰¾åˆ°ã€‚</p>
</li>
</ol>
<h1 id="ä¸‰ç¼–ç å®ç°">ä¸‰ã€ç¼–ç å®ç°</h1>
<h2 id="31-orderæœåŠ¡">3.1 orderæœåŠ¡</h2>
<p>æ–°å»ºä¸€ä¸ªSpringCloudæœåŠ¡order-serviceï¼Œæ³¨å†Œå…ƒæ•°æ®å¾ˆç®€å•ï¼Œåªéœ€è¦æ’é™¤æ‰NacosDiscoveryClientConfigurationï¼Œå†å†™ä¸€ä¸ªè‡ªå·±çš„NacosDiscoveryClientConfigurationé…ç½®ç±»å³å¯ã€‚</p>
<p>åˆ›å»ºMyNacosDiscoveryClientConfiguration</p>
<pre><code class="language-java">/**
 * @Author: Ship
 * @Description:
 * @Date: Created in 2025/2/12
 */
@Configuration(
        proxyBeanMethods = false
)
@ConditionalOnDiscoveryEnabled
@ConditionalOnBlockingDiscoveryEnabled
@ConditionalOnNacosDiscoveryEnabled
@AutoConfigureBefore({SimpleDiscoveryClientAutoConfiguration.class, CommonsClientAutoConfiguration.class})
@AutoConfigureAfter({NacosDiscoveryAutoConfiguration.class})
public class MyNacosDiscoveryClientConfiguration {



    @Bean
    public DiscoveryClient nacosDiscoveryClient(NacosServiceDiscovery nacosServiceDiscovery) {
        return new NacosDiscoveryClient(nacosServiceDiscovery);
    }

    @Bean
    @ConditionalOnProperty(
            value = {"spring.cloud.nacos.discovery.watch.enabled"},
            matchIfMissing = true
    )
    public NacosWatch nacosWatch(NacosServiceManager nacosServiceManager, NacosDiscoveryProperties nacosDiscoveryProperties,
                                 ObjectProvider&lt;ThreadPoolTaskScheduler&gt; taskExecutorObjectProvider, Environment environment) {
        // ç¯å¢ƒå˜é‡è¯»å–æ ‡ç­¾
        String tag = environment.getProperty("tag");
        nacosDiscoveryProperties.getMetadata().put("request-tag", tag);
        return new NacosWatch(nacosServiceManager, nacosDiscoveryProperties, taskExecutorObjectProvider);
    }
}
</code></pre>
<p>è¿™é‡Œä»£ç åŸºæœ¬ä¸NacosDiscoveryClientConfigurationä¸€è‡´ï¼Œåªæ˜¯åŠ ä¸Šäº†è®¾ç½®å…ƒæ•°æ®çš„é€»è¾‘ã€‚</p>
<pre><code class="language-java">@SpringBootApplication(exclude = NacosDiscoveryClientConfiguration.class)
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

}
</code></pre>
<p>å¯åŠ¨ç±»ä¸Šéœ€è¦æ’é™¤é»˜è®¤çš„NacosDiscoveryClientConfigurationï¼Œä¸ç„¶å¯åŠ¨ä¼šæŠ¥beané‡å¤æ³¨å†Œçš„é”™è¯¯ï¼Œæˆ–è€…é…ç½®æ·»åŠ <strong>spring.main.allow-bean-definition-overriding=true</strong>å…è®¸é‡å¤æ³¨å†Œä¹Ÿè¡Œã€‚</p>
<p>å†™ä¸€ä¸ªæµ‹è¯•æ¥å£ï¼Œæ–¹ä¾¿åé¢æµ‹è¯•</p>
<pre><code class="language-java">/**
 * @Author: Ship
 * @Description:
 * @Date: Created in 2025/2/12
 */
@RequestMapping("test")
@RestController
public class TestController {


    @GetMapping("")
    public String sayHello(){
        return "hello";
    }
}

</code></pre>
<h2 id="32-gatewayæœåŠ¡">3.2 gatewayæœåŠ¡</h2>
<p>æ–°å»ºä¸€ä¸ªç½‘å…³æœåŠ¡ï¼Œpomæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre><code class="language-xml"> &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;2020.0.3&lt;/spring-cloud.version&gt;
        &lt;spring-cloud-alibaba.version&gt;2021.1&lt;/spring-cloud-alibaba.version&gt;
        &lt;spring-boot.version&gt;2.5.1&lt;/spring-boot.version&gt;
        &lt;maven-compiler-plugin.version&gt;3.1&lt;/maven-compiler-plugin.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;version&gt;${spring-boot.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;${spring-boot.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud-alibaba.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud-alibaba.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;

            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-boot.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;

            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;


    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;${maven-compiler-plugin.version}&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;${java.version}&lt;/source&gt;
                    &lt;target&gt;${java.version}&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
</code></pre>
<p>Spring-Cloud-loadBalanceré»˜è®¤ä½¿ç”¨è½®è¯¢çš„ç®—æ³•ï¼Œå³org.springframework.cloud.loadbalancer.core.RoundRobinLoadBalancerç±»å®ç°ï¼Œå› æ­¤å¯ä»¥å‚è€ƒRoundRobinLoadBalancerå®ç°ä¸€ä¸ªTagLoadBalancerï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">/**
 * @Author: Ship
 * @Description:
 * @Date: Created in 2025/2/12
 */
public class TagLoadBalancer implements ReactorServiceInstanceLoadBalancer {

    private static final String TAG_HEADER = "request-tag";

    private static final Log log = LogFactory.getLog(TagLoadBalancer.class);
    final AtomicInteger position;
    final String serviceId;
    ObjectProvider&lt;ServiceInstanceListSupplier&gt; serviceInstanceListSupplierProvider;

    public TagLoadBalancer(ObjectProvider&lt;ServiceInstanceListSupplier&gt; serviceInstanceListSupplierProvider, String serviceId) {
        this(serviceInstanceListSupplierProvider, serviceId, (new Random()).nextInt(1000));
    }

    public TagLoadBalancer(ObjectProvider&lt;ServiceInstanceListSupplier&gt; serviceInstanceListSupplierProvider, String serviceId, int seedPosition) {
        this.serviceId = serviceId;
        this.serviceInstanceListSupplierProvider = serviceInstanceListSupplierProvider;
        this.position = new AtomicInteger(seedPosition);
    }

    @Override
    public Mono&lt;Response&lt;ServiceInstance&gt;&gt; choose(Request request) {
        ServiceInstanceListSupplier supplier = (ServiceInstanceListSupplier) this.serviceInstanceListSupplierProvider.getIfAvailable(NoopServiceInstanceListSupplier::new);
        return supplier.get(request).next().map((serviceInstances) -&gt; {
            return this.processInstanceResponse(supplier, serviceInstances, request);
        });
    }

    private Response&lt;ServiceInstance&gt; processInstanceResponse(ServiceInstanceListSupplier supplier, List&lt;ServiceInstance&gt; serviceInstances, Request request) {
        Response&lt;ServiceInstance&gt; serviceInstanceResponse = this.getInstanceResponse(serviceInstances, request);
        if (supplier instanceof SelectedInstanceCallback &amp;&amp; serviceInstanceResponse.hasServer()) {
            ((SelectedInstanceCallback) supplier).selectedServiceInstance((ServiceInstance) serviceInstanceResponse.getServer());
        }

        return serviceInstanceResponse;
    }

    private Response&lt;ServiceInstance&gt; getInstanceResponse(List&lt;ServiceInstance&gt; instances, Request request) {
        if (instances.isEmpty()) {
            if (log.isWarnEnabled()) {
                log.warn("No servers available for service: " + this.serviceId);
            }
            return new EmptyResponse();
        }
        if (request instanceof DefaultRequest) {
            DefaultRequest&lt;RequestDataContext&gt; defaultRequest = (DefaultRequest) request;
            // ä¸Šä¸‹æ–‡è·å–è¯·æ±‚å¤´
            HttpHeaders headers = defaultRequest.getContext().getClientRequest().getHeaders();
            List&lt;String&gt; list = headers.get(TAG_HEADER);
            if (!CollectionUtils.isEmpty(list)) {
                String requestTag = list.get(0);
                for (ServiceInstance instance : instances) {
                    String str = instance.getMetadata().getOrDefault(TAG_HEADER, "");
                    if (requestTag.equals(str)) {
                        return new DefaultResponse(instance);
                    }
                }
                log.error(String.format("No servers available for service:%s,tag:%s ", this.serviceId, requestTag));
                return new EmptyResponse();
            }
        }

        int pos = Math.abs(this.position.incrementAndGet());
        ServiceInstance instance = instances.get(pos % instances.size());
        return new DefaultResponse(instance);
    }
}

</code></pre>
<p>è¿™é‡Œéœ€è¦å®ç°ReactorServiceInstanceLoadBalanceræ¥å£ï¼Œå¦‚æœè¯·æ±‚å¤´å¸¦æœ‰æ ‡ç­¾åˆ™æ ¹æ®æ ‡ç­¾è·¯ç”±ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„è½®è¯¢ç®—æ³•ã€‚</p>
<p>è¿˜è¦æŠŠTagLoadBalancerç”¨èµ·æ¥ï¼Œæ‰€ä»¥éœ€è¦<strong>å®šä¹‰ä¸€ä¸ªé…ç½®ç±»TagLoadBalancerConfigï¼Œå¹¶é€šè¿‡@LoadBalancerClientsæ³¨è§£æ·»åŠ é»˜è®¤é…ç½®</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">/**
 * @Author: Ship
 * @Description:
 * @Date: Created in 2025/2/12
 */
public class TagLoadBalancerConfig {

    @Bean
    public ReactorLoadBalancer reactorTagLoadBalancer(Environment environment, LoadBalancerClientFactory loadBalancerClientFactory) {
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        return new TagLoadBalancer(loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);
    }
}

@LoadBalancerClients(defaultConfiguration = {TagLoadBalancerConfig.class})
@SpringBootApplication
public class GatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }

}
</code></pre>
<p>æœ€ååœ¨application.ymlæ–‡ä»¶æ·»åŠ ç½‘å…³è·¯ç”±é…ç½®</p>
<pre><code class="language-yml">spring:
  application:
    name: gateway
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        namespace: dev
        group: DEFAULT_GROUP
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: dev
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            - StripPrefix=1
server:
  port: 9000


</code></pre>
<h2 id="33-ä»£ç æµ‹è¯•">3.3 ä»£ç æµ‹è¯•</h2>
<ul>
<li>
<p>æœ¬åœ°å¯åŠ¨nacosåå¯åŠ¨orderï¼ˆæ³¨æ„éœ€è¦åœ¨ideaè®¾ç½®ç¯å¢ƒå˜é‡<strong>tag=ship</strong>ï¼‰å’ŒgatewayæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°orderæœåŠ¡å·²ç»æˆåŠŸæ³¨å†Œäº†å…ƒæ•°æ®</p>
<p><img src="https://img2024.cnblogs.com/blog/1167086/202502/1167086-20250214200126345-92449439.png" alt="image" loading="lazy"></p>
</li>
<li>
<p>ç„¶åç”¨Postmanè¯·æ±‚ç½‘å…³http://localhost:9000/order/test</p>
</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1167086/202502/1167086-20250214200756094-720647598.png" alt="image" loading="lazy"></p>
<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚æˆåŠŸè·¯ç”±åˆ°äº†orderæœåŠ¡ï¼Œè¯´æ˜æ ¹æ®tagè·¯ç”±æˆåŠŸäº†ã€‚</p>
<ul>
<li>
<p>å»æ‰ç¯å¢ƒå˜é‡tagåé‡æ–°å¯åŠ¨OrderæœåŠ¡ï¼Œå†æ¬¡è¯·æ±‚å“åº”æŠ¥æ–‡å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
    "timestamp": "2025-02-14T12:10:44.294+00:00",
    "path": "/order/test",
    "status": 503,
    "error": "Service Unavailable",
    "requestId": "41651188-4"
}
</code></pre>
</li>
</ul>
<p>è¯´æ˜æ ¹æ®requst-tagæ‰¾ä¸åˆ°å¯¹åº”çš„æœåŠ¡å®ä¾‹ï¼Œä»£ç é€»è¾‘ç”Ÿæ•ˆäº†ã€‚</p>
<h1 id="å››æ€»ç»“">å››ã€æ€»ç»“</h1>
<p>&nbsp;&nbsp;èªæ˜çš„äººå·²ç»å‘ç°äº†ï¼Œæœ¬æ–‡åªå®ç°äº†ç½‘å…³è·¯ç”±åˆ°ä¸‹æ¸¸æœåŠ¡è¿™éƒ¨åˆ†çš„æ ‡ç­¾è·¯ç”±ï¼Œä¸‹æ¸¸æœåŠ¡Aè°ƒæœåŠ¡Bçš„æ ‡ç­¾è·¯ç”±å¹¶æœªå®ç°ï¼Œå…¶å®ç°æ–¹æ¡ˆä¹Ÿä¸éš¾ï¼Œåªéœ€è¦é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’+feignæ‹¦æˆªå™¨å°±å¯ä»¥åšåˆ°å…¨é“¾è·¯çš„æ ‡ç­¾è·¯ç”±ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±è¯•è¯•ã€‚<br><br>
&nbsp;&nbsp;æœ¬æ–‡ä»£ç å·²ä¸Šä¼ <a href="https://github.com/2YSP/custom-load-balancer" target="_blank" rel="noopener nofollow">github</a>ï¼Œé¡ºä¾¿æ¨å¹¿ä¸‹å‰æ®µæ—¶é—´å†™çš„ideaæ’ä»¶<a href="https://github.com/2YSP/CodeFaster" target="_blank" rel="noopener nofollow">CodeFaster</a>ï¼ˆå¿«é€Ÿç”Ÿæˆå¸¸ç”¨æµæ“ä½œçš„ä»£ç ï¼ŒMarketplaceæœç´¢ä¸‹è½½å³å¯ä½“éªŒï¼‰ğŸ˜‚ã€‚</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.06265035528009259" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-14 20:44">2025-02-14 20:44</span>&nbsp;
<a href="https://www.cnblogs.com/2YSP">çƒŸå‘³i</a>&nbsp;
é˜…è¯»(<span id="post_view_count">1</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18716104" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18716104);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18716104', targetLink: 'https://www.cnblogs.com/2YSP/p/18716104', title: 'SpringCloudè‡ªå®šä¹‰loadbalancerå®ç°æ ‡ç­¾è·¯ç”±' })">ä¸¾æŠ¥</a>
</div>
        