<!----> <meta itemprop="headline" content="å®ç°å¤§æ–‡ä»¶ä¸Šä¼ å…¨æµç¨‹è¯¦è§£(è¡¥å¿ç‰ˆæœ¬)"> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,é¢è¯•"> <meta itemprop="datePublished" content="2025-08-23T16:58:18.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å†å­¦ä¸€ç‚¹å°±ç¡Orz"> <meta itemprop="url" content="https://juejin.cn/user/671151992348125"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å®ç°å¤§æ–‡ä»¶ä¸Šä¼ å…¨æµç¨‹è¯¦è§£(è¡¥å¿ç‰ˆæœ¬)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/671151992348125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å†å­¦ä¸€ç‚¹å°±ç¡Orz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-08-23T16:58:18.000Z" title="Sat Aug 23 2025 16:58:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-08-23
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""></circle></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""></path></svg>
                    é˜…è¯»13åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""></div> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><p>ä¹‹å‰åˆ†äº«äº†å¤§æ–‡ä»¶ä¸Šä¼ çš„å‰ç«¯å®ç°åï¼Œä½†æ˜¯è¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰è¯´æ˜ï¼Œéš”äº†è¿™ä¹ˆä¹…åˆæ¥è€ƒå¤ä¸€ä¸‹Orz.</p>
<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¤§æ–‡ä»¶ä¸Šä¼ æ˜¯ä¸ªç»•ä¸å¼€çš„åâ€”â€”åŠ¨è¾„å‡ ç™¾ MB ç”šè‡³ GB çº§çš„æ–‡ä»¶ï¼Œç›´æ¥ä¸Šä¼ ä¸ä»…å®¹æ˜“è¶…æ—¶ï¼Œè¿˜ä¼šè®©ç”¨æˆ·ä½“éªŒå¤§æ‰“æŠ˜æ‰£ã€‚æœ€è¿‘æˆ‘ç”¨ Vue+Express å®ç°äº†ä¸€å¥—å®Œæ•´çš„å¤§æ–‡ä»¶ä¸Šä¼ æ–¹æ¡ˆï¼Œæ”¯æŒåˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ å’Œæ‰‹åŠ¨ä¸­æ–­ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶ä»å¤´åˆ°å°¾ç›˜æ¸…æ¥šå…¶ä¸­çš„æŠ€æœ¯ç»†èŠ‚ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€å…ˆçœ‹æ•ˆæœï¼šæˆ‘ä»¬è¦å®ç°ä»€ä¹ˆï¼Ÿ</h2>
<p>å…ˆä¸Šæ ¸å¿ƒåŠŸèƒ½æ¸…å•ï¼Œç¡®ä¿å¤§å®¶æ˜ç¡®ç›®æ ‡ï¼ŒçŸ¥é“æˆ‘ä»¬è¦è§£å†³å“ªäº›å®é™…é—®é¢˜ï¼š</p>
<ul>
<li>
<p><strong>å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ </strong>ï¼šå°†æ–‡ä»¶åˆ‡æˆå›ºå®šå¤§å°çš„å°ç‰‡æ®µåˆ†æ‰¹ä¸Šä¼ ï¼Œé¿å…å•æ¬¡è¯·æ±‚è¶…æ—¶</p>
</li>
<li>
<p>&nbsp;<strong>ç§’ä¼ </strong>ï¼šæœåŠ¡å™¨å·²å­˜åœ¨å®Œæ•´æ–‡ä»¶æ—¶ï¼Œç›´æ¥è¿”å›æˆåŠŸï¼Œæ— éœ€é‡å¤ä¸Šä¼ </p>
</li>
<li>
<p><strong>æ–­ç‚¹ç»­ä¼ </strong>ï¼šåˆ·æ–°é¡µé¢æˆ–ä¸Šä¼ ä¸­æ–­åï¼Œä»…ä¸Šä¼ æœªå®Œæˆçš„åˆ†ç‰‡ï¼Œæ— éœ€ä»å¤´å¼€å§‹</p>
</li>
<li>
<p><strong>å¹¶å‘æ§åˆ¶</strong>ï¼šé™åˆ¶åŒæ—¶ä¸Šä¼ çš„åˆ†ç‰‡æ•°é‡ï¼Œé¿å…è¯·æ±‚è¿‡å¤šå¯¼è‡´æµè§ˆå™¨ / æœåŠ¡å™¨å´©æºƒ</p>
</li>
<li>
<p><strong>æ‰‹åŠ¨ä¸­æ–­</strong>ï¼šæ”¯æŒç”¨æˆ·éšæ—¶åœæ­¢ä¸Šä¼ ï¼Œä¸”ä¸­æ–­åå·²ä¼ åˆ†ç‰‡ä¸ä¸¢å¤±</p>
</li>
</ul>
<p>æœ€ç»ˆäº¤äº’å¾ˆç®€æ´ï¼šä¸€ä¸ªæ–‡ä»¶é€‰æ‹©æ¡† + ä¸Šä¼ ä¸­çš„ä¸­æ–­æŒ‰é’®ï¼Œä½†èƒŒåæ˜¯ä¸€æ•´å¥—è¦†ç›–ã€Œä¸Šä¼ å‰ - ä¸Šä¼ ä¸­ - ä¸Šä¼ åã€çš„å®Œæ•´é€»è¾‘ã€‚</p>
<h2 data-id="heading-1">äºŒã€å…¨æµç¨‹æ‹†è§£ï¼šä»é€‰æ–‡ä»¶åˆ°åˆå¹¶</h2>
<p>æˆ‘ä»¬å…ˆä»å®è§‚è§†è§’æ¢³ç†æ•´ä¸ªæµç¨‹ï¼Œå†æ‹†åˆ†æˆå‰ç«¯å’Œåç«¯çš„å…·ä½“å®ç°ã€‚æ•´ä¸ªè¿‡ç¨‹å¯æ€»ç»“ä¸ºã€Œ5 æ­¥èµ°ã€ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„ç›®æ ‡å’ŒæŠ€æœ¯è¦ç‚¹ï¼š</p>
<pre><code class="hljs language-æµç¨‹" lang="æµç¨‹">ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ å‰ç«¯åˆ†ç‰‡+ç®—å“ˆå¸Œ â†’ æ ¡éªŒæ–‡ä»¶çŠ¶æ€ï¼ˆç§’ä¼ /æ–­ç‚¹ç»­ä¼ ï¼‰ â†’ å¹¶å‘ä¸Šä¼ åˆ†ç‰‡ â†’ åç«¯åˆå¹¶åˆ†ç‰‡
</code></pre>
<h3 data-id="heading-2">ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼ˆå‰ç«¯è§¦å‘ï¼‰</h3>
<p>è¿™æ˜¯æµç¨‹çš„èµ·ç‚¹ï¼Œé€šè¿‡åŸç”Ÿ&nbsp;<code>&lt;input type="file"&gt;</code>&nbsp;è·å–ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶ï¼Œåœ¨&nbsp;<code>onchange</code>&nbsp;äº‹ä»¶ä¸­è§¦å‘åç»­é€»è¾‘ã€‚</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="upload-container"&gt;
    &lt;h2&gt;å¤§æ–‡ä»¶ä¸Šä¼ æ¼”ç¤º&lt;/h2&gt;
    &lt;input @change="handleUpload" type="file" class="file-input" /&gt;
    &lt;!-- ä¸Šä¼ ä¸­æ‰æ˜¾ç¤ºä¸­æ–­æŒ‰é’® --&gt;
    &lt;button @click="abortUpload" v-if="isUploading" class="abort-btn"&gt;
      ä¸­æ–­ä¸Šä¼ 
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from "vue";

// ä¸Šä¼ çŠ¶æ€ç®¡ç†
const isUploading = ref(false); // æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
const abortControllers = ref([]); // å­˜å‚¨æ‰€æœ‰è¯·æ±‚çš„ä¸­æ–­æ§åˆ¶å™¨

const handleUpload = async (e) =&gt; {
  const file = e.target.files[0]; // è·å–ç”¨æˆ·é€‰æ‹©çš„å•ä¸ªæ–‡ä»¶
  if (!file) return; // æœªé€‰æ–‡ä»¶åˆ™é€€å‡º

  // åç»­æ ¸å¿ƒé€»è¾‘ï¼šåˆ†ç‰‡ã€ç®—å“ˆå¸Œã€æ ¡éªŒ...
  // ï¼ˆä¸‹æ–‡é€æ­¥å±•å¼€ï¼‰
};
&lt;/script&gt;

&lt;style scoped&gt;
.upload-container { margin: 20px; }
.file-input { margin-right: 10px; }
.abort-btn { padding: 4px 8px; background: #ff4444; color: white; border: none; border-radius: 4px; }
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-3">ç¬¬äºŒæ­¥ï¼šå‰ç«¯åˆ†ç‰‡ + è®¡ç®—æ–‡ä»¶å“ˆå¸Œ</h3>
<p>å¤§æ–‡ä»¶ç›´æ¥ä¸Šä¼ ä¼šè§¦å‘è¶…æ—¶ï¼Œå› æ­¤å¿…é¡»å…ˆã€Œæ‹†å°ã€ï¼›è€Œå“ˆå¸Œå€¼æ˜¯å®ç°ã€Œç§’ä¼ ã€å’Œã€Œæ–­ç‚¹ç»­ä¼ ã€çš„æ ¸å¿ƒ â€”â€” å®ƒæ˜¯æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå‘Šè¯‰æœåŠ¡å™¨ â€œè¿™æ˜¯å“ªä¸ªæ–‡ä»¶â€ã€‚</p>
<h4 data-id="heading-4">2.1 æ–‡ä»¶åˆ†ç‰‡ï¼šæŠŠå¤§æ–‡ä»¶åˆ‡æˆå°ç‰‡æ®µ</h4>
<p>ç”¨æµè§ˆå™¨åŸç”Ÿ API&nbsp;<code>File.slice()</code>&nbsp;æŒ‰å›ºå®šå¤§å°ï¼ˆè¿™é‡Œè®¾ä¸º 1MBï¼‰åˆ‡å‰²æ–‡ä»¶ï¼Œå¾—åˆ°å¤šä¸ª&nbsp;<code>Blob</code>&nbsp;å¯¹è±¡ï¼ˆå³ã€Œåˆ†ç‰‡ã€ï¼‰ã€‚</p>
<p>è¿è¡Œ</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// åˆ†ç‰‡å¤§å°ï¼š1MBï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼Œå¦‚5MB/10MBï¼‰</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; 

<span class="hljs-comment">/**
 * ç”Ÿæˆæ–‡ä»¶åˆ†ç‰‡æ•°ç»„
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - ç”¨æˆ·é€‰æ‹©çš„åŸå§‹æ–‡ä»¶
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Blob[]</span>} åˆ†ç‰‡æ•°ç»„
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createChunks</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">let</span> cur = <span class="hljs-number">0</span>; <span class="hljs-comment">// å½“å‰åˆ‡å‰²ä½ç½®</span>
  <span class="hljs-keyword">let</span> chunks = [];
  <span class="hljs-keyword">while</span> (cur &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-comment">// ä»å½“å‰ä½ç½®åˆ‡å‰²åˆ°ã€Œå½“å‰ä½ç½®+åˆ†ç‰‡å¤§å°ã€ï¼Œæœ€åä¸€ç‰‡å¯èƒ½ä¸è¶³1MB</span>
    <span class="hljs-keyword">const</span> blob = file.<span class="hljs-title function_">slice</span>(cur, cur + <span class="hljs-variable constant_">CHUNK_SIZE</span>);
    chunks.<span class="hljs-title function_">push</span>(blob);
    cur += <span class="hljs-variable constant_">CHUNK_SIZE</span>;
  }
  <span class="hljs-keyword">return</span> chunks;
};

<span class="hljs-comment">// ç¤ºä¾‹ï¼š3.5MB çš„æ–‡ä»¶ä¼šç”Ÿæˆ 4 ä¸ªåˆ†ç‰‡ï¼ˆ1MB+1MB+1MB+0.5MBï¼‰</span>
</code></pre>
<h4 data-id="heading-5">2.2 è®¡ç®—æ–‡ä»¶å“ˆå¸Œï¼šç”Ÿæˆå”¯ä¸€æ ‡è¯†</h4>
<p>ç”¨&nbsp;<code>spark-md5</code>&nbsp;åº“è®¡ç®—æ–‡ä»¶å“ˆå¸Œï¼Œä½†æœ‰ä¸ªå…³é”®ä¼˜åŒ–ï¼š<strong>ä¸è¯»å–æ•´ä¸ªæ–‡ä»¶</strong>ï¼Œè€Œæ˜¯æŠ½æ ·è¯»å–éƒ¨åˆ†ç‰‡æ®µï¼ˆé¦–å°¾åˆ†ç‰‡å…¨é‡ + ä¸­é—´åˆ†ç‰‡æŠ½æ ·ï¼‰ï¼Œæ—¢èƒ½ä¿è¯å“ˆå¸Œå”¯ä¸€æ€§ï¼Œåˆèƒ½å¤§å¹…æå‡å¤§æ–‡ä»¶çš„è®¡ç®—é€Ÿåº¦ã€‚</p>
<p>å…ˆå®‰è£…ä¾èµ–ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">npm install spark-md5 --save
</code></pre>
<p>å†å®ç°å“ˆå¸Œè®¡ç®—é€»è¾‘ï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> sparkMD5 <span class="hljs-keyword">from</span> <span class="hljs-string">"spark-md5"</span>;

<span class="hljs-comment">/**
 * è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆæŠ½æ ·ä¼˜åŒ–ï¼‰
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Blob[]</span>} <span class="hljs-variable">chunks</span> - åˆ†ç‰‡æ•°ç»„
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;string&gt;</span>} æ–‡ä»¶å“ˆå¸Œå€¼
 */</span>
 <span class="hljs-keyword">const</span> <span class="hljs-title function_">calHash</span> = (<span class="hljs-params">chunks</span>) =&gt; {
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
 <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> sparkMD5.<span class="hljs-title class_">ArrayBuffer</span>(); <span class="hljs-comment">// åˆå§‹åŒ–MD5è®¡ç®—å™¨</span>
 <span class="hljs-keyword">const</span> fileReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(); <span class="hljs-comment">// ç”¨äºè¯»å–Blobå†…å®¹</span>
 <span class="hljs-keyword">const</span> targets = []; <span class="hljs-comment">// å­˜æ”¾æŠ½æ ·çš„ç‰‡æ®µï¼ˆç”¨äºè®¡ç®—å“ˆå¸Œï¼‰</span>

 <span class="hljs-comment">// æŠ½æ ·ç­–ç•¥ï¼šé¦–å°¾åˆ†ç‰‡å…¨é‡ï¼Œä¸­é—´åˆ†ç‰‡å–3ä¸ª2å­—èŠ‚ç‰‡æ®µï¼ˆå…±6å­—èŠ‚ï¼‰</span>
 chunks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">chunk, index</span>) =&gt;</span> {
 <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span> || index === chunks.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// é¦–å°¾åˆ†ç‰‡ï¼šå…¨é‡åŠ å…¥æŠ½æ ·</span>
    targets.<span class="hljs-title function_">push</span>(chunk);
  } <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// ä¸­é—´åˆ†ç‰‡ï¼šå–å‰2å­—èŠ‚ã€ä¸­é—´2å­—èŠ‚ã€å2å­—èŠ‚</span>
    targets.<span class="hljs-title function_">push</span>(chunk.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>));
    targets.<span class="hljs-title function_">push</span>(chunk.<span class="hljs-title function_">slice</span>(<span class="hljs-variable constant_">CHUNK_SIZE</span> / <span class="hljs-number">2</span>, <span class="hljs-variable constant_">CHUNK_SIZE</span> / <span class="hljs-number">2</span> + <span class="hljs-number">2</span>));
    targets.<span class="hljs-title function_">push</span>(chunk.<span class="hljs-title function_">slice</span>(<span class="hljs-variable constant_">CHUNK_SIZE</span> - <span class="hljs-number">2</span>, <span class="hljs-variable constant_">CHUNK_SIZE</span>));
   }
 });

 <span class="hljs-comment">// è¯»å–æŠ½æ ·ç‰‡æ®µå¹¶è®¡ç®—å“ˆå¸Œ</span>
 fileReader.<span class="hljs-title function_">readAsArrayBuffer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>(targets));
 fileReader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
 spark.<span class="hljs-title function_">append</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>); <span class="hljs-comment">// ç´¯åŠ æ•°æ®</span>
 <span class="hljs-title function_">resolve</span>(spark.<span class="hljs-title function_">end</span>()); <span class="hljs-comment">// ç”Ÿæˆæœ€ç»ˆå“ˆå¸Œå€¼ï¼ˆå¦‚ï¼š"a1b2c3d4e5"ï¼‰</span>
   };
  });
 };
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆæŠ½æ ·ï¼Ÿ</strong><br>
å¦‚æœæ˜¯ 1GB çš„æ–‡ä»¶ï¼Œå…¨é‡è¯»å–è®¡ç®—å“ˆå¸Œå¯èƒ½éœ€è¦å‡ ç§’ç”šè‡³åå‡ ç§’ï¼›æŠ½æ ·åä»…è¯»å–å‡ åå­—èŠ‚ï¼Œè€—æ—¶å¯å‹ç¼©åˆ°å‡ ç™¾æ¯«ç§’ï¼Œç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥ã€‚</p>
<h3 data-id="heading-6">ç¬¬ä¸‰æ­¥ï¼šæ ¡éªŒæ–‡ä»¶çŠ¶æ€ï¼ˆå‰åç«¯é…åˆï¼‰</h3>
<p>æ‹¿åˆ°æ–‡ä»¶å“ˆå¸Œåï¼Œå‰ç«¯éœ€è¦å…ˆå‘åç«¯å‘ã€Œæ ¡éªŒè¯·æ±‚ã€ï¼Œåˆ¤æ–­ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š</p>
<ol>
<li>æœåŠ¡å™¨æ˜¯å¦å·²å­˜åœ¨å®Œæ•´æ–‡ä»¶ï¼Ÿï¼ˆå†³å®šæ˜¯å¦ç§’ä¼ ï¼‰</li>
<li>æœåŠ¡å™¨æ˜¯å¦æœ‰éƒ¨åˆ†å·²ä¸Šä¼ çš„åˆ†ç‰‡ï¼Ÿï¼ˆå†³å®šæ–­ç‚¹ç»­ä¼ æ—¶è¦è¡¥ä¼ å“ªäº›åˆ†ç‰‡ï¼‰</li>
</ol>
<h4 data-id="heading-7">3.1 å‰ç«¯å‘èµ·æ ¡éªŒè¯·æ±‚</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fileHash</span> = ref(<span class="hljs-string">""</span>)<span class="hljs-comment">; // æ–‡ä»¶å“ˆå¸Œå€¼</span>
const <span class="hljs-attr">fileName</span> = ref(<span class="hljs-string">""</span>)<span class="hljs-comment">; // åŸå§‹æ–‡ä»¶åï¼ˆç”¨äºå–åç¼€ï¼‰</span>

/**
 * å‘æœåŠ¡å™¨æ ¡éªŒæ–‡ä»¶çŠ¶æ€
 * @returns {Promise&lt;Object&gt;} æ ¡éªŒç»“æœï¼ˆshouldUpload: æ˜¯å¦éœ€è¦ä¸Šä¼ , existChunks: å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨ï¼‰
 */
const <span class="hljs-attr">verify</span> = async () =&gt; {
  const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">"http://localhost:3000/verify"</span>, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      fileHash: fileHash.value,
      fileName: fileName.value,
    }),
  })<span class="hljs-comment">;</span>
  return res.json()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// åœ¨handleUploadä¸­è°ƒç”¨æ ¡éªŒ
const <span class="hljs-attr">handleUpload</span> = async (e) =&gt; {
  const <span class="hljs-attr">file</span> = e.target.files[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  if (!file) return<span class="hljs-comment">;</span>

  <span class="hljs-attr">fileName.value</span> = file.name<span class="hljs-comment">;</span>
  const <span class="hljs-attr">chunks</span> = createChunks(file)<span class="hljs-comment">;</span>
  <span class="hljs-attr">fileHash.value</span> = await calHash(chunks)<span class="hljs-comment">; // è®¡ç®—å“ˆå¸Œ</span>

  // å‘èµ·æ ¡éªŒ
  const <span class="hljs-attr">verifyRes</span> = await verify()<span class="hljs-comment">;</span>
  if (!verifyRes.data.shouldUpload) {
    // æœåŠ¡å™¨å·²å­˜åœ¨å®Œæ•´æ–‡ä»¶ â†’ ç§’ä¼ æˆåŠŸ
    alert("ç§’ä¼ æˆåŠŸï¼æ–‡ä»¶å·²å­˜åœ¨")<span class="hljs-comment">;</span>
    return<span class="hljs-comment">;</span>
  }

  // éœ€ä¸Šä¼ ï¼šè¿›å…¥åˆ†ç‰‡ä¸Šä¼ ç¯èŠ‚ï¼ˆä¸‹æ–‡å±•å¼€ï¼‰
  await uploadChunks(chunks, verifyRes.data.existChunks)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-8">3.2 åç«¯å¤„ç†æ ¡éªŒé€»è¾‘</h4>
<p>åç«¯éœ€è¦æ£€æŸ¥ã€Œå®Œæ•´æ–‡ä»¶ã€å’Œã€Œå·²ä¸Šä¼ åˆ†ç‰‡ã€çš„å­˜åœ¨æ€§ï¼Œè¿”å›ç»™å‰ç«¯å†³ç­–ä¾æ®ã€‚</p>
<p>å…ˆåˆå§‹åŒ–åç«¯é¡¹ç›®å¹¶å®‰è£…ä¾èµ–ï¼š
# 1. åˆå§‹åŒ–
npm init -y</p>
<pre><code class="hljs language-lua" lang="lua"># <span class="hljs-number">2.</span> å®‰è£…ä¾èµ–
npm install express cors multiparty fs-extra <span class="hljs-built_in">path</span> <span class="hljs-comment">--save</span>
</code></pre>
<p>å†å®ç°&nbsp;<code>/verify</code>&nbsp;æ¥å£ï¼š</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">path</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">fse</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"fs-extra"</span>); <span class="hljs-comment">// æ–‡ä»¶æ“ä½œå·¥å…·ï¼ˆæ¯”åŸç”Ÿfsæ›´æ˜“ç”¨ï¼‰</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">cors</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">bodyParser</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">"body-parser"</span>);

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">app</span> = <span class="hljs-title function_ invoke__">express</span>();
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>()); <span class="hljs-comment">// è§£å†³è·¨åŸŸ</span>
app.<span class="hljs-keyword">use</span>(bodyParser.<span class="hljs-title function_ invoke__">json</span>()); <span class="hljs-comment">// è§£æJSONè¯·æ±‚ä½“</span>

<span class="hljs-comment">// ä¸Šä¼ æ ¹ç›®å½•ï¼ˆæ‰€æœ‰åˆ†ç‰‡å’Œå®Œæ•´æ–‡ä»¶éƒ½å­˜åœ¨è¿™é‡Œï¼‰</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UPLOAD_DIR</span> = path.<span class="hljs-title function_ invoke__">resolve</span>(__dirname, <span class="hljs-string">"uploads"</span>);
<span class="hljs-comment">// ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨</span>
fse.<span class="hljs-title function_ invoke__">ensureDirSync</span>(UPLOAD_DIR);

<span class="hljs-comment">/**
 * æå–æ–‡ä»¶ååç¼€ï¼ˆå¦‚ï¼š"test.pdf" â†’ ".pdf"ï¼‰
 * <span class="hljs-doctag">@param</span> {string} fileName - åŸå§‹æ–‡ä»¶å
 * <span class="hljs-doctag">@returns</span> {string} æ–‡ä»¶åç¼€
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">extractExt</span> = (fileName) =&gt; {
  <span class="hljs-keyword">return</span> fileName.<span class="hljs-title function_ invoke__">slice</span>(fileName.<span class="hljs-title function_ invoke__">lastIndexOf</span>(<span class="hljs-string">"."</span>));
};

<span class="hljs-comment">// æ ¡éªŒæ¥å£ï¼š/verify</span>
app.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">"/verify"</span>, <span class="hljs-title function_ invoke__">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { fileHash, fileName } = req.body;
  // å®Œæ•´æ–‡ä»¶è·¯å¾„ = ä¸Šä¼ ç›®å½• + æ–‡ä»¶å“ˆå¸Œ + åŸæ–‡ä»¶åç¼€ï¼ˆç¡®ä¿æ–‡ä»¶åå”¯ä¸€ï¼‰
  <span class="hljs-keyword">const</span> completeFilePath = path.<span class="hljs-title function_ invoke__">resolve</span>(UPLOAD_DIR, `${fileHash}${<span class="hljs-title function_ invoke__">extractExt</span>(fileName)}`);

  // <span class="hljs-number">1</span>. æ£€æŸ¥å®Œæ•´æ–‡ä»¶æ˜¯å¦å­˜åœ¨ â†’ ç§’ä¼ é€»è¾‘
  <span class="hljs-keyword">if</span> (fse.<span class="hljs-title function_ invoke__">existsSync</span>(completeFilePath)) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">json</span>({
      <span class="hljs-attr">status</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">shouldUpload</span>: <span class="hljs-literal">false</span> } // æ— éœ€ä¸Šä¼ 
    });
  }

  <span class="hljs-comment">// 2. æ£€æŸ¥å·²ä¸Šä¼ çš„åˆ†ç‰‡ â†’ æ–­ç‚¹ç»­ä¼ é€»è¾‘</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">chunkDir</span> = path.<span class="hljs-title function_ invoke__">resolve</span>(UPLOAD_DIR, fileHash); <span class="hljs-comment">// åˆ†ç‰‡ä¸´æ—¶ç›®å½•ï¼ˆç”¨æ–‡ä»¶å“ˆå¸Œå‘½åï¼‰</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">existChunks</span> = fse.<span class="hljs-title function_ invoke__">existsSync</span>(chunkDir) 
    ? await fse.<span class="hljs-title function_ invoke__">readdir</span>(chunkDir) <span class="hljs-comment">// å·²ä¸Šä¼ çš„åˆ†ç‰‡åˆ—è¡¨ï¼ˆå¦‚ï¼š["a1b2-0", "a1b2-1"]ï¼‰</span>
    : [];

  res.<span class="hljs-title function_ invoke__">json</span>({
    <span class="hljs-attr">status</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">shouldUpload</span>: <span class="hljs-literal">true</span>, // éœ€è¦ä¸Šä¼ 
      <span class="hljs-attr">existChunks</span>: existChunks // å·²ä¸Šä¼ çš„åˆ†ç‰‡æ ‡è¯†ï¼Œä¾›å‰ç«¯è¿‡æ»¤
    }
  });
});

<span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨</span>
app.<span class="hljs-title function_ invoke__">listen</span>(<span class="hljs-number">3000</span>, () =&gt; {
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3000"</span>);
});
</code></pre>
<h3 data-id="heading-9">ç¬¬å››æ­¥ï¼šå¹¶å‘ä¸Šä¼ åˆ†ç‰‡ï¼ˆå‰ç«¯æ ¸å¿ƒï¼‰</h3>
<p>è¿™æ˜¯å‰ç«¯æœ€å¤æ‚çš„ç¯èŠ‚ï¼Œéœ€è¦è§£å†³ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š</p>
<ol>
<li>è¿‡æ»¤å·²ä¸Šä¼ çš„åˆ†ç‰‡ï¼ˆåªä¼ ç¼ºå¤±çš„ï¼‰</li>
<li>æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°ï¼ˆé¿å…è¯·æ±‚çˆ†ç‚¸ï¼‰</li>
<li>æ”¯æŒæ‰‹åŠ¨ä¸­æ–­ä¸Šä¼ ï¼ˆç”¨æˆ·å¯éšæ—¶åœæ­¢ï¼‰</li>
</ol>
<h4 data-id="heading-10">4.1 è¿‡æ»¤å·²ä¸Šä¼ çš„åˆ†ç‰‡</h4>
<p>æ ¹æ®åç«¯è¿”å›çš„&nbsp;<code>existChunks</code>ï¼ˆå·²ä¸Šä¼ åˆ†ç‰‡æ ‡è¯†åˆ—è¡¨ï¼‰ï¼Œè¿‡æ»¤æ‰ä¸éœ€è¦é‡æ–°ä¸Šä¼ çš„åˆ†ç‰‡ï¼Œåªç”Ÿæˆå¾…ä¸Šä¼ çš„&nbsp;<code>FormData</code>ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">/**
 * ä¸Šä¼ åˆ†ç‰‡ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
 * @param {Blob<span class="hljs-section">[]</span>} chunks - æ‰€æœ‰åˆ†ç‰‡æ•°ç»„
 * @param {string<span class="hljs-section">[]</span>} existChunks - å·²ä¸Šä¼ çš„åˆ†ç‰‡æ ‡è¯†åˆ—è¡¨
 */
const <span class="hljs-attr">uploadChunks</span> = async (chunks, existChunks) =&gt; {
  <span class="hljs-attr">isUploading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">abortControllers.value</span> = []<span class="hljs-comment">; // æ¸…ç©ºå†å²ä¸­æ–­æ§åˆ¶å™¨</span>

  // 1. ç”Ÿæˆæ‰€æœ‰åˆ†ç‰‡çš„åŸºç¡€ä¿¡æ¯ï¼ˆæ–‡ä»¶å“ˆå¸Œã€åˆ†ç‰‡æ ‡è¯†ã€åˆ†ç‰‡æ•°æ®ï¼‰
  const <span class="hljs-attr">chunkInfoList</span> = chunks.map((chunk, index) =&gt; ({
    fileHash: fileHash.value,
    chunkHash: `${fileHash.value}-${index}`, // åˆ†ç‰‡æ ‡è¯†ï¼šæ–‡ä»¶å“ˆå¸Œ-åºå·ï¼ˆç¡®ä¿å”¯ä¸€ï¼‰
    chunk: chunk
  }))<span class="hljs-comment">;</span>

  // 2. è¿‡æ»¤å·²ä¸Šä¼ çš„åˆ†ç‰‡ â†’ åªä¿ç•™å¾…ä¸Šä¼ çš„
  const <span class="hljs-attr">formDatas</span> = chunkInfoList
    .filter(<span class="hljs-attr">item</span> =&gt; !existChunks.includes(item.chunkHash))
    .map(<span class="hljs-attr">item</span> =&gt; {
      const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
      formData.append("filehash", item.fileHash)<span class="hljs-comment">;</span>
      formData.append("chunkhash", item.chunkHash)<span class="hljs-comment">;</span>
      formData.append("chunk", item.chunk)<span class="hljs-comment">; // åˆ†ç‰‡äºŒè¿›åˆ¶æ•°æ®</span>
      return formData<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

  if (<span class="hljs-attr">formDatas.length</span> === <span class="hljs-number">0</span>) {
    // æ‰€æœ‰åˆ†ç‰‡å·²ä¸Šä¼  â†’ ç›´æ¥è¯·æ±‚åˆå¹¶
    mergeRequest()<span class="hljs-comment">;</span>
    return<span class="hljs-comment">;</span>
  }

  // 3. å¹¶å‘ä¸Šä¼ åˆ†ç‰‡ï¼ˆä¸‹æ–‡å±•å¼€ï¼‰
  await uploadWithConcurrencyControl(formDatas)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-11">4.2 æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°</h4>
<p>ç”¨ã€Œè¯·æ±‚æ±  +&nbsp;<code>Promise.race</code>ã€é™åˆ¶åŒæ—¶ä¸Šä¼ çš„åˆ†ç‰‡æ•°é‡ï¼ˆè¿™é‡Œè®¾ä¸º 6 ä¸ªï¼‰ï¼Œé¿å…è¯·æ±‚è¿‡å¤šå¯¼è‡´æµè§ˆå™¨ / æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">/**
 * å¸¦å¹¶å‘æ§åˆ¶çš„åˆ†ç‰‡ä¸Šä¼ 
 * @param {FormData<span class="hljs-section">[]</span>} formDatas - å¾…ä¸Šä¼ çš„FormDataåˆ—è¡¨
 */
const <span class="hljs-attr">uploadWithConcurrencyControl</span> = async (formDatas) =&gt; {
  const <span class="hljs-attr">MAX_CONCURRENT</span> = <span class="hljs-number">6</span><span class="hljs-comment">; // æœ€å¤§å¹¶å‘æ•°ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰</span>
  let <span class="hljs-attr">currentIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // å½“å‰å¾…ä¸Šä¼ çš„åˆ†ç‰‡ç´¢å¼•</span>
  const <span class="hljs-attr">taskPool</span> = []<span class="hljs-comment">; // å­˜å‚¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚ï¼ˆè¯·æ±‚æ± ï¼‰</span>

  while (currentIndex &lt; formDatas.length) {
    // ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºç‹¬ç«‹çš„ä¸­æ–­æ§åˆ¶å™¨ï¼ˆAbortControllerï¼‰
    const <span class="hljs-attr">controller</span> = new AbortController()<span class="hljs-comment">;</span>
    const { signal } = controller<span class="hljs-comment">;</span>
    abortControllers.value.push(controller)<span class="hljs-comment">; // å­˜å…¥æ§åˆ¶å™¨åˆ—è¡¨</span>

    // å‘èµ·åˆ†ç‰‡ä¸Šä¼ è¯·æ±‚
    const <span class="hljs-attr">task</span> = fetch(<span class="hljs-string">"http://localhost:3000/upload"</span>, {
      method: "POST",
      body: formDatas<span class="hljs-section">[currentIndex]</span>,
      signal: signal // ç»‘å®šä¸­æ–­ä¿¡å·
    })
    .then(<span class="hljs-attr">res</span> =&gt; {
      // è¯·æ±‚å®Œæˆåï¼Œä»è¯·æ±‚æ± å’Œæ§åˆ¶å™¨åˆ—è¡¨ä¸­ç§»é™¤
      taskPool.splice(taskPool.indexOf(task), 1)<span class="hljs-comment">;</span>
      <span class="hljs-attr">abortControllers.value</span> = abortControllers.value.filter(c =&gt; c !== controller)<span class="hljs-comment">;</span>
      return res<span class="hljs-comment">;</span>
    })
    .catch(<span class="hljs-attr">err</span> =&gt; {
      // æ•è·é”™è¯¯ï¼šåŒºåˆ†ã€Œç”¨æˆ·ä¸­æ–­ã€å’Œã€Œå…¶ä»–é”™è¯¯ã€
      if (err.name !== "AbortError") {
        console.error("åˆ†ç‰‡ä¸Šä¼ å¤±è´¥ï¼š", err)<span class="hljs-comment">;</span>
        // å¯åœ¨è¿™é‡ŒåŠ ã€Œé”™è¯¯é‡è¯•ã€é€»è¾‘ï¼ˆå¦‚é‡è¯•3æ¬¡ï¼‰
      }
      // æ— è®ºä½•ç§é”™è¯¯ï¼Œéƒ½æ¸…ç†çŠ¶æ€
      taskPool.splice(taskPool.indexOf(task), 1)<span class="hljs-comment">;</span>
      <span class="hljs-attr">abortControllers.value</span> = abortControllers.value.filter(c =&gt; c !== controller)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

    taskPool.push(task)<span class="hljs-comment">;</span>

    // å½“è¯·æ±‚æ± æ»¡äº†ï¼Œç­‰å¾…æœ€å¿«å®Œæˆçš„ä¸€ä¸ªè¯·æ±‚å†ç»§ç»­ï¼ˆé‡Šæ”¾å¹¶å‘åé¢ï¼‰
    if (<span class="hljs-attr">taskPool.length</span> === MAX_CONCURRENT) {
      await Promise.race(taskPool)<span class="hljs-comment">;</span>
    }

    currentIndex++<span class="hljs-comment">;</span>
  }

  // ç­‰å¾…æ‰€æœ‰å‰©ä½™è¯·æ±‚å®Œæˆ
  await Promise.all(taskPool)<span class="hljs-comment">;</span>
  // æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆ â†’ è¯·æ±‚åˆå¹¶
  mergeRequest()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-12">4.3 æ‰‹åŠ¨ä¸­æ–­ä¸Šä¼ </h4>
<p>ç”¨&nbsp;<code>AbortController</code>&nbsp;ä¸­æ–­æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œå¹¶æ¸…ç†çŠ¶æ€ï¼Œç¡®ä¿ä¸­æ–­åä¸‹æ¬¡ä¸Šä¼ èƒ½æ­£å¸¸æ¢å¤ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">/**
 * ä¸­æ–­ä¸Šä¼ ï¼ˆç”¨æˆ·è§¦å‘ï¼‰
 */
const <span class="hljs-attr">abortUpload</span> = () =&gt; {
  if (!isUploading.value) return<span class="hljs-comment">;</span>

  // 1. ä¸­æ–­æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
  abortControllers.value.forEach(<span class="hljs-attr">controller</span> =&gt; {
    controller.abort()<span class="hljs-comment">; // è°ƒç”¨ä¸­æ–­æ–¹æ³•ï¼Œè§¦å‘è¯·æ±‚çš„AbortError</span>
  })<span class="hljs-comment">;</span>

  // 2. æ¸…ç†çŠ¶æ€
  <span class="hljs-attr">abortControllers.value</span> = []<span class="hljs-comment">;</span>
  <span class="hljs-attr">isUploading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

  // 3. é€šçŸ¥ç”¨æˆ·
  alert("ä¸Šä¼ å·²ä¸­æ–­ï¼Œä¸‹æ¬¡å¯ç»§ç»­ä¸Šä¼ ")<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-13">ç¬¬äº”æ­¥ï¼šåç«¯æ¥æ”¶åˆ†ç‰‡å¹¶åˆå¹¶</h3>
<p>æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œå‰ç«¯éœ€è¦é€šçŸ¥åç«¯ã€Œåˆå¹¶åˆ†ç‰‡ã€ï¼Œåç«¯æŒ‰åˆ†ç‰‡åºå·æ’åºï¼Œç”¨ã€Œæµï¼ˆStreamï¼‰ã€æ‹¼æ¥æˆå®Œæ•´æ–‡ä»¶ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰ã€‚</p>
<h4 data-id="heading-14">5.1 åç«¯æ¥æ”¶åˆ†ç‰‡ï¼ˆ/upload æ¥å£ï¼‰</h4>
<p>ç”¨&nbsp;<code>multiparty</code>&nbsp;è§£æå‰ç«¯å‘é€çš„&nbsp;<code>FormData</code>ï¼Œå°†åˆ†ç‰‡ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ï¼ˆä»¥æ–‡ä»¶å“ˆå¸Œå‘½åï¼‰ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// åç«¯ï¼š/upload æ¥å£ï¼ˆæ¥æ”¶åˆ†ç‰‡ï¼‰</span>
<span class="hljs-keyword">const</span> multiparty = <span class="hljs-built_in">require</span>(<span class="hljs-string">"multiparty"</span>);

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/upload"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">new</span> multiparty.<span class="hljs-title class_">Form</span>(); <span class="hljs-comment">// è§£æFormDataçš„å·¥å…·</span>

  <span class="hljs-comment">// è§£æè¯·æ±‚ï¼ˆfieldsï¼šæ™®é€šå­—æ®µï¼Œfilesï¼šæ–‡ä»¶å­—æ®µï¼‰</span>
  form.<span class="hljs-title function_">parse</span>(req, <span class="hljs-keyword">async</span> (err, fields, files) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"åˆ†ç‰‡è§£æå¤±è´¥ï¼š"</span>, err);
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">status</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"åˆ†ç‰‡ä¸Šä¼ å¤±è´¥"</span> });
    }

    <span class="hljs-comment">// æå–å­—æ®µ</span>
    <span class="hljs-keyword">const</span> fileHash = fields[<span class="hljs-string">"filehash"</span>][<span class="hljs-number">0</span>]; <span class="hljs-comment">// æ–‡ä»¶å“ˆå¸Œ</span>
    <span class="hljs-keyword">const</span> chunkHash = fields[<span class="hljs-string">"chunkhash"</span>][<span class="hljs-number">0</span>]; <span class="hljs-comment">// åˆ†ç‰‡æ ‡è¯†</span>
    <span class="hljs-keyword">const</span> chunkFile = files[<span class="hljs-string">"chunk"</span>][<span class="hljs-number">0</span>]; <span class="hljs-comment">// åˆ†ç‰‡ä¸´æ—¶æ–‡ä»¶ï¼ˆmultipartyç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ï¼‰</span>

    <span class="hljs-comment">// åˆ†ç‰‡ä¸´æ—¶ç›®å½•ï¼ˆå¦‚ï¼šuploads/a1b2c3ï¼‰</span>
    <span class="hljs-keyword">const</span> chunkDir = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">UPLOAD_DIR</span>, fileHash);
    <span class="hljs-comment">// ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨</span>
    <span class="hljs-keyword">await</span> fse.<span class="hljs-title function_">ensureDir</span>(chunkDir);

    <span class="hljs-comment">// ç›®æ ‡è·¯å¾„ï¼šå°†åˆ†ç‰‡ä»ä¸´æ—¶ä½ç½®ç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•</span>
    <span class="hljs-keyword">const</span> targetChunkPath = path.<span class="hljs-title function_">resolve</span>(chunkDir, chunkHash);
    <span class="hljs-keyword">await</span> fse.<span class="hljs-title function_">move</span>(chunkFile.<span class="hljs-property">path</span>, targetChunkPath);

    <span class="hljs-comment">// å“åº”å‰ç«¯ï¼šåˆ†ç‰‡ä¸Šä¼ æˆåŠŸ</span>
    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">status</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ"</span> });
  });
});
</code></pre>
<h4 data-id="heading-15">5.2 åç«¯åˆå¹¶åˆ†ç‰‡ï¼ˆ/merge æ¥å£ï¼‰</h4>
<p>åˆå¹¶çš„æ ¸å¿ƒæ˜¯ã€ŒæŒ‰åºå·æ’åºåˆ†ç‰‡ã€+ã€Œç”¨æµæ‹¼æ¥ã€ï¼Œè¾¹è¯»è¾¹å†™ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// å‰ç«¯ï¼šè¯·æ±‚åˆå¹¶åˆ†ç‰‡çš„å‡½æ•°</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeRequest</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"http://localhost:3000/merge"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">fileHash</span>: fileHash.<span class="hljs-property">value</span>,
      <span class="hljs-attr">fileName</span>: fileName.<span class="hljs-property">value</span>,
      <span class="hljs-attr">size</span>: <span class="hljs-variable constant_">CHUNK_SIZE</span> <span class="hljs-comment">// åˆ†ç‰‡å¤§å°ï¼ˆç”¨äºè®¡ç®—å†™å…¥ä½ç½®ï¼‰</span>
    }),
  });

  <span class="hljs-comment">// åˆå¹¶å®Œæˆåçš„æ¸…ç†</span>
  isUploading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">"æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼"</span>);
};

<span class="hljs-comment">// åç«¯ï¼š/merge æ¥å£ï¼ˆåˆå¹¶åˆ†ç‰‡ï¼‰</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/merge"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { fileHash, fileName, <span class="hljs-attr">size</span>: <span class="hljs-variable constant_">CHUNK_SIZE</span> } = req.<span class="hljs-property">body</span>;
  <span class="hljs-comment">// å®Œæ•´æ–‡ä»¶è·¯å¾„ï¼ˆä¸Šä¼ ç›®å½• + æ–‡ä»¶å“ˆå¸Œ + åç¼€ï¼‰</span>
  <span class="hljs-keyword">const</span> completeFilePath = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">UPLOAD_DIR</span>, <span class="hljs-string">`<span class="hljs-subst">${fileHash}</span><span class="hljs-subst">${extractExt(fileName)}</span>`</span>);
  <span class="hljs-comment">// åˆ†ç‰‡ä¸´æ—¶ç›®å½•</span>
  <span class="hljs-keyword">const</span> chunkDir = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">UPLOAD_DIR</span>, fileHash);

  <span class="hljs-comment">// æ£€æŸ¥åˆ†ç‰‡ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆé˜²æ­¢æ¶æ„è¯·æ±‚ï¼‰</span>
  <span class="hljs-keyword">if</span> (!fse.<span class="hljs-title function_">existsSync</span>(chunkDir)) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">status</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"åˆ†ç‰‡ç›®å½•ä¸å­˜åœ¨"</span> });
  }

  <span class="hljs-comment">// 1. è¯»å–æ‰€æœ‰åˆ†ç‰‡å¹¶æŒ‰åºå·æ’åº</span>
  <span class="hljs-keyword">const</span> chunkPaths = <span class="hljs-keyword">await</span> fse.<span class="hljs-title function_">readdir</span>(chunkDir);
  chunkPaths.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
    <span class="hljs-comment">// ä»åˆ†ç‰‡æ ‡è¯†ä¸­æå–åºå·ï¼ˆå¦‚ï¼š"a1b2-0" â†’ 0ï¼‰</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(a.<span class="hljs-title function_">split</span>(<span class="hljs-string">"-"</span>)[<span class="hljs-number">1</span>]) - <span class="hljs-built_in">parseInt</span>(b.<span class="hljs-title function_">split</span>(<span class="hljs-string">"-"</span>)[<span class="hljs-number">1</span>]);
  });

  <span class="hljs-comment">// 2. ç”¨æµæ‹¼æ¥åˆ†ç‰‡ï¼ˆè¾¹è¯»è¾¹å†™ï¼Œä½å†…å­˜å ç”¨ï¼‰</span>
  <span class="hljs-keyword">const</span> mergePromises = chunkPaths.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunkName, index</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> chunkPath = path.<span class="hljs-title function_">resolve</span>(chunkDir, chunkName);
      <span class="hljs-keyword">const</span> readStream = fse.<span class="hljs-title function_">createReadStream</span>(chunkPath); <span class="hljs-comment">// åˆ†ç‰‡è¯»æµ</span>
      <span class="hljs-keyword">const</span> writeStream = fse.<span class="hljs-title function_">createWriteStream</span>(completeFilePath, {
        <span class="hljs-attr">start</span>: index * <span class="hljs-variable constant_">CHUNK_SIZE</span>, <span class="hljs-comment">// å†™å…¥èµ·å§‹ä½ç½®ï¼ˆç²¾ç¡®åˆ°å­—èŠ‚ï¼‰</span>
        <span class="hljs-attr">end</span>: (index + <span class="hljs-number">1</span>) * <span class="hljs-variable constant_">CHUNK_SIZE</span> <span class="hljs-comment">// å†™å…¥ç»“æŸä½ç½®</span>
      });

      <span class="hljs-comment">// åˆ†ç‰‡è¯»å–å®Œæˆåï¼šåˆ é™¤åˆ†ç‰‡æ–‡ä»¶ +  resolve</span>
      readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">"end"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">await</span> fse.<span class="hljs-title function_">unlink</span>(chunkPath); <span class="hljs-comment">// åˆ é™¤å•ä¸ªåˆ†ç‰‡</span>
        <span class="hljs-title function_">resolve</span>();
      });

      <span class="hljs-comment">// ç®¡é“æµï¼šå°†åˆ†ç‰‡å†…å®¹å†™å…¥å®Œæ•´æ–‡ä»¶</span>
      readStream.<span class="hljs-title function_">pipe</span>(writeStream);
    });
  });

  <span class="hljs-comment">// 3. ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡åˆå¹¶å®Œæˆ</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(mergePromises);
  <span class="hljs-comment">// 4. åˆ é™¤åˆ†ç‰‡ä¸´æ—¶ç›®å½•ï¼ˆåˆå¹¶å®Œæˆåæ¸…ç†ï¼‰</span>
  <span class="hljs-keyword">await</span> fse.<span class="hljs-title function_">remove</span>(chunkDir);

  <span class="hljs-comment">// å“åº”å‰ç«¯ï¼šåˆå¹¶æˆåŠŸ</span>
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">status</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"æ–‡ä»¶åˆå¹¶æˆåŠŸ"</span> });
});
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆç”¨æµï¼Ÿ</strong><br>
å¦‚æœç›´æ¥ç”¨&nbsp;<code>fs.readFile</code>&nbsp;è¯»å–æ‰€æœ‰åˆ†ç‰‡å†…å®¹å†æ‹¼æ¥ï¼Œ1GB çš„æ–‡ä»¶ä¼šå ç”¨ 1GB å†…å­˜ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å†…å­˜æº¢å‡ºï¼›è€Œæµæ“ä½œï¼ˆ<code>createReadStream</code>/<code>createWriteStream</code>ï¼‰æ˜¯è¾¹è¯»è¾¹å†™ï¼Œå†…å­˜å ç”¨å§‹ç»ˆå¾ˆä½ï¼ˆä»…å‡  KB/MBï¼‰ã€‚</p>
<h2 data-id="heading-16">ä¸‰ã€æ ¸å¿ƒéš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆæ€»ç»“</h2>
<p>å¤§æ–‡ä»¶ä¸Šä¼ çš„æ ¸å¿ƒç—›ç‚¹å·²åœ¨æ–¹æ¡ˆä¸­è§£å†³ï¼Œè¿™é‡Œæ•´ç†æˆè¡¨æ ¼ï¼Œæ–¹ä¾¿å¤§å®¶å¿«é€Ÿå›é¡¾ï¼š</p>








































<table><thead><tr><th>æ ¸å¿ƒéš¾ç‚¹</th><th>è§£å†³æ–¹æ¡ˆ</th><th>ä»£ç å…³é”®ä½ç½®</th></tr></thead><tbody><tr><td>å¤§æ–‡ä»¶å“ˆå¸Œè®¡ç®—æ…¢</td><td>æŠ½æ ·è¯»å–ç‰‡æ®µï¼ˆé¦–å°¾å…¨é‡ + ä¸­é—´åˆ†ç‰‡æŠ½æ ·ï¼‰</td><td><code>calHash</code>&nbsp;å‡½æ•°</td></tr><tr><td>å¹¶å‘è¯·æ±‚è¿‡å¤šå¯¼è‡´å´©æºƒ</td><td>ç”¨ã€Œè¯·æ±‚æ±  + Promise.raceã€é™åˆ¶å¹¶å‘æ•°</td><td><code>uploadChunks</code>&nbsp;å‡½æ•°</td></tr><tr><td>ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ä¸­æ–­ä¸Šä¼ </td><td>ç”¨&nbsp;<code>AbortController</code>&nbsp;ä¸­æ–­è¯·æ±‚ + æ¸…ç†çŠ¶æ€</td><td><code>abortUpload</code>&nbsp;å‡½æ•°</td></tr><tr><td>åˆ†ç‰‡åˆå¹¶é¡ºåºé”™ä¹±</td><td>æŒ‰åˆ†ç‰‡åºå·æ’åºï¼Œç”¨æµæŒ‰å›ºå®šä½ç½®å†™å…¥</td><td>åç«¯&nbsp;<code>/merge</code>&nbsp;æ¥å£çš„æ’åºé€»è¾‘</td></tr><tr><td>åˆ·æ–°é¡µé¢åéœ€ä»å¤´ä¸Šä¼ </td><td>æ ¡éªŒæ—¶è¿”å›å·²ä¸Šä¼ åˆ†ç‰‡ï¼Œå‰ç«¯è¿‡æ»¤åå†ä¸Šä¼ </td><td>å‰ç«¯&nbsp;<code>filter</code>&nbsp;é€»è¾‘ + åç«¯&nbsp;<code>/verify</code>&nbsp;æ¥å£</td></tr><tr><td>å¤§æ–‡ä»¶åˆå¹¶å†…å­˜æº¢å‡º</td><td>ç”¨æµï¼ˆStreamï¼‰è¾¹è¯»è¾¹å†™ï¼Œé¿å…å…¨é‡åŠ è½½</td><td>åç«¯&nbsp;<code>/merge</code>&nbsp;æ¥å£çš„æµæ“ä½œ</td></tr></tbody></table>
<h2 data-id="heading-17">å››ã€æœ€å</h2>
<p>å¤§æ–‡ä»¶ä¸Šä¼ çœ‹ä¼¼å¤æ‚ï¼Œæ‹†è§£åå…¶å®æ˜¯ã€Œåˆ†ç‰‡â†’æ ¡éªŒâ†’ä¸Šä¼ â†’åˆå¹¶ã€å››ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤è§£å†³ä¸€ä¸ªå…·ä½“é—®é¢˜ã€‚è¿™å¥—æ–¹æ¡ˆç”¨ Vue+Express å®ç°ï¼Œä»£ç ç®€æ´æ˜“æ‡‚ï¼Œå¯ç›´æ¥ä½œä¸ºé¡¹ç›®åŸºç¡€ç‰ˆæœ¬ï¼Œå†æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•ä¼˜åŒ–ã€‚</p>
<p>å®é™…å¼€å‘ä¸­ï¼Œè¿˜éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯è¡¥å……å¼‚å¸¸å¤„ç†ï¼ˆå¦‚æ–‡ä»¶å¤§å°é™åˆ¶ã€æ ¼å¼æ ¡éªŒï¼‰ã€æ—¥å¿—ç›‘æ§ï¼ˆä¸Šä¼ å¤±è´¥å‘Šè­¦ï¼‰ç­‰åŠŸèƒ½ã€‚å¦‚æœå¤§å®¶åœ¨å®è·µä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµã€‚</p>
<hr>
<p>å¦‚æœæ‚¨è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµå’Œæ”¶è—ï¼Œå¤§å®¶çš„æ”¯æŒæ˜¯æˆ‘ç»§ç»­åˆ›ä½œä¼˜è´¨å†…å®¹çš„åŠ¨åŠ›ğŸŒ¹ğŸŒ¹ğŸŒ¹ä¹Ÿå¸Œæœ›æ‚¨èƒ½åœ¨ğŸ˜‰ğŸ˜‰ğŸ˜‰<a href="https://juejin.cn/user/671151992348125" target="_blank" title="https://juejin.cn/user/671151992348125">æˆ‘çš„ä¸»é¡µ</a> ğŸ˜‰ğŸ˜‰ğŸ˜‰æ‰¾åˆ°æ›´å¤šå¯¹æ‚¨æœ‰å¸®åŠ©çš„å†…å®¹ã€‚</p>
<ul>
<li>è‡´æ•¬æ¯ä¸€ä½èµ¶è·¯äºº</li>
</ul></div></div>