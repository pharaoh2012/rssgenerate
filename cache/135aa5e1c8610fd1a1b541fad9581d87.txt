
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/yuzhijian/p/18651324" title="发布于 2025-01-04 03:07">
    <span role="heading" aria-level="2">使用format_obproxy_digest_log工具分析obproxy网络层耗时SQL</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><img src="https://img2024.cnblogs.com/blog/3038670/202501/3038670-20250104031540172-1161563949.jpg" alt="" loading="lazy"></p>
<p><span style="font-size: 14pt">&nbsp;峰哥镇楼~~~!!</span></p>
<hr>
<p>&nbsp;<strong>之前写过一个博客，介绍 ob_tools包 来实施抓取 observer 层的 gv$ob_sql_audit 的SQL，还提供一些分析SQL来通过不同维度分析缓慢的业务SQL语句，免得和应用扯皮说数据库执行SQL慢。</strong></p>
<p><strong>但是分析出服务端业务SQL语句执行时间还不够，应用也有可能会和你扯皮说obproxy转发慢，也不是不能查obproxy的日志来佐证，就日志里面的内容很难看，我经常懒得去看很烦，所以搞了个&nbsp;format_obproxy_digest_log 工具来看proxy的转发耗时。</strong></p>
<p><strong>这样一来proxy(网络层)、server(服务端层) 有了一套完整分析业务SQL语句请求耗时的解决方案，妈妈再也不怕我和开发扯皮了，狠狠地给我怼死开发。🤞🤞🤞</strong></p>
<p><span style="font-size: 18px"><strong>******注意<strong>******</strong>：这个工具只能用来分析 obproxy&nbsp;obproxy_digest.log ，我是基于obproxy 433版本的<strong>obproxy_digest.log日志格式</strong>写的工具，4.X的obproxy应该能用，以后的版本不敢保证。</strong></span></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt"><strong>先介绍下obproxy&nbsp;obproxy_digest.log 日志</strong></span></p>
<p>　　obproxy_digest.log 是 OceanBase 数据库代理（OBProxy）的审计日志文件，主要用于记录执行时间超过指定阈值的 SQL 请求以及错误响应的请求。</p>
<ol>
<li>
<p>记录慢查询和错误请求：</p>
<ul>
<li>慢查询：当 SQL 请求的执行时间超过&nbsp;<code>query_digest_time_threshold</code>&nbsp;参数设置的阈值时，该请求会被记录到&nbsp;<code>obproxy_digest.log</code>&nbsp;中。默认情况下，该阈值为 100 毫秒（在主站环境中默认值为 2 毫秒）。</li>
<li>错误请求：所有执行错误的请求（包括 OBProxy 自身错误和 OBServer 返回的错误）也会被记录到该日志中。</li>
</ul>
</li>
<li>
<p>日志内容：</p>
<ul>
<li>日志中包含了请求的详细信息，如日志打印时间、应用名、TraceId、RpcId、物理库信息（cluster:tenant:database）、数据库类型（OB 或 RDS）、逻辑表名、物理表名、SQL 命令、SQL 类型（CRUD）、执行结果（success 或 failed）、错误码、SQL 执行总耗时、预执行时间、链接建立时间、数据库执行时间等。</li>
</ul>
</li>
</ol>
<p>　　ob官网链接：<a href="https://www.oceanbase.com/docs/common-odp-doc-cn-1000000002024094" rel="noopener nofollow">obproxy_digest.log-V4.3.3-OceanBase 数据库代理文档-分布式数据库使用文档</a></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt"><strong>看完上面介绍的同学就知道&nbsp;obproxy_digest.log 日志里面的内容有多难看了，神烦，就直接开始介绍&nbsp;format_obproxy_digest_log 工具。</strong></span></p>
<p><span style="font-size: 18px"><strong>文件下载：</strong></span></p>
<p><span style="font-size: 18px">通过网盘分享的文件：format_obproxy_digest_log</span><br><span style="font-size: 18px">链接: https://pan.baidu.com/s/14QvqWyV83yn3xhO_PGqqOQ?pwd=j9j4 提取码: j9j4 </span><br><span style="font-size: 18px">--来自百度网盘超级会员v9的分享</span></p>
<p><span style="font-size: 18px">如果分享地址失效了，可以邮箱联系我发给你：842107948@qq.com</span></p>
<p><strong>　　</strong></p>
<p><span style="font-size: 14pt"><strong>&nbsp;下载到<strong>format_obproxy_digest_log&nbsp;</strong>文件后上传到Linux服务器，先赋个权限：</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">chmod</span> +x format_obproxy_digest_log</pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/3038670/202501/3038670-20250104023600912-111512134.png" alt="" width="856" height="120" loading="lazy"></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt">&nbsp;<strong>&nbsp;如果不知道这玩意整么用可以执行一下命令：<br></strong></span></p>
<div class="cnblogs_code">
<pre>./format_obproxy_digest_log</pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/3038670/202501/3038670-20250104024154061-1100617874.jpg" alt="" width="891" height="397" loading="lazy"></p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 14pt">使用方式很简单，最后演示下这个输出的日志：</span></strong></p>
<p>&nbsp;</p>
<p><img src="https://img2024.cnblogs.com/blog/3038670/202501/3038670-20250104024641964-1085470420.png" alt="" width="908" height="272" loading="lazy"></p>
<p>&nbsp;</p>
<p><img src="https://img2024.cnblogs.com/blog/3038670/202501/3038670-20250104025010839-1135009291.png" alt="" width="910" height="435" loading="lazy"></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt"><strong>最后想说一下，虽然我文章开头吐槽了一下<strong>OB</strong>，但是吐槽的是OB的日志格式内容不好看，用过<strong>OB</strong>的人都知道，无论是observer还是obproxy，那日志内容恶心得一批。</strong></span></p>
<p><span style="font-size: 14pt"><strong>之前我玩其他数据库出了问题经常看日志，但是自从搞了<strong>OB</strong>以后，我养成了不看日志的习惯。😂😂😂😂</strong></span></p>
<p><strong><span style="font-size: 14pt">无可否认，在当前的国产信创数据库产品中，无论从架构设计、易用性、性能、兼容性，公司研发实力，还是配套生态等方面来看，就目前在我心目中来说，<strong>OceanBase&nbsp;</strong>是当之无愧的国产第一数据库（发自内心的真心话！！！！）</span></strong></p>
<p><span style="font-size: 18.6667px"><strong>诸多因素后面决定不在OB干了，还是希望公司的发展能越来越好，产品能越来越完善。</strong></span></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.23868249341550926" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-04 03:17">2025-01-04 03:07</span>&nbsp;
<a href="https://www.cnblogs.com/yuzhijian">小至尖尖</a>&nbsp;
阅读(<span id="post_view_count">31</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18651324" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18651324);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18651324', targetLink: 'https://www.cnblogs.com/yuzhijian/p/18651324', title: '使用format_obproxy_digest_log工具分析obproxy网络层耗时SQL' })">举报</a>
</div>
        