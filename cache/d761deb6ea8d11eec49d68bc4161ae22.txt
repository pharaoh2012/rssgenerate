
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/saas-open/p/18711620" title="发布于 2025-02-12 15:15">
    <span role="heading" aria-level="2">定制化训练DeepSeek模型：LoAR、COT推理与SFT技术应用</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1 class="md-end-block md-heading"><span class="md-plain md-expand">DeepSeek-R1 模型微调系列</span></h1>
<div class="md-toc md-end-block">
<p class="md-toc-content"><span class="md-toc-item md-toc-h1" data-ref="n1063"><a class="md-toc-inner">DeepSeek-R1 模型微调系列</a><span class="md-toc-item md-toc-h1" data-ref="n1067"><a class="md-toc-inner">一. 前言介绍</a><span class="md-toc-item md-toc-h2" data-ref="n1779"><a class="md-toc-inner">本文内容：</a><span class="md-toc-item md-toc-h2" data-ref="n1068"><a class="md-toc-inner">1.1 项目背景</a><span class="md-toc-item md-toc-h2" data-ref="n1104"><a class="md-toc-inner">1.2 LoRA和 QLoRA 简介</a><span class="md-toc-item md-toc-h2" data-ref="n1136"><a class="md-toc-inner">1.3 LLaMA 架构和 <strong>Qwen 架构</strong></a><span class="md-toc-item md-toc-h3" data-ref="n1162"><a class="md-toc-inner"><strong>LLaMA 架构</strong></a><span class="md-toc-item md-toc-h3" data-ref="n1185"><a class="md-toc-inner"><strong>Qwen 架构</strong></a><span class="md-toc-item md-toc-h1" data-ref="n1205"><a class="md-toc-inner">二. 环境准备</a><span class="md-toc-item md-toc-h2" data-ref="n1206"><a class="md-toc-inner">2.1 Unsloth 安装（显卡版本-暂时不用）</a><span class="md-toc-item md-toc-h2" data-ref="n1220"><a class="md-toc-inner">2.2 创建Python项目</a><span class="md-toc-item md-toc-h2" data-ref="n1223"><a class="md-toc-inner">2.3 python 依赖库</a><span class="md-toc-item md-toc-h2" data-ref="n1226"><a class="md-toc-inner">2.2 LoRA peft 安装</a><span class="md-toc-item md-toc-h2" data-ref="n1236"><a class="md-toc-inner">2.3 WandB 设置</a><span class="md-toc-item md-toc-h2" data-ref="n1244"><a class="md-toc-inner">2.4 modelscope pull 模型</a><span class="md-toc-item md-toc-h2" data-ref="n1247"><a class="md-toc-inner">2.5 测试模型使用</a><span class="md-toc-item md-toc-h1" data-ref="n1255"><a class="md-toc-inner">三. 训练数据数据</a><span class="md-toc-item md-toc-h2" data-ref="n1256"><a class="md-toc-inner">3.1 准备数据集</a><span class="md-toc-item md-toc-h2" data-ref="n1277"><a class="md-toc-inner">3.2 数据清洗</a><span class="md-toc-item md-toc-h2" data-ref="n1281"><a class="md-toc-inner">3.3 训练数据</a><span class="md-toc-item md-toc-h2" data-ref="n1293"><a class="md-toc-inner">3.3 训练模型并保存</a><span class="md-toc-item md-toc-h2" data-ref="n1328"><a class="md-toc-inner">3.4 合并模型文件</a><span class="md-toc-item md-toc-h2" data-ref="n1327"><a class="md-toc-inner">3.4 评估和监控训练过程</a><span class="md-toc-item md-toc-h3" data-ref="n1355"><a class="md-toc-inner">评估（<code>eval/</code>）相关信息：</a><span class="md-toc-item md-toc-h3" data-ref="n1363"><a class="md-toc-inner">训练（<code>train/</code>）相关信息：</a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
</div>
<p class="md-end-block md-p">&nbsp;</p>
<h1 class="md-end-block md-heading"><span class="md-plain">一. 前言介绍</span></h1>
<h2 class="md-end-block md-heading"><span class="md-plain">本文内容：</span></h2>
<ol class="ol-list">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>模型加载与预处理</strong><span class="md-plain">：详细讲解如何加载预训练模型、分词器，并处理输入数据集。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>LoRA配置</strong><span class="md-plain">：介绍如何使用LoRA技术配置模型，并高效进行微调，节省计算资源。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>训练过程</strong><span class="md-plain">：展示了如何配置训练参数，使用SFTTrainer进行训练，并通过WandB记录训练日志。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>模型保存与评估</strong><span class="md-plain">：如何保存微调后的模型，以及如何通过合适的评估集对模型进行验证。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>模型合并</strong><span class="md-plain">：展示了如何通过加权平均的方式合并多个模型权重，得到一个更强大的模型。</span></span></p>
</li>
</ol>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">1.1 项目背景</span></h2>
<p class="md-end-block md-p"><span class="md-plain"> <span class="md-pair-s"><strong>本文档描述了如何在MAC笔记本上对</strong><span class="md-plain"> <span class="md-pair-s "><strong>DeepSeek-R1-Distill-Llama-1.5B</strong><span class="md-plain"> <span class="md-pair-s "><strong>Qwen架构</strong><span class="md-plain"> 进行高效微调，使用** <span class="md-pair-s "><strong>transformers</strong><span class="md-plain"> <span class="md-pair-s "><strong>进行数据处理，并结合</strong><span class="md-plain"> <span class="md-pair-s "><strong>LoRA</strong><span class="md-plain"> <span class="md-pair-s "><strong>技术进行模型微调，使用</strong><span class="md-plain"> <span class="md-pair-s "><strong>WandB</strong><span class="md-plain"> <span class="md-pair-s "><strong>监控训练过程，</strong><span class="md-plain"> <span class="md-pair-s "><strong>ModelScope</strong><span class="md-plain"> <span class="md-pair-s"><strong>下载模型。（训练数据量大约2w条左右）</strong></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">由于为MAC笔记本本地训练 无显卡支持 故而放弃（DeepSeek-R1-Distill-Qwen-7B Q wen）</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-pair-s"><strong>下载的服务信息如下：</strong></span></p>
<table class="md-table">
<thead>
<tr class="md-end-block"><th><span class="td-span"><span class="md-plain">安装服务</span></span></th><th><span class="td-span"><span class="md-plain">版本名称</span></span></th><th><span class="td-span"><span class="md-plain">作用</span></span></th></tr>
</thead>
<tbody>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>Unsloth</strong></span></span></td>
<td>&nbsp;</td>
<td><span class="td-span"><span class="md-plain">用于数据处理和模型微调。</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>Transformers</strong></span></span></td>
<td>&nbsp;</td>
<td><span class="td-span"><span class="md-plain">Hugging Face 提供的模型库，用于加载和微调 DeepSeek-R1。</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>WandB</strong></span></span></td>
<td>&nbsp;</td>
<td><span class="td-span"><span class="md-plain">用于训练过程的实时监控和可视化。</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>LoRA</strong></span></span></td>
<td>&nbsp;</td>
<td><span class="td-span"><span class="md-plain">用于微调的低秩适应技术。</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>ModelScope</strong></span></span></td>
<td>&nbsp;</td>
<td><span class="td-span"><span class="md-plain">用于下载 DeepSeek-R1-8b 模型。</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>python3.11</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">Python 3.11</span></span></td>
<td><span class="td-span"><span class="md-plain">用于执行 Python 脚本和训练任务。</span></span></td>
</tr>
</tbody>
</table>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">1.2 LoRA和 QLoRA 简介</span></h2>
<p class="md-end-block md-p"><span class="md-plain">以下是 LoRA 和 QLoRA 的区别表格：</span></p>
<table class="md-table">
<thead>
<tr class="md-end-block"><th><span class="td-span"><span class="md-plain">特性</span></span></th><th><span class="td-span"><span class="md-pair-s ">LoRA (Low-Rank Adaptation)</span></span></th><th><span class="td-span"><span class="md-pair-s ">QLoRA (Quantized LoRA)</span></span></th></tr>
</thead>
<tbody>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>核心原理</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">通过低秩矩阵分解减少需要调整的参数量</span></span></td>
<td><span class="td-span"><span class="md-plain">在 LoRA 的基础上结合量化技术，进一步减少存储和计算需求</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>主要优点</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">降低训练时需要调整的参数数量，提高微调效率</span></span></td>
<td><span class="td-span"><span class="md-plain">除了低秩矩阵，还通过量化减少内存占用，适用于资源有限的环境</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>存储需求</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">较低，但不如 QLoRA 节省内存</span></span></td>
<td><span class="td-span"><span class="md-plain">显著减少内存使用，适合在内存受限的设备上使用</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>计算效率</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">提高训练效率，减少计算资源消耗</span></span></td>
<td><span class="td-span"><span class="md-plain">量化后的低精度计算进一步提高了计算效率，降低了开销</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>适用场景</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">计算资源有限但不需要极限压缩的场景</span></span></td>
<td><span class="td-span"><span class="md-plain">内存和计算资源极其有限的环境，特别是在边缘设备上使用</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>适用硬件</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">适用于大多数硬件设备，尤其是高性能计算环境</span></span></td>
<td><span class="td-span"><span class="md-plain">特别适合内存有限的硬件，如边缘设备、低内存服务器等</span></span></td>
</tr>
</tbody>
</table>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">1.3 LLaMA 架构和 <span class="md-pair-s ">Qwen 架构</span></span></h2>
<table class="md-table">
<thead>
<tr class="md-end-block"><th><span class="td-span"><span class="md-plain">特性</span></span></th><th><span class="td-span"><span class="md-plain">LLaMA 架构</span></span></th><th><span class="td-span"><span class="md-plain">Qwen 架构</span></span></th></tr>
</thead>
<tbody>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>开发者</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">Meta（Facebook）</span></span></td>
<td><span class="td-span"><span class="md-plain">深度求索（DeepSeek）</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>设计目标</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">高效、轻量化</span></span></td>
<td><span class="td-span"><span class="md-plain">中文优化、多语言支持</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>参数量</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">7B、13B、33B、65B 等</span></span></td>
<td><span class="td-span"><span class="md-plain">7B、14B 等</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>开源情况</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">开源</span></span></td>
<td><span class="td-span"><span class="md-plain">部分开源或未完全公开</span></span></td>
</tr>
<tr class="md-end-block">
<td><span class="td-span"><span class="md-pair-s "><strong>适用场景</strong></span></span></td>
<td><span class="td-span"><span class="md-plain">资源有限的环境</span></span></td>
<td><span class="td-span"><span class="md-plain">中文任务、多语言任务</span></span></td>
</tr>
</tbody>
</table>
<h3 class="md-end-block md-heading"><span class="md-pair-s ">LLaMA 架构</span></h3>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>全称</strong><span class="md-plain">：Large Language Model Meta AI（LLaMA）</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>开发者</strong><span class="md-plain">：由 Meta（原 Facebook）开发。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>特点</strong><span class="md-plain">：</span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>高效性</strong><span class="md-plain">：LLaMA 旨在以较少的参数量实现高性能，专注于优化计算效率。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>轻量化</strong><span class="md-plain">：模型参数量相对较小（如 7B、13B、33B、65B），但通过高质量数据和训练方法，性能接近甚至超越更大的模型。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>开源</strong><span class="md-plain">：Meta 发布了 LLaMA 的权重和代码，供研究社区使用。</span></span></p>
</li>
</ul>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>应用场景</strong><span class="md-plain">：</span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">适合资源有限的环境，如本地部署或移动设备。</span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">适用于各种 NLP 任务，尤其是在生成、问答、文本分类等任务中，具有较好的性能和效率。</span></p>
</li>
</ul>
</li>
</ul>
<div class="md-hr md-end-block"><hr></div>
<h3 class="md-end-block md-heading"><span class="md-pair-s ">Qwen 架构</span></h3>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>开发者</strong><span class="md-plain">：由中国的深度求索（DeepSeek）团队开发。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>特点</strong><span class="md-plain">：</span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>定制化设计</strong><span class="md-plain">：Qwen 可能是针对中文或特定任务优化的架构，具体细节未完全公开。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>多语言支持</strong><span class="md-plain">：Qwen 系列模型通常对中文有较好的支持，同时在英文和多语言任务上也有不错的表现。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>参数量灵活</strong><span class="md-plain">：Qwen 系列包括不同规模的模型（如 7B、14B 等），适合不同场景。</span></span></p>
</li>
</ul>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>应用场景</strong><span class="md-plain">：</span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">Qwen 适用于文本生成、自动化内容创作、对话系统、语音合成等任务。</span></p>
</li>
</ul>
</li>
</ul>
<div class="md-hr md-end-block"><hr></div>
<p class="md-end-block md-p">&nbsp;</p>
<h1 class="md-end-block md-heading"><span class="md-plain">二. 环境准备</span></h1>
<h2 class="md-end-block md-heading"><span class="md-plain">2.1 Unsloth 安装（显卡版本-暂时不用）</span></h2>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>Unsloth</strong><span class="md-plain"> 是一个用于数据处理和模型微调的工具。您可以通过以下命令安装：</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">MAC不试用，需要显卡</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">##官网：https://github.com/unslothai/unsloth<br><span><span>​<br><span><span class="cm-comment">#01 创建项目，并设置python虚拟环境，python3.11版本<br><span><span>​<br><span><span class="cm-comment">#02 安装 unsloth（cpu版本）<br><span><span class="cm-variable">brew <span class="cm-variable">install <span class="cm-variable">llvm（Homebrew <span class="cm-variable">clang <span class="cm-variable">version <span class="cm-number">19.1.7<span class="cm-variable">）<br><span><span class="cm-variable">echo <span class="cm-string">'export PATH="/opt/homebrew/opt/llvm/bin:$PATH"' <span class="cm-operator">&gt;&gt; <span class="cm-operator">~/.<span class="cm-property">zshrc<br><span><span class="cm-variable">source <span class="cm-operator">~/.<span class="cm-property">zshrc<br><span><span>​<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">torch<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">numpy<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-string">"unsloth[colab-new] @ git+https://github.com/unslothai/unsloth.git"<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span class="cm-comment">#03 版本检查<br><span><span class="cm-variable">python <span class="cm-operator">-<span class="cm-variable">c <span class="cm-string">"import torch; print(torch.__version__)"<br><span><span class="cm-number">2.6.0<br><span><span>​<br><span><span class="cm-comment">#04 引用<br><span><span class="cm-keyword">from <span class="cm-variable">unsloth <span class="cm-keyword">import <span class="cm-variable">FastLanguageModel<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">安装完成后，您可以使用 <span class="md-pair-s "><strong>Unsloth</strong><span class="md-plain"> 进行数据的预处理、加载和微调模型。</span></span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">暂时不使用</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 linux 服务建议使用docker<br><span><span>​<br><span><span>​<br><span><span class="cm-comment">#02 拉取镜像<br><span><span class="cm-variable">docker <span class="cm-variable">pull <span class="cm-variable">modelscope<span class="cm-operator">-<span class="cm-variable">registry.<span class="cm-property">us<span class="cm-operator">-<span class="cm-variable">west<span class="cm-operator">-<span class="cm-number">1.<span class="cm-variable">cr.<span class="cm-property">aliyuncs.<span class="cm-property">com<span class="cm-operator">/<span class="cm-variable">modelscope<span class="cm-operator">-<span class="cm-variable">repo<span class="cm-operator">/<span class="cm-variable">modelscope:<span class="cm-variable">ubuntu22<span class="cm-number">.04<span class="cm-operator">-<span class="cm-variable">py310<span class="cm-operator">-<span class="cm-variable">torch2<span class="cm-number">.3.1<span class="cm-operator">-<span class="cm-number">1.22.2<br><span><span>​<br><span><span class="cm-comment">#03 启动<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">2.2 创建Python项目</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 环境是python3.11<br><span><span>​<br><span><span class="cm-comment">#02 项目目录<br><span><span class="cm-variable">Unsloth<span class="cm-operator">-<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">b<span class="cm-operator">/<br><span><span class="cm-variable">├── <span class="cm-variable">data<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 存放训练数据、验证数据等<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">├── <span class="cm-variable">raw<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 原始数据<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">processed<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 预处理后的数据<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">models<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 存放模型文件<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">├── <span class="cm-variable">checkpoints<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 存储训练过程中的模型检查点<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">final_model<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 存储最终微调后的模型<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">scripts<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 存放训练脚本、数据处理脚本等<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">├── <span class="cm-variable">train.<span class="cm-property">py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 训练脚本<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">├── <span class="cm-variable">data_preprocessing.<span class="cm-property">py<span class="cm-comment"># 数据预处理脚本<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">evaluate.<span class="cm-property">py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 评估脚本<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">logs<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 存放训练日志文件<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">training_logs.<span class="cm-property">txt &nbsp; &nbsp;<span class="cm-comment"># 训练过程中的日志<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">wandb<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 存放 wandb 相关的配置和记录<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">wandb_config.<span class="cm-property">py &nbsp; &nbsp; &nbsp;<span class="cm-comment"># wandb 配置文件<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">environment<span class="cm-operator">/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 环境配置文件<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">├── <span class="cm-variable">requirements.<span class="cm-property">txt &nbsp; &nbsp; <span class="cm-comment"># 项目的 Python 依赖<br><span><span class="cm-variable">│ &nbsp; <span class="cm-variable">└── <span class="cm-variable">environment.<span class="cm-property">yml &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 如果使用 Conda，可以创建一个环境配置文件<br><span><span class="cm-variable">│<br><span><span class="cm-variable">├── <span class="cm-variable">main.<span class="cm-property">py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 主运行文件，启动训练或其他任务<br><span><span class="cm-variable">└── <span class="cm-variable">README.<span class="cm-property">md &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 项目的描述文件，包含如何使用和运行的说明<br><span><span>​<br><span><span>​<br><span><span class="cm-comment">#03 创建目录<br><span><span class="cm-comment"># 创建子目录<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">data<span class="cm-operator">/<span class="cm-variable">raw<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">data<span class="cm-operator">/<span class="cm-variable">processed<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">checkpoints<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">final_model<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">scripts<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">logs<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">wandb<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p <span class="cm-variable">environment<br><span><span>​<br><span><span class="cm-comment"># 创建文件<br><span><span class="cm-variable">touch <span class="cm-variable">scripts<span class="cm-operator">/<span class="cm-variable">train.<span class="cm-property">py<br><span><span class="cm-variable">touch <span class="cm-variable">scripts<span class="cm-operator">/<span class="cm-variable">data_preprocessing.<span class="cm-property">py<br><span><span class="cm-variable">touch <span class="cm-variable">scripts<span class="cm-operator">/<span class="cm-variable">evaluate.<span class="cm-property">py<br><span><span class="cm-variable">touch <span class="cm-variable">logs<span class="cm-operator">/<span class="cm-variable">training_logs.<span class="cm-property">txt<br><span><span class="cm-variable">touch <span class="cm-variable">wandb<span class="cm-operator">/<span class="cm-variable">wandb_config.<span class="cm-property">py<br><span><span class="cm-variable">touch <span class="cm-variable">environment<span class="cm-operator">/<span class="cm-variable">requirements.<span class="cm-property">txt<br><span><span class="cm-variable">touch <span class="cm-variable">environment<span class="cm-operator">/<span class="cm-variable">environment.<span class="cm-property">yml<br><span><span class="cm-variable">touch <span class="cm-variable">main.<span class="cm-property">py<br><span><span class="cm-variable">touch <span class="cm-variable">README.<span class="cm-property">md<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">2.3 python 依赖库</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#03 安装即可<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">torch<span class="cm-operator">==<span class="cm-number">2.6.0 <span class="cm-variable">transformers <span class="cm-variable">datasets<br><span><span>​<br><span><span class="cm-comment">#03 更新证书(后续如果有pip网站使用https 会验证该证书)<br><span><span class="cm-operator">/<span class="cm-variable">Applications<span class="cm-operator">/<span class="cm-variable">Python\ <span class="cm-number">3.11<span class="cm-operator">/<span class="cm-variable">Install\ <span class="cm-variable">Certificates.<span class="cm-property">command<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">2.2 LoRA peft 安装</span></h2>
<p class="md-end-block md-p"><span class="md-pair-s "><strong>LoRA 和 PEFT 的安装</strong><span class="md-plain">：</span></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>LoRA</strong><span class="md-plain"> 和 <span class="md-pair-s "><strong>PEFT</strong><span class="md-plain"> 是用于高效微调的技术。如果你想在 Mac 上使用这些技术来微调 DeepSeek 模型，你需要安装相关的依赖项。</span></span></span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">PEFT 包含了 LoRA 的实现，并且它使得你能够通过修改模型的一部分参数来进行高效微调，从而不需要调整整个模型的权重。</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 安装 peft<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">peft<br><span><span>​</span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading md-focus"><span class="md-plain md-expand">2.3 WandB 设置</span></h2>
<p class="md-end-block md-p"><span class="md-pair-s "><strong>WandB</strong><span class="md-plain"> 是一个用于训练过程实时监控和可视化的工具。您可以通过以下步骤设置 <span class="md-pair-s "><strong>WandB</strong><span class="md-plain">：</span></span></span></span></p>
<ol class="ol-list" start="">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">注册并登录 <span class="md-meta-i-c  md-link"><a href="https://wandb.ai/" rel="noopener nofollow"><span class="md-plain">WandB官网</span></a><span class="md-plain">。</span></span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">获取您的 API 密钥并配置环境变量：</span></p>
</li>
</ol>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 aipkey (本人谷歌邮箱)<br><span><span class="cm-number"><span class="cm-variable"><br><span><span>​<br><span><span class="cm-comment">#02 命令<br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">wandb<br><span><span class="cm-variable">wandb <span class="cm-variable">login<br><span><span>​<br><span><span class="cm-comment">#02  运行文件<br><span><span class="cm-keyword">import <span class="cm-variable">wandb &nbsp;<span class="cm-comment"># 导入 wandb 库，用于跟踪和可视化实验<br><span><span class="cm-keyword">import <span class="cm-variable">random &nbsp;<span class="cm-comment"># 导入 random 库，用于生成随机数<br><span><span>​<br><span><span class="cm-comment"># 开始一个新的 wandb 运行来跟踪当前脚本<br><span><span class="cm-variable">wandb.<span class="cm-property">init(<br><span> &nbsp; &nbsp;<span class="cm-comment"># 设置 wandb 项目，所有与该运行相关的数据将被记录到这个项目中<br><span> &nbsp; &nbsp;<span class="cm-variable">project<span class="cm-operator">=<span class="cm-string">"my-awesome-project", &nbsp;<span class="cm-comment"># 项目名称，你可以在 wandb 仪表盘中看到这个项目<br><span> &nbsp; &nbsp;<br><span> &nbsp; &nbsp;<span class="cm-comment"># 追踪超参数和运行的元数据<br><span> &nbsp; &nbsp;<span class="cm-variable">config<span class="cm-operator">={<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"learning_rate": <span class="cm-number">0.02, &nbsp;<span class="cm-comment"># 设置学习率<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"architecture": <span class="cm-string">"CNN", &nbsp;<span class="cm-comment"># 模型架构（这里是卷积神经网络）<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"dataset": <span class="cm-string">"CIFAR-100", &nbsp;<span class="cm-comment"># 使用的数据集（这里是 CIFAR-100 数据集）<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"epochs": <span class="cm-number">10, &nbsp;<span class="cm-comment"># 训练的轮数<br><span> &nbsp;  }<br><span>)<br><span><span>​<br><span><span class="cm-comment"># 模拟训练过程<br><span><span class="cm-variable">epochs <span class="cm-operator">= <span class="cm-number">10 &nbsp;<span class="cm-comment"># 总训练轮数<br><span><span class="cm-variable">offset <span class="cm-operator">= <span class="cm-variable">random.<span class="cm-property">random() <span class="cm-operator">/ <span class="cm-number">5 &nbsp;<span class="cm-comment"># 生成一个小的随机偏移量，用于模拟训练过程中一些不确定性<br><span><span>​<br><span><span class="cm-comment"># 开始训练循环，模拟 2 到 10 轮的训练过程<br><span><span class="cm-keyword">for <span class="cm-variable">epoch <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">2, <span class="cm-variable">epochs): &nbsp;<span class="cm-comment"># 从第二轮开始，到第 10 轮结束<br><span> &nbsp; &nbsp;<span class="cm-comment"># 模拟准确率的变化，随着 epoch 的增加，准确率逐渐提升<br><span> &nbsp; &nbsp;<span class="cm-variable">acc <span class="cm-operator">= <span class="cm-number">1 <span class="cm-operator">- <span class="cm-number">2 <span class="cm-operator">** <span class="cm-operator">-<span class="cm-variable">epoch <span class="cm-operator">- <span class="cm-variable">random.<span class="cm-property">random() <span class="cm-operator">/ <span class="cm-variable">epoch <span class="cm-operator">- <span class="cm-variable">offset<br><span> &nbsp; &nbsp;<br><span> &nbsp; &nbsp;<span class="cm-comment"># 模拟损失的变化，随着 epoch 的增加，损失逐渐减少<br><span> &nbsp; &nbsp;<span class="cm-variable">loss <span class="cm-operator">= <span class="cm-number">2 <span class="cm-operator">** <span class="cm-operator">-<span class="cm-variable">epoch <span class="cm-operator">+ <span class="cm-variable">random.<span class="cm-property">random() <span class="cm-operator">/ <span class="cm-variable">epoch <span class="cm-operator">+ <span class="cm-variable">offset<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-comment"># 使用 wandb 记录每一轮的准确率（acc）和损失值（loss）<br><span> &nbsp; &nbsp;<span class="cm-variable">wandb.<span class="cm-property">log({<span class="cm-string">"acc": <span class="cm-variable">acc, <span class="cm-string">"loss": <span class="cm-variable">loss})<br><span><span>​<br><span><span class="cm-comment"># [可选] 结束 wandb 运行，确保数据被正确上传并完成记录<br><span><span class="cm-variable">wandb.<span class="cm-property">finish()<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<h2 class="md-end-block md-heading"><span class="md-plain">2.4 modelscope pull 模型</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 安装modelscope <br><span><span class="cm-variable">pip <span class="cm-variable">install <span class="cm-variable">modelscope<br><span><span>​<br><span><span class="cm-comment">#02 下载模型文件<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Llama<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">B<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">1.5<span class="cm-variable">B<br><span><span class="cm-variable">mkdir <span class="cm-operator">-<span class="cm-variable">p .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">7<span class="cm-variable">B<br><span><span>​<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">model <span class="cm-variable">deepseek<span class="cm-operator">-<span class="cm-variable">ai<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Llama<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">B <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Llama<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">B<br><span><span>​<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">model <span class="cm-variable">deepseek<span class="cm-operator">-<span class="cm-variable">ai<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">1.5<span class="cm-variable">B <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">1.5<span class="cm-variable">B<br><span><span>​<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">model <span class="cm-variable">deepseek<span class="cm-operator">-<span class="cm-variable">ai<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">7<span class="cm-variable">B <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Qwen<span class="cm-operator">-<span class="cm-number">7<span class="cm-variable">B<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">model <span class="cm-variable">deepseek<span class="cm-operator">-<span class="cm-variable">ai<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Llama<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">B <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">-<span class="cm-variable">Distill<span class="cm-operator">-<span class="cm-variable">Llama<span class="cm-operator">-<span class="cm-number">8<span class="cm-variable">B</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">2.5 测试模型使用</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-string">"""<br><span><span>​<br><span><span>​<br><span><span class="cm-string">训练前询问问题：<br><span class="cm-tab-wrap-hack"><span class="cm-string"><span class="cm-tab">  皮质醇增多症患者在血浆ACTH明显升高且大剂量地塞米松抑制试验阳性的情况下，应考虑哪种疾病？<br><span class="cm-tab-wrap-hack"><span class="cm-string"><span class="cm-tab">  <br><span><span class="cm-string">训练后再次询问：<br><span><span>​<br><span><span>​<br><span><span class="cm-string">scripts/test_inference.py<br><span><span>​<br><span><span class="cm-string">"""<br><span><span>​<br><span><span>​<br><span><span class="cm-keyword">import <span class="cm-variable">os<br><span><span class="cm-keyword">from <span class="cm-variable">transformers <span class="cm-keyword">import <span class="cm-variable">AutoModelForCausalLM, <span class="cm-variable">AutoTokenizer<br><span><span class="cm-keyword">import <span class="cm-variable">torch<br><span><span>​<br><span><span class="cm-comment"># 获取当前脚本的路径<br><span><span class="cm-variable">current_dir <span class="cm-operator">= <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">dirname(<span class="cm-variable">__file__)<br><span><span>​<br><span><span class="cm-comment"># 拼接模型和分词器路径<br><span><span class="cm-variable">model_dir <span class="cm-operator">= <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">join(<span class="cm-variable">current_dir, <span class="cm-string">'..', <span class="cm-string">'models', <span class="cm-string">'DeepSeek-R1-Distill-Qwen-1.5B')<br><span><span>​<br><span><span class="cm-comment"># 打印路径确认<br><span><span class="cm-builtin">print(<span class="cm-string">f"Model path: {<span class="cm-variable">model_dir}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 确保模型和分词器的路径存在<br><span><span class="cm-keyword">if <span class="cm-keyword">not <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">exists(<span class="cm-variable">model_dir):<br><span> &nbsp; &nbsp;<span class="cm-keyword">raise <span class="cm-variable">ValueError(<span class="cm-string">f"Model directory does not exist at {<span class="cm-variable">model_dir}<span class="cm-string">")<br><span><span class="cm-keyword">else:<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"Model directory exists, proceeding with loading.")<br><span><span>​<br><span><span class="cm-comment"># 加载模型和分词器<br><span><span class="cm-builtin">print(<span class="cm-string">"Loading model and tokenizer...")<br><span><span class="cm-variable">model <span class="cm-operator">= <span class="cm-variable">AutoModelForCausalLM.<span class="cm-property">from_pretrained(<span class="cm-variable">model_dir)<br><span><span class="cm-variable">tokenizer <span class="cm-operator">= <span class="cm-variable">AutoTokenizer.<span class="cm-property">from_pretrained(<span class="cm-variable">model_dir)<br><span><span>​<br><span><span class="cm-comment"># 打印模型和分词器的配置信息<br><span><span class="cm-builtin">print(<span class="cm-string">f"Model config: {<span class="cm-variable">model.<span class="cm-property">config}<span class="cm-string">")<br><span><span class="cm-builtin">print(<span class="cm-string">f"Tokenizer config: {<span class="cm-variable">tokenizer}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 输入中文文本<br><span><span class="cm-variable">input_text <span class="cm-operator">= <span class="cm-string">"皮质醇增多症患者在血浆ACTH明显升高且大剂量地塞米松抑制试验阳性的情况下，应考虑哪种疾病？"<br><span><span class="cm-builtin">print(<span class="cm-string">f"User input: {<span class="cm-variable">input_text}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 结构化的 prompt<br><span><span class="cm-variable">prompt_style_chat <span class="cm-operator">= <span class="cm-string">f"""请写出一个恰当的回答来完成当前对话任务。<br><span><span>​<br><span><span class="cm-string">### Instruction:<br><span><span class="cm-string">你是一名助人为乐的助手。<br><span><span>​<br><span><span class="cm-string">### Question:<br><span>{<span class="cm-variable">input_text}<br><span><span>​<br><span><span class="cm-string">### Response:<br><span><span class="cm-string">&lt;think&gt;"""<br><span><span>​<br><span><span class="cm-comment"># 使用分词器处理输入文本<br><span><span class="cm-variable">inputs <span class="cm-operator">= <span class="cm-variable">tokenizer(<span class="cm-variable">prompt_style_chat, <span class="cm-variable">return_tensors<span class="cm-operator">=<span class="cm-string">"pt", <span class="cm-variable">padding<span class="cm-operator">=<span class="cm-keyword">True, <span class="cm-variable">truncation<span class="cm-operator">=<span class="cm-keyword">True, <span class="cm-variable">max_length<span class="cm-operator">=<span class="cm-number">512)<br><span><span>​<br><span><span class="cm-comment"># 打印 tokenized 输入<br><span><span class="cm-builtin">print(<span class="cm-string">f"Tokenized input: {<span class="cm-variable">inputs}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 打印输入形状<br><span><span class="cm-builtin">print(<span class="cm-string">f"Input shape: {<span class="cm-variable">inputs[<span class="cm-string">'input_ids'].<span class="cm-property">shape}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 打印模型的最大长度<br><span><span class="cm-builtin">print(<span class="cm-string">f"Model max length: {<span class="cm-variable">model.<span class="cm-property">config.<span class="cm-property">max_position_embeddings}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 将模型移至正确的设备（使用 GPU 如果可用）<br><span><span class="cm-variable">device <span class="cm-operator">= <span class="cm-string">"cuda" <span class="cm-keyword">if <span class="cm-variable">torch.<span class="cm-property">cuda.<span class="cm-property">is_available() <span class="cm-keyword">else <span class="cm-string">"cpu"<br><span><span class="cm-variable">model.<span class="cm-property">to(<span class="cm-variable">device)<br><span><span>​<br><span><span class="cm-comment"># 打印设备信息<br><span><span class="cm-builtin">print(<span class="cm-string">f"Using device: {<span class="cm-variable">device}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 打印分词器的 pad_token_id<br><span><span class="cm-variable">pad_token_id <span class="cm-operator">= <span class="cm-variable">tokenizer.<span class="cm-property">pad_token_id <span class="cm-keyword">if <span class="cm-variable">tokenizer.<span class="cm-property">pad_token_id <span class="cm-keyword">is <span class="cm-keyword">not <span class="cm-keyword">None <span class="cm-keyword">else <span class="cm-variable">model.<span class="cm-property">config.<span class="cm-property">pad_token_id<br><span><span class="cm-builtin">print(<span class="cm-string">f"Using pad_token_id: {<span class="cm-variable">pad_token_id}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 生成模型输出<br><span><span class="cm-builtin">print(<span class="cm-string">"Generating response...")<br><span><span class="cm-comment"># 使用 max_new_tokens 来控制生成长度<br><span><span class="cm-keyword">with <span class="cm-variable">torch.<span class="cm-property">no_grad(): &nbsp;<span class="cm-comment"># 禁用梯度计算，节省内存<br><span> &nbsp; &nbsp;<span class="cm-keyword">try:<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"Calling model.generate()...")<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">outputs <span class="cm-operator">= <span class="cm-variable">model.<span class="cm-property">generate(<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">inputs[<span class="cm-string">'input_ids'].<span class="cm-property">to(<span class="cm-variable">device),<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">attention_mask<span class="cm-operator">=<span class="cm-variable">inputs[<span class="cm-string">'attention_mask'].<span class="cm-property">to(<span class="cm-variable">device),<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">max_new_tokens<span class="cm-operator">=<span class="cm-number">1200, &nbsp;<span class="cm-comment"># 设置最大生成的 token 数量<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">temperature<span class="cm-operator">=<span class="cm-number">1.0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">top_p<span class="cm-operator">=<span class="cm-number">0.9,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pad_token_id<span class="cm-operator">=<span class="cm-variable">pad_token_id<br><span> &nbsp; &nbsp; &nbsp;  )<br><span><span>​<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"Model.generate() completed.")<br><span> &nbsp; &nbsp;<span class="cm-keyword">except <span class="cm-variable">Exception <span class="cm-keyword">as <span class="cm-variable">e:<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f"Error generating response: {<span class="cm-variable">e}<span class="cm-string">")<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">raise<br><span><span>​<br><span><span class="cm-comment"># 打印生成的输出 ID 和它们的形状<br><span><span class="cm-builtin">print(<span class="cm-string">f"Generated output IDs: {<span class="cm-variable">outputs}<span class="cm-string">")<br><span><span class="cm-builtin">print(<span class="cm-string">f"Shape of generated output: {<span class="cm-variable">outputs.<span class="cm-property">shape}<span class="cm-string">")<br><span><span>​<br><span><span class="cm-comment"># 解码生成的输出文本<br><span><span class="cm-keyword">try:<br><span> &nbsp; &nbsp;<span class="cm-variable">response <span class="cm-operator">= <span class="cm-variable">tokenizer.<span class="cm-property">decode(<span class="cm-variable">outputs[<span class="cm-number">0], <span class="cm-variable">skip_special_tokens<span class="cm-operator">=<span class="cm-keyword">True)<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f"Generated response: {<span class="cm-variable">response}<span class="cm-string">")<br><span><span class="cm-keyword">except <span class="cm-variable">Exception <span class="cm-keyword">as <span class="cm-variable">e:<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f"Error decoding output: {<span class="cm-variable">e}<span class="cm-string">")<br><span><span>​<br><span><span>​<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">问题回答</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-variable">User <span class="cm-builtin">input: <span class="cm-variable">皮质醇增多症患者在血浆ACTH明显升高且大剂量地塞米松抑制试验阳性的情况下，应考虑哪种疾病？<br><span><span class="cm-variable">Tokenized <span class="cm-builtin">input: {<span class="cm-string">'input_ids': <span class="cm-variable">tensor([[<span class="cm-number">151646, &nbsp;<span class="cm-number">14880, <span class="cm-number">112672, &nbsp;<span class="cm-number">46944, <span class="cm-number">112449, <span class="cm-number">111423, &nbsp;<span class="cm-number">36407, &nbsp;<span class="cm-number">60548, &nbsp;<span class="cm-number">67949,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">105051, &nbsp;<span class="cm-number">88802, &nbsp; <span class="cm-number">3407, &nbsp;<span class="cm-number">14374, &nbsp;<span class="cm-number">29051, &nbsp; &nbsp;<span class="cm-number">510, &nbsp;<span class="cm-number">56568, <span class="cm-number">110124, &nbsp;<span class="cm-number">99262,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">103247, &nbsp;<span class="cm-number">99350, &nbsp; <span class="cm-number">9370, <span class="cm-number">110498, &nbsp; <span class="cm-number">3407, &nbsp;<span class="cm-number">14374, &nbsp;<span class="cm-number">15846, &nbsp; &nbsp;<span class="cm-number">510, &nbsp;<span class="cm-number">99888,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">99178, <span class="cm-number">103032, <span class="cm-number">107284, &nbsp;<span class="cm-number">99769, <span class="cm-number">101924, &nbsp;<span class="cm-number">18493, &nbsp;<span class="cm-number">99389, <span class="cm-number">101498, &nbsp; <span class="cm-number">6823,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">39, <span class="cm-number">100687, <span class="cm-number">109061, <span class="cm-number">100136, &nbsp;<span class="cm-number">26288, <span class="cm-number">114786, &nbsp;<span class="cm-number">29490, <span class="cm-number">101202, &nbsp;<span class="cm-number">72261,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">100180, <span class="cm-number">106555, <span class="cm-number">102360, <span class="cm-number">112758, <span class="cm-number">104248, &nbsp; <span class="cm-number">3837, &nbsp;<span class="cm-number">50511, <span class="cm-number">101118, <span class="cm-number">113195,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">101160, &nbsp;<span class="cm-number">26850, &nbsp;<span class="cm-number">14374, &nbsp; <span class="cm-number">5949, &nbsp; &nbsp;<span class="cm-number">510, <span class="cm-number">151648]]), <span class="cm-string">'attention_mask': <span class="cm-variable">tensor([[<span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1, <span class="cm-number">1]])}<br><span><span class="cm-variable">Input <span class="cm-variable">shape: <span class="cm-variable">torch.<span class="cm-property">Size([<span class="cm-number">1, <span class="cm-number">60])<br><span><span class="cm-variable">Model <span class="cm-builtin">max <span class="cm-variable">length: <span class="cm-number">131072<br><span><span class="cm-variable">Using <span class="cm-variable">device: <span class="cm-variable">cpu<br><span><span class="cm-variable">Using <span class="cm-variable">pad_token_id: <span class="cm-number">151643<br><span><span class="cm-variable">Generating <span class="cm-variable">response<span class="cm-operator">...<br><span><span class="cm-variable">Calling <span class="cm-variable">model.<span class="cm-property">generate()<span class="cm-operator">...<br><span><span class="cm-variable">Model.<span class="cm-property">generate() <span class="cm-variable">completed.<br><span><span>​<br><span><span class="cm-property">Generated <span class="cm-variable">response: <span class="cm-variable">请写出一个恰当的回答来完成当前对话任务。<br><span><span>​<br><span><span class="cm-comment">### Instruction:<br><span><span class="cm-variable">你是一名助人为乐的助手。<br><span><span>​<br><span><span class="cm-comment">### Question:<br><span><span class="cm-variable">皮质醇增多症患者在血浆ACTH明显升高且大剂量地塞米松抑制试验阳性的情况下，应考虑哪种疾病？<br><span><span>​<br><span><span class="cm-comment">### Response:<br><span><span class="cm-operator">&lt;<span class="cm-variable">think<span class="cm-operator">&gt;<br><span><span class="cm-variable">好的，我现在需要仔细分析这个问题并给出一个合适的回答。首先，问题描述的是皮质醇增多症（PHT）患者在血浆ACTH明显升高且大剂量地塞米松抑制试验（SSDS）显示阳性的情况下，应考虑哪种疾病。<br><span><span>​<br><span><span class="cm-variable">首先，我记得皮质醇增多症是由于皮质醇分泌异常导致，通常由代谢紊乱或神经退行性疾病引起，比如皮质醇过激释放症、皮质醇过激释放性代谢综合征等。通常，患者可能表现出皮质醇水平升高，血浆ACTH显著升高，这符合题意的第一个条件。<br><span><span>​<br><span><span class="cm-variable">接下来，第二个条件是SSDS试验阳性。SSDS试验主要用于检测皮质醇释放的细胞因子，比如PD<span class="cm-operator">-<span class="cm-variable">L1，这些因子在疾病早期有显著的表观变化。皮质醇增多症患者的皮质醇释放确实受阻，导致细胞因子释放减少，这在SSDS中会被检测出来，所以这种情况属于皮质醇增多症。<br><span><span>​<br><span><span class="cm-variable">综合这两个条件，患者的血浆ACTH升高和SSDS阳性，符合皮质醇增多症的特征。因此，这种情况下应考虑的是皮质醇增多症。<br><span><span>​<br><span><span class="cm-variable">我需要确保我没有遗漏其他可能导致SSDS试验阳性的情况。比如，是否有一些其他类型的疾病，比如胰岛素素合成障碍或胰岛素缺乏，也会影响皮质醇释放？不过，这些更可能是胰岛素素合成障碍，而不是直接由皮质醇释放受阻引起的。皮质醇增多症通常是由于皮质醇释放异常，因此SSDS阳性更直接与皮质醇释放受阻相关。<br><span><span>​<br><span><span class="cm-variable">此外，ACTH升高可能与皮质醇增多症不同，而更可能是由于激素分泌过量或其他激素调节问题。因此，ACTH升高的信号应该更多指向皮质醇增多症。<br><span><span>​<br><span><span class="cm-variable">综上所述，这种情况下应该考虑的疾病是皮质醇增多症。<br><span><span class="cm-operator">&lt;/<span class="cm-variable">think<span class="cm-operator">&gt;<br><span><span>​<br><span><span class="cm-variable">应考虑皮质醇增多症（Pantoprazolidone <span class="cm-variable">Phenomenon）。<br><span><span>​<br><span><span class="cm-variable">因为：<br><span><span>​<br><span><span class="cm-number">1. <span class="cm-variable">血浆ACTH显著升高，符合皮质醇增多症的特征。<br><span><span class="cm-number">2. <span class="cm-variable">SSDS试验阳性，表明皮质醇释放受阻，属于皮质醇增多症的表现。<br><span><span>​<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h1 class="md-end-block md-heading"><span class="md-plain">三. 训练数据数据</span></h1>
<h2 class="md-end-block md-heading"><span class="md-plain">3.1 准备数据集</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 我们使用COT格式 医学领域 medical-o1-reasoning-SFT 数据集<br><span><span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">huggingface.<span class="cm-property">co<span class="cm-operator">/<span class="cm-variable">datasets<span class="cm-operator">/<span class="cm-variable">FreedomIntelligence<span class="cm-operator">/<span class="cm-variable">medical<span class="cm-operator">-<span class="cm-variable">o1<span class="cm-operator">-<span class="cm-variable">reasoning<span class="cm-operator">-<span class="cm-variable">SFT<br><span><span>​<br><span><span class="cm-comment">#02 b本地导入方式（）<br><span><span class="cm-keyword">from <span class="cm-variable">datasets <span class="cm-keyword">import <span class="cm-variable">load_dataset<br><span><span class="cm-variable">ds <span class="cm-operator">= <span class="cm-variable">load_dataset(<span class="cm-string">"FreedomIntelligence/medical-o1-reasoning-SFT", <span class="cm-string">"zh")<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">Hugging face 数据集</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250208155846921.png"><img alt="image-20250208155846921" height="482" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250208155846921.png?lastModify=1739331767" data-local-refresh="true" data-fixed-size=""></span></p>
<p class="md-end-block md-p">&nbsp;</p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">modelscope</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 使用modelscope 数据集 官网地址<br><span><span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">www.<span class="cm-property">modelscope.<span class="cm-property">cn<span class="cm-operator">/<span class="cm-variable">datasets<span class="cm-operator">/<span class="cm-variable">YIRONGCHEN<span class="cm-operator">/<span class="cm-variable">PsyDTCorpus<span class="cm-operator">/<span class="cm-variable">files<br><span><span>​<br><span><span class="cm-comment">#02 下载完整数据集repo<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">dataset <span class="cm-variable">YIRONGCHEN<span class="cm-operator">/<span class="cm-variable">PsyDTCorpus <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-builtin">dir<br><span><span>​<br><span><span>​<br><span><span class="cm-comment">#03 下载单个文件到指定本地文件夹（以下载README.md到当前路径下“dir”目录为例）<br><span><span class="cm-variable">modelscope <span class="cm-variable">download <span class="cm-operator">--<span class="cm-variable">dataset <span class="cm-variable">YIRONGCHEN<span class="cm-operator">/<span class="cm-variable">PsyDTCorpus <span class="cm-variable">README.<span class="cm-property">md <span class="cm-operator">--<span class="cm-variable">local_dir .<span class="cm-operator">/<span class="cm-builtin">dir<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">下载图示</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250210094853288.png"><img alt="image-20250210094853288" height="208" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250210094853288.png?lastModify=1739331767" data-local-refresh="true" data-fixed-size=""></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">官网</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250210094927913.png"><img alt="image-20250210094927913" height="339" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250210094927913.png?lastModify=1739340166" data-local-refresh="true" data-fixed-size=""></span></p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">3.2 数据清洗</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 用于对medical-o1-reasoning-SFT数据集进行修改，Complex_CoT列和Response列进行拼接，并加上文本结束标记：<br><span><span class="cm-keyword">def <span class="cm-def">formatting_prompts_func(<span class="cm-variable">examples, <span class="cm-variable">EOS_TOKEN):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  格式化数据集中的每个示例，使其符合训练的要求。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  examples (dict): 数据集中的输入示例<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  EOS_TOKEN (str): 结束符<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  dict: 格式化后的文本数据<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-variable">train_prompt_style <span class="cm-operator">= <span class="cm-string">"""Below is an instruction that describes a task, paired with an input that provides further context. <br><span><span class="cm-string"> &nbsp;  Write a response that appropriately completes the request. <br><span><span class="cm-string"> &nbsp;  Before answering, think carefully about the question and create a step-by-step chain of thoughts to ensure a logical and accurate response.<br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Instruction:<br><span><span class="cm-string"> &nbsp;  You are a medical expert with advanced knowledge in clinical reasoning, diagnostics, and treatment planning. <br><span><span class="cm-string"> &nbsp;  Please answer the following medical question. <br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Question:<br><span><span class="cm-string"> &nbsp;  {}<br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Response:<br><span><span class="cm-string"> &nbsp;  &lt;think&gt;<br><span><span class="cm-string"> &nbsp;  {}<br><span><span class="cm-string"> &nbsp;  &lt;/think&gt;<br><span><span class="cm-string"> &nbsp;  {}"""<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-variable">inputs <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Question"]<br><span> &nbsp; &nbsp;<span class="cm-variable">cots <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Complex_CoT"]<br><span> &nbsp; &nbsp;<span class="cm-variable">outputs <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Response"]<br><span> &nbsp; &nbsp;<span class="cm-variable">texts <span class="cm-operator">= []<br><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-builtin">input, <span class="cm-variable">cot, <span class="cm-variable">output <span class="cm-keyword">in <span class="cm-builtin">zip(<span class="cm-variable">inputs, <span class="cm-variable">cots, <span class="cm-variable">outputs):<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">text <span class="cm-operator">= <span class="cm-variable">train_prompt_style.<span class="cm-property">format(<span class="cm-builtin">input, <span class="cm-variable">cot, <span class="cm-variable">output) <span class="cm-operator">+ <span class="cm-variable">EOS_TOKEN<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">texts.<span class="cm-property">append(<span class="cm-variable">text)<br><span> &nbsp; &nbsp;<span class="cm-keyword">return {<span class="cm-string">"text": <span class="cm-variable">texts}<br><span><span>​<br><span><span>​<br><span> &nbsp;<br><span><span class="cm-string">"""<br><span><span>​<br><span><span class="cm-string">问题（{}） 被嵌套到 ### Question: 下面，替换掉 {}。<br><span><span class="cm-string">推理过程（{}） 被嵌套到 &lt;think&gt;&lt;/think&gt; 标签内，替换掉第二个 {}。<br><span><span class="cm-string">答案（{}） 被嵌套到模板的最后，替换掉第三个 {}。<br><span><span class="cm-string">具体替换流程：<br><span><span class="cm-string">{} 第一个位置将会被每个样本中的问题（examples["Question"]）替换。<br><span><span class="cm-string">{} 第二个位置将会被每个样本中的推理过程（examples["Complex_CoT"]）替换。<br><span><span class="cm-string">{} 第三个位置将会被每个样本中的答案（examples["Response"]）替换。<br><span><span class="cm-string">例如，如果输入数据如下：<br><span><span>​<br><span><span class="cm-string">问题（Question）: "What is the cause of fever?"<br><span><span class="cm-string">推理过程（Complex_CoT）: "Fever is usually caused by an infection or inflammation. We need to identify the source."<br><span><span class="cm-string">答案（Response）: "The most common causes of fever are bacterial or viral infections."<br><span><span>​<br><span><span class="cm-string">""" &nbsp;<br><span> &nbsp;<br><span> &nbsp;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">原数据格式</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp; &nbsp;<span class="cm-string">"Question": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"What is the cause of headache?",<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"How do you treat a cold?"<br><span> &nbsp;  ],<br><span> &nbsp; &nbsp;<span class="cm-string">"Complex_CoT": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"The causes of headaches are numerous, including tension, dehydration, or sinus issues.",<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Treating a cold typically involves rest, fluids, and over-the-counter medications for symptoms."<br><span> &nbsp;  ],<br><span> &nbsp; &nbsp;<span class="cm-string">"Response": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"A headache can be caused by stress, lack of sleep, or a sinus infection.",<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"For a cold, hydration and rest are key. Medications like ibuprofen can help with symptoms."<br><span> &nbsp;  ]<br><span>}<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">格式化后数据</span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp; &nbsp;<span class="cm-string">"text": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""Below is an instruction that describes a task, paired with an input that provides further context. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Write a response that appropriately completes the request. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Before answering, think carefully about the question and create a step-by-step chain of thoughts to ensure a logical and accurate response.<br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Instruction:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  You are a medical expert with advanced knowledge in clinical reasoning, diagnostics, and treatment planning. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Please answer the following medical question. <br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Question:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  What is the cause of headache?<br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Response:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  &lt;think&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  The causes of headaches are numerous, including tension, dehydration, or sinus issues.<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  &lt;/think&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  A headache can be caused by stress, lack of sleep, or a sinus infection. &lt;|endoftext|&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """,<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"""Below is an instruction that describes a task, paired with an input that provides further context. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Write a response that appropriately completes the request. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Before answering, think carefully about the question and create a step-by-step chain of thoughts to ensure a logical and accurate response.<br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Instruction:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  You are a medical expert with advanced knowledge in clinical reasoning, diagnostics, and treatment planning. <br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Please answer the following medical question. <br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Question:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  How do you treat a cold?<br><span><span>​<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  ### Response:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  &lt;think&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  Treating a cold typically involves rest, fluids, and over-the-counter medications for symptoms.<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  &lt;/think&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  For a cold, hydration and rest are key. Medications like ibuprofen can help with symptoms. &lt;|endoftext|&gt;<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  """<br><span> &nbsp;  ]<br><span>}<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">3.3 训练数据</span></h2>
<ol class="ol-list">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>setup_wandb</strong><span class="md-plain">: 配置并登录到 <span class="md-pair-s"><code>wandb</code><span class="md-plain"> 进行实验跟踪和日志记录。</span></span></span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>set_paths</strong><span class="md-plain">: 设置根目录、模型路径、数据集路径和保存微调模型的路径。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>load_model_and_tokenizer</strong><span class="md-plain">: 加载预训练模型和分词器，获取结束符。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>formatting_prompts_func</strong><span class="md-plain">: 格式化数据集中的问题和回答，以便训练。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>setup_lora</strong><span class="md-plain">: 配置并应用LoRA（低秩适配器）到模型。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>load_dataset_func</strong><span class="md-plain">: 加载数据集并进行切分，返回训练集和评估集。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>setup_training_args</strong><span class="md-plain">: 设置训练参数，包括学习率、批处理大小、训练周期等。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>train_model</strong><span class="md-plain">: 使用 <span class="md-pair-s"><code>SFTTrainer</code><span class="md-plain"> 进行模型训练。</span></span></span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong>save_model</strong><span class="md-plain">: 保存训练好的模型到指定路径。</span></span></p>
</li>
</ol>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-keyword">import <span class="cm-variable">os<br><span><span class="cm-keyword">import <span class="cm-variable">torch<br><span><span class="cm-keyword">from <span class="cm-variable">transformers <span class="cm-keyword">import <span class="cm-variable">AutoModelForCausalLM, <span class="cm-variable">AutoTokenizer, <span class="cm-variable">TrainingArguments<br><span><span class="cm-keyword">from <span class="cm-variable">datasets <span class="cm-keyword">import <span class="cm-variable">load_dataset<br><span><span class="cm-keyword">from <span class="cm-variable">peft <span class="cm-keyword">import <span class="cm-variable">get_peft_model, <span class="cm-variable">LoraConfig<br><span><span class="cm-keyword">from <span class="cm-variable">trl <span class="cm-keyword">import <span class="cm-variable">SFTTrainer &nbsp;<span class="cm-comment"># 使用 SFTTrainer<br><span><span class="cm-keyword">import <span class="cm-variable">wandb<br><span><span class="cm-keyword">from <span class="cm-variable">config <span class="cm-keyword">import <span class="cm-variable">setting<br><span><span>​<br><span><span class="cm-comment"># 设置环境变量，禁用tokenizer的并行化<br><span><span class="cm-variable">os.<span class="cm-property">environ[<span class="cm-string">"TOKENIZERS_PARALLELISM"] <span class="cm-operator">= <span class="cm-string">"false"<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 登录wandb<br><span><span class="cm-keyword">def <span class="cm-def">setup_wandb():<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  登录到wandb以便记录训练过程中的日志和指标。<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-variable">wandb.<span class="cm-property">login()<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 设置路径<br><span><span class="cm-keyword">def <span class="cm-def">set_paths():<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  设置项目根目录、模型路径、数据集路径和最终模型保存路径。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model_dir (str): 模型文件路径<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  dataset_path (str): 数据集路径<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  final_model_dir (str): 微调后模型的保存路径<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-variable">root_dir <span class="cm-operator">= <span class="cm-variable">setting.<span class="cm-property">root_dir &nbsp;<span class="cm-comment"># 项目根路径<br><span> &nbsp; &nbsp;<span class="cm-variable">model_dir <span class="cm-operator">= <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">join(<span class="cm-variable">root_dir, <span class="cm-string">'models', <span class="cm-string">'DeepSeek-R1-Distill-Qwen-1.5B') &nbsp;<span class="cm-comment"># 模型文件路径<br><span> &nbsp; &nbsp;<span class="cm-variable">dataset_path <span class="cm-operator">= <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">join(<span class="cm-variable">root_dir, <span class="cm-string">'data', <span class="cm-string">'medical-o1-reasoning-SFT') &nbsp;<span class="cm-comment"># 数据集路径<br><span> &nbsp; &nbsp;<span class="cm-variable">final_model_dir <span class="cm-operator">= <span class="cm-variable">os.<span class="cm-property">path.<span class="cm-property">join(<span class="cm-variable">root_dir, <span class="cm-string">'models', <span class="cm-string">'final_model') &nbsp;<span class="cm-comment"># 高效微调后模型保存路径<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f'设置模型路径：{<span class="cm-variable">model_dir}<span class="cm-string"> | 数据集位置：{<span class="cm-variable">dataset_path}<span class="cm-string">')<br><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">model_dir, <span class="cm-variable">dataset_path, <span class="cm-variable">final_model_dir<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 加载模型和分词器<br><span><span class="cm-keyword">def <span class="cm-def">load_model_and_tokenizer(<span class="cm-variable">model_dir):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  加载预训练模型和对应的分词器，并获取结束符（EOS_TOKEN）。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model_dir (str): 模型的文件路径<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model (AutoModelForCausalLM): 加载的模型<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  tokenizer (AutoTokenizer): 加载的分词器<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  EOS_TOKEN (str): 模型的结束符（如果没有，使用默认值）<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"加载分词器：Loading model and tokenizer...")<br><span> &nbsp; &nbsp;<span class="cm-variable">model <span class="cm-operator">= <span class="cm-variable">AutoModelForCausalLM.<span class="cm-property">from_pretrained(<span class="cm-variable">model_dir)<br><span> &nbsp; &nbsp;<span class="cm-variable">tokenizer <span class="cm-operator">= <span class="cm-variable">AutoTokenizer.<span class="cm-property">from_pretrained(<span class="cm-variable">model_dir)<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-variable">EOS_TOKEN <span class="cm-operator">= <span class="cm-variable">tokenizer.<span class="cm-property">eos_token<br><span> &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-variable">EOS_TOKEN <span class="cm-keyword">is <span class="cm-keyword">None:<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">EOS_TOKEN <span class="cm-operator">= <span class="cm-string">"&lt;|endoftext|&gt;"<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f'结束符：{<span class="cm-variable">EOS_TOKEN}<span class="cm-string">')<br><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">model, <span class="cm-variable">tokenizer, <span class="cm-variable">EOS_TOKEN<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 格式化训练数据<br><span><span class="cm-keyword">def <span class="cm-def">formatting_prompts_func(<span class="cm-variable">examples, <span class="cm-variable">EOS_TOKEN):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  格式化数据集中的每个示例，使其符合训练的要求。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  examples (dict): 数据集中的输入示例<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  EOS_TOKEN (str): 结束符<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  dict: 格式化后的文本数据<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-variable">train_prompt_style <span class="cm-operator">= <span class="cm-string">"""Below is an instruction that describes a task, paired with an input that provides further context. <br><span><span class="cm-string"> &nbsp;  Write a response that appropriately completes the request. <br><span><span class="cm-string"> &nbsp;  Before answering, think carefully about the question and create a step-by-step chain of thoughts to ensure a logical and accurate response.<br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Instruction:<br><span><span class="cm-string"> &nbsp;  You are a medical expert with advanced knowledge in clinical reasoning, diagnostics, and treatment planning. <br><span><span class="cm-string"> &nbsp;  Please answer the following medical question. <br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Question:<br><span><span class="cm-string"> &nbsp;  {}<br><span><span>​<br><span><span class="cm-string"> &nbsp;  ### Response:<br><span><span class="cm-string"> &nbsp;  &lt;think&gt;<br><span><span class="cm-string"> &nbsp;  {}<br><span><span class="cm-string"> &nbsp;  &lt;/think&gt;<br><span><span class="cm-string"> &nbsp;  {}"""<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-variable">inputs <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Question"]<br><span> &nbsp; &nbsp;<span class="cm-variable">cots <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Complex_CoT"]<br><span> &nbsp; &nbsp;<span class="cm-variable">outputs <span class="cm-operator">= <span class="cm-variable">examples[<span class="cm-string">"Response"]<br><span> &nbsp; &nbsp;<span class="cm-variable">texts <span class="cm-operator">= []<br><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-builtin">input, <span class="cm-variable">cot, <span class="cm-variable">output <span class="cm-keyword">in <span class="cm-builtin">zip(<span class="cm-variable">inputs, <span class="cm-variable">cots, <span class="cm-variable">outputs):<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">text <span class="cm-operator">= <span class="cm-variable">train_prompt_style.<span class="cm-property">format(<span class="cm-builtin">input, <span class="cm-variable">cot, <span class="cm-variable">output) <span class="cm-operator">+ <span class="cm-variable">EOS_TOKEN<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">texts.<span class="cm-property">append(<span class="cm-variable">text)<br><span> &nbsp; &nbsp;<span class="cm-keyword">return {<span class="cm-string">"text": <span class="cm-variable">texts}<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 设置LoRA配置<br><span><span class="cm-keyword">def <span class="cm-def">setup_lora(<span class="cm-variable">model):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  设置LoRA（低秩适配器）配置，并将其应用到模型。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model (AutoModelForCausalLM): 加载的模型<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model (AutoModelForCausalLM): 应用LoRA后的模型<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"设置LoRA: Setting up LoRA configuration...")<br><span> &nbsp; &nbsp;<span class="cm-variable">lora_config <span class="cm-operator">= <span class="cm-variable">LoraConfig(<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r<span class="cm-operator">=<span class="cm-number">8, &nbsp;<span class="cm-comment"># adapter的秩<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lora_alpha<span class="cm-operator">=<span class="cm-number">32, &nbsp;<span class="cm-comment"># 缩放因子<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lora_dropout<span class="cm-operator">=<span class="cm-number">0.1, &nbsp;<span class="cm-comment"># LoRA层的dropout<br><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">bias<span class="cm-operator">=<span class="cm-string">"none", &nbsp;<span class="cm-comment"># LoRA的偏置项<br><span> &nbsp;  )<br><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">get_peft_model(<span class="cm-variable">model, <span class="cm-variable">lora_config)<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 加载数据集<br><span><span class="cm-keyword">def <span class="cm-def">load_dataset_func(<span class="cm-variable">dataset_path, <span class="cm-variable">train_size<span class="cm-operator">=<span class="cm-number">100):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  从指定路径加载数据集，训练集大小为 train_size，评估集为训练集的10%，但至少为1。<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f"从 {<span class="cm-variable">dataset_path}<span class="cm-string"> 加载数据集...")<br><span> &nbsp; &nbsp;<span class="cm-comment"># 加载数据集<br><span> &nbsp; &nbsp;<span class="cm-variable">dataset <span class="cm-operator">= <span class="cm-variable">load_dataset(<span class="cm-variable">dataset_path, <span class="cm-string">"en", <span class="cm-variable">split<span class="cm-operator">=<span class="cm-string">"train", <span class="cm-variable">trust_remote_code<span class="cm-operator">=<span class="cm-keyword">True)<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-comment"># 计算评估集大小<br><span> &nbsp; &nbsp;<span class="cm-variable">eval_size <span class="cm-operator">= <span class="cm-builtin">max(<span class="cm-number">1, <span class="cm-builtin">int(<span class="cm-variable">train_size <span class="cm-operator">* <span class="cm-number">0.1)) &nbsp;<span class="cm-comment"># 评估集大小是训练集的10%，但至少为1<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-comment"># 切分数据集<br><span> &nbsp; &nbsp;<span class="cm-variable">train_dataset <span class="cm-operator">= <span class="cm-variable">dataset.<span class="cm-property">select(<span class="cm-builtin">range(<span class="cm-variable">train_size)) &nbsp;<span class="cm-comment"># 使用前 train_size 条作为训练集<br><span> &nbsp; &nbsp;<span class="cm-variable">eval_dataset <span class="cm-operator">= <span class="cm-variable">dataset.<span class="cm-property">select(<span class="cm-builtin">range(<span class="cm-variable">train_size, <span class="cm-variable">train_size <span class="cm-operator">+ <span class="cm-variable">eval_size)) &nbsp;<span class="cm-comment"># 剩余部分作为评估集<br><span><span>​<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">f"训练集大小: {<span class="cm-builtin">len(<span class="cm-variable">train_dataset)}<span class="cm-string">, 评估集大小: {<span class="cm-builtin">len(<span class="cm-variable">eval_dataset)}<span class="cm-string">")<br><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">train_dataset, <span class="cm-variable">eval_dataset<br><span><span>​<br><span><span>​<br><span><span class="cm-comment"># 配置训练参数<br><span><span class="cm-keyword">def <span class="cm-def">setup_training_args(<span class="cm-variable">final_model_dir, <span class="cm-variable">enable_evaluation<span class="cm-operator">=<span class="cm-keyword">True):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  设置训练参数，包括输出目录、学习率、批处理大小等，并根据参数控制是否启用评估。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  final_model_dir (str): 微调后模型保存的路径<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  enable_evaluation (bool): 是否启用评估。默认为True，启用评估；为False时禁用评估。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Returns:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  training_args (TrainingArguments): 训练参数<br><span><span class="cm-string"> &nbsp;  """</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 根据是否启用评估设置 evaluation_strategy</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">evaluation_strategy </span><span class="cm-operator">= </span><span class="cm-string">"epoch" </span><span class="cm-keyword">if </span><span class="cm-variable">enable_evaluation </span><span class="cm-keyword">else </span><span class="cm-string">"no"</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">training_args </span><span class="cm-operator">= </span><span class="cm-variable">TrainingArguments(</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">output_dir</span><span class="cm-operator">=</span><span class="cm-variable">final_model_dir,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">evaluation_strategy</span><span class="cm-operator">=</span><span class="cm-variable">evaluation_strategy, &nbsp;</span><span class="cm-comment"># 控制评估策略</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">learning_rate</span><span class="cm-operator">=</span><span class="cm-number">5e-5,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">per_device_train_batch_size</span><span class="cm-operator">=</span><span class="cm-number">2, &nbsp;</span><span class="cm-comment"># 适当减少批处理大小（根据M3 Pro的内存限制）</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">gradient_accumulation_steps</span><span class="cm-operator">=</span><span class="cm-number">4, &nbsp;</span><span class="cm-comment"># 使用梯度累积，模拟更大的批量</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">num_train_epochs</span><span class="cm-operator">=</span><span class="cm-number">3, &nbsp;</span><span class="cm-comment"># 训练3个周期</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">report_to</span><span class="cm-operator">=</span><span class="cm-string">"wandb", &nbsp;</span><span class="cm-comment"># 使用wandb进行训练日志记录</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">weight_decay</span><span class="cm-operator">=</span><span class="cm-number">0.01,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">logging_dir</span><span class="cm-operator">=</span><span class="cm-variable">os.</span><span class="cm-property">path.</span><span class="cm-property">join(</span><span class="cm-variable">setting.</span><span class="cm-property">root_dir, </span><span class="cm-string">'logs'),</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">logging_steps</span><span class="cm-operator">=</span><span class="cm-number">50, &nbsp;</span><span class="cm-comment"># 减少日志记录频率</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">save_steps</span><span class="cm-operator">=</span><span class="cm-number">500, &nbsp;</span><span class="cm-comment"># 增加模型保存的步数频率，减少频繁保存</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">save_total_limit</span><span class="cm-operator">=</span><span class="cm-number">2, &nbsp;</span><span class="cm-comment"># 保存最多2个模型</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">dataloader_num_workers</span><span class="cm-operator">=</span><span class="cm-number">4, &nbsp;</span><span class="cm-comment"># 设置数据加载器的并行数（根据需要调整）</span><br><span> &nbsp;  )</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">return </span><span class="cm-variable">training_args</span><br><span>​</span><br><span>​</span><br><span>​</span><br><span class="cm-comment"># 训练模型</span><br><span class="cm-keyword">def </span><span class="cm-def">train_model(</span><span class="cm-variable">model, </span><span class="cm-variable">training_args, </span><span class="cm-variable">dataset, </span><span class="cm-variable">eval_dataset, </span><span class="cm-variable">tokenizer, </span><span class="cm-variable">enable_evaluation</span><span class="cm-operator">=</span><span class="cm-keyword">True):</span><br><span> &nbsp; &nbsp;</span><span class="cm-string">"""</span><br><span class="cm-string"> &nbsp;  使用SFTTrainer进行模型训练。</span><br><span>​</span><br><span class="cm-string"> &nbsp;  Args:</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  model (AutoModelForCausalLM): 需要训练的模型</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  training_args (TrainingArguments): 训练参数</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  dataset (Dataset): 用于训练的数据集</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  eval_dataset (Dataset): 用于评估的数据集</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  tokenizer (AutoTokenizer): 分词器</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  enable_evaluation (bool): 是否进行评估</span><br><span>​</span><br><span class="cm-string"> &nbsp;  Returns:</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  trainer (SFTTrainer): 训练器实例</span><br><span class="cm-string"> &nbsp;  """</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 如果启用了评估，传递评估集</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">trainer </span><span class="cm-operator">= </span><span class="cm-variable">SFTTrainer(</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">model</span><span class="cm-operator">=</span><span class="cm-variable">model,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">args</span><span class="cm-operator">=</span><span class="cm-variable">training_args,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">train_dataset</span><span class="cm-operator">=</span><span class="cm-variable">dataset,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">eval_dataset</span><span class="cm-operator">=</span><span class="cm-variable">eval_dataset </span><span class="cm-keyword">if </span><span class="cm-variable">enable_evaluation </span><span class="cm-keyword">else </span><span class="cm-keyword">None, &nbsp;</span><span class="cm-comment"># 根据参数决定是否传递评估集</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">tokenizer</span><span class="cm-operator">=</span><span class="cm-variable">tokenizer,</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">data_collator</span><span class="cm-operator">=</span><span class="cm-keyword">None, &nbsp;</span><span class="cm-comment"># 可以选择合适的data collator</span><br><span> &nbsp;  )</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">trainer.</span><span class="cm-property">train()</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">return </span><span class="cm-variable">trainer</span><br><span>​</span><br><span>​</span><br><span class="cm-comment"># 保存模型</span><br><span class="cm-keyword">def </span><span class="cm-def">save_model(</span><span class="cm-variable">trainer, </span><span class="cm-variable">final_model_dir):</span><br><span> &nbsp; &nbsp;</span><span class="cm-string">"""</span><br><span class="cm-string"> &nbsp;  保存训练后的模型到指定目录。</span><br><span>​</span><br><span class="cm-string"> &nbsp;  Args:</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  trainer (SFTTrainer): 训练器实例</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  final_model_dir (str): 模型保存路径</span><br><span class="cm-string"> &nbsp;  """</span><br><span> &nbsp; &nbsp;</span><span class="cm-builtin">print(</span><span class="cm-string">"Saving model...")</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">trainer.</span><span class="cm-property">save_model(</span><span class="cm-variable">final_model_dir)</span><br><span>​</span><br><span>​</span><br><span>​</span><br><span class="cm-keyword">def </span><span class="cm-def">merge_models(</span><span class="cm-variable">models, </span><span class="cm-variable">weights, </span><span class="cm-variable">device</span><span class="cm-operator">=</span><span class="cm-string">"cpu"):</span><br><span> &nbsp; &nbsp;</span><span class="cm-string">"""</span><br><span class="cm-string"> &nbsp;  合并多个模型的权重（加权平均）。</span><br><span>​</span><br><span class="cm-string"> &nbsp;  Args:</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  models (list): 模型列表</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  weights (list): 权重列表，权重数量与模型数量一致</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  device (str): 设备，可以是 "cuda" 或 "cpu"</span><br><span>​</span><br><span class="cm-string"> &nbsp;  Returns:</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  merged_model (nn.Module): 合并后的模型</span><br><span class="cm-string"> &nbsp;  """</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 确保模型数量与权重数量一致</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">assert </span><span class="cm-builtin">len(</span><span class="cm-variable">models) </span><span class="cm-operator">== </span><span class="cm-builtin">len(</span><span class="cm-variable">weights), </span><span class="cm-string">"模型数量与权重数量不一致"</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 将所有模型加载到相同的设备</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">for </span><span class="cm-variable">i </span><span class="cm-keyword">in </span><span class="cm-builtin">range(</span><span class="cm-builtin">len(</span><span class="cm-variable">models)):</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">models[</span><span class="cm-variable">i] </span><span class="cm-operator">= </span><span class="cm-variable">models[</span><span class="cm-variable">i].</span><span class="cm-property">to(</span><span class="cm-variable">device)</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 获取第一个模型的状态字典</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">merged_state_dict </span><span class="cm-operator">= </span><span class="cm-variable">models[</span><span class="cm-number">0].</span><span class="cm-property">state_dict()</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 对每一层的权重进行加权平均</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">for </span><span class="cm-variable">key </span><span class="cm-keyword">in </span><span class="cm-variable">merged_state_dict.</span><span class="cm-property">keys():</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">merged_state_dict[</span><span class="cm-variable">key] </span><span class="cm-operator">= </span><span class="cm-variable">torch.</span><span class="cm-property">zeros_like(</span><span class="cm-variable">merged_state_dict[</span><span class="cm-variable">key])</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-keyword">for </span><span class="cm-variable">model, </span><span class="cm-variable">weight </span><span class="cm-keyword">in </span><span class="cm-builtin">zip(</span><span class="cm-variable">models, </span><span class="cm-variable">weights):</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="cm-variable">merged_state_dict[</span><span class="cm-variable">key] </span><span class="cm-operator">+= </span><span class="cm-variable">model.</span><span class="cm-property">state_dict()[</span><span class="cm-variable">key] </span><span class="cm-operator">* </span><span class="cm-variable">weight</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 创建一个新的模型并加载合并后的权重</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">merged_model </span><span class="cm-operator">= </span><span class="cm-variable">models[</span><span class="cm-number">0].</span><span class="cm-property">__class__.</span><span class="cm-property">from_pretrained(</span><span class="cm-variable">models[</span><span class="cm-number">0].</span><span class="cm-property">config)</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">merged_model.</span><span class="cm-property">load_state_dict(</span><span class="cm-variable">merged_state_dict)</span><br><span> &nbsp; &nbsp;</span><span class="cm-keyword">return </span><span class="cm-variable">merged_model</span><br><span>​</span><br><span>​</span><br><span class="cm-comment"># 主函数</span><br><span class="cm-keyword">def </span><span class="cm-def">main():</span><br><span> &nbsp; &nbsp;</span><span class="cm-string">"""</span><br><span class="cm-string"> &nbsp;  主函数，执行整个训练流程：设置路径、加载模型、训练并保存模型。</span><br><span>​</span><br><span class="cm-string"> &nbsp;  参数设置：</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  enable_evaluation = False  # 设置为False以禁用评估 如果性能慢可以设置 False</span><br><span>​</span><br><span class="cm-string"> &nbsp;  加载数据集：</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  train_size=10 设置数据集大小，评估集是数据集百分之10（如果小于1 则等于1 ）</span><br><span class="cm-string"> &nbsp; &nbsp; &nbsp;  train_dataset, eval_dataset = load_dataset_func(dataset_path, train_size=10)</span><br><span>​</span><br><span>​</span><br><span class="cm-string"> &nbsp;  """</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">setup_wandb() &nbsp;</span><span class="cm-comment"># 登录wandb</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">model_dir, </span><span class="cm-variable">dataset_path, </span><span class="cm-variable">final_model_dir </span><span class="cm-operator">= </span><span class="cm-variable">set_paths() &nbsp;</span><span class="cm-comment"># 设置路径</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">model, </span><span class="cm-variable">tokenizer, </span><span class="cm-variable">EOS_TOKEN </span><span class="cm-operator">= </span><span class="cm-variable">load_model_and_tokenizer(</span><span class="cm-variable">model_dir) &nbsp;</span><span class="cm-comment"># 加载模型和分词器</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">train_dataset, </span><span class="cm-variable">eval_dataset </span><span class="cm-operator">= </span><span class="cm-variable">load_dataset_func(</span><span class="cm-variable">dataset_path, </span><span class="cm-variable">train_size</span><span class="cm-operator">=</span><span class="cm-number">5) &nbsp;</span><span class="cm-comment"># 加载数据集</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">train_dataset </span><span class="cm-operator">= </span><span class="cm-variable">train_dataset.</span><span class="cm-property">map(</span><span class="cm-keyword">lambda </span><span class="cm-variable">examples: </span><span class="cm-variable">formatting_prompts_func(</span><span class="cm-variable">examples, </span><span class="cm-variable">EOS_TOKEN), </span><span class="cm-variable">batched</span><span class="cm-operator">=</span><span class="cm-keyword">True) &nbsp;</span><span class="cm-comment"># 格式化数据集</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">eval_dataset </span><span class="cm-operator">= </span><span class="cm-variable">eval_dataset.</span><span class="cm-property">map(</span><span class="cm-keyword">lambda </span><span class="cm-variable">examples: </span><span class="cm-variable">formatting_prompts_func(</span><span class="cm-variable">examples, </span><span class="cm-variable">EOS_TOKEN), </span><span class="cm-variable">batched</span><span class="cm-operator">=</span><span class="cm-keyword">True) &nbsp;</span><span class="cm-comment"># 格式化评估集</span><br><span> &nbsp; &nbsp;</span><span class="cm-builtin">print(</span><span class="cm-variable">train_dataset[</span><span class="cm-string">"text"][</span><span class="cm-number">0]) &nbsp;</span><span class="cm-comment"># 打印格式化后的数据</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">model </span><span class="cm-operator">= </span><span class="cm-variable">setup_lora(</span><span class="cm-variable">model) &nbsp;</span><span class="cm-comment"># 配置LoRA</span><br><span> &nbsp; &nbsp;</span><span class="cm-comment"># 设置是否开启评估</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">enable_evaluation </span><span class="cm-operator">= </span><span class="cm-keyword">True &nbsp;</span><span class="cm-comment"># 设置为False以禁用评估</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">training_args </span><span class="cm-operator">= </span><span class="cm-variable">setup_training_args(</span><span class="cm-variable">final_model_dir,</span><span class="cm-variable">enable_evaluation) &nbsp;</span><span class="cm-comment"># 配置训练参数</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">trainer </span><span class="cm-operator">= </span><span class="cm-variable">train_model(</span><span class="cm-variable">model, </span><span class="cm-variable">training_args, </span><span class="cm-variable">train_dataset, </span><span class="cm-variable">eval_dataset, </span><span class="cm-variable">tokenizer, </span><span class="cm-variable">enable_evaluation) &nbsp;</span><span class="cm-comment"># 开始训练</span><br><span>​</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">save_model(</span><span class="cm-variable">trainer, </span><span class="cm-variable">final_model_dir) &nbsp;</span><span class="cm-comment"># 保存模型</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">wandb.</span><span class="cm-property">finish() &nbsp;</span><span class="cm-comment"># 完成wandb记录</span><br><span>​</span><br><span>​</span><br><span>​</span><br><span>​</span><br><span class="cm-comment"># 执行主函数</span><br><span class="cm-keyword">if </span><span class="cm-variable">__name__ </span><span class="cm-operator">== </span><span class="cm-string">"__main__":</span><br><span> &nbsp; &nbsp;</span><span class="cm-variable">main()</span><br><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">训练</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250212134721218.png"><img alt="image-20250212134721218" height="592" data-local-refresh="true" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250212134721218.png?lastModify=1739339315" data-fixed-size=""></span></p>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">训练过程</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250212130451066.png"><img alt="image-20250212130451066" height="373" data-local-refresh="true" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250212130451066.png?lastModify=1739339093" data-fixed-size=""></span></p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">3.3 训练模型并保存</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-string">"""<br><span><span class="cm-string">保存在本地 models/final_model 路径下<br><span><span>​<br><span><span class="cm-string">"""<br><span><span>​<br><span><span class="cm-keyword">def <span class="cm-def">save_model(<span class="cm-variable">trainer, <span class="cm-variable">final_model_dir):<br><span> &nbsp; &nbsp;<span class="cm-string">"""<br><span><span class="cm-string"> &nbsp;  保存训练后的模型到指定目录。<br><span><span>​<br><span><span class="cm-string"> &nbsp;  Args:<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  trainer (SFTTrainer): 训练器实例<br><span><span class="cm-string"> &nbsp; &nbsp; &nbsp;  final_model_dir (str): 模型保存路径<br><span><span class="cm-string"> &nbsp;  """<br><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"Saving model...")<br><span> &nbsp; &nbsp;<span class="cm-variable">trainer.<span class="cm-property">save_model(<span class="cm-variable">final_model_dir)<br><span><span>​<br><span> &nbsp; &nbsp;<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">3.4 合并模型文件</span></h2>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span class="cm-comment">#01 执行即可<br><span><span class="cm-variable">new_model_local <span class="cm-operator">= <span class="cm-string">"DeepSeek-R1-Medical-COT-Tiny"<br><span><span class="cm-variable">model.<span class="cm-property">save_pretrained(<span class="cm-variable">new_model_local) <br><span><span class="cm-variable">tokenizer.<span class="cm-property">save_pretrained(<span class="cm-variable">new_model_local)<br><span><span class="cm-variable">model.<span class="cm-property">save_pretrained_merged(<span class="cm-variable">new_model_local, <span class="cm-variable">tokenizer, <span class="cm-variable">save_method <span class="cm-operator">= <span class="cm-string">"merged_16bit",)<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">3.4 评估和监控训练过程</span></h2>
<h3 class="md-end-block md-heading"><span class="md-plain">评估（<span class="md-pair-s"><code>eval/</code><span class="md-plain">）相关信息：</span></span></span></h3>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>eval/runtime 18.3908</code></span></strong><span class="md-plain">: 评估过程总共耗时18.39秒。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>eval/samples_per_second 0.054</code></span></strong><span class="md-plain">: 每秒处理的样本数为0.054，表示评估的速度较慢。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>eval/steps_per_second 0.054</code></span></strong><span class="md-plain">: 每秒进行评估步数为0.054，说明每个评估步骤的时间消耗较大。</span></span></p>
</li>
</ul>
<h3 class="md-end-block md-heading"><span class="md-plain">训练（<span class="md-pair-s"><code>train/</code><span class="md-plain">）相关信息：</span></span></span></h3>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>train/epoch 0</code></span></strong><span class="md-plain">: 当前训练轮次是第0轮。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s"><strong><span class="md-pair-s"><code>train/global_step 0</code></span></strong><span class="md-plain">: 当前全局步骤为0，表示尚未进行任何训练步骤。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>train_loss 14435.36663</code></span></strong><span class="md-plain">: 当前训练的损失为14435.37，表明模型的表现尚不理想，通常需要更多的训练来降低损失。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>train/runtime 251.7582</code></span></strong><span class="md-plain">: 训练总时间为251.76秒。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>train/samples_per_second 0.06</code></span></strong><span class="md-plain">: 每秒处理的训练样本数为0.06，训练的速度较慢。</span></span></p>
</li>
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-pair-s "><strong><span class="md-pair-s"><code>train/steps_per_second 0.012</code></span></strong><span class="md-plain">: 每秒进行的训练步数为0.012，表示每个训练步骤消耗的时间较长。</span></span></p>
</li>
</ul>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span>​<br><span><span>​<br><span><span class="cm-comment">#02 详细日志<br><span><span class="cm-variable">wandb: <span class="cm-variable">⭐️ <span class="cm-variable">View <span class="cm-variable">project <span class="cm-variable">at <span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">wandb.<span class="cm-property">ai<span class="cm-operator">/<span class="cm-variable">z15119911990<span class="cm-operator">-<span class="cm-variable">beijing<span class="cm-operator">/<span class="cm-variable">huggingface<br><span><span class="cm-variable">wandb: <span class="cm-variable">🚀 <span class="cm-variable">View <span class="cm-variable">run <span class="cm-variable">at <span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">wandb.<span class="cm-property">ai<span class="cm-operator">/<span class="cm-variable">z15119911990<span class="cm-operator">-<span class="cm-variable">beijing<span class="cm-operator">/<span class="cm-variable">huggingface<span class="cm-operator">/<span class="cm-variable">runs<span class="cm-operator">/<span class="cm-variable">mgrko2jv<br><span> &nbsp;<span class="cm-number">0<span class="cm-operator">%| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">| <span class="cm-number">0<span class="cm-operator">/<span class="cm-number">3 [<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0<span class="cm-operator">&lt;<span class="cm-error">?, <span class="cm-error">?<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span>{<span class="cm-string">'eval_runtime': <span class="cm-number">14.8693, <span class="cm-string">'eval_samples_per_second': <span class="cm-number">0.067, <span class="cm-string">'eval_steps_per_second': <span class="cm-number">0.067, <span class="cm-string">'epoch': <span class="cm-number">0}<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br><span> &nbsp;<span class="cm-number">0<span class="cm-operator">%| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">| <span class="cm-number">0<span class="cm-operator">/<span class="cm-number">3 [<span class="cm-error">0<span class="cm-number">0:<span class="cm-number">30<span class="cm-operator">&lt;<span class="cm-error">?, <span class="cm-error">?<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span><span class="cm-number">100<span class="cm-operator">%|<span class="cm-variable">██████████<span class="cm-operator">| <span class="cm-number">1<span class="cm-operator">/<span class="cm-number">1 [<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0<span class="cm-operator">&lt;<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0, <span class="cm-number">1461.94<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br><span>{<span class="cm-string">'eval_runtime': <span class="cm-number">21.2073, <span class="cm-string">'eval_samples_per_second': <span class="cm-number">0.047, <span class="cm-string">'eval_steps_per_second': <span class="cm-number">0.047, <span class="cm-string">'epoch': <span class="cm-number">0}<br><span> &nbsp;<span class="cm-number">0<span class="cm-operator">%| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">| <span class="cm-number">0<span class="cm-operator">/<span class="cm-number">3 [<span class="cm-error">0<span class="cm-number">2:<span class="cm-number">11<span class="cm-operator">&lt;<span class="cm-error">?, <span class="cm-error">?<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span><span class="cm-number">100<span class="cm-operator">%|<span class="cm-variable">██████████<span class="cm-operator">| <span class="cm-number">1<span class="cm-operator">/<span class="cm-number">1 [<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0<span class="cm-operator">&lt;<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0, <span class="cm-number">33.69<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br><span> &nbsp;<span class="cm-number">0<span class="cm-operator">%| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">| <span class="cm-number">0<span class="cm-operator">/<span class="cm-number">3 [<span class="cm-error">0<span class="cm-number">4:<span class="cm-error">0<span class="cm-number">2<span class="cm-operator">&lt;<span class="cm-error">?, <span class="cm-error">?<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span><span class="cm-number">100<span class="cm-operator">%|<span class="cm-variable">██████████<span class="cm-operator">| <span class="cm-number">1<span class="cm-operator">/<span class="cm-number">1 [<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0<span class="cm-operator">&lt;<span class="cm-error">0<span class="cm-number">0:<span class="cm-error">0<span class="cm-number">0, <span class="cm-number">334.66<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<span class="cm-string">'eval_runtime': <span class="cm-number">18.3908, <span class="cm-string">'eval_samples_per_second': <span class="cm-number">0.054, <span class="cm-string">'eval_steps_per_second': <span class="cm-number">0.054, <span class="cm-string">'epoch': <span class="cm-number">0}<br><span>{<span class="cm-string">'train_runtime': <span class="cm-number">251.7582, <span class="cm-string">'train_samples_per_second': <span class="cm-number">0.06, <span class="cm-string">'train_steps_per_second': <span class="cm-number">0.012, <span class="cm-string">'train_loss': <span class="cm-number">14435.3666305542, <span class="cm-string">'epoch': <span class="cm-number">0}<br><span> &nbsp;<span class="cm-number">0<span class="cm-operator">%| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">| <span class="cm-number">0<span class="cm-operator">/<span class="cm-number">3 [<span class="cm-error">0<span class="cm-number">4:<span class="cm-number">10<span class="cm-operator">&lt;<span class="cm-error">?, <span class="cm-error">?<span class="cm-variable">it<span class="cm-operator">/<span class="cm-variable">s]<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br><span><span class="cm-variable">wandb: <br><span><span class="cm-variable">wandb: <span class="cm-variable">Run <span class="cm-variable">history:<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">runtime <span class="cm-variable">▁█▅<br><span><span class="cm-variable">wandb: <span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">samples_per_second <span class="cm-variable">█▁▃<br><span><span class="cm-variable">wandb: &nbsp; <span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">steps_per_second <span class="cm-variable">█▁▃<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">train<span class="cm-operator">/<span class="cm-variable">epoch <span class="cm-variable">▁▁▁▁<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; <span class="cm-variable">train<span class="cm-operator">/<span class="cm-variable">global_step <span class="cm-variable">▁▁▁▁<br><span><span class="cm-variable">wandb: <br><span><span class="cm-variable">wandb: <span class="cm-variable">Run <span class="cm-variable">summary:<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">runtime <span class="cm-number">18.3908<br><span><span class="cm-variable">wandb: &nbsp;<span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">samples_per_second <span class="cm-number">0.054<br><span><span class="cm-variable">wandb: &nbsp; &nbsp;<span class="cm-builtin">eval<span class="cm-operator">/<span class="cm-variable">steps_per_second <span class="cm-number">0.054<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">total_flos <span class="cm-number">43804457687040.0<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">train<span class="cm-operator">/<span class="cm-variable">epoch <span class="cm-number">0<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">train<span class="cm-operator">/<span class="cm-variable">global_step <span class="cm-number">0<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">train_loss <span class="cm-number">14435.36663<br><span><span class="cm-variable">wandb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">train_runtime <span class="cm-number">251.7582<br><span><span class="cm-variable">wandb: <span class="cm-variable">train_samples_per_second <span class="cm-number">0.06<br><span><span class="cm-variable">wandb: &nbsp; <span class="cm-variable">train_steps_per_second <span class="cm-number">0.012<br><span><span class="cm-variable">wandb: <br><span><span class="cm-variable">wandb: <span class="cm-variable">🚀 <span class="cm-variable">View <span class="cm-variable">run <span class="cm-operator">/<span class="cm-variable">Users<span class="cm-operator">/<span class="cm-variable">ningcaichen<span class="cm-operator">/<span class="cm-variable">Documents<span class="cm-operator">/<span class="cm-error">0<span class="cm-number">2<span class="cm-operator">-<span class="cm-variable">python相关文档<span class="cm-operator">/<span class="cm-error">0<span class="cm-number">1<span class="cm-operator">-<span class="cm-variable">AI系列<span class="cm-operator">/<span class="cm-variable">LoRA<span class="cm-operator">-<span class="cm-variable">DeepSeek<span class="cm-operator">-<span class="cm-variable">R1<span class="cm-operator">/<span class="cm-variable">models<span class="cm-operator">/<span class="cm-variable">final_model <span class="cm-variable">at: <span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">wandb.<span class="cm-property">ai<span class="cm-operator">/<span class="cm-variable">z15119911990<span class="cm-operator">-<span class="cm-variable">beijing<span class="cm-operator">/<span class="cm-variable">huggingface<span class="cm-operator">/<span class="cm-variable">runs<span class="cm-operator">/<span class="cm-variable">mgrko2jv<br><span><span class="cm-variable">wandb: <span class="cm-variable">⭐️ <span class="cm-variable">View <span class="cm-variable">project <span class="cm-variable">at: <span class="cm-variable">https:<span class="cm-operator">//<span class="cm-variable">wandb.<span class="cm-property">ai<span class="cm-operator">/<span class="cm-variable">z15119911990<span class="cm-operator">-<span class="cm-variable">beijing<span class="cm-operator">/<span class="cm-variable">huggingface<br><span><span class="cm-variable">wandb: <span class="cm-variable">Synced <span class="cm-number">5 <span class="cm-variable">W<span class="cm-operator">&amp;<span class="cm-variable">B <span class="cm-variable">file(<span class="cm-variable">s), <span class="cm-number">0 <span class="cm-variable">media <span class="cm-variable">file(<span class="cm-variable">s), <span class="cm-number">0 <span class="cm-variable">artifact <span class="cm-variable">file(<span class="cm-variable">s) <span class="cm-keyword">and <span class="cm-number">0 <span class="cm-variable">other <span class="cm-variable">file(<span class="cm-variable">s)<br><span><span class="cm-variable">wandb: <span class="cm-variable">Find <span class="cm-variable">logs <span class="cm-variable">at: .<span class="cm-operator">/<span class="cm-variable">wandb<span class="cm-operator">/<span class="cm-variable">run<span class="cm-operator">-<span class="cm-number">20250212_133457<span class="cm-operator">-<span class="cm-variable">mgrko2jv<span class="cm-operator">/<span class="cm-variable">logs<br><span><span>​<br><span><span>​<br><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<ul class="ul-list" data-mark="-">
<li class="md-list-item">
<p class="md-end-block md-p"><span class="md-plain">图示</span></p>
</li>
</ul>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="assets/image-20250212134021697.png"><img alt="image-20250212134021697" height="385" data-real-src="file:///Users/ningcaichen/Documents/01-%E4%B8%AA%E4%BA%BA%E6%96%87%E6%A1%A3/01-Markdown/pythin%E5%85%A8%E6%A0%88%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97/deepseek/assets/image-20250212134021697.png?lastModify=1739339015" data-fixed-size="" data-local-refresh="true"></span></p>
<div><span class="md-image md-img-loaded" data-src="assets/image-20250212134021697.png">&nbsp;</span></div>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03769235399884259" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-12 15:25">2025-02-12 15:15</span>&nbsp;
<a href="https://www.cnblogs.com/saas-open">宁采臣open</a>&nbsp;
阅读(<span id="post_view_count">65</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18711620" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18711620);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18711620', targetLink: 'https://www.cnblogs.com/saas-open/p/18711620', title: '定制化训练DeepSeek模型：LoAR、COT推理与SFT技术应用' })">举报</a>
</div>
        