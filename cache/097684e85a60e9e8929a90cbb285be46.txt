
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/tianwuyvlianshui/p/18857780" title="发布于 2025-05-02 20:44">
    <span role="heading" aria-level="2">ESP32S3  BLE_HID的编程实现</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="esp32s3--ble_hid的编程实现">ESP32S3  BLE_HID的编程实现</h1>
<blockquote>
<p>BLE是低功耗蓝牙，HID是Human Interface Device，也就是人机接口设备。</p>
<p>主要用于无线连接并传输用户输入数据（如按键、触控、手势等）。</p>
</blockquote>
<hr>
<h3 id="核心概念"><strong>核心概念</strong></h3>
<ol>
<li><strong>BLE（Bluetooth Low Energy）</strong>
<ul>
<li>蓝牙4.0及以上版本引入的技术，专为低功耗设计，适合电池供电设备（如键盘、鼠标）。</li>
<li>传输数据量小、连接速度快，功耗仅为传统蓝牙的1/10~1/100。</li>
</ul>
</li>
<li><strong>HID（Human Interface Device）</strong>
<ul>
<li>源自USB HID标准，定义了键盘、鼠标、游戏手柄等设备的通用通信协议。</li>
<li>BLE HID将这一协议无线化，无需物理线缆即可实现设备交互。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="与传统蓝牙hid的区别"><strong>与传统蓝牙HID的区别</strong></h3>
<table>
<thead>
<tr>
<th style="text-align: left"><strong>特性</strong></th>
<th style="text-align: left"><strong>传统蓝牙HID</strong></th>
<th style="text-align: left"><strong>BLE HID</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">功耗</td>
<td style="text-align: left">较高</td>
<td style="text-align: left">极低</td>
</tr>
<tr>
<td style="text-align: left">连接速度</td>
<td style="text-align: left">较慢</td>
<td style="text-align: left">快（毫秒级）</td>
</tr>
<tr>
<td style="text-align: left">兼容性</td>
<td style="text-align: left">依赖传统HID协议</td>
<td style="text-align: left">基于GATT，更现代</td>
</tr>
<tr>
<td style="text-align: left">适用设备</td>
<td style="text-align: left">需较高数据速率（如音频）</td>
<td style="text-align: left">低频输入设备（按键、点击）</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="协议实现"><strong>协议实现</strong></h3>
<ul>
<li><strong>HID Service</strong><br>
通过GATT（通用属性协议）定义服务，包含以下关键特性：
<ul>
<li><strong>Report Map</strong>：描述设备功能（如按键映射）。</li>
<li><strong>Input/Output Report</strong>：传输实际输入/输出数据。</li>
<li><strong>Protocol Mode</strong>：切换Boot Protocol（兼容BIOS）或Report Protocol（标准模式）。</li>
</ul>
</li>
</ul>
<hr>
<p>代码源自esp-idf例程<strong>ble_hidd_demo</strong></p>
<h3 id="执行流程">执行流程</h3>
<table>
<thead>
<tr>
<th>1<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204407501-516134262.png" alt="image-20250502195507712" style="zoom: 150%"></th>
<th>初始化NVS：（Non-Volatile Storage，非易失性存储）是 ESP-IDF 提供的一种存储机制，用于在设备的闪存中保存数据，即使设备断电后数据也不会丢失。<code>nvs</code> 通常用于存储配置信息、蓝牙配对信息等。<em>释放经典蓝牙模式的内存</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>2<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204408050-157654301.png" alt="image-20250502195543790" style="zoom: 33%"></td>
<td>初始化BLE控制器-&gt;启用蓝牙控制器，设置为BLE模式-&gt;初始化Bluedroid协议栈-&gt;启用Bluedroid协议栈-&gt;初始化HID（Human Interface Device）配置文件</td>
</tr>
<tr>
<td>3<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204408524-1734573555.png" alt="image-20250502195630852" style="zoom: 50%"></td>
<td>注册回调函数到GAP（Generic Access Profile）模块-&gt;注册回调函数到GAP（Generic Access Profile）模块-&gt; 注册回调函数到HID模块-&gt;设置BLE安全参数-&gt;创建HID任务（用户或自动执行）</td>
</tr>
<tr>
<td>4<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204408963-724343996.png" alt="image-20250502195651917" style="zoom: 50%"></td>
<td>BLE广播（等待设备连接esp32s3的低功耗蓝牙）-&gt;设备连接BLE-&gt;触发连接事件 -&gt;开始配对BLE</td>
</tr>
<tr>
<td>5<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204409338-926225286.png" alt="image-20250502195722975" style="zoom: 33%"></td>
<td>设备成功配对BLE -&gt;设置连接成功标志位 -&gt;进入人机交互任务</td>
</tr>
<tr>
<td>6<img src="https://img2023.cnblogs.com/blog/3281938/202505/3281938-20250502204409686-1243929280.png" alt="image-20250502195729782" style="zoom: 50%"></td>
<td>HID任务循环 -&gt;判断连接状态 -&gt; 发送指令（操作）+数据</td>
</tr>
</tbody>
</table>
<h4 id="配置项目">配置项目</h4>
<blockquote>
<p>ble_hidd_demo_main.c：此文件是演示如何使用 HID 的示例（您可以使用它连接到智能手机作为消费者设备，然后使用按钮来增加或减少音量等，或者连接到 Windows 10 PC 作为键盘或鼠标）</p>
<p>hidd_le_prf_int.h：此头文件包含一些与 HID 配置文件相关的定义。</p>
<p>esp_hidd_prf_api.h &amp; esp_hidd_prf_api.c：这些文件包含 HID 配置文件的 API</p>
<p>当您使用 HID 配置文件时，只需添加 esp_hidd_prf_api.h 包含文件，并使用 esp_hidd_prf_api.c 文件中定义的函数发送 HID 数据。</p>
<p>hid_dev.h &amp; hid_dev.c：这些文件定义了 HID 规范相关的定义</p>
<p>hid_device_le_prf.c：此文件是 HID 配置文件的定义文件，它包含 HID 配置文件的主要功能。它主要包含如何创建 HID 服务。如果您发送和接收 HID 数据并将数据转换为键盘键、鼠标和消费者值，则将其转发到应用程序。</p>
</blockquote>
<h4 id="整体执行流程">整体执行流程</h4>
<blockquote>
<p>蓝牙初始化：</p>
<p>在主函数中，会初始化蓝牙堆栈并注册 GAP 事件回调函数。</p>
<p>事件处理：</p>
<p>当蓝牙事件发生时，回调函数会根据事件类型执行相应的逻辑。</p>
<p>HID 功能演示：</p>
<p>hid_demo_task 任务会在系统初始化完成后运行，可能会模拟键盘、鼠标或其他 HID 设备的行为。</p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.014565210611111112" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-02 20:45">2025-05-02 20:44</span>&nbsp;
<a href="https://www.cnblogs.com/tianwuyvlianshui">沁拒离</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18857780);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18857780', targetLink: 'https://www.cnblogs.com/tianwuyvlianshui/p/18857780', title: 'ESP32S3  BLE_HID的编程实现' })">举报</a>
</div>
        