
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/huangxincheng/p/18942584" title="å‘å¸ƒäº 2025-06-22 14:20">
    <span role="heading" aria-level="2">DotTraceç³»åˆ—ï¼š2. ç†è§£å››å¤§ç»å…¸çš„è¯Šæ–­ç±»å‹ï¼ˆä¸‹ï¼‰</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="ä¸€èƒŒæ™¯">ä¸€ï¼šèƒŒæ™¯</h2>
<h3 id="1-è®²æ•…äº‹">1. è®²æ•…äº‹</h3>
<p>å‰é¢æˆ‘ä»¬å·²ç»èŠè¿‡å››å¤§è¯Šæ–­ç±»å‹ä¸­çš„å‰ä¸‰ä¸ª <code>Sampling,Tracineï¼ŒLine-by-Line</code>ï¼Œè¿™ç¯‡è¡¥ä¸Šæœ€åä¸€ä¸ªè¯Šæ–­ç±»å‹ <code>Timeline</code>ï¼Œè¿™ä¹Ÿæ˜¯çœŸå®åœºæ™¯ä¸­ä½¿ç”¨æœ€å¤šçš„ï¼Œå®ƒèƒ½å¤Ÿé‡‡é›†åˆ°æ‰€æœ‰å®ƒèƒ½é‡‡é›†åˆ°çš„ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>çº¿ç¨‹æ ˆæ•°æ® ï¼ˆå‡½æ•°æ‰§è¡Œæ—¶é—´ï¼‰</li>
<li>ETWäº‹ä»¶ ï¼ˆWindowsæ—¥å¿—ï¼‰</li>
<li>TPLæ•°æ®ï¼ˆæ–¹ä¾¿ç»˜åˆ¶å¼‚æ­¥æ ˆï¼‰</li>
<li>æŒ‰æ—¶åºç»˜åˆ¶æ—¶é—´è½´ (Timeline)</li>
</ul>
<h2 id="äºŒtimeline-è§£è¯»">äºŒï¼šTimeline è§£è¯»</h2>
<h3 id="1-ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ¡ˆä¾‹">1. ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ¡ˆä¾‹</h3>
<p>ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šä¸€ç¯‡çš„çŸ©é˜µè¿ç®—çš„ä¾‹å­ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-C#">
using System;
using System.Diagnostics;

namespace MatrixOperations
{
    internal class Program
    {
        static void Main(string[] args)
        {
            const int baseSize = 1000;
            const int iterations = 3;

            for (int i = 0; i &lt; iterations; i++)
            {
                int matrixSize = baseSize - (i * 100);
                PerformMatrixMultiplication(matrixSize);
            }
        }

        static void PerformMatrixMultiplication(int matrixSize)
        {
            Console.WriteLine($"\n=== å¤„ç† {matrixSize}x{matrixSize} çŸ©é˜µ ===");

            Console.WriteLine("åˆ›å»ºéšæœºçŸ©é˜µ...");
            var matrixA = GenerateRandomMatrix(matrixSize, matrixSize);
            var matrixB = GenerateRandomMatrix(matrixSize, matrixSize);

            Console.WriteLine("æ‰§è¡ŒçŸ©é˜µä¹˜æ³•...");
            var timer = Stopwatch.StartNew();

            var resultMatrix = MultiplyMatrices(matrixA, matrixB);

            timer.Stop();
            Console.WriteLine($"è¿ç®—å®Œæˆï¼Œè€—æ—¶: {timer.Elapsed.TotalSeconds:0.000} ç§’");

            DisplayMatrixPreview(resultMatrix);
        }

        static double[,] GenerateRandomMatrix(int rows, int cols)
        {
            var random = new Random();
            var matrix = new double[rows, cols];

            for (int i = 0; i &lt; rows; i++)
            {
                for (int j = 0; j &lt; cols; j++)
                {
                    matrix[i, j] = random.NextDouble() * 100;
                }
            }

            return matrix;
        }

        static double[,] MultiplyMatrices(double[,] matrixA, double[,] matrixB)
        {
            int aRows = matrixA.GetLength(0);
            int aCols = matrixA.GetLength(1);
            int bCols = matrixB.GetLength(1);

            if (matrixA.GetLength(1) != matrixB.GetLength(0))
                throw new ArgumentException("çŸ©é˜µç»´åº¦ä¸åŒ¹é…");

            var result = new double[aRows, bCols];

            for (int i = 0; i &lt; aRows; i++)
            {
                for (int j = 0; j &lt; bCols; j++)
                {
                    double sum = 0;
                    for (int k = 0; k &lt; aCols; k++)
                    {
                        sum += matrixA[i, k] * matrixB[k, j];
                    }
                    result[i, j] = sum;
                }
            }

            return result;
        }

        static void DisplayMatrixPreview(double[,] matrix, int previewSize = 3)
        {
            Console.WriteLine($"\nçŸ©é˜µé¢„è§ˆ (å‰{previewSize}x{previewSize}ä¸ªå…ƒç´ ):");

            int rows = Math.Min(previewSize, matrix.GetLength(0));
            int cols = Math.Min(previewSize, matrix.GetLength(1));

            for (int i = 0; i &lt; rows; i++)
            {
                for (int j = 0; j &lt; cols; j++)
                {
                    Console.Write($"{matrix[i, j],8:0.00} ");
                }
                Console.WriteLine();
            }
        }
    }
}

</code></pre>
<p>æ¥ä¸‹æ¥æ‰“å¼€ dotraceï¼Œé€‰æ‹© <code>Timeline</code> æ¨¡å¼ï¼Œé‡‡æ ·é¢‘æ¬¡é»˜è®¤æ˜¯ <code>1000samples/s</code>ï¼Œå³æ¯ç§’1000æ¬¡é‡‡æ ·ï¼Œè¿™ä¸ªç›¸æ¯” <code>Sampling</code> æ¨¡å¼çš„5~11s è¦å¿«å¾—å¤šï¼Œä¹Ÿè®©é‡‡é›†ç»“æœæˆå€çš„å¢åŠ ï¼Œå¦‚æœä½ æƒ³é‡‡é›†çš„æ›´å¯†é›†äº›ï¼Œå¯ä»¥è®¾ç½®ä¸º <code>8000 samples/sec</code>ï¼Œæœ€åå°±æ˜¯å¯åŠ¨ Startï¼Œæˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957076-275492276.png" alt="" loading="lazy"></p>
<p>é‡‡é›†å®Œæˆä¹‹åï¼Œå°±èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ <code>é‡‡é›†ç»“æœç•Œé¢</code>ï¼Œæ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯ğŸ‚ğŸ‘ƒçš„Timeline æ—¶é—´è½´ï¼Œ</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957069-2076427933.png" alt="" loading="lazy"></p>
<p>åœ¨å¦ä¸­çš„æ—¶é—´è½´ä¸Šæ ‡è®°ç€äºŒç±»æ•°æ®ï¼š</p>
<ul>
<li>çº¿ç¨‹æ´»åŠ¨çš„æ—¶åºåˆ†å¸ƒã€‚</li>
<li>GC Waitæ—¶é—´ï¼ˆGCè§¦å‘æ—¶çš„ç´¯è®¡é˜»å¡æ—¶é—´ï¼‰</li>
</ul>
<p>ç»“æœéƒ½æœ‰äº†ï¼Œæ¥ä¸‹æ¥å›ç­”ä¸‰ä¸ªé—®é¢˜æ¥ç†Ÿæ‚‰ä¸‹ <code>Timeline</code> æ¨¡å¼å§ã€‚</p>
<h2 id="ä¸‰å‡ ä¸ªå¸¸è§çš„ç–‘é—®è§£ç­”">ä¸‰ï¼šå‡ ä¸ªå¸¸è§çš„ç–‘é—®è§£ç­”</h2>
<h3 id="1-å“ªä¸ªå‡½æ•°æœ€è€—æ—¶">1. å“ªä¸ªå‡½æ•°æœ€è€—æ—¶</h3>
<p>å®è§‚è§‚å¯Ÿæ—¶é—´è½´ï¼Œæˆ‘ä»¬å‘ç° Mainçº¿ç¨‹çš„è½´ä¸Šæœ‰ä¸€æ®µå¾ˆé•¿çš„æ·±ç»¿è‰²ï¼Œè¯´æ˜å®ƒæ›¾åœ¨è¿™ä¸ªæ—¶æ®µæ´»åŠ¨ï¼Œæ¥ä¸‹æ¥åœ¨ <code>Thread State</code> é¢æ¿ä¸­é€‰æ‹© <code>Running</code> çŠ¶æ€ï¼Œç„¶åé€‰æ‹© <code>Main</code> çº¿ç¨‹è¿›è¡Œè¿‡æ»¤ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957102-2069104999.png" alt="" loading="lazy"></p>
<p>ä»å¦ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿½è¸ªçš„13så‘¨æœŸä¸­ï¼ŒMainåœ¨ç¬¬4sæ—¶å¼€å§‹å‘é£™ï¼Œä» Hotspots ä¸‹çš„ 8s MultiplyMatrices æ¥çœ‹ï¼Œæ—¶é—´éƒ½è¢«å®ƒåƒäº†ï¼Œåœ¨ <code>Runningï¼šCPU Core</code> ä¸­èƒ½çœ‹åˆ°çº¿ç¨‹å¤§å¤šéƒ½åœ¨ <code>core11</code> å’Œ <code>core9</code> ä¸Šè·‘ï¼Œæ‰¾åˆ°å¯ç–‘å‡½æ•°åï¼Œå¯ä»¥å³é”®é€‰æ‹© <code>Show Code</code> è§‚å¯Ÿ MultiplyMatrices æ–¹æ³•çš„æºä»£ç ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957087-637855457.png" alt="" loading="lazy"></p>
<p>è‡³æ­¤æˆ‘ä»¬æ‰¾åˆ°äº†è€—è´¹cpuçš„çƒ­ç‚¹å‡½æ•°ã€‚</p>
<h3 id="2-ä¸ºä»€ä¹ˆæ·±ç»¿è‰²æ˜¯ä¸é—´æ–­çš„">2. ä¸ºä»€ä¹ˆæ·±ç»¿è‰²æ˜¯ä¸é—´æ–­çš„</h3>
<p>è¿™æ˜¯ä¸€ä¸ªæŒºæœ‰æ„æ€çš„é—®é¢˜ï¼Œç†Ÿæ‚‰æ“ä½œç³»ç»ŸçŸ¥è¯†çš„æœ‹å‹åº”è¯¥çŸ¥é“Windowsæ˜¯æŠ¢å å¼æ“ä½œç³»ç»Ÿï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ†é…åˆ°ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œåœ¨è½åœ°ä¸Šç”¨ <code>é‡ç¨‹(Quantum)</code> è¡¨ç¤ºï¼Œæ‰€ä»¥è¿™äº›é—´æ–­çš„å¾ˆæ˜¾ç„¶æ˜¯<code>Mainçº¿ç¨‹</code>ä»<code>å¤±å® </code>åˆ°<code>å¾—å® </code>çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå³å›¾ä¸­çš„ <code>ç²‰è‰²åŒºåŸŸ</code>ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957088-1032204877.png" alt="" loading="lazy"></p>
<p>æ¥ä¸‹æ¥åœ¨ <code>Thread State</code> é¢æ¿ä¸­é€‰æ‹© <code>Waiting</code>ï¼Œä¸‹é’» <code>ç²‰è‰²æ¡æ®µ</code>ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957067-303008551.png" alt="" loading="lazy"></p>
<p>ä»å¦ä¸­å¯ä»¥çœ‹åˆ°è¿™ä¸ªçŠ¶æ€å« <code>Waiting for CPU</code>ï¼Œå³æ­£ç­‰å¾…CPUå†æ¬¡è°ƒåº¦ã€‚</p>
<h3 id="3-è§‚å¯Ÿ-gc-çš„è¿ä½œæƒ…å†µ">3. è§‚å¯Ÿ GC çš„è¿ä½œæƒ…å†µ</h3>
<p>GCè¿ä½œçš„è¯¦ç»†ä¿¡æ¯å…¶å®ç”¨ perfview æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œæ¯•ç«Ÿä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå¾ˆå®¹æ˜“è¾¾åˆ°æˆåƒä¸Šä¸‡æ¬¡GCï¼Œå¦‚æœGCæ¯”è¾ƒå°‘çš„è¯ï¼Œè¿˜æ˜¯å¯ä»¥ç”¨ dottrace è§‚å¯Ÿä¸€ä¸‹çš„ï¼Œæ¥ä¸‹æ¥ç®€å•ä¿®æ”¹ä»£ç ï¼Œåœ¨ MultiplyMatrices æ–¹æ³•çš„æœ€ååŠ ä¸Š <code>GC.Collect()</code>ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š</p>
<pre><code class="language-C#">
        static double[,] MultiplyMatrices(double[,] matrixA, double[,] matrixB)
        {
            int aRows = matrixA.GetLength(0);
            int aCols = matrixA.GetLength(1);
            int bCols = matrixB.GetLength(1);

            if (matrixA.GetLength(1) != matrixB.GetLength(0))
                throw new ArgumentException("çŸ©é˜µç»´åº¦ä¸åŒ¹é…");

            var result = new double[aRows, bCols];

            for (int i = 0; i &lt; aRows; i++)
            {
                for (int j = 0; j &lt; bCols; j++)
                {
                    double sum = 0;
                    for (int k = 0; k &lt; aCols; k++)
                    {
                        sum += matrixA[i, k] * matrixB[k, j];
                    }
                    result[i, j] = sum;
                }
            }

            GC.Collect();  //æ•…æ„è§¦å‘é˜»å¡GC

            return result;
        }

</code></pre>
<p>å¯åŠ¨ dottrace è·Ÿè¸ªï¼Œå®Œæˆä¹‹åæˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202506/214741-20250622141957103-1344889886.png" alt="" loading="lazy"></p>
<p>æ‰“å¼€å¦ä¹‹åï¼Œé€‰ä¸­ Mainçº¿ç¨‹ï¼ŒGarbageCollectionäº‹ä»¶ä»¥åŠRunningçŠ¶æ€ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œå½“å‰è§¦å‘äº† 3æ¬¡ é˜»å¡GCï¼Œ1æ¬¡åå°GCã€‚</p>
<h2 id="å››æ€»ç»“">å››ï¼šæ€»ç»“</h2>
<p>æ•´ä½“ä¸Šæ¥è¯´ï¼Œdottraceæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯æ—¶é—´è½´ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹æ¯” perfview çš„è¡¨æ ¼å±•ç¤ºæ³•æ›´åŠ æ¸…æ¥šï¼Œ<code>timeline</code>æ¨¡å¼ä¹Ÿæ˜¯åœ¨çœŸå®åœºæ™¯ä¸­ç”¨çš„æœ€å¤šçš„ä¸€ç§æ´å¯Ÿæ–¹å¼ã€‚</p>
<blockquote>
<p>ä½œä¸ºJetBrainsç¤¾åŒºå†…å®¹åˆä½œè€…ï¼Œå¦‚æœ‰è´­ä¹°jetbrainsçš„äº§å“ï¼Œå¯ä»¥ç”¨æˆ‘çš„æŠ˜æ‰£ç  HUANGXINCHENGï¼Œæœ‰25%çš„å†…éƒ¨ä¼˜æƒ å“¦ã€‚</p>
</blockquote>
<img src="https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg" width="700" height="300" alt="å›¾ç‰‡åç§°" align="center">
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-06-22 14:21">2025-06-22 14:20</span>&nbsp;
<a href="https://www.cnblogs.com/huangxincheng">ä¸€çº¿ç å†œ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">43</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18942584);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18942584', targetLink: 'https://www.cnblogs.com/huangxincheng/p/18942584', title: 'DotTraceç³»åˆ—ï¼š2. ç†è§£å››å¤§ç»å…¸çš„è¯Šæ–­ç±»å‹ï¼ˆä¸‹ï¼‰' })">ä¸¾æŠ¥</a>
</div>
        