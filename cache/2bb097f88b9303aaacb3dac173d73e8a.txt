
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/shy-huang/p/19016652" title="发布于 2025-08-01 14:32">
    <span role="heading" aria-level="2">Excel: xls与xlsx格式转换排坑指南</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="前言"><font color="#D2691E">前言</font></h2>
<p>总结一下在把Excel 5.0/95 的XLS转换为Excel 2007的XLSX新格式遇到的问题。</p>
<h3 id="数据类型匹配"><font color="#FF7F50">数据类型匹配</font></h3>
<p>XLS文件里的单元格是General类型，但在XLSX里，是有针对具体的列设置数据类型的，这使得在操作database时，有可能造成数据类型不一致的错误：</p>
<pre><code>string type = string.Empty;
if (!dict.TryGetValue(field, out type))
{
    return "TEXT";
}

switch (type.ToUpper())
{
    case "C":
    case "L": // Bit(Logic) treat as Text
        return "TEXT";

    case "I":
        return "INTEGER";

    case "B":
    case "F":
    case "N":
    case "Y":
        return "DOUBLE";

    case "D":
    case "T":
        return "DATETIME";

    default:
        return "TEXT";
}
</code></pre>
<p>再者就是对于空串和Null，似乎xls认为没有什么差异，但xlsx读取出来，倘若单元格没有内容，""和DB.Null是有差异的：</p>
<pre><code>if (cellValue == DBNull.Value || cellValue == null)
{
  if ((sheetName.Equals("sheet1", StringComparison.OrdinalIgnoreCase) || sheetName.Equals("sheet2", StringComparison.OrdinalIgnoreCase)) &amp;&amp;
      (columnName.Equals("date_from", StringComparison.OrdinalIgnoreCase) || columnName.Equals("date_to", StringComparison.OrdinalIgnoreCase)))
  {
      values += "'" + new string(' ', 16) + "',";
  }
  else
  {
      values += "NULL,";
  }

  continue;
</code></pre>
<p>}</p>
<h3 id="内容多行时处理不同"><font color="#FF7F50">内容多行时处理不同</font></h3>
<p>但单元格内容有多行时，xls认为换行是：CR+LF，xlsx则只有LF, 此时需要一个正则，来识别和修正这个换行：</p>
<pre><code>case "TEXT":
    string escaped = Regex.Replace(cellValue.ToString().Replace("'", "''"), @"(?&lt;!\r)\n", "\r\n");
    values += "'" + escaped + "',";
    break;
</code></pre>
<h3 id="default值"><font color="#FF7F50">default值</font></h3>
<p>在xls中，如果每个column都有设置过数据类型，不是default的General，此时修改该column的某一行，如果不匹配，xls将有个角标显示警告，数据类型不符合预期，xls认为这是人为的一个失误。读取时，可能会被强制成default的值。</p>
<p>但如果事先设置了值，再设置数据类型，虽然不匹配，xls将无视这个警告，xls会当做是有意为之。</p>
<pre><code>int: 0;
doouble: 0.0;
bool: string;
DateTime: string;
</code></pre>
<h3 id="最大行数"><font color="#FF7F50">最大行数</font></h3>
<p>xls支持的最大行数：大约是65K，65535行。 但是，当编辑其中内容再次保存时，可能只剩18K，在某些版本（Excel 5.0）会丢失一部分数据。</p>
<p>xlsx支持的最大行数：大约是10,000K, 1048576行。这时候就无法另存为xls格式，数据将丢失绝大部分。</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.002777777777777778" data-date-updated="2025-08-01 14:36">2025-08-01 14:32</span>&nbsp;
<a href="https://www.cnblogs.com/shy-huang">肖恩部落</a>&nbsp;
阅读(<span id="post_view_count">163</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19016652);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19016652', targetLink: 'https://www.cnblogs.com/shy-huang/p/19016652', title: 'Excel: xls与xlsx格式转换排坑指南' })">举报</a>
</div>
        