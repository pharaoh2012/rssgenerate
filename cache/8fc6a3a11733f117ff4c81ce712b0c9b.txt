
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/vpandaxjl/p/18881928" title="发布于 2025-05-18 08:20">
    <span role="heading" aria-level="2">MCP SSE交互完整过程</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p class="md-end-block md-p"><span class="md-plain md-expand">有关MCP的介绍文章很多，本文不细说，做一个时序图将完整过程说清楚。MCP协议主要通过两种技术实现：标准输入输出（stdio）和服务器发送事件（SSE），stdio（标准输入输出）是MCP协议在本地或容器化环境中的主要实现方式。如果把客户端和服务端分离，在网络中通过API调用就使用SSE，这里主要就讲SSE的过程。</span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">SSE概述</span></h2>
<p class="md-end-block md-p"><span class="md-plain">SSE是一种基于HTTP协议的轻量级技术，允许服务器向客户端（通常是浏览器）推送实时更新的数据。通过持久化的连接实现服务器到客户端的单向数据流。大致步骤如下：</span></p>
<p class="md-end-block md-p"><span class="md-plain">（1）客户端通过HTTP请求向服务器发起SSE连接，并保持长连接；</span></p>
<p class="md-end-block md-p"><span class="md-plain">（2）客户端新建连接，向服务端请求列出工具和携带参数请求执行工具等操作；</span></p>
<p class="md-end-block md-p"><span class="md-plain">（3）服务端通过首次长连接返回执行结果；</span></p>
<h2 class="md-end-block md-heading md-focus"><span class="md-plain md-expand">MCP SSE完整过程</span></h2>
<p class="md-end-block md-p"><span class="md-plain">包含：请求用户、客户端、服务端、大模型，描述完整MCP SSE过程。</span></p>
<p class="md-end-block md-p"><span class="md-image md-img-loaded" data-src="https://notepic-1254052750.cos.ap-shanghai.myqcloud.com/1747208866330.png"><img src="https://notepic-1254052750.cos.ap-shanghai.myqcloud.com/1747208866330.png" alt="1747208866330"></span></p>
<h2 class="md-end-block md-heading"><span class="md-plain">过程描述：</span></h2>
<p class="md-end-block md-p"><span class="md-plain">0、编写MCP Server工具，使用Python通过装饰器将工具注册到Server端上；</span></p>
<p class="md-end-block md-p"><span class="md-plain">1、MCP Client对Server发送请求，GET方式请求/sse，并保持长连接状态等待数据实时返回；</span></p>
<p class="md-end-block md-p"><span class="md-plain">2、Server端返回sessionID；</span></p>
<p class="md-end-block md-p"><span class="md-plain">3、Client发送initialize包含协商信息；</span></p>
<p class="md-end-block md-p"><span class="md-plain">4、Server端响应确认；</span></p>
<p class="md-end-block md-p"><span class="md-plain">5、Client发送initialized确认；</span></p>
<p class="md-end-block md-p"><span class="md-plain">6、用户在客户端请求提问：杭州天气；</span></p>
<p class="md-end-block md-p"><span class="md-plain">7、Client发起向Server端的tools/list请求；</span></p>
<p class="md-end-block md-p"><span class="md-plain">8、Server端返回注册好的工具列表及所需参数；</span></p>
<p class="md-end-block md-p"><span class="md-plain">9、Client封装请求内容：</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp;  "messages": [<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "user",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "content": "杭州的天气"<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  ],<br><span> &nbsp;  "model": "gpt-4o-mini",<br><span> &nbsp;  "max_tokens": 1000,<br><span> &nbsp;  "tools": [<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "function",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "function": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "name": "get_weather",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "description": "获取指定城市的天气信息",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "parameters": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "properties": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "city": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "title": "City",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "string"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "required": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "city"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "title": "get_weatherArguments",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "object"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "function",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "function": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "name": "suggest_activity",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "description": "根据天气描述推荐适合的活动",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "parameters": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "properties": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "condition": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "title": "Condition",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "string"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "required": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "condition"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "title": "suggest_activityArguments",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "object"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  ]<br><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">10、Client将以上内容发送大模型调用API请求；</span></p>
<p class="md-end-block md-p"><span class="md-plain">11、大模型返回tool_calls内容；</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp;  "id": "chatcmpl-BWdzaegB1h3XJMc4ZcgL4TWR3wmcr",<br><span> &nbsp;  "model": "gpt-4o-mini-2024-07-18",<br><span> &nbsp;  "object": "chat.completion",<br><span> &nbsp;  "created": 1747119926,<br><span> &nbsp;  "choices": [<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "index": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "message": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "assistant",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "tool_calls": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "id": "call_OaxrnCKcBANGqm4mheSd9RSD",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "function",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "function": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "name": "get_weather",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "arguments": "{\"city\":\"杭州\"}"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ]<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "finish_reason": "tool_calls"<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  ],<br><span> &nbsp;  "system_fingerprint": "fp_7a53abb7a2",<br><span> &nbsp;  "usage": {<br><span> &nbsp; &nbsp; &nbsp;  "prompt_tokens": 88,<br><span> &nbsp; &nbsp; &nbsp;  "completion_tokens": 15,<br><span> &nbsp; &nbsp; &nbsp;  "total_tokens": 103,<br><span> &nbsp; &nbsp; &nbsp;  "prompt_tokens_details": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "audio_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "cached_tokens": 0<br><span> &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp;  "completion_tokens_details": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "accepted_prediction_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "audio_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "reasoning_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "rejected_prediction_tokens": 0<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  }<br><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">12、Client将大模型返回的name和arguments内容，POST请求Server；</span></p>
<p class="md-end-block md-p"><span class="md-plain">13、Server接受参数执行对应的工具，并通过第一次长连接返回数据；</span></p>
<p class="md-end-block md-p"><span class="md-plain">14、Client第二次将返回结果发送大模型调用API请求；</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp;  "messages": [<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "user",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "content": "杭州的天气"<br><span> &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "assistant",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "content": null,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "tool_calls": [<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "id": "call_4Sbmkb2kNltmzVMkJJDDgGKd",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "function": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "arguments": "{\"city\":\"杭州\"}",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "name": "get_weather"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "type": "function"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ]<br><span> &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "tool",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "tool_call_id": "call_4Sbmkb2kNltmzVMkJJDDgGKd",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "content": "杭州：晴，25°C"<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  ],<br><span> &nbsp;  "model": "gpt-4o-mini",<br><span> &nbsp;  "max_tokens": 1000<br><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p class="md-end-block md-p"><span class="md-plain">15、大模型返回结果，最终客户端将content内容返回给用户；</span></p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span>{<br><span> &nbsp;  "id": "chatcmpl-BWe2yvHUm17yPRxTRuUS1FCYezPn2",<br><span> &nbsp;  "model": "gpt-4o-mini-2024-07-18",<br><span> &nbsp;  "object": "chat.completion",<br><span> &nbsp;  "created": 1747120136,<br><span> &nbsp;  "choices": [<br><span> &nbsp; &nbsp; &nbsp;  {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "index": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "message": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "role": "assistant",<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "content": "杭州的天气是晴，气温25°C。"<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "finish_reason": "stop"<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  ],<br><span> &nbsp;  "system_fingerprint": "fp_7a53abb7a2",<br><span> &nbsp;  "usage": {<br><span> &nbsp; &nbsp; &nbsp;  "prompt_tokens": 38,<br><span> &nbsp; &nbsp; &nbsp;  "completion_tokens": 12,<br><span> &nbsp; &nbsp; &nbsp;  "total_tokens": 50,<br><span> &nbsp; &nbsp; &nbsp;  "prompt_tokens_details": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "audio_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "cached_tokens": 0<br><span> &nbsp; &nbsp; &nbsp;  },<br><span> &nbsp; &nbsp; &nbsp;  "completion_tokens_details": {<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "accepted_prediction_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "audio_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "reasoning_tokens": 0,<br><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "rejected_prediction_tokens": 0<br><span> &nbsp; &nbsp; &nbsp;  }<br><span> &nbsp;  }<br><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0.8307546008518518" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-18 08:20">2025-05-18 08:20</span>&nbsp;
<a href="https://www.cnblogs.com/vpandaxjl">功夫小熊猫</a>&nbsp;
阅读(<span id="post_view_count">51</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18881928);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18881928', targetLink: 'https://www.cnblogs.com/vpandaxjl/p/18881928', title: 'MCP SSE交互完整过程' })">举报</a>
</div>
