
        <div class="postTitle">
            <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/tobeone/p/18713253" title="发布于 2025-02-14 13:50">
    <span role="heading" aria-level="2">在 GitLab CI/CD 中使用内置的容器镜像库</span>
    

</a>

        </div>
        <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h4 id="配置-docker-in-docker">配置 <code>Docker-in-Docker</code></h4>
<p><code>Docker-in-Docker (dind)</code> means:</p>
<ul>
<li>你应该注册一个 <code>Docker executor</code> 或 <code>Kubernetes executor</code></li>
<li>执行器（executor）使用 docker 镜像运行你的 CI/CD jobs</li>
</ul>
<p>参考 <a href="https://archives.docs.gitlab.com/16.1/ee/ci/docker/using_docker_build.html#docker-in-docker-with-tls-disabled-in-the-docker-executor" target="_blank" rel="noopener nofollow">Docker-in-Docker with TLS disabled in the Docker executor</a></p>
<h4 id="身份认证">身份认证</h4>
<pre><code class="language-shell">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
</code></pre>
<p><code>CI_REGISTRY_USER </code>、<code>CI_REGISTRY_PASSWORD</code> 和 <code>CI_REGISTRY</code> 都是 CI/CD 变量</p>
<p>参考：<a href="https://archives.docs.gitlab.com/16.1/ee/user/packages/container_registry/authenticate_with_container_registry.html" target="_blank" rel="noopener nofollow">Authenticate with the Container Registry</a></p>
<h4 id="gitlab-runner-配置">Gitlab Runner 配置</h4>
<pre><code>[root@localhost test]# cat /etc/gitlab-runner/config.toml 
[[runners]]
  ....
  [runners.docker]
    tls_verify = false
    privileged = true
    image = "docker:20.10.16"
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache"]
    shm_size = 0
    extra_hosts = ["registry.gitlab.example.com:your-gitlab-instance-host"]
</code></pre>
<h4 id="构建并推送镜像到镜像库">构建并推送镜像到镜像库</h4>
<pre><code>[root@localhost opt]# cat .gitlab-ci.yml 
stages:
  - build

build-image:
  stage: build
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      command: ["--insecure-registry", "registry.gitlab.example.com"]
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
      - docker info
  script:
   - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
   - docker build --pull -t $IMAGE_TAG .
   - docker push $IMAGE_TAG
</code></pre>
<h4 id="使用镜像库的镜像">使用镜像库的镜像</h4>
<pre><code>[root@localhost opt]# cat .gitlab-ci.yml 
stages:
  - test

# before_script: docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

format:
  stage: test
  image: registry.gitlab.example.com/group/project:tag
  variables:
   CGO_ENABLED: 1
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)
</code></pre>
<h4 id="troubleshooting">Troubleshooting</h4>
<h5 id="docker-cannot-connect-to-the-docker-daemon-at-tcpdocker2375-is-the-docker-daemon-running">docker: Cannot connect to the Docker daemon at tcp://docker:2375. Is the docker daemon running?</h5>
<p>原因是 Docker daemon 启动失败，请检查 docker executor 是否配置正确，是否配置 CI/CD 变量 <code>DOCKER_HOST</code> 和 <code>DOCKER_TLS_CERTDIR</code><br>
参考 <a href="https://archives.docs.gitlab.com/16.1/ee/ci/docker/using_docker_build.html#docker-in-docker-with-tls-disabled-in-the-docker-executor" target="_blank" rel="noopener nofollow">Docker-in-Docker with TLS disabled in the Docker executor</a></p>
<h5 id="error-response-from-daemon-get-httpsregistrygitlabexamplecomv2-dial-tcp-lookup-registrygitlabexamplecom-on-1921684019053-no-such-host">Error response from daemon: Get "<a href="https://registry.gitlab.example.com/v2/" target="_blank" rel="noopener nofollow">https://registry.gitlab.example.com/v2/</a>": dial tcp: lookup registry.gitlab.example.com on 192.168.40.190:53: no such host</h5>
<p>原因是在 job 执行中使用了 <code>docker-in-docker（dind）</code>方式运行一个 <code>Docker daemon</code>，这个 <code>docker daemon</code> 没有使用宿主机的 <code>/etc/hosts</code> 文件，而是使用了默认的 <code>DNS</code> 服务器来解析所需的域名。因此，当尝试登陆<code>registry.gitlab.example.com</code> 时，<code>DNS</code> 无法解析这个名字，导致了错误<br>
解决方法：为 <code>Docker runner</code> 添加额外的 <code>hosts</code> 映射</p>
<pre><code>[[runners]]
  ....
  [runners.docker]
    ....
    extra_hosts = ["registry.gitlab.example.com:your-gitlab-instance-host"]
</code></pre>
<h5 id="error-response-from-daemon-get-httpsregistrygitlabexamplecomv2-x509-certificate-is-not-valid-for-any-names-but-wanted-to-match-registrygitlabexamplecom">Error response from daemon: Get "<a href="https://registry.gitlab.example.com/v2/" target="_blank" rel="noopener nofollow">https://registry.gitlab.example.com/v2/</a>": x509: certificate is not valid for any names, but wanted to match registry.gitlab.example.com</h5>
<p>原因是 <code>Docker daemon</code> 无法验证镜像仓库自签的 SSL 证书<br>
解决方法：把这个镜像仓库添加到 <code>dind service</code> 的 <code>insecure-registries</code> 列表中</p>
<h6 id="通过挂载配置文件的方式">通过挂载配置文件的方式</h6>
<pre><code>[root@localhost opt]# cat /opt/daemon.json 
{
  "insecure-registries": ["registry.gitlab.example.com"]
}

[root@localhost opt]# cat /etc/gitlab-runner/config.toml
[[runners]]
  ....
  [runners.docker]
    ....
    volumes = ["/opt/daemon.json:/etc/docker/daemon.json:ro"]
</code></pre>
<h6 id="通过-gitlab-runner-配置的方式">通过 <code>GitLab Runner</code> 配置的方式</h6>
<pre><code>[[runners]]
  ...
  executor = "docker"
  [runners.docker]
    ...
    privileged = true
    [[runners.docker.services]]
      name = "docker:20.10.16-dind"
      command = ["--insecure-registry", "registry.gitlab.example.com"]
</code></pre>
<h6 id="通过-cli-flag-的方式">通过 <code>CLI flag</code> 的方式</h6>
<pre><code>[root@localhost opt]# cat .gitlab-ci.yml
build-image:
  stage: build
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      command: ["--insecure-registry", "registry.gitlab.example.com"]
</code></pre>
<h4 id="补充在-cli-中使用容器镜像库">补充：在 CLI 中使用容器镜像库</h4>
<pre><code class="language-shell"># 登录
docker login registry.gitlab.example.com

# 构建镜像
docker build -t registry.gitlab.example.com/group/project .

# 推送镜像
docker push registry.gitlab.example.com/group/project
</code></pre>
<h4 id="参考文档">参考文档</h4>
<p><a href="https://archives.docs.gitlab.com/16.1/ee/user/packages/container_registry/build_and_push_images.html" target="_blank" rel="noopener nofollow">Build and push container images to the Container Registry</a><br>
<a href="https://archives.docs.gitlab.com/16.1/ee/ci/docker/using_docker_build.html#use-docker-in-docker" target="_blank" rel="noopener nofollow">Use Docker to build Docker images</a></p>

</div>
<div class="clear"></div>

        <div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0.019764008519675927" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-14 13:51">2025-02-14 13:50</span>&nbsp;
<a href="https://www.cnblogs.com/tobeone">心向所想</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18713253" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18713253);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18713253', targetLink: 'https://www.cnblogs.com/tobeone/p/18713253', title: '在 GitLab CI/CD 中使用内置的容器镜像库' })">举报</a>
</div>
    