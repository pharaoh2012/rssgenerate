
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/qubernet/p/18704234" title="å‘å¸ƒäº 2025-02-08 15:28">
    <span role="heading" aria-level="2">.Net9ä¸­é€šè¿‡HttpClientç®€å•è°ƒç”¨Ollamaä¸­çš„DeepSeek R1æ¨¡å‹</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>æœ¬æ–‡ä¸»è¦ä½¿ç”¨.Net9ä¸­çš„HttpClientç»„ä»¶ï¼Œè°ƒç”¨æœ¬åœ°éƒ¨ç½²çš„Ollamaæä¾›çš„APIæ¥å£ï¼Œè·å–å¯¹åº”çš„é—®ç­”ä¿¡æ¯ã€‚</p>
</blockquote>
<h1 id="1æµ‹è¯•ç¯å¢ƒ">1ã€ğŸ¥‡æµ‹è¯•ç¯å¢ƒ</h1>
<ul>
<li>
<p>VS2022ï¼›</p>
</li>
<li>
<p>.Net9æ§åˆ¶å°ç¨‹åºï¼›</p>
</li>
<li>
<p>HttpClientç»„ä»¶ï¼›</p>
</li>
<li>
<p>æœ¬åœ°éƒ¨ç½²çš„Ollamaç¯å¢ƒ</p>
</li>
<li>
<p>DeepSeek R1æ¨¡å‹ï¼ˆdeepseek-r1:1.5bï¼‰</p>
</li>
</ul>
<p>å…³äºæœ¬åœ°éƒ¨ç½²çš„Ollamaç¯å¢ƒï¼Œå¯å‚è§æ–‡ç« ã€<a href="https://www.cnblogs.com/qubernet/p/18702147" target="_blank">é€šè¿‡Ollamaæœ¬åœ°éƒ¨ç½²DeepSeek R1ä»¥åŠç®€å•ä½¿ç”¨çš„æ•™ç¨‹ï¼ˆè¶…è¯¦ç»†ï¼‰</a>ã€‘ã€‚</p>
<hr>
<h1 id="2åˆ›å»ºæ§åˆ¶å°ç¨‹åº">2ã€ğŸ¥ˆåˆ›å»ºæ§åˆ¶å°ç¨‹åº</h1>
<p>æˆ‘ä»¬ä½¿ç”¨VS2022åˆ›å»ºä¸€ä¸ªåŸºäº.Net9çš„æ§åˆ¶å°ç¨‹åºï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208144132808-1982141445.png" alt="æ§åˆ¶å°ç¨‹åº" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208144155424-349494272.png" alt="æ§åˆ¶å°ç¨‹åº" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208144300052-451934267.png" alt="æ§åˆ¶å°ç¨‹åº" loading="lazy"></p>
<p>ä¸Šè¿°æˆ‘ä»¬å°±åˆ›å»ºå¥½äº†ä¸€ä¸ªæ§åˆ¶å°ç¨‹åºã€‚</p>
<hr>
<h1 id="3ollamaæ¥å£">3ã€ğŸ¥‰Ollamaæ¥å£</h1>
<p>Ollamaä¸ºæˆ‘ä»¬æä¾›äº†å¤šç§æ¥å£ï¼Œæœ€å¸¸ç”¨çš„æ¥å£ä¸ºï¼š</p>
<ul>
<li>
<p>POST /api/generate</p>
</li>
<li>
<p>POST /api/chat</p>
</li>
</ul>
<p>ä¸Šè¿°ä¸¤ä¸ªæ¥å£ä¸ºæœ€å¸¸ç”¨çš„ï¼Œå…·ä½“è¯´æ˜å¯å‚è§ã€<a href="https://github.com/ollama/ollama/blob/main/docs/api.md" target="_blank" rel="noopener nofollow">https://github.com/ollama/ollama/blob/main/docs/api.md</a>ã€‘è¯´æ˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºä¸ºéƒ¨åˆ†ä½¿ç”¨è¯´æ˜çš„æˆªå›¾ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208145015710-1933094050.png" alt="Ollamaæ¥å£" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208145111027-1097427983.png" alt="Ollamaæ¥å£" loading="lazy"></p>
<hr>
<h1 id="4è°ƒç”¨å®ç°">4ã€ğŸ…è°ƒç”¨å®ç°</h1>
<h2 id="41generateæ¥å£">4.1ã€ğŸ€generateæ¥å£</h2>
<p>æˆ‘ä»¬åœ¨<code>Program.cs</code>æ–‡ä»¶ä¸­ç¼–å†™å…·ä½“çš„ä»£ç ã€‚</p>
<p>å…·ä½“ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼ˆå¤åˆ¶ç²˜è´´å³å¯è¿è¡Œï¼‰ï¼Œéƒ½æœ‰å¯¹åº”çš„è¯´æ˜ï¼š</p>
<pre><code class="language-cs">using System.Data;
using System.Text;
using System.Text.Json;

// HttpClientå®ä¾‹
var httpClient = new HttpClient();

// Ollama APIè¯·æ±‚åœ°å€
var requestUrl = "http://localhost:11434/api/generate";

Console.ForegroundColor = ConsoleColor.Green;
Console.WriteLine("è¯·è¾“å…¥å¯¹è¯å†…å®¹ï¼ˆè¾“å…¥exité€€å‡ºï¼‰ï¼š");

while (true)
{
    // è¯»å–è¾“å…¥çš„å†…å®¹
    var input = Console.ReadLine();

    if (input != null &amp;&amp; input.ToLower() == "exit")
    {
        Console.ForegroundColor = ConsoleColor.Red;
        Console.WriteLine("ç¨‹åºå³å°†é€€å‡º...");

        // é€€å‡ºå¾ªç¯ï¼Œç¨‹åºç»“æŸ
        break;
    }

    // è¯·æ±‚å‚æ•°
    var requestData = new
    {
        // æŒ‡å®šæ¨¡å‹æ ‡è¯†ç¬¦
        model = "deepseek-r1:1.5b",
        // è¾“å…¥çš„æç¤ºæ–‡æœ¬
        prompt = input,
        // æ˜¯å¦å¯ç”¨æµå¼å“åº”
        stream = true,
        // å…¶ä»–é€‰é¡¹
        options = new
        {
            // æ§åˆ¶ç”Ÿæˆéšæœºæ€§ï¼ˆ0-1ï¼‰
            temperature = 0.7,
            // æœ€å¤§ç”Ÿæˆ token æ•°
            max_tokens = 500
        }
    };

    // åˆ›å»ºHttpRequestMessageå®ä¾‹ä»¥åŠè®¾ç½®è¯·æ±‚å†…å®¹
    using var request = new HttpRequestMessage(HttpMethod.Post, requestUrl);
    request.Content = new StringContent(JsonSerializer.Serialize(requestData), Encoding.UTF8, "application/json");

    // å‘é€è¯·æ±‚å¹¶è·å–å“åº”
    using var response = await httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead);
    await using var stream = await response.Content.ReadAsStreamAsync();
    using var reader = new StreamReader(stream);

    // å¾ªç¯è¯»å–å“åº”æµ
    while (!reader.EndOfStream)
    {
        var content = await reader.ReadLineAsync();
        if (!string.IsNullOrEmpty(content))
        {
            var partialResponse = JsonSerializer.Deserialize&lt;OllamaResponse&gt;(content);

            // è¾“å‡ºå“åº”å†…å®¹
            Console.ForegroundColor = ConsoleColor.White;
            Console.Write(partialResponse?.response);
        }
    }

    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("\r\n\r\nè¯·è¾“å…¥å¯¹è¯å†…å®¹ï¼ˆè¾“å…¥exité€€å‡ºï¼‰ï¼š");
}

/// &lt;summary&gt;
/// Ollama APIå“åº”å®ä½“ç±»
/// &lt;/summary&gt;
public class OllamaResponse
{
    /// &lt;summary&gt;
    /// æ¨¡å‹æ ‡è¯†ç¬¦
    /// &lt;/summary&gt;
    public string model { get; set; }

    /// &lt;summary&gt;
    /// åˆ›å»ºæ—¶é—´æˆ³
    /// &lt;/summary&gt;
    public string created_at { get; set; }

    /// &lt;summary&gt;
    /// å“åº”å†…å®¹
    /// &lt;/summary&gt;
    public string response { get; set; }

    /// &lt;summary&gt;
    /// æ˜¯å¦å®Œæˆ
    /// &lt;/summary&gt;
    public bool done { get; set; }

    /// &lt;summary&gt;
    /// å®ŒæˆåŸå› 
    /// &lt;/summary&gt;
    public string done_reason { get; set; }

    public int[] context { get; set; }
    public long total_duration { get; set; }
    public long load_duration { get; set; }
    public int prompt_eval_count { get; set; }
    public long prompt_eval_duration { get; set; }
    public int eval_count { get; set; }
    public long eval_duration { get; set; }
}
</code></pre>
<p><strong>è¿è¡Œæ•ˆæœï¼š</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208151640068-1785980879.gif" alt="è¿è¡Œæ•ˆæœ" loading="lazy"></p>
<h2 id="42chatæ¥å£">4.2ã€ğŸchatæ¥å£</h2>
<p>æˆ‘ä»¬åœ¨<code>Program.cs</code>æ–‡ä»¶ä¸­ç¼–å†™å…·ä½“çš„ä»£ç ã€‚</p>
<p>å…·ä½“ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼ˆå¤åˆ¶ç²˜è´´å³å¯è¿è¡Œï¼‰ï¼Œéƒ½æœ‰å¯¹åº”çš„è¯´æ˜ï¼š</p>
<pre><code class="language-cs">using System.Data;
using System.Text;
using System.Text.Json;

// HttpClientå®ä¾‹
var httpClient = new HttpClient();

// Ollama APIè¯·æ±‚åœ°å€
var requestUrl = "http://localhost:11434/api/chat";

Console.ForegroundColor = ConsoleColor.Green;
Console.WriteLine("è¯·è¾“å…¥å¯¹è¯å†…å®¹ï¼ˆè¾“å…¥exité€€å‡ºï¼‰ï¼š");

while (true)
{
    // è¯»å–è¾“å…¥çš„å†…å®¹
    var input = Console.ReadLine();

    if (input != null &amp;&amp; input.ToLower() == "exit")
    {
        Console.ForegroundColor = ConsoleColor.Red;
        Console.WriteLine("ç¨‹åºå³å°†é€€å‡º...");

        // é€€å‡ºå¾ªç¯ï¼Œç¨‹åºç»“æŸ
        break;
    }

    // è¯·æ±‚å‚æ•°
    var requestData = new
    {
        // æŒ‡å®šæ¨¡å‹æ ‡è¯†ç¬¦
        model = "deepseek-r1:1.5b",
        // è¾“å…¥çš„æç¤ºæ–‡æœ¬
        messages = new[]
        {
            new { role = "user", content = input }
        },
        // æ˜¯å¦å¯ç”¨æµå¼å“åº”
        stream = true,
        // å…¶ä»–é€‰é¡¹
        options = new
        {
            // æ§åˆ¶ç”Ÿæˆéšæœºæ€§ï¼ˆ0-1ï¼‰
            temperature = 0.7,
            // æœ€å¤§ç”Ÿæˆ token æ•°
            max_tokens = 500
        }
    };

    // åˆ›å»ºHttpRequestMessageå®ä¾‹ä»¥åŠè®¾ç½®è¯·æ±‚å†…å®¹
    using var request = new HttpRequestMessage(HttpMethod.Post, requestUrl);
    request.Content = new StringContent(JsonSerializer.Serialize(requestData), Encoding.UTF8, "application/json");

    // å‘é€è¯·æ±‚å¹¶è·å–å“åº”
    using var response = await httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead);
    await using var stream = await response.Content.ReadAsStreamAsync();
    using var reader = new StreamReader(stream);

    // å¾ªç¯è¯»å–å“åº”æµ
    while (!reader.EndOfStream)
    {
        var content = await reader.ReadLineAsync();
        if (!string.IsNullOrEmpty(content))
        {
            var partialResponse = JsonSerializer.Deserialize&lt;OllamaResponse&gt;(content);

            // è¾“å‡ºå“åº”å†…å®¹
            Console.ForegroundColor = ConsoleColor.White;
            Console.Write(partialResponse?.message.content);
        }
    }

    Console.ForegroundColor = ConsoleColor.Green;
    Console.WriteLine("\r\n\r\nè¯·è¾“å…¥å¯¹è¯å†…å®¹ï¼ˆè¾“å…¥exité€€å‡ºï¼‰ï¼š");
}

/// &lt;summary&gt;
/// Ollama APIå“åº”å®ä½“ç±»
/// &lt;/summary&gt;
public class OllamaResponse
{
    /// &lt;summary&gt;
    /// æ¨¡å‹æ ‡è¯†ç¬¦
    /// &lt;/summary&gt;
    public string model { get; set; }

    /// &lt;summary&gt;
    /// åˆ›å»ºæ—¶é—´æˆ³
    /// &lt;/summary&gt;
    public string created_at { get; set; }

    /// &lt;summary&gt;
    /// å“åº”å†…å®¹
    /// &lt;/summary&gt;
    public OllamaResponseMessage message { get; set; }

    /// &lt;summary&gt;
    /// æ˜¯å¦å®Œæˆ
    /// &lt;/summary&gt;
    public bool done { get; set; }

    /// &lt;summary&gt;
    /// å®ŒæˆåŸå› 
    /// &lt;/summary&gt;
    public string done_reason { get; set; }

    public long total_duration { get; set; }
    public long load_duration { get; set; }
    public int prompt_eval_count { get; set; }
    public long prompt_eval_duration { get; set; }
    public int eval_count { get; set; }
    public long eval_duration { get; set; }
}

/// &lt;summary&gt;
/// Ollama APIå“åº”å®ä½“ç±»çš„messageå­ç±»
/// &lt;/summary&gt;
public class OllamaResponseMessage
{
    /// &lt;summary&gt;
    /// è§’è‰²
    /// &lt;/summary&gt;
    public string role { get; set; }

    /// &lt;summary&gt;
    /// å†…å®¹
    /// &lt;/summary&gt;
    public string content { get; set; }
}
</code></pre>
<p><strong>è¿è¡Œæ•ˆæœï¼š</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/346453/202502/346453-20250208152246525-2015758116.gif" alt="è¿è¡Œæ•ˆæœ" loading="lazy"></p>
<hr>
<p>åˆ°æ­¤ï¼Œé€šè¿‡.Net9çš„HttpClientç®€å•è°ƒç”¨Ollamaçš„APIå°±å®Œæˆäº†ã€‚</p>
<hr>
<h1 id="5å…¶ä»–æ–‡ç« ">5ã€ğŸ”–å…¶ä»–æ–‡ç« ï¼š</h1>
<ul>
<li><a href="https://www.cnblogs.com/qubernet/p/18702147" target="_blank">é€šè¿‡Ollamaæœ¬åœ°éƒ¨ç½²DeepSeek R1ä»¥åŠç®€å•ä½¿ç”¨çš„æ•™ç¨‹ï¼ˆè¶…è¯¦ç»†ï¼‰</a></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03114302401736111" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-08 15:32">2025-02-08 15:28</span>&nbsp;
<a href="https://www.cnblogs.com/qubernet">Qubernet</a>&nbsp;
é˜…è¯»(<span id="post_view_count">4</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18704234" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18704234);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18704234', targetLink: 'https://www.cnblogs.com/qubernet/p/18704234', title: '.Net9ä¸­é€šè¿‡HttpClientç®€å•è°ƒç”¨Ollamaä¸­çš„DeepSeek R1æ¨¡å‹' })">ä¸¾æŠ¥</a>
</div>
        