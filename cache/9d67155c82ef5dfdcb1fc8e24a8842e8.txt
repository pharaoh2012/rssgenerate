<!----> <meta itemprop="headline" content="ğŸ”¥ğŸ”¥ä»€ä¹ˆï¼ŸLocalStorage ä¹Ÿèƒ½è¢«ç›‘å¬ï¼Ÿä¸ºä»€ä¹ˆæˆ‘è¯•äº†å´ä¸è¡Œï¼Ÿ"> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,é¢è¯•"> <meta itemprop="datePublished" content="2024-09-25T05:47:38.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sailing"> <meta itemprop="url" content="https://juejin.cn/user/307518988100237"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-7cdd11fb="">
            ğŸ”¥ğŸ”¥ä»€ä¹ˆï¼ŸLocalStorage ä¹Ÿèƒ½è¢«ç›‘å¬ï¼Ÿä¸ºä»€ä¹ˆæˆ‘è¯•äº†å´ä¸è¡Œï¼Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-7cdd11fb=""><div class="author-info-box" data-v-7cdd11fb=""><div class="author-name" data-v-7cdd11fb=""><a href="/user/307518988100237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-1800aadb="" data-v-7cdd11fb=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-1800aadb="">
    Sailing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-7cdd11fb=""><time datetime="2024-09-25T05:47:38.000Z" title="Wed Sep 25 2024 05:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-7cdd11fb="">
                    2024-09-25
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-7cdd11fb=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-7cdd11fb=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-7cdd11fb=""></circle></svg> <span class="views-count" data-v-7cdd11fb="">
                    8,663
                  </span> <span class="read-time" data-v-7cdd11fb=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-7cdd11fb=""><rect width="16" height="16" fill="none" data-v-7cdd11fb=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-7cdd11fb=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-7cdd11fb=""></path></svg>
                    é˜…è¯»8åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-7cdd11fb=""></div> <!----> <!----></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-7cdd11fb=""><div class="article-viewer markdown-body result"><blockquote>
<p>å¼•è¨€ï¼šæœ€è¿‘ï¼Œå›¢é˜Ÿçš„ä¼™ä¼´éœ€è¦å®ç°ç›‘å¬ <code>localStorage</code> æ•°æ®å˜åŒ–ï¼Œä½†å¼€å‘ä¸­å´å‘ç°æ— æ³•ç›´æ¥ç›‘å¬ã€‚</p>
</blockquote>
<p>åœ¨å›¢é˜Ÿçš„ä¸€ä¸ªç¹é‡é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªæ–°åŠŸèƒ½çš„å®ç°æˆæœ¬å¾ˆå¤§ï¼Œå› æ­¤å¼€å§‹æ€è€ƒï¼š<strong>èƒ½å¦é€šè¿‡å®æ—¶ç›‘å¬ LocalStorage çš„å˜åŒ–å¹¶è‡ªåŠ¨è§¦å‘ç›¸å…³æ“ä½œ</strong>ã€‚æˆ‘ä»¬å°è¯•ä½¿ç”¨ <code>addEventListener</code> æ¥ç›‘å¬ <code>localStorage</code> çš„å˜åŒ–ï¼Œä½†ä»¤äººæ„å¤–çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä»…åœ¨<strong>ä¸åŒæµè§ˆå™¨æ ‡ç­¾é¡µä¹‹é—´</strong>æœ‰æ•ˆï¼Œè€Œåœ¨<strong>åŒä¸€æ ‡ç­¾é¡µå†…</strong>å´æ— æ³•å®ç°ç›‘å¬ã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>
<div align="center">
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3a62547cf0942b085c7e6148f1e1e06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735183721&amp;x-signature=hyivBvRrXIVVm3IZaCkz9lLIJi4%3D" width="80%" loading="lazy">
</div>
<p>ç»è¿‡è°ƒç ”äº†è§£åˆ°ï¼Œæµè§ˆå™¨ç¡®å®æä¾›äº† <code>storage</code> äº‹ä»¶æœºåˆ¶ï¼Œä½†å®ƒä»…é€‚ç”¨äºåŒæºçš„ä¸åŒæ ‡ç­¾é¡µä¹‹é—´ã€‚å¯¹äº<strong>åŒä¸€æ ‡ç­¾é¡µå†…çš„ LocalStorage å˜åŒ–</strong>ï¼Œå´æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥å®ç°å®æ—¶ç›‘å¬ã€‚æœ€åˆï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ <code>setInterval</code> è¿›è¡Œå®šæ—¶è½®è¯¢æ¥è·å–å˜åŒ–ï¼Œä½†è¿™ç§æ–¹å¼è¦ä¹ˆå¯¼è‡´æ€§èƒ½å¼€é”€è¿‡å¤§ï¼Œè¦ä¹ˆæ— æ³•ç¬¬ä¸€æ—¶é—´æ•æ‰åˆ°å˜åŒ–ã€‚</p>
<p>ä»Šå¤©ï¼Œæˆ‘ä»¬æ¢è®¨ä¸‹å‡ ç§<strong>é«˜æ•ˆä¸”å®ç”¨</strong>çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯å¦å¯ä»¥å¸®åŠ©è½»æ¾åº”å¯¹<code>LocalStorage</code>è¿™ç§ç›‘å¬éœ€æ±‚ï¼Ÿå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæœ‰æ‰€å€Ÿé‰´ï¼</p>
<h3 data-id="heading-0">ä¼ ç»Ÿæ–¹æ¡ˆçš„ç—›ç‚¹ğŸ¯ğŸ¯</h3>
<p>å…ˆæ¥çœ‹çœ‹æµè§ˆå™¨æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å¤„ç†<strong>ä¸åŒé¡µç­¾</strong>çš„ LocalStorage å˜åŒ–ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"storage"</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {      
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">"myKey"</span>) {
    <span class="hljs-comment">// æ‰§è¡Œç›¸åº”æ“ä½œ</span>
  }
});
</code></pre>
<p>é€šè¿‡ç›‘å¬ <code>storage</code> äº‹ä»¶ï¼Œå½“åœ¨å…¶ä»–é¡µç­¾ä¿®æ”¹ LocalStorage æ—¶ï¼Œä½ å¯ä»¥åœ¨å½“å‰é¡µç­¾æ•è·åˆ°è¿™ä¸ªå˜åŒ–ã€‚ä½†é—®é¢˜æ˜¯ï¼š<strong>è¿™ç§æ–¹æ³•åªé€‚ç”¨äºè·¨é¡µç­¾çš„ LocalStorage ä¿®æ”¹ï¼Œåœ¨åŒä¸€é¡µç­¾ä¸‹æ— æ³•è§¦å‘è¯¥äº‹ä»¶</strong>ã€‚äºæ˜¯ï¼Œå¾ˆå¤šå¼€å‘è€…å¼€å§‹å¯»æ±‚æ›¿ä»£æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š</p>
<h4 data-id="heading-1">1ã€<strong>è½®è¯¢ï¼ˆPollingï¼‰</strong></h4>
<p>è½®è¯¢æ˜¯ä¸€ç§æœ€ç›´è§‚çš„æ–¹å¼ï¼Œå®ƒå®šæœŸæ£€æŸ¥ <code>localStorage</code> çš„å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•æ€§èƒ½è¾ƒå·®ï¼Œå°¤å…¶åœ¨é«˜é¢‘è½®è¯¢æ—¶ä¼šå¯¹æµè§ˆå™¨æ€§èƒ½äº§ç”Ÿè¾ƒå¤§çš„å½±å“ï¼Œå› æ­¤ä¸é€‚åˆä½œä¸ºé•¿æœŸæ–¹æ¡ˆã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> lastValue = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'myKey'</span>);

<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> newValue = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'myKey'</span>);
  <span class="hljs-keyword">if</span> (newValue !== lastValue) {
    lastValue = newValue;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, newValue);
  }
}, <span class="hljs-number">1000</span>); <span class="hljs-comment">// æ¯ç§’æ£€æŸ¥ä¸€æ¬¡</span>
</code></pre>
<p>è¿™ç§æ–¹å¼å®ç°ç®€å•ï¼Œä¸ä¾èµ–å¤æ‚æœºåˆ¶ã€‚ä½†æ˜¯æ€§èƒ½è¾ƒå·®ï¼Œé¢‘ç¹è½®è¯¢ä¼šå½±å“æµè§ˆå™¨æ€§èƒ½ã€‚</p>
<h4 data-id="heading-2">2ã€<strong>ç›‘å¬ä»£ç†ï¼ˆProxyï¼‰æˆ–å‘å¸ƒ-è®¢é˜…æ¨¡å¼</strong></h4>
<p>è¿™ç§æ–¹å¼é€šè¿‡åˆ›å»ºä¸€ä¸ªä»£ç†æ¥æ‹¦æˆª <code>localStorage.setItem</code> çš„è°ƒç”¨ã€‚æ¯æ¬¡æ•°æ®å˜æ›´æ—¶ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç›‘å¬è€…ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> originalSetItem = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-property">setItem</span>;
  <span class="hljs-keyword">const</span> subscribers = [];

  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-property">setItem</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">key, value</span>) {
    originalSetItem.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    subscribers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(key, value));
  };

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">callback</span>) {
    subscribers.<span class="hljs-title function_">push</span>(callback);
  }

  <span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">key, value</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'myKey'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, value);
    }
  });

  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'myKey'</span>, <span class="hljs-string">'newValue'</span>);
})();
</code></pre>
<p>è¿™ç§æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥ç”¨äºå¤æ‚åœºæ™¯ã€‚ä½†æ˜¯éœ€è¦æ‰‹åŠ¨æ‹¦æˆª <code>setItem</code>ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼ˆä½†ä¹Ÿæ˜¯å€¼å¾—æ¨èçš„ï¼‰ã€‚</p>
<div align="center">
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bd3ab3acaff433fb0b40d499281dac0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735183721&amp;x-signature=5qwk1h%2FP8kXH81sh8gwiN5Yixac%3D" width="80%" loading="lazy">
</div>
<p>ç„¶è€Œï¼Œè¿™äº›æ–¹æ¡ˆå¾€å¾€å­˜åœ¨æ€§èƒ½é—®é¢˜æˆ–è€…å¼€å‘çš„å¤æ‚åº¦ï¼Œåœ¨é«˜é¢‘æ•°æ®æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½é—®é¢˜ï¼Œè€Œä¸”å­˜åœ¨ä¸€å®šçš„é£é™©æ€§ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å¯ä»¥ç®€å•å¿«é€Ÿï¼Œé£é™©æ€§è¿˜å°çš„æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<h3 data-id="heading-3">é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆ ğŸš€ğŸš€</h3>
<p>æ—¢ç„¶æµè§ˆå™¨ä¸æ”¯æŒåŒä¸€é¡µç­¾çš„ <code>storage</code> äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥<strong>æ‰‹åŠ¨è§¦å‘äº‹ä»¶</strong>ï¼Œä»¥æ­¤æ¥å®ç°åŒä¸€é¡µç­¾ä¸‹çš„ LocalStorage å˜åŒ–ç›‘å¬ã€‚</p>
<h4 data-id="heading-4">1ã€è‡ªå®šä¹‰ Storage äº‹ä»¶</h4>
<p>é€šè¿‡æ‰‹åŠ¨è§¦å‘ <code>StorageEvent</code>ï¼Œä½ å¯ä»¥åœ¨ LocalStorage æ›´æ–°æ—¶åŒæ­¥åˆ†å‘äº‹ä»¶ï¼Œä»è€Œå®ç°åŒä¸€é¡µç­¾ä¸‹çš„ç›‘å¬ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'myKey'</span>, <span class="hljs-string">'value'</span>);

<span class="hljs-comment">// æ‰‹åŠ¨åˆ›å»ºå¹¶åˆ†å‘ StorageEvent</span>
<span class="hljs-keyword">const</span> storageEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageEvent</span>(<span class="hljs-string">'storage'</span>, {
  <span class="hljs-attr">key</span>: <span class="hljs-string">'myKey'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
});
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(storageEvent);
</code></pre>
<p>ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç›‘å¬é€»è¾‘æ¥å¤„ç†æ•°æ®å˜åŒ–ï¼Œæ— è®ºæ˜¯åŒä¸€é¡µç­¾è¿˜æ˜¯ä¸åŒé¡µç­¾ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"storage"</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">"myKey"</span>) {
    <span class="hljs-comment">// å¤„ç† LocalStorage æ›´æ–°</span>
  }
});
</code></pre>
<p>è¿™ç§å®ç°ç®€å•ã€è½»é‡ã€å¿«æ·ã€‚ä½†æ˜¯éœ€è¦æ‰‹åŠ¨è§¦å‘äº‹ä»¶ã€‚</p>
<h4 data-id="heading-5">2ã€åŸºäº <code>CustomEvent</code> çš„è‡ªå®šä¹‰äº‹ä»¶</h4>
<p>ä¸ <code>StorageEvent</code> ç±»ä¼¼ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>CustomEvent</code> æ‰‹åŠ¨åˆ›å»ºå¹¶åˆ†å‘äº‹ä»¶ï¼Œå®ç° <code>localStorage</code> çš„åŒæ­¥ç›‘å¬ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'myKey'</span>, <span class="hljs-string">'newValue'</span>);

<span class="hljs-keyword">const</span> customEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'localStorageChange'</span>, {
  <span class="hljs-attr">detail</span>: { <span class="hljs-attr">key</span>: <span class="hljs-string">'myKey'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'newValue'</span> }
});
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(customEvent);

</code></pre>
<p>è¿™ç§æ–¹å¼é€‚åˆæ›´åŠ çµæ´»çš„äº‹ä»¶è§¦å‘åœºæ™¯ã€‚<code>CustomEvent</code>ä¸å±€é™äº <code>localStorage</code> äº‹ä»¶ï¼Œå¯ä»¥æ‰©å±•åˆ°å…¶ä»–åŠŸèƒ½ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'localStorageChange'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { key, value } = event.<span class="hljs-property">detail</span>;
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'myKey'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, value);
  }
});
</code></pre>
<h4 data-id="heading-6">3ã€MessageChannelï¼ˆæ¶ˆæ¯é€šé“ï¼‰</h4>
<p><code>MessageChannel</code> API å¯ä»¥åœ¨åŒä¸€ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>MessageChannel</code> å°† <code>localStorage</code> çš„å˜åŒ–ä¿¡æ¯åŒæ­¥åˆ°å…¶ä»–éƒ¨åˆ†ï¼Œèµ·åˆ°ç±»ä¼¼äº‹ä»¶ç›‘å¬çš„æ•ˆæœã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();

channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, event.<span class="hljs-property">data</span>);
};

<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'myKey'</span>, <span class="hljs-string">'newValue'</span>);
channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'myKey'</span>));
</code></pre>
<p>é€‚åˆç»„ä»¶é€šä¿¡å’Œå¤æ‚åº”ç”¨åœºæ™¯ï¼Œæ¶ˆæ¯æœºåˆ¶è¾ƒä¸ºçµæ´»ã€‚ç›¸å¯¹å¤æ‚çš„å®ç°ï¼Œå¯èƒ½ä¸é€‚åˆç®€å•åœºæ™¯ã€‚</p>
<h4 data-id="heading-7">4ã€BroadcastChannel</h4>
<p><code>BroadcastChannel</code> æä¾›äº†ä¸€ç§æ›´é«˜çº§çš„æµè§ˆå™¨é€šä¿¡æœºåˆ¶ï¼Œå…è®¸å¤šä¸ªçª—å£æˆ–é¡µé¢ä¹‹é—´å¹¿æ’­æ¶ˆæ¯ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªæœºåˆ¶å°† <code>localStorage</code> å˜æ›´åŒæ­¥åˆ°å¤šä¸ªé¡µé¢æˆ–åŒä¸€é¡µé¢çš„ä¸åŒéƒ¨åˆ†ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'storage_channel'</span>);

channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, event.<span class="hljs-property">data</span>);
};

<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'myKey'</span>, <span class="hljs-string">'newValue'</span>);
channel.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">key</span>: <span class="hljs-string">'myKey'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'newValue'</span> });
</code></pre>
<p>æ”¯æŒè·¨é¡µé¢é€šä¿¡ï¼Œæ–¹ä¾¿åœ¨ä¸åŒé¡µé¢é—´åŒæ­¥æ•°æ®ï¼Œæ˜“äºå®ç°ã€‚é€‚ç”¨åœºæ™¯è¾ƒä¸ºå…·ä½“ï¼Œé€šå¸¸ç”¨äºå¤æ‚çš„é¡µé¢é€šä¿¡éœ€æ±‚ã€‚</p>
<p>è¿™4ä¸ªæ–¹æ³•ï¼Œä¸»æ‰“çš„å°±æ˜¯ä¸€ä¸ªè§ç¼æ’é’ˆï¼Œç®€å•å¿«é€Ÿï¼Œé£é™©æ€§ä½ã€‚ä½†æ˜¯å®¢è§‚è§’åº¦æ¥è®²ï¼Œæ¯ç§æ–¹æ¡ˆéƒ½æ˜¯æœ‰å„è‡ªä¼˜åŠ¿çš„ã€‚</p>
<h3 data-id="heading-8">ä¼˜åŠ¿å¯¹æ¯”</h3>















































<table><thead><tr><th>æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>è½®è¯¢</td><td>å®ç°ç®€å•ï¼Œé€‚åˆä½é¢‘ç›‘æ§éœ€æ±‚</td><td>æ€§èƒ½å·®ï¼Œé¢‘ç¹è½®è¯¢å½±å“æµè§ˆå™¨æ€§èƒ½</td><td>ç®€å•åœºæ™¯æˆ–ä¸´æ—¶æ–¹æ¡ˆ</td></tr><tr><td>ç›‘å¬ä»£ç†/å‘å¸ƒ-è®¢é˜…æ¨¡å¼</td><td>çµæ´»æ‰©å±•ï¼Œé€‚åˆå¤æ‚é¡¹ç›®</td><td>éœ€è¦æ‰‹åŠ¨æ‹¦æˆª <code>setItem</code>ï¼Œç»´æŠ¤æˆæœ¬é«˜</td><td>éœ€è¦æ‰‹åŠ¨äº‹ä»¶å‘å¸ƒçš„åœºæ™¯</td></tr><tr><td>è‡ªå®šä¹‰ <code>StorageEvent</code></td><td>å®ç°ç®€å•ï¼ŒåŸç”Ÿæ”¯æŒ <code>storage</code> äº‹ä»¶ç›‘å¬</td><td>éœ€è¦æ‰‹åŠ¨è§¦å‘äº‹ä»¶</td><td>åŒé¡µç­¾ä¸‹ <code>localStorage</code> ç›‘å¬</td></tr><tr><td>è‡ªå®šä¹‰äº‹ä»¶</td><td>çµæ´»çš„äº‹ä»¶ç®¡ç†ï¼Œé€‚åˆä¸åŒåœºæ™¯</td><td>éœ€è¦æ‰‹åŠ¨è§¦å‘äº‹ä»¶</td><td>éœ€è¦è‡ªå®šä¹‰è§¦å‘æ¡ä»¶çš„åœºæ™¯</td></tr><tr><td><code>MessageChannel</code></td><td>é€‚åˆç»„ä»¶é€šä¿¡å’Œå¤æ‚åº”ç”¨åœºæ™¯</td><td>å®ç°å¤æ‚ï¼Œä¸é€‚åˆç®€å•åœºæ™¯</td><td>é«˜çº§ç»„ä»¶é€šä¿¡éœ€æ±‚</td></tr><tr><td><code>BroadcastChannel</code></td><td>è·¨é¡µé¢é€šä¿¡ï¼Œé€‚åˆå¤æ‚é€šä¿¡éœ€æ±‚</td><td>ä½¿ç”¨åœºæ™¯è¾ƒå…·ä½“</td><td>å¤æ‚çš„å¤šçª—å£é€šä¿¡</td></tr></tbody></table>
<h3 data-id="heading-9">å¦‚ä½•åœ¨ React / Vue ä½¿ç”¨</h3>
<p>åœ¨ä¸»æµå‰ç«¯æ¡†æ¶ï¼ˆå¦‚ React å’Œ Vueï¼‰ä¸­ï¼Œç›‘å¬ LocalStorage å˜åŒ–å¹¶ä¸å›°éš¾ã€‚æ— è®ºæ˜¯ React è¿˜æ˜¯ Vueï¼Œä½ éƒ½å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ <code>StorageEvent</code> æˆ–å…¶ä»–æ–¹æ³•æ¥å®ç°ç›‘å¬ã€‚åœ¨æ­¤ï¼Œæˆ‘ä»¬ä»¥<strong>è‡ªå®šä¹‰ <code>StorageEvent</code></strong> ä¸ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ React å’Œ Vue ä¸­å®ç° LocalStorage çš„ç›‘å¬ã€‚</p>
<div align="center">
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6905f4242f91472595aeeb41e8b89872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735183721&amp;x-signature=9mo4jxtRbFb1wQrgSsl%2B%2BrzOHII%3D" width="80%" loading="lazy">
</div>
<h4 data-id="heading-10">1. åœ¨ React ä¸­ä½¿ç”¨è‡ªå®šä¹‰ <code>StorageEvent</code></h4>
<p>React æ˜¯ä¸€ä¸ªåŸºäºç»„ä»¶çš„æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆå¦‚ <code>useEffect</code>ï¼‰æ¥ç›‘å¬å’Œå¤„ç† LocalStorage çš„å˜åŒ–ã€‚</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">LocalStorageListener</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// å®šä¹‰ storage äº‹ä»¶ç›‘å¬å™¨</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStorageChange</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">'myKey'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Detected localStorage change:'</span>, event.<span class="hljs-property">newValue</span>);
      }
    };

    <span class="hljs-comment">// æ·»åŠ ç›‘å¬å™¨</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);

    <span class="hljs-comment">// æ¨¡æ‹Ÿè§¦å‘è‡ªå®šä¹‰çš„ StorageEvent</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">triggerCustomStorageEvent</span> = (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-keyword">const</span> storageEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageEvent</span>(<span class="hljs-string">'storage'</span>, {
        <span class="hljs-attr">key</span>: <span class="hljs-string">'myKey'</span>,
        <span class="hljs-attr">newValue</span>: <span class="hljs-string">'newValue'</span>,
        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      });
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(storageEvent);
    };

    <span class="hljs-comment">// ç»„ä»¶å¸è½½æ—¶ç§»é™¤ç›‘å¬å™¨</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);
    };
  }, []); <span class="hljs-comment">// ç©ºä¾èµ–æ•°ç»„è¡¨ç¤ºè¯¥ effect åªä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿è¡Œ</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> localStorage.setItem('myKey', 'newValue')}&gt;
        ä¿®æ”¹ localStorage
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> window.dispatchEvent(new StorageEvent('storage', {
        key: 'myKey',
        newValue: localStorage.getItem('myKey'),
        url: window.location.href,
      }))}&gt;
        æ‰‹åŠ¨è§¦å‘ StorageEvent
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">LocalStorageListener</span>;
</code></pre>
<ul>
<li><code>useEffect</code> æ˜¯ React çš„ä¸€ä¸ª Hookï¼Œç”¨æ¥å¤„ç†å‰¯ä½œç”¨ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç”¨å®ƒæ¥æ³¨å†Œå’Œæ¸…é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚</li>
<li>æˆ‘ä»¬æ‰‹åŠ¨è§¦å‘äº† <code>StorageEvent</code>ï¼Œä»¥ä¾¿åœ¨åŒä¸€é¡µé¢ä¸­ç›‘å¬ LocalStorage çš„å˜åŒ–ã€‚</li>
</ul>
<h4 data-id="heading-11">2. åœ¨ Vue ä¸­ä½¿ç”¨è‡ªå®šä¹‰ <code>StorageEvent</code></h4>
<p>åœ¨ Vue 3 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>onMounted</code> å’Œ <code>onUnmounted</code> è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­æ¥ç®¡ç†äº‹ä»¶ç›‘å¬å™¨ã€‚ï¼ˆVue 3 Composition APIï¼‰ï¼š</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;button @click="updateLocalStorage"&gt;ä¿®æ”¹ localStorage&lt;/button&gt;
    &lt;button @click="triggerCustomStorageEvent"&gt;æ‰‹åŠ¨è§¦å‘ StorageEvent&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import { onMounted, onUnmounted } from 'vue';

const handleStorageChange = (event: StorageEvent) =&gt; {
  if (event.key === 'myKey') {
    console.log('Detected localStorage change:', event.newValue);
  }
};

const updateLocalStorage = () =&gt; {
  localStorage.setItem('myKey', 'newValue');
};

const triggerCustomStorageEvent = () =&gt; {
  const storageEvent = new StorageEvent('storage', {
    key: 'myKey',
    newValue: 'newValue',
    url: window.location.href,
  });
  window.dispatchEvent(storageEvent);
};

onMounted(() =&gt; {
  window.addEventListener('storage', handleStorageChange);
});

onUnmounted(() =&gt; {
  window.removeEventListener('storage', handleStorageChange);
});
&lt;/script&gt;
</code></pre>
<ul>
<li>ä½¿ç”¨äº† Vue çš„ Composition APIï¼Œå…¶ä¸­ <code>onMounted</code> å’Œ <code>onUnmounted</code> ç±»ä¼¼äº React çš„ <code>useEffect</code>ï¼Œç”¨äºåœ¨ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶ç®¡ç†å‰¯ä½œç”¨ã€‚</li>
<li>åŒæ ·æ‰‹åŠ¨è§¦å‘äº† <code>StorageEvent</code> æ¥ç›‘å¬åŒä¸€é¡µé¢ä¸­çš„ LocalStorage å˜åŒ–ã€‚</li>
</ul>
<h3 data-id="heading-12">æç‚¼å°è£…ä¸€ä¸‹ ğŸš€ğŸš€</h3>
<p>æ— è®ºæ˜¯ React è¿˜æ˜¯ Vueï¼Œå°†è‡ªå®šä¹‰ <code>StorageEvent</code> å®ç°ä¸ºä¸€ä¸ªç»„ä»¶æˆ–å·¥å…·å‡½æ•°æ˜¯å¸¸è§çš„åšæ³•ã€‚ä½ å¯ä»¥å°†ä¸Šé¢çš„é€»è¾‘æå–åˆ°ä¸€ä¸ªç‹¬ç«‹çš„ hook æˆ–å·¥å…·å‡½æ•°ä¸­ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®ä¸­å¤šæ¬¡ä½¿ç”¨ã€‚</p>
<h4 data-id="heading-13">åœ¨ React ä¸­æå–ä¸º Hook</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocalStorageListener</span> = (<span class="hljs-params">key, callback</span>) =&gt; {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStorageChange</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === key) {
        <span class="hljs-title function_">callback</span>(event.<span class="hljs-property">newValue</span>);
      }
    };

    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);
    };
  }, [key, callback]);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useLocalStorageListener;
</code></pre>
<h4 data-id="heading-14">åœ¨ Vue ä¸­æå–ä¸ºå·¥å…·å‡½æ•°</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocalStorageListener</span> = (<span class="hljs-params">key: <span class="hljs-built_in">string</span>, callback: (value: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>) =&gt; <span class="hljs-built_in">void</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStorageChange</span> = (<span class="hljs-params">event: StorageEvent</span>) =&gt; {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === key) {
      <span class="hljs-title function_">callback</span>(event.<span class="hljs-property">newValue</span>);
    }
  };

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);
  });

  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorageChange);
  });
};
</code></pre>
<ul>
<li>åœ¨ React ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ Hook <code>useLocalStorageListener</code>ï¼Œé€šè¿‡ä¼ å…¥ç›‘å¬çš„ key å’Œå›è°ƒå‡½æ•°æ¥æ•è· LocalStorage çš„å˜åŒ–ã€‚</li>
<li>åœ¨ Vue ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå·¥å…·å‡½æ•° <code>useLocalStorageListener</code>ï¼ŒåŒæ ·é€šè¿‡ä¼ å…¥ key å’Œå›è°ƒå‡½æ•°æ¥ç›‘å¬å˜åŒ–ã€‚</li>
</ul>
<h3 data-id="heading-15">æ€»ç»“</h3>
<div align="center">
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1f01ca364ac48cbbc84aa53b7b9ab23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735183721&amp;x-signature=cvTUHzadfckMWeeM%2BD%2BYQBXG79Q%3D" width="80%" loading="lazy">
</div>
<p>åœ¨åŒä¸€ä¸ªæµè§ˆå™¨é¡µç­¾ä¸­ç›‘å¬ <code>localStorage</code> çš„å˜åŒ–å¹¶ééš¾äº‹ï¼Œä½†ä¸åŒåœºæ™¯ä¸‹éœ€è¦ä¸åŒçš„æ–¹æ¡ˆã€‚ä»ç®€å•çš„è½®è¯¢åˆ°é«˜çº§çš„ <code>BroadcastChannel</code>ï¼Œæœ¬æ–‡ä»‹ç»çš„å‡ ç§æ–¹æ¡ˆå„æœ‰ä¼˜ç¼ºç‚¹ã€‚æ ¹æ®ä½ çš„å®é™…éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆå¯ä»¥å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°è§£å†³é—®é¢˜ã€‚</p>
<ul>
<li><strong>ç®€å•éœ€æ±‚</strong>ï¼šå¯ä»¥è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰ <code>StorageEvent</code> æˆ– <code>CustomEvent</code> å®ç°ç›‘å¬ã€‚</li>
<li><strong>å¤æ‚éœ€æ±‚</strong>ï¼šå¯¹äºæ›´é«˜çº§çš„åœºæ™¯ï¼Œå¦‚è·¨é¡µé¢é€šä¿¡ï¼Œ<code>MessageChannel</code> æˆ– <code>BroadcastChannel</code> æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</li>
</ul>
<p>å¦‚æœä½ æœ‰å…¶ä»–çš„ä¼˜åŒ–æŠ€å·§æˆ–é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ï¼Œè®©æˆ‘ä»¬ä¸€èµ·äº¤æµæ›´å¤šçš„è§£å†³æ–¹æ¡ˆï¼</p></div></div>