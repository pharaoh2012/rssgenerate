
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/east4ming/p/18787004" title="发布于 2025-03-22 19:53">
    <span role="heading" aria-level="2">如何设置家用威联通 NAS UPS 断电后自动关机并通知其他设备?</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="场景">场景</h2>
<blockquote>
<p>📝<strong>备注:</strong></p>
<p>求轻喷, 求放过. 😅</p>
<p>我真的是个理线方面的白痴. 这已经是我的极限了. 😂</p>
</blockquote>
<p>我的家庭实验室 Homelab 服务器集群配置如下.</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195339330-1707516301.jpg" alt="HomeLab 上半部分" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195341051-2141328849.png" alt="HomeLab 下半部分" loading="lazy"></p>
<p>上半部分之前已经介绍过了, 这里就不再赘述了. 今天重点介绍介绍 UPS 和 NAS 部分.</p>
<ul>
<li>
<p>1台 UPS, 型号为 APC Back-UPS 650. 插座插着: NAS 和 插线板(插线板上连了4个 N100小主机和其他; 通过数据端口和 NAS 连接). 如下图: (求轻喷, 求放过. 😅)</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195343225-2060825669.png" alt="UPS" loading="lazy"></p>
</li>
<li>
<p>1 台威联通 QNAP TS-453Bmini NAS. 如下图: (求轻喷, 求放过. 😅)</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195345088-1098824203.png" alt="QNAP NAS" loading="lazy"></p>
</li>
</ul>
<p>现在的需求是:</p>
<ol>
<li>UPS 断电后一段时间(如 5min 后), NAS 自动断电;</li>
<li>NAS 作为 UPS Server 运行, UPS 断电后, 通知其他 4 台 N100 小主机</li>
<li>4 台 N100 小主机收到通知后, 也过一段时间(如 5min 后)自动断电.</li>
</ol>
<p>具体实现概述如下:</p>
<ol>
<li>物理层面: UPS 通过数据线连接到 NAS USB</li>
<li>软件层面:
<ol>
<li>NAS: 通过 UI 配置断电后操作;</li>
<li>NAS: 通过 UI 启用 UPS Server 配置;</li>
<li>N100 小主机: UPS Client 配置.</li>
</ol>
</li>
</ol>
<p>细节步骤如下:</p>
<h2 id="实战">实战</h2>
<h3 id="1-物理层面-ups-通过数据线连接到-nas-usb">1. 物理层面: UPS 通过数据线连接到 NAS USB</h3>
<p>这里我就不放图了, 因为就在上面那一堆线里面... 这个机柜在墙角, 我左跪右跪看了一圈也没找到能拍清楚的角度... 😅</p>
<p>APC UPS 自带一根数据线, 具体操作如下:</p>
<p>使用 USB 缆线将 Back-UPS 连接到 NAS。将一端插到 Back-UPS 后面板上的 POWERCHUTE 端口，另一端插到计算机上的 USB 端口。</p>
<p>就是下图的 ⑥:</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195346661-305653775.png" alt="APC 示意图" loading="lazy"></p>
<p>完成.</p>
<h4 id="验证">验证</h4>
<p>完成后, 我们可以访问 威联通 QNAP QTS 界面, 会看到 UPS 的相关信息, 具体如下:</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195346898-240455108.png" alt="QTS 外部设备" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195347179-698384402.png" alt="QTS UPS 信息" loading="lazy"></p>
<p>接下来进入软件层面操作.</p>
<h3 id="2-nas-通过-ui-配置断电后的操作">2. NAS: 通过 UI 配置断电后的操作</h3>
<p>具体如下:</p>
<p><img src="https://img2024.cnblogs.com/other/3034537/202503/3034537-20250322195347408-830357082.png" alt="QNAP QTS UPS 设置界面" loading="lazy"></p>
<ol>
<li>进入 威联通 QNAP QTS 界面;</li>
<li>访问 控制台 -&gt; 系统 -&gt; 外界设备 -&gt; UPS</li>
<li>选择 USB 连接 -&gt; 当电源失效时, 10 分钟后进入自动保护模式. (当然, 你可以选择另一选项, 即: 关闭 NAS)</li>
</ol>
<p>如果你只需要 UPS 和 NAS 联动, 那么到这里就配置完成了.</p>
<h3 id="3-nas-通过-ui-启用-ups-server-配置">3. NAS: 通过 UI 启用 UPS Server 配置</h3>
<p>如果你还需要和其他主机/服务器联动, 那么需要通过 UI 启用 UPS Server 配置, 具体如上图 ⑥:</p>
<ol>
<li>启用 网络不间断电源服务器(即 UPS Server)</li>
<li>并添加 4 台 N100 小主机的 IP 地址. 如: 192.168.3.154</li>
</ol>
<p>完成.</p>
<h4 id="额外说明">额外说明</h4>
<p>威联通 QNAP QTS 在后台, 实际上运行的是: <code>upsd</code> 服务, 监听了 <code>3493</code> 端口. 如下:</p>
<pre><code class="language-bash">[admin@NAS33657A ups]# netstat -tuln | grep 3493
tcp        0      0 0.0.0.0:3493            0.0.0.0:*               LISTEN      
[admin@NAS33657A ups]# ps -ef|grep ups
 6960 admin       996 S   grep ups
14369 admin      1764 R   /usr/local/ups/bin/usbhid-ups -a qnapups -u admin
15999 admin      1536 S   /usr/sbin/upsd -u admin
23676 admin      8548 S   /usr/sbin/upsutil
</code></pre>
<p>这里我们需要知道的是:</p>
<ol>
<li>QNAP UPS Server  的 名称是:<code>qnapups</code></li>
</ol>
<p>威联通 QNAP QTS 的 UPS 配置, 具体位于 <code>/etc/config/ups/</code> 目录下, 如下:</p>
<pre><code class="language-bash">[admin@NAS33657A ups]# ls
ups.conf  upsd.conf  upsdrv.map  upsd.users  upsmon.conf

[admin@NAS33657A ups]# cat upsd.users
[admin]
                password = 123456
                allowfrom = localhost
		        actions = SET
		        instcmds = ALL
                upsmon master           # or upsmon slave
</code></pre>
<p>这里我们需要知道的是:</p>
<ol>
<li>QNAP UPS Server 的用户是:<code>admin</code></li>
<li>密码是: <code>123456</code></li>
</ol>
<p>总结一下, <strong>威联通 QNAP QTS Server 信息</strong>:</p>
<ol>
<li>实际上运行的是: <code>upsd</code> 服务</li>
<li>监听了 <code>3493</code> 端口</li>
<li>UPS Server  的 名称是:<code>qnapups</code> (🐾 <strong>注意</strong>: 在威联通所有 NAS 上, 这个名字都是固定的)</li>
<li>用户是:<code>admin</code></li>
<li>密码是: <code>123456</code></li>
</ol>
<p><strong>后面 N100 配置 UPS Client 需要用到这些信息</strong>.</p>
<h3 id="4-n100-小主机-ups-client-配置">4. N100 小主机: UPS Client 配置</h3>
<p>我的 N100 小主机是 Ubuntu 24.04, 要在 Linux 系统上实现与 UPS（不间断电源）服务器的交互，并在断电 5 分钟后自动关机，通常需要使用 UPS 监控软件。常见的工具是 <code>NUT</code>（Network UPS Tools），它是一个开源的 UPS 监控和管理工具。</p>
<p>既然已经在 NAS 上运行了 <code>upsd</code>，并且 UPS 是 APC Back-UPS 650 通过 USB 连接到 NAS，那么在小主机上，可以通过配置 NUT 客户端（<code>upsmon</code>）来与 NAS 上的 <code>upsd</code> 交互，并实现断电 5 分钟后关机。</p>
<p>以下是详细的步骤：</p>
<h4 id="41-在-linux-设备上安装-nut-客户端">4.1. 在 Linux 设备上安装 NUT 客户端</h4>
<p>在需要监控 UPS 的 Linux 设备上，安装 NUT 客户端工具：</p>
<ul>
<li>
<p>对于基于 Debian/Ubuntu 的系统：</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install nut-client
</code></pre>
</li>
<li>
<p>如果你是基于 Red Hat/CentOS 的系统：</p>
<pre><code class="language-bash">sudo yum install nut-client
</code></pre>
</li>
</ul>
<h4 id="42-配置-nut-客户端">4.2. 配置 NUT 客户端</h4>
<p>在 Linux 设备上，编辑 NUT 客户端的配置文件 <code>/etc/nut/upsmon.conf</code>，添加以下内容：</p>
<pre><code class="language-bash">MONITOR qnapups@nas_ip 1 admin 123456 slave
</code></pre>
<ul>
<li><code>qnapups</code>：这是 QNAP NAS 上 UPS 的名称(🐾 注意: 在威联通所有 NAS 上, 这个名字都是固定的)。</li>
<li><code>nas_ip</code>：NAS 的 IP 地址。</li>
<li><code>admin</code>：NAS 上定义的用户名。</li>
<li><code>123456</code>：NAS 上定义的密码。</li>
<li><code>slave</code>：表示这台设备是客户端，不是主控设备。</li>
</ul>
<h4 id="43-设置断电后关机">4.3. 设置断电后关机</h4>
<p>在 <code>/etc/nut/upsmon.conf</code> 中，添加以下行以设置断电 5 分钟后关机：</p>
<pre><code class="language-bash">SHUTDOWNCMD "/sbin/shutdown -h +5"
</code></pre>
<h4 id="44-设置-nut-运行模式">4.4. 设置 NUT 运行模式</h4>
<p>在 <code>/etc/nut/nut.conf</code> 中, 有 4 种运行模式, 分别为:</p>
<ol>
<li><code>none</code>: NUT 没有配置，或者使用集成电源管理，或者使用一些外部系统来启动 NUT 组件. 因此，不需要由 NUT 软件包捆绑的脚本或服务启动任何内容。</li>
<li><code>standalone</code>: 这种模式只针对本地配置，由 1 个 UPS 保护本地系统。这意味着要启动 3 个 NUT 层（驱动程序、<code>upsd</code>和 <code>upsmon</code>）及相应的配置文件。这种模式还可以处理 UPS 冗余。</li>
<li><code>netserver</code>: 与独立配置相同，但还需要一些额外的网络访问控制（防火墙、tcp包装器）以及在 <code>upsd.conf </code>中可能需要一个特定的 LISTEN 指令。由于此模式对网络开放，因此应特别关注安全问题。 -- 很明显, NAS UPS Server 是这种模式.</li>
<li><code>netclient</code>: 这种模式只要求upsmon（以及它可能使用的工具，如<code>upssched</code>或自定义脚本）来监视远程NUT服务器，并可能关闭此系统（在这种情况下，<code>upsmon</code>的一部分必须以<code>root</code>身份运行）。-- 很明显, 我们需要设置 Linux 设备为此模式.</li>
</ol>
<p>调整 mode 配置为:</p>
<pre><code class="language-ini">MODE=netclient
</code></pre>
<h4 id="44-启动-nut-客户端服务">4.4. 启动 NUT 客户端服务</h4>
<p>启动 <code>upsmon</code> 服务并设置为开机自启：</p>
<ul>
<li>
<p>对于基于 systemd 的系统：</p>
<pre><code class="language-bash">sudo systemctl start nut-client
sudo systemctl enable nut-client
</code></pre>
</li>
<li>
<p>对于基于 SysVinit 的系统：</p>
<pre><code class="language-bash">sudo service nut-client start
sudo update-rc.d nut-client defaults
</code></pre>
</li>
</ul>
<p>查看启动状态:</p>
<h5 id="441-报错修复">4.4.1 报错修复</h5>
<p>这里第一次启动后报了1个错误, 具体如下:</p>
<ol>
<li><code>Failed to open '/usr/lib/tmpfiles.d/nut-common-tmpfiles.conf': No such file or directory</code></li>
</ol>
<pre><code class="language-bash">❯ sudo systemctl status nut-client.service
○ nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller
     Loaded: loaded (/usr/lib/systemd/system/nut-monitor.service; enabled; preset: enabled)
     Active: inactive (dead) since Sat 2025-03-22 17:12:20 CST; 8s ago
   Duration: 5ms
    Process: 347996 ExecStartPre=/usr/bin/systemd-tmpfiles --create /usr/lib/tmpfiles.d/nut-common-tmpfiles.conf (code=exited, status=1/FAILURE)
    Process: 347998 ExecStart=/sbin/upsmon -F (code=exited, status=0/SUCCESS)
   Main PID: 347998 (code=exited, status=0/SUCCESS)
        CPU: 15ms

Mar 22 17:12:20 n100-jumper-2 systemd[1]: Starting nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller...
Mar 22 17:12:20 n100-jumper-2 systemd-tmpfiles[347996]: Failed to open '/usr/lib/tmpfiles.d/nut-common-tmpfiles.conf': No such file or directory
Mar 22 17:12:20 n100-jumper-2 systemd[1]: Started nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller.
Mar 22 17:12:20 n100-jumper-2 nut-monitor[347998]: upsmon disabled, please adjust the configuration to your needs
Mar 22 17:12:20 n100-jumper-2 nut-monitor[347998]: Then set MODE to a suitable value in /etc/nut/nut.conf to enable it
Mar 22 17:12:20 n100-jumper-2 systemd[1]: nut-monitor.service: Deactivated successfully.
</code></pre>
<p>所以执行如下命令修复:</p>
<pre><code class="language-bash">sudo touch /usr/lib/tmpfiles.d/nut-common-tmpfiles.conf
</code></pre>
<p>启动后再次运行, 没有报错:</p>
<pre><code class="language-bash">❯ sudo systemctl status nut-client.service 
● nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller
     Loaded: loaded (/usr/lib/systemd/system/nut-monitor.service; enabled; preset: enabled)
     Active: active (running) since Sat 2025-03-22 17:15:21 CST; 2s ago
    Process: 350296 ExecStartPre=/usr/bin/systemd-tmpfiles --create /usr/lib/tmpfiles.d/nut-common-tmpfiles.conf (code=exited, status=0/SUCCESS)
   Main PID: 350298 (upsmon)
      Tasks: 2 (limit: 18754)
     Memory: 3.6M (peak: 3.8M)
        CPU: 22ms
     CGroup: /system.slice/nut-monitor.service
             ├─350298 /lib/nut/upsmon -F
             └─350310 /lib/nut/upsmon -F

Mar 22 17:15:21 n100-jumper-2 systemd[1]: Starting nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller...
Mar 22 17:15:21 n100-jumper-2 systemd[1]: Started nut-monitor.service - Network UPS Tools - power device monitor and shutdown controller.
Mar 22 17:15:21 n100-jumper-2 nut-monitor[350298]: fopen /run/nut/upsmon.pid: No such file or directory
Mar 22 17:15:21 n100-jumper-2 nut-monitor[350298]: Could not find PID file to see if previous upsmon instance is already running!
Mar 22 17:15:21 n100-jumper-2 nut-monitor[350298]: Using power down flag file /etc/killpower
Mar 22 17:15:21 n100-jumper-2 nut-monitor[350298]: UPS: qnapups@192.168.3.216 (secondary) (power value 1)
Mar 22 17:15:21 n100-jumper-2 nut-monitor[350310]: Init SSL without certificate database

</code></pre>
<h4 id="45-测试配置">4.5. 测试配置</h4>
<h5 id="451-检查-ups-状态">4.5.1 检查 UPS 状态</h5>
<p>在 Linux 设备上，使用以下命令检查是否能够正确获取 UPS 状态：</p>
<pre><code class="language-bash">❯ upsc qnapups@192.168.3.216
Init SSL without certificate database
battery.charge: 100
battery.charge.low: 10
battery.charge.warning: 50
battery.date: not set
battery.mfr.date: 2019/12/10
battery.runtime: 1140
battery.runtime.low: 120
battery.type: PbAc
battery.voltage: 13.7
battery.voltage.nominal: 12.0
device.mfr: APC
device.model: Back-UPS 650
device.serial: 3B1950X62634  
device.type: ups
driver.name: usbhid-ups
driver.parameter.pollfreq: 30
driver.parameter.pollinterval: 2
driver.parameter.port: /dev/ttyS1
driver.parameter.synchronous: no
driver.version: 2.7.4
driver.version.data: APC HID 0.96
driver.version.internal: 0.41
input.sensitivity: low
input.transfer.high: 266
input.transfer.low: 165
input.transfer.reason: input voltage out of range
input.voltage: 226.0
input.voltage.nominal: 220
ups.beeper.status: enabled
ups.delay.shutdown: 20
ups.firmware: 822.A3.I
ups.firmware.aux: A3
ups.load: 38
ups.mfr: APC
ups.mfr.date: 2019/12/10
ups.model: Back-UPS 650
ups.productid: 0002
ups.serial: 3B1950X62634  
ups.status: OL
ups.timer.reboot: 0
ups.timer.shutdown: -1
ups.vendorid: 051d
</code></pre>
<p>如果配置正确，你应该能够看到 UPS 的详细信息，例如电池状态、输入电压等。</p>
<h5 id="452-模拟断电测试">4.5.2 模拟断电测试</h5>
<p>你可以通过断开 UPS 的电源来测试配置是否正确。如果一切正常，Linux 设备应该在断电 5 分钟后自动关机。</p>
<p>全部完成! 🎉🎉🎉</p>
<hr>
<h3 id="5-其他注意事项">5. 其他注意事项</h3>
<ul>
<li><strong>防火墙配置</strong>：确保 NAS 的防火墙允许来自 Linux 设备的 <code>3493</code> 端口的连接。</li>
<li><strong>权限问题</strong>：如果你是其他 NAS, 需要确保 NAS 上的 <code>upsd.users</code> 文件中定义的权限允许客户端设备访问 UPS 信息。</li>
<li><strong>时间同步</strong>：确保 NAS 和 Linux 设备的时间同步，以避免因时间差异导致的监控问题。</li>
</ul>
<h2 id="总结">总结</h2>
<p>通过以上步骤，你应该能够实现:</p>
<p>当 UPS 断电后:</p>
<ol>
<li>NAS 自动关机</li>
<li>其他 Linux 设备 自动关机</li>
</ol>
<p>🎉🎉🎉</p>
<blockquote>
<p><em>三人行, 必有我师; 知识共享, 天下为公.</em>  本文由东风微鸣技术博客 <a href="https://EWhisper.cn" target="_blank" rel="noopener nofollow">EWhisper.cn</a> 编写.</p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.3477906892060185" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-22 19:54">2025-03-22 19:53</span>&nbsp;
<a href="https://www.cnblogs.com/east4ming">东风微鸣</a>&nbsp;
阅读(<span id="post_view_count">5</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18787004" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18787004);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18787004', targetLink: 'https://www.cnblogs.com/east4ming/p/18787004', title: '如何设置家用威联通 NAS UPS 断电后自动关机并通知其他设备?' })">举报</a>
</div>
        