
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/damaoa/p/18938878" title="å‘å¸ƒäº 2025-06-20 17:24">
    <span role="heading" aria-level="2">ThreadLocalè¯¦è§£ï¼šçº¿ç¨‹ç§æœ‰å˜é‡çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="threadlocalè¯¦è§£çº¿ç¨‹ç§æœ‰å˜é‡çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿">ThreadLocalè¯¦è§£ï¼šçº¿ç¨‹ç§æœ‰å˜é‡çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h1>
<blockquote>
<p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå¦‚ä½•è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼ŸThreadLocalå°±åƒç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªä¸“å±ä¿é™©ç®±ï¼Œè§£å†³äº†çº¿ç¨‹é—´æ•°æ®å†²çªçš„é—®é¢˜ã€‚æœ¬æ–‡å°†ç”¨æœ€ç®€å•çš„æ–¹å¼å¸¦ä½ æŒæ¡ThreadLocalï¼Œè®©å¤šçº¿ç¨‹ç¼–ç¨‹å˜å¾—æ›´åŠ è½»æ¾ï¼</p>
</blockquote>
<h2 id="ä¸€threadlocalæ˜¯ä»€ä¹ˆ">ä¸€ã€ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<h3 id="1-ä¸€ä¸ªç”Ÿæ´»åŒ–çš„æ¯”å–»">1. ä¸€ä¸ªç”Ÿæ´»åŒ–çš„æ¯”å–»</h3>
<p>æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å…¬å¸ä¸Šç­ï¼š</p>
<p><strong>ä¼ ç»Ÿæ–¹å¼ï¼ˆå…±äº«å˜é‡ï¼‰</strong>ï¼š</p>
<ul>
<li>æ•´ä¸ªå…¬å¸åªæœ‰ä¸€å°æ‰“å°æœºï¼Œå¤§å®¶æ’é˜Ÿä½¿ç”¨</li>
<li>ç»å¸¸å‡ºç°æ‰“å°æ··ä¹±ï¼Œä½ çš„æ–‡ä»¶è¢«åˆ«äººæ‹¿èµ°</li>
<li>éœ€è¦åŠ é”ç®¡ç†ï¼Œæ•ˆç‡å¾ˆä½</li>
</ul>
<p><strong>ThreadLocalæ–¹å¼</strong>ï¼š</p>
<ul>
<li>ç»™æ¯ä¸ªå‘˜å·¥å‘ä¸€å°ä¸“å±æ‰“å°æœº</li>
<li>å„è‡ªä½¿ç”¨å„è‡ªçš„ï¼Œäº’ä¸å¹²æ‰°</li>
<li>ä¸éœ€è¦æ’é˜Ÿï¼Œæ•ˆç‡è¶…é«˜</li>
</ul>
<pre><code class="language-java">// ä¼ ç»Ÿæ–¹å¼ï¼šå¤§å®¶å…±ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå®¹æ˜“å‡ºé”™
public class SharedCounter {
    private static int count = 0;
  
    public static void add() {
        count++;  // å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¼šå‡ºé—®é¢˜
    }
}

// ThreadLocalæ–¹å¼ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„è®¡æ•°å™¨
public class ThreadLocalCounter {
    private static ThreadLocal&lt;Integer&gt; count = ThreadLocal.withInitial(() -&gt; 0);
  
    public static void add() {
        count.set(count.get() + 1);  // çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€æ‹…å¿ƒ
    }
  
    public static int get() {
        return count.get();
    }
}
</code></pre>
<h3 id="2-threadlocalçš„æ ¸å¿ƒç‰¹ç‚¹">2. ThreadLocalçš„æ ¸å¿ƒç‰¹ç‚¹</h3>
<ul>
<li><strong>çº¿ç¨‹éš”ç¦»</strong>ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬</li>
<li><strong>è‡ªåŠ¨ç®¡ç†</strong>ï¼šæ— éœ€æ‰‹åŠ¨åŒæ­¥ï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨</li>
<li><strong>ä½¿ç”¨ç®€å•</strong>ï¼šå°±åƒæ“ä½œæ™®é€šå˜é‡ä¸€æ ·</li>
</ul>
<h2 id="äºŒthreadlocalæ€ä¹ˆç”¨">äºŒã€ThreadLocalæ€ä¹ˆç”¨ï¼Ÿ</h2>
<h3 id="1-åŸºæœ¬ä½¿ç”¨æ–¹æ³•">1. åŸºæœ¬ä½¿ç”¨æ–¹æ³•</h3>
<p>ThreadLocalçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦è®°ä½ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-java">public class ThreadLocalExample {
    // åˆ›å»ºThreadLocalå˜é‡
    private static ThreadLocal&lt;String&gt; userInfo = ThreadLocal.withInitial(() -&gt; "æœªçŸ¥ç”¨æˆ·");
  
    public static void main(String[] args) {
        // è®¾ç½®å€¼
        userInfo.set("å¼ ä¸‰");
      
        // è·å–å€¼
        String user = userInfo.get();
        System.out.println("å½“å‰ç”¨æˆ·: " + user);
      
        // æ¸…ç†å€¼ï¼ˆé‡è¦ï¼ï¼‰
        userInfo.remove();
    }
}
</code></pre>
<h3 id="2-å®é™…åº”ç”¨åœºæ™¯">2. å®é™…åº”ç”¨åœºæ™¯</h3>
<p><strong>åœºæ™¯ä¸€ï¼šç”¨æˆ·ä¿¡æ¯ä¼ é€’</strong></p>
<p>åœ¨Webå¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦åœ¨æ•´ä¸ªè¯·æ±‚è¿‡ç¨‹ä¸­ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼š</p>
<pre><code class="language-java">public class UserContext {
    private static ThreadLocal&lt;String&gt; currentUser = new ThreadLocal&lt;&gt;();
  
    // è®¾ç½®å½“å‰ç”¨æˆ·
    public static void setUser(String username) {
        currentUser.set(username);
    }
  
    // è·å–å½“å‰ç”¨æˆ·
    public static String getUser() {
        return currentUser.get();
    }
  
    // æ¸…ç†ç”¨æˆ·ä¿¡æ¯
    public static void clear() {
        currentUser.remove();
    }
}

// åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½è·å–å½“å‰ç”¨æˆ·ï¼Œæ— éœ€å±‚å±‚ä¼ å‚
public class OrderService {
    public void createOrder() {
        String user = UserContext.getUser();
        System.out.println(user + " åˆ›å»ºäº†ä¸€ä¸ªè®¢å•");
    }
}
</code></pre>
<p><strong>åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥ç®¡ç†</strong></p>
<pre><code class="language-java">public class DatabaseHelper {
    private static ThreadLocal&lt;Connection&gt; connection = new ThreadLocal&lt;&gt;();
  
    public static Connection getConnection() {
        Connection conn = connection.get();
        if (conn == null) {
            // åˆ›å»ºæ–°è¿æ¥
            conn = createNewConnection();
            connection.set(conn);
        }
        return conn;
    }
  
    public static void closeConnection() {
        Connection conn = connection.get();
        if (conn != null) {
            try {
                conn.close();
            } catch (Exception e) {
                // å¤„ç†å¼‚å¸¸
            } finally {
                connection.remove();  // è®°å¾—æ¸…ç†
            }
        }
    }
}
</code></pre>
<p><strong>åœºæ™¯ä¸‰ï¼šSimpleDateFormatçº¿ç¨‹å®‰å…¨</strong></p>
<p>SimpleDateFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç”¨ThreadLocalè½»æ¾è§£å†³ï¼š</p>
<pre><code class="language-java">public class DateUtils {
    private static ThreadLocal&lt;SimpleDateFormat&gt; formatter = 
        ThreadLocal.withInitial(() -&gt; new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
  
    public static String formatDate(Date date) {
        return formatter.get().format(date);
    }
  
    public static Date parseDate(String dateStr) throws ParseException {
        return formatter.get().parse(dateStr);
    }
}
</code></pre>
<h2 id="ä¸‰threadlocalçš„å·¥ä½œåŸç†">ä¸‰ã€ThreadLocalçš„å·¥ä½œåŸç†</h2>
<h3 id="1-ç®€å•ç†è§£å†…éƒ¨æœºåˆ¶">1. ç®€å•ç†è§£å†…éƒ¨æœºåˆ¶</h3>
<p>ThreadLocalçš„å®ç°åŸç†å…¶å®å¾ˆç®€å•ï¼š</p>
<div class="mermaid">flowchart TD
    A[æ¯ä¸ªThreadçº¿ç¨‹] --&gt; B[éƒ½æœ‰ä¸€ä¸ªMapå®¹å™¨]
    B --&gt; C[ThreadLocalä½œä¸ºkey]
    C --&gt; D[å­˜å‚¨çš„å€¼ä½œä¸ºvalue]
    D --&gt; E[ä¸åŒçº¿ç¨‹çš„Mapäº’ä¸å¹²æ‰°]
</div><p>ç”¨ä»£ç æ¥ç†è§£å°±æ˜¯ï¼š</p>
<pre><code class="language-java">// å¯ä»¥è¿™æ ·ç®€å•ç†è§£ThreadLocalçš„å·¥ä½œæ–¹å¼
class Thread {
    Map&lt;ThreadLocal, Object&gt; threadLocalMap = new HashMap&lt;&gt;();
}

// å½“ä½ è°ƒç”¨threadLocal.set(value)æ—¶ï¼š
// Thread.currentThread().threadLocalMap.put(threadLocal, value);

// å½“ä½ è°ƒç”¨threadLocal.get()æ—¶ï¼š
// return Thread.currentThread().threadLocalMap.get(threadLocal);
</code></pre>
<h3 id="2-ä¸ºä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨çš„">2. ä¸ºä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ</h3>
<p>å› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼Œå°±åƒæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„å£è¢‹ï¼š</p>
<ul>
<li>å¼ ä¸‰å¾€è‡ªå·±å£è¢‹é‡Œæ”¾é’±ï¼Œä¸ä¼šå½±å“æå››çš„å£è¢‹</li>
<li>æå››ä»è‡ªå·±å£è¢‹é‡Œæ‹¿é’±ï¼Œä¹Ÿä¸ä¼šæ‹¿åˆ°å¼ ä¸‰çš„é’±</li>
</ul>
<h2 id="å››ä½¿ç”¨threadlocalçš„æ³¨æ„äº‹é¡¹">å››ã€ä½¿ç”¨ThreadLocalçš„æ³¨æ„äº‹é¡¹</h2>
<h3 id="1-æœ€é‡è¦çš„ä¸€ç‚¹è®°å¾—æ¸…ç†">1. æœ€é‡è¦çš„ä¸€ç‚¹ï¼šè®°å¾—æ¸…ç†ï¼</h3>
<p><strong>ä¸ºä»€ä¹ˆä¸€å®šè¦æ¸…ç†ThreadLocalï¼Ÿ</strong></p>
<p>æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä½ æœ‰ä¸€ä¸ªå‚¨ç‰©æŸœï¼ˆThreadLocalï¼‰ï¼Œé‡Œé¢æ”¾äº†é‡è¦æ–‡ä»¶ï¼ˆæ•°æ®ï¼‰ã€‚å¦‚æœä½ æ¢å·¥ä½œäº†ï¼ˆçº¿ç¨‹ç»“æŸï¼‰ï¼Œä½†å¿˜è®°æ¸…ç†å‚¨ç‰©æŸœï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<pre><code class="language-java">public class MemoryLeakExample {
    private static ThreadLocal&lt;byte[]&gt; bigData = new ThreadLocal&lt;&gt;();
  
    public void badExample() {
        // å­˜å‚¨1MBçš„æ•°æ®
        bigData.set(new byte[1024 * 1024]);
      
        // å¤„ç†ä¸šåŠ¡é€»è¾‘...
      
        // å¿˜è®°æ¸…ç†ï¼è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨
        // bigData.remove();  // åº”è¯¥è°ƒç”¨è¿™ä¸ª
    }
}
</code></pre>
<p><strong>ä¸æ¸…ç†ä¼šå¯¼è‡´çš„é—®é¢˜ï¼š</strong></p>
<ol>
<li><strong>å†…å­˜æ³„æ¼</strong>ï¼šæ•°æ®ä¸€ç›´å ç”¨å†…å­˜ï¼Œæ— æ³•è¢«å›æ”¶</li>
<li><strong>çº¿ç¨‹æ± æ±¡æŸ“</strong>ï¼šä¸‹ä¸€ä¸ªä»»åŠ¡å¯èƒ½æ‹¿åˆ°ä¸Šä¸€ä¸ªä»»åŠ¡çš„è„æ•°æ®</li>
<li><strong>ç³»ç»Ÿæ€§èƒ½ä¸‹é™</strong>ï¼šå†…å­˜è¶Šç”¨è¶Šå¤šï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´OutOfMemoryError</li>
</ol>
<p><strong>ç”¨ä¸€ä¸ªç”Ÿæ´»åŒ–çš„ä¾‹å­ç†è§£ï¼š</strong></p>
<div class="mermaid">flowchart TD
    A[å‘˜å·¥Aä½¿ç”¨å‚¨ç‰©æŸœ] --&gt; B[æ”¾å…¥æœºå¯†æ–‡ä»¶]
    B --&gt; C[å‘˜å·¥Aç¦»èŒ]
    C --&gt; D{æ˜¯å¦æ¸…ç†å‚¨ç‰©æŸœ}
    D --&gt;|å¦| E[æ–°å‘˜å·¥Bä½¿ç”¨åŒä¸€å‚¨ç‰©æŸœ]
    E --&gt; F[çœ‹åˆ°å‘˜å·¥Açš„æœºå¯†æ–‡ä»¶]
    F --&gt; G[æ•°æ®æ³„éœ²]
    D --&gt;|æ˜¯| H[å‚¨ç‰©æŸœå¹²å‡€]
    H --&gt; I[æ–°å‘˜å·¥Bå®‰å…¨ä½¿ç”¨]
</div><p><strong>æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼š</strong></p>
<pre><code class="language-java">public class GoodPractice {
    private static ThreadLocal&lt;String&gt; data = new ThreadLocal&lt;&gt;();
  
    public void handleRequest() {
        try {
            // è®¾ç½®æ•°æ®
            data.set("é‡è¦æ•°æ®");
          
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            doSomething();
          
        } finally {
            // æ— è®ºå¦‚ä½•éƒ½è¦æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
            data.remove();  // è¿™ä¸€è¡Œéå¸¸é‡è¦ï¼
        }
    }
}
</code></pre>
<h3 id="2-çº¿ç¨‹æ± ç¯å¢ƒä¸‹è¦ç‰¹åˆ«å°å¿ƒ">2. çº¿ç¨‹æ± ç¯å¢ƒä¸‹è¦ç‰¹åˆ«å°å¿ƒ</h3>
<p>åœ¨çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹ä¼šè¢«é‡å¤ä½¿ç”¨ï¼Œä¸æ¸…ç†ThreadLocalå°±åƒä¸æ¸…ç†å…¬ç”¨å·¥å…·ï¼š</p>
<pre><code class="language-java">// é”™è¯¯ç¤ºä¾‹ï¼šåœ¨çº¿ç¨‹æ± ä¸­å¿˜è®°æ¸…ç†
ExecutorService executor = Executors.newFixedThreadPool(5);

executor.submit(() -&gt; {
    ThreadLocalData.set("ä»»åŠ¡1çš„æ•°æ®");
    System.out.println("ä»»åŠ¡1: " + ThreadLocalData.get());
    // å¿˜è®°æ¸…ç†ï¼Œä¸‹ä¸ªä»»åŠ¡å¯èƒ½æ‹¿åˆ°è„æ•°æ®
});

executor.submit(() -&gt; {
    // ç³Ÿç³•ï¼å¯èƒ½æ‹¿åˆ°"ä»»åŠ¡1çš„æ•°æ®"
    System.out.println("ä»»åŠ¡2: " + ThreadLocalData.get());
});

// æ­£ç¡®ç¤ºä¾‹ï¼šç¡®ä¿æ¸…ç†
executor.submit(() -&gt; {
    try {
        ThreadLocalData.set("ä»»åŠ¡1çš„æ•°æ®");
        System.out.println("ä»»åŠ¡1: " + ThreadLocalData.get());
        // å¤„ç†ä»»åŠ¡
    } finally {
        ThreadLocalData.remove();  // æ¸…ç†æ•°æ®ï¼Œä¸ºä¸‹ä¸ªä»»åŠ¡åšå¥½å‡†å¤‡
    }
});
</code></pre>
<p><strong>çº¿ç¨‹æ± æ±¡æŸ“çš„åæœï¼š</strong></p>
<ul>
<li>æ•°æ®æ··ä¹±ï¼šä»»åŠ¡Bæ‹¿åˆ°ä»»åŠ¡Açš„æ•°æ®</li>
<li>å®‰å…¨é—®é¢˜ï¼šæ•æ„Ÿä¿¡æ¯æ³„éœ²ç»™å…¶ä»–ä»»åŠ¡</li>
<li>è°ƒè¯•å›°éš¾ï¼šå¾ˆéš¾å®šä½é—®é¢˜æ ¹æº</li>
</ul>
<h3 id="3-é¿å…å­˜å‚¨å¤§å¯¹è±¡">3. é¿å…å­˜å‚¨å¤§å¯¹è±¡</h3>
<p>ThreadLocalé€‚åˆå­˜å‚¨è½»é‡çº§æ•°æ®ï¼Œä¸è¦å­˜å‚¨å¤§å¯¹è±¡ï¼š</p>
<pre><code class="language-java">// ä¸å¥½çš„åšæ³• - å­˜å‚¨å¤§å¯¹è±¡
ThreadLocal&lt;byte[]&gt; bigData = new ThreadLocal&lt;&gt;();
bigData.set(new byte[1024 * 1024]);  // 1MBæ•°æ®ï¼Œå¤ªå¤§äº†ï¼

// ä¸å¥½çš„åšæ³• - å­˜å‚¨å¤æ‚å¯¹è±¡
ThreadLocal&lt;List&lt;User&gt;&gt; userList = new ThreadLocal&lt;&gt;();
userList.set(getAllUsers());  // å¦‚æœç”¨æˆ·å¾ˆå¤šï¼Œå ç”¨å†…å­˜å°±å¾ˆå¤§

// æ›´å¥½çš„åšæ³• - å­˜å‚¨ç®€å•æ ‡è¯†
ThreadLocal&lt;String&gt; userId = new ThreadLocal&lt;&gt;();
userId.set("user123");  // è½»é‡çº§ï¼Œæ¨è

ThreadLocal&lt;Long&gt; requestId = new ThreadLocal&lt;&gt;(); 
requestId.set(12345L);  // ç®€å•æ•°æ®ç±»å‹ï¼Œå¾ˆå¥½
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆè¦é¿å…å¤§å¯¹è±¡ï¼Ÿ</strong></p>
<ul>
<li>å†…å­˜æ¶ˆè€—å¤§ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½è¦å¤åˆ¶ä¸€ä»½</li>
<li>GCå‹åŠ›å¤§ï¼šåƒåœ¾å›æ”¶æ—¶éœ€è¦å¤„ç†æ›´å¤šæ•°æ®</li>
<li>æ€§èƒ½å½±å“ï¼šå­˜å–å¤§å¯¹è±¡æ¯”è¾ƒæ…¢</li>
</ul>
<h2 id="äº”threadlocal-vs-å…¶ä»–æ–¹æ¡ˆ">äº”ã€ThreadLocal vs å…¶ä»–æ–¹æ¡ˆ</h2>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>ThreadLocal</td>
<td>çº¿ç¨‹éš”ç¦»ï¼Œæ— éœ€åŒæ­¥</td>
<td>å¯èƒ½å†…å­˜æ³„æ¼</td>
<td>çº¿ç¨‹çº§åˆ«çš„æ•°æ®ä¼ é€’</td>
</tr>
<tr>
<td>synchronized</td>
<td>å®‰å…¨å¯é </td>
<td>æ€§èƒ½å¼€é”€å¤§</td>
<td>éœ€è¦çº¿ç¨‹é—´å…±äº«æ•°æ®</td>
</tr>
<tr>
<td>volatile</td>
<td>è½»é‡çº§</td>
<td>ä¸èƒ½ä¿è¯åŸå­æ€§</td>
<td>ç®€å•çš„çŠ¶æ€æ ‡è®°</td>
</tr>
<tr>
<td>Atomicç±»</td>
<td>é«˜æ€§èƒ½åŸå­æ“ä½œ</td>
<td>åªé€‚åˆç®€å•æ“ä½œ</td>
<td>è®¡æ•°å™¨ã€çŠ¶æ€æ›´æ–°</td>
</tr>
</tbody>
</table>
<h2 id="å…­å®æˆ˜å°æŠ€å·§">å…­ã€å®æˆ˜å°æŠ€å·§</h2>
<h3 id="1-åˆ›å»ºthreadlocalçš„ç°ä»£å†™æ³•">1. åˆ›å»ºThreadLocalçš„ç°ä»£å†™æ³•</h3>
<pre><code class="language-java">// è€å¼å†™æ³•
ThreadLocal&lt;String&gt; oldStyle = new ThreadLocal&lt;String&gt;() {
    @Override
    protected String initialValue() {
        return "é»˜è®¤å€¼";
    }
};

// ç°ä»£å†™æ³•ï¼ˆæ¨èï¼‰
ThreadLocal&lt;String&gt; newStyle = ThreadLocal.withInitial(() -&gt; "é»˜è®¤å€¼");
</code></pre>
<h3 id="2-ç»“åˆspringä½¿ç”¨">2. ç»“åˆSpringä½¿ç”¨</h3>
<pre><code class="language-java">@Component
public class RequestContextHolder {
    private static final ThreadLocal&lt;String&gt; REQUEST_ID = new ThreadLocal&lt;&gt;();
  
    public void setRequestId(String requestId) {
        REQUEST_ID.set(requestId);
    }
  
    public String getRequestId() {
        return REQUEST_ID.get();
    }
  
    @PreDestroy
    public void cleanup() {
        REQUEST_ID.remove();
    }
}
</code></pre>
<h3 id="3-ç®€å•çš„æ€§èƒ½ç›‘æ§">3. ç®€å•çš„æ€§èƒ½ç›‘æ§</h3>
<pre><code class="language-java">public class PerformanceMonitor {
    private static ThreadLocal&lt;Long&gt; startTime = new ThreadLocal&lt;&gt;();
  
    public static void start() {
        startTime.set(System.currentTimeMillis());
    }
  
    public static long end() {
        Long start = startTime.get();
        if (start != null) {
            long duration = System.currentTimeMillis() - start;
            startTime.remove();
            return duration;
        }
        return 0;
    }
}
</code></pre>
<h2 id="ä¸ƒæ€»ç»“">ä¸ƒã€æ€»ç»“</h2>
<p>ThreadLocalå°±åƒç»™æ¯ä¸ªçº¿ç¨‹å‘äº†ä¸€ä¸ªä¸“å±ä¿é™©ç®±ï¼Œè®©å¤šçº¿ç¨‹ç¼–ç¨‹å˜å¾—ç®€å•å®‰å…¨ã€‚</p>
<h3 id="-æ ¸å¿ƒè¦ç‚¹">ğŸ¯ <strong>æ ¸å¿ƒè¦ç‚¹</strong></h3>
<ul>
<li><strong>çº¿ç¨‹éš”ç¦»</strong>ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬äº«è‡ªå·±çš„æ•°æ®å‰¯æœ¬</li>
<li><strong>ä½¿ç”¨ç®€å•</strong>ï¼šset()å­˜å‚¨ï¼Œget()è·å–ï¼Œremove()æ¸…ç†</li>
<li><strong>å¤©ç„¶å®‰å…¨</strong>ï¼šæ— éœ€æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šç”¨æˆ·ä¿¡æ¯ä¼ é€’ã€è¿æ¥ç®¡ç†ã€å·¥å…·ç±»å°è£…</li>
</ul>
<h3 id="-ä½¿ç”¨åŸåˆ™">ğŸš€ <strong>ä½¿ç”¨åŸåˆ™</strong></h3>
<ol>
<li><strong>ç”¨å®Œå°±æ¸…ç†</strong>ï¼šå…»æˆè°ƒç”¨remove()çš„å¥½ä¹ æƒ¯</li>
<li><strong>é¿å…å¤§å¯¹è±¡</strong>ï¼šä¸è¦å­˜å‚¨å ç”¨å†…å­˜è¿‡å¤§çš„å¯¹è±¡</li>
<li><strong>çº¿ç¨‹æ± æ³¨æ„</strong>ï¼šç¡®ä¿ä»»åŠ¡ç»“æŸæ—¶æ¸…ç†æ•°æ®</li>
<li><strong>åˆç†é€‰æ‹©</strong>ï¼šä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½é€‚åˆç”¨ThreadLocal</li>
</ol>
<h3 id="ï¸-è®°ä½ä¸‰ç‚¹">âš ï¸ <strong>è®°ä½ä¸‰ç‚¹</strong></h3>
<ul>
<li>ThreadLocalä¸æ˜¯ç”¨æ¥è§£å†³çº¿ç¨‹é—´é€šä¿¡çš„</li>
<li>ä¸€å®šè¦åœ¨åˆé€‚çš„æ—¶å€™è°ƒç”¨remove()</li>
<li>ä¸è¦ä¸ºäº†ç”¨ThreadLocalè€Œç”¨ThreadLocal</li>
</ul>
<p>æŒæ¡äº†ThreadLocalï¼Œä½ çš„å¤šçº¿ç¨‹ç¼–ç¨‹å°†ä¼šæ›´åŠ è½»æ¾æ„‰å¿«ï¼å°±åƒæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰äº†è‡ªå·±çš„ç§äººåŠ©ç†ï¼Œå·¥ä½œæ•ˆç‡è‡ªç„¶æå‡ã€‚</p>
<hr>
<blockquote>
<p>è§‰å¾—æ–‡ç« æœ‰å¸®åŠ©ï¼Ÿæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€ä¸€åªåˆ’æ°´çš„ç¨‹åºçŒ¿ã€‘ï¼ŒæŒç»­åˆ†äº«Javaå¹¶å‘ç¼–ç¨‹ã€å®ç”¨æŠ€å·§ç­‰æŠ€æœ¯å¹²è´§ï¼Œè®©ç¼–ç¨‹å˜å¾—æ›´ç®€å•ï¼</p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-06-20 17:24">2025-06-20 17:24</span>&nbsp;
<a href="https://www.cnblogs.com/damaoa">å¤§æ¯›å•Š</a>&nbsp;
é˜…è¯»(<span id="post_view_count">35</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18938878);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18938878', targetLink: 'https://www.cnblogs.com/damaoa/p/18938878', title: 'ThreadLocalè¯¦è§£ï¼šçº¿ç¨‹ç§æœ‰å˜é‡çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿' })">ä¸¾æŠ¥</a>
</div>
        