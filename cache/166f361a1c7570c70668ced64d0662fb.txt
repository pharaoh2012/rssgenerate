
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiao987334176/p/18807489" title="发布于 2025-04-03 16:13">
    <span role="heading" aria-level="2">dify升级，PostgreSQL数据库字段更新处理</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1>一、概述</h1>
<p>dify运行在容器中，PostgreSQL用的是阿里云，已经运行了很长一段时间。某些表的数据量很大，比如workflowruns表，就有100GB。这个主要是，详细记录了工作流的执行情况，包括执行时间、状态、结果等信息。<br>版本比较老，0.14.2，需要升级到0.15.3。</p>
<p>升级之前，除了对数据库做备份之外，还需要知道升级过程中，哪些表需要做更新处理。因为某些大表如果要添加字段，索引等操作，非常耗费时间，长达3个小时以上。</p>
<p>为了缩短升级过程，需要对数据库的某些大表，提前进行清理，一些不重要的数据，保留1个月即可。</p>
<h1>二、代码分析</h1>
<p>访问github官网，<a href="https://github.com/langgenius/dify" rel="noopener nofollow">https://github.com/langgenius/dify</a></p>
<p>下载releases对应的版本的代码，0.14.2，0.15.3</p>
<p>得到文件，dify-0.14.2.zip，dify-0.15.3.zip</p>
<p>&nbsp;</p>
<p>首先解压文件dify-0.14.2.zip</p>
<p>进入文件夹，dify-0.14.2\api\models</p>
<p>api是基于python flask框架开发的， models里面的python文件，都是数据库表结构文件。</p>
<p>&nbsp;</p>
<p>然后解压文件dify-0.15.3.zip，对比2个model文件，发现workflowruns表，确实是有更新的</p>
<p>0.14.2如下：</p>
<p>total_tokens = db.Column(db.Integer, nullable=False, server_default=db.text("0"))</p>
<p>&nbsp;</p>
<p>0.15.3 如下：</p>
<p>total_tokens: Mapped[int] = mapped_column(sa.BigInteger, server_default=sa.text("0"))</p>
<p>&nbsp;</p>
<p>直接对比python文件，不够直观，涉及的文件比较多。就算看出来差异了，也不能直接看到具体的表字段是怎么变化的。</p>
<p>接下来，使用sql文件分析，会更加直观一些。</p>
<h1>三、sql文件分析</h1>
<p><span style="color: rgba(255, 0, 0, 1)"><strong>演示环境，我们弄2台服务器，分别运行0.14.2，0.15.3。不需要任何数据库，直接空数据运行都没问题，主要是为了分析表结构。</strong></span></p>
<h2>0.14.2</h2>
<p>进入0.14.2版本的容器，找到dify_db_1，进入docker</p>
<div class="cnblogs_code">
<pre>docker <span style="color: rgba(0, 0, 255, 1)">exec</span> -it dify_db_1 /bin/bash</pre>
</div>
<p>导出dify表结构</p>
<div class="cnblogs_code">
<pre>pg_dump -h localhost -p 5432 -U postgres -d dify -s -f dify-0.14.2.sql</pre>
</div>
<p>将文件拷贝出来</p>
<div class="cnblogs_code">
<pre>docker cp dify_db_1:/dify-0.14.2.sql /tmp/dify-0.14.2.sql</pre>
</div>
<h2>0.15.3</h2>
<p>进入0.15.3版本的容器，找到dify_db_1，进入docker</p>
<div class="cnblogs_code">
<pre>docker <span style="color: rgba(0, 0, 255, 1)">exec</span> -it dify_db_1 /bin/bash</pre>
</div>
<p>导出dify表结构</p>
<div class="cnblogs_code">
<pre>pg_dump -h localhost -p 5432 -U postgres -d dify -s -f dify-0.15.3.sql</pre>
</div>
<p>&nbsp;</p>
<p>将文件拷贝出来</p>
<div class="cnblogs_code">
<pre>docker cp dify_db_1:/dify-0.15.3.sql /tmp/dify-0.15.3.sql</pre>
</div>
<h2>对比差异</h2>
<p>使用VsCode编辑器对比2个文件，dify-0.14.2.sql，dify-0.15.3.sql</p>
<p>差异如下：</p>
<p>左边是0.14.2，右边是0.15.3</p>
<p>新增表child_chunks</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403160925004-1860488502.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>新增表data_source_oauth_bindings</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403160955401-298579977.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>比较关心的表workflowruns，确实发生了变化。</p>
<p>0.14.2版本total_tokens字段是int类型</p>
<p>0.15.3版本total_tokens字段是bigint类型</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403161026487-5903884.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>child_chunks表添加一个主键约束，确保 id 列中的值是唯一的。</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403161104001-2007740079.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>dataset_auto_disable_logs表添加一个主键约束，确保 id 列中的值是唯一的。</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403161130792-1410672883.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>child_chunks表添加组合索引child_chunk_dataset_id_idx</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403161204673-1282759842.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p align="left">dataset_auto_disable_logs表添加索引dataset_auto_disable_log_created_atx，dataset_auto_disable_log_dataset_idx，dataset_auto_disable_log_tenant_idx</p>
<p><img src="https://img2024.cnblogs.com/blog/1341090/202504/1341090-20250403161245284-125712238.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>知道以上这些差异之后，就可以对生产PostgreSQL数据库做进一步处理了</p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.005344652962962963" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-03 16:14">2025-04-03 16:13</span>&nbsp;
<a href="https://www.cnblogs.com/xiao987334176">肖祥</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18807489" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18807489);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18807489', targetLink: 'https://www.cnblogs.com/xiao987334176/p/18807489', title: 'dify升级，PostgreSQL数据库字段更新处理' })">举报</a>
</div>
        