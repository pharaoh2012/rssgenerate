
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/songxwn/p/18855128/AD-DS-install" title="发布于 2025-04-30 11:13">
    <span role="heading" aria-level="2">AD系列：Windows Server 2025 搭建AD域控和初始化</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="简介">简介</h1>
<p>本教程主要内容为使用Windows Server 2025 部署Active Directory  （ADDS\域控制器）服务。<br>
所有操作尽量使用PowerShell，可提高部署效率和自动化操作。</p>
<p>AD 系列文章：<a href="https://songxwn.com/categories/AD/" target="_blank" rel="noopener nofollow">https://songxwn.com/categories/AD/</a></p>
<h2 id="使用目的">使用目的</h2>
<p>用于基础设施中的LDAP统一身份授权认证、NTP 服务器、DNS服务器。</p>
<p>LDAP 系列文章：<a href="https://songxwn.com/tags/ldap/" target="_blank" rel="noopener nofollow">https://songxwn.com/tags/ldap/</a></p>

<h2 id="域控配置要求">域控配置要求</h2>
<p>建议至少 2C6G 50G存储</p>
<h2 id="windows-server-2025-最新iso下载">Windows Server 2025 最新ISO下载</h2>
<p>MD5：985096E0D119BD8D2947CC2220986EE2</p>
<p>SHA1：5370F9F768EC31B846B2B7E14DCAF597C649ADEA</p>
<p>SHA256：72E67B86E0F7A000BF33D2CFB2394680E909AB3F880EAB42222177F5F4DF8E8A</p>
<p>BT 磁力 （可用迅雷或qBittorrent 下载）：</p>
<pre><code class="language-powershell">magnet:?xt=urn:btih:02b56c181327e1effeda992a3b3f0de3c74ba792&amp;dn=zh-cn_windows_server_2025_updated_april_2025_x64_dvd_ea86301d.iso&amp;xl=7050024960

</code></pre>
<h2 id="kms-安装激活密钥">KMS 安装/激活密钥</h2>
<p> </p>
<p>安装密钥：D764K-2NDRG-47T6Q-P8T8W-YP6DF</p>
<p>注意：安装的时候选择 Windows Server 2025 Datacenter 桌面体验 版本。</p>
<h3 id="激活命令">激活命令</h3>
<pre><code class="language-powershell"># 运行管理员权限的powershell 窗口




slmgr /ipk D764K-2NDRG-47T6Q-P8T8W-YP6DF

# 安装KMS密钥



slmgr /skms kms.songxwn.com
# 指定KMS 激活服务器



slmgr /ato

# 配置激活

# 然后重启系统即可完成转换。

</code></pre>
<h1 id="域控安装前准备">域控安装前准备</h1>
<h2 id="修改计算机名字-作为域控后不建议随意修改名字">修改计算机名字 （作为域控后不建议随意修改名字）</h2>
<pre><code class="language-powershell">## powershell 管理员执行 或 终端 管理员执行

Rename-Computer -NewName "AD-S1" -Force -Restart

# 修改计算机名字并立即重启生效。
</code></pre>
<h2 id="配置固定ip">配置固定IP</h2>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/uI9SfTkOwD.png" alt="" loading="lazy"></p>
<h2 id="删除安全服务-可选">删除安全服务 （可选）</h2>
<pre><code class="language-powershell">Remove-WindowsFeature -Name Windows-Defender
</code></pre>
<h1 id="域控安装">域控安装</h1>
<h2 id="添加域控制器角色">添加域控制器角色</h2>
<pre><code class="language-powershell">## powershell 管理员执行 或 终端 管理员执行

Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# 关闭防火墙

Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools 

# 安装域控角色
</code></pre>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/SXa30nPDRs.png" alt="" loading="lazy"></p>
<p>如上图，代表安装完成。（安装完成后尽量重启一次。）</p>
<h2 id="将服务器配置为域控制器">将服务器配置为域控制器</h2>
<pre><code class="language-powershell">## powershell 管理员执行 或 终端 管理员执行，执行后会提示是否继续，回车继续即可。

Install-ADDSForest `
    -DomainName "songxwn.local" `
    -ForestMode Win2025 `
    -DomainMode Win2025 `
    -DomainNetbiosName "SONGXWN" `
    -SafeModeAdministratorPassword (ConvertTo-SecureString "Songxwn.com" -AsPlainText -Force) `
    -InstallDNS
</code></pre>
<p><strong>注意：执行配置完成后，会自动重启。重启后，要使用 songxwn\administrator 用户登录，密码和之前的本地administrator一样。</strong></p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/NQMefXltPZ.png" alt="" loading="lazy"></p>
<h2 id="以上powershell-配置ad-命令的详细讲解">以上powershell 配置AD 命令的详细讲解：</h2>
<h3 id="-domainname-songxwnlocal"><code>-DomainName "songxwn.local"</code></h3>
<ul>
<li>
<p>该参数指定新的 Active Directory 域的 DNS 名称。</p>
</li>
<li>
<p>这里创建的域名是 <code>songxwn.local</code>，可以自行修改。</p>
</li>
</ul>
<h3 id="-forestmode-win2025"><code>-ForestMode Win2025</code></h3>
<ul>
<li>
<p>该参数用于指定新的 AD 域林的功能级别（Forest Functional Level）。</p>
</li>
<li>
<p>功能级别定义了林中能支持的活动目录功能。</p>
<ul>
<li>
<p>Windows2008, Windows2008R2</p>
</li>
<li>
<p>Windows2012, Windows2012R2</p>
</li>
<li>
<p>Windows2016</p>
</li>
<li>
<p>Windows2025</p>
</li>
</ul>
</li>
</ul>
<h3 id="-domainmode-win2025"><code>-DomainMode Win2025</code></h3>
<ul>
<li>
<p>该参数指定域的功能级别（Domain Functional Level）。</p>
</li>
<li>
<p>与林功能级别类似，定义了该域支持的功能和特性。</p>
</li>
</ul>
<h3 id="-domainnetbiosname-songxwn"><code>-DomainNetbiosName SONGXWN</code></h3>
<ul>
<li>
<p>指定域的 NetBIOS 名称，NetBIOS 名称是一个15字符以内的短名，主要用于旧的网络浏览、兼容应用等。</p>
</li>
<li>
<p>一般与域名的前缀（主机部分）相同或类似，通常大写。</p>
</li>
<li>
<p>例如 <code>songxwn.local</code> 域对应的 NetBIOS 名称是 <code>SONGXWN</code>。</p>
</li>
</ul>
<h3 id="-safemodeadministratorpassword-convertto-securestring--asplaintext-songxwncom--force"><code>-SafeModeAdministratorPassword (ConvertTo-SecureString -AsPlainText "Songxwn.com" -Force)</code></h3>
<ul>
<li>
<p>该参数指定目录服务恢复模式（DSRM）管理员账号（内建管理员账户）的密码。</p>
</li>
<li>
<p>DSRM 是 AD 维护和恢复时使用的特殊模式。</p>
</li>
<li>
<p>命令部分 <code>(ConvertTo-SecureString -AsPlainText "Songxwn.com" -Force)</code> 是将明文密码 <code>"Songxwn.com"</code> 转换成安全的字符串格式，符合命令要求。</p>
</li>
<li>
<p>注意，密码应遵循复杂性策略，以保证安全。</p>
</li>
</ul>
<h3 id="-installdns"><code>-InstallDNS</code></h3>
<ul>
<li>
<p>指示安装过程也安装 DNS 服务器角色，并自动配置DNS。</p>
</li>
<li>
<p>对 Active Directory 域控来说，DNS 服务是必备的，因为 AD 依赖 DNS 进行名称解析和服务定位。</p>
</li>
</ul>
<h1 id="域控安装后">域控安装后</h1>
<h2 id="组策略---修改密码过期时间">组策略 - 修改密码过期时间</h2>
<p>powershell 执行 gpmc.msc 打开组策略管理。</p>
<p>修改最长最短使用期限都为0天。</p>
<p>然后让AD执行<code> gpupdate  /force</code>  强制快速应用组策略。</p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/HrAQuQVqRM.png" alt="" loading="lazy"></p>
<h2 id="修改-dns-转发器---加快dns查询">修改 DNS 转发器 - 加快DNS查询</h2>
<p>运行 dnsmgmt.msc，修改所有的转发器为本地网络的公共DNS服务器。</p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/jlZ41dd4xc.png" alt="" loading="lazy"></p>
<h2 id="adsi---设置普通用户不能自己将计算机加入域控">ADSI - 设置普通用户不能自己将计算机加入域控</h2>
<p>运行adsiedit.msc，点击操作 &gt; 连接到 &gt; 确定（连接到默认域控）&gt; 右键 DC=songxwn,DC=local 属性进行编辑。</p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/yHnsIoIfNc.png" alt="" loading="lazy"></p>
<p>找到“ ms-DS-MachineAccountQuota” ，将其数值由默认的10改成0 。然后点击应用。如上图。 （默认是10次，代表普通用户可以将十台计算机加入域控，但域控管理员不受限制。）</p>
<h2 id="组策略---只允许本地管理员登录域控计算机---可选">组策略 - 只允许本地管理员登录域控计算机 - 可选</h2>
<p>powershell 执行 gpmc.msc 打开组策略管理。</p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/9VGoPSK19N.png" alt="" loading="lazy"></p>
<p>添加 Administrators 组 和 Domain Admins组，这样只能添加到本地管理员组的普通用户，或域控管理员用户能进行登录这台计算机。</p>
<p>然后让AD执行<code> gpupdate  /force</code>  强制快速应用组策略。</p>
<h2 id="ntp服务器配置---使用公网权威ntp服务器作为上游同步">NTP服务器配置 - 使用公网权威NTP服务器作为上游同步</h2>
<p>因为默认仅仅会用COMS作为时间源，久了时间会偏移。</p>
<pre><code class="language-powershell">w32tm /config /manualpeerlist:cn.ntp.org.cn,0x8 /syncfromflags:MANUAL /update

#  仅主域控配置公网ntp服务器，并立即同步





w32tm /resync

# 强制同步NTP服务器，最好所有AD中的域控制器，都执行一次。


w32tm /query /status /verbose   

# 查看当前状态，NTP是否配置成功。

Leap 指示符: 0(无警告)
层次: 3 (次引用 - 与(S)NTP 同步)
精度: -23 (每刻度 119.209ns)
根延迟: 0.2056026s
根分散: 4.0711694s
引用 ID: 0xB65C0C0B (源 IP:  182.92.12.11)
上次成功同步时间: 2025/4/29 8:52:14
源: cn.ntp.org.cn,8
轮询间隔: 6 (64s)

相位偏移: -0.2507314s
ClockRate: 0.0156261s
计算机状态: 1 (等候)
时间源标志:0 (无)
服务器角色: 64 (时间服务)
上次同步错误: 0 (成功地执行了命令。)
上次成功同步时间后的时间: 19.3403555s
</code></pre>
<h2 id="创建额外的域控管理员用户">创建额外的域控管理员用户</h2>
<p>运行dsa.msc  打开Active Directory 用户和计算机 </p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/jmTmgGxxn9.png" alt="" loading="lazy"></p>
<p>进入 Users 组织单位下，右键 Administrator，选择复制创建用户。</p>
<h2 id="启用并使用-active-directory-回收站">启用并使用 Active Directory 回收站</h2>
<pre><code class="language-powershell">## powershell 管理员执行。在主域控制器执行。

Enable-ADOptionalFeature –Identity ‘CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=songxwn,DC=local’ –Scope ForestOrConfigurationSet –Target ‘songxwn.local’

# 在主域控上执行，注意修改域名。
</code></pre>
<p>已删除的对象，运行 dsac.exe 去 Active Directory 管理中心 &gt;  Deleted Objects 下查看并还原。</p>
<p><img src="https://r2.songxwn.com/ShareX/2025/04/5dO0xkuYV3.png" alt="" loading="lazy"></p>
<h2 id="启用数据库-32k-页可选功能----可选">启用数据库 32k 页可选功能 -- 可选</h2>
<pre><code class="language-powershell"># powershell 管理执行，输入Y继续。

$params = @{
    Identity = 'Database 32k pages feature'
    Scope = 'ForestOrConfigurationSet'
    Server = 'AD-S1'
    Target = 'songxwn.local'
}
Enable-ADOptionalFeature @params

# 注意修改域名。

</code></pre>
<h1 id="微软官方文档">微软官方文档</h1>
<p><a href="https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview" target="_blank" rel="noopener nofollow">https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview</a></p>
<h1 id="运维技术交流群">运维技术交流群</h1>
<p>发送邮件到 ➡️ <a href="mailto:me@songxwn.com" target="_blank" rel="noopener nofollow">me@songxwn.com</a></p>
<p>或者关注WX公众号：网工格物</p>
<p><img src="https://img.songxwn.com/file/2118ff80cff02968a8fe8.png" alt="微信扫码" loading="lazy"></p>
<h2 id="博客最先更新">博客（最先更新）</h2>
<p><a href="https://songxwn.com/" title="https://songxwn.com/" target="_blank" rel="noopener nofollow">https://songxwn.com/</a></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.044318587114583335" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-30 11:16">2025-04-30 11:13</span>&nbsp;
<a href="https://www.cnblogs.com/songxwn">网工格物</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18855128);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18855128', targetLink: 'https://www.cnblogs.com/songxwn/p/18855128/AD-DS-install', title: 'AD系列：Windows Server 2025 搭建AD域控和初始化' })">举报</a>
</div>
        