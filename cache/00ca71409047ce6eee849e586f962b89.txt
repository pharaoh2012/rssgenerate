
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/fengyun2019/p/19024465" title="å‘å¸ƒäº 2025-08-06 09:36">
    <span role="heading" aria-level="2">LangChainæ¡†æ¶å…¥é—¨08ï¼šå…¨æ–¹ä½è§£æè®°å¿†ç»„ä»¶</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨LangChainæ„å»ºåŸºæœ¬çš„å¯¹è¯åº”ç”¨ï¼Œä¸è¿‡åœ¨å’Œå¤§è¯­è¨€æ¨¡å‹å¯¹è¯æ—¶ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°å¤§è¯­è¨€æ¨¡å‹å¾ˆå¿«å°±ä¼šå¤±å¿†ï¼Œåé¢èŠå¤©æé—®å‰é¢èŠè¿‡çš„å†…å®¹ï¼Œå¤§è¯­è¨€æ¨¡å‹ä»¿ä½›å®Œå…¨â€œå¿˜è®°â€äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLangChainæä¾›äº†å¼ºå¤§çš„<strong>è®°å¿†ç»„ä»¶ï¼ˆMemoryï¼‰</strong>ï¼Œèƒ½å¤Ÿè®©AIâ€œè®°ä½â€ä¸Šä¸‹æ–‡å¯¹è¯ä¿¡æ¯ã€‚</p>
<blockquote>
<p>æ–‡ä¸­æ‰€æœ‰ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/wzycoding/langchain-study" target="_blank" rel="noopener nofollow">https://github.com/wzycoding/langchain-study</a></p>
</blockquote>
<h2 id="ä¸€ä¸ºä»€ä¹ˆéœ€è¦è®°å¿†ç»„ä»¶">ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è®°å¿†ç»„ä»¶</h2>
<p>å¤§è¯­è¨€æ¨¡å‹æœ¬è´¨ä¸Šæ˜¯ç»è¿‡å¤§é‡æ•°æ®è®­ç»ƒå‡ºæ¥çš„è‡ªç„¶è¯­è¨€æ¨¡å‹ï¼Œç”¨æˆ·ç»™å‡ºè¾“å…¥ä¿¡æ¯ï¼Œå¤§è¯­è¨€æ¨¡å‹ä¼šæ ¹æ®è®­ç»ƒçš„æ•°æ®è¿›è¡Œ<strong>é¢„æµ‹</strong>ç»™å‡ºæŒ‡å®šçš„ç»“æœï¼Œå¤§è¯­è¨€æ¨¡å‹æœ¬èº«æ˜¯<strong>â€œæ— çŠ¶æ€çš„â€</strong>ï¼Œå› æ­¤å¤§è¯­è¨€æ¨¡å‹æ˜¯<strong>æ²¡æœ‰è®°å¿†èƒ½åŠ›çš„</strong>ã€‚</p>
<p>å½“æˆ‘ä»¬å’Œå¤§è¯­è¨€æ¨¡å‹èŠå¤©æ—¶ï¼Œä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š</p>
<pre><code class="language-python">Human:æˆ‘å«å¤§å¿—ï¼Œè¯·é—®ä½ æ˜¯ï¼Ÿ
AIï¼šä½ å¥½ï¼Œå¤§å¿—ï¼Œæˆ‘æ˜¯OpenAIå¼€å‘çš„èŠå¤©æœºå™¨äººã€‚
Human:ä½ çŸ¥é“æˆ‘æ˜¯è°å—ï¼Ÿ
AIï¼šæˆ‘ä¸çŸ¥é“ï¼Œè¯·ä½ å‘Šè¯‰æˆ‘çš„åå­—ã€‚
</code></pre>
<p>æˆ‘ä»¬åˆšåˆšåœ¨å‰ä¸€è½®å¯¹è¯å‘Šè¯‰å¤§è¯­è¨€æ¨¡å‹çš„ä¿¡æ¯ï¼Œä¸‹ä¸€è½®å°±è¢«â€œé—å¿˜äº†â€ã€‚å½“æˆ‘åœ¨ChatGPTå®˜ç½‘å’ŒChatGPTèŠå¤©æ—¶ï¼Œå®ƒèƒ½è®°ä½å¤šè½®å¯¹è¯ä¸­çš„å†…å®¹ï¼Œè¿™ChatGPTç½‘é¡µç‰ˆå®ç°äº†å†å²è®°å¿†åŠŸèƒ½ã€‚</p>
<p><img alt="image-20250728211159494" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1495546/202508/1495546-20250806093412371-731853484.png" class="lazyload"></p>
<h2 id="äºŒè®°å¿†ç»„ä»¶å®ç°åŸç†">äºŒã€è®°å¿†ç»„ä»¶å®ç°åŸç†</h2>
<p>ä¸€ä¸ªè®°å¿†ç»„ä»¶è¦å®ç°çš„ä¸‰ä¸ªæœ€åŸºæœ¬åŠŸèƒ½ï¼š</p>
<ul>
<li>è¯»å–è®°å¿†ç»„ä»¶ä¿å­˜çš„å†å²å¯¹è¯ä¿¡æ¯</li>
<li>å†™å…¥å†å²å¯¹è¯ä¿¡æ¯åˆ°è®°å¿†ç»„ä»¶</li>
<li>å­˜å‚¨å†å²å¯¹è¯æ¶ˆæ¯</li>
</ul>
<p>åœ¨LangChainä¸­ï¼Œç»™å¤§è¯­è¨€æ¨¡å‹æ·»åŠ è®°å¿†åŠŸèƒ½çš„æ–¹æ³•ï¼š</p>
<ul>
<li>åœ¨é“¾æ‰§è¡Œå‰ï¼Œå°†å†å²æ¶ˆæ¯ä»è®°å¿†ç»„ä»¶è¯»å–å‡ºæ¥ï¼Œå’Œç”¨æˆ·è¾“å…¥ä¸€èµ·æ·»åŠ åˆ°æç¤ºè¯ä¸­ï¼Œä¼ é€’ç»™å¤§è¯­è¨€æ¨¡å‹ã€‚</li>
<li>åœ¨é“¾æ‰§è¡Œå®Œæ¯•åï¼Œå°†ç”¨æˆ·çš„è¾“å…¥å’Œå¤§è¯­è¨€æ¨¡å‹è¾“å‡ºï¼Œä¸€èµ·å†™å…¥åˆ°è®°å¿†ç»„ä»¶ä¸­</li>
<li>ä¸‹ä¸€æ¬¡è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹æ—¶ï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹</li>
</ul>
<p>è¿™æ ·å¤§è¯­è¨€æ¨¡å‹å°±æ‹¥æœ‰äº†â€œè®°å¿†â€åŠŸèƒ½ï¼Œä¸Šè¿°å®ç°è®°å¿†åŠŸèƒ½çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š<br>
<img alt="image-20250728213831347" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1495546/202508/1495546-20250806093445643-909651839.png" class="lazyload"></p>
<h2 id="ä¸‰è®°å¿†ç»„ä»¶ä»‹ç»">ä¸‰ã€è®°å¿†ç»„ä»¶ä»‹ç»</h2>
<h3 id="31-å¸¸è§è®°å¿†ç»„ä»¶">3.1 å¸¸è§è®°å¿†ç»„ä»¶</h3>
<p>LangChainä¸­çš„è®°å¿†ç»„ä»¶ç»§æ‰¿å…³ç³»å›¾å¦‚ä¸‹ï¼Œæ‰€æœ‰å¸¸ç”¨çš„è®°å¿†ç»„ä»¶éƒ½ç»§æ‰¿è‡ª<code>BaseChatMemory</code>ç±»ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±æƒ³å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„è®°å¿†ç»„ä»¶ä¹Ÿå¯ä»¥ç»§æ‰¿<code>BaseChatMemory</code>ã€‚</p>
<p><img alt="image-20250729100724121" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1495546/202508/1495546-20250806093458039-135967567.png" class="lazyload"></p>
<p>ä¸‹é¢æ˜¯LangChainä¸­å¸¸ç”¨è®°å¿†ç»„ä»¶ä»¥åŠå®ƒä»¬çš„ç‰¹æ€§ã€‚</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶åç§°</th>
<th>ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConversationBufferMemory</td>
<td>ä¿å­˜æ‰€æœ‰çš„å†å²å¯¹è¯ä¿¡æ¯</td>
</tr>
<tr>
<td>ConversationBufferWindowMemory</td>
<td>ä¿å­˜æœ€è¿‘Nè½®å¯¹è¯å†…å®¹</td>
</tr>
<tr>
<td>ConversationSummaryMemory</td>
<td>å‹ç¼©å†å²å¯¹è¯ä¸ºæ‘˜è¦ä¿¡æ¯</td>
</tr>
<tr>
<td>ConversationSummaryBufferMemory</td>
<td>ç»“åˆç¼“å­˜å’Œæ‘˜è¦ä¿¡æ¯</td>
</tr>
<tr>
<td>ConversationTokenBufferMemory</td>
<td>åŸºäºtokené™åˆ¶çš„å†å²å¯¹è¯ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h3 id="32-basechatmemoryç®€ä»‹">3.2 BaseChatMemoryç®€ä»‹</h3>
<p>ä¸‹é¢å¯¹<code>BaseChatMemory</code>çš„æ ¸å¿ƒå±æ€§ä¸æ–¹æ³•è¿›è¡Œåˆ†æï¼š</p>
<p><strong>1ã€å±æ€§ï¼š</strong></p>
<p><strong>chat_memory</strong>: BaseChatMessageHistoryç±»çš„çš„å¯¹è±¡ï¼Œ<code>BaseChatMessageHistory</code>æ˜¯çœŸæ­£å®ç°ä¿å­˜å†å²å¯¹è¯ä¿¡æ¯åŠŸèƒ½çš„ç±»ï¼Œè¿™é‡Œ<code>BaseChatMemory</code>å¹¶æ²¡æœ‰åœ¨è‡ªèº«å»å®ç°èŠå¤©æ¶ˆæ¯çš„ä¿å­˜ï¼Œè€Œæ˜¯æŠ½è±¡å‡º<code>BaseChatMessageHistory</code>ç±»ï¼Œä¿æŒå„ä¸ªç±»éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œè¿™æ ·åšæ›´åˆ©äºé¡¹ç›®çš„æ‰©å±•å’Œè§£è€¦ã€‚</p>
<pre><code class="language-python">chat_memory: BaseChatMessageHistory = Field(
    default_factory=InMemoryChatMessageHistory
)
</code></pre>
<p><strong>2ã€æ–¹æ³•</strong></p>
<p><code>save_context()</code>ï¼šåŒæ­¥ä¿å­˜å†å²æ¶ˆæ¯</p>
<p><code>load_memory_variables()</code>ï¼šåŠ è½½å†å²è®°å¿†ä¿¡æ¯</p>
<p><code>clear()</code>ï¼šåŒæ­¥æ¸…ç©ºå†å²è®°å¿†ä¿¡æ¯</p>
<h3 id="33-basechatmessagehistoryç®€ä»‹">3.3 BaseChatMessageHistoryç®€ä»‹</h3>
<p><code>BaseChatMessageHistory</code>æ˜¯ç”¨æ¥ä¿å­˜èŠå¤©æ¶ˆæ¯å†å²çš„æŠ½è±¡åŸºç±»ï¼Œä¸‹é¢å¯¹<code>BaseChatMessageHistory</code>çš„æ ¸å¿ƒå±æ€§ä¸æ–¹æ³•è¿›è¡Œåˆ†æï¼š</p>
<p><strong>1.å±æ€§ï¼š</strong></p>
<p><code>messages: List[BaseMessage]</code>ï¼šç”¨æ¥æ¥æ”¶å’Œè¯»å–å†å²æ¶ˆæ¯çš„åªè¯»å±æ€§</p>
<p><strong>2.æ–¹æ³•ï¼š</strong></p>
<p><code>add_messages</code>ï¼šæ‰¹é‡æ·»åŠ æ¶ˆæ¯ï¼Œé»˜è®¤å®ç°æ˜¯æ¯ä¸ªæ¶ˆæ¯éƒ½å»è°ƒç”¨ä¸€æ¬¡add_message</p>
<p><code>add_message</code>ï¼šå•ç‹¬æ·»åŠ æ¶ˆæ¯ï¼Œå®ç°ç±»å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p>
<p><code>clear()</code>ï¼šæ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯ï¼Œå®ç°ç±»å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•</p>
<p>BaseChatMessageHistoryå¸¸è§å®ç°ç±»å¦‚ä¸‹ï¼š</p>
<p><img alt="image-20250729124902104" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1495546/202508/1495546-20250806093525262-906888160.png" class="lazyload"></p>
<p>ä¸‹é¢æ˜¯LangChainä¸­å¸¸ç”¨çš„æ¶ˆæ¯å†å²ç»„ä»¶ä»¥åŠå®ƒä»¬çš„ç‰¹æ€§ï¼Œå…¶ä¸­<code>InMemoryChatMessageHistory</code>æ˜¯<code>BaseChatMemory</code>é»˜è®¤ä½¿ç”¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶ã€‚</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶åç§°</th>
<th>ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>InMemoryChatMessageHistory</td>
<td>åŸºäºå†…å­˜å­˜å‚¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶</td>
</tr>
<tr>
<td>FileChatMessageHistory</td>
<td>åŸºäºæ–‡ä»¶å­˜å‚¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶</td>
</tr>
<tr>
<td>RedisChatMessageHistory</td>
<td>åŸºäºRediså­˜å‚¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶</td>
</tr>
<tr>
<td>ElasticsearchChatMessageHistory</td>
<td>åŸºäºESå­˜å‚¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶</td>
</tr>
</tbody>
</table>
<h2 id="å››è®°å¿†ç»„ä»¶ä½¿ç”¨æ–¹æ³•">å››ã€è®°å¿†ç»„ä»¶ä½¿ç”¨æ–¹æ³•</h2>
<p>ä¸‹é¢ä»¥æœ€å…¸å‹çš„<code>ConversationBufferWindowMemory</code>ç±»å’Œ<code>ConversationSummaryBufferMemory</code>ç±»ä½œä¸ºç¤ºä¾‹ï¼Œæ¥æ¼”ç¤ºè®°å¿†ç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<h3 id="41-conversationbufferwindowmemoryç”¨æ³•">4.1 ConversationBufferWindowMemoryç”¨æ³•</h3>
<p><code>ConversationBufferMemory</code>æ˜¯LangChainä¸­æœ€ç®€å•çš„è®°å¿†ç»„ä»¶ï¼Œå®ƒåªæ˜¯ç®€å•å°†æ‰€æœ‰çš„å†å²å¯¹è¯ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œè€Œ<code>ConversationBufferWindowMemory</code>ä¸<code>ConversationBufferMemory</code>çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š<code>ConversationBufferWindowMemory</code>å¢åŠ äº†ä¸€ä¸ªé™åˆ¶ï¼Œ<code>ConversationBufferWindowMemory</code>åªè¿”å›æœ€è¿‘Kè½®å¯¹è¯çš„å†å²è®°å¿†ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨å®ç°å†å²è®°å¿†å’Œå¤§è¯­è¨€æ¨¡å‹tokenæ¶ˆè€—ä¹‹é—´å¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ï¼Œå¦‚æœæ¯æ¬¡æºå¸¦çš„å†å²æ¶ˆæ¯å¤ªé•¿ï¼Œé‚£ä¹ˆæ¯æ¬¡æ¶ˆè€—çš„tokenæ•°é‡éƒ½ä¼šéå¸¸å¤šã€‚</p>
<p><code>ConversationBufferWindowMemory</code>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œåˆ›å»º<code>ConversationBufferWindowMemory</code>æŒ‡å®š<code>return_messages</code>ä¸ºTrueï¼Œè¡¨ç¤ºåŠ è½½å†å²æ¶ˆæ¯æ—¶è¿”å›æ¶ˆæ¯åˆ—è¡¨è€Œéå­—ç¬¦ä¸²ï¼ŒæŒ‡å®škä¸º2ï¼Œè¡¨ç¤ºæœ€å¤šè¿”å›ä¸¤è½®å¯¹è¯çš„å†å²è®°å¿†ã€‚</p>
<p>åœ¨é“¾çš„ç¬¬ä¸€ä¸ªå¯è¿è¡Œç»„ä»¶ä½ç½®ï¼Œè°ƒç”¨äº†memoryç»„ä»¶ï¼Œå¹¶è¯»å–äº†å†å²è®°å¿†ï¼Œå‘è¾“å…¥å‚æ•°åˆ—è¡¨ä¸­æ·»åŠ äº†ä¸€ä¸ªhistoryå‚æ•°ï¼Œå®ƒçš„å€¼å°±æ˜¯å†å²è®°å¿†ä¿¡æ¯ï¼Œç»§ç»­ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªå¯è¿è¡Œç»„ä»¶ï¼Œåœ¨æ¸²æŸ“æç¤ºè¯æ¨¡æ¿æ—¶å³å¯ä½¿ç”¨å†å²è®°å¿†ä¿¡æ¯ï¼Œå†å²è®°å¿†ä¿¡æ¯å°±å’Œç”¨æˆ·æé—®ä¸€èµ·ä¼ é€’ç»™äº†å¤§è¯­è¨€æ¨¡å‹ï¼Œå¤§è¯­è¨€æ¨¡å‹å°±æ‹¥æœ‰äº†å†å²è®°å¿†ã€‚</p>
<pre><code class="language-python">from operator import itemgetter

import dotenv
from langchain.memory import ConversationBufferWindowMemory
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_openai import ChatOpenAI

# è¯»å–envé…ç½®
dotenv.load_dotenv()

# 1.åˆ›å»ºæç¤ºè¯æ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    MessagesPlaceholder("chat_history"),
    ("human", "{question}"),
])

# 2.æ„å»ºGPT-3.5æ¨¡å‹
llm = ChatOpenAI(model="gpt-3.5-turbo")

# 3.åˆ›å»ºè¾“å‡ºè§£æå™¨
parser = StrOutputParser()

memory = ConversationBufferWindowMemory(return_messages=True, k=2)

# 4.æ‰§è¡Œé“¾
chain = RunnablePassthrough.assign(
    chat_history=(RunnableLambda(memory.load_memory_variables) | itemgetter("history"))
) | prompt | llm | parser

while True:
    question = input("Humanï¼š")
    response = chain.invoke({"question": question})
    print(f"AIï¼š{response}")
    memory.save_context({"human": question}, {"ai": response})
</code></pre>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œç¬¬ä¸€è½®å¯¹è¯ä¸­ï¼ŒHumanå‘Šè¯‰AIï¼Œä»–å«å¤§å¿—ï¼Œéšåçš„ä¸€è½®å¯¹è¯ï¼Œæ˜¾ç„¶AIå·²ç»è®°ä½äº†Humançš„åå­—ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬è®¾ç½®çš„kå€¼æ˜¯2ï¼Œåœ¨è¶…è¿‡ä¸¤è½®å¯¹è¯ä¹‹åå¤§è¯­è¨€æ¨¡å‹å°±åˆè¿›å…¥å¤±å¿†çŠ¶æ€äº†ã€‚</p>
<pre><code class="language-python">Humanï¼šæˆ‘æ˜¯å¤§å¿—ï¼Œä½ æ˜¯
AIï¼šä½ å¥½ï¼Œå¤§å¿—ï¼æˆ‘æ˜¯ChatGPTï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚ä½ ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ
Humanï¼šæˆ‘æ˜¯è°
AIï¼šä½ æ˜¯å¤§å¿—å‘€ï¼ä¸è¿‡å¦‚æœä½ æ˜¯æƒ³æ¢ç´¢ä¸€ä¸‹â€œæˆ‘æ˜¯è°â€è¿™ä¸ªå“²å­¦é—®é¢˜ï¼Œé‚£å°±æŒºæœ‰æ„æ€çš„ã€‚ä½ è§‰å¾—è‡ªå·±æ˜¯è°ï¼Ÿ
Humanï¼šå†°æ³‰å†·æ¶©å¼¦å‡ç»
AIï¼šå“¦ï¼Œè¿™å¥å‡ºè‡ªå”ä»£è¯äººææ¸…ç…§çš„ã€Šå¦‚æ¢¦ä»¤ã€‹ã€‚æ•´å¥æ˜¯ï¼š
**å†°æ³‰å†·æ¶©å¼¦å‡ç»ï¼Œå‡ç»ä¸é€šå£°æš‚æ­‡ã€‚**

Humanï¼šåˆ«æœ‰å¿§æ„æš—æ¨ç”Ÿ
AIï¼šè¿™å¥å‡ºè‡ªææ¸…ç…§çš„ã€Šå¦‚æ¢¦ä»¤Â·å¸¸è®°æºªäº­æ—¥æš®ã€‹ï¼š

**â€œåˆ«æœ‰å¿§æ„æš—æ¨ç”Ÿã€‚â€**

å¥¹åœ¨è¿™å¥è¯ä¸­è¡¨è¾¾çš„æ˜¯æ·±æ·±çš„å†…å¿ƒæ„ç»ªå’Œæ— æ³•è¨€è¯´çš„é—æ†¾ã€‚(çœç•¥ã€‚ã€‚ã€‚)
Humanï¼šæˆ‘æ˜¯è°
AIï¼šè¿™ä¸ªé—®é¢˜æœ‰ç‚¹å“²å­¦æ„å‘³äº†ï¼ä½ æ˜¯åœ¨é—®è‡ªæˆ‘è®¤çŸ¥å—ï¼Ÿè¿˜æ˜¯åœ¨æƒ³â€œæˆ‘æ˜¯è°â€è¿™ä¸ªæ›´æ·±å±‚æ¬¡çš„å­˜åœ¨æ„ä¹‰ï¼Ÿæ¯ä¸ªäººå¯¹â€œæˆ‘æ˜¯è°â€çš„ç­”æ¡ˆéƒ½ä¸ä¸€æ ·ï¼Œè¿™ä¹Ÿè®¸æ˜¯ä¸€ä¸ªå¯ä»¥ä¸æ–­æ¢ç´¢ã€å˜åŒ–çš„è¿‡ç¨‹ã€‚ä½ æ˜¯æƒ³èŠèŠè¿™ä¸ªè¯é¢˜å—ï¼Ÿ
Humanï¼šæˆ‘çš„åå­—æ˜¯ä»€ä¹ˆ
AIï¼šå—¯ï¼Œæˆ‘å¹¶ä¸çŸ¥é“ä½ çš„åå­—å“¦ï¼ä½†å¦‚æœä½ æ„¿æ„å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šå¾ˆé«˜å…´è®°ä½çš„ã€‚ä½ å–œæ¬¢ä»€ä¹ˆåå­—å‘¢ï¼Ÿæˆ–è€…ï¼Œä½ å¯¹åå­—æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æƒ³æ³•å—ï¼Ÿ
Humanï¼š
</code></pre>
<h3 id="42-conversationsummarybuffermemoryç”¨æ³•">4.2 ConversationSummaryBufferMemoryç”¨æ³•</h3>
<p><code>ConversationSummaryBufferMemory</code>çš„ç”¨æ³•å’Œä¸Šé¢çš„<code>ConversationBufferWindowMemory</code>åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«æ˜¯<code>ConversationSummaryBufferMemory</code>æ˜¯ä¸€ä¸ªç¼“å†²æ‘˜è¦æ··åˆè®°å¿†ç»„ä»¶ï¼Œ<code>ConversationSummaryBufferMemory</code>æ”¯æŒå½“å†å²è®°å¿†è¶…è¿‡æŒ‡å®šçš„tokenæ•°é‡å°±ä¼šä½¿ç”¨æŒ‡å®šçš„llmè¿›è¡Œæ‘˜è¦çš„æå–ï¼Œä¹Ÿå°±æ˜¯å¯¹åŸæœ¬çš„å¯¹è¯å†…å®¹è¿›è¡Œæ¦‚æ‹¬ï¼Œå†å­˜å‚¨åˆ°è®°å¿†ç»„ä»¶ï¼Œè¿™æ ·å°±èµ·åˆ°äº†èŠ‚çœtokençš„ä½œç”¨ã€‚</p>
<p>ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼Œä¸ºäº†æ¼”ç¤º<code>ConversationSummaryBufferMemory</code>çš„å®é™…æ•ˆæœï¼Œ<code>max_token_limit</code>æŒ‡å®šä¸º200ï¼Œå¹¶ä¸”ä¸ºllmå‚æ•°ä¼ å…¥ä¸€ä¸ªåŸºäºgpt-3.5-turboå¤§è¯­è¨€æ¨¡å‹å¯¹è±¡ã€‚</p>
<pre><code class="language-python">from operator import itemgetter

import dotenv
from langchain.memory import ConversationSummaryBufferMemory
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_openai import ChatOpenAI

# è¯»å–envé…ç½®
dotenv.load_dotenv()

# 1.åˆ›å»ºæç¤ºè¯æ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    MessagesPlaceholder("chat_history"),
    ("human", "{question}"),
])

# 2.æ„å»ºGPT-3.5æ¨¡å‹
llm = ChatOpenAI(model="gpt-3.5-turbo")

# 3.åˆ›å»ºè¾“å‡ºè§£æå™¨
parser = StrOutputParser()

memory = ConversationSummaryBufferMemory(return_messages=True,
                                         max_token_limit=200,
                                         llm=ChatOpenAI(model="gpt-3.5-turbo")
                                         )

# 4.æ‰§è¡Œé“¾
chain = RunnablePassthrough.assign(
    chat_history=(RunnableLambda(memory.load_memory_variables) | itemgetter("history"))
) | prompt | llm | parser

while True:
    print("========================")
    question = input("Humanï¼š")
    response = chain.invoke({"question": question})
    print(f"AIï¼š{response}")
    memory.save_context({"human": question}, {"ai": response})
    print("========================")
    print(f"å¯¹è¯å†å²ä¿¡æ¯ï¼š{memory.load_memory_variables({})}")

</code></pre>
<p>æ‰§è¡Œç»“æœï¼Œé¦–å…ˆHumanæé—®è¯¦ç»†ä»‹ç»LangChainæ¡†æ¶ç”¨æ³•ï¼ŒAIå›å¤çš„å†…å®¹éå¸¸å¤šï¼Œè‚¯å®šè¶…è¿‡äº†200ä¸ªtokenï¼Œå†æ¬¡è¯»å–èŠå¤©å†å²æ¶ˆæ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¤šäº†ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯ç”¨è‹±æ–‡æè¿°çš„ã€‚</p>
<p>è¿™æ®µè‹±æ–‡æè¿°å°±æ˜¯å¯¹ä¹‹å‰å¯¹è¯å†…å®¹çš„æ‘˜è¦ï¼Œä¹‹æ‰€ä»¥å†…å®¹æ˜¯è‹±æ–‡çš„ï¼Œå› ä¸ºç”Ÿæˆæ‘˜è¦çš„æç¤ºè¯æ˜¯LangChianå†…ç½®çš„ï¼Œæœ¬èº«å°±æ˜¯è‹±æ–‡çš„ï¼Œåœ¨ä¸­æ–‡åœºæ™¯ä¸‹ä½¿ç”¨éœ€è¦å¯¹æç¤ºè¯è¿›è¡Œæ±‰åŒ–ï¼Œå¯ä»¥æŒ‡å®špromptå±æ€§ä¸ºè‡ªå®šä¹‰çš„æç¤ºè¯ã€‚</p>
<pre><code class="language-python">========================
Humanï¼šè¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹LangChainæ¡†æ¶çš„ç”¨æ³•
AIï¼š**LangChain** æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸºäºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚å®ƒæä¾›äº†å¼ºå¤§çš„åŠŸèƒ½æ¥å¤„ç†è¯­è¨€æ¨¡å‹ä¸å¤–éƒ¨æ•°æ®çš„äº¤äº’ã€è‡ªåŠ¨åŒ–ä»»åŠ¡å’Œå¤šç§æ•°æ®æºçš„å¤„ç†ï¼Œå¸®åŠ©å¼€å‘è€…æ›´é«˜æ•ˆåœ°æ„å»ºåº”ç”¨ã€‚

(ä¸­é—´å†…å®¹çœç•¥)

å¦‚æœä½ æƒ³å¼€å§‹ä½¿ç”¨ LangChainï¼Œå¯ä»¥ä»åŸºæœ¬çš„ LLM è°ƒç”¨å’Œç®€å•çš„é“¾å¼æ“ä½œå…¥æ‰‹ï¼Œé€æ¸æ‰©å±•åˆ°æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚
========================
å¯¹è¯å†å²ä¿¡æ¯ï¼š{'history': [SystemMessage(content='The human asks for a detailed introduction to the LangChain framework. The AI explains that LangChain is a framework designed for building applications based on large language models (LLMs), offering functionality for interacting with external data, automating tasks, and processing various data sources. The framework is especially useful for scenarios like building chat systems, document retrieval, API calls, and task automation.\n\nThe AI then breaks down LangChainâ€™s core components and usage, starting with LLM integration, prompt templates, chains, agents, memory, document loaders, and tools &amp; APIs. Examples for each component are provided to demonstrate practical implementation.\n\nFinally, the AI compares LangChain to other frameworks, highlighting its advantages such as chain operations, external tool integration, memory management, and modularity, making it a versatile choice for developing complex LLM applications. LangChain is presented as a flexible toolset for tasks ranging from customer service to automated workflows, with an emphasis on its ability to handle complex tasks efficiently.\n\nEND OF SUMMARY.')]}
========================
Humanï¼š
</code></pre>
<h3 id="43-å†å²æ¶ˆæ¯çš„å­˜å‚¨">4.3 å†å²æ¶ˆæ¯çš„å­˜å‚¨</h3>
<p>åœ¨å‰ä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œç¨‹åºé‡å¯ä¹‹åï¼Œå¤§è¯­è¨€æ¨¡å‹çš„å†å²è®°å¿†å°±ä¼šä¸¢å¤±ï¼Œå› ä¸ºåœ¨<code>BaseChatMemory</code>å†…éƒ¨é»˜è®¤ä½¿ç”¨çš„èŠå¤©æ¶ˆæ¯å†å²ç»„ä»¶æ˜¯åŸºäºå†…å­˜å­˜å‚¨çš„<code>InMemoryChatMessageHistory</code>å¯¹è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥<code>FileChatMessageHistory</code>ä¸ºä¾‹ï¼Œå°†å†å²æ¶ˆæ¯æŒä¹…åŒ–åˆ°å½“å‰ç›®å½•çš„chat_history.txtæ–‡ä»¶ä¸­ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from operator import itemgetter

import dotenv
from langchain.memory import ConversationBufferMemory
from langchain_community.chat_message_histories import FileChatMessageHistory
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_openai import ChatOpenAI

# è¯»å–envé…ç½®
dotenv.load_dotenv()

# 1.åˆ›å»ºæç¤ºè¯æ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    MessagesPlaceholder("chat_history"),
    ("human", "{question}"),
])

# 2.æ„å»ºGPT-3.5æ¨¡å‹
llm = ChatOpenAI(model="gpt-3.5-turbo")

# 3.åˆ›å»ºè¾“å‡ºè§£æå™¨
parser = StrOutputParser()

memory = ConversationBufferMemory(
    return_messages=True,
    chat_memory=FileChatMessageHistory("chat_history.txt")
)

# 4.æ‰§è¡Œé“¾
chain = RunnablePassthrough.assign(
    chat_history=(RunnableLambda(memory.load_memory_variables) | itemgetter("history"))
) | prompt | llm | parser

while True:
    question = input("Humanï¼š")
    response = chain.invoke({"question": question})
    print(f"AIï¼š{response}")
    memory.save_context({"human": question}, {"ai": response})

</code></pre>
<p>æ‰§è¡Œä¸Šé¢çš„ç¨‹åºï¼Œè¿›è¡Œå¯¹è¯</p>
<pre><code>Humanï¼šä½ å¥½ï¼Œæˆ‘æ˜¯å¤§å¿—ï¼Œä½ æ˜¯
AIï¼šä½ å¥½ï¼Œå¤§å¿—ï¼æˆ‘æ˜¯ChatGPTï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚ä½ ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ
Humanï¼šæˆ‘çš„åå­—æ˜¯
AIï¼šå“¦ï¼Œä½ çš„åå­—æ˜¯å¤§å¿—ï¼åˆšæ‰æˆ‘ç†è§£é”™äº†ã€‚é‚£ä½ å¹³æ—¶å–œæ¬¢åšä»€ä¹ˆï¼Ÿ
Humanï¼š
</code></pre>
<p>æ‰§è¡Œäº†ä¸¤è½®å¯¹è¯åï¼Œåœ¨å½“å‰ç›®å½•å°±ä¼šç”Ÿæˆä¿å­˜äº†èŠå¤©å†å²æ¶ˆæ¯çš„chat_history.txtæ–‡ä»¶ã€‚</p>
<p><img alt="image-20250729162336857" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1495546/202508/1495546-20250806093550621-451412948.png" class="lazyload"></p>
<p>chat_history.txt æ–‡ä»¶å†…å®¹</p>
<pre><code class="language-json">[{"type": "human", "data": {"content": "\u4f60\u597d\uff0c\u6211\u662f\u5927\u5fd7\uff0c\u4f60\u662f", "additional_kwargs": {}, "response_metadata": {}, "type": "human", "name": null, "id": null, "example": false}}, {"type": "ai", "data": {"content": "\u4f60\u597d\uff0c\u5927\u5fd7\uff01\u6211\u662fChatGPT\uff0c\u5f88\u9ad8\u5174\u8ba4\u8bc6\u4f60\u3002\u4f60\u4eca\u5929\u600e\u4e48\u6837\uff1f", "additional_kwargs": {}, "response_metadata": {}, "type": "ai", "name": null, "id": null, "example": false, "tool_calls": [], "invalid_tool_calls": [], "usage_metadata": null}}, {"type": "human", "data": {"content": "\u6211\u7684\u540d\u5b57\u662f", "additional_kwargs": {}, "response_metadata": {}, "type": "human", "name": null, "id": null, "example": false}}, {"type": "ai", "data": {"content": "\u54e6\uff0c\u4f60\u7684\u540d\u5b57\u662f\u5927\u5fd7\uff01\u521a\u624d\u6211\u7406\u89e3\u9519\u4e86\u3002\u90a3\u4f60\u5e73\u65f6\u559c\u6b22\u505a\u4ec0\u4e48\uff1f", "additional_kwargs": {}, "response_metadata": {}, "type": "ai", "name": null, "id": null, "example": false, "tool_calls": [], "invalid_tool_calls": [], "usage_metadata": null}}]
</code></pre>
<p>å…³é—­ç¨‹åºï¼Œé‡æ–°å¯åŠ¨ç¨‹åºï¼Œå¤§è¯­è¨€æ¨¡å‹ä¾ç„¶è®°å¾—ç”¨æˆ·çš„åå­—ã€‚</p>
<pre><code class="language-python">Humanï¼šæˆ‘çš„åå­—æ˜¯ä»€ä¹ˆ
AIï¼šä½ çš„åå­—æ˜¯å¤§å¿—ï¼ğŸ˜„ æœ‰ä»€ä¹ˆæƒ³åˆ†äº«çš„å…³äºè¿™ä¸ªåå­—çš„æ•…äº‹å—ï¼Ÿ
Humanï¼š
</code></pre>
<h2 id="äº”æ€»ç»“">äº”ã€æ€»ç»“</h2>
<p>æœ¬æ–‡ä»‹ç»äº†LangChainè®°å¿†ç»„ä»¶çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚é€šè¿‡è®°å¿†ç»„ä»¶æœ‰æ•ˆè§£å†³äº†å¤§è¯­è¨€æ¨¡å‹"å¤±å¿†"çš„é—®é¢˜ï¼Œèƒ½è®©AIè®°ä½å¤šè½®ä¸Šä¸‹æ–‡å¯¹è¯ã€‚LangChainæä¾›äº†å¤šç§è®°å¿†ç»„ä»¶ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„è®°å¿†ç»„ä»¶å’Œå­˜å‚¨æ–¹å¼ã€‚</p>
<p>å¼€å‘é˜¶æ®µå¯ä»¥ä½¿ç”¨åŸºäºå†…å­˜çš„<code>InMemoryChatMessageHistory</code>ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é€‰æ‹©<code>FileChatMessageHistory</code>æˆ–<code>RedisChatMessageHistory</code>è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®°å¿†ç»„ä»¶ä¼šå¢åŠ tokenæ¶ˆè€—ï¼Œè¦åœ¨ç”¨æˆ·ä½“éªŒå’Œæˆæœ¬æ§åˆ¶ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ã€‚</p>
<p>é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œç›¸ä¿¡ä½ å·²ç»èƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨è¿™äº›è®°å¿†ç»„ä»¶ï¼Œæ„å»ºå‡ºæœ‰è‰¯å¥½ç”¨æˆ·ä½“éªŒçš„AIåº”ç”¨ï¼Œåç»­å°†ç»§ç»­æ·±å…¥ä»‹ç»LangChainçš„æ ¸å¿ƒæ¨¡å—å’Œé«˜çº§ç”¨æ³•ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-08-06 09:36">2025-08-06 09:36</span>&nbsp;
<a href="https://www.cnblogs.com/fengyun2019">å¤§å¿—è¯´ç¼–ç¨‹</a>&nbsp;
é˜…è¯»(<span id="post_view_count">110</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19024465);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19024465', targetLink: 'https://www.cnblogs.com/fengyun2019/p/19024465', title: 'LangChainæ¡†æ¶å…¥é—¨08ï¼šå…¨æ–¹ä½è§£æè®°å¿†ç»„ä»¶' })">ä¸¾æŠ¥</a>
</div>
        