
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zxyyds/p/18969553" title="发布于 2025-07-06 23:15">
    <span role="heading" aria-level="2">抓包经验</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="对讲终端脱机抓包通用分析指南">对讲终端脱机抓包通用分析指南</h1>
<h2 id="目录">目录</h2>
<ol>
<li><a href="#1-%E6%8A%93%E5%8C%85%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5" rel="noopener nofollow">抓包准备阶段</a></li>
<li><a href="#2-%E6%8A%93%E5%8C%85%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4" rel="noopener nofollow">抓包操作步骤</a></li>
<li><a href="#3-wireshark%E5%88%86%E6%9E%90%E5%85%B3%E9%94%AE%E7%82%B9" rel="noopener nofollow">Wireshark分析关键点</a></li>
<li><a href="#4-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" rel="noopener nofollow">常见问题解决方案</a></li>
<li><a href="#5-%E9%AB%98%E7%BA%A7%E5%88%86%E6%9E%90%E6%8A%80%E5%B7%A7" rel="noopener nofollow">高级分析技巧</a></li>
<li><a href="#6-%E6%97%A0%E6%B3%95%E8%A7%A3%E5%86%B3%E6%97%B6%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%93%8D%E4%BD%9C" rel="noopener nofollow">无法解决时的进一步操作</a></li>
</ol>
<hr>
<h2 id="1-抓包准备阶段">1. 抓包准备阶段</h2>
<h3 id="11-确定抓包位置">1.1 确定抓包位置</h3>
<ul>
<li><strong>关键接口</strong>：在服务器上抓取与问题终端通信的网卡流量（通常是对讲系统使用的业务网卡）</li>
<li><strong>辅助接口</strong>：若服务器有多个网卡（如管理网卡、业务网卡），需确认目标终端连接的物理端口或VLAN</li>
</ul>
<h3 id="12-安装wireshark">1.2 安装Wireshark</h3>
<ul>
<li>
<p><strong>Windows服务器</strong>：</p>
<ul>
<li>官网下载安装包：<a href="https://www.wireshark.org/" target="_blank" rel="noopener nofollow">https://www.wireshark.org/</a></li>
<li>安装时勾选 <strong>Npcap</strong>（WinPcap的替代品，支持现代Windows）</li>
</ul>
</li>
<li>
<p><strong>Linux服务器</strong>：</p>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt update
sudo apt install wireshark
sudo usermod -aG wireshark $USER  # 将当前用户加入wireshark组
newgrp wireshark                 # 刷新组权限             # 刷新组权限
</code></pre>
</li>
</ul>
<h3 id="13-配置镜像端口如需跨设备抓包">1.3 配置镜像端口（如需跨设备抓包）</h3>
<ul>
<li><strong>若问题终端与服务器不在同一设备</strong>：
<ul>
<li>在交换机上配置端口镜像，将目标终端的流量镜像到服务器网卡</li>
<li>示例命令（华为交换机）：<pre><code class="language-bash">observe-port 1 interface GigabitEthernet0/0/1  # 镜像到服务器所连端口
interface GigabitEthernet0/0/2                  # 问题终端所连端口
port-mirroring to observe-port 1 both           # 镜像进出双向流量
</code></pre>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="2-抓包操作步骤">2. 抓包操作步骤</h2>
<h3 id="21-启动wireshark并选择网卡">2.1 启动Wireshark并选择网卡</h3>
<pre><code class="language-bash">sudo wireshark  # Linux需提权，Windows直接打开
</code></pre>
<ul>
<li>选择服务器与终端通信的网卡（如 <code>eth0</code> 或 <code>192.168.1.x</code> 对应的接口）</li>
</ul>
<h3 id="22-设置抓包过滤器减少噪声">2.2 设置抓包过滤器（减少噪声）</h3>
<ul>
<li><strong>基础过滤</strong>（根据终端IP）：<pre><code>ip.addr == 192.168.1.100  # 替换为目标终端的IP
</code></pre>
</li>
<li><strong>协议过滤</strong>（常见对讲协议）：<pre><code>udp.port == 5060 || udp.port == 10000-20000  # SIP+语音端口范围
|| tcp.port == 80 || udp.port == 5061        # HTTP/HTTPS/SIPS
</code></pre>
</li>
</ul>
<h3 id="23-开始抓包并重现问题">2.3 开始抓包并重现问题</h3>
<ol>
<li>点击 <strong>鲨鱼鳍图标</strong> 开始捕获</li>
<li><strong>立即操作</strong>：从问题终端发起一次呼叫（触发"目标脱机"提示）</li>
<li>问题复现后，点击 <strong>红色停止按钮</strong> 结束抓包</li>
</ol>
<h3 id="24-保存抓包数据">2.4 保存抓包数据</h3>
<ul>
<li><code>File &gt; Save As</code> 保存为 <code>广播服务器_目标脱机.pcapng</code></li>
</ul>
<hr>
<h2 id="3-wireshark分析关键点">3. Wireshark分析关键点</h2>
<h3 id="31-检查目标终端可达性">3.1 检查目标终端可达性</h3>
<ul>
<li><strong>ARP解析</strong>：搜索目标终端IP的ARP请求（过滤 <code>arp</code>）
<ul>
<li>若无ARP响应 → 终端离线或网络隔离</li>
</ul>
</li>
<li><strong>ICMP检测</strong>（若允许ping）：<pre><code>icmp &amp;&amp; ip.addr == 目标终端IP
</code></pre>
<ul>
<li>无ICMP Reply → 网络层不通</li>
</ul>
</li>
</ul>
<h3 id="32-分析呼叫信令流程">3.2 分析呼叫信令流程</h3>
<ul>
<li><strong>SIP协议分析</strong>（常见对讲系统协议）：
<ul>
<li>过滤：<code>sip</code> 或 <code>sip.Call-ID contains "会话ID"</code></li>
<li>正常流程：<code>INVITE → 100 Trying → 180 Ringing → 200 OK → ACK</code></li>
<li><strong>异常场景</strong>：
<ul>
<li><code>INVITE</code> 无响应 → 目标终端未收到请求（防火墙拦截/终端离线）</li>
<li><code>INVITE</code> 返回 <code>404 Not Found</code> → 终端未注册到服务器</li>
<li><code>INVITE</code> 返回 <code>503 Service Unavailable</code> → 服务器路由错误</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="33-检查终端注册状态">3.3 检查终端注册状态</h3>
<ul>
<li>过滤终端IP的注册请求：<pre><code>sip.Method == "REGISTER" &amp;&amp; ip.src == 目标终端IP
</code></pre>
</li>
<li>若最后一次 <code>REGISTER</code> 过期（查看 <code>Expires</code> 头），服务器会标记终端为离线</li>
</ul>
<h3 id="34-排查防火墙中间设备干扰">3.4 排查防火墙/中间设备干扰</h3>
<ul>
<li>查找 <strong>TCP RST</strong> 或 <strong>ICMP Destination Unreachable</strong> 数据包：<pre><code>tcp.flags.reset == 1 || icmp.type == 3
</code></pre>
</li>
<li>此类包表明流量被中间设备（防火墙、路由器）拦截</li>
</ul>
<h3 id="35-分析会话超时">3.5 分析会话超时</h3>
<ul>
<li>若呼叫建立后突然断开：
<ul>
<li>检查 <code>SIP BYE</code> 发起方（终端主动退出？）</li>
<li>查看 <strong>RTP流</strong>（语音流）是否中断：
<ul>
<li><code>Telephony &gt; RTP &gt; Stream Analysis</code> → 检查丢包率和抖动</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="4-常见问题解决方案">4. 常见问题解决方案</h2>
<table>
<thead>
<tr>
<th><strong>问题根因</strong></th>
<th><strong>解决方案</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>目标终端未注册</strong></td>
<td>1. 检查终端网络配置<br>2. 确认终端到服务器的5060/5061端口可达<br>3. 抓取终端侧日志</td>
</tr>
<tr>
<td><strong>SIP信令被防火墙拦截</strong></td>
<td>1. 在服务器/防火墙上放行UDP 5060-5080端口<br>2. 关闭服务器临时防火墙：<code>sudo ufw disable</code>（测试用）</td>
</tr>
<tr>
<td><strong>NAT穿透失败</strong></td>
<td>1. 服务器配置STUN/TURN服务<br>2. 修改SIP <code>Contact</code> 头为公网IP（如FreeSWITCH中设置<code>external_sip_ip</code>）</td>
</tr>
<tr>
<td><strong>终端心跳超时</strong></td>
<td>1. 延长SIP注册有效期（修改 <code>Expires</code> 值）<br>2. 配置OPTIONS心跳检测</td>
</tr>
<tr>
<td><strong>服务器路由表错误</strong></td>
<td>1. 检查SIP服务器配置（如FreeSWITCH的 <code>dialplan</code>）<br>2. 确认目标终端在注册数据库中的状态</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="5-高级分析技巧">5. 高级分析技巧</h2>
<ol>
<li>
<p><strong>绘制呼叫流程图</strong>：<br>
<code>Statistics &gt; Flow Graph</code> → 选择 "Limit to display filter"</p>
</li>
<li>
<p><strong>追踪特定会话</strong>：<br>
右键SIP数据包 → <code>Follow &gt; UDP Stream</code></p>
</li>
<li>
<p><strong>解码自定义协议</strong>：<br>
若使用私有协议，通过 <code>Analyze &gt; Decode As</code> 指定端口和协议类型</p>
</li>
<li>
<p><strong>时间分析</strong>：<br>
在问题时间点右键标记 → <code>Set Time Reference</code>，计算响应延迟</p>
</li>
</ol>
<hr>
<h2 id="6-无法解决时的进一步操作">6. 无法解决时的进一步操作</h2>
<ol>
<li>
<p><strong>交叉验证</strong>：</p>
<ul>
<li>在 <strong>目标终端侧抓包</strong>，对比服务器流量</li>
<li>在 <strong>交换机镜像口抓包</strong>，确认流量是否到达网络设备</li>
</ul>
</li>
<li>
<p><strong>收集日志</strong>：</p>
<ul>
<li>服务器日志（如FreeSWITCH的 <code>/var/log/freeswitch/freeswitch.log</code>）</li>
<li>终端日志（联系设备厂商获取）</li>
</ul>
</li>
<li>
<p><strong>协议模拟测试</strong>：<br>
使用 <code>sipsak</code> 或 <code>sipp</code> 工具模拟呼叫，隔离终端故障：</p>
<pre><code class="language-bash">sipsak -s sip:目标终端IP -v -U 问题终端IP
</code></pre>
</li>
</ol>
<hr>
<p><strong>最后更新日期</strong>：2025年7月6日</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.007638888888888889" data-date-updated="2025-07-06 23:26">2025-07-06 23:15</span>&nbsp;
<a href="https://www.cnblogs.com/zxyyds">帆再小也能远航</a>&nbsp;
阅读(<span id="post_view_count">1</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18969553);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18969553', targetLink: 'https://www.cnblogs.com/zxyyds/p/18969553', title: '抓包经验' })">举报</a>
</div>
        