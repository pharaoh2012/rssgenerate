
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/nanxi-xz/p/19032010" title="发布于 2025-08-13 02:42">
    <span role="heading" aria-level="2">将虚拟机从PVE上迁移至EXSI详细步骤！！！（避免踩坑）</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250813024134002-807998123.png" alt="将虚拟机从PVE上迁移至EXSI详细步骤！！！（避免踩坑）" class="desc_img">
        近期进行了大量虚拟机迁移的动作，从PVE到EXSI，从PVE到PVE，从EXSI到EXSI，从EXSI到PVE，可算是把这两个平台玩遍了，害，简单做个记录，因为从PVE到EXSI迁移比较麻烦，而且参考了网上很多文章，都写的不够完整，导致一步步踩了很多坑，为了大家以后减少不必要的麻烦，虚拟机迁移的事情看这篇文章就够了，坑已经给大家踩过了，不要在盲目的看别的文章了
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>近期进行了大量虚拟机迁移的动作，从PVE到EXSI，从PVE到PVE，从EXSI到EXSI，从EXSI到PVE，可算是把这两个平台玩遍了，害，简单做个记录，因为从PVE到EXSI迁移比较麻烦，而且参考了网上很多文章，都写的不够完整，导致一步步踩了很多坑，为了大家以后减少不必要的麻烦，虚拟机迁移的事情看这篇文章就够了，坑已经给大家踩过了，不要在盲目的看别的文章了</p>
</blockquote>
<p><strong>My Version:</strong>   <span style="background-color: rgba(255, 221, 221, 1); padding: 3px 8px; border-radius: 5px; color: rgba(179, 0, 0, 1)"><b>PVE:</b> 8.4.0</span> | <span style="background-color: rgba(221, 255, 221, 1); padding: 3px 8px; border-radius: 5px; color: rgba(0, 102, 0, 1)"><b>ESXi:</b> 7.0 Update 3</span></p>
<h3 id="1查看虚拟机状态停止虚拟机">1、查看虚拟机状态，停止虚拟机</h3>
<pre><code># 可选命令行或者web页面操作，web页面更为直观
qm list 
qm stop &lt;vmid&gt;
</code></pre>
<h3 id="2确定虚拟机磁盘文件位置">2、确定虚拟机磁盘文件位置</h3>
<p>  查看虚拟机磁盘位置，选择指定虚拟机--&gt;硬件配置--&gt;确认磁盘文件存储位置<br>
<img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250813012857677-1273530886.png" alt="image" loading="lazy"></p>
<pre><code># 查看data2在服务器上的准确位置，便可找到虚拟机文件存放位置
cat /etc/pve/stroage.cfg
</code></pre>
<h3 id="3磁盘文件格式转换">3、磁盘文件格式转换</h3>
<pre><code># 使用PVE自带的磁盘格式转换工具，转换qcrow2格式为vmdk格式
# 例：
qemu-img convert -f qcow2 -O vmdk vm-104-disk-0.qcow2 /data/vm-104-disk-0.vmdk
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250813013228637-1330112088.png" alt="image" loading="lazy"></p>
<h3 id="4在exsi上创建虚拟机配置cpu内存网络等信息不要添加磁盘设备">4、在EXSI上创建虚拟机，配置CPU、内存、网络等信息（不要添加磁盘设备）</h3>
<p><img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811142808488-1616414288.png" alt="image" loading="lazy"><br>
<img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811143011819-461296854.png" alt="image" loading="lazy"></p>
<h3 id="5再次转换磁盘格式转换为支持vmware-exsi可识别的磁盘配置格式">5、再次转换磁盘格式（转换为支持VMware EXSI可识别的磁盘配置格式）</h3>
<p><img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811143236304-401799112.png" alt="image" loading="lazy"><br>
</p>
<pre><code>vmkfstools -d thin -i vm-103-disk-0.vmdk k8s-master01-191/k8s-master01-191.vmdk
# -d thin  (指定磁盘配置方式为精简配置，也可选其他磁盘置备格式，使用vmkfstools --help 可查看详细用法)
</code></pre>
<h3 id="6添加刚刚转换好的磁盘修改磁盘的控制器位置改为ide模式然后启动">6、添加刚刚转换好的磁盘，修改磁盘的控制器位置，改为ide模式然后启动</h3>
<p><img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811143804278-352819682.png" alt="image" loading="lazy"><br>
<img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811143839014-2135608272.png" alt="image" loading="lazy"><br>
<img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811144025688-1061491462.png" alt="image" loading="lazy"></p>
<h3 id="7修改网卡配置信息重启网卡迁移过程中网卡地址可能会变需注意">7、修改网卡配置信息，重启网卡（迁移过程中网卡地址可能会变需注意）</h3>
<pre><code>###编辑网卡配置文件
[root@localhost network-scripts]# vi  ifcfg-ens18
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens18
UUID=6cd3657b-28d4-4a8f-a8a3-bfc5e1dc2963
DEVICE=ens18
IPADDR=XXX.XXX.XXX.XXX
PREFIX=23
GATEWAY=XXX.XXX.XXX.XXX
DNS1=114.114.114.114
ONBOOT=yes
###重启网卡
[root@localhost network-scripts]# nmcli connection reload
[root@localhost network-scripts]# nmcli connection up ens18
</code></pre>
<h3 id="8增加内核驱动exsi上虚拟机默认scsi类型为vmware-paravirtual需增加驱动">8、增加内核驱动（EXSI上虚拟机默认SCSI类型为VMware Paravirtual需增加驱动）</h3>
<pre><code>dracut --add-drivers "vmw_pvscsi" -f /boot/initramfs-$(uname -r).img $(uname -r)
</code></pre>
<h3 id="9关闭虚拟机把磁盘控制器位置改回scsi0启动虚拟机即可">9、关闭虚拟机，把磁盘控制器位置改回SCSI:0，启动虚拟机即可</h3>
<p><img src="https://img2024.cnblogs.com/blog/3413000/202508/3413000-20250811150142600-397491758.png" alt="image" loading="lazy"><br>
<br></p>
<div style="border-bottom: 2px dashed rgba(88, 215, 87, 1)"></div>
<h3 id="迁移过程遇到问题q--a"><mark><strong>迁移过程遇到问题：Q &amp; A</strong></mark></h3>
<p><strong>一、【ESXi】打开电源失败提示 – “scsi0:0”的磁盘类型 2 不受支持或无效。请确保磁盘已导入！！！</strong></p>
<p><font color="green">答：首先确保自己的磁盘文件在传输过程中是完整的，可对比文件大小，在虚拟机的硬件配置中磁盘显示如果正确那就基本无问题，如果此时报上述提示，那只有一个原因，磁盘格式不对，注意第5步的操作，需要将文件再次使用vmkfstools工具进行格式转换的，该步骤不可省略。</font></p>
<p><strong>二、打开电源后，虚拟机启动很慢，且直接进入了救援模式</strong></p>
<p><font color="green">答：开机后进入救援模式的情况很多，可能你的磁盘挂载出了问题，也可能是其他原因，可以用<code>journalctl -xb</code>仔细查看一下，我遇到的问题是刚开始启动未更改为IDE模式，因为initramfs 里没 vmw_pvscsi，内核在早期阶段无法访问磁盘就找不到根所以导致进入emergency shell，所以第8步的作用就是增加 vmw_pvscsi 驱动，在这之后你才能改回SCSI驱动磁盘。</font></p>
<hr>
<p><em>如果你有其他问题，可以在评论区反馈，我们可以进一步交流~</em></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.014583333333333334" data-date-updated="2025-08-13 03:03">2025-08-13 02:42</span>&nbsp;
<a href="https://www.cnblogs.com/nanxi-xz">NanXi_XZ</a>&nbsp;
阅读(<span id="post_view_count">3</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19032010);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19032010', targetLink: 'https://www.cnblogs.com/nanxi-xz/p/19032010', title: '将虚拟机从PVE上迁移至EXSI详细步骤！！！（避免踩坑）' })">举报</a>
</div>
        