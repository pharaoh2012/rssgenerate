
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/data-analytics/p/18849986" title="å‘å¸ƒäº 2025-05-08 18:33">
    <span role="heading" aria-level="2">ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3640949/202504/3640949-20250427174046256-277631692.png" alt="ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ" class="desc_img">
        æ ¹æ®ç”µå½±ã€Šæ— åŒã€‹è‡ªåˆ›çš„ SQL é¢˜ç›®ï¼šå‡è®¾ä¼ªé’é›†å›¢æ¯æ—¥ç»™ä½ ä¾›åº”éšæœºæ•°é‡çš„å˜è‰²æ²¹å¢¨ã€æ— é…¸çº¸ã€å®‰å…¨çº¿/é˜²ä¼ªçº¿ã€‚è¯·ä½ è®¡ç®—æ¯å¤©èƒ½åˆ¶ä½œä¼ªé’å¤šå°‘å¼ ï¼Œå¹¶ä¸”æ ¹æ®å½“å¤©çš„æƒ…å†µè¾“å‡ºç¬¬äºŒå¤©æœ€ç¼ºå°‘çš„ææ–™ã€‚
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<section>
<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯â€œè’‹ç‚¹æ•°åˆ†â€ï¼Œå¤šå¹´ä»¥æ¥ä¸€ç›´ä»äº‹æ•°æ®åˆ†æå·¥ä½œã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œä¸å¤§å®¶æŒç»­åˆ†äº«å…³äºæ•°æ®åˆ†æçš„å­¦ä¹ å†…å®¹ã€‚</p>
<p>æœ¬æ–‡æ˜¯ç¬¬ 2 ç¯‡ï¼Œä¹Ÿæ˜¯ã€SQL å‘¨å‘¨ç»ƒã€‘ç³»åˆ—çš„ç¬¬ 2 ç¯‡ã€‚è¯¥ç³»åˆ—æ˜¯æŒ‘é€‰æˆ–è‡ªåˆ›å…·æœ‰ä¸€äº›éš¾åº¦çš„ SQL é¢˜ç›®ï¼Œä¸€å‘¨è‡³å°‘æ›´æ–°ä¸€ç¯‡ã€‚åç»­åˆ›ä½œçš„å†…å®¹ï¼Œåˆæ­¥è§„åˆ’çš„æ–¹å‘åŒ…æ‹¬ï¼š</p>
<h2 data-heading="true">åç»­å†…å®¹è§„åˆ’</h2>
<p>1.åˆ©ç”¨&nbsp;<strong>Streamlit</strong>&nbsp;å®ç°&nbsp;<code>Hive å…ƒæ•°æ®å±•ç¤º</code>ã€<code>SQL ç¼–è¾‘å™¨</code>ã€ ç»“åˆ<code>Docker æ²™ç®±å®ç°æ•°æ®åˆ†æ Agent</code><br>2.æ—¶é—´åºåˆ—å¼‚å¸¸è¯†åˆ«ã€å¼‚åŠ¨å½’å› ç®—æ³•<br>3.ç•™å­˜ç‡æ‹Ÿåˆã€é¢„æµ‹ã€å»ºæ¨¡<br>4.å­¦ä¹ &nbsp;<code>AB å®éªŒ</code>ã€å¤æ‚å®éªŒè®¾è®¡ç­‰<br>5.<code>è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ </code>ã€è‡ªåŠ¨åŒ–ç‰¹å¾å·¥ç¨‹<br>6.<code>å› æœæ¨æ–­</code>å­¦ä¹ <br>7. â€¦â€¦</p>
<p><strong>æ¬¢è¿å…³æ³¨</strong>ï¼Œä¸€èµ·å­¦ä¹ ã€‚</p>
<h2 data-heading="true">ç¬¬ 2 æœŸé¢˜ç›®</h2>
<p>é¢˜ç›®æ¥æºï¼šè‡ªåˆ›é¢˜ç›®ï¼Œåœºæ™¯æ¥æºäºé¦™æ¸¯ç”µå½±ã€Šæ— åŒã€‹</p>
<h3 data-heading="true">ä¸€ã€é¢˜ç›®ä»‹ç»</h3>
<p>ã€Šæ— åŒã€‹æ˜¯ä¸€éƒ¨å¾ˆä¸é”™çš„ç”µå½±ï¼Œå…¶ä¸»é¢˜æ˜¯ä¼ªé€ ç¾é’ã€‚è™½ç„¶å·²ç»ä¸Šæ˜ å¤šå¹´ï¼Œä½†å…¶ä¸­â€œæ— é…¸çº¸â€ã€â€œå˜è‰²æ²¹å¢¨â€çš„æ¢—ï¼Œè‡³ä»Šåœ¨ç½‘ä¸Šä¾æ—§å¯ä»¥çœ‹åˆ°ã€‚å…¶ä¸­çš„ä¸€ä¸ªç»å…¸ç‰‡æ®µ â€”â€” â€œç”»å®¶â€(å‘¨æ¶¦å‘)å—”æ€ªâ€œæé—®â€(éƒ­å¯ŒåŸ)è®¢è´­äº†500å¨æ— é…¸çº¸ï¼Œè¯´è®©â€œææ–‡â€æ´»ç€ç»™ä»–å°å®Œï¼ˆå½“ç„¶ç»“å°¾å±•ç¤ºäº†éƒ­å¯ŒåŸå…¶å®æ‰æ˜¯â€œç”»å®¶â€ï¼‰ã€‚é‚£ä¹ˆç”±æ­¤è€Œæ¥ï¼Œæˆ‘æƒ³å‡ºäº†ä¸€é“ SQL é¢˜ï¼š</p>
<p>å‡è®¾ä¼ªé’é›†å›¢æ¯æ—¥ç»™ä½ ä¾›åº”éšæœºæ•°é‡çš„<code>å˜è‰²æ²¹å¢¨</code>ã€<code>æ— é…¸çº¸</code>ã€<code>å®‰å…¨çº¿/é˜²ä¼ªçº¿</code>ï¼ˆæœªç”¨å®Œçš„ææ–™å¯ä»¥ç•™ç»™åé¢ç”¨ï¼‰ï¼Œå‡¹ç‰ˆå°åˆ·æœºç­‰å…¶ä»–ææ–™å’Œå·¥å…·ä¹Ÿå·²ç»å‡†å¤‡å¥½ã€‚</p>
<p>è¯·ä½ è®¡ç®—æ¯å¤©èƒ½åˆ¶ä½œä¼ªé’å¤šå°‘å¼ ï¼Œå¹¶ä¸”æ ¹æ®å½“å¤©çš„æƒ…å†µè¾“å‡ºç¬¬äºŒå¤©<strong>æœ€ç¼º</strong>å“ªç§ææ–™ï¼š</p>
<section>
<table>
<thead>
<tr>
<td>
<section>åˆ—å</section>
</td>
<td>
<section>æ•°æ®ç±»å‹</section>
</td>
<td>
<section>æ³¨é‡Š</section>
</td>
</tr>
</thead>
<tbody>
<tr>
<td>
<section>date</section>
</td>
<td>
<section>string</section>
</td>
<td>
<section>æ—¥æœŸ</section>
</td>
</tr>
<tr>
<td>
<section>acid_free_paper_supply</section>
</td>
<td>
<section>int</section>
</td>
<td>
<section>æ— é…¸çº¸ä¾›åº”é‡ï¼ˆå•ä½gï¼‰</section>
</td>
</tr>
<tr>
<td>
<section>optically_variable_ink_supply</section>
</td>
<td>
<section>int</section>
</td>
<td>
<section>å˜è‰²æ²¹å¢¨ä¾›åº”é‡ï¼ˆå•ä½mgï¼‰</section>
</td>
</tr>
<tr>
<td>
<section>security_thread_supply</section>
</td>
<td>
<section>int</section>
</td>
<td>
<section>å®‰å…¨çº¿ä¾›åº”é‡</section>
</td>
</tr>
</tbody>
</table>
</section>
<p>å‡è®¾ ä¸€å¼ ä¼ªé’éœ€è¦&nbsp;1g æ— é…¸çº¸ï¼Œ0.005g çš„å˜è‰²æ²¹å¢¨ï¼Œ1 æ ¹å®‰å…¨çº¿ï¼›å°åˆ¶è¿‡ç¨‹ä¸­ä¸è€ƒè™‘æŸè€—</p>
<h3 data-heading="true">äºŒã€é¢˜ç›®æ€è·¯</h3>
<p>æƒ³è¦ç­”é¢˜çš„åŒå­¦ï¼Œå¯ä»¥å…ˆæ€è€ƒç­”æ¡ˆğŸ¤”ã€‚<br>â€¦â€¦</p>
<p>â€¦â€¦</p>
<p>â€¦â€¦</p>
<p>æˆ‘æ¥è°ˆè°ˆæˆ‘çš„æ€è·¯ï¼šè¿™é“é¢˜ç›®çš„è®¾è®¡ï¼Œææ–™æ˜¯ä»¥å›ºå®šæ¯”ä¾‹çš„æŠ•å…¥äº§ç”Ÿä¸€å¼ ä¼ªé’ï¼Œå“ªç§ææ–™ç›¸å¯¹è¾ƒå°‘ï¼Œå“ªç§ææ–™å°±é™åˆ¶ä½äº†ä¼ªé’çš„åˆ¶é€ æ•°é‡ï¼›æ‰€ä»¥å¯ä»¥<strong>å•ç‹¬è®¡ç®—ä¸‰ç§ææ–™èƒ½åˆ¶é€ å¤šå°‘ä¼ªé’</strong>ï¼Œç„¶åç”¨&nbsp;<code>least</code>&nbsp;æ±‚æœ€å°å€¼ï¼Œç±»ä¼¼â€œæœ¨æ¡¶çŸ­æ¿ç†è®ºâ€ã€‚é¢˜ç›®é‡Œæåˆ°äº†å½“æ—¥æœªç”¨å®Œçš„ææ–™ï¼Œå¯ä»¥åé¢å†ç”¨ï¼›æ‰€ä»¥æ¯å¤©ä¸éœ€è¦å•ç‹¬è®¡ç®—ï¼Œç›´æ¥è®¡ç®—ä»å¼€å§‹åˆ°å½“å¤© =&gt; è¿™åˆç”¨ä¸Šäº†æ•°æ®åˆ†æå¸ˆçš„è€æœ‹å‹â€œçª—å£å‡½æ•°â€ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ç”¨&nbsp;<code>NumPy</code>&nbsp;å’Œ&nbsp;<code>Scipy</code>&nbsp;ç”Ÿæˆæ¨¡æ‹Ÿçš„æ•°æ®é›†ï¼š</p>
<h3 data-heading="true">ä¸‰ã€ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</h3>
<p>åªå…³å¿ƒ SQL ä»£ç çš„åŒå­¦ï¼Œå¯ä»¥è·³è½¬åˆ°ç¬¬å››èŠ‚ï¼ˆæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨&nbsp;<code>Hive</code>&nbsp;è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨&nbsp;<code>Hive</code>&nbsp;çš„è¯­æ³•ï¼‰</p>
<p>æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹ï¼š</p>
<section>1. å®šä¹‰æ¨¡æ‹Ÿé€»è¾‘éœ€è¦çš„<code>å¸¸é‡</code>ï¼Œè®¡ç®—ç›®æ ‡æ•°é‡çš„ä¼ªé’éœ€è¦å¤šå°‘ææ–™ï¼š</section>
<section></section>
<pre class="highlighter-prismjs language-python prismjs-lines-highlighted" tabindex="0" data-dark-theme="true"><code>import numpy as np
import pandas as pd
import scipy

# éšæœºæ•°ç§å­
RANDOM_SEED = 2025
# ä¼ªé€ å¼€å§‹æ—¥æœŸ
START_DATE = "2025-05-01"
# ä¼ªé€ å¤©æ•°
NUM_DAY = 10
# éœ€è¦ä¼ªé€ çš„ä¼ªé’æ•°é‡ï¼ˆå¼ æ•°ï¼Œéé‡‘é¢ï¼‰
NUM_TOTAL_COUNTERFEIT_CURRENCY = 1_000_000

# ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘æ— é…¸çº¸ï¼Œç®€åŒ–é—®é¢˜åªè€ƒè™‘é‡é‡(å•ä½ g)
ACID_FREE_PAPER_EACH_COUNTERFEIT_CURRENCY = 1
# æ‰€æœ‰ä¼ªé’éœ€è¦çš„æ— é…¸çº¸(1.05 æ˜¯ä¸€ä¸ªå†—ä½™åº¦ï¼Œæ‰€æœ‰ææ–™ç±»ä¼¼)
ACID_FREE_PAPER_ALL_NEED = (
    ACID_FREE_PAPER_EACH_COUNTERFEIT_CURRENCY 
    * NUM_TOTAL_COUNTERFEIT_CURRENCY 
    * 1.05
)

# ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘å˜è‰²æ²¹å¢¨ï¼Œé‡é‡ï¼ˆå•ä½ mgï¼‰
OPTICALLY_VARIABLE_INK_EACH_COUNTERFEIT_CURRENCY = 5
# æ‰€æœ‰ä¼ªé’éœ€è¦çš„å˜è‰²æ²¹å¢¨
OPTICALLY_VARIABLE_INK_ALL_NEED = (
    OPTICALLY_VARIABLE_INK_EACH_COUNTERFEIT_CURRENCY
    * NUM_TOTAL_COUNTERFEIT_CURRENCY
    * 1.05
)

# ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘å®‰å…¨çº¿ï¼ˆå•ä½ æ¡ï¼‰
SECURITY_THREAD_EACH_COUNTERFEIT_CURRENCY = 1
# æ‰€æœ‰ä¼ªé’éœ€è¦çš„é˜²ä¼ªçº¿
SECURITY_THREAD_ALL_NEED = (
    SECURITY_THREAD_EACH_COUNTERFEIT_CURRENCY 
    * NUM_TOTAL_COUNTERFEIT_CURRENCY 
    * 1.05
)</code></pre>
<section></section>
<section>2. ä¼ªé’éœ€è¦çš„ææ–™æ¯å¤©æŒ‰ç…§éšæœºçš„æƒé‡æä¾›ï¼Œæƒé‡éœ€è¦å½’ä¸€åŒ–ï¼š</section>
<section></section>
<pre class="highlighter-prismjs language-python prismjs-lines-highlighted" tabindex="0" data-dark-theme="true"><code># æƒé‡èŒƒå›´ï¼Œç”¨æ¥éšæœºç”Ÿæˆæ•°æ®ï¼ˆéœ€è¦å½’ä¸€åŒ–ï¼‰
WEIGHT_RANGE = (0.2, 2)

# æ— é…¸çº¸æ¯å¤©ä¾›åº”çš„éšæœºæƒé‡
acid_free_paper_supply_weight = scipy.stats.uniform.rvs(
    loc=WEIGHT_RANGE[0],
    scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
    size=NUM_DAY,
    random_state=RANDOM_SEED - 1,
)

# å˜è‰²æ²¹å¢¨æ¯å¤©ä¾›åº”çš„æƒé‡
optically_variable_ink_supply_weight = scipy.stats.uniform.rvs(
    loc=WEIGHT_RANGE[0],
    scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
    size=NUM_DAY,
    random_state=RANDOM_SEED,
)

# å®‰å…¨çº¿æ¯å¤©ä¾›åº”çš„æƒé‡
security_thread_supply_weight = scipy.stats.uniform.rvs(
    loc=WEIGHT_RANGE[0],
    scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
    size=NUM_DAY,
    random_state=RANDOM_SEED + 1,
)

# å°†æƒé‡å½’ä¸€åŒ–ï¼Œä½¿å¾—æ‰€æœ‰å¤©æ•°çš„ä¾›åº”æ¯”ä¾‹å’Œä¸º 1
acid_free_paper_supply_weight /= acid_free_paper_supply_weight.sum()
optically_variable_ink_supply_weight /= optically_variable_ink_supply_weight.sum()
security_thread_supply_weight /= security_thread_supply_weight.sum()</code></pre>
<section></section>
<section>3. å°†å‰é¢ç”Ÿæˆçš„æ•°æ®è½¬ä¸º <code>pd.DataFrame</code>ï¼Œå¹¶è¾“å‡ºä¸º&nbsp;<code>csv</code>&nbsp;æ–‡ä»¶ï¼š</section>
<section></section>
<pre class="highlighter-prismjs language-python prismjs-lines-highlighted" tabindex="0" data-dark-theme="true"><code>df = pd.DataFrame(
    {
        "acid_free_paper_supply": ACID_FREE_PAPER_ALL_NEED
        * acid_free_paper_supply_weight,
        "optically_variable_ink_supply": OPTICALLY_VARIABLE_INK_ALL_NEED
        * optically_variable_ink_supply_weight,
        "security_thread_supply": SECURITY_THREAD_ALL_NEED
        * security_thread_supply_weight
    }
)

# å››èˆäº”å…¥å¹¶è½¬ä¸º int
df = df.round().astype(int)
df["date"] = pd.date_range(start=START_DATE, periods=NUM_DAY, freq="D")

# åœ¨ Jupyter ä¸­å±•ç¤ºæ•°æ®
display(df)

out_csv_path = "./dwd_conterfeit_material_daily_supply_records.csv"
columns = [
    "date",
    "acid_free_paper_supply",
    "optically_variable_ink_supply",
    "security_thread_supply"
]
# å¯¼å‡º csv ç”¨æ¥è®© hive load æ•°æ®ï¼Œutf-8-sig ç¼–ç å¤„ç†ä¸­æ–‡ï¼Œè™½ç„¶è¡¨é‡Œæ•°æ®æ²¡æœ‰ä¸­æ–‡
df[columns].to_csv(out_csv_path, header=False, index=False, encoding="utf-8-sig")</code></pre>
<section></section>
<section>4. åˆ›å»ºæ–°çš„ <code>Hive</code>&nbsp;è¡¨ï¼Œå¹¶å°†æ•°æ®&nbsp;<code>load</code>&nbsp;åˆ°è¡¨ä¸­ï¼š</section>
<section></section>
<pre class="highlighter-prismjs language-python prismjs-lines-highlighted" tabindex="0" data-dark-theme="true"><code>from pyhive import hive

# é…ç½®è¿æ¥å‚æ•°
host_ip = "127.0.0.1"
port = 10000
username = "è’‹ç‚¹æ•°åˆ†"


with hive.Connection(host=host_ip, port=port) as conn:
    cursor = conn.cursor()

    drop_table_sql = """
    drop table if exists data_exercise.dwd_conterfeit_material_daily_supply_records
    """
    print(drop_table_sql)
    cursor.execute(drop_table_sql)

    create_table_sql = """
    create table data_exercise.dwd_conterfeit_material_daily_supply_records (
        `date` string comment "æ—¥æœŸ",
        acid_free_paper_supply int comment "æ— é…¸çº¸ä¾›åº”é‡ï¼ˆå•ä½gï¼‰",
        optically_variable_ink_supply int comment "å˜è‰²æ²¹å¢¨ä¾›åº”é‡ï¼ˆå•ä½mgï¼‰",
        security_thread_supply int comment "å®‰å…¨çº¿ä¾›åº”é‡"
    )
    comment "ä¼ªé’é›†å›¢æ¯å¤©ä¾›åº”çš„ä¼ªé’åŸææ–™æ•°é‡ | æ–‡ç« ç¼–å·ï¼š2c3d2561"
    row format delimited fields terminated by ","
    stored as textfile
    """
    
    print(create_table_sql)
    cursor.execute(create_table_sql)

    import os
    
    load_data_sql = f"""
    load data local inpath "{os.path.abspath(out_csv_path)}" 
    overwrite into table data_exercise.dwd_conterfeit_material_daily_supply_records
    """
    
    print(load_data_sql)
    cursor.execute(load_data_sql)

    cursor.close()</code></pre>
<blockquote>
<p>æˆ‘é€šè¿‡ä½¿ç”¨&nbsp;<code>PyHive</code>&nbsp;åŒ…å®ç° Python æ“ä½œ&nbsp;<code>Hive</code>ã€‚æˆ‘ä¸ªäººç”µè„‘éƒ¨ç½²äº†&nbsp;<code>Hadoop</code>&nbsp;åŠ&nbsp;<code>Hive</code>ï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯è®¤è¯ï¼Œä¼ä¸šé‡Œä¸€èˆ¬å¸¸ç”¨&nbsp;<code>Kerberos</code>&nbsp;æ¥è¿›è¡Œå¤§æ•°æ®é›†ç¾¤çš„è®¤è¯ã€‚</p>
</blockquote>
<h3 data-heading="true">å››ã€SQL è§£ç­”</h3>
<p>æ€è·¯åœ¨ç¬¬äºŒèŠ‚å·²ç»è¯´æ˜ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼Œç»†èŠ‚å‚è§æ³¨é‡Šã€‚å…¶ä¸­&nbsp;<code>cumulative_conterfeit_all_restriction</code>&nbsp;ç­‰äºå“ªç§ææ–™çš„&nbsp;<code>cumulative_conterfeit_only...</code>&nbsp;å°±å¯ä»¥è®¤ä¸ºç¬¬äºŒå¤©æœ€ç¼ºå“ªç§ææ–™ï¼ˆä¼ªé’åˆ¶é€ é‡è¢«è¿™ç§ææ–™åˆ¶çº¦ï¼‰ã€‚æç¤ºï¼š<code>order by</code>&nbsp;æ—¶ï¼Œç»Ÿè®¡çš„çª—å£èŒƒå›´é»˜è®¤æ˜¯&nbsp;<code>rows between preceding unbounded and current row</code>ï¼Œå†™æ¸…æ¥šæ›´å¥½ã€‚ä¸‰ç§ææ–™å•ç‹¬åˆ¤æ–­ï¼Œç„¶åç”¨&nbsp;<code>concat_ws</code>&nbsp;åˆå¹¶ç»“æœï¼ˆæ³¨æ„å…¶ä»– SQL æ–¹è¨€ä¸ä¸€å®šæœ‰&nbsp;<code>Hive</code>&nbsp;çš„è¿™ä¸ªå‡½æ•°ï¼‰ã€‚</p>
<p>æ¯å¤©çš„ä¼ªé’åˆ¶é€ é‡&nbsp;<code>action_daily_production</code>&nbsp;ä½¿ç”¨&nbsp;<code>cumulative_conterfeit_all_restriction</code>&nbsp;ç»“åˆçª—å£å‡½æ•°&nbsp;<code>lag</code>&nbsp;å‡å»ä¸Šä¸€è¡Œå³å¯ã€‚</p>
<p>&nbsp;</p>
<pre class="highlighter-prismjs prismjs-lines-highlighted language-python" tabindex="0" data-dark-theme="true"><code>with calc_single_material_restrict_production as (
    -- è®¡ç®—ä¸€ç§ææ–™é™åˆ¶èƒ½é€ å¤šå°‘ç¾å…ƒä¼ªé’
    select
      `date`
    , acid_free_paper_supply
    , optically_variable_ink_supply
    , security_thread_supply
    -- åªè€ƒè™‘æ— é…¸çº¸ï¼Œä¸è€ƒè™‘å…¶ä»–ææ–™å’Œæ¯æ—¥æœ€å¤§åˆ¶é€ é‡é™åˆ¶ï¼Œç´¯è®¡ä¼ªé’åˆ¶ä½œæ•°ï¼Œä¸‹é¢ä»¥æ­¤ç±»æ¨
    -- æœ‰äº›ææ–™æ¯”ä¾‹ä¸º 1ï¼Œå› æ­¤ä¸é¢å¤–å†™é™¤ä»¥ 1
    , sum(acid_free_paper_supply) over(orderby `date` asc) as cumulative_conterfeit_only_acid_free_paper
    -- æ³¨æ„å‘ä¸‹å–æ•´
    , floor(sum(optically_variable_ink_supply) over(orderby `date` asc) /5) as cumulative_conterfeit_only_optically_variable_ink
    , sum(security_thread_supply) over(orderby `date` asc) as cumulative_conterfeit_only_security_thread
    from data_exercise.dwd_conterfeit_material_daily_supply_records
)

, calc_all_restriction_prodection as (
    select
      `date`
    , acid_free_paper_supply
    , optically_variable_ink_supply
    , security_thread_supply
    , cumulative_conterfeit_only_acid_free_paper
    , cumulative_conterfeit_only_optically_variable_ink
    , cumulative_conterfeit_only_security_thread
    -- ä½¿ç”¨ least è®¡ç®—æœ€å°å€¼
    , least(
        cumulative_conterfeit_only_acid_free_paper, 
        cumulative_conterfeit_only_optically_variable_ink, 
        cumulative_conterfeit_only_security_thread
      ) as cumulative_conterfeit_all_restriction
    from calc_single_material_restrict_production

)

select
  `date`
, cumulative_conterfeit_only_acid_free_paper
, cumulative_conterfeit_only_optically_variable_ink
, cumulative_conterfeit_only_security_thread
, cumulative_conterfeit_all_restriction
-- å‡å»ä¸Šä¸€è¡Œçš„æ•°æ®ï¼Œè·å–æ¯æ—¥ä¼ªé’åˆ¶é€ é‡
, cumulative_conterfeit_all_restriction -lag(cumulative_conterfeit_all_restriction, 1, 0) over(orderby `date` asc) as action_daily_production
, if( cumulative_conterfeit_all_restriction &gt;=1000000, null, -- å·²ç»å®Œæˆç›®æ ‡é‡ï¼Œå°±ä¸å†™ç¼ºå“ªç§ææ–™äº†
    concat_ws(',', 
        if(cumulative_conterfeit_only_acid_free_paper=cumulative_conterfeit_all_restriction, 'æ— é…¸çº¸', null),
        if(cumulative_conterfeit_only_optically_variable_ink=cumulative_conterfeit_all_restriction, 'å˜è‰²æ²¹å¢¨', null),
        if(cumulative_conterfeit_only_security_thread=cumulative_conterfeit_all_restriction, 'å®‰å…¨çº¿', null)
    )
) as `æœ€ç¼ºçš„ææ–™`
from calc_all_restriction_prodection</code></pre>
<p>&nbsp;</p>
<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š</p>
<section>
<table>
<thead>
<tr>
<td data-colwidth="118">
<section>date</section>
</td>
<td data-colwidth="171">
<section>cumulative_conterfeit_only_acid_free_paper</section>
</td>
<td data-colwidth="77">
<section>cumulative_conterfeit_only_optically_variable_ink</section>
</td>
<td data-colwidth="79">
<section>cumulative_conterfeit_only_security_thread</section>
</td>
<td data-colwidth="83">
<section>cumulative_conterfeit_all_restriction</section>
</td>
<td data-colwidth="85">
<section>action_daily_production</section>
</td>
<td data-colwidth="173">
<section>æœ€ç¼ºçš„ææ–™</section>
</td>
</tr>
</thead>
<tbody>
<tr>
<td data-colwidth="118">
<section>2025-05-01</section>
</td>
<td data-colwidth="171">
<section>139293</section>
</td>
<td data-colwidth="77">
<section>36604</section>
</td>
<td data-colwidth="79">
<section>51579</section>
</td>
<td data-colwidth="83">
<section>36604</section>
</td>
<td data-colwidth="85">
<section>36604</section>
</td>
<td data-colwidth="173">
<section>å˜è‰²æ²¹å¢¨</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-02</section>
</td>
<td data-colwidth="171">
<section>300720</section>
</td>
<td data-colwidth="77">
<section>184888</section>
</td>
<td data-colwidth="79">
<section>133386</section>
</td>
<td data-colwidth="83">
<section>133386</section>
</td>
<td data-colwidth="85">
<section>96782</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-03</section>
</td>
<td data-colwidth="171">
<section>360345</section>
</td>
<td data-colwidth="77">
<section>339815</section>
</td>
<td data-colwidth="79">
<section>303165</section>
</td>
<td data-colwidth="83">
<section>303165</section>
</td>
<td data-colwidth="85">
<section>169779</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-04</section>
</td>
<td data-colwidth="171">
<section>391211</section>
</td>
<td data-colwidth="77">
<section>422448</section>
</td>
<td data-colwidth="79">
<section>334383</section>
</td>
<td data-colwidth="83">
<section>334383</section>
</td>
<td data-colwidth="85">
<section>31218</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-05</section>
</td>
<td data-colwidth="171">
<section>454196</section>
</td>
<td data-colwidth="77">
<section>496570</section>
</td>
<td data-colwidth="79">
<section>426535</section>
</td>
<td data-colwidth="83">
<section>426535</section>
</td>
<td data-colwidth="85">
<section>92152</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-06</section>
</td>
<td data-colwidth="171">
<section>497465</section>
</td>
<td data-colwidth="77">
<section>551300</section>
</td>
<td data-colwidth="79">
<section>598018</section>
</td>
<td data-colwidth="83">
<section>497465</section>
</td>
<td data-colwidth="85">
<section>70930</section>
</td>
<td data-colwidth="173">
<section>æ— é…¸çº¸</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-07</section>
</td>
<td data-colwidth="171">
<section>664497</section>
</td>
<td data-colwidth="77">
<section>665371</section>
</td>
<td data-colwidth="79">
<section>646287</section>
</td>
<td data-colwidth="83">
<section>646287</section>
</td>
<td data-colwidth="85">
<section>148822</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-08</section>
</td>
<td data-colwidth="171">
<section>821998</section>
</td>
<td data-colwidth="77">
<section>754988</section>
</td>
<td data-colwidth="79">
<section>805933</section>
</td>
<td data-colwidth="83">
<section>754988</section>
</td>
<td data-colwidth="85">
<section>108701</section>
</td>
<td data-colwidth="173">
<section>å˜è‰²æ²¹å¢¨</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-09</section>
</td>
<td data-colwidth="171">
<section>938544</section>
</td>
<td data-colwidth="77">
<section>914610</section>
</td>
<td data-colwidth="79">
<section>910409</section>
</td>
<td data-colwidth="83">
<section>910409</section>
</td>
<td data-colwidth="85">
<section>155421</section>
</td>
<td data-colwidth="173">
<section>å®‰å…¨çº¿</section>
</td>
</tr>
<tr>
<td data-colwidth="118">
<section>2025-05-10</section>
</td>
<td data-colwidth="171">
<section>1050000</section>
</td>
<td data-colwidth="77">
<section>1050000</section>
</td>
<td data-colwidth="79">
<section>1050001</section>
</td>
<td data-colwidth="83">
<section>1050000</section>
</td>
<td data-colwidth="85">
<section>139591</section>
</td>
<td data-colwidth="173">
<section>null</section>
</td>
</tr>
</tbody>
</table>
</section>
<figure></figure>
</section>
<section><img src="https://img2024.cnblogs.com/blog/3640949/202504/3640949-20250427173852509-2026342824.png" alt="" height="699" width="1271"></section>
<section>
<figure>
<figcaption>vchart ç»˜åˆ¶å¯è§†åŒ–ç»“æœ</figcaption>
</figure>
<p>ä¸Šé¢çš„å›¾ç‰‡ï¼Œæ˜¯æˆ‘åœ¨&nbsp;<code>Python</code>&nbsp;ä¸­ä½¿ç”¨&nbsp;<code>pyvchart</code>&nbsp;åº“å®ç°çš„ï¼Œå®ƒæ˜¯å­—èŠ‚è·³åŠ¨å¼€æºçš„&nbsp;<code>vchart</code>&nbsp;çš„ Python åŒ…ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨&nbsp;<code>pyecharts</code>ã€‚<code>pd.melt</code>&nbsp;å‡½æ•°ç”¨äºå°†â€œå®½æ•°æ®æ¡†â€è½¬â€œé•¿æ•°æ®æ¡†â€ã€‚ä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<p>&nbsp;</p>
<pre class="highlighter-prismjs prismjs-lines-highlighted language-python" tabindex="0" data-dark-theme="true"><code>with hive.Connection(host=host_ip, port=port) as conn:
    select_data_sql = ''' æˆ‘ç»™å‡º SQL ç­”æ¡ˆ '''
    df_outcome = pd.read_sql_query(select_data_sql, conn)

from pyvchart import render_chart
spec = {
"type": 'area',
"data": [
    {
      "id": 'lineData',
      "values": pd.melt(df_outcome[[
        'date','cumulative_conterfeit_only_acid_free_paper',
        'cumulative_conterfeit_only_optically_variable_ink',
        'cumulative_conterfeit_only_security_thread'
      ]], id_vars=['date']).to_dict(orient='records')
    },
    {
      "id": 'areaData',
      "values": pd.melt(df_outcome[['date','cumulative_conterfeit_all_restriction',
        'æœ€ç¼ºçš„ææ–™']], id_vars=['date']).to_dict(orient='records')
    },
  ],
"series": [
    {
      "type": 'line',
      "dataId": 'lineData',
      "xField": 'date',
      "yField": 'value',
      "seriesField": 'variable',
    },
    {
      "type": 'area',
      "dataId": 'areaData',
      "xField": 'date',
      "yField": 'value',
      "seriesField": 'variable',
    },
 ],

};

display(render_chart(spec))</code></pre>
<hr>
<p>ğŸ˜ğŸ˜ğŸ˜<br><strong>æˆ‘ç°åœ¨æ­£åœ¨æ±‚èŒæ•°æ®ç±»å·¥ä½œ</strong>ï¼ˆä¸»è¦æ˜¯æ•°æ®åˆ†ææˆ–æ•°æ®ç§‘å­¦ï¼‰ï¼›å¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼Œæ³è¯·æ‚¨ä¸æˆ‘è”ç³»ï¼Œå³æ—¶åˆ°å²—ï¼Œä¸é™åŸå¸‚ã€‚æ‚¨å¯ä»¥å‘é€ç§ä¿¡æˆ–è€…è”ç³»æˆ‘ï¼ˆå…¨ç½‘åŒåï¼šè’‹ç‚¹æ•°åˆ†ï¼‰ã€‚</p>
</section>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.08167619064467592" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-08 18:33">2025-05-08 18:33</span>&nbsp;
<a href="https://www.cnblogs.com/data-analytics">è’‹ç‚¹æ•°åˆ†</a>&nbsp;
é˜…è¯»(<span id="post_view_count">50</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18849986);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18849986', targetLink: 'https://www.cnblogs.com/data-analytics/p/18849986', title: 'ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ' })">ä¸¾æŠ¥</a>
</div>
        