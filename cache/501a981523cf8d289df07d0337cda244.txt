
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Tangtang1997/p/18616866" title="å‘å¸ƒäº 2024-12-19 14:35">
    <span role="heading" aria-level="2">ä½¿ç”¨ .NET Core å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ—¥å¿—è®°å½•å™¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p></p><div class="toc"><div class="toc-container-header">ç›®å½•</div><ul><li><a href="#å¼•è¨€" rel="noopener nofollow">å¼•è¨€</a></li><li><a href="#1-æŠ½è±¡åŒ…" rel="noopener nofollow">1. æŠ½è±¡åŒ…</a><ul><li><a href="#11-å®šä¹‰æ—¥å¿—è®°å½•æ¥å£" rel="noopener nofollow">1.1 å®šä¹‰æ—¥å¿—è®°å½•æ¥å£</a></li><li><a href="#12-å®šä¹‰æ—¥å¿—è®°å½•æŠ½è±¡ç±»" rel="noopener nofollow">1.2 å®šä¹‰æ—¥å¿—è®°å½•æŠ½è±¡ç±»</a></li><li><a href="#13-è¡¨ç»“æ„è¿ç§»" rel="noopener nofollow">1.3 è¡¨ç»“æ„è¿ç§»</a></li></ul></li><li><a href="#2-entityframework-core-çš„å®ç°" rel="noopener nofollow">2. EntityFramework Core çš„å®ç°</a><ul><li><a href="#21-æ•°æ®åº“ä¸Šä¸‹æ–‡" rel="noopener nofollow">2.1 æ•°æ®åº“ä¸Šä¸‹æ–‡</a></li><li><a href="#22-å®ç°æ—¥å¿—å†™å…¥" rel="noopener nofollow">2.2 å®ç°æ—¥å¿—å†™å…¥</a></li></ul></li><li><a href="#3-mysqlconnector-çš„å®ç°" rel="noopener nofollow">3. MySqlConnector çš„å®ç°</a><ul><li><a href="#31-sqlè„šæœ¬" rel="noopener nofollow">3.1 SQLè„šæœ¬</a></li><li><a href="#32-å®ç°æ—¥å¿—å†™å…¥" rel="noopener nofollow">3.2 å®ç°æ—¥å¿—å†™å…¥</a></li></ul></li><li><a href="#4-ä½¿ç”¨ç¤ºä¾‹" rel="noopener nofollow">4. ä½¿ç”¨ç¤ºä¾‹</a></li></ul></div><p></p>
<h2 id="å¼•è¨€">å¼•è¨€</h2>
<p>åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œæ—¥å¿—è®°å½•æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„åŠŸèƒ½ã€‚ä¸ä»…æœ‰åŠ©äºè°ƒè¯•å’Œç›‘æ§åº”ç”¨ç¨‹åºï¼Œè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬äº†è§£åº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ã€‚<br>
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­å°†å±•ç¤ºå¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥å¿—è®°å½•å™¨ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªå®ç°å’Œ<code>Microsoft.Extensions.Logging</code>ã€<code>Serilog</code>ã€<code>NLog</code>ä»€ä¹ˆçš„æ— å…³ï¼Œè¿™é‡Œåªæ˜¯å°†è‡ªå®šä¹‰çš„æ—¥å¿—æ•°æ®å­˜å…¥æ•°æ®åº“ä¸­ï¼Œæˆ–è®¸ä½ ä¹Ÿå¯ä»¥ç†è§£ä¸º<strong>å®ç°çš„æ˜¯ä¸€ä¸ªå­˜æ•°æ®çš„â€œRepositoryâ€ï¼Œåªä¸è¿‡ç”¨è¿™ä¸ªRepositoryæ¥å­˜çš„æ˜¯æ—¥å¿—</strong>ğŸ™ˆã€‚è¿™ä¸ªå®ç°åŒ…å«ä¸€ä¸ªæŠ½è±¡åŒ…å’Œä¸¤ä¸ªå®ç°åŒ…ï¼Œä¸¤ä¸ªå®ç°åˆ†åˆ«æ˜¯ç”¨ EntityFramework Core å’Œ MySqlConnector ã€‚æ—¥å¿—è®°å½•æ“ä½œå°†æ”¾åœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­å¼‚æ­¥å¤„ç†ï¼Œä»¥ç¡®ä¿ä¸å½±å“ä¸šåŠ¡å¤„ç†ã€‚</p>
<h2 id="1-æŠ½è±¡åŒ…">1. æŠ½è±¡åŒ…</h2>
<h3 id="11-å®šä¹‰æ—¥å¿—è®°å½•æ¥å£">1.1 å®šä¹‰æ—¥å¿—è®°å½•æ¥å£</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ—¥å¿—è®°å½•æ¥å£ <code>ICustomLogger</code>ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼šLogReceived å’Œ LogProcessedã€‚LogReceived ç”¨äºè®°å½•æ¥æ”¶åˆ°çš„æ—¥å¿—ï¼ŒLogProcessed ç”¨äºæ›´æ–°æ—¥å¿—çš„å¤„ç†çŠ¶æ€ã€‚</p>
<pre><code class="language-csharp">namespace Logging.Abstractions;

public interface ICustomLogger
{
    /// &lt;summary&gt;
    /// è®°å½•ä¸€æ¡æ—¥å¿—
    /// &lt;/summary&gt;
    void LogReceived(CustomLogEntry logEntry);

    /// &lt;summary&gt;
    /// æ ¹æ®Idæ›´æ–°è¿™æ¡æ—¥å¿—
    /// &lt;/summary&gt;
    void LogProcessed(string logId, bool isSuccess);
} 
</code></pre>
<p>å®šä¹‰ä¸€ä¸ªæ—¥å¿—ç»“æ„å®ä½“<code>CustomLogEntry</code>ï¼Œç”¨äºå­˜å‚¨æ—¥å¿—çš„è¯¦ç»†ä¿¡æ¯ï¼š</p>
<pre><code class="language-csharp">namespace Logging.Abstractions;

public class CustomLogEntry
{
    /// &lt;summary&gt;
    /// æ—¥å¿—å”¯ä¸€Idï¼Œæ•°æ®åº“ä¸»é”®
    /// &lt;/summary&gt;
    public string Id { get; set; } = Guid.NewGuid().ToString();
    public string Message { get; set; } = default!;
    public bool IsSuccess { get; set; }
    public DateTime CreateTime { get; set; } = DateTime.UtcNow;
    public DateTime? UpdateTime { get; set; } = DateTime.UtcNow;
}
</code></pre>
<h3 id="12-å®šä¹‰æ—¥å¿—è®°å½•æŠ½è±¡ç±»">1.2 å®šä¹‰æ—¥å¿—è®°å½•æŠ½è±¡ç±»</h3>
<p>æ¥ä¸‹æ¥ï¼Œå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»<code>CustomLogger</code>ï¼Œå®ƒå®ç°äº†<code>ICustomLogger</code>æ¥å£ï¼Œå¹¶æä¾›äº†æ—¥å¿—è®°å½•çš„åŸºæœ¬åŠŸèƒ½ï¼Œå°†æ—¥å¿—å†™å…¥æ“ä½œï¼ˆæ’å…¥oræ›´æ–°ï¼‰æ”¾åœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­å¼‚æ­¥å¤„ç†ã€‚ä½¿ç”¨<code>ConcurrentQueue</code>æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å¼€å¯ä¸€ä¸ªåå°ä»»åŠ¡å¼‚æ­¥å¤„ç†è¿™äº›æ—¥å¿—ã€‚è¿™ä¸ªæŠ½è±¡ç±»åªè´Ÿè´£å°†æ—¥å¿—å†™å…¥å‘½ä»¤æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå®ç°ç±»è´Ÿè´£æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œç¡®å®šæ—¥å¿—åº”è¯¥æ€ä¹ˆå†™ï¼Ÿå¾€å“ªé‡Œå†™ï¼Ÿè¿™ä¸ªç¤ºä¾‹ä¸­åè¾¹ä¼šæœ‰ä¸¤ä¸ªå®ç°ï¼Œä¸€ä¸ªæ˜¯åŸºäºEntityFramework Coreçš„å®ç°ï¼Œå¦ä¸€ä¸ªæ˜¯MySqlConnectorçš„å®ç°ã€‚</p>
<p><strong>å°è£…ä¸€ä¸‹æ—¥å¿—å†™å…¥å‘½ä»¤</strong></p>
<pre><code class="language-csharp">namespace Logging.Abstractions;

public class WriteCommand(WriteCommandType commandType, CustomLogEntry logEntry)
{
    public WriteCommandType CommandType { get; } = commandType;
    public CustomLogEntry LogEntry { get; } = logEntry;
}

public enum WriteCommandType
{
    /// &lt;summary&gt;
    /// æ’å…¥
    /// &lt;/summary&gt;
    Insert,

    /// &lt;summary&gt;
    /// æ›´æ–°
    /// &lt;/summary&gt;
    Update
}
</code></pre>
<p><code>CustomLogger</code>å®ç°</p>
<pre><code class="language-csharp">using System.Collections.Concurrent;
using Microsoft.Extensions.Logging;

namespace Logging.Abstractions;

public abstract class CustomLogger : ICustomLogger, IDisposable, IAsyncDisposable
{
    protected ILogger&lt;CustomLogger&gt; Logger { get; }

    protected ConcurrentQueue&lt;WriteCommand&gt; WriteQueue { get; }

    protected Task WriteTask { get; }
    private readonly CancellationTokenSource _cancellationTokenSource;
    private readonly CancellationToken _cancellationToken;

    protected CustomLogger(ILogger&lt;CustomLogger&gt; logger)
    {
        Logger = logger;

        WriteQueue = new ConcurrentQueue&lt;WriteCommand&gt;();
        _cancellationTokenSource = new CancellationTokenSource();
        _cancellationToken = _cancellationTokenSource.Token;
        WriteTask = Task.Factory.StartNew(TryWriteAsync, _cancellationToken, TaskCreationOptions.LongRunning, TaskScheduler.Default);
    }

    public void LogReceived(CustomLogEntry logEntry)
    {
        WriteQueue.Enqueue(new WriteCommand(WriteCommandType.Insert, logEntry));
    }

    public void LogProcessed(string logId, bool isSuccess)
    {
        var logEntry = GetById(logId);
        if (logEntry == null)
        {
            return;
        }

        logEntry.IsSuccess = isSuccess;
        logEntry.UpdateTime = DateTime.UtcNow;
        WriteQueue.Enqueue(new WriteCommand(WriteCommandType.Update, logEntry));
    }

    private async Task TryWriteAsync()
    {
        try
        {
            while (!_cancellationToken.IsCancellationRequested)
            {
                if (WriteQueue.IsEmpty)
                {
                    await Task.Delay(1000, _cancellationToken);
                    continue;
                }

                if (WriteQueue.TryDequeue(out var writeCommand))
                {
                    await WriteAsync(writeCommand);
                }
            }

            while (WriteQueue.TryDequeue(out var remainingCommand))
            {
                await WriteAsync(remainingCommand);
            }
        }
        catch (OperationCanceledException)
        {
            // ä»»åŠ¡è¢«å–æ¶ˆï¼Œæ­£å¸¸é€€å‡º
        }
        catch (Exception e)
        {
            Logger.LogError(e, "å¤„ç†å¾…å†™å…¥æ—¥å¿—é˜Ÿåˆ—å¼‚å¸¸");
        }
    }

    protected abstract CustomLogEntry? GetById(string logId);

    protected abstract Task WriteAsync(WriteCommand writeCommand);

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    public async ValueTask DisposeAsync()
    {
        await DisposeAsyncCore();
        Dispose(false);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (disposing)
        {
            _cancellationTokenSource.Cancel();
            try
            {
                WriteTask.Wait();
            }
            catch (AggregateException ex)
            {
                foreach (var innerException in ex.InnerExceptions)
                {
                    Logger.LogError(innerException, "é‡Šæ”¾èµ„æºå¼‚å¸¸");
                }
            }
            finally
            {
                _cancellationTokenSource.Dispose();
            }
        }
    }

    protected virtual async Task DisposeAsyncCore()
    {
        _cancellationTokenSource.Cancel();
        try
        {
            await WriteTask;
        }
        catch (Exception e)
        {
            Logger.LogError(e, "é‡Šæ”¾èµ„æºå¼‚å¸¸");
        }
        finally
        {
            _cancellationTokenSource.Dispose();
        }
    }
}
</code></pre>
<h3 id="13-è¡¨ç»“æ„è¿ç§»">1.3 è¡¨ç»“æ„è¿ç§»</h3>
<p>ä¸ºäº†æ–¹ä¾¿è¡¨ç»“æ„è¿ç§»ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>FluentMigrator.Runner.MySql</code>ï¼Œåœ¨é¡¹ç›®ä¸­å¼•å…¥ï¼š</p>
<pre><code class="language-csharp">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
	&lt;PropertyGroup&gt;
		&lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
		&lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
		&lt;Nullable&gt;enable&lt;/Nullable&gt;
	&lt;/PropertyGroup&gt;

	&lt;ItemGroup&gt;
		&lt;PackageReference Include="FluentMigrator.Runner.MySql" Version="6.2.0" /&gt;
	&lt;/ItemGroup&gt;
&lt;/Project&gt;
</code></pre>
<p><strong>æ–°å»ºä¸€ä¸ª<code>CreateLogEntriesTable</code>ï¼Œæ”¾åœ¨Migrationsç›®å½•ä¸‹</strong></p>
<pre><code class="language-csharp">[Migration(20241216)]
public class CreateLogEntriesTable : Migration
{
    public override void Up()
    {
        Create.Table("LogEntries")
            .WithColumn("Id").AsString(36).PrimaryKey()
            .WithColumn("Message").AsCustom(text)
            .WithColumn("IsSuccess").AsBoolean().NotNullable()
            .WithColumn("CreateTime").AsDateTime().NotNullable()
            .WithColumn("UpdateTime").AsDateTime();
    }

    public override void Down()
    {
        Delete.Table("LogEntries");
    }
}
</code></pre>
<p><strong>æ·»åŠ æœåŠ¡æ³¨å†Œ</strong></p>
<pre><code class="language-csharp">using FluentMigrator.Runner;
using Logging.Abstractions;
using Logging.Abstractions.Migrations;

namespace Microsoft.Extensions.DependencyInjection;

public static class CustomLoggerExtensions
{
    /// &lt;summary&gt;
    /// æ·»åŠ è‡ªå®šä¹‰æ—¥å¿—æœåŠ¡è¡¨ç»“æ„è¿ç§»
    /// &lt;/summary&gt;
    /// &lt;param name="services"&gt;&lt;/param&gt;
    /// &lt;param name="connectionString"&gt;æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IServiceCollection AddCustomLoggerMigration(this IServiceCollection services, string connectionString)
    {
        services.AddFluentMigratorCore()
            .ConfigureRunner(
                rb =&gt; rb.AddMySql5()
                    .WithGlobalConnectionString(connectionString)
                    .ScanIn(typeof(CreateLogEntriesTable).Assembly)
                    .For.Migrations()
            )
            .AddLogging(lb =&gt;
            {
                lb.AddFluentMigratorConsole();
            });

        using var serviceProvider = services.BuildServiceProvider();
        using var scope = serviceProvider.CreateScope();
        var runner = scope.ServiceProvider.GetRequiredService&lt;IMigrationRunner&gt;();
        runner.MigrateUp();

        return services;
    }
}
</code></pre>
<h2 id="2-entityframework-core-çš„å®ç°">2. EntityFramework Core çš„å®ç°</h2>
<h3 id="21-æ•°æ®åº“ä¸Šä¸‹æ–‡">2.1 æ•°æ®åº“ä¸Šä¸‹æ–‡</h3>
<p>æ–°å»ºLogging.EntityFrameworkCoreé¡¹ç›®ï¼Œæ·»åŠ å¯¹Logging.Abstractionsé¡¹ç›®çš„å¼•ç”¨ï¼Œå¹¶åœ¨é¡¹ç›®ä¸­å®‰è£…<code>Pomelo.EntityFrameworkCore.MySql</code>å’Œ<code>Microsoft.Extensions.ObjectPool</code>ã€‚</p>
<pre><code class="language-csharp">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
  &lt;/PropertyGroup&gt;

  &lt;ItemGroup&gt;
    &lt;PackageReference Include="Microsoft.Extensions.ObjectPool" Version="8.0.11" /&gt;
    &lt;PackageReference Include="Pomelo.EntityFrameworkCore.MySql" Version="8.0.2" /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;ProjectReference Include="..\Logging.Abstractions\Logging.Abstractions.csproj" /&gt;
  &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<p><strong>åˆ›å»º<code>CustomLoggerDbContext</code>ç±»ï¼Œç”¨äºç®¡ç†æ—¥å¿—å®ä½“</strong></p>
<pre><code class="language-csharp">using Logging.Abstractions;
using Microsoft.EntityFrameworkCore;

namespace Logging.EntityFrameworkCore;

public class CustomLoggerDbContext(DbContextOptions&lt;CustomLoggerDbContext&gt; options) : DbContext(options)
{
    public virtual DbSet&lt;CustomLogEntry&gt; LogEntries { get; set; }
}
</code></pre>
<p>ä½¿ç”¨ <strong>ObjectPool</strong> ç®¡ç† <strong>DbContext</strong>ï¼šæé«˜æ€§èƒ½ï¼Œå‡å°‘ DbContext çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€ã€‚<br>
<strong>åˆ›å»º<code>CustomLoggerDbContextPoolPolicy</code></strong></p>
<pre><code class="language-csharp">using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.ObjectPool;

namespace Logging.EntityFrameworkCore;

/// &lt;summary&gt;
/// DbContext æ± ç­–ç•¥
/// &lt;/summary&gt;
/// &lt;param name="options"&gt;&lt;/param&gt;
public class CustomLoggerDbContextPoolPolicy(DbContextOptions&lt;CustomLoggerDbContext&gt; options) : IPooledObjectPolicy&lt;CustomLoggerDbContext&gt;
{
    /// &lt;summary&gt;
    /// åˆ›å»º DbContext
    /// &lt;/summary&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public CustomLoggerDbContext Create()
    {
        return new CustomLoggerDbContext(options);
    }

    /// &lt;summary&gt;
    /// å›æ”¶ DbContext
    /// &lt;/summary&gt;
    /// &lt;param name="context"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public bool Return(CustomLoggerDbContext context)
    {
        // é‡ç½® DbContext çŠ¶æ€
        context.ChangeTracker.Clear();
        return true; 
    }
} 
</code></pre>
<h3 id="22-å®ç°æ—¥å¿—å†™å…¥">2.2 å®ç°æ—¥å¿—å†™å…¥</h3>
<p>åˆ›å»ºä¸€ä¸ª<code>EfCoreCustomLogger</code>ï¼Œç»§æ‰¿è‡ª<code>CustomLogger</code>ï¼Œå®ç°æ—¥å¿—å†™å…¥çš„å…·ä½“é€»è¾‘</p>
<pre><code class="language-csharp">using Logging.Abstractions;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.ObjectPool;

namespace Logging.EntityFrameworkCore;

/// &lt;summary&gt;
/// EfCoreè‡ªå®šä¹‰æ—¥å¿—è®°å½•å™¨
/// &lt;/summary&gt;
public class EfCoreCustomLogger(ObjectPool&lt;CustomLoggerDbContext&gt; contextPool, ILogger&lt;EfCoreCustomLogger&gt; logger) : CustomLogger(logger)
{
    /// &lt;summary&gt;
    /// æ ¹æ®IdæŸ¥è¯¢æ—¥å¿—
    /// &lt;/summary&gt;
    /// &lt;param name="logId"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    protected override CustomLogEntry? GetById(string logId)
    {
        var dbContext = contextPool.Get();
        try
        {
            return dbContext.LogEntries.Find(logId);
        }
        finally
        {
            contextPool.Return(dbContext);
        }
    }

    /// &lt;summary&gt;
    /// å†™å…¥æ—¥å¿—
    /// &lt;/summary&gt;
    /// &lt;param name="writeCommand"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    /// &lt;exception cref="ArgumentOutOfRangeException"&gt;&lt;/exception&gt;
    protected override async Task WriteAsync(WriteCommand writeCommand)
    {
        var dbContext = contextPool.Get();

        try
        {
            switch (writeCommand.CommandType)
            {
                case WriteCommandType.Insert:
                    if (writeCommand.LogEntry != null)
                    {
                        await dbContext.LogEntries.AddAsync(writeCommand.LogEntry);
                    }

                    break;
                case WriteCommandType.Update:
                {
                    if (writeCommand.LogEntry != null)
                    {
                        dbContext.LogEntries.Update(writeCommand.LogEntry);
                    }

                    break;
                }
                default:
                    throw new ArgumentOutOfRangeException();
            }

            await dbContext.SaveChangesAsync();
        }
        finally
        {
            contextPool.Return(dbContext);
        }
    }
}
</code></pre>
<p><strong>æ·»åŠ æœåŠ¡æ³¨å†Œ</strong></p>
<pre><code class="language-csharp">using Logging.Abstractions;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.ObjectPool;

namespace Logging.EntityFrameworkCore;

public static class EfCoreCustomLoggerExtensions
{
    public static IServiceCollection AddEfCoreCustomLogger(this IServiceCollection services, string connectionString)
    {
        if (string.IsNullOrEmpty(connectionString))
        {
            throw new ArgumentNullException(nameof(connectionString));
        }

        services.AddCustomLoggerMigration(connectionString);

        services.AddSingleton&lt;ObjectPoolProvider, DefaultObjectPoolProvider&gt;();
        services.AddSingleton(serviceProvider =&gt;
        {
            var options = new DbContextOptionsBuilder&lt;CustomLoggerDbContext&gt;()
                .UseMySql(connectionString, ServerVersion.AutoDetect(connectionString))
                .Options;
            var poolProvider = serviceProvider.GetRequiredService&lt;ObjectPoolProvider&gt;();
            return poolProvider.Create(new CustomLoggerDbContextPoolPolicy(options));
        });

        services.AddSingleton&lt;ICustomLogger, EfCoreCustomLogger&gt;();

        return services;
    }
}
</code></pre>
<h2 id="3-mysqlconnector-çš„å®ç°">3. MySqlConnector çš„å®ç°</h2>
<p>MySqlConnector çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨åŸç”ŸSQLæ“ä½œæ•°æ®åº“å®Œæˆæ—¥å¿—çš„æ’å…¥å’Œæ›´æ–°ã€‚<br>
æ–°å»ºLogging.MySqlConnectoré¡¹ç›®ï¼Œæ·»åŠ å¯¹Logging.Abstractionsé¡¹ç›®çš„å¼•ç”¨ï¼Œå¹¶å®‰è£…<code>MySqlConnector</code>åŒ…</p>
<pre><code class="language-csharp">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
	&lt;PropertyGroup&gt;
		&lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
		&lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
		&lt;Nullable&gt;enable&lt;/Nullable&gt;
	&lt;/PropertyGroup&gt;

	&lt;ItemGroup&gt;
		&lt;PackageReference Include="MySqlConnector" Version="2.4.0" /&gt;
	&lt;/ItemGroup&gt;

	&lt;ItemGroup&gt;
		&lt;ProjectReference Include="..\Logging.Abstractions\Logging.Abstractions.csproj" /&gt;
	&lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre>
<h3 id="31-sqlè„šæœ¬">3.1 SQLè„šæœ¬</h3>
<p>ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬æŠŠéœ€è¦ç”¨åˆ°çš„SQLè„šæœ¬æ”¾åœ¨ä¸€ä¸ª<code>Consts</code>ç±»ä¸­</p>
<pre><code class="language-csharp">namespace Logging.MySqlConnector;

public class Consts
{
    /// &lt;summary&gt;
    /// æ’å…¥æ—¥å¿—
    /// &lt;/summary&gt;
    public const string InsertSql = """
                                    INSERT INTO `LogEntries` (`Id`, `TranceId`, `BizType`, `Body`, `Component`, `MsgType`, `Status`, `CreateTime`, `UpdateTime`, `Remark`)
                                    VALUES (@Id, @TranceId, @BizType, @Body, @Component, @MsgType, @Status, @CreateTime, @UpdateTime, @Remark);
                                    """;

    /// &lt;summary&gt;
    /// æ›´æ–°æ—¥å¿—
    /// &lt;/summary&gt;
    public const string UpdateSql = """
                                    UPDATE `LogEntries` SET `Status` = @Status, `UpdateTime` = @UpdateTime
                                    WHERE `Id` = @Id;
                                    """;

    /// &lt;summary&gt;
    /// æ ¹æ®IdæŸ¥è¯¢æ—¥å¿—
    /// &lt;/summary&gt;
    public const string QueryByIdSql = """
                                        SELECT `Id`, `TranceId`, `BizType`, `Body`, `Component`, `MsgType`, `Status`, `CreateTime`, `UpdateTime`, `Remark`
                                        FROM `LogEntries`
                                        WHERE `Id` = @Id;
                                        """;
}
</code></pre>
<h3 id="32-å®ç°æ—¥å¿—å†™å…¥">3.2 å®ç°æ—¥å¿—å†™å…¥</h3>
<p><strong>åˆ›å»º<code>MySqlConnectorCustomLogger</code>ç±»ï¼Œå®ç°æ—¥å¿—å†™å…¥çš„å…·ä½“é€»è¾‘</strong></p>
<pre><code class="language-csharp">using Logging.Abstractions;
using Microsoft.Extensions.Logging;
using MySqlConnector;

namespace Logging.MySqlConnector;

/// &lt;summary&gt;
/// ä½¿ç”¨ MySqlConnector å®ç°è®°å½•æ—¥å¿—
/// &lt;/summary&gt;
public class MySqlConnectorCustomLogger : CustomLogger
{

    /// &lt;summary&gt;
    /// æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
    /// &lt;/summary&gt;
    private readonly string _connectionString;

    /// &lt;summary&gt;
    /// æ„é€ å‡½æ•°
    /// &lt;/summary&gt;
    /// &lt;param name="connectionString"&gt;MySQLè¿æ¥å­—ç¬¦ä¸²&lt;/param&gt;
    /// &lt;param name="logger"&gt;&lt;/param&gt;
    public MySqlConnectorCustomLogger(
        string connectionString, 
        ILogger&lt;MySqlConnectorCustomLogger&gt; logger)
        : base(logger)
    {
        _connectionString = connectionString;
    }

    /// &lt;summary&gt; 
    /// æ ¹æ®IdæŸ¥è¯¢æ—¥å¿—
    /// &lt;/summary&gt;
    /// &lt;param name="logId"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    protected override CustomLogEntry? GetById(string logId)
    {
        using var connection = new MySqlConnection(_connectionString);
        connection.Open();

        using var command = new MySqlCommand(Consts.QueryByIdSql, connection);
        command.Parameters.AddWithValue("@Id", logId);

        using var reader = command.ExecuteReader();
        if (!reader.Read())
        {
            return null;
        }

        return new CustomLogEntry
        {
            Id = reader.GetString(0),
            Message = reader.GetString(1),
            IsSuccess = reader.GetBoolean(2),
            CreateTime = reader.GetDateTime(3),
            UpdateTime = reader.GetDateTime(4)
        };
    }

    /// &lt;summary&gt;
    /// å¤„ç†æ—¥å¿—
    /// &lt;/summary&gt;
    /// &lt;param name="writeCommand"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    /// &lt;exception cref="ArgumentOutOfRangeException"&gt;&lt;/exception&gt;
    protected override async Task WriteAsync(WriteCommand writeCommand)
    {
        await using var connection = new MySqlConnection(_connectionString);
        await connection.OpenAsync();

        switch (writeCommand.CommandType)
        {
            case WriteCommandType.Insert:
                {
                    if (writeCommand.LogEntry != null)
                    {
                        await using var command = new MySqlCommand(Consts.InsertSql, connection);
                        command.Parameters.AddWithValue("@Id", writeCommand.LogEntry.Id);
                        command.Parameters.AddWithValue("@Message", writeCommand.LogEntry.Message);
                        command.Parameters.AddWithValue("@IsSuccess", writeCommand.LogEntry.IsSuccess);
                        command.Parameters.AddWithValue("@CreateTime", writeCommand.LogEntry.CreateTime);
                        command.Parameters.AddWithValue("@UpdateTime", writeCommand.LogEntry.UpdateTime);
                        await command.ExecuteNonQueryAsync();
                    }

                    break;
                }
            case WriteCommandType.Update:
                {
                    if (writeCommand.LogEntry != null)
                    {
                        await using var command = new MySqlCommand(Consts.UpdateSql, connection);
                        command.Parameters.AddWithValue("@Id", writeCommand.LogEntry.Id);
                        command.Parameters.AddWithValue("@IsSuccess", writeCommand.LogEntry.IsSuccess);
                        command.Parameters.AddWithValue("@UpdateTime", writeCommand.LogEntry.UpdateTime);
                        await command.ExecuteNonQueryAsync();
                    }

                    break;
                }
            default:
                throw new ArgumentOutOfRangeException();
        }
    }
}
</code></pre>
<p><strong>æ·»åŠ æœåŠ¡æ³¨å†Œ</strong></p>
<pre><code class="language-csharp">using Logging.Abstractions;
using Logging.MySqlConnector;
using Microsoft.Extensions.Logging;

namespace Microsoft.Extensions.DependencyInjection;

/// &lt;summary&gt;
/// MySqlConnector æ—¥å¿—è®°å½•å™¨æ‰©å±•
/// &lt;/summary&gt;
public static class MySqlConnectorCustomLoggerExtensions
{
    /// &lt;summary&gt;
    /// æ·»åŠ  MySqlConnector æ—¥å¿—è®°å½•å™¨
    /// &lt;/summary&gt;
    /// &lt;param name="services"&gt;&lt;/param&gt;
    /// &lt;param name="connectionString"&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IServiceCollection AddMySqlConnectorCustomLogger(this IServiceCollection services, string connectionString)
    {
        if (string.IsNullOrEmpty(connectionString))
        {
            throw new ArgumentNullException(nameof(connectionString));
        }

        services.AddSingleton&lt;ICustomLogger&gt;(s =&gt;
        {
            var logger = s.GetRequiredService&lt;ILogger&lt;MySqlConnectorCustomLogger&gt;&gt;();
            return new MySqlConnectorCustomLogger(connectionString, logger);
        });
        services.AddCustomLoggerMigration(connectionString);

        return services;
    }
}
</code></pre>
<h2 id="4-ä½¿ç”¨ç¤ºä¾‹">4. ä½¿ç”¨ç¤ºä¾‹</h2>
<p>ä¸‹è¾¹æ˜¯ä¸€ä¸ªEntityFramework Coreçš„å®ç°ä½¿ç”¨ç¤ºä¾‹ï¼ŒMySqlConnectorçš„ä½¿ç”¨æ–¹å¼ç›¸åŒã€‚<br>
<strong>æ–°å»ºWebApié¡¹ç›®ï¼Œæ·»åŠ Logging.EntityFrameworkCore</strong></p>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// æ·»åŠ EntityFrameworkCoreæ—¥å¿—è®°å½•å™¨
var connectionString = builder.Configuration.GetConnectionString("MySql");
builder.Services.AddEfCoreCustomLogger(connectionString!);

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseAuthorization();

app.MapControllers();

app.Run();
</code></pre>
<p><strong>åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨</strong></p>
<pre><code class="language-csharp">namespace EntityFrameworkCoreTest.Controllers;

[ApiController]
[Route("[controller]")]
public class TestController(ICustomLogger customLogger) : ControllerBase
{
    [HttpPost("InsertLog")]
    public IActionResult Post(CustomLogEntry model)
    {
        customLogger.LogReceived(model);

        return Ok(); 
    }

    [HttpPut("UpdateLog")]
    public IActionResult Put(string logId, MessageStatus status)
    {
        customLogger.LogProcessed(logId, status);

        return Ok();
    }
} 
</code></pre>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="3.1702863640057872" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2024-12-20 10:54">2024-12-19 14:35</span>&nbsp;
<a href="https://www.cnblogs.com/Tangtang1997">è´¾å…‰è¾‰</a>&nbsp;
é˜…è¯»(<span id="post_view_count">1122</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">2</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18616866" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18616866);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18616866', targetLink: 'https://www.cnblogs.com/Tangtang1997/p/18616866', title: 'ä½¿ç”¨ .NET Core å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ—¥å¿—è®°å½•å™¨' })">ä¸¾æŠ¥</a>
</div>
        