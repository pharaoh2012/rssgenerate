
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sanyejun/p/19002339" title="å‘å¸ƒäº 2025-07-24 10:58">
    <span role="heading" aria-level="2">ä»Monoè„šæœ¬ç”ŸæˆEntityï¼šæ·±å…¥ç†è§£Unity DOTSä¸­çš„Archetypeã€Chunkä¸Entityç»“æ„è®¾è®¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p data-pm-slice="1 1 []">Unity çš„ DOTSï¼ˆData-Oriented Technology Stackï¼‰æ˜¯é¢å‘æ€§èƒ½æè‡´ä¼˜åŒ–çš„ä¸€ç§æ¶æ„èŒƒå¼ï¼Œå…¶åº•å±‚ç»“æ„è®¾è®¡å¹¶éå¶ç„¶ï¼Œè€Œæ˜¯æ·±æ€ç†Ÿè™‘çš„ç»“æœã€‚æœ¬ç¯‡æ–‡ç« å°†ä»å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„å…¥å£â€”â€”MonoBehaviour è„šæœ¬ + Baker å…¥æ‰‹ï¼Œé€æ­¥å‰–æ DOTS ä¸­ Entity æ˜¯å¦‚ä½•ç”Ÿæˆä¸ç»„ç»‡çš„ï¼Œå¹¶æ·±å…¥ç†è§£å…¶åº•å±‚æ¶æ„ï¼šArchetypeã€Chunkã€Entity çš„è®¾è®¡é€»è¾‘å’ŒåŠ¨æœºã€‚</p>
<div><hr></div>
<h2>ä¸€ã€ä» MonoBehaviour + Baker ç”Ÿæˆ Entity è¯´èµ·</h2>
<p>åœ¨ Unity DOTS ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Authoring + Baker çš„æ–¹å¼å°†ä¼ ç»Ÿçš„ GameObject è½¬æ¢ä¸º Entityã€‚ä¸€ä¸ªå¸¸è§çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>public class MonsterAuthoring : MonoBehaviour
{
    public int MonsterType;

    class Baker : Baker&lt;MonsterAuthoring&gt;
    {
        public override void Bake(MonsterAuthoring authoring)
        {
            var entity = GetEntity(TransformUsageFlags.Dynamic);
            AddComponent(entity, new Health { Value = 100 });
            AddComponent(entity, new Translation { Value = float3.zero });
            AddSharedComponent(entity, new MonsterType { TypeId = authoring.MonsterType });
        }
    }
}</code></pre>
<p>è¡¨é¢ä¸Šçœ‹ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨æ·»åŠ ç»„ä»¶ã€‚ç„¶è€Œåœ¨èƒŒåï¼ŒUnity DOTS ä¼šæ ¹æ®è¿™äº›ç»„ä»¶è‡ªåŠ¨ä¸ºè¿™ä¸ª Entity åˆ›å»ºå½’å±ç»“æ„â€”â€”Archetypeï¼Œå¹¶ä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´â€”â€”Chunkã€‚</p>
<div><hr></div>
<h2>äºŒã€Entity æ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>Entity æ˜¯ DOTS ä¸­æœ€åŸºæœ¬çš„å•ä½ï¼Œä½†æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå¼•ç”¨å¥æŸ„ï¼š</p>
<pre><code>public struct Entity
{
    public int Index;     // åœ¨å†…éƒ¨æ•°ç»„ä¸­çš„ä½ç½®
    public int Version;   // ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ£€æµ‹ç”¨
}</code></pre>
<p>Entity ä»£è¡¨çš„æ˜¯ä¸€ä¸ªâ€œIDâ€ï¼Œå®ƒçš„æ•°æ®å­˜åœ¨ Chunk ä¸­ï¼Œå®ƒçš„ç»„ä»¶å®šä¹‰äº†å®ƒçš„â€œèƒ½åŠ›å’ŒçŠ¶æ€â€ã€‚</p>
<div><hr></div>
<h2>ä¸‰ã€Archetypeï¼šç»„ä»¶ç»„åˆå®šä¹‰å®ä½“ç»“æ„</h2>
<p>å½“ä½ ç»™ä¸€ä¸ª Entity æ·»åŠ äº†å¤šä¸ªç»„ä»¶æ—¶ï¼ŒUnity ä¼šè‡ªåŠ¨æ ¹æ®è¿™äº›ç»„ä»¶çš„é›†åˆå®šä¹‰ä¸€ä¸ª Archetypeã€‚å®ƒå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªâ€œç»“æ„ç­¾åâ€ï¼š</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code>Archetype A = [Translation, Health, MonsterType]
Archetype B = [Translation, Velocity]</code></pre>
<p>æ‰€æœ‰å…·æœ‰ç›¸åŒç»„ä»¶ç»„åˆçš„ Entity éƒ½å±äºåŒä¸€ä¸ª Archetypeã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p>
<ul data-spread="false">
<li>
<p>å¯ä»¥å¿«é€Ÿå®šä½æ‹¥æœ‰æŸäº›ç»„ä»¶çš„æ‰€æœ‰å®ä½“</p>
</li>
<li>
<p>æ–¹ä¾¿æ•°æ®æ‰¹å¤„ç†</p>
</li>
<li>
<p>æ”¯æŒç»“æ„åŒ–å­˜å‚¨ï¼ˆæ–¹ä¾¿å†…å­˜å¸ƒå±€ï¼‰</p>
</li>
</ul>
<div><hr></div>
<h2>å››ã€Chunkï¼šç»“æ„åŒ–å†…å­˜å—</h2>
<p>æ¯ä¸ª Archetype æ‹¥æœ‰è‹¥å¹²ä¸ª Chunkã€‚Chunk æ˜¯ DOTS ä¸­ç”¨äºå­˜å‚¨å®ä½“æ•°æ®çš„æœ€å°å•ä½ã€‚</p>
<h3>âœ… Chunk ç‰¹ç‚¹ï¼š</h3>
<ul data-spread="false">
<li>
<p>å¤§å°å›ºå®šä¸º <strong>16KB</strong>ï¼ˆUnity å†…éƒ¨å›ºå®šï¼‰</p>
</li>
<li>
<p>æ‰€æœ‰ Entity çš„ç»„ä»¶æ•°æ®æŒ‰åˆ—å¼å­˜å‚¨</p>
</li>
<li>
<p>æ¯ä¸ª Chunk åªå®¹çº³ä¸€ç§ Archetype çš„å®ä½“</p>
</li>
<li>
<p>åŒä¸€ä¸ª Chunk ä¸­æ‰€æœ‰ Entity çš„ SharedComponent å€¼å¿…é¡»ä¸€è‡´</p>
</li>
</ul>
<h3>ğŸ§® ä¸€ä¸ª Chunk å®¹çº³å¤šå°‘ä¸ª Entityï¼Ÿ</h3>
<p>å–å†³äºæ¯ä¸ª Entity æ‹¥æœ‰ç»„ä»¶æ•°æ®çš„æ€»å¤§å°ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul data-spread="false">
<li>
<p>Entity æ¯ä¸ªæ•°æ® 32Bï¼Œåˆ™ Chunk å®¹çº³ 16KB / 32 â‰ˆ 512 ä¸ª</p>
</li>
<li>
<p>è‹¥æ•°æ®å˜å¤§ï¼ˆå¦‚åŒ…å« float4x4ï¼‰ï¼ŒEntity å˜å°‘</p>
</li>
</ul>
<div><hr></div>
<h2>äº”ã€SharedComponentï¼šæ§åˆ¶ Chunk åˆ†ç±»çš„å…³é”®</h2>
<p>SharedComponent æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„ä»¶ï¼Œå®ç°äº† <code>ISharedComponentData</code> æ¥å£ã€‚å®ƒçš„å€¼ä¸èƒ½åœ¨ Entity çº§åˆ«å­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ Chunk çš„ header åŒºåŸŸã€‚</p>
<h3>ç‰¹æ€§ï¼š</h3>
<ul data-spread="false">
<li>
<p>æ‰€æœ‰ Chunk å†…çš„ Entity å¿…é¡»æ‹¥æœ‰ç›¸åŒçš„ SharedComponent å€¼</p>
</li>
<li>
<p>å€¼ä¸åŒçš„ Entity ä¸èƒ½æ”¾åœ¨åŒä¸€ä¸ª Chunk ä¸­</p>
</li>
<li>
<p>æ›´æ”¹ SharedComponent å€¼ä¼šå¯¼è‡´ Entity æ¬å®¶ï¼ˆChunk ç§»åŠ¨ï¼‰</p>
</li>
</ul>
<h3>ä½¿ç”¨åœºæ™¯ï¼š</h3>
<ul data-spread="false">
<li>
<p>æ€ªç‰©ç±»å‹åˆ†ç±»ï¼ˆå¦‚ MonsterTypeï¼‰</p>
</li>
<li>
<p>LOD åˆ†ç»„ã€åŒºåŸŸåˆ†ç»„ã€æ¸²æŸ“æè´¨åˆ†ç»„ï¼ˆRenderMeshArrayï¼‰</p>
</li>
</ul>
<h3>æ³¨æ„ï¼šé¢‘ç¹æ›´æ”¹ SharedComponent ä¼šå¼•èµ·æ€§èƒ½æŠ–åŠ¨</h3>
<div><hr></div>
<h2>å…­ã€ä¸ºä»€ä¹ˆ Chunk æ˜¯ 16KBï¼Ÿ</h2>
<p>è¿™ä¸ªæ•°å­—æ˜¯æ·±æ€ç†Ÿè™‘åçš„ç¡¬ä»¶é€‚é…å€¼ï¼š</p>
<ul data-spread="false">
<li>
<p>L1 Cache ä¸€èˆ¬ä¸º 32KBï¼Œæ¯ä¸ª Chunk 16KB å¯ä»¥ä¿è¯é«˜ç¼“å­˜å‘½ä¸­ç‡</p>
</li>
<li>
<p>L2 Cache è¾ƒå¤§ï¼Œä¹Ÿèƒ½å®¹çº³å¤šä¸ª Chunk</p>
</li>
<li>
<p>16KB æ˜¯å†…å­˜å¯¹é½ã€æ‰¹å¤„ç†ã€é¡µç®¡ç†çš„é»„é‡‘æŠ˜ä¸­å€¼</p>
</li>
</ul>
<p>å¤ªå°ï¼šEntity å¤ªå°‘ã€æ•ˆç‡ä½ å¤ªå¤§ï¼šCache æº¢å‡ºã€å¤„ç†æ…¢</p>
<p>å› æ­¤ Unity é»˜è®¤è®¾å®šä¸º 16KBï¼Œä¸å¯ä¿®æ”¹ã€‚</p>
<div><hr></div>
<h2>ä¸ƒã€Archetypeã€Chunkã€Entity çš„ç»„ç»‡ç»“æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰</h2>
<pre><code>Archetype A: [Translation, Health, MonsterType]
â”‚
â”œâ”€ Chunk A1 (MonsterType = 1)
â”‚   â”œâ”€ Entity 1
â”‚   â”œâ”€ Entity 2
â”‚   â””â”€ ...
â”‚
â”œâ”€ Chunk A2 (MonsterType = 2)
â”‚   â”œâ”€ Entity 1001
â”‚   â””â”€ ...
â””â”€ ...</code></pre>
<div><hr></div>
<h2>å…«ã€æ€»ç»“ï¼šè®¾è®¡èƒŒåçš„å“²å­¦</h2>
<p>Unity DOTS çš„ Archetype-Chuck-Entity ç»“æ„ï¼Œèåˆäº†ä»¥ä¸‹é¢†åŸŸçš„ç²¾é«“ï¼š</p>
<table>
<tbody>
<tr><th>çµæ„Ÿæ¥æº</th><th>åº”ç”¨ç‚¹</th></tr>
<tr>
<td>æ•°æ®å¯¼å‘è®¾è®¡ DoD</td>
<td>æ„å»º Archetype ä»¥ä¼˜åŒ–è®¿é—®ç»“æ„</td>
</tr>
<tr>
<td>åˆ—å¼æ•°æ®åº“</td>
<td>Chunk å†…ç»„ä»¶æŒ‰åˆ—æ’åˆ—</td>
</tr>
<tr>
<td>ç¨€ç–é›†åˆï¼ˆIndex+Versionï¼‰</td>
<td>å®‰å…¨åœ°ç®¡ç† Entity ç”Ÿå‘½å‘¨æœŸ</td>
</tr>
<tr>
<td>GPU æ¸²æŸ“ç®¡çº¿</td>
<td>SharedComponent æ§åˆ¶åˆ†ç»„æ¸²æŸ“</td>
</tr>
</tbody>
</table>
<p>å…¶æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š<strong>åˆ©ç”¨ç°ä»£ç¡¬ä»¶ç¼“å­˜ç‰¹æ€§ï¼Œè®©å¤§è§„æ¨¡æ•°æ®æ›´æ–°ä¸å¤„ç†é«˜æ•ˆè€Œå¯æ§ã€‚</strong></p>
<div><hr></div>
<h2>ä¹ã€é™„ï¼šå¦‚ä½•æŸ¥çœ‹å®é™… Chunk/Archetype</h2>
<ul data-spread="false">
<li>
<p>é€šè¿‡ <code>Entities Hierarchy</code>ï¼ˆWindow â†’ Entitiesï¼‰å¯è§†åŒ–å·¥å…·æŸ¥çœ‹ Chunk åˆ†å¸ƒ</p>
</li>
<li>
<p>é€šè¿‡ä»£ç ï¼š</p>
</li>
</ul>
<pre><code>EntityQuery query = GetEntityQuery(typeof(Health), typeof(MonsterType));
var chunks = query.ToArchetypeChunkArray(Allocator.Temp);
Debug.Log($"Archetype has {chunks.Length} chunks");</code></pre>
<div><hr></div>
<h2>ç»“è¯­</h2>
<p>ä½ åªæ˜¯åœ¨ Mono è„šæœ¬é‡Œå†™äº†å‡ è¡Œ AddComponentï¼ŒUnity åœ¨èƒŒåå·²ç»å¸®ä½ æ„å»ºå¥½äº†å¤æ‚è€Œé«˜æ•ˆçš„æ•°æ®å¤„ç†æ¶æ„ã€‚è¿™å°±æ˜¯ DOTS çš„é­…åŠ›æ‰€åœ¨â€”â€”å¼€å‘è€…ä¸“æ³¨é€»è¾‘ï¼Œç³»ç»Ÿä¿éšœæ€§èƒ½ã€‚</p>
<p>ç†è§£ Archetypeã€Chunkã€Entity çš„å†…åœ¨åŸç†ï¼Œæ˜¯èµ°å‘ DOTS é«˜æ•ˆæ¶æ„è®¾è®¡çš„ç¬¬ä¸€æ­¥ã€‚</p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0020833333333333333" data-date-updated="2025-07-24 11:01">2025-07-24 10:58</span>&nbsp;
<a href="https://www.cnblogs.com/sanyejun">ä¸‰é¡µèŒ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19002339);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19002339', targetLink: 'https://www.cnblogs.com/sanyejun/p/19002339', title: 'ä»Monoè„šæœ¬ç”ŸæˆEntityï¼šæ·±å…¥ç†è§£Unity DOTSä¸­çš„Archetypeã€Chunkä¸Entityç»“æ„è®¾è®¡' })">ä¸¾æŠ¥</a>
</div>
        