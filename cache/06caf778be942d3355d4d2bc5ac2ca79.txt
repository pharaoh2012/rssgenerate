
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/imadc/p/19002991" title="å‘å¸ƒäº 2025-07-24 20:08">
    <span role="heading" aria-level="2">æœ¬å¯é¿å…çš„P1äº‹æ•…ï¼šNginxå˜æ›´å¯¼è‡´ç½‘å…³è¯·æ±‚å‡å“åº”400</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h5 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h5>
<p>é¡¹ç›®ä¸Šä½¿ç”¨SpringCloudGatewayä½œä¸ºç½‘å…³æ‰¿æ¥å…¬ç½‘ä¸Šå„ä¸ªä¸šåŠ¡çº¿è¿›æ¥çš„è¯·æ±‚æµé‡ï¼Œåœ¨ç½‘å…³çš„å‰é¢æœ‰ä¸¤å°Nginxåå‘ä»£ç†äº†ç½‘å…³ï¼Œç½‘å…³åšäº†ä¸€ç³»åˆ—çš„å‰ç½®å¤„ç†åè½¬å‘è¯·æ±‚åˆ°åé¢å„ä¸ªä¸šåŠ¡çº¿çš„æœåŠ¡ï¼Œç®€è¦çš„ç½‘ç»œé“¾è·¯ä¸ºï¼š</p>
<pre><code class="language-tex">ç½‘å…³åŸŸå(wmg.test.com) -&gt; ... -&gt; Nginx -&gt;F5(ç¡¬è´Ÿè½½åŸŸåfp.wmg.test) -&gt; ç½‘å…³ -&gt; ä¸šåŠ¡ç³»ç»Ÿ
</code></pre>
<p>æŸå¤©ï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¦å¢åŠ ä¸¤å°æ–°çš„Nginxæœºå™¨ï¼ŒåŸå› è¯´æ¥è¯é•¿ï¼ŒæŒ‰ä¸‹ä¸è¡¨ï¼Œä½¿ç”¨ä¸¤å°æ–°çš„Nginxæœºå™¨æ›¿ä»£æ‰åŸå…ˆåå‘ä»£ç†ç½‘å…³çš„ä¸¤å°Nginxã€‚</p>
<h5 id="sreç­‰çº§å®šæ€§p1">SREç­‰çº§å®šæ€§P1</h5>
<p>ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™šï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¿›è¡Œäº†ç”Ÿäº§å˜æ›´ï¼Œåœ¨ä¸¤å°æ–°æœºå™¨ä¸Šéƒ¨ç½²äº†Nginxï¼Œç„¶åè®©ç½‘ç»œå›¢é˜Ÿå°†ç½‘å…³åŸŸåçš„æµé‡åˆ‡æ¢åˆ°äº†ä¸¤å°æ–°çš„Nginxæœºå™¨ä¸Šï¼Œåˆšåˆ‡æ¢å®Œï¼Œç«‹é©¬æœ‰ä¸šåŠ¡çº¿å›¢é˜Ÿçš„äººååº”ï¼Œè¿‡ç½‘å…³çš„æ¥å£è¯·æ±‚éƒ½å˜æˆ400äº†ã€‚è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿåˆè®©ç½‘ç»œå›¢é˜Ÿå°†ç½‘å…³åŸŸåæµé‡åˆ‡å›åˆ°åŸæœ‰çš„ä¸¤å°Nginxä¸Šï¼Œä¸šåŠ¡çº¿è¿‡ç½‘å…³çš„æ¥å£è¯·æ±‚æ¢å¤æ­£å¸¸ï¼ŒæŒç»­äº†ä¸¤åˆ†å¤šé’Ÿï¼ŒSREç­‰çº§å®šæ€§P1ã€‚</p>
<p>è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¯´ï¼Œä¸¤å°æ–°çš„Nginxé…ç½®å’ŒåŸæœ‰çš„ä¸¤å°Nginxé…ç½®ä¸€æ ·ï¼Œçœ‹ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼Œæ‰¾åˆ°æˆ‘ï¼Œè®©æˆ‘ä»ç½‘å…³æ’æŸ¥æœ‰æ²¡æœ‰ä»€ä¹ˆé”™è¯¯æ—¥å¿—ã€‚</p>
<p>ä¸å¤ªå¯èƒ½å§ï¼Œå¦‚æœæ–°çš„ä¸¤å°Nginxé…ç½®å’ŒåŸæœ‰çš„ä¸¤å°Nginxé…ç½®ä¸€æ ·çš„è¯ï¼Œä¸ä¼šå‡ºç°è¯·æ±‚éƒ½æ˜¯400çš„é—®é¢˜å•Šï¼Œæˆ‘å¿ƒæƒ³ï¼Œä¸è¿‡è¿˜æ˜¯å»çœ‹äº†ç½‘å…³ä¸Šçš„æ—¥å¿—ï¼Œåœ¨é‚£ä¸ªæ—¶é—´æ®µï¼Œç½‘å…³æ²¡æœ‰é”™è¯¯æ—¥å¿—å‡ºç°ã€‚</p>
<p>çœ‹äº†ä¸‹æ–°Nginxçš„æ—¥å¿—ï¼ŒOptionsè¯·æ±‚æ­£å¸¸è¿”å›204ï¼Œå…¶å®ƒçš„GETã€POSTè¯·æ±‚éƒ½æ˜¯400ï¼ŒOptionsæ˜¯é¢„æ£€è¯·æ±‚ï¼Œåœ¨Nginxå±‚é¢å°±å¤„ç†è¿”å›äº†ï¼Œæ–°Nginxçš„æ—¥å¿—ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">10.x.x.x:63048 &gt; -  &gt; 10.x.x.x:8099 &gt; [2025-07-17T10:36:26+08:00] &gt; 10.x.x.x:8099  OPTIONS /api/xxx HTTP/1.1 &gt; 204 &gt; 0 &gt; https://domain/ &gt; Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 &gt; - &gt; [req_time:0.000 s] &gt;[upstream_connect_time:- s]&gt; [upstream_header_time:- s] &gt; [upstream_resp_time:- s] [-]
10.x.x.x:63048 &gt; -  &gt; 10.x.x.x:8099 &gt; [2025-07-17T10:36:26+08:00] &gt; 10.x.x.x:8099  POST /api/xxx HTTP/1.1 &gt; 400 &gt; 0 &gt; https://domain/ &gt; Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 &gt; - &gt; [req_time:0.001 s] &gt;[upstream_connect_time:0.000 s]&gt; [upstream_header_time:0.001 s] &gt; [upstream_resp_time:0.001 s] [10.x.x.x:8082]
</code></pre>
<p>å»æ‰¾äº†ç½‘ç»œå›¢é˜Ÿï¼Œä»æµé‡å›æº¯è®¾å¤‡ä¸Šçœ‹åˆ°400ç¡®å®æ˜¯ç½‘å…³è¿”å›çš„ï¼Œè¿˜æ²¡æœ‰åˆ°åé¢çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œ400ä»£è¡¨BadRequestï¼Œæˆ‘æ€€ç–‘æ˜¯ä¸æ˜¯è¯·æ±‚ä½“çš„é—®é¢˜ï¼Œæƒ³è®©ç½‘ç»œå°†é‚£ä¸ªæ—¶é—´æ®µçš„æµé‡åŒ…æ•°æ®å–ä¸‹æ¥åˆ†æï¼Œç½‘ç»œæ²¡ç»™ï¼Œåªç»™æˆ‘äº†ä¸šåŠ¡æŠ¥æ–‡å‚æ•°ï¼Œèµ°ç½‘å…³è¯·æ±‚çš„ä¸šåŠ¡å‚æ•°æŠ¥æ–‡æ˜¯åŠ å¯†çš„ï¼Œæˆ‘æœ¬åœ°è¿è¡Œç¨‹åºå¯ä»¥æ­£å¸¸è§£å¯†æŠ¥æ–‡ï¼Œæˆ‘åé¦ˆç»™äº†è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿã€‚</p>
<p>è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸåˆèŠ±äº†ä¸€æ®µæ—¶é—´å®šä½é—®é¢˜ï¼Œè¿˜æ˜¯æ²¡æœ‰å¤´ç»ªï¼Œåˆæ‰¾åˆ°æˆ‘ï¼Œè®©æˆ‘å¸®å¿™åˆ†æè°ƒæŸ¥ä¸‹ã€‚</p>
<h5 id="ä»‹å…¥è°ƒæŸ¥">ä»‹å…¥è°ƒæŸ¥</h5>
<p>æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåœ°å€æ˜¯å•¥ï¼Œæˆ‘å…ˆåœ¨æµ‹è¯•ç¯å¢ƒçœ‹ä¸‹èƒ½ä¸èƒ½å¤ç°ï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿæˆå‘˜è¯´ï¼Œæ²¡æœ‰åœ¨æµ‹è¯•ç¯å¢ƒæ­å»ºæµ‹è¯•ï¼Œè¿™ä¸€æ¬¡å˜æ›´æ˜¯å¦ä¸€ä¸ªæˆå‘˜ç›´æ¥ç”Ÿäº§å˜æ›´ã€‚</p>
<p>ğŸ˜“</p>
<p>æˆ‘è¦æ¥äº†æ–°çš„Nginxé…ç½®æ–‡ä»¶å’Œè€çš„Nginxé…ç½®æ–‡ä»¶æ¯”å¯¹äº†ä¸‹ï¼Œå‘ç°æœ‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œè€Nginxä¸Šåå‘ä»£ç†ç½‘å…³çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">server {
    listen 8080;
    server_name wmg.test.com;
    
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Content-Security-Policy "frame-ancestors 'self'";
	
    location / {
        proxy_hide_header  host;
        client_max_body_size    100m;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
        add_header 'Access-Control-Allow-Headers' '...';
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        proxy_pass http://fp.wmg.test:8090;
    }
}
</code></pre>
<p>æ–°Nginxé…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">upstream http_gateways{
  server fp.wmg.test:8090;
  keepalive 30;
}

server {
    listen 8080 backlog=512;
    server_name wmg.test.com;
    
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Content-Security-Policy "frame-ancestors 'self'";
    
    location / {
        proxy_hide_header  host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        client_max_body_size    100m;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
        add_header 'Access-Control-Allow-Headers' '...';
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        proxy_pass http://http_gateways;
    }
}
</code></pre>
<p>æ–°Nginxä»£ç†ç½‘å…³çš„é…ç½®ä¸åŸæœ‰Nginxä¸Šçš„é…ç½®åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨upstreamé…ç½®äº†ç½‘å…³çš„F5è´Ÿè½½å‡è¡¡åœ°å€ï¼š</p>
<pre><code>upstream http_gateways{
  server fp.wmg.test:8090;
  keepalive 30;
}
</code></pre>
</li>
<li>
<p>è®¾ç½®httpåè®®ä¸º1.1ï¼Œå¯ç”¨é•¿è¿æ¥</p>
<pre><code class="language-shell">proxy_http_version 1.1;
proxy_set_header Connection "";
</code></pre>
</li>
</ul>
<p>æˆ‘è®©è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿåœ¨æµ‹è¯•ç¯å¢ƒçš„Nginxä¸ŠæŒ‰ç…§æ–°çš„Nginxé…ç½®æ¨¡æ‹Ÿäº†ç”Ÿäº§ç¯å¢ƒï¼š</p>
<p>Nginxï¼š10.100.8.11 ç›‘å¬9104ç«¯å£</p>
<p>ç½‘å…³ï¼š10.100.22.48 ç›‘å¬8081ç«¯å£</p>
<p>Nginxçš„9104ç«¯å£è½¬å‘åˆ°ç½‘å…³çš„8081ç«¯å£ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">upstream http_gateways{
  server 10.100.22.48:8081;
  keepalive 30;
}

server {
    listen 9104 backlog=512;
    server_name localhost;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Content-Security-Policy "frame-ancestors 'self'";

    location / {
        proxy_hide_header  host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        client_max_body_size    100m;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
        add_header 'Access-Control-Allow-Headers' '...';
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        proxy_pass http://http_gateways;
    }
}
</code></pre>
<h5 id="é—®é¢˜å¤ç°">é—®é¢˜å¤ç°</h5>
<p>é€šè¿‡Nginxè¯·æ±‚ç½‘å…³åˆ°åç«¯æœåŠ¡æ¥å£ï¼Œé—®é¢˜å¤ç°ï¼Œè¯·æ±‚å“åº”400ï¼š</p>
<pre><code class="language-shell">curl -v -X GET http://10.100.8.11:9104/wechat-web/actuator/info
</code></pre>
<p>å»æ‰ä¸‹é¢çš„ä¸¤ä¸ªé…ç½®ï¼Œè¯·æ±‚æ­£å¸¸å“åº”200ï¼š</p>
<pre><code class="language-shell">proxy_http_version 1.1;
proxy_set_header Connection "";
</code></pre>
<h5 id="å¤©å¤–æ¥é”…">å¤©å¤–æ¥é”…</h5>
<p>å°†è¿™ä¸ªç°è±¡åé¦ˆç»™äº†è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿï¼Œç»“æœè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸæŸ¥äº†åŠå¤©è¯´ç½‘å…³ä¸æ”¯æŒé•¿è¿æ¥ï¼Œè¦è®©ç½‘å…³æ”¹é€ ã€‚</p>
<p>ğŸ˜“</p>
<p>ä¸åº”è¯¥å•Šï¼Œä»¥å¾€ç½‘å…³å‘ç‰ˆçš„æ—¶å€™ï¼Œæ˜¯æ»šåŠ¨å‘ç‰ˆçš„ï¼ŒF5ä¸Šå…ˆä¸‹æ‰ä¸€ä¸ªæœºå™¨çš„æµé‡ï¼Œåœå¯è¿™ä¸ªæœºå™¨ä¸Šçš„ç½‘å…³æœåŠ¡ï¼Œç„¶åF5ä¸Šæµé‡ï¼ŒF5ä¸‹æµé‡çš„æ—¶å€™æ˜¯æœ‰é•¿è¿æ¥å­˜åœ¨çš„ï¼Œæ¯æ¬¡éƒ½ä¼šç­‰ä¸ª5åˆ†é’Ÿå·¦å³æ‰èƒ½ä¸‹æ‰ä¸€è·¯çš„æµé‡ã€‚</p>
<p>å¾—ï¼Œå…ˆæ”¾ä¸‹æ‰‹å¤´çš„å·¥ä½œï¼ŒèŠ±ç‚¹æ—¶é—´æ¥è¯æ˜ç½‘å…³æ˜¯æ”¯æŒé•¿è¿æ¥çš„ã€‚</p>
<p>åœ¨Nginxæœºå™¨ä¸Šé€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šé•¿è¿æ¥æ–¹å¼è®¿é—®ç½‘å…³è¯·æ±‚åç«¯æœåŠ¡æ¥å£ï¼š</p>
<pre><code class="language-shell">wget -d --header="Connection: keepalive" http://10.100.22.48:8081/wechat-web/actuator/info http://10.100.22.48:8081/wechat-web/actuator/info http://10.100.22.48:8081/wechat-web/actuator/info
</code></pre>
<p>å›è½¦å‡ºç°å¦‚ä¸‹æ—¥å¿—ï¼š</p>
<pre><code class="language-shell">Setting --header (header) to Connection: keepalive
DEBUG output created by Wget 1.14 on linux-gnu.

URI encoding = â€˜UTF-8â€™
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
--2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
Connecting to 10.100.22.48:8081... connected.
Created socket 3.
Releasing 0x0000000000c95a90 (new refcount 0).
Deleting unused 0x0000000000c95a90.

---request begin---
GET /wechat-web/actuator/info HTTP/1.1
User-Agent: Wget/1.14 (linux-gnu)
Accept: */*
Host: 10.100.22.48:8081
Connection: keepalive

---request end---
HTTP request sent, awaiting response... 
---response begin---
HTTP/1.1 200 OK
transfer-encoding: chunked
Content-Type: application/vnd.spring-boot.actuator.v3+json
Date: Thu, 17 Jul 2025 05:25:34 GMT

---response end---
200 OK
Registered socket 3 for persistent reuse.
Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
Saving to: â€˜infoâ€™

    [ &lt;=&gt;                                                                                                                                                              ] 83          --.-K/s   in 0s      

2025-07-17 13:45:08 (7.75 MB/s) - â€˜infoâ€™ saved [83]

URI encoding = â€˜UTF-8â€™
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
--2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
Reusing existing connection to 10.100.22.48:8081.
Reusing fd 3.

---request begin---
GET /wechat-web/actuator/info HTTP/1.1
User-Agent: Wget/1.14 (linux-gnu)
Accept: */*
Host: 10.100.22.48:8081
Connection: keepalive

---request end---
HTTP request sent, awaiting response... 
---response begin---
HTTP/1.1 200 OK
transfer-encoding: chunked
Content-Type: application/vnd.spring-boot.actuator.v3+json
Date: Thu, 17 Jul 2025 05:25:34 GMT

---response end---
200 OK
Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
Saving to: â€˜info.1â€™

    [ &lt;=&gt;                                                                                                                                                              ] 83          --.-K/s   in 0s      

2025-07-17 13:45:08 (9.47 MB/s) - â€˜info.1â€™ saved [83]

URI encoding = â€˜UTF-8â€™
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
Converted file name 'info' (UTF-8) -&gt; 'info' (UTF-8)
--2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
Reusing existing connection to 10.100.22.48:8081.
Reusing fd 3.

---request begin---
GET /wechat-web/actuator/info HTTP/1.1
User-Agent: Wget/1.14 (linux-gnu)
Accept: */*
Host: 10.100.22.48:8081
Connection: keepalive

---request end---
HTTP request sent, awaiting response... 
---response begin---
HTTP/1.1 200 OK
transfer-encoding: chunked
Content-Type: application/vnd.spring-boot.actuator.v3+json
Date: Thu, 17 Jul 2025 05:25:34 GMT

---response end---
200 OK
Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
Saving to: â€˜info.2â€™

    [ &lt;=&gt;                                                                                                                                                              ] 83          --.-K/s   in 0s      

2025-07-17 13:45:08 (11.1 MB/s) - â€˜info.2â€™ saved [83]

FINISHED --2025-07-17 13:45:08--
Total wall clock time: 0.1s
Downloaded: 3 files, 249 in 0s (9.25 MB/s)

</code></pre>
<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚å»ºç«‹äº†socket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724151519794-1361370271.png" class="lazyload"></p>
<p>ç¬¬äºŒä¸ªè¯·æ±‚é‡ç”¨äº†ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œsocket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724151528366-612035678.png" class="lazyload"></p>
<p>ç¬¬ä¸‰ä¸ªè¯·æ±‚ä¾ç„¶é‡ç”¨äº†ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œsocket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724151537229-1743932975.png" class="lazyload"></p>
<p>ç½‘å…³æ˜¯æ”¯æŒé•¿è¿æ¥çš„ï¼Œåé¦ˆç»™è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸåˆæŸ¥äº†åŠå¤©ï¼Œåˆæ‰¾åˆ°æˆ‘è¯´è¿˜æ˜¯å¾—æ‹œæ‰˜æˆ‘æ¥è°ƒæŸ¥è§£å†³æ‰è¿™ä¸ªé—®é¢˜ã€‚</p>
<h5 id="æ·±åº¦è°ƒæŸ¥">æ·±åº¦è°ƒæŸ¥</h5>
<p>åœ¨æµ‹è¯•ç¯å¢ƒNginxæœºå™¨10.100.8.11ä¸Šä½¿ç”¨tcpdumpå‘½ä»¤æŠ“å–ä¸ç½‘å…³ç›¸å…³çš„æµé‡åŒ…ï¼š</p>
<pre><code class="language-shell">tcpdump -vv -i ens192 host 10.100.22.48 and tcp port 8081 -w /tmp/ng400.cap
</code></pre>
<p>æ‰¾åˆ°å‡ºç°httpå“åº”ç ä¸º400çš„è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°æµé‡åŒ…ä¸­çš„wechat-web/actuator/infoè¯·æ±‚å“åº”ä¸ºï¼šHTTP/1.1 400 Bad Request</p>
<p>è§‚å¯Ÿè¯·æ±‚ä½“ï¼Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚å¤´Hostçš„å€¼ä¸ºï¼šhttp_gatewaysï¼Œè¿™å¼•èµ·äº†æˆ‘çš„æ³¨æ„ï¼š</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724193744202-2086782784.png" class="lazyload"></p>
<p>æŸ¥é˜…èµ„æ–™å¾—åˆ°ï¼ŒHTTP/1.1åè®®è§„èŒƒå®šä¹‰HTTP/1.1ç‰ˆæœ¬å¿…é¡»ä¼ é€’Hostè¯·æ±‚å¤´</p>
<pre><code class="language-tex">- Both clients and servers MUST support the Host request-header.
- A client that sends an HTTP/1.1 request MUST send a Host header.
- Servers MUST report a 400 (Bad Request) error if an HTTP/1.1
        request does not include a Host request-header.
- Servers MUST accept absolute URIs.
</code></pre>
<p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.2" target="_blank" rel="noopener nofollow">https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.2</a></p>
<p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html#sec19.6.1.1" target="_blank" rel="noopener nofollow">https://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html#sec19.6.1.1</a></p>
<p>Hostçš„æ ¼å¼å¯ä»¥åŒ…å«ï¼š. å’Œ - ç‰¹æ®Šç¬¦å·ï¼Œ_ ä¸è¢«æ”¯æŒ</p>
<p>æŸ¥é˜…Nginxçš„å®˜æ–¹æ–‡æ¡£å¾—çŸ¥ï¼Œ<em>proxy_set_header</em> æœ‰ä¸¤ä¸ªé»˜è®¤é…ç½®ï¼š</p>
<pre><code>proxy_set_header Host       $proxy_host;
proxy_set_header Connection close;
</code></pre>
<p><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" target="_blank" rel="noopener nofollow">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header</a></p>
<p>å¯ä»¥çœ‹å‡ºNginxå¯ç”¨äº†HTTP/1.1åè®®ï¼ŒHostå¦‚æœæ²¡æœ‰æŒ‡å®šä¼šå–$proxy_hostï¼Œé‚£ä¹ˆä½¿ç”¨upstreamçš„æƒ…å†µä¸‹ï¼Œ$proxy_hostå°±æ˜¯upstreamçš„åç§°ï¼Œè€Œæ­¤å¤„çš„upstreamä¸­åŒ…å«_ï¼Œä¸æ˜¯åˆæ³•çš„Hostæ ¼å¼ã€‚</p>
<p>HTTP/1.1è§„å®šå¿…é¡»ä¼ é€’Hostçš„ä¸€æ–¹é¢åŸå› å°±æ˜¯ä¸ºäº†æ”¯æŒå•IPåœ°å€æ‰˜ç®¡å¤šåŸŸåçš„è™šæ‹Ÿä¸»æœºåŠŸèƒ½ï¼Œæ–¹ä¾¿åç«¯æœåŠ¡æ ¹æ®ä¸åŒæ¥æºHoståšä¸åŒçš„å¤„ç†ã€‚</p>
<pre><code class="language-tex">Older HTTP/1.0 clients assumed a one-to-one relationship of IP addresses and servers; there was no other established mechanism for distinguishing the intended server of a request than the IP address to which that request was directed. The changes outlined above will allow the Internet, once older HTTP clients are no longer common, to support multiple Web sites from a single IP address, greatly simplifying large operational Web servers, where allocation of many IP addresses to a single host has created serious problems. 
</code></pre>
<p>é‚£ä¹ˆåªè¦éµå¾ªäº†HTTP/1.1åè®®è§„èŒƒçš„æ¡†æ¶ï¼ˆTomcatã€SpringCloudGatewayã€...ï¼‰åœ¨è§£æHostæ—¶å‘ç°Hostä¸æ˜¯åˆæ³•çš„æ ¼å¼æ—¶ï¼Œå°±å“åº”äº†400ã€‚</p>
<p>æœ¬åœ°æ­å»ºäº†ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œdebugäº†ä¸‹ç½‘å…³çš„ä»£ç ï¼Œåœ¨SpringCloudGatewayè§£æhttpè¯·æ±‚ç±»ReactorHttpHandlerAdapterä¸­çš„applyæ–¹æ³•é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œè§£æHostå¤±è´¥ä¼šå“åº”400ï¼š</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724151449498-927084501.png" class="lazyload"></p>
<p>ä¸‹é¢æ˜¯SpringCloudGatewayè§£æhttpè¯·æ±‚ç±»ReactorHttpHandlerAdapterä¸­çš„applyæ–¹æ³•é€»è¾‘ï¼š</p>
<pre><code class="language-java">public Mono&lt;Void&gt; apply(HttpServerRequest reactorRequest, HttpServerResponse reactorResponse) {
	NettyDataBufferFactory bufferFactory = new NettyDataBufferFactory(reactorResponse.alloc());
	try {
		ReactorServerHttpRequest request = new ReactorServerHttpRequest(reactorRequest, bufferFactory);
		ServerHttpResponse response = new ReactorServerHttpResponse(reactorResponse, bufferFactory);
		if (request.getMethod() == HttpMethod.HEAD) {
			response = new HttpHeadResponseDecorator(response);
		}
		return this.httpHandler.handle(request, response)
				.doOnError(ex -&gt; logger.trace(request.getLogPrefix() + "Failed to complete: " + ex.getMessage()))
				.doOnSuccess(aVoid -&gt; logger.trace(request.getLogPrefix() + "Handling completed"));
	}
	catch (URISyntaxException ex) {
		if (logger.isDebugEnabled()) {
			logger.debug("Failed to get request URI: " + ex.getMessage());
		}
		reactorResponse.status(HttpResponseStatus.BAD_REQUEST);
		return Mono.empty();
	}
}
</code></pre>
<p>SpringCloudGatewayé€šè¿‡debugçº§åˆ«æ—¥å¿—è¾“å‡ºè¿™ç±»ä¸ç¬¦åˆåè®®è§„èŒƒçš„æ—¥å¿—ï¼Œç”Ÿäº§æ—¥å¿—çº§åˆ«ä¸ºinfoï¼Œå› æ­¤ä¸ä¼šæ‰“å°è¿™æ ·å¼‚å¸¸çš„æ—¥å¿—ã€‚</p>
<h5 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h5>
<p>æ—¢ç„¶HTTP/1.1åè®®è§„å®šå¿…é¡»ä¼ é€’Hostä¸”æ²¡æœ‰é€šè¿‡é…ç½®æ˜¾å¼æŒ‡å®šNginxä¼ é€’çš„Hostæ—¶Nginxä¼šæœ‰é»˜è®¤å€¼ï¼Œé‚£ä¹ˆåœ¨Nginxçš„é…ç½®ä¸­å¢åŠ ä¼ é€’Hostçš„é…ç½®è¦†ç›–é»˜è®¤å€¼çš„é€»è¾‘ï¼ŒæŸ¥é˜…Nginxçš„æ–‡æ¡£ï¼Œå¯ä»¥é€šè¿‡å¢åŠ ä¸‹é¢çš„é…ç½®è§£å†³ï¼š</p>
<pre><code class="language-shell">proxy_set_header Host       $host;
</code></pre>
<p>åœ¨æµ‹è¯•ç¯å¢ƒNginx9104ç«¯å£ä»£ç†é…ç½®ä¸­å¢åŠ ä¸Šé¢çš„é…ç½®ï¼Œå†æ¬¡æ‰§è¡Œï¼Œè¯·æ±‚æ­£å¸¸å“åº”200ã€‚</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1407141/202507/1407141-20250724151427627-1307945051.png" class="lazyload"></p>
<p>å®Œæ•´é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">upstream http_gateways{
  server 10.100.22.48:8081;
  keepalive 30;
}

server {
    listen 9104 backlog=512;
    server_name wmg.test.com;
    
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Content-Security-Policy "frame-ancestors 'self'";
    
    location / {
        proxy_set_header Host       $host;
        proxy_hide_header  host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        client_max_body_size    100m;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
        add_header 'Access-Control-Allow-Headers' '...';
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        proxy_pass http://http_gateways;
    }
}
</code></pre>
<p>è§£å†³æ–¹æ¡ˆä¸æ­¢ä¸€ä¸ª:</p>
<ul>
<li>å¯ä»¥ä¿®æ”¹upstreamçš„åç§°ï¼Œå»æ‰ä¸æ”¯æŒçš„_ï¼Œæ¯”å¦‚æ›´æ¢ä¸ºï¼šhttp-gatewaysã€httpgateways</li>
<li>è¿˜å¯ä»¥ç›´æ¥æŒ‡å®šHostçš„å€¼ä¸ºåŸŸåï¼ˆdomainï¼‰ï¼Œproxy_set_header Host       'doamin';</li>
</ul>
<h5 id="æ€»ç»“">æ€»ç»“</h5>
<p>è¿™ä¸ªé—®é¢˜åªè¦åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ä¸‹ï¼Œæ˜¯å¿…ç°çš„ï¼Œä¸å±äºæµ‹è¯•caseæ²¡æœ‰è¦†ç›–åˆ°çš„èŒƒç•´ï¼Œä¸€å®šè¦é‡è§†æµ‹è¯•æµç¨‹ï¼Œå¾ˆå¤šæµç¨‹çœ‹ä¼¼ç¹çï¼Œå…¶å®éƒ½æ˜¯è¡€ä¸æ³ªçš„æ•™è®­å¾—æ¥çš„ã€‚</p>

</div>
<div id="MySignature" role="contentinfo">
    <p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href="https://www.cnblogs.com/imadc/" target="_blank">æœåŠ²æ¾</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href="https://www.cnblogs.com/imadc/p/19002991" target="_blank">https://www.cnblogs.com/imadc/p/19002991</a></p>
</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-24 20:08">2025-07-24 20:08</span>&nbsp;
<a href="https://www.cnblogs.com/imadc">æœåŠ²æ¾</a>&nbsp;
é˜…è¯»(<span id="post_view_count">1577</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">14</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19002991);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19002991', targetLink: 'https://www.cnblogs.com/imadc/p/19002991', title: 'æœ¬å¯é¿å…çš„P1äº‹æ•…ï¼šNginxå˜æ›´å¯¼è‡´ç½‘å…³è¯·æ±‚å‡å“åº”400' })">ä¸¾æŠ¥</a>
</div>
	