
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/YangJieCheng/p/18768844" title="å‘å¸ƒäº 2025-03-12 22:49">
    <span role="heading" aria-level="2">Laravel11 ä»0å¼€å‘ Swoole-Reverb æ‰©å±•åŒ…ï¼ˆå››ï¼‰ - è§¦å‘ä¸€ä¸ªå¹¿æ’­äº‹ä»¶åˆ°reverbæœåŠ¡ä¹‹åæ˜¯å¦‚ä½•è½¬å‘ç»™å‰ç«¯è®¢é˜…çš„å‘¢ï¼ˆä¸‹ï¼‰ï¼Ÿ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="å‰æƒ…æè¦">å‰æƒ…æè¦</h1>
<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²åˆ°äº†reverbæœåŠ¡çš„é€šä¿¡ä¸Šä¸‹æ–‡å’Œè·¯ç”±å¤„ç†ï¼Œè·¯ç”±å®ç°äº†pusherå…³è”çš„å‡ ç§è¯·æ±‚ã€‚é‚£ä¹ˆè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸»è¦æ¥è®²æ··å“æœåŠ¡Server</p>
<h1 id="æ··å“-server">æ··å“ Server</h1>
<p>è´Ÿè´£åŸºäº ReactPHP çš„ SocketServer å’Œäº‹ä»¶å¾ªç¯æ„å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼ˆå®ç°äº†ä¸€ä¸ªè½»é‡çº§ã€å¼‚æ­¥çš„ HTTP æœåŠ¡å™¨ã€‚é€šè¿‡æ³¨å†Œäº‹ä»¶ã€è¯·æ±‚è§£æã€å¼‚å¸¸æ•è·ç­‰æœºåˆ¶ï¼Œä¿è¯äº†è¯·æ±‚çš„æ­£ç¡®å¤„ç†å’Œå¼‚å¸¸æƒ…å†µä¸‹çš„ä¼˜é›…å“åº”ï¼‰ã€‚å®ƒä¸»è¦å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š è¿æ¥ç®¡ç†ï¼šé€šè¿‡ç›‘å¬æ–°è¿æ¥ï¼ˆ__invoke æ–¹æ³•ï¼‰æ¥å¤„ç†æ•°æ®äº‹ä»¶ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™è¯·æ±‚å¤„ç†é€»è¾‘ã€‚ è¯·æ±‚è§£æä¸åˆ†å‘ï¼šå°†åŸå§‹æ•°æ®è½¬æ¢ä¸º PSR-7 Request å¯¹è±¡ï¼Œå¹¶äº¤ç”±è·¯ç”±å™¨åˆ†å‘ã€‚ å¼‚å¸¸å¤„ç†ä¸é”™è¯¯å“åº”ï¼šæ•è·è¯·æ±‚è°ƒåº¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ï¼Œè¿”å›å¯¹åº” HTTP çŠ¶æ€ç å’Œæ¶ˆæ¯ã€‚ åƒåœ¾å›æ”¶ä¼˜åŒ–ï¼šé€šè¿‡å®šæ—¶å™¨è°ƒç”¨åƒåœ¾å›æ”¶ï¼Œé™ä½å†…å­˜ç¢ç‰‡ã€‚ TLS æ£€æµ‹ï¼šåˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦æ”¯æŒåŠ å¯†è¿æ¥ã€‚</p>
<h1 id="serverå¯åŠ¨">serverå¯åŠ¨</h1>
<p>æˆ‘ä»¬èµ°åˆ° <code>vendor/laravel/reverb/src/Servers/Reverb/Http/Server.php</code>æ–‡ä»¶ï¼Œä»£ç ä¸å¤šï¼Œæˆ‘å…ˆè´´å‡ºæ¥</p>
<pre><code class="language-php">&lt;?php

namespace Laravel\Reverb\Servers\Reverb\Http;

use Illuminate\Support\Str;
use Laravel\Reverb\Loggers\Log;
use Laravel\Reverb\Servers\Reverb\Concerns\ClosesConnections;
use OverflowException;
use Psr\Http\Message\RequestInterface;
use React\EventLoop\Loop;
use React\EventLoop\LoopInterface;
use React\Socket\ConnectionInterface;
use React\Socket\ServerInterface;
use Symfony\Component\HttpKernel\Exception\HttpException;
use Throwable;

class Server
{
    use ClosesConnections;

    /**
     * Create a new Http server instance.
     */
    public function __construct(protected ServerInterface $socket, protected Router $router, protected int $maxRequestSize, protected ?LoopInterface $loop = null)
    {
        gc_disable();

        $this-&gt;loop = $loop ?: Loop::get();

        $this-&gt;loop-&gt;addPeriodicTimer(30, fn () =&gt; gc_collect_cycles());

        $socket-&gt;on('connection', $this);
    }

    /**
     * Start the Http server
     */
    public function start(): void
    {
        $this-&gt;loop-&gt;run();
    }

    /**
     * Handle an incoming request.
     */
    protected function handleRequest(string $message, Connection $connection): void
    {
        if ($connection-&gt;isConnected()) {
            return;
        }

        if (($request = $this-&gt;createRequest($message, $connection)) === null) {
            return;
        }

        $connection-&gt;connect();

        try {
            $this-&gt;router-&gt;dispatch($request, $connection);
        } catch (HttpException $e) {
            $this-&gt;close($connection, $e-&gt;getStatusCode(), $e-&gt;getMessage());
        } catch (Throwable $e) {
            Log::error($e-&gt;getMessage());
            $this-&gt;close($connection, 500, 'Internal server error.');
        }
    }

    /**
     * Create a Psr7 request from the incoming message.
     */
    protected function createRequest(string $message, Connection $connection): ?RequestInterface
    {
        try {
            $request = Request::from($message, $connection, $this-&gt;maxRequestSize);
        } catch (OverflowException $e) {
            $this-&gt;close($connection, 413, 'Payload too large.');
        } catch (Throwable $e) {
            $this-&gt;close($connection, 400, 'Bad request.');
        }

        return $request ?? null;
    }

    /**
     * Stop the Http server
     */
    public function stop(): void
    {
        $this-&gt;loop-&gt;stop();

        $this-&gt;socket-&gt;close();
    }

    /**
     * Invoke the server with a new connection instance.
     */
    public function __invoke(ConnectionInterface $connection): void
    {
        $connection = new Connection($connection);

        $connection-&gt;on('data', function ($data) use ($connection) {
            $this-&gt;handleRequest($data, $connection);
        });
    }

    /**
     * Determine whether the server has TLS support.
     */
    public function isSecure(): bool
    {
        return Str::startsWith($this-&gt;socket-&gt;getAddress(), 'tls://');
    }
}

</code></pre>
<p>é¦–å…ˆæˆ‘ä»¬å…³æ³¨startæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¤–å±‚å·¥å‚è°ƒç”¨æœåŠ¡å¯åŠ¨çš„æ–¹æ³•ï¼šå¯åŠ¨æœåŠ¡</p>
<pre><code class="language-php">    public function start(): void
    {
        $this-&gt;loop-&gt;run();
    }
</code></pre>
<p>start() æ–¹æ³•ç®€å•åœ°å¯åŠ¨äº‹ä»¶å¾ªç¯ã€‚æ‰€æœ‰æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯çš„å®šæ—¶å™¨ã€IO äº‹ä»¶å’Œè¿æ¥å¤„ç†éƒ½å°†åœ¨ run() æ–¹æ³•è°ƒç”¨åå¼€å§‹æ‰§è¡Œã€‚ è¿™æ˜¯æ•´ä¸ª HTTP æœåŠ¡å™¨çš„å…¥å£ï¼Œè°ƒç”¨åæœåŠ¡å™¨è¿›å…¥é˜»å¡çŠ¶æ€ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚<br>
åœ¨èµ°åˆ°æˆ‘ä»¬çš„æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="language-php">  public function __construct(protected ServerInterface $socket, protected Router $router, protected int $maxRequestSize, protected ?LoopInterface $loop = null)
    {
	  // è°ƒç”¨ gc_disable() ç¦ç”¨ PHP çš„è‡ªåŠ¨åƒåœ¾å›æ”¶
        gc_disable();
        $this-&gt;loop = $loop ?: Loop::get();
		//ç„¶åä½¿ç”¨äº‹ä»¶å¾ªç¯çš„å®šæ—¶å™¨æ¯ 30 ç§’æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ gc_collect_cycles()ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶å†…å­˜ç®¡ç†ï¼Œé˜²æ­¢è‡ªåŠ¨åƒåœ¾å›æ”¶å¸¦æ¥çš„æ€§èƒ½æ³¢åŠ¨
        $this-&gt;loop-&gt;addPeriodicTimer(30, fn () =&gt; gc_collect_cycles());
        $socket-&gt;on('connection', $this);
    }
</code></pre>
<p>å¤§å®¶åœ¨è¿™é‡Œå¯ä»¥åœä¸‹æ¥ğŸ¤”ï¸ä¸‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™é‡Œæœ‰ä¸¤ç‚¹æ˜¯å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„ï¼Œæ¥ä¸‹æ¥æˆ‘å°±å’Œå¤§å®¶ä¸€èµ·æ¥å­¦ä¹ ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<h2 id="åƒåœ¾å›æ”¶æœºåˆ¶">åƒåœ¾å›æ”¶æœºåˆ¶</h2>
<p>ç”±äºPHP çš„åƒåœ¾å›æ”¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æ»¡è¶³æ¡ä»¶åè§¦å‘ï¼Œå› æ­¤ï¼Œphpæä¾›äº†æ‰‹åŠ¨æ“ä½œgcçš„æ–¹æ³•ï¼Œé‚£ä¹ˆé€šè¿‡reverbçš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰æœºä¼šç”¨åˆ°è‡ªå·±çš„é¡¹ç›®ä»£ç ä¸­ã€‚</p>
<p>ä¸‹é¢æ˜¯AIçš„æ€»ç»“ï¼š</p>
<h3 id="1-php-7-åŠä»¥åçš„åƒåœ¾å›æ”¶æœºåˆ¶"><strong>1. PHP 7 åŠä»¥åçš„åƒåœ¾å›æ”¶æœºåˆ¶</strong></h3>
<p>PHP 7 ç»§ç»­ä½¿ç”¨ <strong>å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰</strong> ä½œä¸ºä¸»è¦çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¹¶é…åˆ <strong>å¾ªç¯å¼•ç”¨æ£€æµ‹ï¼ˆCycle Detectionï¼‰</strong> è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p>
<h4 id="11-ä¸»è¦ç»„æˆéƒ¨åˆ†"><strong>1.1 ä¸»è¦ç»„æˆéƒ¨åˆ†</strong></h4>
<ol>
<li>
<p><strong>å¼•ç”¨è®¡æ•°ï¼ˆReference Counting, RCï¼‰</strong></p>
<ul>
<li>PHP çš„å˜é‡æ˜¯åŸºäºå¼•ç”¨è®¡æ•°è¿›è¡Œç®¡ç†çš„ï¼Œæ¯ä¸ªå˜é‡éƒ½æœ‰ä¸€ä¸ª <strong>å¼•ç”¨è®¡æ•°å™¨ï¼ˆrefcountï¼‰</strong>ã€‚</li>
<li>å½“å˜é‡è¢«èµ‹å€¼æˆ–ä¼ é€’æ—¶ï¼Œå¼•ç”¨è®¡æ•°å¢åŠ ã€‚</li>
<li>å½“å˜é‡çš„ä½œç”¨åŸŸç»“æŸæˆ– unset() é‡Šæ”¾å˜é‡æ—¶ï¼Œå¼•ç”¨è®¡æ•°å‡å°‘ã€‚</li>
<li>å½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ï¼Œå˜é‡å ç”¨çš„å†…å­˜è¢«ç«‹å³é‡Šæ”¾ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¾ªç¯å¼•ç”¨æ£€æµ‹ï¼ˆCycle Collectionï¼‰</strong></p>
<ul>
<li>PHP 7 åŠä»¥åç‰ˆæœ¬é‡‡ç”¨ <strong>ä¸‰ä»£åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGenerational GCï¼‰</strong> è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼ˆå³ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¼šå½’é›¶ï¼‰ã€‚</li>
<li>é‡‡ç”¨ <strong>åˆ†ä»£æ”¶é›†ï¼ˆGenerational Collectionï¼‰</strong>ï¼Œå°†å˜é‡åˆ†ä¸º <strong>å¹´è½»ä»£ï¼ˆyoungï¼‰ã€ä¸­ç”Ÿä»£ï¼ˆmiddle-agedï¼‰ã€è€å¹´ä»£ï¼ˆoldï¼‰</strong>ï¼Œå‡å°‘ä¸å¿…è¦çš„åƒåœ¾å›æ”¶æ“ä½œã€‚</li>
</ul>
</li>
<li>
<p><strong>åˆ†ä»£åƒåœ¾å›æ”¶ï¼ˆGenerational Garbage Collectionï¼‰</strong></p>
<ul>
<li><strong>å¹´è½»ä»£ï¼ˆyoungï¼‰</strong>ï¼šåˆšåˆ›å»ºçš„å˜é‡ï¼ŒGC è§¦å‘é¢‘ç‡é«˜ã€‚</li>
<li><strong>ä¸­ç”Ÿä»£ï¼ˆmiddle-agedï¼‰</strong>ï¼šå·²å­˜æ´»ä¸€æ®µæ—¶é—´çš„å˜é‡ï¼ŒGC è§¦å‘é¢‘ç‡è¾ƒä½ã€‚</li>
<li><strong>è€å¹´ä»£ï¼ˆoldï¼‰</strong>ï¼šå­˜æ´»å¾ˆä¹…çš„å˜é‡ï¼ŒGC è§¦å‘æœ€å°‘ã€‚</li>
<li>è¿™ç§ç­–ç•¥å‡å°‘äº†åƒåœ¾å›æ”¶å¯¹æ€§èƒ½çš„å½±å“ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="2-php-7-åŠä»¥åçš„åƒåœ¾å›æ”¶ç­–ç•¥"><strong>2. PHP 7 åŠä»¥åçš„åƒåœ¾å›æ”¶ç­–ç•¥</strong></h3>
<h4 id="21-è§¦å‘æ¡ä»¶"><strong>2.1 è§¦å‘æ¡ä»¶</strong></h4>
<p>PHP çš„åƒåœ¾å›æ”¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶è§¦å‘ï¼š</p>
<ol>
<li><strong>å˜é‡çš„å¼•ç”¨è®¡æ•°é™ä¸º 0</strong>ï¼Œç«‹å³é‡Šæ”¾å†…å­˜ï¼ˆé€‚ç”¨äºæ— å¾ªç¯å¼•ç”¨çš„å˜é‡ï¼‰ã€‚</li>
<li><strong>åƒåœ¾å›æ”¶é˜ˆå€¼è§¦å‘</strong>ï¼Œå³ï¼š
<ul>
<li><strong>å½“åˆ›å»ºçš„æ–°å˜é‡æ•°é‡è¶…è¿‡ GC é˜ˆå€¼</strong>ï¼ˆé»˜è®¤ 10,000ï¼‰ï¼ŒGC å¯èƒ½ä¼šè¿è¡Œã€‚</li>
<li><strong>å½“ PHP å‘ç°æœ‰å¾ªç¯å¼•ç”¨</strong>ï¼Œä¼šè¿›å…¥ GC è¿‡ç¨‹ï¼Œé‡Šæ”¾å¾ªç¯å¼•ç”¨çš„å†…å­˜ã€‚</li>
</ul>
</li>
</ol>
<h4 id="22-å…³é”®ä¼˜åŒ–ç‚¹"><strong>2.2 å…³é”®ä¼˜åŒ–ç‚¹</strong></h4>
<ul>
<li><strong>å‡å°‘ä¸å¿…è¦çš„ GC è§¦å‘</strong>
<ul>
<li>ç”±äºé‡‡ç”¨äº†<strong>åˆ†ä»£åƒåœ¾å›æ”¶</strong>ï¼ŒPHP ä¸ä¼šæ¯æ¬¡éƒ½æ‰«ææ‰€æœ‰å˜é‡ï¼Œè€Œæ˜¯ä¼˜å…ˆå›æ”¶<strong>å¹´è½»ä»£å˜é‡</strong>ï¼Œå‡å°‘å½±å“ã€‚</li>
</ul>
</li>
<li><strong>æå‡ GC æ‰§è¡Œæ•ˆç‡</strong>
<ul>
<li>PHP 7 ä¼˜åŒ–äº† GC ç®—æ³•ï¼Œä½¿å¾—æ¸…ç†å¾ªç¯å¼•ç”¨çš„æ“ä½œæ›´å¿«ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜åŒ–å˜é‡ç®¡ç†</strong>
<ul>
<li>PHP 7 å¯¹ <code>zend_mm_heap</code>ï¼ˆPHP å†…å­˜ç®¡ç†å™¨ï¼‰è¿›è¡Œäº†æ”¹è¿›ï¼Œæé«˜äº†å˜é‡åˆ†é…å’Œå›æ”¶çš„æ•ˆç‡ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-å¸¸è§é—®é¢˜åŠä¼˜åŒ–å»ºè®®"><strong>3. å¸¸è§é—®é¢˜åŠä¼˜åŒ–å»ºè®®</strong></h3>
<h4 id="31-é¿å…å¾ªç¯å¼•ç”¨"><strong>3.1 é¿å…å¾ªç¯å¼•ç”¨</strong></h4>
<p>å¦‚æœ PHP ä»£ç ä¸­å­˜åœ¨å¯¹è±¡ç›¸äº’å¼•ç”¨ï¼ŒGC å¯èƒ½ä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ã€‚è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><strong>ä½¿ç”¨ <code>WeakReference</code>ï¼ˆPHP 7.4+ï¼‰</strong>ï¼š</p>
<pre><code class="language-php">$obj1 = new stdClass();
$obj2 = new stdClass();

$obj1-&gt;ref = WeakReference::create($obj2);
$obj2-&gt;ref = WeakReference::create($obj1);
</code></pre>
<p>è¿™æ ·ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼ŒGC è§¦å‘æ—¶å¯ä»¥æ­£å¸¸å›æ”¶ã€‚</p>
</li>
<li>
<p><strong>æ‰‹åŠ¨é‡Šæ”¾å¼•ç”¨</strong></p>
<pre><code class="language-php">$obj1-&gt;ref = null;
$obj2-&gt;ref = null;
</code></pre>
</li>
</ul>
<h4 id="32-æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶"><strong>3.2 æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶</strong></h4>
<p>å¦‚æœå†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒç”¨ <code>gc_collect_cycles()</code> è¿›è¡Œåƒåœ¾å›æ”¶ï¼š</p>
<pre><code class="language-php">gc_collect_cycles();
</code></pre>
<p>ä½†é€šå¸¸æƒ…å†µä¸‹ï¼ŒPHP çš„ GC æœºåˆ¶å·²ç»è¶³å¤Ÿæ™ºèƒ½ï¼Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ã€‚</p>
<h4 id="33-å…³é—­è°ƒæ•´-gc"><strong>3.3 å…³é—­/è°ƒæ•´ GC</strong></h4>
<ul>
<li>
<p><strong>ç¦ç”¨ GC</strong>ï¼ˆåœ¨ç‰¹å®šæƒ…å†µä¸‹æé«˜æ€§èƒ½ï¼‰ï¼š</p>
<pre><code class="language-php">gc_disable();
</code></pre>
<p>é€‚ç”¨äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„è„šæœ¬ï¼Œä¾‹å¦‚ CLI å·¥å…·ã€ä»»åŠ¡é˜Ÿåˆ—ç­‰ï¼Œé¿å… GC å½±å“æ‰§è¡Œé€Ÿåº¦ã€‚</p>
</li>
<li>
<p><strong>é‡æ–°å¯ç”¨ GC</strong></p>
<pre><code class="language-php">gc_enable();
</code></pre>
</li>
<li>
<p><strong>è°ƒæ•´ GC é˜ˆå€¼</strong><br>
å¯ä»¥é€šè¿‡ <code>gc_mem_caches()</code> è°ƒæ•´å›æ”¶ç­–ç•¥ï¼Œä¼˜åŒ–é•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ã€‚</p>
</li>
</ul>
<hr>
<h3 id="4-æ€»ç»“"><strong>4. æ€»ç»“</strong></h3>
<table>
<thead>
<tr>
<th><strong>PHP ç‰ˆæœ¬</strong></th>
<th><strong>åƒåœ¾å›æ”¶æœºåˆ¶</strong></th>
<th><strong>ä¼˜åŒ–ç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PHP 7+</strong></td>
<td>å¼•å…¥ <strong>åˆ†ä»£åƒåœ¾å›æ”¶ï¼ˆGenerational GCï¼‰</strong></td>
<td>æé«˜ GC æ•ˆç‡ï¼Œå‡å°‘æ€§èƒ½å¼€é”€</td>
</tr>
<tr>
<td><strong>PHP 7.4+</strong></td>
<td>å¼•å…¥ <code>WeakReference</code></td>
<td>é¿å…ä¸å¿…è¦çš„å¼•ç”¨è®¡æ•°</td>
</tr>
</tbody>
</table>
<h2 id="__invokeä½¿ç”¨">__invokeä½¿ç”¨</h2>
<p>__invoke æ˜¯ PHP çš„é­”æœ¯æ–¹æ³•ä¹‹ä¸€ï¼Œå…è®¸å¯¹è±¡åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ è®©ç±»çš„å®ä¾‹å¯ä»¥åƒå‡½æ•°ä¸€æ ·æ‰§è¡Œï¼Œä»è€Œæä¾›æ›´çµæ´»çš„ä»£ç è®¾è®¡</p>
<p><code> $socket-&gt;on('connection', $this);</code>,connection å¯¹åº”çš„æ˜¯$thisï¼Œæ–°è¿æ¥å¤„ç†å°±åœ¨__invokeã€‚å› æ­¤æˆ‘ä»¬å…³æ³¨çš„ç‚¹å°±åœ¨__invokeä¸Šäº†ï¼Œå¯ä»¥çœ‹åˆ°laravelæ¡†æ¶æœ‰å¾ˆå¤šçš„åœ°æ–¹ä½¿ç”¨äº†__invokeï¼Œé‚£ä¹ˆå¯¹äºæˆ‘ä»¬æ¥è¯´ä¹Ÿæ˜¯æœ‰æœºä¼šç”¨åˆ°è‡ªå·±çš„ä»£ç é‡Œçš„ã€‚</p>
<hr>
<h1 id="æ–°è¿æ¥å¤„ç†">æ–°è¿æ¥å¤„ç†</h1>
<p>æˆ‘ä»¬ç°åœ¨é‡ç‚¹å…³å¿ƒ__invokeé‡Œé¢çš„ä»£ç ï¼Œå½“æœ‰æ•°æ®åˆ°è¾¾æ—¶è°ƒç”¨ handleRequest() æ–¹æ³•å¤„ç†ï¼Œæ·±å…¥åˆ°handleRequesté‡Œé¢ã€‚</p>
<h2 id="handlerequest-å¤„ç†æµç¨‹">handleRequest å¤„ç†æµç¨‹</h2>
<ul>
<li>è¿æ¥çŠ¶æ€åˆ¤æ–­ï¼š å¼€å§‹æ£€æŸ¥è¿æ¥æ˜¯å¦å·²ç»å»ºç«‹ï¼ˆisConnected()ï¼‰ï¼Œå¦‚æœå·²ç»è¿æ¥ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤å¤„ç†</li>
<li>è°ƒç”¨ createRequest() å°†åŸå§‹æ¶ˆæ¯è½¬æ¢ä¸º PSR-7 Request å¯¹è±¡ã€‚å¦‚æœè¯·æ±‚åˆ›å»ºå¤±è´¥ï¼ˆè¿”å› nullï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œåç»­è°ƒåº¦ã€‚</li>
<li>è¿æ¥æ¿€æ´»ï¼š æˆåŠŸåˆ›å»ºè¯·æ±‚åï¼Œè°ƒç”¨ $connection-&gt;connect() æ¿€æ´»è¿æ¥ï¼Œè¡¨ç¤ºå·²å‡†å¤‡å¥½å¤„ç†è¯·æ±‚ã€‚</li>
<li>è·¯ç”±åˆ†å‘ï¼š ä½¿ç”¨æ³¨å…¥çš„ $router å¯¹è±¡ï¼Œæ ¹æ®è¯·æ±‚å†…å®¹åˆ†å‘åˆ°å¯¹åº”çš„æ§åˆ¶å™¨æˆ–å¤„ç†é€»è¾‘ã€‚</li>
<li>å¼‚å¸¸å¤„ç†ï¼š å¦‚æœè°ƒåº¦è¿‡ç¨‹ä¸­æ•è·åˆ° HttpExceptionï¼Œåˆ™æ ¹æ®å¼‚å¸¸çŠ¶æ€ç å’Œæ¶ˆæ¯å…³é—­è¿æ¥ã€‚æ•è·æ‰€æœ‰å…¶ä»–å¼‚å¸¸æ—¶ï¼Œå…ˆè®°å½•é”™è¯¯æ—¥å¿—ï¼Œç„¶åè¿”å› 500 çŠ¶æ€ç ï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚</li>
</ul>
<h2 id="è·¯ç”±åˆ†å‘">è·¯ç”±åˆ†å‘</h2>
<p>æˆ‘ä»¬ç°åœ¨å°±æ¥åˆ°äº†<code>vendor/laravel/reverb/src/Servers/Reverb/Http/Router.php</code>,è·¯ç”±ç±»é‡Œé¢ï¼Œç»§ç»­çœ‹æ ¸å¿ƒçš„<code>dispatch</code></p>
<pre><code class="language-php"> public function dispatch(RequestInterface $request, Connection $connection): mixed
    {
        $uri = $request-&gt;getUri();
        $context = $this-&gt;matcher-&gt;getContext();

        $context-&gt;setMethod($request-&gt;getMethod());
        $context-&gt;setHost($uri-&gt;getHost());

        try {
            $route = $this-&gt;matcher-&gt;match($uri-&gt;getPath());
        } catch (MethodNotAllowedException $e) {
            return $this-&gt;close($connection, 405, 'Method not allowed.', ['Allow' =&gt; $e-&gt;getAllowedMethods()]);
        } catch (ResourceNotFoundException $e) {
            return $this-&gt;close($connection, 404, 'Not found.');
        }

        $controller = $this-&gt;controller($route);

        if ($this-&gt;isWebSocketRequest($request)) {
            $wsConnection = $this-&gt;attemptUpgrade($request, $connection);

            return $controller($request, $wsConnection, ...Arr::except($route, ['_controller', '_route']));
        }

        $routeParameters = Arr::except($route, [
            '_controller',
            '_route',
        ]) + ['request' =&gt; $request, 'connection' =&gt; $connection];

        $response = $controller(
            ...$this-&gt;arguments($controller, $routeParameters)
        );

        return $response instanceof PromiseInterface ?
            $response-&gt;then(fn ($response) =&gt; $connection-&gt;send($response)-&gt;close()) :
            $connection-&gt;send($response)-&gt;close();
    }
</code></pre>
<p>è¿™ä¸ªè·¯ç”±åˆ†å‘å†™çš„ä¹Ÿå¾ˆå¥½ï¼Œå¾ˆå¥½çš„åˆ©ç”¨äº†Symfony çš„Route æ¥å®ç°ï¼Œå†™åˆ°è¿™é‡Œå°±è®©æƒ³èµ·äº†ä¸Šå®¶å…¬å¸æ¡†æ¶é‡Œé¢ä¹Ÿæ˜¯å¤§é‡ä½¿ç”¨symfonyçš„route http command process ç­‰æ ¸å¿ƒç»„ä»¶æ¥æ„å»ºapiæœåŠ¡ï¼Œä¸å¾—ä¸è¯´symfonyæ‰æ˜¯ç²¾å“ã€‚åŒæ—¶å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œä¹Ÿå¯ä»¥æŠŠsymfonyçš„å¥½çš„ç»„ä»¶ç”¨äºè‡ªå·±çš„é¡¹ç›®ã€‚<br>
åŒæ—¶è·¯ç”±ä¹Ÿå…±åŒå¤„ç†ç€http request ä»¥åŠ ws on message çš„æµç¨‹ã€‚<br>
é™¤äº†è·¯ç”±ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜èƒ½å­¦åˆ°çš„ä¸€ä¸ªç‚¹å°±æ˜¯ï¼šwebscoket åè®®çš„å¤„ç†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±é‡ç‚¹æ¥çœ‹ä¸‹è¿™ä¸ªã€‚</p>
<h2 id="webscoket-åè®®çš„å¤„ç†">webscoket åè®®çš„å¤„ç†</h2>
<h3 id="åè®®å‡çº§">åè®®å‡çº§</h3>
<p>æˆ‘ä»¬å…ˆå…³æ³¨æ ¸å¿ƒçš„ä»£ç é€»è¾‘ï¼š</p>
<pre><code class="language-php">        if ($this-&gt;isWebSocketRequest($request)) {
            $wsConnection = $this-&gt;attemptUpgrade($request, $connection);

            return $controller($request, $wsConnection, ...Arr::except($route, ['_controller', '_route']));
        }
</code></pre>
<ul>
<li>å¦‚æœè¯·æ±‚æ˜¯ä¸€ä¸ª WebSocket è¯·æ±‚ï¼ˆé€šè¿‡ Upgrade: websocket å¤´éƒ¨åˆ¤æ–­ï¼‰ï¼Œå°±å°è¯•è¿›è¡Œåè®®å‡çº§ã€‚</li>
<li>å‡çº§æˆåŠŸåï¼Œå°†è¯·æ±‚ $request å’Œå‡çº§åçš„è¿æ¥å¯¹è±¡ $wsConnection ä¼ é€’ç»™æ§åˆ¶å™¨ $controller å¤„ç†ã€‚</li>
<li>Arr::except($route, ['_controller', '_route']) æ˜¯ Laravel çš„è¾…åŠ©å‡½æ•°ï¼Œè¡¨ç¤ºæ’é™¤æ§åˆ¶å™¨ç›¸å…³ä¿¡æ¯ï¼Œä¼ é€’å‰©ä½™è·¯ç”±å‚æ•°</li>
</ul>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰ç«¯å‘èµ·å»ºç«‹çš„wsè¿æ¥åï¼ˆæ¯”å¦‚æ˜¯ï¼š<code>ws://localhost:8083/app/2lza6dryoslsyxss6ub4?protocol=7&amp;client=js&amp;version=8.4.0&amp;flash=false</code>)ï¼Œå°±ä¼šèµ°åˆ°åè®®å‡çº§çš„$controllerå¤„ç†ã€‚é‚£å…·ä½“å¤„ç†åœ¨å“ªå‘¢ï¼Œè¿™ä¸ªå°±è¦å›åˆ°æˆ‘ä»¬ä¸ŠèŠ‚æåˆ°çš„ï¼š<code>pusherRoutes</code>é‡Œå®šä¹‰çš„è·¯ç”±äº†ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¿«é©¬åŠ é­çš„å›åˆ°é‚£é‡Œå»ï¼ŒåŒæ—¶ä¹Ÿè¯´æ˜ä¸‹ï¼Œè¿™é‡Œå¯¹wsåè®®æ²¡æœ‰è®²å®Œã€‚æˆ‘å‡†å¤‡åœ¨ä¸‹é¢çš„å†…å®¹åœ¨è¿›è¡Œè¯´æ˜<br>
<img src="https://img2024.cnblogs.com/blog/990003/202503/990003-20250312222123784-902846808.png" alt="image" loading="lazy"></p>
<h3 id="ä¸šåŠ¡å…·ä½“å¤„ç†">ä¸šåŠ¡å…·ä½“å¤„ç†</h3>
<p>æˆ‘ä»¬å›åˆ°äº†<code>vendor/laravel/reverb/src/Servers/Reverb/Factory.php</code> çš„<code>pusherRoutes</code>æ–¹æ³•é‡Œé¢ï¼Œç„¶åå°±çœ‹ç¬¬ä¸€æ¡è·¯ç”±ï¼š</p>
<pre><code class="language-php">$routes-&gt;add('sockets', Route::get('/app/{appKey}', new PusherController(app(PusherServer::class), app(ApplicationProvider::class))));
</code></pre>
<p>æ˜¯ä¸æ˜¯ä¸€ä¸‹å­å°±ç ´æ¡ˆäº†å‘¢ï¼Œè¿™ä¸ªè·¯ç”±åŒ¹é…äº†wsè¿æ¥åœ°å€<code>/app/2lza6dryoslsyxss6ub4</code>,å› æ­¤<code>PusherController</code> å°±æ˜¯wsçš„å¤„ç†ã€‚å› æ­¤æˆ‘ä»¬å°±ç»§ç»­èµ°ï¼Œæ¥åˆ°ï¼š<code>vendor/laravel/reverb/src/Protocols/Pusher/Http/Controllers/PusherController.php</code><br>
åŒæ ·çš„controllerä¹Ÿæ˜¯ç”¨åˆ°äº†__invokeï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ç›˜å®ƒã€‚</p>
<hr>
<h2 id="pusher-åè®®">Pusher åè®®</h2>
<h3 id="1-æ¶ˆæ¯æ ¼å¼"><strong>1. æ¶ˆæ¯æ ¼å¼</strong></h3>
<p>Pusher åè®®ä¸­çš„æ¶ˆæ¯æ ¼å¼æ˜¯ JSONï¼Œä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
  "event": "event-name",
  "data": "stringified JSON",
  "channel": "optional-channel-name"
}
</code></pre>
<p>ä¾‹å­ï¼š</p>
<pre><code class="language-json">{
  "event": "pusher:subscribe",
  "data": {
    "channel": "private-chat.123"
  }
}
</code></pre>
<p>æˆ–è€…æ¶ˆæ¯æ¨é€ï¼š</p>
<pre><code class="language-json">{
  "event": "client-message",
  "data": {
    "text": "Hello"
  },
  "channel": "chat.123"
}
</code></pre>
<hr>
<h3 id="2-æ§åˆ¶å™¨ä¸­å¤„ç†çš„-websocket-ç”Ÿå‘½å‘¨æœŸ"><strong>2. æ§åˆ¶å™¨ä¸­å¤„ç†çš„ WebSocket ç”Ÿå‘½å‘¨æœŸ</strong></h3>
<p>æ§åˆ¶å™¨é‡Œæ³¨å†Œäº†ä¸‰ç§ WebSocket äº‹ä»¶ç›‘å¬ï¼š</p>
<pre><code class="language-php">$connection-&gt;onMessage(fn ($message) =&gt; ... );
$connection-&gt;onControl(fn (FrameInterface $message) =&gt; ... );
$connection-&gt;onClose(fn () =&gt; ... );
</code></pre>
<h4 id="onmessage"><strong>onMessage()</strong></h4>
<p>å½“æµè§ˆå™¨å‘é€ WebSocket æ¶ˆæ¯æ—¶ï¼š</p>
<pre><code class="language-php">fn ($message) =&gt; $this-&gt;server-&gt;message($reverbConnection, (string) $message)
</code></pre>
<ul>
<li>å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å­—ç¬¦ä¸²ä¼ ç»™ <code>PusherServer::message()</code> å¤„ç†ã€‚</li>
<li>è¿™ä¸ªæ–¹æ³•é‡Œä¼šè§£æ JSONï¼Œåˆ¤æ–­ event ç±»å‹ï¼Œæ¯”å¦‚ï¼š
<ul>
<li><code>pusher:subscribe</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯è®¢é˜…é¢‘é“ã€‚</li>
<li><code>client-event</code>ï¼šå®¢æˆ·ç«¯å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ã€‚</li>
<li><code>ping/pong</code>ï¼šå¿ƒè·³æ£€æŸ¥ã€‚</li>
</ul>
</li>
<li>ç„¶åè¿›è¡Œè·¯ç”±ã€é‰´æƒã€å¹¿æ’­ç­‰é€»è¾‘ã€‚</li>
</ul>
<h4 id="oncontrol"><strong>onControl()</strong></h4>
<pre><code class="language-php">fn (FrameInterface $message) =&gt; $this-&gt;server-&gt;control($reverbConnection, $message)
</code></pre>
<ul>
<li>æ§åˆ¶å¸§ï¼Œå¦‚ <code>ping</code>ã€<code>pong</code>ã€<code>close</code> ç­‰å¸§ã€‚</li>
<li>æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯å‘é€ pingï¼Œè¿™é‡Œå¯ä»¥å›åº” pongã€‚</li>
<li>è¿™éƒ¨åˆ†å±äº WebSocket åè®®çš„ä½å±‚éƒ¨åˆ†ï¼Œä¿è¯è¿æ¥æ´»è·ƒã€‚</li>
</ul>
<h4 id="onclose"><strong>onClose()</strong></h4>
<pre><code class="language-php">fn () =&gt; $this-&gt;server-&gt;close($reverbConnection)
</code></pre>
<ul>
<li>å½“è¿æ¥å…³é—­æ—¶ï¼Œåšæ¸…ç†ï¼Œæ¯”å¦‚ç§»é™¤è¿æ¥ã€å–æ¶ˆè®¢é˜…ã€å¹¿æ’­ç¦»çº¿æ¶ˆæ¯ç­‰ã€‚</li>
</ul>
<hr>
<h3 id="3-è¿æ¥åˆå§‹åŒ–"><strong>3. è¿æ¥åˆå§‹åŒ–</strong></h3>
<pre><code class="language-php">$this-&gt;server-&gt;open($reverbConnection);
</code></pre>
<ul>
<li>é€šçŸ¥ <code>PusherServer</code> æœ‰ä¸€ä¸ªæ–°çš„è¿æ¥å»ºç«‹äº†ã€‚</li>
<li>å®ƒå¯èƒ½ä¼šç»™å®¢æˆ·ç«¯æ¨é€ä¸€ä¸ª <code>pusher:connection_established</code> æ¶ˆæ¯ï¼š</li>
</ul>
<pre><code class="language-json">{
  "event": "pusher:connection_established",
  "data": {
    "socket_id": "some-unique-id",
    "activity_timeout": 120
  }
}
</code></pre>
<p>è¿™ä¸ªæ˜¯ Pusher åè®®é‡Œçº¦å®šçš„ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ° <code>socket_id</code> åï¼Œæ‰èƒ½è®¢é˜…ç§æœ‰é¢‘é“ç­‰ã€‚</p>
<p>å½“ appKey æ— æ•ˆæ—¶ï¼Œä¼šæ¨é€ä¸€ä¸ªæ ‡å‡†çš„é”™è¯¯ï¼š</p>
<pre><code class="language-php">$connection-&gt;send('{"event":"pusher:error","data":"{\"code\":4001,\"message\":\"Application does not exist\"}"}');
</code></pre>
<hr>
<ul>
<li>ä½œä¸º WebSocket è·¯ç”±çš„å…¥å£</li>
<li>å®ç° <strong>Pusher åè®®çš„æ¡æ‰‹ã€è®¢é˜…ã€æ¶ˆæ¯å¤„ç†</strong>ç­‰</li>
<li>å°è£…äº†ä½å±‚çš„ <code>Connection</code> å’Œé«˜å±‚çš„ <code>Application</code> ä¸º <code>ReverbConnection</code></li>
<li>æ³¨å†Œäº†å®Œæ•´çš„ WebSocket ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆæ¶ˆæ¯ã€æ§åˆ¶å¸§ã€å…³é—­ï¼‰</li>
</ul>
<p>è€Œ <strong>Pusher åè®®çš„æ•°æ®ç»“æ„</strong> æ˜¯åŸºäº JSON çš„ï¼Œæ‰€æœ‰é€šä¿¡äº‹ä»¶éƒ½é€šè¿‡ <code>event + data (+channel)</code> æ¥ä¼ é€’å’Œè§£æï¼Œä¿æŒäº†é«˜åº¦çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<hr>
<p>ä¸ºäº†ä¸€èµ·å­¦ä¹ ï¼Œæˆ‘ä»¬ç”¨gpt4æ¥ç³»ç»Ÿæ€»ç»“ä¸‹websocketçš„çŸ¥è¯†ã€‚</p>
<h2 id="ä¸€websocket-æ˜¯ä»€ä¹ˆ"><strong>ä¸€ã€WebSocket æ˜¯ä»€ä¹ˆï¼Ÿ</strong></h2>
<p>WebSocket æ˜¯ä¸€ç§ <strong>åŸºäº TCP çš„åŒå‘é€šä¿¡åè®®</strong>ï¼Œå®ƒå…è®¸æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ª <strong>æŒä¹…çš„è¿æ¥</strong>ï¼ŒåŒæ–¹å¯ä»¥éšæ—¶äº’å‘æ•°æ®ï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°å»ºç«‹è¿æ¥ï¼ˆåƒ HTTP é‚£æ ·ï¼‰ã€‚</p>
<p>å®ƒæœ€åˆç”± <a href="https://datatracker.ietf.org/doc/html/rfc6455" target="_blank" rel="noopener nofollow">RFC 6455</a> è§„èŒƒå®šä¹‰ã€‚</p>
<hr>
<h2 id="äºŒwebsocket-å»ºç«‹è¿‡ç¨‹"><strong>äºŒã€WebSocket å»ºç«‹è¿‡ç¨‹</strong></h2>
<h3 id="1-æ¡æ‰‹é˜¶æ®µhttp-åè®®å®Œæˆå‡çº§">1. <strong>æ¡æ‰‹é˜¶æ®µï¼ˆHTTP åè®®å®Œæˆå‡çº§ï¼‰</strong></h3>
<p>WebSocket è¿æ¥å¼€å§‹äºä¸€ä¸ª <strong>HTTP GET è¯·æ±‚</strong>ï¼Œå®¢æˆ·ç«¯å‘é€å¦‚ä¸‹è¯·æ±‚ï¼š</p>
<pre><code class="language-http">GET /app/abc123 HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
</code></pre>
<p>å…³é”®å­—æ®µè¯´æ˜ï¼š</p>
<ul>
<li><code>Upgrade: websocket</code>ï¼šå‘Šè¯‰æœåŠ¡å™¨è¦å‡çº§ä¸º WebSocket åè®®ã€‚</li>
<li><code>Connection: Upgrade</code>ï¼šå’Œä¸Šé¢çš„é…å¥—ï¼Œè¡¨ç¤ºè¿æ¥è¦å‡çº§ã€‚</li>
<li><code>Sec-WebSocket-Key</code>ï¼šä¸€ä¸ªéšæœºçš„ base64 ç¼–ç å­—ç¬¦ä¸²ï¼Œç”¨äºå®‰å…¨æ ¡éªŒã€‚</li>
<li><code>Sec-WebSocket-Version</code>ï¼šWebSocket åè®®ç‰ˆæœ¬ï¼Œå½“å‰ä¸º <code>13</code>ã€‚</li>
</ul>
<h3 id="2-æœåŠ¡å™¨å“åº”æ¡æ‰‹">2. <strong>æœåŠ¡å™¨å“åº”æ¡æ‰‹</strong></h3>
<p>æœåŠ¡å™¨éªŒè¯åˆæ³•åï¼Œä¼šå“åº”å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-http">HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</code></pre>
<ul>
<li><code>Sec-WebSocket-Accept</code> æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„ <code>Sec-WebSocket-Key</code> è®¡ç®—å¾—æ¥çš„ï¼š<pre><code class="language-php">base64_encode(sha1($clientKey . '258EAFA5-E914-47DA-95CA-C5AB0DC85B11', true));
</code></pre>
</li>
</ul>
<p>ä¸€æ—¦æ¡æ‰‹å®Œæˆï¼ŒHTTP è¿æ¥å°±å‡çº§ä¸º WebSocketï¼Œä¹‹åä¼ è¾“çš„æ‰€æœ‰æ•°æ®éƒ½ä¸å†æ˜¯ HTTP æ ¼å¼ï¼Œè€Œæ˜¯ <strong>WebSocket å¸§æ ¼å¼</strong>ã€‚</p>
<hr>
<h2 id="ä¸‰websocket-æ•°æ®å¸§ç»“æ„"><strong>ä¸‰ã€WebSocket æ•°æ®å¸§ç»“æ„</strong></h2>
<p>WebSocket çš„é€šä¿¡æ˜¯ä»¥ <strong>å¸§ï¼ˆframeï¼‰</strong> ä¸ºå•ä½çš„ï¼Œæ¯ä¸€å¸§éƒ½åŒ…å«ï¼š</p>
<h3 id="å¸§ç»“æ„ç®€åŒ–å›¾"><strong>å¸§ç»“æ„ï¼ˆç®€åŒ–å›¾ï¼‰</strong></h3>
<pre><code>0               1               2               3
+-------+-------+---------------+-------------------------------+
|FIN| RSV | OPCODE | MASK | Payload Len | Extended Len | MASK Key |
+-------+-------+---------------+-------------------------------+
|         Payload Data (possibly masked)                        |
+---------------------------------------------------------------+
</code></pre>
<h3 id="é‡è¦å­—æ®µ">é‡è¦å­—æ®µï¼š</h3>
<table>
<thead>
<tr>
<th>å­—æ®µå</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FIN</strong></td>
<td>1 ä½ï¼Œæ˜¯å¦æ˜¯æ¶ˆæ¯æœ€åä¸€å¸§ã€‚é€šå¸¸ä¸º 1ã€‚</td>
</tr>
<tr>
<td><strong>Opcode</strong></td>
<td>è¡¨ç¤ºå¸§çš„ç±»å‹ï¼ˆæ–‡æœ¬ã€äºŒè¿›åˆ¶ã€ping ç­‰ï¼‰ã€‚</td>
</tr>
<tr>
<td><strong>MASK</strong></td>
<td>1 ä½ï¼Œæ˜¯å¦å¯ç”¨æ©ç ï¼ˆå®¢æˆ·ç«¯å¿…é¡»è®¾ç½®ä¸º 1ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸º 0ï¼‰ã€‚</td>
</tr>
<tr>
<td><strong>Payload Length</strong></td>
<td>æ•°æ®é•¿åº¦ï¼ˆå¯èƒ½éœ€è¦æ‰©å±•é•¿åº¦å­—æ®µï¼‰ã€‚</td>
</tr>
<tr>
<td><strong>Masking Key</strong></td>
<td>4 å­—èŠ‚ï¼Œå®¢æˆ·ç«¯åŠ å¯†æ•°æ®ä½¿ç”¨çš„å¯†é’¥ã€‚</td>
</tr>
<tr>
<td><strong>Payload Data</strong></td>
<td>å®é™…ä¼ è¾“çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯å‘å‡ºæ—¶å¿…é¡»è¢«æ©ç å¤„ç†ã€‚</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="opcode-ç±»å‹"><strong>Opcode ç±»å‹</strong></h3>
<table>
<thead>
<tr>
<th>Opcode</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0</td>
<td>è¿ç»­å¸§ï¼ˆåç»­å¸§ï¼‰</td>
</tr>
<tr>
<td>0x1</td>
<td>æ–‡æœ¬å¸§ï¼ˆUTF-8ï¼‰</td>
</tr>
<tr>
<td>0x2</td>
<td>äºŒè¿›åˆ¶å¸§</td>
</tr>
<tr>
<td>0x8</td>
<td>å…³é—­è¿æ¥</td>
</tr>
<tr>
<td>0x9</td>
<td>Pingï¼ˆå¿ƒè·³ï¼‰</td>
</tr>
<tr>
<td>0xA</td>
<td>Pongï¼ˆå›åº”ï¼‰</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="ç¤ºä¾‹å‘é€ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯-hiå®¢æˆ·ç«¯---æœåŠ¡ç«¯"><strong>ç¤ºä¾‹ï¼šå‘é€ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯ "hi"ï¼ˆå®¢æˆ·ç«¯ -&gt; æœåŠ¡ç«¯ï¼‰</strong></h3>
<ul>
<li><code>Opcode = 0x1</code>ï¼ˆæ–‡æœ¬å¸§ï¼‰</li>
<li><code>Payload = "hi"</code>ï¼Œé•¿åº¦ä¸º 2 å­—èŠ‚</li>
<li><code>MASK = 1</code>ï¼ˆå®¢æˆ·ç«¯å‘é€æ—¶å¿…é¡»æ©ç ï¼‰</li>
<li>ä½¿ç”¨æ©ç  key åŠ å¯† payload</li>
</ul>
<p>æœåŠ¡ç«¯æ¥æ”¶åˆ°åä¼šåæ©ç è¿˜åŸå‡ºåŸå§‹æ–‡æœ¬ã€‚</p>
<hr>
<h2 id="å››æ§åˆ¶å¸§"><strong>å››ã€æ§åˆ¶å¸§</strong></h2>
<p>æ§åˆ¶å¸§æ˜¯ç®¡ç†è¿æ¥ç”¨çš„ï¼š</p>
<ul>
<li><strong>Ping / Pong</strong>ï¼šç”¨äºå¿ƒè·³æœºåˆ¶ï¼Œç¡®ä¿è¿æ¥æ´»è·ƒã€‚</li>
<li><strong>Close</strong>ï¼šé€šçŸ¥å¯¹æ–¹å…³é—­è¿æ¥ï¼Œå¯ä»¥æºå¸¦å…³é—­åŸå› å’ŒçŠ¶æ€ç ã€‚</li>
</ul>
<hr>
<h2 id="äº”è¿æ¥å…³é—­"><strong>äº”ã€è¿æ¥å…³é—­</strong></h2>
<p>å½“ä»»æ„ä¸€æ–¹æƒ³å…³é—­è¿æ¥ï¼Œä¼šå‘é€ä¸€ä¸ª <code>Opcode = 0x8</code> çš„å¸§ï¼Œå¹¶å¯é™„å¸¦ä¸€ä¸ªçŠ¶æ€ç ï¼ˆå¦‚ 1000 è¡¨ç¤ºæ­£å¸¸å…³é—­ï¼‰ã€‚</p>
<hr>
<h2 id="å…­ä¸-laravel-reverb-çš„å¯¹åº”å…³ç³»"><strong>å…­ã€ä¸ Laravel Reverb çš„å¯¹åº”å…³ç³»</strong></h2>
<p>ä½ ä¹‹å‰çœ‹åˆ°çš„ <code>onMessage</code>, <code>onControl</code>, <code>onClose</code> å®é™…å°±æ˜¯å¯¹ä¸Šè¿°åº•å±‚å¸§çš„å“åº”å°è£…ï¼š</p>
<ul>
<li><code>onMessage</code>ï¼šå¤„ç† <code>Opcode=0x1</code> çš„æ–‡æœ¬å¸§ã€‚</li>
<li><code>onControl</code>ï¼šå¤„ç† <code>Ping</code> / <code>Pong</code> / <code>Close</code> æ§åˆ¶å¸§ã€‚</li>
<li><code>onClose</code>ï¼šå¯¹åº”è¿æ¥æ–­å¼€ï¼ˆå¯èƒ½æ˜¯æ”¶åˆ° Close å¸§ï¼Œæˆ– TCP æ–­äº†ï¼‰ã€‚</li>
</ul>
<hr>
<h2 id="æ€»ç»“ä¸€å¥è¯"><strong>æ€»ç»“ä¸€å¥è¯</strong></h2>
<blockquote>
<p>WebSocket æ˜¯åœ¨ TCP ä¸Šå»ºç«‹çš„æŒä¹…åŒå‘é€šä¿¡åè®®ï¼Œå…ˆé€šè¿‡ HTTP å‡çº§ï¼Œç„¶åé€šè¿‡ä¸€å¥—ä¸“é—¨çš„äºŒè¿›åˆ¶å¸§ç»“æ„è¿›è¡Œé€šä¿¡ï¼Œå¸§å¯ä»¥æ˜¯æ–‡æœ¬ã€äºŒè¿›åˆ¶ã€Ping/Pong æˆ– Closeã€‚</p>
</blockquote>
<h2 id="websocket-å¸§ç»“æ„å›¾">WebSocket å¸§ç»“æ„å›¾</h2>
<p><img src="https://img2024.cnblogs.com/blog/990003/202503/990003-20250312223711059-896897989.png" alt="image" loading="lazy"></p>
<hr>
<h3 id="å„å­—æ®µè¯´æ˜">å„å­—æ®µè¯´æ˜ï¼š</h3>
<ol>
<li><strong>FIN (1 bit)</strong>ï¼šæ˜¯å¦ä¸ºæ¶ˆæ¯æœ€åä¸€å¸§ï¼ˆ1 è¡¨ç¤ºæ˜¯ï¼Œ0 è¡¨ç¤ºåé¢è¿˜æœ‰ï¼‰ã€‚</li>
<li><strong>RSV1, RSV2, RSV3 (å„ 1 bit)</strong>ï¼šä¿ç•™ä½ï¼Œé€šå¸¸ä¸º 0ã€‚</li>
<li><strong>Opcode (4 bits)</strong>ï¼š
<ul>
<li><code>0x1</code>ï¼šæ–‡æœ¬å¸§</li>
<li><code>0x2</code>ï¼šäºŒè¿›åˆ¶å¸§</li>
<li><code>0x8</code>ï¼šå…³é—­è¿æ¥</li>
<li><code>0x9</code>ï¼šPing</li>
<li><code>0xA</code>ï¼šPong</li>
</ul>
</li>
<li><strong>MASK (1 bit)</strong>ï¼š
<ul>
<li>å®¢æˆ·ç«¯å¿…é¡»è®¾ç½®ä¸º 1ï¼ˆæ•°æ®ç»è¿‡æ©ç å¤„ç†ï¼‰</li>
<li>æœåŠ¡ç«¯å¿…é¡»è®¾ç½®ä¸º 0ï¼ˆä¸ä½¿ç”¨æ©ç ï¼‰</li>
</ul>
</li>
<li><strong>Payload Len (7 bits)</strong>ï¼š
<ul>
<li>å°äº 126ï¼šç›´æ¥å†™é•¿åº¦</li>
<li>ç­‰äº 126ï¼šåé¢æ‰©å±• 16 ä½è¡¨ç¤ºé•¿åº¦</li>
<li>ç­‰äº 127ï¼šåé¢æ‰©å±• 64 ä½è¡¨ç¤ºé•¿åº¦</li>
</ul>
</li>
<li><strong>Extended Payload Len</strong>ï¼šåªæœ‰åœ¨ Payload é•¿åº¦å¤§äºç­‰äº 126 æ—¶æ‰å‡ºç°ã€‚</li>
<li><strong>Masking Key (32 bits)</strong>ï¼š
<ul>
<li>å®¢æˆ·ç«¯å‘é€æ•°æ®æ—¶ç”¨æ­¤ key æ©ç å®é™…å†…å®¹</li>
</ul>
</li>
<li><strong>Payload Data</strong>ï¼šçœŸæ­£çš„æ•°æ®å†…å®¹ï¼ˆå¯èƒ½æ˜¯æ©ç å¤„ç†çš„ï¼‰</li>
</ol>
<hr>
<p>å¥½ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸ªçœŸå®çš„ <strong>WebSocket æŠ“åŒ…æ•°æ®ç¤ºä¾‹</strong>ï¼Œæ¼”ç¤ºä¸€æ¬¡å®¢æˆ·ç«¯å‘é€æ–‡æœ¬æ¶ˆæ¯ <code>"hi"</code> çš„åŸå§‹å¸§æ•°æ®ï¼Œä»¥åŠå¦‚ä½•è§£æå®ƒã€‚</p>
<hr>
<h2 id="åœºæ™¯æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯-hi"><strong>åœºæ™¯ï¼šæµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ <code>"hi"</code></strong></h2>
<p>æˆ‘ä»¬æŠ“åŒ…çœ‹åˆ° WebSocket å¸§å¦‚ä¸‹ï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼š</p>
<pre><code>81 82 37 fa 21 3d 5f 9f 44 52
</code></pre>
<hr>
<h3 id="é€å­—èŠ‚è§£æ"><strong>é€å­—èŠ‚è§£æï¼š</strong></h3>
<table>
<thead>
<tr>
<th>å­—èŠ‚</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>81</code></td>
<td><strong>FIN=1</strong>, <strong>Opcode=1</strong>ï¼ˆæ–‡æœ¬å¸§ï¼‰</td>
</tr>
<tr>
<td><code>82</code></td>
<td><strong>MASK=1</strong>, <strong>Payload length=2</strong>ï¼ˆè¡¨ç¤º2ä¸ªå­—èŠ‚çš„å†…å®¹ï¼‰</td>
</tr>
<tr>
<td><code>37 fa 21 3d</code></td>
<td><strong>æ©ç  key</strong>ï¼ˆmasking keyï¼‰</td>
</tr>
<tr>
<td><code>5f 9f</code></td>
<td>è¢«æ©ç å¤„ç†è¿‡çš„ <code>"hi"</code> æ•°æ®</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="æ©ç è¿˜åŸ-payload"><strong>æ©ç è¿˜åŸ Payload</strong></h3>
<p>æ©ç ç®—æ³•ï¼ˆRFC6455 æ ‡å‡†ï¼‰ï¼š<br>
<code>payload[i] = encoded[i] ^ masking_key[i % 4]</code></p>
<p>è¿˜åŸè¿‡ç¨‹ï¼š</p>
<pre><code class="language-text">åŸå§‹æ•°æ®ï¼ˆmaskedï¼‰:   0x5f 0x9f
æ©ç  key:           0x37 0xfa 0x21 0x3d

è¿˜åŸï¼š
byte 1: 0x5f ^ 0x37 = 0x68 = 'h'
byte 2: 0x9f ^ 0xfa = 0x69 = 'i'
</code></pre>
<p><strong>â†’ å¾—å‡ºè¿˜åŸç»“æœï¼š"hi"</strong></p>
<hr>
<h2 id="å›¾è§£æ€»ç»“"><strong>å›¾è§£æ€»ç»“ï¼š</strong></h2>
<pre><code>[81]     -&gt; FIN + Opcodeï¼ˆ0x1 = æ–‡æœ¬å¸§ï¼‰
[82]     -&gt; MASK=1, Payloadé•¿åº¦=2
[37 fa 21 3d] -&gt; æ©ç  key
[5f 9f]  -&gt; æ©ç åçš„ payloadï¼ˆhiï¼‰

è¿˜åŸå payload: "hi"
</code></pre>
<hr>
<h2 id="å†ä¸¾ä¸ªæœåŠ¡ç«¯å‘é€å›å®¢æˆ·ç«¯çš„æ•°æ®å¸§"><strong>å†ä¸¾ä¸ªæœåŠ¡ç«¯å‘é€å›å®¢æˆ·ç«¯çš„æ•°æ®å¸§</strong></h2>
<p>å‡è®¾æœåŠ¡ç«¯å‘å›æ–‡æœ¬æ¶ˆæ¯ <code>"ok"</code>ï¼Œä¸éœ€è¦æ©ç ï¼š</p>
<pre><code>81 02 6f 6b
</code></pre>
<table>
<thead>
<tr>
<th>å­—èŠ‚</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>81</code></td>
<td>FIN=1, Opcode=1ï¼ˆæ–‡æœ¬å¸§ï¼‰</td>
</tr>
<tr>
<td><code>02</code></td>
<td>MASK=0, Payload é•¿åº¦ = 2</td>
</tr>
<tr>
<td><code>6f 6b</code></td>
<td>å­—ç¬¦ <code>"o"</code> å’Œ <code>"k"</code> çš„ ASCIIï¼ˆ0x6F 0x6Bï¼‰</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="æ€»ç»“"><strong>æ€»ç»“</strong></h1>
<p>è¿™ä¸€èŠ‚å°±åˆ°è¿™é‡Œäº†ï¼Œå¸Œæœ›å¯¹ä½ æœ‰ç”¨ã€‚åŒæ—¶ï¼Œæå‰ä¹Ÿæå‰å¹ä¸‹swooleçš„é£ï¼šswooleåº•å±‚å¤„ç†äº†å¾ˆå¤šæ­¥éª¤ï¼Œæ¯”å¦‚ï¼š<br>
<img src="https://img2024.cnblogs.com/blog/990003/202503/990003-20250312224546558-1341024445.png" alt="image" loading="lazy"><br>
è¿™æ ·ç®€åŒ–äº†ä¸Šå±‚å¼€å‘ï¼ŒåŒæ—¶ä¹Ÿæ”¾å¼€äº†ä¸Šå±‚å¼€å‘çš„å¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨æŠ€æœ¯æ¡†æ¶ã€ç»„ä»¶çš„æ—¶å€™åº”å½“æ›´ä»”ç»†é˜…è¯»å…¶æ–‡æ¡£ã€‚</p>

</div>
<div id="MySignature" role="contentinfo">
    æœ‰è€•è€˜ã€æœ‰æ¬è¿ã€å…±å­¦ä¹ 
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.7307808428206019" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-12 22:49">2025-03-12 22:49</span>&nbsp;
<a href="https://www.cnblogs.com/YangJieCheng">wanzij</a>&nbsp;
é˜…è¯»(<span id="post_view_count">42</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18768844" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18768844);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18768844', targetLink: 'https://www.cnblogs.com/YangJieCheng/p/18768844', title: 'Laravel11 ä»0å¼€å‘ Swoole-Reverb æ‰©å±•åŒ…ï¼ˆå››ï¼‰ - è§¦å‘ä¸€ä¸ªå¹¿æ’­äº‹ä»¶åˆ°reverbæœåŠ¡ä¹‹åæ˜¯å¦‚ä½•è½¬å‘ç»™å‰ç«¯è®¢é˜…çš„å‘¢ï¼ˆä¸‹ï¼‰ï¼Ÿ' })">ä¸¾æŠ¥</a>
</div>
        