
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ziyansugar/p/18657519" title="å‘å¸ƒäº 2025-01-07 14:11">
    <span role="heading" aria-level="2">C#ç¬”è®°ï¼ˆ1ã€é’‰é’‰æœºå™¨äººæ¨é€å¸†è½¯æŠ¥è¡¨å›¾ç‰‡ï¼‰</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="cç¬”è®°é’‰é’‰æœºå™¨äººæ¨é€å¸†è½¯æŠ¥è¡¨å›¾ç‰‡ä¸€">C#ç¬”è®°â€”â€”é’‰é’‰æœºå™¨äººæ¨é€å¸†è½¯æŠ¥è¡¨å›¾ç‰‡ï¼ˆä¸€ï¼‰</h1>
<blockquote>
<h2 id="1å‰è¨€">1ã€å‰è¨€</h2>
<p>â€‹	2024å¹´æœ€åä¸€ä¸ªæœˆï¼Œå®¶é‡Œå¤šäº†ä¸ªå°å…¬ä¸»ï¼Œåœ¨å®¶ä¼‘æ¯äº†ä¸€æ®µæ—¶é—´ã€‚2025å¹´ï¼Œä¼‘å®Œå‡ä¸Šç­ç¬¬ä¸€å¤©ï¼Œé¢†å¯¼å°±è¯´ï¼šå“ï¼Œæˆ‘çœ‹æ€»éƒ¨é‚£è¾¹åšäº†ä¸ªæ¯æ—¥äº§å‡ºçš„æŠ¥è¡¨æ¨é€åˆ°é’‰é’‰ç¾¤ï¼Œæ¥çœ‹è®¡åˆ’è¾¾æˆç‡ã€‚æˆ‘ä»¬åŸºåœ°è¿™è¾¹èƒ½ä¸èƒ½åšå•Šã€‚æˆ‘å¿ƒé‡Œé»˜é»˜ä¸€æƒ³ï¼Œç„¶åå¤§å£°ä¸€å–Šèƒ½åšï¼ˆå†…å¿ƒosï¼šä¸Šå®¶å…¬å¸åšè¿‡ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä¸è¿‡ä»–ä»¬æ˜¯è‡ªå·±çš„é€šè®¯å·¥å…·ï¼Œä¸æ˜¯é’‰é’‰ï¼‰ã€‚æ—¢ç„¶æœ‰äº†æ´»ï¼Œé‚£å°±å¼€å¹²å§ã€‚æœ€ç»ˆå¿™æ´»äº†å‡ å¤©ï¼Œç»ˆäºç®—æ˜¯å®ç°äº†è¿™ä¸ªåŠŸèƒ½å§ï¼Œè®°å½•ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œä»¥åŠè¸©åˆ°çš„å‘å§ï¼Œæœ€ç»ˆå®ç°æ•ˆæœå¦‚å›¾ã€‚</p>
<p><img src="https://gitee.com/wind59/blog-file/raw/master/Springboot/Pictures/10.1.png" alt="image-20250107130753085" loading="lazy"></p>
</blockquote>
<blockquote>
<h2 id="2ä¸‹è½½å¸†è½¯æŠ¥è¡¨å›¾ç‰‡åˆ°æœ¬åœ°">2ã€ä¸‹è½½å¸†è½¯æŠ¥è¡¨å›¾ç‰‡åˆ°æœ¬åœ°</h2>
<p>å› ä¸ºä¸Šå®¶åšè¿‡ç±»ä¼¼çš„åŠŸèƒ½ï¼Œé‚£å°±ç›´æ¥å€Ÿé‰´ä¸‹ä¹‹å‰çš„ä»£ç ï¼Œå…ˆæŠŠå¸†è½¯æŠ¥è¡¨ä»¥å›¾ç‰‡æ ¼å¼ä¸‹è½½åˆ°æœ¬åœ°ã€‚å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹</p>
<p>1ã€åœ¨å¸†è½¯çš„æŠ¥è¡¨è®¿é—®é¡µé¢çš„urlåé¢æ·»åŠ <code>&amp;format=image&amp;extype=PNG</code></p>
<p>2ã€ä½¿ç”¨httpè¯·æ±‚è®¿é—®ï¼Œä¸‹è½½åˆ°æœ¬åœ°ï¼Œæ·»åŠ åŠ¨æ€åå°„ä»¥ç”¨æ¥ä¼ å¸†è½¯æŠ¥è¡¨çš„æŸ¥è¯¢æ¡ä»¶å‚æ•°</p>
<p>3ã€è£å‰ªå›¾ç‰‡ç•™ç™½åŒºåŸŸï¼Œæ·»åŠ æ°´å°ç­‰</p>
<pre><code class="language-c#">public async Task SendImageOutput()
{
    try
    {
        //string fineReportUrl = "http://localhost:8075/webroot/decision/view/report?viewlet=tzreport/E04.cpt&amp;format=image&amp;extype=PNG";
        string image_Path = "D:\\1";
        string retMsg = string.Empty;
        DateTime dateTime = DateTime.Now;
        string time = dateTime.ToString("yyyyMMdd");//å½“å‰æ—¶é—´æ ¼å¼
        string downPath = Path.Combine(image_Path, time);//ä¸‹è½½åˆ°å½“å‰çš„è·¯å¾„ //æ–¹ä¾¿åˆ é™¤å†å²çš„è®°å½•æ–‡ä»¶
        if (!Directory.Exists(downPath))
        {
            Directory.CreateDirectory(downPath);
        }
        string startdate = dateTime.AddDays(-7).ToString("yyyy-MM-dd");
        string enddate = dateTime.ToString("yyyy-MM-dd");
        string cSharpScript = $"string startdate= \"{startdate}\";string enddate= \"{enddate}\"; var paramlist =\"&amp;startdate=\"+startdate+\"&amp;\"+\"enddate=\"+enddate; return paramlist;";
        string urlParam = FineReportUrlParam(cSharpScript);
        string url = fineReportUrl;
        if (!string.IsNullOrEmpty(urlParam))
        {
            url += urlParam;
        }
        //ä¸‹è½½å›¾ç‰‡
        bool downResult = HttpDownloadImage(url, "C02äº§å‡º", downPath, out string imageFullpath);
        if (downResult)
        {
            //å‘é€æ•°æ®åˆ°dingding
            .......
        }
        else
        {
            retMsg = "æ‰§è¡Œå¤±è´¥ï¼";
        }
    }
    catch (Exception ex)
    {
        throw ex;
    }
}

/// &lt;summary&gt;
/// httpä¸‹è½½æ–‡ä»¶
/// &lt;/summary&gt;
/// &lt;param name="url"&gt;ä¸‹è½½æ–‡ä»¶åœ°å€&lt;/param&gt;
/// &lt;param name="path"&gt;æ–‡ä»¶å­˜æ”¾åœ°å€&lt;/param&gt;
/// &lt;param name="isAddSecurity"&gt;æ˜¯å¦æ ‡å¯†&lt;/param&gt;
/// &lt;param name="imageNamePrefix"&gt;ä¿å­˜çš„æ–‡ä»¶çš„å‰ç¼€&lt;/param&gt;
/// &lt;param name="imageFullPath"&gt;å›¾ç‰‡ä¿å­˜åˆ°çš„æœ¬åœ°è·¯å¾„&lt;/param&gt;
/// &lt;returns&gt;&lt;/returns&gt;
public bool HttpDownloadImage(string url, string imageNamePrefix, string path, out string imageFullPath)
{
    try
    {
        HttpWebRequest? request = WebRequest.Create(url) as HttpWebRequest;
        //å‘é€è¯·æ±‚å¹¶è·å–ç›¸åº”å›åº”æ•°æ®
        HttpWebResponse? response = request.GetResponse() as HttpWebResponse;
        string fileName = imageNamePrefix + "_" + DateTime.Now.ToString("yyyyMMddHHmmssFFF") + ".png";
        string fileFullPath = Path.Combine(path, fileName);
        Stream responseStream = response.GetResponseStream();
        ImageEditDomain imageEdit = new ImageEditDomain();
        Bitmap imageBitmap = imageEdit.CutImageWhitePart(responseStream, 80, fileFullPath);
        Bitmap imageBitmapSecret = imageBitmap;
        Bitmap imageBitmapWord = imageEdit.AddWatermarkWord(imageBitmapSecret);//åŠ æœ‰â€œMESç³»ç»Ÿè‡ªåŠ¨å‘é€â€çš„å›¾ç‰‡
        imageFullPath = string.Empty;
        if (imageBitmapWord == null)
        {
            return false;
        }
        else
        {
            imageBitmapWord.Save(fileFullPath, ImageFormat.Png);
            imageFullPath = fileFullPath;
            return true;
        }
    }
    catch (Exception ex)
    {
        imageFullPath = string.Empty;
        return false;
    }
}

/// &lt;summary&gt;
/// ç”ŸæˆåŠ¨æ€ä»£ç ï¼Œæ–¹ä¾¿è°ƒç”¨
/// &lt;/summary&gt;
/// &lt;param name="argMethodCode"&gt;&lt;/param&gt;
/// &lt;returns&gt;&lt;/returns&gt;
public string GenerateCode(string argMethodCode)
{
    StringBuilder sb = new StringBuilder();
    sb.Append("using System;");
    sb.Append(Environment.NewLine);
    sb.Append("namespace FineReport");
    sb.Append(Environment.NewLine);
    sb.Append("{");
    sb.Append(Environment.NewLine);
    sb.Append("      public class UrlParam");
    sb.Append(Environment.NewLine);
    sb.Append("      {");
    sb.Append(Environment.NewLine);
    sb.Append("          public string GetParam()");
    sb.Append(Environment.NewLine);
    sb.Append("          {");
    sb.Append(Environment.NewLine);
    sb.Append(argMethodCode);
    sb.Append(Environment.NewLine);
    sb.Append("          }");
    sb.Append(Environment.NewLine);
    sb.Append("      }");
    sb.Append(Environment.NewLine);
    sb.Append("}");
    return sb.ToString();
}
/// &lt;summary&gt;
/// è·å–æ‰§è¡ŒåŠ¨æ€C#ä»£ç çš„å€¼
/// &lt;/summary&gt;
/// &lt;param name="argCodeStr"&gt;&lt;/param&gt;
/// &lt;returns&gt;&lt;/returns&gt;
public string FineReportUrlParam(string argCodeStr)
{
    if (string.IsNullOrEmpty(argCodeStr))
    {
        return string.Empty;
    }

    string code = GenerateCode(argCodeStr);
    // CSharpCodeProvider objCSharpCodePrivoder = new CSharpCodeProvider();
    //// CSharpCompilation objCSharpCodePrivoder = new CSharpCompilation();
    //  CompilerParameters objCompilerParameters = new CompilerParameters();

    // objCompilerParameters.ReferencedAssemblies.Add("System.dll");
    // //objCompilerParameters.ReferencedAssemblies.Add("Newtonsoft.Json.dll");
    // objCompilerParameters.GenerateExecutable = false;
    // objCompilerParameters.GenerateInMemory = true;
    // CompilerResults cresult = objCSharpCodePrivoder.CompileAssemblyFromSource(objCompilerParameters, code);

    // // é€šè¿‡åå°„ï¼Œæ‰§è¡Œä»£ç 
    // Assembly objAssembly = cresult.CompiledAssembly;
    // object obj = objAssembly.CreateInstance("FineReport.UrlParam");
    // MethodInfo objMI = obj.GetType().GetMethod("GetParam");
    // return objMI.Invoke(obj, null)?.ToString();
    // Parse the source code into a syntax tree.
    var syntaxTree = CSharpSyntaxTree.ParseText(code);

    // Define the references that your compiled code will need.
    var references = new[]
    {
    MetadataReference.CreateFromFile(typeof(object).Assembly.Location), // mscorlib/System.Runtime.dll
    MetadataReference.CreateFromFile(typeof(Console).Assembly.Location), // For example, if you use Console.WriteLine
    // Add other necessary references here, for example:
    // MetadataReference.CreateFromFile(typeof(Newtonsoft.Json.JsonConvert).Assembly.Location) // Newtonsoft.Json.dll
};

    // Create a compilation object with the parsed code and references.
    var compilation = CSharpCompilation.Create(
        assemblyName: Path.GetRandomFileName(),
        syntaxTrees: new[] { syntaxTree },
        references: references,
        options: new CSharpCompilationOptions(OutputKind.DynamicallyLinkedLibrary));

    // Emit the compiled code into a memory stream.
    using (var ms = new MemoryStream())
    {
        var result = compilation.Emit(ms);

        if (!result.Success)
        {
            var failures = result.Diagnostics.Where(diagnostic =&gt;
                diagnostic.IsWarningAsError ||
                diagnostic.Severity == DiagnosticSeverity.Error);

            throw new Exception("Compilation failed: " + string.Join(Environment.NewLine, failures.Select(d =&gt; d.ToString())));
        }
        else
        {
            ms.Seek(0, SeekOrigin.Begin);

            // Load the compiled assembly in a separate context to avoid locking issues.

            var loadContext = new AssemblyLoadContext(null, isCollectible: true);
            var assembly = loadContext.LoadFromStream(ms);
            // Use reflection to create an instance of the type and invoke its method.
            Type? type = assembly.GetType("FineReport.UrlParam");
            if (type == null)
                throw new InvalidOperationException("Type 'FineReport.UrlParam' not found.");
            object obj = Activator.CreateInstance(type)!;
            MethodInfo? methodInfo = type.GetMethod("GetParam");
            if (methodInfo == null)
                throw new InvalidOperationException("Method 'GetParam' not found.");
            return methodInfo.Invoke(obj, null)?.ToString();

        }
    }
}

</code></pre>
<pre><code class="language-c#">using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Imaging;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DingDingTest
{
    internal class ImageEditDomain
    {

        /// &lt;summary&gt;
        /// å‰ªå»å›¾ç‰‡ç©ºä½™ç™½è¾¹
        /// &lt;/summary&gt;
        /// &lt;param name="stream"&gt;æºæ–‡ä»¶&lt;/param&gt;
        /// &lt;param name="WhiteBar"&gt;ä¿ç•™çš„ç™½è¾¹ï¼Œå•ä½ä¸ºåƒç´ &lt;/param&gt;
        /// &lt;param name="fullPath"&gt;ä¿å­˜åˆ°æœ¬åœ°çš„åœ°å€&lt;/param&gt;
        public Bitmap CutImageWhitePart(Stream stream, int WhiteBar, string fullPath)
        {
            Bitmap bmp = new Bitmap(stream);
            int top = 0, left = 0;
            int right = bmp.Width, bottom = bmp.Height;
            Color white = Color.White;
            //å¯»æ‰¾æœ€ä¸Šé¢çš„æ ‡çº¿,ä»å·¦(0)åˆ°å³ï¼Œä»ä¸Š(0)åˆ°ä¸‹
            for (int i = 0; i &lt; bmp.Height; i++)//è¡Œ
            {
                bool find = false;
                for (int j = 0; j &lt; bmp.Width; j++)//åˆ—
                {
                    Color c = bmp.GetPixel(j, i);
                    if (IsWhite(c))
                    {
                        top = i;
                        find = true;
                        break;
                    }
                }
                if (find) break;
            }
            //å¯»æ‰¾æœ€å·¦è¾¹çš„æ ‡çº¿ï¼Œä»ä¸Šï¼ˆtopä½ï¼‰åˆ°ä¸‹ï¼Œä»å·¦åˆ°å³
            for (int i = 0; i &lt; bmp.Width; i++)//åˆ—
            {
                bool find = false;
                for (int j = top; j &lt; bmp.Height; j++)//è¡Œ
                {
                    Color c = bmp.GetPixel(i, j);
                    if (IsWhite(c))
                    {
                        left = i;
                        find = true;
                        break;
                    }
                }
                if (find) break; ;
            }
            // å¯»æ‰¾æœ€ä¸‹è¾¹æ ‡çº¿ï¼Œä»ä¸‹åˆ°ä¸Šï¼Œä»å·¦åˆ°å³
            for (int i = bmp.Height - 1; i &gt;= 0; i--)//è¡Œ
            {
                bool find = false;
                for (int j = left; j &lt; bmp.Width; j++)//åˆ—
                {
                    Color c = bmp.GetPixel(j, i);
                    if (IsWhite(c))
                    {
                        bottom = i;
                        find = true;
                        break;
                    }
                }
                if (find) break;
            }
            //å¯»æ‰¾æœ€å³è¾¹çš„æ ‡çº¿ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä»å³å¾€å·¦
            for (int i = bmp.Width - 1; i &gt;= 0; i--)//åˆ—
            {
                bool find = false;
                for (int j = 0; j &lt;= bottom; j++)//è¡Œ
                {
                    Color c = bmp.GetPixel(i, j);
                    if (IsWhite(c))
                    {
                        right = i;
                        find = true;
                        break;
                    }
                }
                if (find) break;
            }
            int iWidth = right - left + 2;
            int iHeight = bottom - top + 2;
            bmp = Cut(bmp, left, top, iWidth, iHeight, WhiteBar);
            return bmp;
        }

        /// &lt;summary&gt;
        /// æ·»åŠ æ–‡å­—:MESç³»ç»Ÿè‡ªåŠ¨å‘é€
        /// &lt;/summary&gt;
        /// &lt;param name="bitmap"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Bitmap AddWatermarkWord(Bitmap bitmap)
        {
            //æ·»åŠ MESç³»ç»Ÿæ ‡è¯†
            string text = "MESç³»ç»Ÿè‡ªåŠ¨å‘é€";
            int fontSize = 10;
            Graphics g = Graphics.FromImage(bitmap);
            int rectWidth = text.Length * (fontSize + 10);
            int rectHeight = fontSize + 15;

            //å£°æ˜çŸ©å½¢åŸŸ
            Rectangle rectangle = new Rectangle(bitmap.Width - 200, bitmap.Height - 25, rectWidth, rectHeight);
            Font font = new Font("å¾®è½¯é›…é»‘", fontSize, FontStyle.Bold); //å®šä¹‰å­—ä½“
            SolidBrush backbrush = new SolidBrush(Color.Transparent);
            SolidBrush sbrushRed = new SolidBrush(Color.Red);
            var stringFormat = new StringFormat();
            stringFormat.Alignment = StringAlignment.Center;
            g.FillRectangle(backbrush, rectangle);
            g.DrawString(text, font, sbrushRed, rectangle, stringFormat);
            return bitmap;
        }

        /// &lt;summary&gt;
        /// å¯¹å›¾ç‰‡è¿›è¡Œè£å‰ª
        /// &lt;/summary&gt;
        /// &lt;param name="b"&gt;è¦è£å‰ªçš„å›¾ç‰‡&lt;/param&gt;
        /// &lt;param name="StartX"&gt;è£å‰ªçš„Xè½´&lt;/param&gt;
        /// &lt;param name="StartY"&gt;è£å‰ªçš„Yè½´&lt;/param&gt;
        /// &lt;param name="iWidth"&gt;è¦è£å‰ªçš„å®½åº¦&lt;/param&gt;
        /// &lt;param name="iHeight"&gt;è¦è£å‰ªçš„é«˜åº¦&lt;/param&gt;
        /// &lt;param name="WhiteBar"&gt;ä¿ç•™çš„ç™½è¾¹&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Bitmap Cut(Bitmap b, int StartX, int StartY, int iWidth, int iHeight, int WhiteBar)
        {
            Bitmap bmpOut = new Bitmap(iWidth + 2 * WhiteBar, iHeight + 2 * WhiteBar, PixelFormat.Format24bppRgb);

            Graphics g = Graphics.FromImage(bmpOut);
            g.FillRectangle(Brushes.White, new Rectangle(0, 0, iWidth + 2 * WhiteBar, iHeight + 2 * WhiteBar));
            g.DrawImage(b, new Rectangle(WhiteBar, WhiteBar, iWidth, iHeight), new Rectangle(StartX, StartY, iWidth, iHeight), GraphicsUnit.Pixel);
            g.Dispose();
            return bmpOut;
        }

        /// &lt;summary&gt;
        /// åˆ¤æ–­ç™½è‰²ä¸å¦ï¼Œéçº¯ç™½è‰²
        /// &lt;/summary&gt;
        /// &lt;param name="c"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool IsWhite(Color c)
        {
            if (c.R &lt; 245 || c.G &lt; 245 || c.B &lt; 245)
                return true;
            else return false;
        }
    }
}

</code></pre>
</blockquote>
<blockquote>
<h2 id="3ä½¿ç”¨é’‰é’‰æœºå™¨äººå‘é€å›¾ç‰‡">3ã€ä½¿ç”¨é’‰é’‰æœºå™¨äººå‘é€å›¾ç‰‡</h2>
<p>ä¸Šä¸€æ­¥ï¼Œæˆ‘ä»¬å°†å¸†è½¯å›¾ç‰‡å·²ç»ä¸‹è½½åˆ°æœ¬åœ°äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨é’‰é’‰æœºå™¨äººæ¨é€å›¾ç‰‡äº†ã€‚è¿™è¾¹è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ›²æŠ˜çš„ï¼ŒæŸ¥é˜…èµ„æ–™ï¼Œæˆ‘å…ˆä½¿ç”¨äº†SendMessageWithImageAsyncè¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æ¨é€åˆ°é’‰é’‰ï¼Œç¡®å®è¡¨æƒ…åŒ…ï¼Œæ— æ³•æ”¾å¤§æŸ¥çœ‹å›¾ç‰‡ã€‚</p>
<p><img src="https://gitee.com/wind59/blog-file/raw/master/Springboot/Pictures/10.2.png" alt="image-20250107133451315" loading="lazy"></p>
<p>ç„¶åï¼Œæˆ‘æ¢äº†ä¸ªæ ¼å¼ä½¿ç”¨SendMessageWithMarkDownAsyncæ–¹æ³•æ¥æ¨é€markdownï¼Œè¿™æ¬¡å›¾ç‰‡å¯ä»¥æ­£å¸¸æ”¾å¤§æ¥æŸ¥çœ‹äº†ã€‚</p>
<p><img src="https://gitee.com/wind59/blog-file/raw/master/Springboot/Pictures/10.3.png" alt="image-20250107133643171" loading="lazy"></p>
<p>å¯æ˜¯ï¼Œå½“æˆ‘å°†urlæ¢æˆæˆ‘æœ¬åœ°åˆšä¸‹è½½çš„å¸†è½¯æŠ¥è¡¨å›¾ç‰‡æ—¶ï¼Œå´å‘ç°æ¨é€åˆ°é’‰é’‰ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ã€‚é—®äº†ä¸‹ç™¾åº¦å‘ç°ï¼Œé’‰é’‰ç¾¤æœºå™¨äººç›®å‰ä¸æ”¯æŒç›´æ¥æ¨é€æœ¬åœ°å›¾ç‰‡ï¼Œè§£å†³æ–¹æ³•å¯ä»¥å°†å›¾ç‰‡æ”¾åˆ°é’‰é’‰æœåŠ¡å™¨å¯ä»¥httpè®¿é—®çš„å­˜å‚¨æœåŠ¡å™¨ä¸Šã€‚è¿™ä¸‹éš¾åŠäº†ï¼Œå› ä¸ºæ€»éƒ¨å®‰å…¨çš„ç­–ç•¥ï¼Œè¿™éƒ¨åˆ†åªèƒ½æ‰¾æ€»éƒ¨å¯»æ±‚å¸®åŠ©äº†ã€‚</p>
<p><img src="https://gitee.com/wind59/blog-file/raw/master/Springboot/Pictures/10.4.png" alt="image-20250107133932522" loading="lazy"></p>
<pre><code class="language-c#">using System.Text;

namespace DingDingTest
{
    public class DingTalkClient
    {
        private readonly HttpClient _httpClient;
         // é’‰é’‰æœºå™¨äººçš„Webhook URL
 private readonly string webhookUrl = "https://oapi.dingtalk.com/robot/send?access_token={token}";
 private readonly string title = "MESæŠ¥éšœ";

        public DingTalkClient(HttpClient httpClient)
        {
            _httpClient = httpClient;
        }

        /// &lt;summary&gt;
        /// å‘é€å›¾ç‰‡
        /// &lt;/summary&gt;
        /// &lt;param name="webhookUrl"&gt;&lt;/param&gt;
        /// &lt;param name="imageUrl"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task SendMessageWithImageAsync(string webhookUrl, string imageUrl)
        {
            var content = new StringContent($"{{ \"msgtype\": \"image\", \"image\": {{ \"picURL\": \"{imageUrl}\" }} }}", Encoding.UTF8, "application/json");
            // å‘é€POSTè¯·æ±‚
            var response = await _httpClient.PostAsync(webhookUrl, content);
            // è¾“å‡ºç»“æœ
            Console.WriteLine(await response.Content.ReadAsStringAsync());
        }

        /// &lt;summary&gt;
        /// å‘é€markdown
        /// &lt;/summary&gt;
        /// &lt;param name="webhookUrl"&gt;&lt;/param&gt;
        /// &lt;param name="imageUrl"&gt;&lt;/param&gt;
        /// &lt;param name="message"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task SendMessageWithMarkDownAsync(string webhookUrl, string imageUrl, string message)
        {
            var content = new StringContent($"{{ \"msgtype\": \"markdown\", \"markdown\": {{ \"title\": \"{message}\", \"text\": \"![å›¾ç‰‡]({imageUrl})\" }} }}", Encoding.UTF8, "application/json");
            // å‘é€POSTè¯·æ±‚
            var response = await _httpClient.PostAsync(webhookUrl, content);
            // è¾“å‡ºç»“æœ
            Console.WriteLine(await response.Content.ReadAsStringAsync());
        }
    }
}

</code></pre>
</blockquote>
<blockquote>
<h2 id="4ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°gitee">4ã€ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°gitee</h2>
<p>åœ¨æ€»éƒ¨çš„å¸®åŠ©ä¸‹ï¼Œæœ€åä¹Ÿæ˜¯æˆåŠŸå®ç°äº†åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä¸€æƒ³ï¼Œæˆ‘ä»¬å¹³æ—¶å¯ä»¥æŠŠæœ¬åœ°å›¾ç‰‡ä¸Šä¼ åˆ°giteeï¼Œç„¶åé’‰é’‰æœºå™¨äººæ¨é€çš„åœ°å€æ”¹æˆgiteeçš„å›¾ç‰‡è®¿é—®è·¯å¾„ä¸ä¹Ÿè¡Œå—ï¼Œè¯´å¹²å°±å¹²ã€‚æŸ¥çœ‹giteeå¸®åŠ©æ–‡æ¡£ã€‚ä¸Šä¼ æˆåŠŸã€‚</p>
<p><img src="https://gitee.com/wind59/blog-file/raw/master/Springboot/Pictures/10.5.png" alt="image-20250107134758636" loading="lazy"></p>
<pre><code class="language-c#">// è¦å‘é€çš„å›¾ç‰‡URL
 string imageUrl = $"https://gitee.com/{user}/{repos}/raw/{branch}/{path}";
</code></pre>
<pre><code class="language-c#">using System.Text;

namespace DingDingTest
{
    internal class UploadImage
    {
        private const string AccessToken = {ä½ çš„ä»¤ç‰Œ};
        private const string Repository = {ä½ çš„ä»“åº“};
        private const string Branch = {ä½ çš„åˆ†æ”¯};
        private const string BasePath = "gitee.com";
        private const string ApiPath = "/api/v5/repos/{user}/{repos}/contents/{path}";
        public async Task UploadImageAsync(string imagePath, string commitMessage)
        {
            var imageFileName = Path.GetFileName(imagePath);
            try
            {
                var url = {ä¸Šä¼ åœ°å€};
                using (var request = new HttpRequestMessage(HttpMethod.Post, url))
                {
                    string contentType = "application/json";
                    // è®¾ç½®è¯·æ±‚å¤´ä¸­çš„ContentType
                    request.Headers.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue(contentType));
                    var data = new
                    {
                        access_token = AccessToken,
                        content = Convert.ToBase64String(System.IO.File.ReadAllBytes(imagePath)), // è¿™é‡Œåº”è¯¥æ”¾ç½®ä½ çš„Base64ç¼–ç åçš„å›¾ç‰‡å†…å®¹
                        message = commitMessage
                    };
                    string jsonBody = Newtonsoft.Json.JsonConvert.SerializeObject(data);
                    request.Content = new StringContent(jsonBody, Encoding.UTF8, contentType);
                    var client = new HttpClient();
                    client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("token", AccessToken);
                    HttpResponseMessage response = client.Send(request);
                    response.EnsureSuccessStatusCode(); // æŠ›å‡ºå¼‚å¸¸å¦‚æœå“åº”ä¸æ˜¯æˆåŠŸçš„
                    string responseBody = await response.Content.ReadAsStringAsync().ConfigureAwait(false);
                    Console.WriteLine(responseBody);
                }
            }
            catch (HttpRequestException e)
            {
                Console.WriteLine("\nException Caught!");
                Console.WriteLine("Message :{0} ", e.Message);
            }
        }
    }
}

</code></pre>
</blockquote>
<blockquote>
<h2 id="5ä½¿ç”¨quartz">5ã€ä½¿ç”¨Quartz</h2>
<p>æ·»åŠ Quartz,æ¯ä¸‰åˆ†é’Ÿæ‰§è¡Œæµ‹è¯•ä¸€ä¸‹ï¼Œæµ‹è¯•OKã€‚</p>
<pre><code class="language-c#">using Quartz;
using Quartz.Impl;
using System;
using System.Threading.Tasks;

namespace DingDingTest
{
    internal class Program
    {
        static async Task Main(string[] args)
        {
            // 1. åˆ›å»ºScheduler
            IScheduler scheduler = await StdSchedulerFactory.GetDefaultScheduler();

            // 2. å¼€å¯Scheduler
            await scheduler.Start();

            // 3. åˆ›å»ºä½œä¸š
            IJobDetail job = JobBuilder.Create&lt;TestJob&gt;()
                .WithIdentity("myJob", "group1")
                .Build();

            // 4. åˆ›å»ºè§¦å‘å™¨
            var trigger = TriggerBuilder.Create()
                .WithIdentity("myTrigger", "group1")
                .StartNow() // ç«‹å³å¯åŠ¨
                .WithSimpleSchedule(x =&gt; x
                    .RepeatForever() // é‡å¤æ‰§è¡Œ
                    .WithIntervalInMinutes(3)) // æ¯3minæ‰§è¡Œä¸€æ¬¡
                .Build();

            // 5. å°†ä½œä¸šå’Œè§¦å‘å™¨æ·»åŠ åˆ°è°ƒåº¦å™¨
            await scheduler.ScheduleJob(job, trigger);

            Console.WriteLine("Press any key to close the application");
            Console.ReadKey();

            // 6. å…³é—­Scheduler
            await scheduler.Shutdown();
        }
    }
}

</code></pre>
</blockquote>
<blockquote>
<h2 id="6æ€»ç»“">6ã€æ€»ç»“</h2>
<p>æ•´ä½“æ€è·¯æœ€åå¦‚ä¸‹ï¼š</p>
<p>1ã€ä¸‹è½½å¸†è½¯æŠ¥è¡¨å›¾ç‰‡åˆ°æœ¬åœ°</p>
<p>2ã€ä¸Šä¼ å›¾ç‰‡åˆ°å…¬ç½‘å¯pingé€šçš„æœåŠ¡å™¨</p>
<p>3ã€é’‰é’‰æœºå™¨äººä»¥markdownæ–¹å¼æ¨é€</p>
<p>è¸©å‘å¦‚ä¸‹ï¼š</p>
<p>1ã€å› ä¸ºä¹‹å‰ä¸‹è½½å¸†è½¯æŠ¥è¡¨å›¾ç‰‡åˆ°æœ¬åœ°ï¼Œå…¶ä¸­å¸†è½¯çš„å‚æ•°ä½¿ç”¨çš„å¤–éƒ¨è„šæœ¬ï¼Œæ‰€ä»¥ä½¿ç”¨äº†using Microsoft.CSharpåŒ…çš„CSharpCodeProviderï¼Œæ¥åŠ¨æ€æ‰§è¡Œå¤–éƒ¨C#è„šæœ¬ä»£ç ï¼Œæ¥æ‹¼æ¥æŸ¥è¯¢çš„å‚æ•°ï¼Œä½†æ˜¯å› ä¸ºç‰ˆæœ¬çš„é—®é¢˜.Net 8 ä¸­CSharpCodeProviderè¢«åºŸå¼ƒäº†ï¼Œæ‰€ä»¥æ¢æˆäº†Microsoft.CodeAnalysis.CSharpã€‚ç®€å•ä½¿ç”¨çš„è¯ï¼Œä¸Šè¯‰ä»£ç FineReportUrlParamæ–¹æ³•å¯ä»¥ç›´æ¥æ‹¼æ¥ä¸‹ä¼ å‚</p>
<p>2ã€é’‰é’‰æœºå™¨äººæ— æ³•ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆä¹Ÿä¸çŸ¥é“ç™¾åº¦çš„å¯¹ä¸å¯¹ï¼Œæˆ–è®¸æœ‰å…¶ä»–æ–¹å¼ï¼Œå“ˆå“ˆï¼‰</p>
<p>3ã€ ä¸Šä¼ åˆ°giteeä¸Šæ—¶ï¼ŒHttpResponseMessage response = client.Send(request);å¯ä»¥çœ‹åˆ°æˆ‘è¿™è¾¹æ²¡æœ‰ä½¿ç”¨SendAsyncï¼ŒğŸ˜­è¿™æ˜¯å› ä¸ºæˆ‘ä½¿ç”¨äº†å¼‚æ­¥ï¼Œvsæ‰§è¡Œåˆ°è¿™é‡Œå°±ä¼šå´©æºƒï¼Œæ›´æ”¹æˆSendå°±å¥½äº†ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºå•¥ã€‚</p>
</blockquote>
<p>æœ€å¥½ï¼Œå‰åæäº†ä¸¤ä¸‰å¤©è¿˜æ˜¯å®ç°äº†è¯¥åŠŸèƒ½ï¼Œç‰¹æ­¤è®°å½•åˆ†äº«ä¸‹ã€‚</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="2.86181717027662" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-07 14:11">2025-01-07 14:11</span>&nbsp;
<a href="https://www.cnblogs.com/ziyansugar">å­è¨€sugar</a>&nbsp;
é˜…è¯»(<span id="post_view_count">70</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18657519" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18657519);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18657519', targetLink: 'https://www.cnblogs.com/ziyansugar/p/18657519', title: 'C#ç¬”è®°ï¼ˆ1ã€é’‰é’‰æœºå™¨äººæ¨é€å¸†è½¯æŠ¥è¡¨å›¾ç‰‡ï¼‰' })">ä¸¾æŠ¥</a>
</div>
        