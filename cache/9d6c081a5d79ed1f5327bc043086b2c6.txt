
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/abinzhao/p/18910353" title="å‘å¸ƒäº 2025-06-04 15:40">
    <span role="heading" aria-level="2">HarmonyOS å®æˆ˜ï¼šç»™ç¬”è®°åº”ç”¨åŠ é˜²æˆªå›¾æ°´å°</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æœ€è¿‘åœ¨åšç¬”è®°ç±»åº”ç”¨æ—¶ï¼Œé‡åˆ°ä¸€ä¸ªå¤´ç–¼çš„éœ€æ±‚ï¼šé˜²æ­¢ç”¨æˆ·å†…å®¹è¢«éæ³•æˆªå›¾ä¼ æ’­ã€‚æ€æ¥æƒ³å»ï¼ŒåŠ æ°´å°æ˜¯ä¸ªç›´æ¥æœ‰æ•ˆçš„æ–¹æ¡ˆã€‚ç ”ç©¶äº† HarmonyOS çš„å¼€å‘æ–‡æ¡£åï¼Œå‘ç°ç”¨ Canvas é…åˆå¸ƒå±€ç»„ä»¶èƒ½è½»æ¾å®ç°åŠ¨æ€æ°´å°æ•ˆæœã€‚ä»Šå¤©å°±æ¥èŠèŠå¦‚ä½•ç»™ç¬”è®°é¡µé¢åŠ ä¸Šã€Œä¼šå‘¼å¸ã€çš„ç”¨æˆ·ä¸“å±æ°´å°ï¼Œé¡ºä¾¿åˆ†äº«å‡ ä¸ªå¼€å‘æ—¶è¸©è¿‡çš„å‘ã€‚</p>
<h2 id="ä¸€éœ€æ±‚æ‹†è§£ä»€ä¹ˆæ ·çš„æ°´å°é˜²æˆªå›¾æœ€æœ‰æ•ˆ">ä¸€ã€éœ€æ±‚æ‹†è§£ï¼šä»€ä¹ˆæ ·çš„æ°´å°é˜²æˆªå›¾æœ€æœ‰æ•ˆï¼Ÿ</h2>
<p>æˆ‘ä»¬çš„ç›®æ ‡å¾ˆæ˜ç¡®ï¼šåœ¨ç¬”è®°æµè§ˆé¡µé¢è¦†ç›–ä¸€å±‚åŠé€æ˜æ°´å°ï¼Œå†…å®¹åŒ…å«<strong>ç”¨æˆ· ID+å®æ—¶æ—¶é—´æˆ³</strong>ï¼Œä¸”æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li><strong>æ–œå‘æ’åˆ—</strong>ï¼šé˜²æ­¢æˆªå›¾åé€šè¿‡ç®€å•è£å‰ªå»é™¤</li>
<li><strong>åŠ¨æ€æ›´æ–°</strong>ï¼šæ¯åˆ†é’Ÿåˆ·æ–°æ—¶é—´æˆ³ï¼Œå¢åŠ è¿½è¸ªéš¾åº¦</li>
<li><strong>æ€§èƒ½æ— æ„Ÿ</strong>ï¼šä¸å½±å“é¡µé¢æ»‘åŠ¨å’Œäº¤äº’</li>
<li><strong>å…¨å±€è¦†ç›–</strong>ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸å’Œæ—‹è½¬æ–¹å‘</li>
</ul>
<h2 id="äºŒæ ¸å¿ƒå®ç°ç”¨canvaså®ç°åŠ¨æ€æ°´å°">äºŒã€æ ¸å¿ƒå®ç°ï¼šç”¨canvaså®ç°åŠ¨æ€æ°´å°</h2>
<h3 id="1-æ­å»ºæ°´å°ç»„ä»¶éª¨æ¶">1. æ­å»ºæ°´å°ç»„ä»¶éª¨æ¶</h3>
<p>é¦–å…ˆå°è£…ä¸€ä¸ª <code>UserWatermark</code> ç»„ä»¶ï¼ŒåŸºäº HarmonyOS çš„ Canvas å®ç°è‡ªç»˜ã€‚è¿™é‡Œæœ‰ä¸ªå…³é”®ç»†èŠ‚ï¼šé€šè¿‡ <code>hitTestBehavior</code> è®¾ç½®æ°´å°å±‚é€æ˜ï¼Œé¿å…é˜»æŒ¡ç”¨æˆ·ç‚¹å‡»ç¬”è®°å†…å®¹ã€‚</p>
<pre><code class="language-typescript">// components/Watermark.ets
@Component
export struct UserWatermark {
  @State userId = 'user001' // ä»è´¦å·æœåŠ¡è·å–çš„åŠ¨æ€ç”¨æˆ·ID
  private context = new CanvasRenderingContext2D(new RenderingContextSettings(true))
  private timestamp = new Date().toLocaleString() // å®æ—¶æ—¶é—´æˆ³

  build() {
    Canvas(this.context)
      .width('100%')
      .height('100%')
      .hitTestBehavior(HitTestMode.Transparent) // é‡ç‚¹ï¼ä¸å½±å“è§¦æ‘¸äº‹ä»¶
      .onReady(() =&gt; this.drawWatermark())
  }

  // åˆå§‹åŒ–ç»˜åˆ¶
  private drawWatermark() {
    this.updateTimestamp() // å…ˆæ›´æ–°æ—¶é—´
    this.context.clearRect(0, 0, this.context.width, this.context.height)
    this.setWatermarkStyle()
    this.drawWatermarkGrid()
  }
}
</code></pre>
<h3 id="2-åŠ¨æ€æ—¶é—´æˆ³å®ç°æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡">2. åŠ¨æ€æ—¶é—´æˆ³å®ç°ï¼šæ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡</h3>
<p>ä¸ºäº†é¿å…é«˜é¢‘é‡ç»˜å½±å“æ€§èƒ½ï¼Œé€‰æ‹©æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æˆ³ã€‚è¿™é‡Œç”¨ <code>setInterval</code> é…åˆçŠ¶æ€å˜é‡è§¦å‘é‡ç»˜ï¼š</p>
<pre><code class="language-typescript">// ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­
aboutToAppear() {
  this.updateTimestamp() // åˆå§‹åŒ–æ—¶é—´
  setInterval(() =&gt; {
    this.timestamp = new Date().toLocaleString() // æ›´æ–°æ—¶é—´
    this.drawWatermark() // è§¦å‘ç”»å¸ƒé‡ç»˜
  }, 60 * 1000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
}

// æ—¶é—´æ ¼å¼åŒ–æ–¹æ³•ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
private updateTimestamp() {
  const now = new Date()
  this.timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
}
</code></pre>
<h3 id="3-æ–œå‘æ°´å°çš„åæ ‡è®¡ç®—ç„å­¦">3. æ–œå‘æ°´å°çš„åæ ‡è®¡ç®—ã€Œç„å­¦ã€</h3>
<p>å®ç°æ–œå‘æ’åˆ—çš„å…³é”®æ˜¯<strong>åæ ‡ç³»æ—‹è½¬å’Œå¹³ç§»</strong>ã€‚è¿™é‡Œè¸©è¿‡æœ€å¤§çš„å‘æ˜¯æ—‹è½¬ååŸç‚¹ä½ç½®çš„å˜åŒ–ï¼Œè°ƒè¯•äº†åŠå°æ—¶æ‰å‘ç°éœ€è¦å°†åŸç‚¹ç§»åˆ°å·¦ä¸‹è§’ï¼š</p>
<pre><code class="language-typescript">private drawWatermarkGrid() {
  const text = `ç”¨æˆ·ID:${this.userId} ${this.timestamp}`
  const font = '14vp sans-serif'
  const angle = -25 * Math.PI / 180 // å€¾æ–œ25åº¦

  // è®¡ç®—æ–‡æœ¬å°ºå¯¸
  this.context.font = font
  const { width: textWidth, height: textHeight } = this.context.measureText(text)

  // åæ ‡ç³»å˜æ¢ï¼šå…ˆå¹³ç§»åˆ°å·¦ä¸‹è§’ï¼Œå†æ—‹è½¬
  this.context.save()
  this.context.translate(0, this.context.height) // åŸç‚¹ç§»è‡³å·¦ä¸‹è§’
  this.context.rotate(angle) // é€†æ—¶é’ˆæ—‹è½¬25åº¦

  // è®¡ç®—è¡Œåˆ—é—´éš”ï¼ˆ1.5å€æ–‡æœ¬å°ºå¯¸é¿å…é‡å ï¼‰
  const colGap = textWidth * 1.5
  const rowGap = textHeight * 1.5
  const cols = Math.ceil(this.context.width / colGap)
  const rows = Math.ceil(this.context.height / rowGap)

  // ç»˜åˆ¶ç½‘æ ¼
  for (let i = 0; i &lt; cols; i++) {
    for (let j = 0; j &lt; rows; j++) {
      const x = i * colGap
      const y = j * rowGap
      this.context.fillText(text, x, -y) // yè½´åè½¬ï¼ˆå› ä¸ºåŸç‚¹åœ¨å·¦ä¸‹è§’ï¼‰
    }
  }

  this.context.restore() // æ¢å¤åŸå§‹åæ ‡ç³»
}
</code></pre>
<h3 id="4-é¡µé¢é›†æˆç”¨-stack-å®ç°æ°´å°å±‚è¦†ç›–">4. é¡µé¢é›†æˆï¼šç”¨ Stack å®ç°æ°´å°å±‚è¦†ç›–</h3>
<p>å°†æ°´å°ç»„ä»¶ä¸ç¬”è®°å†…å®¹å±‚å åŠ ï¼Œæ¨èä½¿ç”¨ <code>Stack</code> å¸ƒå±€ï¼Œæ¸…æ™°ä¸”æ€§èƒ½ç¨³å®šï¼š</p>
<pre><code class="language-typescript">// pages/NoteDetail.ets
@Entry
@Component
struct NoteDetail {
  private noteContent = 'è¿™é‡Œæ˜¯ç”¨æˆ·çš„ç¬”è®°æ­£æ–‡...'

  build() {
    Stack() {
      // ç¬”è®°å†…å®¹å±‚
      Column()
        .padding(24)
        .spacing(16)
        .text(this.noteContent)
        .fontSize(16)
        .lineHeight(24)

      // æ°´å°å±‚ï¼ˆè¦†ç›–åœ¨å†…å®¹ä¸Šæ–¹ï¼‰
      UserWatermark()
    }
    .backgroundColor(Color.White)
    .width('100%')
    .height('100%')
  }
}
</code></pre>
<h2 id="ä¸‰æ€§èƒ½ä¼˜åŒ–">ä¸‰ã€æ€§èƒ½ä¼˜åŒ–</h2>
<ol>
<li>
<p><strong>ç¦»å±æ¸²æŸ“ä¼˜åŒ–</strong><br>
å¦‚æœé‡åˆ°é¡µé¢å¡é¡¿ï¼Œå¯ä»¥å°è¯•å°† <code>Canvas</code> æ›¿æ¢ä¸º <code>OffscreenCanvas</code> è¿›è¡Œç¦»å±ç»˜åˆ¶ï¼Œå‡å°‘ä¸»çº¿ç¨‹å‹åŠ›ï¼š</p>
<pre><code class="language-typescript">// ç¦»å±ç”»å¸ƒç‰ˆæœ¬ï¼ˆé€‚ç”¨äºå¤æ‚åœºæ™¯ï¼‰
private offscreenCanvas = new OffscreenCanvas()
private offscreenContext = this.offscreenCanvas.getContext('2d')!

// åœ¨drawæ–¹æ³•ä¸­ä½¿ç”¨offscreenContextç»˜åˆ¶ï¼Œæœ€ååŒæ­¥åˆ°ä¸»ç”»å¸ƒ
this.context.drawImage(this.offscreenCanvas, 0, 0)
</code></pre>
</li>
<li>
<p><strong>æ–‡æœ¬æµ‹é‡ç¼“å­˜</strong><br>
é‡å¤è®¡ç®—æ–‡æœ¬å®½åº¦ä¼šå½±å“æ€§èƒ½ï¼Œå› æ­¤å°† <code>measureText</code> çš„ç»“æœç¼“å­˜ï¼š</p>
<pre><code class="language-typescript">private textMetrics: TextMetrics | null = null

private getTextSize(text: string) {
  if (!this.textMetrics || this.textMetrics.text !== text) {
    this.textMetrics = this.context.measureText(text)
  }
  return this.textMetrics
}
</code></pre>
</li>
<li>
<p><strong>è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–</strong><br>
é€šè¿‡ <code>hitTestBehavior: HitTestMode.Transparent</code> è®©æ°´å°å±‚å®Œå…¨é€æ˜ï¼Œè§¦æ‘¸äº‹ä»¶ç›´æ¥ç©¿é€åˆ°ä¸‹å±‚å†…å®¹ï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œã€‚</p>
</li>
</ol>
<h2 id="å››ä»é¡µé¢åˆ°å…¨åœºæ™¯çš„æ°´å°æ–¹æ¡ˆ">å››ã€ä»é¡µé¢åˆ°å…¨åœºæ™¯çš„æ°´å°æ–¹æ¡ˆ</h2>
<p>å¦‚æœä½ çš„åº”ç”¨éœ€è¦æ”¯æŒæ›´å¤šåœºæ™¯ï¼Œè¿˜å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸­çš„å…¶ä»–èƒ½åŠ›ï¼š</p>
<ul>
<li><strong>å›¾ç‰‡æ°´å°</strong>ï¼šç”¨ <code>OffscreenCanvas</code> å®ç°æœ¬åœ°å›¾ç‰‡åŠ æ°´å°ï¼ˆé€‚åˆç”¨æˆ·ä¿å­˜ç¬”è®°æˆªå›¾æ—¶è‡ªåŠ¨åŠ æ°´å°ï¼‰</li>
<li><strong>PDF æ°´å°</strong>ï¼šé€šè¿‡ <code>pdfService</code> æ¨¡å—ç»™å¯¼å‡ºçš„ PDF æ–‡æ¡£æ·»åŠ æ°´å°ï¼ˆä¼ä¸šéœ€æ±‚å¿…å¤‡ï¼‰</li>
<li><strong>åŠ¨æ€å˜è‰²</strong>ï¼šæ ¹æ®é¡µé¢ä¸»é¢˜åˆ‡æ¢æ°´å°é¢œè‰²ï¼ˆæµ…è‰²/æ·±è‰²æ¨¡å¼é€‚é…ï¼‰</li>
</ul>
<h2 id="äº”é‚£äº›è®©æˆ‘åŠå¤œç¡ä¸ç€çš„ç»†èŠ‚">äº”ã€é‚£äº›è®©æˆ‘åŠå¤œç¡ä¸ç€çš„ç»†èŠ‚</h2>
<ol>
<li>
<p><strong>æ—‹è½¬æ–¹å‘çš„å‘</strong><br>
åæ ‡ç³»é»˜è®¤é¡ºæ—¶é’ˆæ—‹è½¬ï¼Œæƒ³å®ç°ã€Œå‘å·¦å€¾æ–œã€éœ€è¦ç”¨è´Ÿæ•°è§’åº¦ï¼ˆå¦‚ <code>-25åº¦</code>ï¼‰ï¼Œåˆšå¼€å§‹ç”¨æ­£æ•°å¯¼è‡´æ°´å°æ–¹å‘æåã€‚</p>
</li>
<li>
<p><strong>è®¾å¤‡é€‚é…é—®é¢˜</strong><br>
ä¸åŒè®¾å¤‡çš„ <code>vp</code> å•ä½æ¢ç®—æœ‰å·®å¼‚ï¼Œå»ºè®®ç»Ÿä¸€å¤„ç†å°ºå¯¸é—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>æ€§èƒ½ç›‘æ§</strong><br>
ç”¨ DevEco Studio çš„ã€Œæ€§èƒ½è°ƒä¼˜ã€å·¥å…·ç›‘æ§ <code>onReady</code> å’Œ <code>draw</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œç¡®ä¿å•æ¬¡ç»˜åˆ¶ä¸è¶…è¿‡ 16msï¼ˆ60fpsæ ‡å‡†ï¼‰ã€‚</p>
</li>
</ol>
<h2 id="å…­æ€»ç»“æ°´å°èƒŒåçš„å®‰å…¨å“²å­¦">å…­ã€æ€»ç»“ï¼šæ°´å°èƒŒåçš„å®‰å…¨å“²å­¦</h2>
<p>åŠ æ°´å°æœ¬è´¨æ˜¯ä¸€ç§ã€Œå¨æ…‘æ€§é˜²æŠ¤ã€ï¼Œå®ƒä¸èƒ½å®Œå…¨é˜»æ­¢æˆªå›¾ï¼Œä½†èƒ½å¤§å¤§å¢åŠ å†…å®¹æ³„éœ²åçš„è¿½æº¯æˆæœ¬ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ç»“åˆä»¥ä¸‹ç­–ç•¥ï¼š</p>
<ul>
<li><strong>å‰ç«¯æ°´å°</strong>ï¼šé˜²æ­¢éæˆæƒæˆªå›¾ä¼ æ’­</li>
<li><strong>åç«¯æ—¥å¿—</strong>ï¼šè®°å½•ç”¨æˆ·æ“ä½œæ—¶é—´çº¿</li>
<li><strong>æ•°æ®åŠ å¯†</strong>ï¼šæ•æ„Ÿå†…å®¹æœ¬åœ°åŠ å¯†å­˜å‚¨</li>
</ul>
<p>æŠ€æœ¯ä¹‹å¤–ï¼Œæ›´é‡è¦çš„æ˜¯å¹³è¡¡ç”¨æˆ·ä½“éªŒä¸å®‰å…¨éœ€æ±‚â€”â€”æ¯•ç«Ÿï¼Œæ²¡æœ‰äººå–œæ¬¢è¢«å¯†å¯†éº»éº»çš„æ°´å°ã€ŒåŒ…å›´ã€ã€‚é€šè¿‡é€æ˜åº¦è°ƒæ•´ï¼ˆå»ºè®® <code>opacity: 0.15-0.2</code>ï¼‰å’Œåˆç†çš„æ’åˆ—é—´éš”ï¼Œå®Œå…¨å¯ä»¥åšåˆ°ã€Œæ°´å°å¯è§ä½†ä¸å¹²æ‰°é˜…è¯»ã€ã€‚</p>
<p>å¦‚æœä½ åœ¨å¼€å‘ä¸­é‡åˆ°å…¶ä»–æœ‰è¶£çš„åœºæ™¯ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï½ ä¸€èµ·ç”¨æŠ€æœ¯è®©å†…å®¹å®‰å…¨æ›´ä¼˜é›…ä¸€ç‚¹ï½ ğŸ’»âœ¨</p>

</div>
<div id="MySignature" role="contentinfo">
    <p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href="https://www.cnblogs.com/abinzhao/" target="_blank">çº¯çˆ±æŒé—¨äºº</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href="https://www.cnblogs.com/abinzhao/p/18910353" target="_blank">https://www.cnblogs.com/abinzhao/p/18910353</a></p>
</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.5242397295150463" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-06-04 15:40">2025-06-04 15:40</span>&nbsp;
<a href="https://www.cnblogs.com/abinzhao">çº¯çˆ±æŒé—¨äºº</a>&nbsp;
é˜…è¯»(<span id="post_view_count">104</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18910353);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18910353', targetLink: 'https://www.cnblogs.com/abinzhao/p/18910353', title: 'HarmonyOS å®æˆ˜ï¼šç»™ç¬”è®°åº”ç”¨åŠ é˜²æˆªå›¾æ°´å°' })">ä¸¾æŠ¥</a>
</div>
	