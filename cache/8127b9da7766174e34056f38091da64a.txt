<!----> <meta itemprop="headline" content="怎么办？微信小程序主包又双叒叕不够用了！！！"> <meta itemprop="keywords" content="React.js"> <meta itemprop="datePublished" content="2025-04-21T01:18:12.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古茗前端团队"> <meta itemprop="url" content="https://juejin.cn/user/3233040624266695"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-61fb5e44="">
            怎么办？微信小程序主包又双叒叕不够用了！！！
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dafcebf7c91d402abd52f072a32deba8~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="古茗前端团队" class="title" data-v-d326b38e="">古茗前端团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-04-21T01:18:12.000Z" title="Mon Apr 21 2025 01:18:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-04-21
              </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""></circle></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                9,433
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""></path></svg>
                阅读7分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"></path><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"></path></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @古茗科技
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><h2 data-id="heading-0">一、背景</h2>
<p>古茗会员体系升级需要在小程序首页接入炫酷的动画，通过技术选型最终敲定了阿里出品的<code>@galacean/effects</code>，编译后体积<code>599.3KB</code>，小程序主包限制最大也就只有<code>2MB</code>，这完全塞不下啊喂。这就不得不吐槽了，都<code>2025</code>年了，大家都在用<code>5G</code>网络了，微信小程序主包体积限制还是<code>2MB</code>。</p>
<p>目前我们在古茗点单小程序中已经使用了以下<a href="https://juejin.cn/post/7326093660705718284" target="_blank" title="https://juejin.cn/post/7326093660705718284">优化方案</a>：</p>
<ul>
<li>页面分包：主包仅保留默认「启动页/TabBar页」，其他页面模块均迁移至分包</li>
<li>图片资源优化：上传本地资源，并通过Babel插件实现本地资源替换为网络地址。</li>
<li>公共模块分包：Taro项目配置mini.optimizeMainPackage，将主包未使用的公共模块打包至对应分包。</li>
</ul>
<p>能优化的都优化了，完蛋没法发版了。又没有钞能力让微信多给我们几<code>MB</code>，只能再想想其他办法了。。。</p>
<h2 data-id="heading-1">二、目标</h2>
<ul>
<li>能够使用<code>@galacean/effects</code>，在小程序首页展示炫酷的动画，且主包体积不能超<code>2MB</code></li>
<li>沉淀通用的解决方案，优化其他三方依赖或业务组件在主包中的体积占用。</li>
</ul>
<h2 data-id="heading-2">三、方案实现</h2>
<p>主包塞不下，那就塞分包里，「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fsubpackages%2Fasync.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/async.html" ref="nofollow noopener noreferrer">分包异步化</a>」闪亮登场！！！</p>
<p>核心思路：</p>
<ul>
<li>将编译后体积占用较大的<code>JS</code>代码拆分到分包中</li>
<li>通过微信分包异步化的能力，跨分包引用<code>JS</code>代码</li>
</ul>
<h3 data-id="heading-3">1. 实现V1：<code>babel</code>收集异步化模块编译输出到指定分包</h3>
<h4 data-id="heading-4">实现思路</h4>
<ul>
<li>定义一个标记函数<code>asyncRequire</code></li>
<li><code>babel</code>识别<code>asyncRequire</code>收集异步化模块，并替换为跨分包引用<code>JS</code>实现</li>
<li><code>webpack</code>插件实现<code>esbuild</code>编译收集的异步化模块，并输出到指定分包</li>
<li>通过<code>taro</code>插件引入实现的<code>babel</code>和<code>webpack</code>插件，并修改微信小程序配置文件，注册对应分包</li>
</ul>
<h4 data-id="heading-5">代码实现</h4>
<ol>
<li>定义全局函数<code>asyncRequire</code>标记异步化模块。</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">/**
 * 异步加载三方依赖
 */</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">asyncRequire</span>: &lt;T = <span class="hljs-built_in">any</span>&gt;<span class="hljs-function">(<span class="hljs-params">packagePath: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;
</code></pre>
<ol start="2">
<li>定义重试函数<code>promiseRetry</code></li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">promiseRetry</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fn: () =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;, retries = <span class="hljs-number">3</span>, delay = <span class="hljs-number">1000</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 尝试执行传入的异步操作</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (retries &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error); <span class="hljs-comment">// 如果用尽重试次数，抛出错误</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, delay)); <span class="hljs-comment">// 等待指定的延迟时间</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">promiseRetry</span>(fn, retries - <span class="hljs-number">1</span>, delay); <span class="hljs-comment">// 递归调用自己</span>
  }
};

</code></pre>
<ol start="3">
<li><code>babel</code>收集异步化模块路径，并替换为跨分包引用<code>JS</code>实现</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 异步化模块路径</span>
<span class="hljs-keyword">const</span> asyncPackagePaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();

<span class="hljs-comment">// 基于异步化模块文件路径生成模块编译后的分包名</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateAsyncPackageName</span> = (<span class="hljs-params">packagePath</span>) =&gt; packagePath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">'-'</span>);

<span class="hljs-comment">// Babel 收集当前文件已引入的依赖</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getImportElements</span> = (<span class="hljs-params">programPath</span>) =&gt; {
  <span class="hljs-keyword">const</span> importElement = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  programPath.<span class="hljs-title function_">traverse</span>({
    <span class="hljs-title class_">ImportDeclaration</span>(importDeclarationPath) {
      <span class="hljs-keyword">const</span> { source, specifiers } = importDeclarationPath.<span class="hljs-property">node</span>;
      <span class="hljs-keyword">if</span> (!importElement.<span class="hljs-title function_">has</span>(source.<span class="hljs-property">value</span>)) importElement.<span class="hljs-title function_">set</span>(source.<span class="hljs-property">value</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
      <span class="hljs-keyword">const</span> tempObj = importElement.<span class="hljs-title function_">get</span>(source.<span class="hljs-property">value</span>);
      specifiers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">specifier</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span> } = specifier;
        <span class="hljs-keyword">if</span> (!tempObj.<span class="hljs-title function_">has</span>(<span class="hljs-keyword">type</span>)) tempObj.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">type</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
        tempObj.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>).<span class="hljs-title function_">add</span>(specifier?.<span class="hljs-property">local</span>?.<span class="hljs-property">name</span>);
      });
    },
  });
  <span class="hljs-keyword">return</span> importElement;
};

<span class="hljs-comment">// 插入依赖（用来引入 promiseRetry 函数的）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">injectImport</span> = (<span class="hljs-params">programPath</span>) =&gt; {
  <span class="hljs-keyword">const</span> importElements = <span class="hljs-title function_">getImportElements</span>(programPath);
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">templateCode</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> templateAst = template.<span class="hljs-title function_">statement</span>(templateCode)();
    <span class="hljs-keyword">const</span> { source, specifiers } = templateAst;
    <span class="hljs-keyword">const</span> needInjectSpecifiers = (<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!importElements.<span class="hljs-title function_">has</span>(source.<span class="hljs-property">value</span>)) <span class="hljs-keyword">return</span> specifiers;
      <span class="hljs-keyword">return</span> specifiers.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">specifier</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span> } = specifier;
        <span class="hljs-keyword">return</span> !importElements.<span class="hljs-title function_">get</span>(source.<span class="hljs-property">value</span>).<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)?.<span class="hljs-title function_">has</span>(specifier?.<span class="hljs-property">local</span>?.<span class="hljs-property">name</span>);
      });
    })();
    <span class="hljs-keyword">if</span> (!needInjectSpecifiers.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;
    programPath.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">unshift</span>({ ...templateAst, <span class="hljs-attr">specifiers</span>: needInjectSpecifiers });
  };
};

<span class="hljs-comment">// 跨分包引用 js 代码实现</span>
<span class="hljs-keyword">const</span> requireAsyncPackageTemplateCode = <span class="hljs-string">`promiseRetry(() =&gt; __non_webpack_require__.async(ASYNC_REQUIRE_PATH), 3, 200)`</span>;

<span class="hljs-comment">// 兜底其他渠道实现（如：支付宝小程序、抖音小程序）</span>
<span class="hljs-keyword">const</span> defaultRequireTemplateCode = <span class="hljs-string">`new Promise((resolve) =&gt; resolve(require(PACKAGE_PATH)))`</span>;

<span class="hljs-keyword">const</span> generateDefaultRequireTemplateAst = template.<span class="hljs-title function_">expression</span>(defaultRequireTemplateCode);

<span class="hljs-keyword">const</span> generateRequireAsyncPackageTemplateAst = template.<span class="hljs-title function_">expression</span>(requireAsyncPackageTemplateCode);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">requireAsyncPackageBabelTransformPlugin</span> = (<span class="hljs-params">babel, options</span>) =&gt; {
  <span class="hljs-keyword">const</span> { types } = babel;

  <span class="hljs-keyword">const</span> { asyncPackageDirPath } = options;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">visitor</span>: {
      <span class="hljs-title class_">CallExpression</span>(callExpressionPath) {
        <span class="hljs-comment">// 检查是否是 asyncRequire 调用</span>
        <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">isIdentifier</span>(callExpressionPath.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'asyncRequire'</span> })) {
          <span class="hljs-keyword">const</span> [packagePathNode] = callExpressionPath.<span class="hljs-property">node</span>.<span class="hljs-property">arguments</span>;

          <span class="hljs-keyword">const</span> isWeapp = <span class="hljs-regexp">/weapp/</span>.<span class="hljs-title function_">test</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">TARO_ENV</span>);

          <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">isStringLiteral</span>(packagePathNode) &amp;&amp; !isWeapp) {
            <span class="hljs-keyword">const</span> opt = { <span class="hljs-attr">PACKAGE_PATH</span>: packagePathNode };

            <span class="hljs-comment">// 使用模板创建新的 Promise 结构</span>
            <span class="hljs-keyword">const</span> transformedExpression = <span class="hljs-title function_">generateDefaultRequireTemplateAst</span>(opt);

            callExpressionPath.<span class="hljs-title function_">replaceWith</span>(transformedExpression);
          }

          <span class="hljs-comment">// 确保 pkgName 是一个静态字符串</span>
          <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">isStringLiteral</span>(packagePathNode) &amp;&amp; isWeapp) {
            <span class="hljs-keyword">const</span> packagePath = packagePathNode.<span class="hljs-property">value</span>;

            <span class="hljs-keyword">const</span> packageName = <span class="hljs-title function_">generateAsyncPackageName</span>(packagePath);

            <span class="hljs-keyword">const</span> asyncRequirePath = <span class="hljs-string">`<span class="hljs-subst">${asyncPackageDirPath}</span>/<span class="hljs-subst">${packageName}</span>/index.js`</span>;

            <span class="hljs-comment">// 使用模板创建新的 Promise 结构</span>
            <span class="hljs-keyword">const</span> opt = { <span class="hljs-attr">ASYNC_REQUIRE_PATH</span>: types.<span class="hljs-title function_">stringLiteral</span>(asyncRequirePath) };
            <span class="hljs-keyword">const</span> transformedExpression = <span class="hljs-title function_">generateRequireAsyncPackageTemplateAst</span>(opt);

            asyncPackagePaths.<span class="hljs-title function_">add</span>(packagePath);

            <span class="hljs-comment">// 替换原来的 asyncRequire 调用</span>
            callExpressionPath.<span class="hljs-title function_">replaceWith</span>(transformedExpression);

            <span class="hljs-comment">// 找到 Program 节点</span>
            <span class="hljs-keyword">const</span> programPath = callExpressionPath.<span class="hljs-title function_">findParent</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> types.<span class="hljs-title function_">isProgram</span>(p));

            <span class="hljs-keyword">const</span> inject = <span class="hljs-title function_">injectImport</span>(programPath);

            <span class="hljs-title function_">inject</span>(<span class="hljs-string">`import {promiseRetry} from '@/utils'`</span>);
          }
        }
      },
    },
  };
};
</code></pre>
<ol start="4">
<li>实现<code>webpack</code>插件通过<code>esbuild</code>构建异步模块输出至指定目录</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 异步化模块路径</span>
<span class="hljs-keyword">const</span> asyncPackagePaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();

<span class="hljs-comment">// 基于异步化模块文件路径生成模块编译后的分包名</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateAsyncPackageName</span> = (<span class="hljs-params">packagePath</span>) =&gt; packagePath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">'-'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncPackageBuild</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options || {};
  }

  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEmit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'AnalyzeModulesPlugin'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildAsyncPackage</span>();
    });
  }

  <span class="hljs-title function_">buildAsyncPackage</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> { outputPath, cacheFileDir } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildPackage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">packagePath</span>) =&gt; {
      <span class="hljs-keyword">const</span> contents = <span class="hljs-string">`export * from '<span class="hljs-subst">${packagePath}</span>';`</span>;
      <span class="hljs-keyword">const</span> outfile = <span class="hljs-string">`<span class="hljs-subst">${outputPath}</span>/<span class="hljs-subst">${generateAsyncPackageName(packagePath)}</span>/index.js`</span>;
      <span class="hljs-keyword">const</span> buildOpt = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateBuildOption</span>({ contents, outfile });
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">build</span>(buildOpt);
    };

    <span class="hljs-keyword">const</span> finalAsyncPackagePaths = (<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!cacheFileDir) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(asyncPackagePaths);
      <span class="hljs-keyword">const</span> cacheFileDirPath = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), cacheFileDir);
      <span class="hljs-keyword">const</span> cacheFilePath = path.<span class="hljs-title function_">join</span>(cacheFileDirPath, <span class="hljs-string">'async-package-cache.json'</span>);
      <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(cacheFileDirPath)) fs.<span class="hljs-title function_">mkdirSync</span>(cacheFileDirPath, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(cacheFilePath)) fs.<span class="hljs-title function_">writeFileSync</span>(cacheFilePath, <span class="hljs-string">'[]'</span>, <span class="hljs-string">'utf8'</span>);
      <span class="hljs-keyword">const</span> cachePaths = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(cacheFilePath, <span class="hljs-string">'utf8'</span>) || <span class="hljs-string">'[]'</span>);
      <span class="hljs-keyword">const</span> tempPaths = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(asyncPackagePaths), ...cachePaths]));
      fs.<span class="hljs-title function_">writeFileSync</span>(cacheFilePath, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(tempPaths), <span class="hljs-string">'utf8'</span>);
      <span class="hljs-keyword">return</span> tempPaths;
    })();

    finalAsyncPackagePaths.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">result, packagePath</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">buildPackage</span>(packagePath));
    }, <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>());
  }

  <span class="hljs-title function_">generateBuildOption</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-keyword">const</span> { outfile, contents } = options;
    <span class="hljs-keyword">const</span> __isDev__ = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">stdin</span>: {
        contents, <span class="hljs-comment">// 直接传递文件内容</span>
        <span class="hljs-attr">resolveDir</span>: __dirname, <span class="hljs-comment">// 设置解析目录，用于解析相对路径的导入</span>
        <span class="hljs-attr">sourcefile</span>: <span class="hljs-string">'index.ts'</span>, <span class="hljs-comment">// 虚拟文件名，方便调试</span>
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'ts'</span>, <span class="hljs-comment">// 指定内容的类型，TypeScript 需要指定为 'ts'</span>
      },
      <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
      outfile,
      <span class="hljs-attr">format</span>: <span class="hljs-string">'cjs'</span>,
      <span class="hljs-attr">target</span>: [<span class="hljs-string">'es6'</span>], <span class="hljs-comment">// 编译到 ES5</span>
      <span class="hljs-attr">drop</span>: !__isDev__ ? [<span class="hljs-string">'console'</span>, <span class="hljs-string">'debugger'</span>] : [],
      <span class="hljs-attr">minify</span>: <span class="hljs-literal">true</span>,
    };
  }
}
</code></pre>
<ol start="5">
<li>定义<code>Taro</code>插件
<ul>
<li>使用<code>AsyncPackageBuild</code>与<code>requireAsyncPackageBabelTransformPlugin</code></li>
<li>修改微信小程序配置文件，注册对应分包。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">ctx, options</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { outputDir = <span class="hljs-string">'async-packages'</span>, cacheFileDir } = options;

  <span class="hljs-keyword">const</span> outputPath = <span class="hljs-string">`<span class="hljs-subst">${ctx.paths.outputPath}</span>/<span class="hljs-subst">${outputDir}</span>`</span>;

  <span class="hljs-keyword">const</span> asyncPackageDirPath = <span class="hljs-string">`~/<span class="hljs-subst">${outputDir}</span>`</span>;

  <span class="hljs-keyword">const</span> isWeapp = <span class="hljs-regexp">/weapp/</span>.<span class="hljs-title function_">test</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">TARO_ENV</span>);

  ctx.<span class="hljs-title function_">modifyWebpackChain</span>(<span class="hljs-function">(<span class="hljs-params">{ chain }</span>) =&gt;</span> {
    <span class="hljs-comment">// eslint-disable-next-line prettier/prettier</span>
    <span class="hljs-keyword">if</span> (isWeapp) chain.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'AsyncPackageBuild'</span>).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">AsyncPackageBuild</span>, [{ outputPath, cacheFileDir }]);
    chain.<span class="hljs-property">module</span>
      .<span class="hljs-title function_">rule</span>(<span class="hljs-string">'script'</span>)
      .<span class="hljs-title function_">use</span>(<span class="hljs-string">'babelLoader'</span>)
      .<span class="hljs-title function_">tap</span>(<span class="hljs-function">(<span class="hljs-params">opts</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> pluginConfig = [requireAsyncPackageBabelTransformPlugin, { asyncPackageDirPath }];
        <span class="hljs-keyword">return</span> { ...opts, <span class="hljs-attr">plugins</span>: [pluginConfig, ...(opts.<span class="hljs-property">plugins</span> || [])] };
      })
      .<span class="hljs-title function_">end</span>();
  });

  ctx.<span class="hljs-title function_">modifyBuildAssets</span>(<span class="hljs-function">(<span class="hljs-params">{ assets }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> appJSON = assets[<span class="hljs-string">'app.json'</span>];

    <span class="hljs-keyword">if</span> (!appJSON || !isWeapp) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 读取微信小程序配置文件内容</span>
    <span class="hljs-keyword">const</span> appJSONContent = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(appJSON.<span class="hljs-title function_">source</span>());

    <span class="hljs-comment">// 生成异步分包包名</span>
    <span class="hljs-keyword">const</span> asyncPackageNames = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(asyncPackagePaths).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">asyncPackagePath</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${outputDir}</span>/<span class="hljs-subst">${generateAsyncPackageName(asyncPackagePath)}</span>`</span>;
    });

    <span class="hljs-comment">// 生成异步分包配置</span>
    <span class="hljs-keyword">const</span> asyncPackagesConfig = asyncPackageNames.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">asyncPackageName</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">root</span>: asyncPackageName, <span class="hljs-attr">pages</span>: [] };
    });

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">resolveAlias</span>: curResolveAlias = {}, <span class="hljs-attr">subpackages</span>: curSubpackages = [] } = appJSONContent;

    <span class="hljs-comment">//  设置小程序路径别名</span>
    appJSONContent.<span class="hljs-property">resolveAlias</span> = { ...curResolveAlias, <span class="hljs-string">'~/*'</span>: <span class="hljs-string">'/*'</span> };

    <span class="hljs-comment">// 注册异步加载分包</span>
    appJSONContent.<span class="hljs-property">subpackages</span> = [...curSubpackages, ...asyncPackagesConfig];

    <span class="hljs-comment">// 覆写微信小程序配置文件</span>
    assets[<span class="hljs-string">'app.json'</span>] = <span class="hljs-keyword">new</span> webpackSources.<span class="hljs-title class_">RawSource</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(appJSONContent, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  });
};

</code></pre>
<h4 data-id="heading-6">业务中使用</h4>
<p>这里使用的是由<code>@galacean/effects/weapp</code>构建的产物<code>mp-weapp-galacean-effects</code></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> id = <span class="hljs-string">'webglCanvas'</span>

<span class="hljs-keyword">const</span> systemInfo = <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">getSystemInfoSync</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Animation</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> animationRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initAnimation</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-comment">// 这里引用了npm库编译后的js文件，源自 https://www.galacean.com/effects/user/pq9u1sqdbtugp997#E9gHP</span>
    animationRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncRequire</span>(<span class="hljs-string">'@/assets/libs/mp-weapp-galacean-effects'</span>);
    <span class="hljs-comment">// ....</span>
  }

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">initAnimation</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Canvas</span>
      <span class="hljs-attr">type</span>=<span class="hljs-string">"webgl"</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">systemInfo.screenWidth</span>}`}
      <span class="hljs-attr">height</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">systemInfo.screenHeight</span>}`}
    /&gt;</span></span>
  )
};

</code></pre>
<h3 data-id="heading-7">2. 实现V2：<code>SplitChunk</code>拆分异步模块到指定分包</h3>
<p>实现V1完成了目标「能够使用<code>@galacean/effects</code>，在小程序首页展示炫酷的动画，且主包体积不能超<code>2MB</code>」</p>
<p>但目标「沉淀通用的解决方案，优化其他三方依赖或业务组件在主包中的体积占用」还存在以下问题</p>
<ul>
<li>针对组件打包如何处理样式和图片资源文件？</li>
<li>针对项目中配置的<code>babel</code>插件如何保持一致？</li>
<li>针对项目中配置的路径别名如何保持一致？</li>
</ul>
<p>能不能将项目中的相关配置在异步模块的<code>esbuild</code>编译中再配置配置一遍？当然可以，但还会产生其他问题比如：</p>
<ul>
<li>要实现与<code>webpack</code>一致的能力需要额外引入相关的<code>plugin</code>，存在较大的负担</li>
<li>不熟悉的同学增加编译相关的配置容易遗漏<code>esbuild</code>配置</li>
</ul>
<p>怎么解决这些问题？</p>
<h4 data-id="heading-8">实现思路</h4>
<ul>
<li>使用<code>import('modulePath')</code>动态引入异步模块</li>
<li>使用<code>splitChunk</code>拆分异步模块至指定分包</li>
<li>修改<code>webpack runtime</code>实现跨分包引用<code>JS</code>（webpack引入异步模块默认通过创建<code>Script</code>实现）</li>
<li>通过<code>taro</code>修改微信小程序配置文件，注册对应分包</li>
</ul>
<h4 data-id="heading-9">代码实现</h4>
<ol>
<li>修改<code>babel</code>配置
<ul>
<li><code>taro</code>默认开启<code>dynamic-import-node</code>会将异步的<code>import('path')</code>转换为同步的<code>require('path')</code></li>
<li>所以需要前置关闭，当然多渠道的话也可以做渠道区分。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// babel-preset-taro 更多选项和默认值：</span>
<span class="hljs-comment">// https://github.com/NervJS/taro/blob/next/packages/babel-preset-taro/README.md</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [
    [<span class="hljs-string">'taro'</span>, {
      <span class="hljs-attr">framework</span>: <span class="hljs-string">'react'</span>,
      <span class="hljs-attr">ts</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">loose</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">useBuiltIns</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-string">"dynamic-import-node"</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TARO_ENV</span> !== <span class="hljs-string">'weapp'</span>, <span class="hljs-comment">// 在原有基础上添加这个配置即可</span>
      <span class="hljs-attr">targets</span>: {
        <span class="hljs-attr">ios</span>: <span class="hljs-string">'9'</span>,
        <span class="hljs-attr">android</span>: <span class="hljs-string">'5'</span>,
      },
    }]
  ],
}

</code></pre>
<ol start="2">
<li>修改<code>splitChunk</code>配置
<ul>
<li>将异步模块<code>JS</code>文件拆分到指定分包。</li>
<li>由于<code>CSS</code>无法跨分包引用，故聚合异步模块<code>CSS</code>文件输出至根目录由主包引用。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IPluginContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/service'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DynamicPackOpts</span> {
  <span class="hljs-attr">dynamicModuleJsDir</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dynamicModuleStyleFile</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">dynamicPackOptsDefaultOpt</span>: <span class="hljs-title class_">DynamicPackOpts</span> = {
  <span class="hljs-attr">dynamicModuleJsDir</span>: <span class="hljs-string">'dynamic-common'</span>,
  <span class="hljs-attr">dynamicModuleStyleFile</span>: <span class="hljs-string">'dynamic-common'</span>,
};


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">IPluginContext</span>, <span class="hljs-attr">pluginOpts</span>: <span class="hljs-title class_">DynamicPackOpts</span>) =&gt; {
  <span class="hljs-keyword">const</span> finalOpts = { ...dynamicPackOptsDefaultOpt, ...pluginOpts };

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">TARO_ENV</span> !== <span class="hljs-string">'weapp'</span>) <span class="hljs-keyword">return</span>;

  ctx.<span class="hljs-title function_">modifyWebpackChain</span>(<span class="hljs-function">(<span class="hljs-params">{ chain }</span>) =&gt;</span> {
    chain.<span class="hljs-property">optimization</span>.<span class="hljs-title function_">merge</span>({
      <span class="hljs-attr">splitChunks</span>: {
        <span class="hljs-attr">cacheGroups</span>: {
          <span class="hljs-attr">common</span>: {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'common'</span>,
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">priority</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>
          },
          <span class="hljs-attr">vendors</span>: {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">test</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">resource</span>),
            <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>
          },
          [<span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>-js`</span>]: {
            <span class="hljs-attr">name</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>/<span class="hljs-subst">${<span class="hljs-variable language_">module</span>.buildInfo.hash}</span>`</span>,
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">'async'</span>,
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|jsx|ts|tsx)$/</span>,
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>
          },
          [<span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>-js-common`</span>]: {
            <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>/common`</span>,
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">'async'</span>,
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">priority</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|jsx|ts|tsx)$/</span>,
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>
          },
          [<span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleStyleFile}</span>-css`</span>]: {
            <span class="hljs-attr">name</span>: finalOpts.<span class="hljs-property">dynamicModuleStyleFile</span>,
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">'async'</span>,
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(css|less|scss|sass)$/</span>,
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>
          },
        },
      },
    });
  });
};

</code></pre>
<ol start="3">
<li>修改<code>webpack``runtime</code>实现跨分包引用<code>JS</code>实现
<ul>
<li>实现<code>webpack</code>插件，在编译产物压缩输出前进行代码转换。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CompilationAssets</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Source</span>&gt;;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Opt</span> {
  test?: <span class="hljs-title class_">RegExp</span>;
  <span class="hljs-attr">transform</span>: <span class="hljs-function">(<span class="hljs-params">code: <span class="hljs-built_in">string</span>, assets: CompilationAssets</span>) =&gt;</span> <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">'TransformBeforeCompression'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformBeforeCompression</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">opt</span>: <span class="hljs-title class_">Opt</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opt: Opt</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">opt</span> = opt;
  }

  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler: webpack.Compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation: webpack.Compilation</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> stage = webpack.<span class="hljs-property">Compilation</span>.<span class="hljs-property">PROCESS_ASSETS_STAGE_OPTIMIZE</span>; <span class="hljs-comment">// 压缩前</span>

      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tap</span>({ <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">PLUGIN_NAME</span>, stage }, <span class="hljs-function">(<span class="hljs-params">assets</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { test, transform } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">opt</span>;

        <span class="hljs-keyword">const</span> assetNames = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets);

        assetNames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">assetName</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (!test || !test.<span class="hljs-title function_">test</span>(assetName)) <span class="hljs-keyword">return</span>;

          <span class="hljs-keyword">const</span> originalSource = assets[assetName].<span class="hljs-title function_">source</span>();

          <span class="hljs-keyword">const</span> transformResult = <span class="hljs-title function_">transform</span>(originalSource <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, assets <span class="hljs-keyword">as</span> <span class="hljs-title class_">CompilationAssets</span>);

          compilation.<span class="hljs-title function_">updateAsset</span>(assetName, <span class="hljs-keyword">new</span> webpack.<span class="hljs-property">sources</span>.<span class="hljs-title class_">RawSource</span>(transformResult));
        });
      });
    });
  }
}

</code></pre>
<ul>
<li>通过<code>babel</code>实现代码转换逻辑</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodePath</span>, template } <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/core'</span>;
<span class="hljs-keyword">import</span> generator <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/generator'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> parser <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/parser'</span>;
<span class="hljs-keyword">import</span> traverse <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/traverse'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> types <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/types'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">AssignmentExpression</span>, <span class="hljs-title class_">VariableDeclarator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@babel/types'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">CompilationAssets</span>, <span class="hljs-title class_">DynamicPackOpts</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Opts</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DynamicPackOpts</span> {
  <span class="hljs-attr">assets</span>: <span class="hljs-title class_">CompilationAssets</span>;
}

<span class="hljs-keyword">const</span> webpackLoadDynamicModuleTemplateDep = <span class="hljs-string">`
  var loadedDynamicModules = {};
  var loadDynamicModule = function (dynamicModulePath) {
    var loadDynamicModuleFn = loadDynamicModuleFnMap[dynamicModulePath];
    return loadDynamicModuleFn ? loadDynamicModuleFn() : Promise.reject();
  };
  var promiseRetry = function (apply,retries = 6,delay = 500) {
    return apply().catch(function (error) {
      if (retries &lt;= 0) return Promise.reject(error);
      return new Promise(function (resolve) {
          setTimeout(resolve, delay);
       })
       .then(function () {
          return promiseRetry(apply, retries - 1, delay)
       });
    })
  }
`</span>;

<span class="hljs-keyword">const</span> webpackLoadDynamicModuleTemplate = <span class="hljs-string">`
  __webpack_require__.l = function (dynamicModulePath, done, key, chunkId) {
    if (inProgress[dynamicModulePath]) {
      inProgress[dynamicModulePath].push(done);
      return;
    }

    const target = { src: dynamicModulePath };

    if (loadedDynamicModules[dynamicModulePath]) return done({ type: 'loaded', target });

    promiseRetry(function () {
      return loadDynamicModule(dynamicModulePath)
    })
    .then(function () {
      return done({ type: 'loaded', target })
    }).catch(function () {
      return done({ type:'error', target })
    });
  };
`</span>;

<span class="hljs-comment">// eslint-disable-next-line prettier/prettier</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">replaceWebpackLoadScriptFn</span> = (<span class="hljs-params">
  assignmentExpressionNodePath: NodePath&lt;AssignmentExpression&gt;,
  opts: Opts
</span>) =&gt; {
  <span class="hljs-keyword">const</span> { left, right } = assignmentExpressionNodePath.<span class="hljs-property">node</span> || {};

  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isMemberExpression</span>(left)) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isFunctionExpression</span>(right)) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isIdentifier</span>(left.<span class="hljs-property">object</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'__webpack_require__'</span> })) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isIdentifier</span>(left.<span class="hljs-property">property</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'l'</span> })) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> isProcessed = right.<span class="hljs-property">params</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> types.<span class="hljs-title function_">isIdentifier</span>(item, { <span class="hljs-attr">name</span>: <span class="hljs-string">'dynamicModulePath'</span> });
  });

  <span class="hljs-keyword">if</span> (isProcessed) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> { assets, dynamicModuleJsDir } = opts;

  <span class="hljs-keyword">const</span> dynamicAssets = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">assetName</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`^<span class="hljs-subst">${dynamicModuleJsDir}</span>/.`</span>).<span class="hljs-title function_">test</span>(assetName);
  });

  <span class="hljs-keyword">const</span> loadDynamicModuleFnMapCode = (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> tempCode = dynamicAssets.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">dynamicAsset</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`'/<span class="hljs-subst">${dynamicAsset}</span>':function (){ return require.async('<span class="hljs-subst">${dynamicAsset}</span>'); }`</span>;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-string">`var loadDynamicModuleFnMap = {<span class="hljs-subst">${tempCode.join(<span class="hljs-string">','</span>)}</span>}`</span>;
  })();

  <span class="hljs-keyword">const</span> templateCodeAst = template.<span class="hljs-title function_">ast</span>(webpackLoadDynamicModuleTemplate);

  <span class="hljs-keyword">const</span> templateCodeDepAst = template.<span class="hljs-title function_">ast</span>(webpackLoadDynamicModuleTemplateDep);

  <span class="hljs-keyword">const</span> loadDynamicModuleFnMapAst = template.<span class="hljs-title function_">ast</span>(loadDynamicModuleFnMapCode);

  assignmentExpressionNodePath.<span class="hljs-title function_">replaceWith</span>(templateCodeAst <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);

  assignmentExpressionNodePath.<span class="hljs-title function_">insertBefore</span>(templateCodeDepAst);

  assignmentExpressionNodePath.<span class="hljs-title function_">insertBefore</span>(loadDynamicModuleFnMapAst);
};

<span class="hljs-keyword">const</span> webpackLoadDynamicModuleStylesheetTemplate = <span class="hljs-string">`
loadStylesheet = function () {
  return Promise.resolve()
}
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">replaceLoadStylesheetFn</span> = (<span class="hljs-params">nodePath: NodePath&lt;VariableDeclarator&gt;</span>) =&gt; {
  <span class="hljs-keyword">const</span> { id, init } = nodePath.<span class="hljs-property">node</span> || {};
  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isIdentifier</span>(id, { <span class="hljs-attr">name</span>: <span class="hljs-string">'loadStylesheet'</span> })) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isFunctionExpression</span>(init)) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> isProcessed = !init.<span class="hljs-property">params</span>.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (isProcessed) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> templateCodeAst = template.<span class="hljs-title function_">expression</span>(webpackLoadDynamicModuleStylesheetTemplate)();
  nodePath.<span class="hljs-title function_">replaceWith</span>(templateCodeAst);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeCreateStylesheetFn</span> = (<span class="hljs-params">nodePath: NodePath&lt;VariableDeclarator&gt;</span>) =&gt; {
  <span class="hljs-keyword">const</span> { id } = nodePath.<span class="hljs-property">node</span> || {};
  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isIdentifier</span>(id, { <span class="hljs-attr">name</span>: <span class="hljs-string">'createStylesheet'</span> })) <span class="hljs-keyword">return</span>;
  nodePath.<span class="hljs-title function_">remove</span>();
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeFindStylesheetFn</span> = (<span class="hljs-params">nodePath: NodePath&lt;VariableDeclarator&gt;</span>) =&gt; {
  <span class="hljs-keyword">const</span> { id } = nodePath.<span class="hljs-property">node</span> || {};
  <span class="hljs-keyword">if</span> (!types.<span class="hljs-title function_">isIdentifier</span>(id, { <span class="hljs-attr">name</span>: <span class="hljs-string">'findStylesheet'</span> })) <span class="hljs-keyword">return</span>;
  nodePath.<span class="hljs-title function_">remove</span>();
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">replaceWebpackRuntime</span> = (<span class="hljs-params">code: <span class="hljs-built_in">string</span>, opts: Opts</span>) =&gt; {
  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(code); <span class="hljs-comment">// 将代码解析为 AST</span>
  <span class="hljs-title function_">traverse</span>(ast, {
    <span class="hljs-title class_">AssignmentExpression</span>: <span class="hljs-function">(<span class="hljs-params">nodePath: NodePath&lt;AssignmentExpression&gt;</span>) =&gt;</span> {
      <span class="hljs-title function_">replaceWebpackLoadScriptFn</span>(nodePath, opts);
    },
    <span class="hljs-title class_">VariableDeclarator</span>(<span class="hljs-attr">nodePath</span>: <span class="hljs-title class_">NodePath</span>&lt;<span class="hljs-title class_">VariableDeclarator</span>&gt;) {
      <span class="hljs-title function_">replaceLoadStylesheetFn</span>(nodePath);
      <span class="hljs-title function_">removeCreateStylesheetFn</span>(nodePath);
      <span class="hljs-title function_">removeFindStylesheetFn</span>(nodePath);
    },
  });
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">generator</span>(ast).<span class="hljs-property">code</span>;
};

</code></pre>
<ol start="4">
<li>插入异步模块样式文件至主包样式文件中</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Opt</span> {
  test?: <span class="hljs-title class_">RegExp</span>;
  styleSheetPath?: <span class="hljs-built_in">string</span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">'RequireStylesheet'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequireStylesheet</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">opt</span>: <span class="hljs-title class_">Opt</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">opt: Opt</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">opt</span> = opt;
  }
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler: webpack.Compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation: webpack.Compilation</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> stage = webpack.<span class="hljs-property">Compilation</span>.<span class="hljs-property">PROCESS_ASSETS_STAGE_OPTIMIZE</span>; <span class="hljs-comment">// 压缩前</span>

      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tap</span>({ <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">PLUGIN_NAME</span>, stage }, <span class="hljs-function">(<span class="hljs-params">assets</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { test, styleSheetPath } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">opt</span>;

        <span class="hljs-keyword">const</span> assetNames = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets);

        assetNames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">assetName</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (!test || !styleSheetPath || !test.<span class="hljs-title function_">test</span>(assetName)) <span class="hljs-keyword">return</span>;

          <span class="hljs-keyword">const</span> originalSource = assets[assetName].<span class="hljs-title function_">source</span>();

          <span class="hljs-keyword">const</span> transformResult = (originalSource <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>).<span class="hljs-title function_">concat</span>(<span class="hljs-string">`@import '<span class="hljs-subst">${styleSheetPath}</span>';`</span>);

          compilation.<span class="hljs-title function_">updateAsset</span>(assetName, <span class="hljs-keyword">new</span> webpack.<span class="hljs-property">sources</span>.<span class="hljs-title class_">RawSource</span>(transformResult));
        });
      });
    });
  }
}

</code></pre>
<ol start="5">
<li>定义<code>Taro</code>插件
<ul>
<li>使用<code>RequireStylesheet</code>、<code>TransformBeforeCompression</code>与<code>replaceWebpackRuntime</code></li>
<li>修改微信小程序配置文件，注册对应分包。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IPluginContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RawSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-sources'</span>;
<span class="hljs-keyword">import</span> { replaceWebpackRuntime } <span class="hljs-keyword">from</span> <span class="hljs-string">'./replace-webpack-runtime'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RequireStylesheet</span>, <span class="hljs-variable constant_">PLUGIN_NAME</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequireStylesheetPluginName</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./require-stylesheet'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransformBeforeCompression</span>, <span class="hljs-variable constant_">PLUGIN_NAME</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">TransformBeforeCompressionPluginName</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transform-before-compression'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DynamicPackOpts</span> {
  <span class="hljs-attr">dynamicModuleJsDir</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dynamicModuleStyleFile</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">dynamicPackOptsDefaultOpt</span>: <span class="hljs-title class_">DynamicPackOpts</span> = {
  <span class="hljs-attr">dynamicModuleJsDir</span>: <span class="hljs-string">'dynamic-common'</span>,
  <span class="hljs-attr">dynamicModuleStyleFile</span>: <span class="hljs-string">'dynamic-common'</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">IPluginContext</span>, <span class="hljs-attr">pluginOpts</span>: <span class="hljs-title class_">DynamicPackOpts</span>) =&gt; {
  <span class="hljs-keyword">const</span> finalOpts = { ...dynamicPackOptsDefaultOpt, ...pluginOpts };

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">TARO_ENV</span> !== <span class="hljs-string">'weapp'</span>) <span class="hljs-keyword">return</span>;

  ctx.<span class="hljs-title function_">modifyWebpackChain</span>(<span class="hljs-function">(<span class="hljs-params">{ chain }</span>) =&gt;</span> {
    chain.<span class="hljs-title function_">plugin</span>(<span class="hljs-title class_">TransformBeforeCompressionPluginName</span>).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">TransformBeforeCompression</span>, [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/^runtime\.js$/</span>,
        <span class="hljs-attr">transform</span>: <span class="hljs-function">(<span class="hljs-params">code, assets</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">replaceWebpackRuntime</span>(code, { ...finalOpts, assets });
        },
      },
    ]);
    chain.<span class="hljs-title function_">plugin</span>(<span class="hljs-title class_">RequireStylesheetPluginName</span>).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">RequireStylesheet</span>, [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/^app.wxss$/</span>,
        <span class="hljs-attr">styleSheetPath</span>: <span class="hljs-string">`./<span class="hljs-subst">${finalOpts.dynamicModuleStyleFile}</span>.wxss`</span>,
      },
    ]);
  });

  ctx.<span class="hljs-title function_">modifyBuildAssets</span>(<span class="hljs-function">(<span class="hljs-params">{ assets }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> curAppJSON = assets[<span class="hljs-string">'app.json'</span>];

    <span class="hljs-keyword">if</span> (!curAppJSON) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> curAppJSONContent = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(curAppJSON.<span class="hljs-title function_">source</span>());

    <span class="hljs-keyword">const</span> dynamicPackagesConfig = { <span class="hljs-attr">root</span>: finalOpts.<span class="hljs-property">dynamicModuleJsDir</span>, <span class="hljs-attr">pages</span>: [] };

    <span class="hljs-keyword">const</span> { resolveAlias = {}, subpackages = [] } = curAppJSONContent;

    <span class="hljs-keyword">const</span> newAppJSONContent = {
      ...curAppJSONContent,
      <span class="hljs-attr">subpackages</span>: [...subpackages, dynamicPackagesConfig],
      <span class="hljs-attr">resolveAlias</span>: {
        ...resolveAlias,
        [<span class="hljs-string">`<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>/*`</span>]: <span class="hljs-string">`/<span class="hljs-subst">${finalOpts.dynamicModuleJsDir}</span>/*`</span>,
      },
    };

    assets[<span class="hljs-string">'app.json'</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSource</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newAppJSONContent, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  });
};

</code></pre>
<h4 data-id="heading-10">业务中使用</h4>
<p><strong>组件分包异步化</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, <span class="hljs-title class_">ComponentType</span>, <span class="hljs-title class_">ComponentProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">OrigingComponentPropsType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./origin-component'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">OrigingComponentPropsType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./origin-component'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-keyword">async</span> ()=&gt;{
  <span class="hljs-keyword">const</span> tempRes = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./origin-component'</span>)
  <span class="hljs-keyword">return</span> {<span class="hljs-attr">default</span>:tempRes.<span class="hljs-property">OrigingComponent</span>}
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">OrigingComponentPropsType</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>)=&gt;</span>{
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{null}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> {<span class="hljs-attr">...props</span>}/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>函数分包异步化</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">()=&gt;</span>{
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>)=&gt;{
      <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./fn'</span>)
      <span class="hljs-title function_">fn</span>()
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>click<span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
}
</code></pre>
<h2 data-id="heading-11">四、总结</h2>
<p>成功塞下<code>@galacean/effects</code>，在小程序首页为用户展示了炫酷的会员体系升级动画。完结撒花🎉🎉🎉🎉。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaea1e1763bf45f9bb64b10afc5f5e53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6IyX5YmN56uv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1753646549&amp;x-signature=%2BTh5%2Fx85xivQzWwG7ENMGX5ME1Q%3D" width="320px" loading="lazy"></div></div>