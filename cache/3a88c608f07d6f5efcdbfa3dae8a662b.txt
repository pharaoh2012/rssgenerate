
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/BNTang/p/18974289" title="å‘å¸ƒäº 2025-07-09 09:10">
    <span role="heading" aria-level="2">Spring AI å®ç°è®©ä½ çš„ AI â€œä¸‰æ€è€Œåè¡Œâ€</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>ä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼šç²¾å¿ƒè®¾è®¡çš„ AI åº”ç”¨ï¼Œåœ¨é¢å¯¹ç¨å¾®å¤æ‚ç‚¹çš„é—®é¢˜æ—¶ï¼Œç»™å‡ºçš„ç­”æ¡ˆå´é©´å”‡ä¸å¯¹é©¬å˜´ï¼Ÿæ„Ÿè§‰å®ƒå¥½åƒâ€œçœ‹äº†ä¸€çœ¼å°±ç­”â€ï¼Œæ ¹æœ¬æ²¡ä»”ç»†â€œé˜…è¯»ç†è§£â€ã€‚</p>
<p>åˆ«æ€¥ï¼Œä»Šå¤©å°±ä¸ºä½ ä»‹ç»ä¸€ä¸ªèƒ½æ˜¾è‘—æå‡å¤§æ¨¡å‹æ¨ç†èƒ½åŠ›çš„æŠ€å·§â€”â€”<strong>Re-Readingï¼ˆé‡è¯»ï¼‰</strong>ï¼Œç®€ç§° <strong>Re2</strong>ã€‚è¿™ä¸ªæ–¹æ³•æœ‰ <a href="https://arxiv.org/pdf/2309.06275" target="_blank" rel="noopener nofollow">è®ºæ–‡</a> èƒŒä¹¦ï¼Œæ•ˆæœæ˜¾è‘—ã€‚</p>
<p>æ›´æ£’çš„æ˜¯ï¼Œåœ¨ Spring AI ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>Advisorï¼ˆé¡¾é—®ï¼‰</strong> æ¨¡å¼ï¼Œä¼˜é›…åœ°å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œè®©ä½ çš„ AI åœ¨å›ç­”å‰çœŸæ­£åšåˆ°â€œä¸‰æ€è€Œåè¡Œâ€ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-re-reading-re2">ä»€ä¹ˆæ˜¯ Re-Reading (Re2)ï¼Ÿ</h2>
<p>Re2 çš„åŸç†å‡ºå¥‡åœ°ç®€å•ï¼š<strong>è®©æ¨¡å‹æŠŠé—®é¢˜å†è¯»ä¸€é</strong>ã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦å°†ç”¨æˆ·çš„åŸå§‹é—®é¢˜ï¼ˆ<code>{Input_Query}</code>ï¼‰é€šè¿‡ Prompt æ”¹é€ ä¸ºä»¥ä¸‹æ ¼å¼ï¼š</p>
<pre><code class="language-java">{Input_Query}
Read the question again: {Input_Query}
</code></pre>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¼ºåˆ¶æ¨¡å‹åœ¨ç”Ÿæˆç­”æ¡ˆå‰é‡æ–°å®¡è§†é—®é¢˜ï¼Œä»è€Œæœ‰æ•ˆå‡å°‘è¯¯è§£ï¼Œæé«˜å¤æ‚æ¨ç†ä»»åŠ¡çš„å‡†ç¡®ç‡ã€‚</p>
<p>ğŸ’¡ <strong>å‹æƒ…æç¤º</strong>ï¼šè¿™ç§æ–¹æ³•è™½ç„¶èƒ½æå‡æ•ˆæœï¼Œä½†å› ä¸ºè¾“å…¥é•¿åº¦ç¿»å€ï¼ŒAPI è°ƒç”¨æˆæœ¬ä¹Ÿä¼šéšä¹‹ç¿»å€ã€‚å› æ­¤ï¼Œåœ¨é¢å‘ C ç«¯çš„ã€æˆæœ¬æ•æ„Ÿçš„åº”ç”¨ä¸­è¯·è°¨æ…ä½¿ç”¨ï¼</p>
<h2 id="æ„å»ºä½ çš„-re2-advisor">æ„å»ºä½ çš„ Re2 Advisor</h2>
<p>åœ¨ Spring AI ä¸­ï¼Œ<code>Advisor</code> æ˜¯ä¸€ç§ AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ€æƒ³çš„ä½“ç°ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸ä¾µå…¥æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„æƒ…å†µä¸‹ï¼Œå¯¹ AI çš„è¯·æ±‚å’Œå“åº”è¿›è¡Œæ‹¦æˆªå’Œå¢å¼ºã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ª <code>ReReadingAdvisor</code>ï¼Œå®ƒä¼šæ‹¦æˆªç”¨æˆ·è¯·æ±‚å¹¶è‡ªåŠ¨åº”ç”¨ Re2 æ¨¡å¼ã€‚</p>
<pre><code class="language-java">/**
 * @author BNTang
 * @version 1.0
 * @description è‡ªå®šä¹‰ Re2 Advisorï¼Œé€šè¿‡è®©æ¨¡å‹é‡è¯»é—®é¢˜æ¥æé«˜å…¶æ¨ç†èƒ½åŠ›ã€‚
 **/
public class ReReadingAdvisor implements CallAroundAdvisor, StreamAroundAdvisor {

    /**
     * åœ¨ AI è°ƒç”¨å‰æ‰§è¡Œï¼Œè´Ÿè´£æ”¹å†™ç”¨æˆ·è¯·æ±‚ã€‚
     *
     * @param advisedRequest åŸå§‹è¯·æ±‚
     * @return åº”ç”¨äº† Re2 æ¨¡å¼çš„æ–°è¯·æ±‚
     */
    private AdvisedRequest before(AdvisedRequest advisedRequest) {
        // å°†åŸå§‹æŸ¥è¯¢å­˜å…¥å‚æ•°ï¼Œä»¥ä¾¿åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
        Map&lt;String, Object&gt; advisedUserParams = new HashMap&lt;&gt;(advisedRequest.userParams());
        advisedUserParams.put("re2_input_query", advisedRequest.userText());

        // ä½¿ç”¨æ–°æ¨¡æ¿æ„å»ºå¹¶è¿”å› AdvisedRequest
        return AdvisedRequest.from(advisedRequest)
                .userText("""
                        {re2_input_query}
                        Read the question again: {re2_input_query}
                        """)
                .userParams(advisedUserParams)
                .build();
    }

    /**
     * ç¯ç»•å¤„ç†éæµå¼è°ƒç”¨ã€‚
     */
    @NotNull
    @Override
    public AdvisedResponse aroundCall(@NotNull AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
        // è°ƒç”¨ before æ–¹æ³•ä¿®æ”¹è¯·æ±‚ï¼Œç„¶åä¼ é€’ç»™è°ƒç”¨é“¾çš„ä¸‹ä¸€ä¸ªç¯èŠ‚
        return chain.nextAroundCall(this.before(advisedRequest));
    }

    /**
     * ç¯ç»•å¤„ç†æµå¼è°ƒç”¨ã€‚
     */
    @NotNull
    @Override
    public Flux&lt;AdvisedResponse&gt; aroundStream(@NotNull AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
        // åŒæ ·ï¼Œè°ƒç”¨ before æ–¹æ³•ä¿®æ”¹è¯·æ±‚ï¼Œç„¶åä¼ é€’ç»™è°ƒç”¨é“¾
        return chain.nextAroundStream(this.before(advisedRequest));
    }

    /**
     * è¿”å› Advisor çš„åç§°ã€‚
     */
    @NotNull
    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    /**
     * å®šä¹‰ Advisor çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
     */
    @Override
    public int getOrder() {
        return 0; // è®¾ç½®ä¸ºé«˜ä¼˜å…ˆçº§
    }
}
</code></pre>
<h2 id="å³æ’å³ç”¨åœ¨-chatclient-ä¸­å¯ç”¨-advisor">å³æ’å³ç”¨ï¼šåœ¨ ChatClient ä¸­å¯ç”¨ Advisor</h2>
<p>Advisor å†™å¥½äº†ï¼Œç”¨èµ·æ¥ä¹Ÿéå¸¸ç®€å•ã€‚åªéœ€åœ¨æ„å»º <code>ChatClient</code> æ—¶ï¼Œé€šè¿‡ <code>.defaultAdvisors()</code> æ–¹æ³•å°†å…¶åŠ å…¥å³å¯ã€‚</p>
<pre><code class="language-java">/**
 * App æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–èŠå¤©å®¢æˆ·ç«¯ã€‚
 *
 * @param ollamaChatModel èŠå¤©æ¨¡å‹å®ä¾‹
 */
public App(ChatModel ollamaChatModel) {
    ChatMemory chatMemory = new InMemoryChatMemory();
    chatClient = ChatClient.builder(ollamaChatModel)
            .defaultSystem(SYSTEM_PROMPT)
            .defaultAdvisors(
                    new MessageChatMemoryAdvisor(chatMemory), // è®°å¿†é¡¾é—®
                    new ReReadingAdvisor() // å¯ç”¨ Re-Reading é¡¾é—®ï¼
            )
            .build();
}
</code></pre>
<p>ç°åœ¨ï¼Œæ‰€æœ‰é€šè¿‡è¿™ä¸ª <code>chatClient</code> å‘å‡ºçš„è¯·æ±‚ï¼Œéƒ½ä¼šè‡ªåŠ¨è¢« <code>ReReadingAdvisor</code> å¤„ç†ï¼Œå®ç°æ¨ç†å¢å¼ºï¼Œè€Œæˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç æ— éœ€åšä»»ä½•æ”¹åŠ¨ã€‚æ˜¯ä¸æ˜¯éå¸¸ä¼˜é›…ï¼Ÿ</p>
<h2 id="advisor-æœ€ä½³å®è·µæ¸…å•">Advisor æœ€ä½³å®è·µæ¸…å•</h2>
<p>ä¸ºäº†è®©ä½ æ›´å¥½åœ°é©¾é©­ <code>Advisor</code>ï¼Œè¿™é‡Œæ€»ç»“äº†å‡ ä¸ªæœ€ä½³å®è·µï¼š</p>
<ol>
<li><strong>ä¿æŒå•ä¸€èŒè´£</strong>ï¼šæ¯ä¸ª Advisor åº”è¯¥åªåšä¸€ä»¶äº‹ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç¼“å­˜ã€é‡è¯•æˆ–åƒæˆ‘ä»¬ä»Šå¤©çš„ Re2ã€‚</li>
<li><strong>æ³¨æ„æ‰§è¡Œé¡ºåº</strong>ï¼šé€šè¿‡ <code>getOrder()</code> æ§åˆ¶ Advisor çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®ã€‚</li>
<li><strong>å…¼å®¹æµå¼ä¸éæµå¼</strong>ï¼šå°½å¯èƒ½åŒæ—¶å®ç° <code>CallAroundAdvisor</code> å’Œ <code>StreamAroundAdvisor</code> æ¥å£ï¼Œè®©ä½ çš„ Advisor æ›´é€šç”¨ã€‚</li>
<li><strong>ä¿æŒé«˜æ•ˆ</strong>ï¼šé¿å…åœ¨ Advisor ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œä»¥å…é˜»å¡æ•´ä¸ªè°ƒç”¨é“¾ã€‚</li>
<li><strong>å……åˆ†æµ‹è¯•</strong>ï¼šç‰¹åˆ«æ˜¯è¾¹ç•Œæƒ…å†µï¼Œç¡®ä¿ Advisor çš„å¥å£®æ€§ã€‚</li>
<li><strong>å–„ç”¨ Reactorï¼ˆè¿›é˜¶ï¼‰</strong>ï¼šå¯¹äºå¤æ‚çš„æµå¼å¤„ç†ï¼Œå¯ä»¥åˆ©ç”¨ <code>Reactor</code> çš„æ“ä½œç¬¦è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚</li>
</ol>
<pre><code class="language-java">@Override
public Flux&lt;AdvisedResponse&gt; aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
    return Mono.just(advisedRequest)
            .publishOn(Schedulers.boundedElastic())
            .map(this::modifyRequest) // è¯·æ±‚å‰å¤„ç†
            .flatMapMany(chain::nextAroundStream)
            .map(this::modifyResponse); // å“åº”åå¤„ç†
}
</code></pre>
<ol start="7">
<li><strong>å…±äº«çŠ¶æ€ï¼ˆè¿›é˜¶ï¼‰</strong>ï¼šä½¿ç”¨ <code>advisedRequest.updateContext()</code> å’Œ <code>advisedResponse.adviseContext()</code> åœ¨ Advisor é“¾ä¸­ä¼ é€’çŠ¶æ€ã€‚</li>
</ol>
<pre><code class="language-java">// åœ¨ Advisor A ä¸­æ›´æ–°ä¸Šä¸‹æ–‡
advisedRequest = advisedRequest.updateContext(context -&gt; {
context.put("my_key", "my_value");
return context;
});

// åœ¨ Advisor B ä¸­è¯»å–ä¸Šä¸‹æ–‡
Object value = advisedResponse.adviseContext().get("my_key");
</code></pre>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-09 09:11">2025-07-09 09:10</span>&nbsp;
<a href="https://www.cnblogs.com/BNTang">BNTang</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18974289);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18974289', targetLink: 'https://www.cnblogs.com/BNTang/p/18974289', title: 'Spring AI å®ç°è®©ä½ çš„ AI â€œä¸‰æ€è€Œåè¡Œâ€' })">ä¸¾æŠ¥</a>
</div>
        