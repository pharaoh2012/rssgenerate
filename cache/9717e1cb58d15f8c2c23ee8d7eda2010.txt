<!----> <meta itemprop="headline" content="åœ¨çº¿äººæ•°å®æ—¶æ¨é€ï¼ŸWebSocket å¤ªé‡ï¼ŒSSE æ­£åˆé€‚ ğŸ¯ğŸ¯ğŸ¯"> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,é¢è¯•"> <meta itemprop="datePublished" content="2025-04-14T06:23:02.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-61fb5e44="">
            åœ¨çº¿äººæ•°å®æ—¶æ¨é€ï¼ŸWebSocket å¤ªé‡ï¼ŒSSE æ­£åˆé€‚ ğŸ¯ğŸ¯ğŸ¯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-04-14T06:23:02.000Z" title="Mon Apr 14 2025 06:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-04-14
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""></circle></svg> <span class="views-count" data-v-61fb5e44="">
                    8,864
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""></path></svg>
                    é˜…è¯»9åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""></div> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2Fzh" target="_blank" title="https://www.codecrack.cn/zh" ref="nofollow noopener noreferrer">é¢è¯•å¯¼èˆª</a> æ˜¯ä¸€ä¸ªä¸“æ³¨äºå‰ã€åç«¯æŠ€æœ¯å­¦ä¹ å’Œé¢è¯•å‡†å¤‡çš„ <strong>å…è´¹</strong> å­¦ä¹ å¹³å°ï¼Œæä¾›ç³»ç»ŸåŒ–çš„æŠ€æœ¯æ ˆå­¦ä¹ ï¼Œæ·±å…¥è®²è§£æ¯ä¸ªçŸ¥è¯†ç‚¹çš„æ ¸å¿ƒåŸç†ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå…¨é¢çš„æŠ€æœ¯ä½“ç³»ã€‚å¹³å°è¿˜æ”¶å½•äº†å¤§é‡çœŸå®çš„æ ¡æ‹›ä¸ç¤¾æ‹›é¢ç»ï¼Œå¸®åŠ©ä½ å¿«é€ŸæŒæ¡é¢è¯•æŠ€å·§ï¼Œæå‡æ±‚èŒç«äº‰åŠ›ã€‚å¦‚æœä½ æƒ³åŠ å…¥æˆ‘ä»¬çš„äº¤æµç¾¤ï¼Œæ¬¢è¿é€šè¿‡å¾®ä¿¡è”ç³»ï¼š<code>yunmz777</code>ã€‚</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5522900b291a4882a6030709227b4267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1752440549&amp;x-signature=x2MEopKT4GsWI%2FhdCBdCKn6v8Bw%3D" alt="20250310220634" loading="lazy"></p>
<p>æœ‰äº›é¡¹ç›®è¦ç»Ÿè®¡åœ¨çº¿äººæ•°ï¼Œå…¶å®æ›´å¤šæ˜¯ä¸ºäº†â€œè¥é€ çƒ­é—¹æ°”æ°›â€ã€‚æ¯”å¦‚ä½ è¿›ä¸ªèŠå¤©å®¤ï¼Œçœ‹åˆ°â€œæœ‰ 120 äººåœ¨çœ‹â€ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è¿™ä¸ªåœ°æ–¹æŒºæ´»è·ƒçš„ï¼Ÿè¿™å°±æ˜¯ä¸€ç§â€œç¤¾äº¤è¯æ˜â€ï¼Œè®©ç”¨æˆ·è§‰å¾—ï¼šå“‡ï¼Œè¿™ä¸ªåœ°æ–¹æŒºç«ï¼Œå€¼å¾—ç•™ä¸‹æ¥ã€‚è€Œä¸”å¯¹äº§å“æ¥è¯´ï¼Œè¿™ä¹Ÿèƒ½æé«˜ç”¨æˆ·çš„å‚ä¸æ„Ÿå’Œç²˜æ€§ã€‚</p>
<h2 data-id="heading-0">æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Ÿä¸ºå•¥æˆ‘æœ€åé€‰äº† SSEï¼Ÿ</h2>
<p>åœ¨è€ƒè™‘æ€ä¹ˆå®ç°â€œç»Ÿè®¡åœ¨çº¿äººæ•°å¹¶å®æ—¶æ˜¾ç¤ºâ€è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œå…¶å®æˆ‘ä¸€å¼€å§‹ä¹Ÿæ²¡ç›´æ¥æƒ³åˆ°è¦ç”¨ SSEã€‚æ¯•ç«Ÿå®ç°æ–¹å¼æœ‰å¥½å‡ ç§ï¼Œå’±ä»¬ä¸å¦¨ä¸€æ­¥æ­¥åˆ†æä¸€ä¸‹å¸¸è§çš„å‡ ç§åšæ³•ï¼Œçœ‹çœ‹å®ƒä»¬å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œè¿™æ ·æœ€åä¸ºå•¥é€‰ SSEï¼Œè‡ªç„¶å°±æ°´è½çŸ³å‡ºäº†ã€‚</p>
<h3 data-id="heading-1">âŒ ç¬¬ä¸€ç§æƒ³æ³•ï¼šè½®è¯¢ï¼ˆPollingï¼‰</h3>
<p>æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹å¼å°±æ˜¯ï¼š<strong>æˆ‘å®šæ—¶å»é—®æœåŠ¡å™¨ï¼Œâ€œç°åœ¨æœ‰å¤šå°‘äººåœ¨çº¿ï¼Ÿâ€</strong><br>
æ¯”å¦‚ç”¨ <code>setInterval</code> æ¯éš” 3 ç§’å‘ä¸€æ¬¡ AJAX è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›ä¸€ä¸ªæ•°å­—ï¼Œå‰ç«¯æ‹¿åˆ°ä¹‹åæ›´æ–°é¡µé¢ã€‚</p>
<p>å¬èµ·æ¥æ²¡æ¯›ç—…ï¼Œå¯¹å§ï¼Ÿç¡®å®ç®€å•ï¼Œå†™å‡ è¡Œä»£ç å°±èƒ½è·‘èµ·æ¥ã€‚</p>
<p>ä½†é—®é¢˜ä¹Ÿå¾ˆå¿«æš´éœ²äº†ï¼š</p>
<ul>
<li>
<p>å°±ç®—åœ¨çº¿äººæ•° 10 åˆ†é’Ÿéƒ½æ²¡å˜ï¼Œå®¢æˆ·ç«¯ä¹Ÿåœ¨ä¸€ç›´è¯·æ±‚ï¼Œå®Œå…¨æ²¡å¿…è¦ï¼Œ<strong>éå¸¸ä½æ•ˆ</strong></p>
</li>
<li>
<p>è¿™ç§æ–¹å¼æ ¹æœ¬åšä¸åˆ°çœŸæ­£çš„â€œå®æ—¶â€ï¼Œé™¤éä½ æ¯ç§’é’Ÿè¯·æ±‚ä¸€æ¬¡ï¼ˆä½†é‚£æ ·æœåŠ¡å™¨å‹åŠ›å°±çˆ†ç‚¸äº†ï¼‰</p>
</li>
<li>
<p>æ¯ä¸ªç”¨æˆ·éƒ½å‘è¯·æ±‚ï¼Œè¿™å‹åŠ›ä¸æ˜¯ä¹˜ä»¥ç”¨æˆ·æ•°ä¹ˆï¼Ÿäººä¸€å¤šï¼ŒæœåŠ¡å™¨ç›´æ¥â€œå˜å¡â€</p>
</li>
</ul>
<p>æ‰€ä»¥è½®è¯¢è™½ç„¶ç®€å•ï¼Œä½†åœ¨â€œå®æ—¶åœ¨çº¿äººæ•°â€è¿™ç§åœºæ™¯ä¸‹ï¼Œ<strong>ä¸ç®¡æ€§èƒ½ã€å®æ—¶æ€§è¿˜æ˜¯ç”¨æˆ·ä½“éªŒï¼Œéƒ½ä¸å¤Ÿç†æƒ³</strong>ã€‚</p>
<h3 data-id="heading-2">âŒ ç¬¬äºŒç§æ–¹æ¡ˆï¼šWebSocket</h3>
<p>å†å¾€ä¸Šä¸€ä¸ªå±‚çº§ï¼Œå¾ˆå¤šäººå°±ä¼šæƒ³åˆ° <strong>WebSocket</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥å®ç°åŒå‘é€šä¿¡çš„æŠ€æœ¯ï¼Œå¬èµ·æ¥éå¸¸é«˜çº§ã€‚</p>
<p>ç¡®å®ï¼ŒWebSocket ç‰¹åˆ«é€‚åˆ<strong>èŠå¤©å®¤ã€æ¸¸æˆã€ååŒç¼–è¾‘å™¨</strong>è¿™ç§å®æ—¶äº’åŠ¨åœºæ™¯â€”â€”å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éšæ—¶å¯ä»¥äº’ç›¸å‘æ¶ˆæ¯ï¼Œæ•ˆç‡é«˜ã€å»¶è¿Ÿä½ã€‚</p>
<p>ä½†é—®é¢˜ä¹Ÿæ¥äº†ï¼š<strong>æˆ‘ä»¬çœŸçš„éœ€è¦é‚£ä¹ˆé‡çš„æ­¦å™¨å—ï¼Ÿ</strong></p>
<ul>
<li>
<p>æˆ‘åªæ˜¯è¦æœåŠ¡å™¨æŠŠâ€œå½“å‰åœ¨çº¿äººæ•°â€è¿™ä¸ªæ•°å­—å‘ç»™é¡µé¢ï¼Œ<strong>ä¸éœ€è¦å®¢æˆ·ç«¯å‘ä»€ä¹ˆæ¶ˆæ¯å›å»</strong></p>
</li>
<li>
<p>WebSocket çš„è¿æ¥ã€å¿ƒè·³ã€æ–­çº¿é‡è¿ã€èµ„æºç®¡ç†â€¦â€¦è¿™å¥—æœºåˆ¶ç¡®å®å¼ºå¤§ï¼Œä½†åŒæ—¶ä¹Ÿè®©å¼€å‘å¤æ‚åº¦å’ŒæœåŠ¡å™¨èµ„æºå ç”¨éƒ½æé«˜äº†ä¸å°‘</p>
</li>
<li>
<p>è€Œä¸”ä½ è¦éƒ¨ç½² WebSocket æœåŠ¡çš„è¯ï¼Œå¾ˆå¤šæ—¶å€™è¿˜å¾—è€ƒè™‘åå‘ä»£ç†æ”¯æŒã€è·¨åŸŸã€åè®®å‡çº§ç­‰é—®é¢˜</p>
</li>
</ul>
<p>æ€»ç»“ä¸€å¥è¯ï¼š<strong>WebSocket èƒ½å¹²çš„æ´»å¤ªå¤šï¼Œåè€Œä¸é€‚åˆå¹²è¿™ä¹ˆç®€å•çš„ä¸€ä»¶äº‹</strong>ã€‚</p>
<h3 data-id="heading-3">âœ… æœ€åé€‰æ‹©ï¼šSSEï¼ˆServer-Sent Eventsï¼‰</h3>
<p>ç„¶åæˆ‘å°±æƒ³åˆ°äº† SSEã€‚</p>
<p>SSE æ˜¯ HTML5 æä¾›çš„ä¸€ä¸ªéå¸¸é€‚åˆâ€œæœåŠ¡ç«¯å•å‘æ¨é€æ¶ˆæ¯â€çš„æ–¹æ¡ˆï¼Œæµè§ˆå™¨ç”¨ <code>EventSource</code> è¿™ä¸ªå¯¹è±¡å°±èƒ½è½»æ¾å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡ç«¯åªéœ€è¦æŒ‰ç…§ç‰¹å®šæ ¼å¼å¾€å®¢æˆ·ç«¯å†™æ•°æ®å°±èƒ½å®æ—¶æ¨é€ï¼Œéå¸¸ç®€å•ã€éå¸¸è½»é‡ã€‚</p>
<p>å¯¹äºâ€œç»Ÿè®¡åœ¨çº¿äººæ•°â€è¿™ç§åœºæ™¯æ¥è¯´ï¼Œå®ƒåˆšå¥½æ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼š</p>
<ul>
<li>
<p>å®¢æˆ·ç«¯ä¸éœ€è¦å‘æ¶ˆæ¯ï¼Œåªè¦èƒ½â€œå¬æ¶ˆæ¯â€å°±å¤Ÿäº† â€”â€” SSE å°±æ˜¯åªè¯»çš„æ¨é€æµï¼Œæ­£åˆé€‚</p>
</li>
<li>
<p>æˆ‘åªéœ€è¦æœåŠ¡ç«¯ä¸€æœ‰å˜åŒ–ï¼ˆæ¯”å¦‚æŸä¸ªç”¨æˆ·æ–­å¼€è¿æ¥ï¼‰ï¼Œå°±é€šçŸ¥æ‰€æœ‰äººå½“å‰åœ¨çº¿äººæ•°æ˜¯å¤šå°‘ â€”â€” SSE çš„å¹¿æ’­æœºåˆ¶å°±å¾ˆå¥½å®ç°è¿™ä¸€ç‚¹</p>
</li>
<li>
<p>è€Œä¸”æµè§ˆå™¨æ–­çº¿åä¼šè‡ªåŠ¨é‡è¿ï¼Œ<strong>ä½ ä¸éœ€è¦å†™é¢å¤–çš„å¿ƒè·³æˆ–è€…é‡è¿é€»è¾‘ï¼Œç›´æ¥çˆ½ç”¨</strong></p>
</li>
<li>
<p>å®ƒç”¨çš„æ˜¯æ™®é€šçš„ HTTP åè®®ï¼Œéƒ¨ç½²å’Œ Nginx é…åˆä¹Ÿæ²¡å•¥é—®é¢˜</p>
</li>
</ul>
<p>å½“ç„¶å®ƒä¹Ÿä¸æ˜¯æ²¡æœ‰ç¼ºç‚¹ï¼Œæ¯”å¦‚ IE ä¸æ”¯æŒï¼ˆä½†ç°åœ¨è°è¿˜ç”¨ IE å•Šï¼‰ï¼Œä»¥åŠå®ƒæ˜¯å•å‘é€šä¿¡ï¼ˆä¸è¿‡æˆ‘ä»¬å‹æ ¹ä¹Ÿä¸éœ€è¦åŒå‘ï¼‰ã€‚</p>
<p>æ‰€ä»¥ç»¼åˆæ¥çœ‹ï¼Œ<strong>SSE å°±æ˜¯è¿™ä¸ªåŠŸèƒ½çš„â€œåˆšåˆšå¥½â€æ–¹æ¡ˆï¼šè½»é‡ã€ç®€å•ã€ç¨³å®šã€è¶³å¤Ÿç”¨ã€‚</strong></p>
<h2 data-id="heading-4">é¡¹ç›®å®æˆ˜</h2>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆè´´ä¸Šåç«¯çš„ä»£ç ï¼Œåç«¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ NextJs æä¾›çš„ API æ¥å®ç°çš„åç«¯æ¥å£ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„è¾…åŠ©æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// å•ä¾‹æ¨¡å¼å®ç°çš„åœ¨çº¿ç”¨æˆ·è®¡æ•°å™¨</span>
<span class="hljs-comment">// ä½¿ç”¨Symbolç¡®ä¿ç§æœ‰å±æ€§</span>
<span class="hljs-keyword">const</span> _connections = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"connections"</span>);
<span class="hljs-keyword">const</span> _clients = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"clients"</span>);
<span class="hljs-keyword">const</span> _lastCleanup = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"lastCleanup"</span>);
<span class="hljs-keyword">const</span> _maxInactiveTime = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"maxInactiveTime"</span>);
<span class="hljs-keyword">const</span> _connectionTimes = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"connectionTimes"</span>);

<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå•ä¾‹è®¡æ•°å™¨</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionCounter</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">ConnectionCounter</span>;
  <span class="hljs-keyword">private</span> [_connections]: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> [_clients]: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">(<span class="hljs-params">count: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">private</span> [_lastCleanup]: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// é»˜è®¤10åˆ†é’Ÿæœªæ´»åŠ¨çš„è¿æ¥å°†è¢«æ¸…ç†</span>
  <span class="hljs-keyword">private</span> [_maxInactiveTime]: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
  <span class="hljs-comment">// è·Ÿè¸ªè¿æ¥IDå’Œå®ƒä»¬çš„æœ€åæ´»åŠ¨æ—¶é—´</span>
  <span class="hljs-keyword">private</span> [_connectionTimes]: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// é˜²æ­¢å¤–éƒ¨ç›´æ¥å®ä¾‹åŒ–</span>
  }

  <span class="hljs-comment">// è·å–å•ä¾‹å®ä¾‹</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">ConnectionCounter</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">ConnectionCounter</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-title class_">ConnectionCounter</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionCounter</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ConnectionCounter</span>.<span class="hljs-property">instance</span>;
  }

  <span class="hljs-comment">// ç”Ÿæˆå”¯ä¸€è¿æ¥ID</span>
  <span class="hljs-title function_">generateConnectionId</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>);
  }

  <span class="hljs-comment">// æ·»åŠ æ–°è¿æ¥</span>
  <span class="hljs-title function_">addConnection</span>(<span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">set</span>(connectionId, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    <span class="hljs-variable language_">this</span>[_connections]++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">broadcastCount</span>();

    <span class="hljs-comment">// å¦‚æœæ´»è·ƒè¿æ¥è¶…è¿‡100æˆ–ä¸Šæ¬¡æ¸…ç†å·²ç»è¶…è¿‡5åˆ†é’Ÿï¼Œæ‰§è¡Œæ¸…ç†</span>
    <span class="hljs-keyword">if</span> (
      <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-property">size</span> &gt; <span class="hljs-number">100</span> ||
      <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>[_lastCleanup] &gt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
    ) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupStaleConnections</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[_connections];
  }

  <span class="hljs-comment">// ç§»é™¤è¿æ¥</span>
  <span class="hljs-title function_">removeConnection</span>(<span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-comment">// å¦‚æœè¿æ¥IDå­˜åœ¨åˆ™ç§»é™¤</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">has</span>(connectionId)) {
      <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">delete</span>(connectionId);
      <span class="hljs-variable language_">this</span>[_connections] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>[_connections] - <span class="hljs-number">1</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">broadcastCount</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[_connections];
  }

  <span class="hljs-comment">// æ›´æ–°è¿æ¥çš„æ´»åŠ¨æ—¶é—´</span>
  <span class="hljs-title function_">updateConnectionActivity</span>(<span class="hljs-attr">connectionId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">has</span>(connectionId)) {
      <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">set</span>(connectionId, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    }
  }

  <span class="hljs-comment">// æ¸…ç†é•¿æ—¶é—´ä¸æ´»è·ƒçš„è¿æ¥</span>
  <span class="hljs-title function_">cleanupStaleConnections</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>[_lastCleanup] = now;

    <span class="hljs-keyword">let</span> removedCount = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">lastActive, connectionId</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (now - lastActive &gt; <span class="hljs-variable language_">this</span>[_maxInactiveTime]) {
        <span class="hljs-variable language_">this</span>[_connectionTimes].<span class="hljs-title function_">delete</span>(connectionId);
        removedCount++;
      }
    });

    <span class="hljs-keyword">if</span> (removedCount &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>[_connections] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>[_connections] - removedCount);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">broadcastCount</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cleaned up <span class="hljs-subst">${removedCount}</span> stale connections`</span>);
    }
  }

  <span class="hljs-comment">// è·å–å½“å‰è¿æ¥æ•°</span>
  <span class="hljs-title function_">getConnectionCount</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[_connections];
  }

  <span class="hljs-comment">// è®¢é˜…è®¡æ•°æ›´æ–°</span>
  <span class="hljs-title function_">subscribeToUpdates</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">count: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>[_clients].<span class="hljs-title function_">add</span>(callback);
    <span class="hljs-comment">// ç«‹å³è¿”å›å½“å‰è®¡æ•°</span>
    <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>[_connections]);

    <span class="hljs-comment">// è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>[_clients].<span class="hljs-title function_">delete</span>(callback);
    };
  }

  <span class="hljs-comment">// å¹¿æ’­è®¡æ•°æ›´æ–°åˆ°æ‰€æœ‰å®¢æˆ·ç«¯</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">broadcastCount</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>[_clients].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>[_connections]);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// å¦‚æœå›è°ƒå¤±è´¥ï¼Œä»é›†åˆä¸­ç§»é™¤</span>
        <span class="hljs-variable language_">this</span>[_clients].<span class="hljs-title function_">delete</span>(callback);
      }
    });
  }
}

<span class="hljs-comment">// å¯¼å‡ºä¾¿æ·å‡½æ•°</span>
<span class="hljs-keyword">const</span> counter = <span class="hljs-title class_">ConnectionCounter</span>.<span class="hljs-title function_">getInstance</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> connectionId = counter.<span class="hljs-title function_">generateConnectionId</span>();
  counter.<span class="hljs-title function_">addConnection</span>(connectionId);
  <span class="hljs-keyword">return</span> connectionId;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeConnection</span>(<span class="hljs-params">connectionId: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> counter.<span class="hljs-title function_">removeConnection</span>(connectionId);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">pingConnection</span>(<span class="hljs-params">connectionId: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  counter.<span class="hljs-title function_">updateConnectionActivity</span>(connectionId);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getConnectionCount</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> counter.<span class="hljs-title function_">getConnectionCount</span>();
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribeToCountUpdates</span>(<span class="hljs-params">
  callback: (count: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">void</span>
</span>): <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">return</span> counter.<span class="hljs-title function_">subscribeToUpdates</span>(callback);
}

<span class="hljs-comment">// å¯¼å‡ºå®ä¾‹ä¾›ç›´æ¥ä½¿ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> connectionCounter = counter;
</code></pre>
<p>è¿™æ®µä»£ç å…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹ï¼š<strong>ç»Ÿè®¡å½“å‰æœ‰å¤šå°‘ä¸ªç”¨æˆ·åœ¨çº¿</strong>ï¼Œè€Œä¸”å¯ä»¥<strong>å®æ—¶æ¨é€åˆ°å‰ç«¯</strong>ã€‚æˆ‘ä»¬ç”¨äº†ä¸€ä¸ªâ€œå•ä¾‹â€æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªæœåŠ¡é‡Œåªæœ‰ä¸€ä¸ª <code>ConnectionCounter</code> å®ä¾‹ï¼Œé¿å…å¤šäººè¿æ¥æ—¶å‡ºç°æ•°æ®é”™ä¹±ã€‚æ¯å½“æœ‰æ–°ç”¨æˆ·è¿ä¸Š SSE çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„è¿æ¥ IDï¼Œç„¶åè°ƒç”¨ <code>createConnection()</code> æŠŠå®ƒåŠ è¿›æ¥ï¼Œåœ¨çº¿äººæ•°å°± +1ã€‚</p>
<p>è¿™äº›è¿æ¥ ID éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œè¿˜ä¼šè®°ä½â€œæœ€åæ´»è·ƒæ—¶é—´â€ã€‚å¦‚æœç”¨æˆ·ä¸€ç›´åœ¨çº¿ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‰ç«¯å‘ä¸ªå¿ƒè·³ï¼ˆ<code>pingConnection()</code>ï¼‰æ¥å‘Šè¯‰åç«¯â€œæˆ‘è¿˜åœ¨å“¦â€ã€‚æ–­å¼€è¿æ¥çš„æ—¶å€™ï¼ˆæ¯”å¦‚ç”¨æˆ·å…³é—­äº†é¡µé¢ï¼‰ï¼Œæˆ‘ä»¬å°±é€šè¿‡ <code>closeConnection()</code> æŠŠå®ƒç§»é™¤ï¼Œäººæ•°å°± -1ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢æœ‰äº›ç”¨æˆ·æ²¡æ­£å¸¸æ–­å¼€ï¼ˆæ¯”å¦‚çªç„¶å…³æœºäº†ï¼‰ï¼Œä»£ç é‡Œè¿˜æœ‰ä¸€ä¸ªâ€œè‡ªåŠ¨æ¸…ç†æœºåˆ¶â€ï¼Œé»˜è®¤ 10 åˆ†é’Ÿæ²¡åŠ¨é™çš„è¿æ¥å°±ä¼šè¢«æ¸…ç†æ‰ã€‚æ¯æ¬¡äººæ•°å˜åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªè®¡æ•°å™¨ä¼šâ€œå¹¿æ’­â€ä¸€ä¸‹ï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…å®ƒçš„äººè¯´ï¼šâ€œå˜¿ï¼Œåœ¨çº¿äººæ•°å˜å•¦ï¼â€</p>
<p>è€Œè¿™ä¸ªè®¢é˜…æœºåˆ¶ï¼ˆ<code>subscribeToCountUpdates()</code>ï¼‰ç‰¹åˆ«å…³é”®â€”â€”å®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨ SSE é‡Œå®æ—¶æ¨é€äººæ•°æ›´æ–°ï¼Œå‰ç«¯åªè¦ç›‘å¬ç€ï¼Œå°±èƒ½ç¬¬ä¸€æ—¶é—´çœ‹åˆ°æœ€æ–°çš„åœ¨çº¿äººæ•°ã€‚æˆ‘ä»¬è¿˜æŠŠå¸¸ç”¨çš„æ“ä½œéƒ½å°è£…å¥½äº†ï¼Œæ¯”å¦‚ <code>createConnection()</code>ã€<code>getConnectionCount()</code> ç­‰ï¼Œè®©æ•´ä¸ªæµç¨‹ç‰¹åˆ«å®¹æ˜“é›†æˆã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼šè¿™æ®µé€»è¾‘å°±æ˜¯ <strong>è‡ªåŠ¨ç»Ÿè®¡åœ¨çº¿äººæ•° + è‡ªåŠ¨æ¸…ç†æ— æ•ˆè¿æ¥ + å®æ—¶æ¨é€æ›´æ–°</strong></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™åç«¯ SSE æ¥å£ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {
  createConnection,
  closeConnection,
  pingConnection,
  subscribeToCountUpdates,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"./counter"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// æ ‡è®°è¿æ¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ</span>
  <span class="hljs-keyword">let</span> connectionClosed = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// ä¸ºæ­¤è¿æ¥ç”Ÿæˆå”¯ä¸€ID</span>
  <span class="hljs-keyword">const</span> connectionId = <span class="hljs-title function_">createConnection</span>();

  <span class="hljs-comment">// å½“å‰è¿æ¥çš„è®¡æ•°æ›´æ–°å›è°ƒ</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">countUpdateUnsubscribe</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// ä½¿ç”¨Next.jsçš„æµå¼å“åº”å¤„ç†</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadableStream</span>({
      <span class="hljs-title function_">start</span>(<span class="hljs-params">controller</span>) {
        <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();

        <span class="hljs-comment">// å®‰å…¨å‘é€æ•°æ®å‡½æ•°</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">safeEnqueue</span> = (<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt; {
          <span class="hljs-keyword">if</span> (connectionClosed) <span class="hljs-keyword">return</span>;
          <span class="hljs-keyword">try</span> {
            controller.<span class="hljs-title function_">enqueue</span>(encoder.<span class="hljs-title function_">encode</span>(data));
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SSEå‘é€é”™è¯¯:"</span>, error);
            connectionClosed = <span class="hljs-literal">true</span>;
            <span class="hljs-title function_">cleanup</span>();
          }
        };

        <span class="hljs-comment">// å®šä¹‰intervalå¼•ç”¨</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">heartbeatInterval</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">let</span> <span class="hljs-attr">activityPingInterval</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// è®¢é˜…åœ¨çº¿ç”¨æˆ·è®¡æ•°æ›´æ–°</span>
        countUpdateUnsubscribe = <span class="hljs-title function_">subscribeToCountUpdates</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (!connectionClosed) {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-title function_">safeEnqueue</span>(
                <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ onlineUsers: count })}</span>\n\n`</span>
              );
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"å‘é€åœ¨çº¿ç”¨æˆ·æ•°æ®é”™è¯¯:"</span>, error);
            }
          }
        });

        <span class="hljs-comment">// æ¸…ç†æ‰€æœ‰èµ„æº</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanup</span> = (<span class="hljs-params"></span>) =&gt; {
          <span class="hljs-keyword">if</span> (heartbeatInterval) <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
          <span class="hljs-keyword">if</span> (activityPingInterval) <span class="hljs-built_in">clearInterval</span>(activityPingInterval);

          <span class="hljs-comment">// å–æ¶ˆè®¢é˜…è®¡æ•°æ›´æ–°</span>
          <span class="hljs-keyword">if</span> (countUpdateUnsubscribe) {
            <span class="hljs-title function_">countUpdateUnsubscribe</span>();
            countUpdateUnsubscribe = <span class="hljs-literal">null</span>;
          }

          <span class="hljs-comment">// å¦‚æœè¿æ¥å°šæœªè®¡æ•°ä¸ºå…³é—­ï¼Œåˆ™å‡å°‘è¿æ¥è®¡æ•°</span>
          <span class="hljs-keyword">if</span> (!connectionClosed) {
            <span class="hljs-title function_">closeConnection</span>(connectionId);
            connectionClosed = <span class="hljs-literal">true</span>;
          }

          <span class="hljs-comment">// å°è¯•å®‰å…¨å…³é—­æ§åˆ¶å™¨</span>
          <span class="hljs-keyword">try</span> {
            controller.<span class="hljs-title function_">close</span>();
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// å¿½ç•¥å…³é—­æ—¶çš„é”™è¯¯</span>
          }
        };

        <span class="hljs-comment">// è®¾ç½®15ç§’çš„å¿ƒè·³é—´éš”ï¼Œé¿å…è¿æ¥è¶…æ—¶</span>
        heartbeatInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (connectionClosed) {
            <span class="hljs-title function_">cleanup</span>();
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-title function_">safeEnqueue</span>(<span class="hljs-string">": heartbeat\n\n"</span>);
        }, <span class="hljs-number">15000</span>);

        <span class="hljs-comment">// æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è¿æ¥æ´»åŠ¨æ—¶é—´</span>
        activityPingInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (connectionClosed) {
            <span class="hljs-title function_">cleanup</span>();
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-title function_">pingConnection</span>(connectionId);
        }, <span class="hljs-number">60000</span>);
      },
      <span class="hljs-title function_">cancel</span>(<span class="hljs-params"></span>) {
        <span class="hljs-comment">// å½“æµè¢«å–æ¶ˆæ—¶è°ƒç”¨ï¼ˆå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼‰</span>
        <span class="hljs-keyword">if</span> (!connectionClosed) {
          <span class="hljs-title function_">closeConnection</span>(connectionId);
          connectionClosed = <span class="hljs-literal">true</span>;

          <span class="hljs-keyword">if</span> (countUpdateUnsubscribe) {
            <span class="hljs-title function_">countUpdateUnsubscribe</span>();
          }
        }
      },
    }),
    {
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream"</span>,
        <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache, no-transform"</span>,
        <span class="hljs-title class_">Connection</span>: <span class="hljs-string">"keep-alive"</span>,
        <span class="hljs-string">"Access-Control-Allow-Origin"</span>: <span class="hljs-string">"*"</span>,
        <span class="hljs-string">"X-Accel-Buffering"</span>: <span class="hljs-string">"no"</span>, <span class="hljs-comment">// é€‚ç”¨äºæŸäº›ä»£ç†æœåŠ¡å™¨å¦‚Nginx</span>
      },
    }
  );
}
</code></pre>
<p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ª Next.js çš„ API è·¯ç”±ï¼Œç”¨æ¥å»ºç«‹ä¸€ä¸ª <strong>SSE é•¿è¿æ¥</strong>ï¼Œå¹¶æŠŠâ€œå½“å‰åœ¨çº¿äººæ•°â€<strong>å®æ—¶æ¨é€ç»™å®¢æˆ·ç«¯</strong>ã€‚</p>
<p>ç¬¬ä¸€æ­¥å°±æ˜¯å»ºç«‹è¿æ¥å¹¶æ³¨å†Œè®¡æ•°å½“å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œåç«¯ä¼šï¼š</p>
<ul>
<li>è°ƒç”¨ <code>createConnection()</code> ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„è¿æ¥ IDï¼›</li>
<li>æŠŠè¿™æ¬¡è¿æ¥è®¡å…¥åœ¨çº¿ç”¨æˆ·æ€»æ•°é‡Œï¼›</li>
<li>å¹¶è¿”å›ä¸€ä¸ª <code>ReadableStream</code>ï¼Œè®©æœåŠ¡ç«¯èƒ½ä¸æ–­å¾€å®¢æˆ·ç«¯â€œæ¨é€æ¶ˆæ¯â€ã€‚</li>
</ul>
<p>ç¬¬äºŒæ­¥å°±æ˜¯è®¢é˜…åœ¨çº¿äººæ•°å˜åŒ–ï¼Œä¸€æ—¦è¿æ¥å»ºç«‹ï¼ŒæœåŠ¡ç«¯å°±è°ƒç”¨ <code>subscribeToCountUpdates()</code>ï¼Œè®¢é˜…åœ¨çº¿äººæ•°çš„å˜åŒ–ã€‚ä¸€æ—¦æ€»äººæ•°å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå°±ä¼šé€šè¿‡ SSE æ¨é€è¿™æ ·çš„æ•°æ®ç»™å‰ç«¯ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">data</span>: {
  <span class="hljs-attr">onlineUsers</span>: <span class="hljs-number">23</span>;
}
</code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æ¯æ¬¡æœ‰äººè¿ä¸Šæˆ–æ–­å¼€ï¼Œæ‰€æœ‰å‰ç«¯éƒ½ä¼šæ”¶åˆ°æ›´æ–°</strong>ï¼Œéå¸¸é€‚åˆâ€œåœ¨çº¿äººæ•°å±•ç¤ºâ€ã€‚</p>
<p>ç¬¬ä¸‰æ­¥å°±æ˜¯å®šæœŸå¿ƒè·³å’Œæ´»è·ƒæ£€æµ‹ï¼š</p>
<ul>
<li>
<p>æ¯ 15 ç§’æœåŠ¡ç«¯ä¼šå‘ä¸€ä¸ª <code>: heartbeat</code>ï¼Œä¿æŒè¿æ¥ä¸æ–­å¼€ï¼›</p>
</li>
<li>
<p>æ¯ 60 ç§’è°ƒç”¨ <code>pingConnection()</code>ï¼Œå‘Šè¯‰åå°â€œæˆ‘è¿˜æ´»ç€â€ï¼Œé˜²æ­¢è¢«è¯¯åˆ¤ä¸ºä¸æ´»è·ƒè¿æ¥è€Œæ¸…ç†ã€‚</p>
</li>
</ul>
<p>ç¬¬å››æ­¥æ˜¯æ¸…ç†é€»è¾‘ï¼Œå½“è¿æ¥è¢«å–æ¶ˆï¼ˆæ¯”å¦‚ç”¨æˆ·å…³é—­é¡µé¢ï¼‰æˆ–å‡ºé”™æ—¶ï¼Œåå°ä¼šï¼š</p>
<ul>
<li>
<p>è°ƒç”¨ <code>closeConnection()</code> æŠŠè¿™æ¡è¿æ¥ä»ç»Ÿè®¡ä¸­ç§»é™¤ï¼›</p>
</li>
<li>
<p>å–æ¶ˆæ‰åœ¨çº¿äººæ•°çš„è®¢é˜…ï¼›</p>
</li>
<li>
<p>åœæ‰å¿ƒè·³å’Œæ´»è·ƒæ£€æµ‹å®šæ—¶å™¨ï¼›</p>
</li>
<li>
<p>å®‰å…¨å…³é—­è¿™ä¸ªæ•°æ®æµã€‚</p>
</li>
</ul>
<p>è¿™ä¸ªæ¸…ç†é€»è¾‘ä¿è¯äº†<strong>æ•°æ®å‡†ç¡®ã€èµ„æºä¸æµªè´¹</strong>ï¼Œä¸ä¼šå‡ºç°â€œäººæ•°ä¸å‡â€æˆ–â€œå†…å­˜æ³„éœ²â€ã€‚</p>
<p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œè¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„â€œ<strong>è°è¿æ¥æˆ‘å°±+1ï¼Œè°æ–­å¼€æˆ‘å°±-1ï¼Œç„¶åå®æ—¶å¹¿æ’­å½“å‰åœ¨çº¿äººæ•°</strong>â€çš„æœºåˆ¶ã€‚ä½ åªè¦åœ¨å‰ç«¯ç”¨ <code>EventSource</code> æ¥æ”¶è¿™æ¡ SSE æµï¼Œå°±èƒ½çœ‹åˆ°ç”¨æˆ·æ•°é‡å®æ—¶è·³åŠ¨ï¼Œéå¸¸é€‚åˆç”¨åœ¨èŠå¤©å®¤ã€æ§åˆ¶å°ã€ç›´æ’­é¡µé¢ç­‰åœºæ™¯ã€‚</p>
<p>ç›®å‰åç«¯ä»£ç æˆ‘ä»¬æ˜¯ç¼–å†™å®Œæˆäº†ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå‰ç«¯é¡µé¢æ¥å®ç°è¿™ä¸ªåŠŸèƒ½æ¥å¯¹æ¥è¿™ä¸ªæ¥å£ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-string">"use client"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">OnlineCounter</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [onlineUsers, setOnlineUsers] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [connected, setConnected] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> eventSourceRef = useRef&lt;<span class="hljs-title class_">EventSource</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// åˆ›å»ºSSEè¿æ¥</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">connectSSE</span> = (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-keyword">if</span> (eventSourceRef.<span class="hljs-property">current</span>) {
        eventSourceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">close</span>();
      }

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">`/api/sse?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>);
        eventSourceRef.<span class="hljs-property">current</span> = eventSource;

        eventSource.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">true</span>);
        };

        eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);
            <span class="hljs-comment">// åªå¤„ç†åœ¨çº¿ç”¨æˆ·æ•°</span>
            <span class="hljs-keyword">if</span> (data.<span class="hljs-property">onlineUsers</span> !== <span class="hljs-literal">undefined</span>) {
              <span class="hljs-title function_">setOnlineUsers</span>(data.<span class="hljs-property">onlineUsers</span>);
            }
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"è§£ææ•°æ®å¤±è´¥:"</span>, error);
          }
        };

        eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SSEè¿æ¥é”™è¯¯:"</span>, error);
          <span class="hljs-title function_">setConnected</span>(<span class="hljs-literal">false</span>);
          eventSource.<span class="hljs-title function_">close</span>();

          <span class="hljs-comment">// 5ç§’åå°è¯•é‡æ–°è¿æ¥</span>
          <span class="hljs-built_in">setTimeout</span>(connectSSE, <span class="hljs-number">5000</span>);
        };
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"åˆ›å»ºSSEè¿æ¥å¤±è´¥:"</span>, error);
        <span class="hljs-built_in">setTimeout</span>(connectSSE, <span class="hljs-number">5000</span>);
      }
    };

    <span class="hljs-title function_">connectSSE</span>();

    <span class="hljs-comment">// ç»„ä»¶å¸è½½æ—¶æ¸…ç†</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (eventSourceRef.<span class="hljs-property">current</span>) {
        eventSourceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">close</span>();
      }
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-4"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-slate-800 rounded-xl shadow-2xl overflow-hidden max-w-sm w-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-6"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-3xl font-bold text-center text-blue-400 mb-6"</span>&gt;</span>
            åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
          <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center mb-4"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">h-3</span> <span class="hljs-attr">w-3</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">mr-2</span> ${
                <span class="hljs-attr">connected</span> ? "<span class="hljs-attr">bg-green-500</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">bg-red-500</span>"
              }`}
            &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm text-slate-300"</span>&gt;</span>
              {connected ? "å·²è¿æ¥" : "è¿æ¥æ–­å¼€"}
            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center bg-slate-700 rounded-lg p-8 mt-4"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col items-center"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-6xl font-bold text-green-400 mb-2"</span>&gt;</span>
                {onlineUsers}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">svg</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"w-5 h-5 text-green-400 mr-2"</span>
                  <span class="hljs-attr">fill</span>=<span class="hljs-string">"currentColor"</span>
                  <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 20 20"</span>
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-medium text-green-300"</span>&gt;</span>
                  åœ¨çº¿ç”¨æˆ·
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>æœ€ç»ˆè¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/092f763c07ee4ad7a8cd750f803fdec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1752440549&amp;x-signature=hJSP5ssBoiWlbOIYLWbj07G0Mrs%3D" alt="20250414134818" loading="lazy"></p>
<h2 data-id="heading-5">æ€»ç»“</h2>
<p>SSE å®ç°åœ¨çº¿äººæ•°ç»Ÿè®¡å¯ä»¥è¯´æ˜¯<strong>ç®€å•é«˜æ•ˆåˆåˆšåˆšå¥½</strong>çš„é€‰æ‹©ï¼šå®ƒæ”¯æŒæœåŠ¡ç«¯å•å‘æ¨é€ï¼Œå®¢æˆ·ç«¯åªç”¨ç›‘å¬å°±èƒ½å®æ—¶è·å–åœ¨çº¿äººæ•°æ›´æ–°ï¼Œä¸ç”¨è‡ªå·±è½®è¯¢ã€‚ç›¸æ¯” WebSocket æ¥è¯´ï¼ŒSSE æ›´è½»é‡ï¼Œéƒ¨ç½²èµ·æ¥ä¹Ÿæ›´æ–¹ä¾¿ã€‚æˆ‘ä»¬è¿˜é€šè¿‡å¿ƒè·³æœºåˆ¶å’Œæ´»è·ƒæ—¶é—´ç®¡ç†ï¼Œä¿è¯äº†æ•°æ®å‡†ç¡®ã€è¿æ¥ç¨³å®šã€‚æ•´ä½“æ¥è¯´ï¼Œ<strong>åŠŸèƒ½å¯¹å¾—ä¸Šï¼Œæ€§èƒ½æ‰›å¾—ä½ï¼Œä»£ç å†™èµ·æ¥ä¹Ÿä¸è´¹åŠ²</strong>ï¼Œæ˜¯éå¸¸é€‚åˆè¿™ä¸ªåœºæ™¯çš„ä¸€ç§å®ç°æ–¹å¼ã€‚</p>





































<table><thead><tr><th>æŠ€æœ¯æ–¹å¼</th><th>å®æ—¶æ€§</th><th>å®ç°éš¾åº¦</th><th>æ€§èƒ½æ¶ˆè€—</th><th>é€‚ä¸é€‚åˆè¿™ä¸ªåŠŸèƒ½</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td><strong>è½®è¯¢</strong></td><td>â˜…â˜…â˜†â˜†â˜†</td><td>â˜…â˜†â˜†â˜†â˜†ï¼ˆæœ€ç®€å•ï¼‰</td><td>â˜…â˜†â˜†â˜†â˜†ï¼ˆæµªè´¹ï¼‰</td><td>âŒ ä¸æ¨è</td><td>å¤ªä½æ•ˆäº†</td></tr><tr><td><strong>WebSocket</strong></td><td>â˜…â˜…â˜…â˜…â˜…</td><td>â˜…â˜…â˜…â˜…â˜†ï¼ˆè¾ƒå¤æ‚ï¼‰</td><td>â˜…â˜…â˜…â˜†â˜†ï¼ˆé‡å‹ï¼‰</td><td>âŒ ä¸åˆé€‚</td><td>å¤ªå¼ºå¤§ã€å¤ªå¤æ‚</td></tr><tr><td><strong>SSE</strong></td><td>â˜…â˜…â˜…â˜…â˜†</td><td>â˜…â˜…â˜†â˜†â˜†ï¼ˆéå¸¸å®¹æ˜“ä¸Šæ‰‹ï¼‰</td><td>â˜…â˜…â˜…â˜…â˜†ï¼ˆè½»é‡ï¼‰</td><td>âœ… éå¸¸é€‚åˆ</td><td>ç®€å•å¥½ç”¨åˆé«˜æ•ˆ</td></tr></tbody></table></div></div>