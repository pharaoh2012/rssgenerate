
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/shuinanxun/p/18712586" title="发布于 2025-02-13 10:24">
    <span role="heading" aria-level="2">解决微信小程序原生云开发退款报错“特约子商户商户号未授权服务商的产品权限”的问题</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p data-track="1">背景：微信小程序云开发支付没问题，退款时就会报这个错。</p>
<p data-track="2">现象：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-axegupay5k/b7c408b2796442b69c46edb40d472d7b~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=U4SioQIJA5thR0rWga2zOjhOoOc%3D" width="650" height="270" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-axegupay5k/b7c408b2796442b69c46edb40d472d7b~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=U4SioQIJA5thR0rWga2zOjhOoOc%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="3">解决方法流程：</p>
<p data-track="4">1、打开微信小程序开发者工具上面的云开发界面：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/550e9ba8736f4c0cbea76b267b1bc5c2~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=beEr2roSpglkgLARuWlLguXIJMI%3D" width="598" height="255" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/550e9ba8736f4c0cbea76b267b1bc5c2~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=beEr2roSpglkgLARuWlLguXIJMI%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="5">2、进入设置：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/a0884dd9870e4588b036d128850452cd~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=SR9TrkCrtqMqeWVbF95%2BoBdk%2FFU%3D" width="1032" height="338" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/a0884dd9870e4588b036d128850452cd~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=SR9TrkCrtqMqeWVbF95%2BoBdk%2FFU%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="6">3、其他设置：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/2799ea98b3e84e029e39fd257788cf63~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=7QKkTRMgepQDFfDRXZnwjCUSOXI%3D" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/2799ea98b3e84e029e39fd257788cf63~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=7QKkTRMgepQDFfDRXZnwjCUSOXI%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="7">需要授权退款API权限，我这里已经授权了，未授权的话会有授权按钮，点击后会提示等待商户审核</p>
<p data-track="8">4、我们来到微信支付商户后台：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/a4120005f0224d399c055a18b4d32e38~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=ajuOdXvH6Ypdxk8qFKYs72lxiB8%3D" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/a4120005f0224d399c055a18b4d32e38~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=ajuOdXvH6Ypdxk8qFKYs72lxiB8%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="9">授权后就可以使用退款的API了。</p>
<p data-track="10">最后补一下退款的官方文档和我的传参：</p>
<p data-track="11">文档：<br>https://developers.weixin.qq.com/minigame/dev/wxcloud/reference-sdk-api/open/pay/CloudPay.refund.html</p>
<p data-track="12">参数最关键的是要记录下来商户订单号，这个商户订单号是在发起支付时我们自己生成的，在我们自己的系统内保持唯一即可。</p>
<p data-track="13">我的参数：</p>
<div class="cnblogs_Highlighter">
<pre class="brush:javascript;gutter:true;">let cloud = cloudBase.getCloud();
let refund_fee_type = 1; // 金额单位为分 1就是退款1分钱 100就是退款1块钱
const refund_params = {
  functionName: 'mcloud', // 这个函数名自己系统内的
  envId: config.CLOUD_ID, // 环境id
  sub_mch_id: config.SUBMCH_ID, // 子商户id 下面有说明在哪获取
  nonce_str: this.generateRandomString(), // 这里自己生成一个随机数就行，生成随机数的方法我下面也会提供
  out_trade_no: order.out_trade_no, // 支付时自己系统生成的商户订单号，需要在支付的时候存到订单表里，然后退款时从订单表里取出这个字段
  out_refund_no: this.generateRandomString(), // 商户退款单号，也是自己随机生成一个就行，用来查询退款情况用，比如退款成功还是失败
  total_fee: refund_fee_type, // 订单金额 单位：分
  refund_fee: refund_fee_type, // 申请退款金额，用户实际到账的金额 单位：分
  refund_desc: "手动取消",// 退款理由，界面显示效果如下
}
const res = await cloud.cloudPay.refund(refund_params);
</pre>
</div>
<p>　　</p>
<p data-track="28">envId在微信小程序点开云开发就能看到：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/0b0a2675447b43b1916f8090652310a9~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=RDznQFuYO4DuBbgoA54CADqkygg%3D" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/0b0a2675447b43b1916f8090652310a9~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=RDznQFuYO4DuBbgoA54CADqkygg%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="29">sub_mch_id也是在微信小程序云开发查看，依次点开云开发、设置、其他设置：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/cddf990995f54763ac393a7c0d6d248c~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=VupYJOBetn9KZ4vJdWQ5u%2BVgydI%3D" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/cddf990995f54763ac393a7c0d6d248c~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=VupYJOBetn9KZ4vJdWQ5u%2BVgydI%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="30">生成随机数的函数：</p>
<div class="cnblogs_Highlighter">
<pre class="brush:javascript;gutter:true;">generateRandomString(length = 32) {
  let result = '';
  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const charactersLength = characters.length;
  for (let i = 0; i &lt; length; i++) {
  	result += characters.charAt(Math.floor(Math.random() * charactersLength));
  }
  return result;
}
</pre>
</div>
<p>　　</p>
<p data-track="40">退款理由的界面显示效果：</p>
<div class="pgc-img"><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/343e4334c7fa429db545dd85061c1c06~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=kZLBPrU613u3J101720ME3axLN0%3D" width="670" height="717" class="syl-page-img" data-src="https://p3-sign.toutiaoimg.com/tos-cn-i-6w9my0ksvp/343e4334c7fa429db545dd85061c1c06~tplv-tt-origin-web:gif.jpeg?_iz=58558&amp;from=article.pc_detail&amp;lk3s=953192f4&amp;x-expires=1740018094&amp;x-signature=kZLBPrU613u3J101720ME3axLN0%3D">
<p class="pgc-img-caption">&nbsp;</p>
</div>
<p data-track="41">这篇分享文章就到这里啦！如果你对文章内容有疑问或想要深入讨论，欢迎在评论区留言，我会尽力回答。同时，如果你觉得这篇文章对你有帮助，不妨点个赞并分享给其他同学，让更多人受益。</p>
<p data-track="42">想要了解更多相关知识，可以查看我以往的文章，其中有许多精彩内容。记得关注我，获取及时更新，我们可以一起学习、讨论技术，共同进步。</p>
<p data-track="43">感谢你的阅读与支持，期待在未来的文章中与你再次相遇！</p>
<p data-track="44">我的微信公众号：【xdub】，欢迎大家订阅，我会同步文章到公众号上。</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.4930189793865741" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-13 10:25">2025-02-13 10:24</span>&nbsp;
<a href="https://www.cnblogs.com/shuinanxun">一方_self</a>&nbsp;
阅读(<span id="post_view_count">156</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18712586" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18712586);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18712586', targetLink: 'https://www.cnblogs.com/shuinanxun/p/18712586', title: '解决微信小程序原生云开发退款报错“特约子商户商户号未授权服务商的产品权限”的问题' })">举报</a>
</div>
        