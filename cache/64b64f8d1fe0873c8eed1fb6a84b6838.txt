
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zxlh1529/p/18872581" title="å‘å¸ƒäº 2025-05-12 15:22">
    <span role="heading" aria-level="2">è§£å†³uniappå®ç°iosç³»ç»Ÿä¸­ä½åŠŸè€—è“ç‰™é€šè®¯å¤±è´¥é—®é¢˜</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="-uniapp-å®ç°-app-è¿æ¥ä½åŠŸè€—è“ç‰™bleé€šè®¯">ğŸ“± UniApp å®ç° App è¿æ¥ä½åŠŸè€—è“ç‰™ï¼ˆBLEï¼‰é€šè®¯</h2>
<p>æ‰‹å¤´ä¸Šæœ‰ä¸€ä¸ª uniapp å®ç°ä½åŠŸè€—è“ç‰™é€šè®¯è®¾å¤‡çš„é¡¹ç›®ï¼Œæœ¬æ¥ Android ç‰ˆæœ¬æ²¡é—®é¢˜å·²ç»ä¸Šçº¿ï¼Œåˆ°äº†å‘å¸ƒæµ‹è¯• iOS å‡ºé—®é¢˜äº†ï¼Œè¿æ¥ä¸Šäº†è®¾å¤‡ä½†æ˜¯é€šè®¯å¤±è´¥ï¼Œæ’æŸ¥äº†ä¸‹æ‰å‘ç°æ˜¯åè®®é€šè®¯ä¸­æœ‰åŒ…å«å…­ä½ IDï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡çš„ MAC åœ°å€ï¼Œå› ä¸ºè®¾å¤‡ä¸»è¦æ ‡è¯†ç¬¦é€šå¸¸æ˜¯è®¾å¤‡ MACï¼ŒAndroid èƒ½ç›´æ¥è·å–ï¼Œä½†æ˜¯å–µçš„ iOS ä¸ç»™ï¼Œæ‰€ä»¥æœ€ç»ˆåªèƒ½æ‰¾ç¡¬ä»¶å·¥ç¨‹å¸ˆè¿›è¡Œåå•†æ‰¾è§£å†³æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="ä¸€ble-é€šè®¯åè®®è¯´æ˜è¿™æ˜¯æœ¬é¡¹ç›®åè®®æ¶ˆæ¯ä½“æ„æˆ">ä¸€ã€BLE é€šè®¯åè®®è¯´æ˜ï¼ˆè¿™æ˜¯æœ¬é¡¹ç›®åè®®æ¶ˆæ¯ä½“æ„æˆï¼‰</h2>
<h3 id="å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ä½“æ ¼å¼">å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ä½“æ ¼å¼ï¼š</h3>
<pre><code>1Byteï¼ˆåŠŸèƒ½IDï¼‰ + 6Byteï¼ˆè®¾å¤‡IDï¼‰ + 1Byteï¼ˆç‰ˆæœ¬å·ï¼‰ + nByteï¼ˆåŠŸèƒ½å†…å®¹ï¼‰
</code></pre>
<h3 id="æœåŠ¡ç«¯å›åº”æ¶ˆæ¯ä½“æ ¼å¼">æœåŠ¡ç«¯å›åº”æ¶ˆæ¯ä½“æ ¼å¼ï¼š</h3>
<pre><code>1Byteï¼ˆåŠŸèƒ½IDï¼‰ + nByteï¼ˆåŠŸèƒ½å†…å®¹ï¼‰
</code></pre>
<hr>
<h2 id="-äºŒandroid-ä¸-ios-çš„å·®å¼‚ä¸è§£å†³æ–¹æ¡ˆ">ğŸ”§ äºŒã€Android ä¸ iOS çš„å·®å¼‚ä¸è§£å†³æ–¹æ¡ˆ</h2>
<h3 id="-android">ğŸ¤– Android</h3>
<ul>
<li><code>deviceId</code> è¿”å›å³ä¸ºè®¾å¤‡ <strong>Mac åœ°å€</strong>ï¼Œå¯ç›´æ¥è¿›è¡Œæ•°æ®é€šè®¯ã€‚</li>
</ul>
<h3 id="-ios">ğŸ iOS</h3>
<ul>
<li><code>deviceId</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <strong>UUID</strong>ï¼Œå¹¶éçœŸå® Mac åœ°å€ã€‚</li>
</ul>
<h4 id="-uuid-æ˜¯å¦‚ä½•ç”Ÿæˆçš„">ğŸ” UUID æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ</h4>
<ul>
<li>iOS ä½¿ç”¨ <code>CBPeripheral.identifier</code> ç”Ÿæˆä¸€ä¸ªä¸´æ—¶ <strong>UUID</strong>ã€‚</li>
<li>æ­¤ UUID æ˜¯ iOS ç³»ç»ŸåŸºäº BLE å‘ç°è¿‡ç¨‹ä¸ºæ¯ä¸ªè®¾å¤‡ <strong>éšæœºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦</strong>ã€‚</li>
<li>ä¸è®¾å¤‡çš„çœŸå®ç‰©ç†åœ°å€æ— å…³ï¼Œ<strong>æ¯æ¬¡è“ç‰™é‡è¿æˆ–é‡æ–°å‘ç°è®¾å¤‡æ—¶å¯èƒ½ä¼šæ”¹å˜</strong>ã€‚</li>
<li>Apple è¿™ä¹ˆè®¾è®¡æ˜¯ä¸º <strong>ä¿æŠ¤ç”¨æˆ·éšç§</strong>ï¼Œé¿å…å¼€å‘è€…è¿½è¸ªè®¾å¤‡æˆ–ç”¨æˆ·ã€‚</li>
</ul>
<h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆï¼š</h3>
<h4 id="æ–¹æ³•ä¸€è¿æ¥æˆåŠŸåç›‘å¬è®¾å¤‡ä¸»åŠ¨è¿”å›-mac-åœ°å€">æ–¹æ³•ä¸€ï¼šè¿æ¥æˆåŠŸåç›‘å¬è®¾å¤‡ä¸»åŠ¨è¿”å› Mac åœ°å€</h4>
<ul>
<li>è®¾å¤‡ä¼šåœ¨è¿æ¥ <strong>1 ç§’åä¸»åŠ¨å‘é€ Mac åœ°å€</strong>ã€‚</li>
<li>è‹¥æ— å›åº”ï¼Œè®¾å¤‡ä¼šæ¯ <strong>2 ç§’é‡å‘ä¸€æ¬¡</strong>ï¼Œç›´åˆ°æ”¶åˆ°ã€‚</li>
</ul>
<pre><code class="language-js">uni.onBLECharacteristicValueChange((res) =&gt; {
  const value = ab2hex(res.value);
  if (value.startsWith("01")) {
    const mac = value.slice(2, 14); // æˆªå–6å­—èŠ‚mac
    uni.setStorageSync('deviceMac', mac) // å­˜å‚¨macç”¨äºåç»­é€šè®¯ï¼Œæœ‰ç”¨ vuex æˆ–è€… pinia ç­‰å…¶ä»–æ–¹æ³•ä¹Ÿå¯ä»¥
    await this.send('11');  // åº”ç­”è®¾å¤‡é˜²æ­¢ä¸€ç›´ä¸ŠæŠ¥
  }
});
</code></pre>
<h4 id="æ–¹æ³•äºŒé€šè¿‡å¹¿æ’­æ•°æ®-advertisdata-æå–-mac-åœ°å€">æ–¹æ³•äºŒï¼šé€šè¿‡å¹¿æ’­æ•°æ® (advertisData) æå– Mac åœ°å€</h4>
<ul>
<li>æ¯æ¬¡æ‰«æè®¾å¤‡æ—¶ï¼Œå¹¿æ’­åŒ…ä¸­å¯èƒ½åŒ…å« Mac åœ°å€å­—æ®µã€‚</li>
<li>è‹¥å­˜åœ¨éšç§é¡¾è™‘ï¼Œå¯å¯¹å…¶ <strong>åŠ å¯†å¤„ç†</strong>ï¼Œè¿æ¥è®¾å¤‡å‰è¿›è¡Œ <strong>è§£å¯†å¹¶ç¼“å­˜</strong>ã€‚</li>
</ul>
<pre><code class="language-js">import CryptoJS from "crypto-js";

function decryptMac(cipherHex) {
  const key = CryptoJS.enc.Hex.parse("00112233445566778899aabbccddeeff"); // 16å­—èŠ‚å¯†é’¥
  const iv = CryptoJS.enc.Hex.parse("00000000000000000000000000000000"); // é»˜è®¤å…¨0 IV
  const encrypted = CryptoJS.enc.Hex.parse(cipherHex);
  const encryptedBase64 = CryptoJS.enc.Base64.stringify(encrypted);
  const decrypted = CryptoJS.AES.decrypt(encryptedBase64, key, {
    iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7,
  });
  return decrypted.toString(CryptoJS.enc.Hex);
}

uni.startBluetoothDevicesDiscovery({
  success() {
    uni.onBluetoothDeviceFound((device) =&gt; {
      const advertisData = device.advertisData;
      const raw = ab2hex(advertisData);
      const encryptedMac = raw.slice(10, 42); // ç¤ºä¾‹ä¸­ä¸º16å­—èŠ‚åŠ å¯†
      const mac = decryptMac(encryptedMac);
      console.log("è§£å¯†å‡ºçš„Macåœ°å€ï¼š", mac);
    });
  },
});
</code></pre>
<hr>
<h2 id="ä¸‰é€šè®¯æµç¨‹ç®€å•ç¤ºæ„">ä¸‰ã€é€šè®¯æµç¨‹ç®€å•ç¤ºæ„</h2>
<pre><code class="language-js">async function connectBLE(device) {
  await uni.createBLEConnection({ deviceId: device.deviceId });

  // ç›‘å¬ç‰¹å¾å€¼å˜åŒ–
  uni.onBLECharacteristicValueChange((res) =&gt; handleResponse(res));

  // å¯ç”¨ notify ç›‘å¬
  await uni.notifyBLECharacteristicValueChange({
    deviceId: device.deviceId,
    serviceId: serviceUUID,
    characteristicId: notifyUUID,
    state: true,
  });

  // å‘é€æ•°æ®
  const platform = uni.getSystemInfoSync().platform;
  const macAddress = uni.getStorageSync("deviceMac");
  const payload = buildPayload(
    "01",
    platform == "ios" ? macAddress : device.deviceId,
    "01",
    content
  );
  await uni.writeBLECharacteristicValue({
    deviceId: device.deviceId,
    serviceId: serviceUUID,
    characteristicId: writeUUID,
    value: str2ab(payload),
  });
}
</code></pre>
<hr>
<h2 id="ï¸-å››å®‰å…¨å»ºè®®">ğŸ›¡ï¸ å››ã€å®‰å…¨å»ºè®®</h2>
<ul>
<li><strong>å¹¿æ’­ä¸­çš„ Mac åœ°å€åº”åŠ å¯†</strong>ï¼Œé˜²æ­¢æ³„éœ²ã€‚</li>
<li><strong>é€šè®¯å†…å®¹å»ºè®®ä½¿ç”¨ AES åŠ å¯†</strong>ï¼Œæå‡å®‰å…¨ç­‰çº§ã€‚</li>
<li>ä½¿ç”¨ <strong>CRC16 æˆ– hash</strong> æ ¡éªŒæ•°æ®å®Œæ•´æ€§ã€‚</li>
</ul>
<hr>
<h2 id="-äº”æ€»ç»“">ğŸ“š äº”ã€æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>Android</th>
<th>iOS</th>
</tr>
</thead>
<tbody>
<tr>
<td>deviceId</td>
<td>è¿”å›çœŸå® Mac åœ°å€ âœ…</td>
<td>è¿”å› UUIDï¼Œéœ€ç‰¹æ®Šå¤„ç† âš ï¸</td>
</tr>
<tr>
<td>è·å– Mac</td>
<td>å¯ç›´æ¥ä½¿ç”¨</td>
<td>è¿æ¥åç›‘å¬ / å¹¿æ’­åŒ…è§£æ</td>
</tr>
<tr>
<td>å¹¿æ’­æ•°æ®</td>
<td>å¯ç”¨ï¼Œå¯åŠ å¯†æºå¸¦ Mac åœ°å€</td>
<td>æ¨èä½¿ç”¨ï¼Œç”¨äºè¿æ¥å‰æ ‡è¯†è®¾å¤‡</td>
</tr>
<tr>
<td>åŠ å¯†å»ºè®®</td>
<td>AES å¯¹ç§°åŠ å¯† / CRC16 æ ¡éªŒ</td>
<td>åŒ Androidï¼Œå»ºè®®ä¸€è‡´å¤„ç†æ–¹å¼</td>
</tr>
</tbody>
</table>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.7429873697002315" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-12 15:22">2025-05-12 15:22</span>&nbsp;
<a href="https://www.cnblogs.com/zxlh1529">å¹¼å„¿å›­æŠ€æœ¯å®¶</a>&nbsp;
é˜…è¯»(<span id="post_view_count">119</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18872581);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18872581', targetLink: 'https://www.cnblogs.com/zxlh1529/p/18872581', title: 'è§£å†³uniappå®ç°iosç³»ç»Ÿä¸­ä½åŠŸè€—è“ç‰™é€šè®¯å¤±è´¥é—®é¢˜' })">ä¸¾æŠ¥</a>
</div>
        