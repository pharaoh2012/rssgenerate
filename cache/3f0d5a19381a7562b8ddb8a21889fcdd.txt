
	<div class="postTitle">
		<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/many-bucket/p/18971691" title="å‘å¸ƒäº 2025-07-07 21:50">
    <span role="heading" aria-level="2">ä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿåˆ«è¢«éª—äº†ï¼Œä¸€çº§ç¼“å­˜å°±å¤Ÿäº†ï¼</span>
    

</a>

	</div>
	<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="æ–¹æ¡ˆå¯¼å…¥">æ–¹æ¡ˆå¯¼å…¥</h2>
<h3 id="å¾ªç¯ä¾èµ–æ˜¯ä»€ä¹ˆ">å¾ªç¯ä¾èµ–æ˜¯ä»€ä¹ˆ</h3>
<p>æ„é€ å‡ºä¸¤ä¸ªå¯¹è±¡Aå’ŒBï¼ŒAä¸­æœ‰æˆå‘˜Bï¼ŒBä¸­æœ‰æˆå‘˜Aï¼Œæ¢æˆä»£ç å°±æ˜¯è¿™æ ·å­ã€‚</p>
<pre><code class="language-java">@Component
public class A {
    @Autowired
    private B b;
}

@Component
public class B {
    @Autowired
    private A a;
}
</code></pre>
<h3 id="å¾ªç¯ä¾èµ–ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜">å¾ªç¯ä¾èµ–ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜</h3>
<p>å¦‚æœåˆ›å»ºAå¯¹è±¡ï¼Œé‚£å¿…é¡»æ³¨å…¥Bå¯¹è±¡ï¼Œæ³¨å…¥Bå¯¹è±¡åˆéœ€è¦åˆ›å»ºAå¯¹è±¡ï¼Œå¦‚æ­¤åå¤ï¼Œç›´åˆ°OOM</p>
<p><img alt="image1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3642195/202507/3642195-20250707214028147-389894272.png" class="lazyload"></p>
<h3 id="å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜">å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</h3>
<p>æˆ‘ä»¬æƒ³è±¡æœ‰è¿™æ ·ä¸€å¹…æœ‰å‘å›¾ï¼Œæˆ‘ä»¬ä»Aå¼€å§‹ï¼Œåˆ°Dç»“æŸï¼Œå½“æ‰§è¡Œåˆ°Dçš„æ—¶å€™ï¼ŒDè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºDä¸çŸ¥é“Aæ˜¯å¦è¢«ç»è¿‡ã€‚</p>
<p><img alt="image2" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3642195/202507/3642195-20250707214037311-1628211088.png" class="lazyload"></p>
<p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ç»è¿‡çš„è·¯å¾„ç‚¹<code>æŸ“è‰²</code>å°±å¥½äº†ã€‚</p>
<p><img alt="image3" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3642195/202507/3642195-20250707214044854-1473465357.png" class="lazyload"></p>
<p>Då‘ç°Aå·²ç»æ˜¯çº¢è‰²ï¼ŒçŸ¥é“å·²ç»è¢«é€”å¾„è¿‡ï¼Œä¸»åŠ¨ç»“æŸå¾ªç¯ã€‚</p>
<p>æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½å‘ç°ï¼Œå¾ªç¯ä¾èµ–é—®é¢˜å’Œå›¾è·¯å¾„ä¸­æ˜¯å¦æœ‰ç¯é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œå°±èƒ½ä¿è¯Beanï¼ˆå®ä¾‹ï¼‰ä¸è¢«é‡å¤åˆ›å»ºã€‚</p>
<p><img alt="image4" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3642195/202507/3642195-20250707214053641-253448483.png" class="lazyload"></p>
<h2 id="è”ç³»spring">è”ç³»Spring</h2>
<p>éƒ½è¯´Springä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å°±ä½¿ç”¨äº†ä¸€çº§ç¼“å­˜å°±è§£å†³äº†ç¼“å­˜ä¾èµ–é—®é¢˜ï¼Œspringçš„å¼€å‘å›¢é˜Ÿæ€ä¹ˆä¼šå‚»åˆ°ç”¨ä¸‰çº§ç¼“å­˜è§£å†³é—®é¢˜ï¼Œå½“ç„¶è¿™å¥è¯å¯èƒ½è¿˜æœ‰ä¸€ä¸ªæ­§ä¹‰ï¼Œç¬¬ä¸‰å±‚ç¼“å­˜åŒºè§£å†³äº†ç¼“å­˜ä¾èµ–é—®é¢˜ï¼Œè¿™åŒæ ·ä¹Ÿæ˜¯é”™çš„ï¼Œä¸”å¬ä¸‹æ–‡åˆ†æã€‚</p>
<h3 id="ä¸‰çº§ç¼“å­˜æ˜¯ä»€ä¹ˆ">ä¸‰çº§ç¼“å­˜æ˜¯ä»€ä¹ˆ</h3>
<pre><code class="language-java">//  å­˜å‚¨å•ä¾‹çš„Beanå¯¹è±¡
private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);
//  å­˜å‚¨æ—©æœŸæ›å…‰çš„å•ä¾‹Beanå¯¹è±¡ï¼Œåªæ˜¯ä¸€ä¸ªBeançš„å¼•ç”¨ï¼Œæœªåˆå§‹åŒ–
private final Map&lt;String, Object&gt; earlySingletonObjects = new ConcurrentHashMap&lt;&gt;(16);
//  å­˜å‚¨å•ä¾‹Beanå¯¹è±¡çš„å·¥å‚
private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new ConcurrentHashMap&lt;&gt;(16);
</code></pre>
<h3 id="ä¸‰çº§ç¼“å­˜å¦‚ä½•å·¥ä½œ---æºç éƒ¨åˆ†">ä¸‰çº§ç¼“å­˜å¦‚ä½•å·¥ä½œ - æºç éƒ¨åˆ†</h3>
<blockquote>
<p>æˆ‘ä¼šå¯¹å…³é”®ä»£ç æ‰“æ³¨é‡Šï¼Œä½ è¿™ä¹ˆèªæ˜è‚¯å®šä¸€ä¸‹å°±çœ‹æ‡‚äº†</p>
</blockquote>
<p>å½“æˆ‘ä»¬è·å–æƒ³è¦æ³¨å…¥çš„å•ä¾‹æ—¶ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼Œåˆ å»äº† try - catchçš„å¼‚å¸¸å¤„ç†å’Œè§£å†³å¹¶å‘é—®é¢˜çš„ä»£ç å—ï¼Œä¾¿äºæ¸…æ™°çš„é˜…è¯»</p>
<pre><code class="language-java">public Object getSingleton(String beanName) {
	return getSingleton(beanName, true);
}
	
protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    //ä»ä¸€çº§ç¼“å­˜ä¸­è·å–Bean
    Object singletonObject = this.singletonObjects.get(beanName);
    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {
		//ä»äºŒçº§ç¼“å­˜ä¸­è·å–Bean
        singletonObject = this.earlySingletonObjects.get(beanName);
        if (singletonObject == null &amp;&amp; allowEarlyReference) {
		    //ä»ä¸‰çº§ç¼“å­˜ï¼ˆå·¥å‚ï¼‰ä¸­è·å–Bean
            ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);
            if (singletonFactory != null) {
                singletonObject = singletonFactory.getObject();
                //ä»å·¥å‚ä¸­è·å–åˆ° singletonObject æ—¶ï¼Œä»å·¥å‚ç¼“å­˜ä¸­åˆ å»å·¥å‚ï¼Œå·¥å‚åˆ›å»ºçš„å¯¹è±¡åŠ å…¥äºŒçº§ç¼“å­˜
                if (this.singletonFactories.remove(beanName) != null) {
                    this.earlySingletonObjects.put(beanName, singletonObject);
                }
            }
        }
    }
    return singletonObject;
}
</code></pre>
<p>å¯è§ <code>getSingleton</code> çš„è·¯å¾„æ˜¯ ä¸€çº§ç¼“å­˜ â†’ äºŒçº§ç¼“å­˜  â†’ ä¸‰çº§ç¼“å­˜ï¼ŒåŒæ—¶å½“ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ°æ—©æœŸå¯¹è±¡æ—¶ï¼Œç›´æ¥æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œåˆ é™¤ä¸‰çº§ç¼“å­˜ï¼ˆåç»­çš„å¤šæ¬¡å¼•ç”¨ä¹Ÿæ˜¯äºŒçº§ç¼“å­˜ï¼‰ï¼Œå¯è§äºŒçº§ç¼“å­˜+çŸ­æš‚çš„ä¸‰çº§ç¼“å­˜ç›¸å½“äºæ ‡è®°beanä¸ºå·²å®ä¾‹åŒ–ï¼Œæ‰€ä»¥ä¾èµ–ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–æ˜¾ç„¶æ˜¯é”™çš„</p>
<p>é‚£ä¸‰çº§ç¼“å­˜ï¼ˆå·¥å‚ï¼‰åˆ°åº•å­˜å‚¨ç€ä»€ä¹ˆï¼Œä¸æ˜¯äºŒçº§ç¼“å­˜å°±èƒ½è§£å†³é—®é¢˜äº†å—ï¼Ÿæˆ‘ä»¬åœ¨ <code>doCreateBean</code> ä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç ã€‚</p>
<pre><code class="language-java">		// å½“å‰ Beanï¼ˆä¾‹å¦‚ Aï¼‰åœ¨å®ä¾‹åŒ–åã€ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–å®Œæˆå‰ï¼Œæ˜¯å¦éœ€è¦å°†å…¶ä½œä¸ºâ€œæ—©å¼•ç”¨â€æš´éœ²ç»™å…¶ä»– Bean
		boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;
				isSingletonCurrentlyInCreation(beanName));
		// å…è®¸è¢«æ—©å¼•ç”¨ï¼ˆæ—©æœŸæ›å…‰ï¼‰
		if (earlySingletonExposure) {
			// æ·»åŠ åˆ°å•ä¾‹å·¥å‚ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
		}
		
		// è¢«ä¸‰çº§ç¼“å­˜æ·»åŠ åå†è¿›è¡Œåˆå§‹åŒ–
		Object exposedObject = bean;
		populateBean(beanName, mbd, instanceWrapper);
		exposedObject = initializeBean(beanName, exposedObject, mbd);

</code></pre>
<p>è¯æ˜äº†ä¸‰çº§ç¼“å­˜ä»¥åŠäºŒçº§ç¼“å­˜ä¸­çš„å¯¹è±¡æ˜¯å¼•ç”¨å¯¹è±¡ï¼Œæœªè¢«çœŸæ­£åˆå§‹åŒ–ï¼Œç­‰äºæ˜¯ä¸€ä¸ªæ‡’åŠ è½½ï¼ŒåŒæ ·ä¹Ÿä¸ä¼šé€ æˆå¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„å¯¹è±¡æ²¡æœ‰åªå¼•ç”¨äº†å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œæœªè¢«åˆå§‹åŒ–ã€‚</p>
<p><code>getEarlyBeanReference</code> åº”è¯¥æœ‰å…³äºFactoryä¸­çš„ä¸€äº›ä¿¡æ¯</p>
<pre><code class="language-java">	protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
		Object exposedObject = bean;
		// æ˜¯å¦è¢«ä»£ç†ï¼ˆAOPï¼Œå­—èŠ‚ç å¢å¼ºï¼‰
		if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {
			for (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) {
				exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);
			}
		}
		return exposedObject;
	}
</code></pre>
<p>å€˜è‹¥æ²¡æœ‰ç»è¿‡å­—èŠ‚ç å¢å¼ºä»£ç å¯ä»¥ç¼©ç•¥æˆä¸¤è¡Œ</p>
<pre><code class="language-java">	protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
		Object exposedObject = bean;
		return exposedObject;
	}
</code></pre>
<p>è¯¶å§æ§½ï¼Œè¿™ä¸æ˜¯å•¥ä¹Ÿæ²¡å¹²ï¼</p>
<p>ä¸‰çº§ç¼“å­˜åªå‚ä¸äº†AOPå¯¹è±¡çš„è¿”å›ï¼Œè§£å†³beançš„AOPä»£ç†é—®é¢˜</p>
<p>ä¸‹å›¾å±•ç¤ºäº†beançš„åˆå§‹åŒ–è¿‡ç¨‹</p>
<p><img alt="image5" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3642195/202507/3642195-20250707214105375-1531597703.png" class="lazyload"></p>
<p>é‚£æˆ‘ä»¬ç°åœ¨å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºäº†ï¼š</p>
<ol>
<li>ç¬¬ä¸€çº§ç¼“å­˜ç”¨æ¥ç®€å•è¿”å›ç¼“å­˜åçš„beanå¯¹è±¡ã€‚</li>
<li>ç¬¬äºŒçº§ç¼“å­˜å°±å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚</li>
<li>äºŒä¸‰çº§ç¼“å­˜åªä¿ç•™äº†å®ä¾‹åŒ–çš„beanï¼Œæœªåˆå§‹åŒ–ï¼Œä¸ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–ã€‚</li>
<li>ç¬¬ä¸‰çº§ç¼“å­˜ç”¨æ¥è§£å†³Beançš„ä»£ç†ç±»çš„å®ä¾‹åŒ–é—®é¢˜ã€‚</li>
</ol>
<hr>
<p>å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ç‚¹ä¸ªèµã€‚ä½ çš„è‚¯å®šä¼šè®©æˆ‘éå¸¸å¼€å¿ƒã€‚ğŸ¥°ğŸ¥°ğŸ¥°</p>
<p>æ±‚ç‚¹èµ orz OTZ ï¼ï¼</p>

</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0.001388888888888889" data-date-updated="2025-07-07 21:52">2025-07-07 21:50</span>&nbsp;
<a href="https://www.cnblogs.com/many-bucket">crhl-yy</a>&nbsp;
é˜…è¯»(<span id="post_view_count">31</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18971691);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18971691', targetLink: 'https://www.cnblogs.com/many-bucket/p/18971691', title: 'ä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿåˆ«è¢«éª—äº†ï¼Œä¸€çº§ç¼“å­˜å°±å¤Ÿäº†ï¼' })">ä¸¾æŠ¥</a>
</div>
