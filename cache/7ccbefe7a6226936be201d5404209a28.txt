
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/MrHanBlog/p/18706316" title="å‘å¸ƒäº 2025-02-09 17:18">
    <span role="heading" aria-level="2">ç½‘ç«™é›†æˆå¾®ä¿¡å…¬ä¼—å·ï¼ˆè®¢é˜…å·ï¼‰ç™»å½•</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å‰ä¸€é˜µå­ï¼Œæƒ³ç€ç»™<a href="https://www.xiandanplay.com/" target="_blank" rel="noopener nofollow">æˆ‘çš„ç«™ç‚¹</a>é›†æˆä¸€ä¸ªå¾®ä¿¡ç™»å½•ï¼Œå› ä¸ºæˆ‘ä¹‹å‰ä»æœªæœ‰è¿‡å¾®ä¿¡ç›¸å…³çš„å¼€å‘ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±è·Ÿç€ç½‘ä¸Šçš„èµ„æ–™ï¼Œä¸€æ­¥ä¸€æ­¥çš„æ…¢æ…¢çš„æ‘¸ç´¢ï¼Œè¿‡ç¨‹ä¸å…çš„é‡åˆ°äº†è®¸å¤šå‘ï¼Œæ‰æŠŠæˆ‘çš„ç½‘ç«™å¾®ä¿¡ç™»å½•é›†æˆå®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œåˆ†äº«ä¸€ä¸‹æˆ‘çš„æ‘¸ç´¢çš„è¿‡ç¨‹ã€‚<strong>å› ä¸ºæˆ‘çš„æ˜¯è®¢é˜…å·ï¼Œæ‰€ä»¥ä¸€ä¸‹çš„å†…å®¹å‡é’ˆå¯¹è®¢é˜…å·è€Œè¨€çš„</strong>ã€‚</p>
<h2 id="ä¸€äº†è§£å¾®ä¿¡çš„äº¤äº’æµç¨‹">ä¸€ã€äº†è§£å¾®ä¿¡çš„äº¤äº’æµç¨‹</h2>
<p>è¿™é‡Œå‡è®¾æˆ‘ä»¬éƒ½å·²ç»ç”³è¯·å·äº†å¾®ä¿¡å¼€å‘çš„ç›¸å…³ä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦é…ç½®å¾®ä¿¡è®¤è¯æœåŠ¡å™¨åœ°å€ï¼ˆapiåœ°å€ï¼‰ï¼Œè¿™ä¸€æ­¥æ˜¯å¿…é¡»çš„ï¼Œå¾®ä¿¡ä¸æˆ‘ä»¬äº¤äº’éƒ½æ˜¯éƒ½æ˜¯é€šè¿‡è¿™ä¸€ä¸ªåœ°å€ï¼Œå¼€å§‹æˆ‘ä¸€ç›´ä¸çŸ¥é“ï¼Œæˆ‘ä»¥ä¸ºè‡ªå·±è¦å¯¹æ¯ä¸€ä¸ªåŠŸèƒ½éƒ½è¦å†™ä¸€ä¸ªapiï¼Œå…¶å®ä¸éœ€è¦çš„ã€‚æˆ‘ä»¬åªéœ€è¦å®Œæˆæˆ‘ä»¬çš„å¾®ä¿¡è®¤è¯æœåŠ¡å™¨åœ°å€ï¼Œç„¶åé‡Œé¢å¤„ç†æˆ‘ä»¬ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚<br>
<img src="https://img2024.cnblogs.com/blog/994611/202502/994611-20250209171426798-1744355540.png" alt="" loading="lazy"></p>
<div class="mermaid">sequenceDiagram
  ç”¨æˆ·-&gt;&gt;å¾®ä¿¡: å‘é€æ¶ˆæ¯â€œhello!â€
  å¾®ä¿¡-&gt;&gt;æˆ‘çš„ç½‘ç«™: è®¤è¯æœåŠ¡apiæ ¡éªŒ
  æˆ‘çš„ç½‘ç«™-)å¾®ä¿¡: æ ¡éªŒæˆåŠŸ
  å¾®ä¿¡-&gt;&gt;æˆ‘çš„ç½‘ç«™: å‘é€â€œhello!â€åˆ°è®¤è¯æœåŠ¡api
  æˆ‘çš„ç½‘ç«™-)ä¸šåŠ¡é€»è¾‘: è®¤è¯æœåŠ¡apiæ¥æ”¶â€œhello!â€å¹¶ä¸”å¤„ç†ä¸šåŠ¡é€»è¾‘
 æˆ‘çš„ç½‘ç«™--&gt;&gt; ç”¨æˆ·: ä¹Ÿå¯è¿”å›ç»™ç”¨æˆ·ç›¸å…³ä¿¡æ¯
</div><p>ç”¨æˆ‘çš„è¯å°±æ˜¯<br>
å‡è®¾æˆ‘çš„è®¤è¯apiæ˜¯ï¼š/api/check<br>
1.ç”¨æˆ·å‘é€æ¶ˆæ¯â€ä½ å¥½â€œåˆ°å¾®ä¿¡å…¬ä¼—å·<br>
2.å¾®ä¿¡å…¬ä¼—å·å‘èµ·Getè¯·æ±‚è°ƒç”¨ /api/check è¿›è¡Œè®¤è¯<br>
3.è®¤è¯æˆåŠŸæ—¶å¾®ä¿¡å…¬ä¼—å·å†æ¬¡Postè¯·æ±‚è°ƒç”¨/api/checkï¼Œå¹¶ä¸”æºå¸¦â€ä½ å¥½â€œä¿¡æ¯<br>
4./api/checkæ¥å£é‡Œé¢å¤„ç†ç›¸å…³ä¸šåŠ¡é€»è¾‘ï¼Œæˆ–è€…è¿”å›ç‰¹å®šä¿¡æ¯ç»™ç”¨æˆ·</p>
<h2 id="äºŒé›†æˆç›¸å…³sdk">äºŒã€é›†æˆç›¸å…³sdk</h2>
<p>å¯¹äºå¾®ä¿¡çš„æ¶ˆæ¯å¤„ç†ï¼Œå…¶å®æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œæˆ‘ç½‘ä¸Šæœäº†ä¸€ä¸‹ï¼Œå¤§éƒ¨åˆ†æ¨èçš„æ˜¯<a href="https://sdk.weixin.senparc.com/Docs/Work/" target="_blank" rel="noopener nofollow">ç››æ´¾å¾®ä¿¡sdk</a>,åšå®¢å›­ä¹Ÿæœ‰ç›¸å…³çš„æ•™ç¨‹<a href="https://www.cnblogs.com/szw/archive/2013/05/20/3089479.html" target="_blank">https://www.cnblogs.com/szw/archive/2013/05/20/3089479.html</a>ï¼Œä¸ªäººç”¨èµ·æ¥æˆ‘è§‰å¾—è¿˜æ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥çœå»æˆ‘ä»¬å¤§éƒ¨åˆ†å·¥ä½œï¼Œä¸“æ³¨å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚</p>
<h3 id="å°è£…custommessagehandler">å°è£…CustomMessageHandler</h3>
<p>é¦–å…ˆæˆ‘æ˜¯è¦å¯¹ç››æ´¾å¾®ä¿¡sdkçš„å°è£…ï¼Œæ‰€ä»¥æˆ‘æ–°å»ºäº†ä¸€ä¸ªCustomMessageHandlerï¼Œç„¶åç»§æ‰¿è‡ªMessageHandler<defaultmpmessagecontext>ï¼Œç„¶åé‡æ–°DefaultResponseMessageæ–¹æ³•ï¼Œè¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œç›´æ¥</defaultmpmessagecontext></p>
<p>public override IResponseMessageBase DefaultResponseMessage(IRequestMessageBase requestMessage)<br>
{<br>
var responseMessage = base.CreateResponseMessage<responsemessagetext>();<br>
return responseMessage;<br>
}</responsemessagetext></p>
<h3 id="å¤„ç†ç”¨æˆ·å…³æ³¨äº‹ä»¶">å¤„ç†ç”¨æˆ·å…³æ³¨äº‹ä»¶</h3>
<p>å½“å¾®ä¿¡ç”¨æˆ·å…³æ³¨å…¬ä¼—å·æ—¶æˆ‘éœ€è¦å‘é€é—®å€™è¯­ç»™ç”¨æˆ·ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦é‡å†™OnEvent_SubscribeRequestAsync<br>
public override Task<iresponsemessagebase> OnEvent_SubscribeRequestAsync(RequestMessageEvent_Subscribe requestMessage)<br>
{<br>
var responseMessage = base.CreateResponseMessage<responsemessagetext>();<br>
responseMessage.Content = â€œæ¬¢è¿å…³æ³¨â€;<br>
return Task.FromResult(responseMessage as IResponseMessageBase);<br>
}</responsemessagetext></iresponsemessagebase></p>
<h3 id="å¤„ç†ç”¨æˆ·å…³é”®å­—">å¤„ç†ç”¨æˆ·å…³é”®å­—</h3>
<p>å½“å¾®ä¿¡ç”¨æˆ·ç»™å…¬ä¼—å·å‘é€ç‰¹ç‚¹æ¶ˆæ¯ï¼ˆå…³é”®å­—ï¼‰æ—¶ï¼Œæˆ‘éœ€è¦å›å¤ç”¨æˆ·ï¼Œé‚£ä¹ˆå°±é‡å†™OnTextRequestAsync<br>
public override Task<iresponsemessagebase> OnTextRequestAsync(RequestMessageText requestMessage)<br>
{<br>
var responseMessage = base.CreateResponseMessage<responsemessagetext>();<br>
return Task.FromResult(responseMessage as IResponseMessageBase);<br>
}</responsemessagetext></iresponsemessagebase></p>
<h3 id="æŠ½ç¦»ä¸šåŠ¡é€»è¾‘æ–¹æ³•">æŠ½ç¦»ä¸šåŠ¡é€»è¾‘æ–¹æ³•</h3>
<p>åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€å¸Œæœ›å°è£…ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œä¸éœ€è¦ç‰µæ‰¯å¤ªå¤šä¸šåŠ¡é€»è¾‘ï¼Œå°±ä¾‹å¦‚ä¸æƒ³åœ¨CustomMessageHandleré‡Œå»å†™ä¸šåŠ¡é€»è¾‘ï¼Œé‚£ä¹ˆæˆ‘è¿™é‡Œé‡‡ç”¨çš„å§”æ‰˜çš„å½¢å¼ï¼Œæ–°å»ºä¸€ä¸ªCustomParamï¼Œç„¶åé‡Œé¢å®šä¹‰ä¸€ä¸ªä¸¤ä¸ªå§”æ‰˜</p>
<pre><code class="language-C#"> public class CustomParam
    {
        /// &lt;summary&gt;
        /// æ™®é€šæ–‡æœ¬äº‹ä»¶å¤„ç†
        /// &lt;/summary&gt;
        public Func&lt;RequestMessageText, ResponseMessageText, string, ResponseMessageText&gt; OnTextFunc;
        /// &lt;summary&gt;
        /// è®¢é˜…äº‹ä»¶å¤„ç†
        /// &lt;/summary&gt;
        public Func&lt;string&gt; OnSubscribeFunc;
    }
</code></pre>
<p>ç„¶åé€šè¿‡CustomMessageHandlerçš„æ„é€ å‡½æ•°ä¼ å…¥</p>
<pre><code class="language-C#">        private CustomParam customParam;
        public CustomMessageHandler(CustomParam customParam)
        {
            this.customParam = customParam;
        }
</code></pre>
<p>ç„¶ååœ¨å…·ä½“çš„å¤„ç†äº‹ä»¶é‡Œé¢è°ƒç”¨è¿™ä¸ªå§”æ‰˜<br>
<img src="https://www.xiandanplay.com/qniu/2025/2/9/0b8b7abd9d3e419ba8ca747ef817fa70.png" alt="" loading="lazy"></p>
<h3 id="é€šè¿‡æ¥å£è°ƒç”¨å¾®ä¿¡custommessagehandlerçš„æ–¹æ³•">é€šè¿‡æ¥å£è°ƒç”¨å¾®ä¿¡CustomMessageHandlerçš„æ–¹æ³•</h3>
<p>æˆ‘æ¥ç€åœ¨å»ºä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢åŒ…å«äº†è®¤è¯ï¼Œæ¶ˆæ¯å¤„ç†ï¼Œåˆ›å»ºCustomMessageHandlerçš„æ–¹æ³•ï¼Œæ¥ç»™ä¸šåŠ¡è°ƒç”¨</p>
<pre><code class="language-C#">using Core.WeXin.WxOfficial;
using Senparc.Weixin.AspNet.MvcExtension;
using Senparc.Weixin.MP.Entities;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Core.WeXin
{
    public interface IWxCommonHandler
    {
        /// &lt;summary&gt;
        /// æ ¡éªŒæœåŠ¡
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        bool CheckSign(string signature, string timestamp, string nonce, string echostr);
        /// &lt;summary&gt;
        /// åˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨
        /// &lt;/summary&gt;
        /// &lt;param name="inputStream"&gt;&lt;/param&gt;
        /// &lt;param name="messageAbsService"&gt;&lt;/param&gt;
        void CreateMessageHandler(Stream inputStream, CustomParam param);
        /// &lt;summary&gt;
        /// å…¬ä¼—å·æ¶ˆæ¯å¤„ç†
        /// &lt;/summary&gt;
        /// &lt;param name="inputStream"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        Task&lt;WeixinResult&gt; ExecuteMessageHandler();
        /// &lt;summary&gt;
        /// è·å–å½“å‰opentid
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        string GetOpenId();
        /// &lt;summary&gt;
        /// è·å–å¾®ä¿¡æ¶ˆæ¯
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        string GetMessgeText();
    }
}

</code></pre>
<pre><code class="language-C#">using Core.Log;
using Core.WeXin.WxOfficial;
using Microsoft.Extensions.Configuration;
using Senparc.NeuChar;
using Senparc.NeuChar.Entities;
using Senparc.Weixin.AspNet.MvcExtension;
using Senparc.Weixin.MP;
using Senparc.Weixin.MP.Entities;
using System;

namespace Core.WeXin
{
    internal class WxCommonHandler:IWxCommonHandler
    {
        private CustomMessageHandler customMessageHandler = null;
        private IConfiguration configuration; 
        public WxCommonHandler(IConfiguration configuration)
        {
          this.configuration = configuration;
        }
        public bool CheckSign(string signature, string timestamp, string nonce, string echostr)
        {
            string token = configuration.GetSection("SenparcWeixinSetting:Token").Value;
            return CheckSignature.Check(signature, timestamp, nonce, token);
        }
        public void CreateMessageHandler(Stream inputStream,CustomParam customParam)
        {
            customMessageHandler = new CustomMessageHandler(inputStream, null, customParam);
            customMessageHandler.OmitRepeatedMessage = true;
        }
        public async Task&lt;WeixinResult&gt; ExecuteMessageHandler()
        {
            await customMessageHandler.ExecuteAsync(new CancellationToken());
            string result = "";
            if (customMessageHandler.ResponseDocument != null)
            {
                 result = customMessageHandler.ResponseDocument.ToString();
            }
            return new WeixinResult(result);
        }

        public string GetOpenId()
        {
            return customMessageHandler.OpenId;
        }
        public string GetMessgeText()
        {
            var requestMsg= customMessageHandler.RequestMessage;
            if (requestMsg.MsgType == RequestMsgType.Text)
            {
                RequestMessageText requestText = requestMsg as RequestMessageText;
                return requestText.Content;
            }
            return string.Empty;
        }
    }
}

</code></pre>
<h3 id="æ³¨å†Œå¾®ä¿¡sdkç›¸å…³å†…å®¹">æ³¨å†Œå¾®ä¿¡sdkç›¸å…³å†…å®¹</h3>
<pre><code class="language-C#">using Core.Log;
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Newtonsoft.Json;
using Senparc.CO2NET;
using Senparc.CO2NET.AspNet;
using Senparc.Weixin.AspNet;
using Senparc.Weixin.Entities;
using Senparc.Weixin.MP;
using Senparc.Weixin.RegisterServices;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Core.WeXin
{
    public static class ConfigureWxService
    {
        public static IServiceCollection AddWxOfficialServices(this IServiceCollection services, IConfiguration configuration)
        {
            services.AddScoped&lt;IWxCommonHandler, WxCommonHandler&gt;();
            services.AddSenparcWeixinServices(configuration);
            return services;
        }
        public static void UseWxOfficial(this WebApplication app, ConfigurationManager configuration)
        {
            var registerService = app.UseSenparcWeixin(app.Environment, null, null, register =&gt; { },
                (register, weixinSetting) =&gt;
                {
                    register.RegisterMpAccount(weixinSetting, configuration.GetSection("WxOfficialName").Value);
                });
        }
    }
}

</code></pre>
<h2 id="äºŒæ–°å»ºè®¤è¯apigetè¯·æ±‚">äºŒã€æ–°å»ºè®¤è¯api(Getè¯·æ±‚)</h2>
<p>å‰é¢è¯´åˆ°ï¼Œæˆ‘ä»¬å’Œå¾®ä¿¡æ‰“äº¤é“å§‹ç»ˆæ˜¯è¿™ä¸€ä¸ªå¾®ä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªapiæ—¢èƒ½æ¥æ”¶è®¤è¯åˆèƒ½æ¥æ”¶æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘å…ˆå»ºä¸€ä¸ªGetè¯·æ±‚çš„æ–¹æ³•</p>
<pre><code class="language-C#">  [HttpGet("handler")]
   public ContentResult Handler()
        {
            string signature = Request.Query["signature"];
            string timestamp = Request.Query["timestamp"];
            string nonce = Request.Query["nonce"];
            string echostr = Request.Query["echostr"];
            if (wxCommonHandler.CheckSign(signature, timestamp, nonce, echostr))
            {
                return new ContentResult()
                {
                    Content = echostr
                };
            }
            else
            {
                return new ContentResult()
                {
                    Content = "false"
                };
            }
        }

</code></pre>
<h2 id="ä¸‰æ–°å»ºå¾®ä¿¡å¤„ç†çš„service">ä¸‰ã€æ–°å»ºå¾®ä¿¡å¤„ç†çš„Service</h2>
<h3 id="å…³æ³¨äº‹ä»¶ä¸šåŠ¡">å…³æ³¨äº‹ä»¶ä¸šåŠ¡</h3>
<p>æˆ‘æƒ³åœ¨ç”¨æˆ·å…³æ³¨æ—¶å‘é€å¯¹åº”çš„é—®å€™è¯­ï¼Œåˆ™æˆ‘ç›´æ¥æ–°å»ºä¸€ä¸ªæ–¹æ³•OnSubscribeEvent</p>
<pre><code class="language-C#">     public string OnSubscribeEvent()
        {
            StringBuilder sb = new StringBuilder();
            sb.Append("æ‚¨å¥½ï¼æ¬¢è¿å…³æ³¨ã€é—²è›‹ã€‘ğŸ’–\r\n");
            sb.Append("å›å¤[ç™»å½•]å³å¯è·å–éªŒè¯ç ç™»å½•ç½‘é¡µ&lt;a href=\"https://www.xiandanplay.com\"&gt;é—²è›‹&lt;/a&gt;ğŸŒŸ\r\n");
            sb.Append("æ›´å¥½çš„ç½‘ç«™ä½“éªŒè¯·ç”¨ç”µè„‘ç™»å½•ğŸ˜‚ğŸ˜‚\r\n");
            sb.Append("å…³äºé—²è›‹ï¼Œç‚¹è¿™é‡ŒğŸ‘‰ï¼š&lt;a href=\"https://mp.weixin.qq.com/s/TNBr9XiLbPJU3ZFRT3cCbg\"&gt;å…³äºé—²è›‹&lt;/a&gt;\r\n");
            sb.Append("å…³äºç«™é•¿ï¼Œç‚¹è¿™é‡ŒğŸ‘‰ï¼š&lt;a href=\"https://mp.weixin.qq.com/s/4KvydAbogv2KZGBfNmRveA\"&gt;å…³äºç«™é•¿&lt;/a&gt;\r\n");
            sb.Append("ç¥å¤§å®¶ç”Ÿæ´»å¹³å¹³å®‰å®‰ï¼Œä¸æ±‚å¤šè´¢ä½†æ±‚æ— ç–¾ğŸ˜œğŸ˜œ");
            return sb.ToString();
        }
</code></pre>
<h3 id="å…³é”®å­—ç™»å½•">å…³é”®å­—ç™»å½•</h3>
<p>å› ä¸ºæˆ‘çš„æ˜¯è®¢é˜…å·ï¼Œæ— æ³•è·å–å®ç°å¾®ä¿¡ç™»å½•ï¼Œäºæ˜¯æˆ‘åªå¥½é€šè¿‡å›å¤å…³é”®å­—çš„å½¢å¼ï¼Œè·å–ç™»å½•éªŒè¯ç ï¼Œç„¶åè·å–åˆ°openidæ¥æ³¨å†Œç”¨æˆ·ï¼Œæ‰€ä»¥æˆ‘çš„å¤„ç†æ­¥éª¤å¦‚ä¸‹ï¼š<br>
1.åŒ¹é…åˆ°å…³é”®å­—â€œç™»å½•â€<br>
2.æ ¹æ®å½“å‰çš„å½“å‰çš„openidåˆ¤æ–­redisçš„Setæ˜¯å¦å·²æœ‰å¯¹åº”çš„éªŒè¯å—ï¼Œå¦‚æœå·²å­˜åœ¨ç›´æ¥è¿”å›â€œè¯·å‹¿é‡å¤è·å–éªŒè¯ç â€<br>
3.ä¸ºäº†é˜²æ­¢ç”Ÿæˆé‡å¤çš„æœ‰æ•ˆçš„éªŒè¯ç ï¼Œæ‰€ä»¥æˆ‘æ–°å»ºä¸€ä¸ªKeyï¼Œå€¼ä¸ºloginCodeçš„Setç±»å‹çš„ç¼“å­˜ï¼Œå½“ç”Ÿæˆçš„éªŒè¯ç å¯ä»¥ä»rediså–åˆ°ï¼Œåˆ™ä»æ–°ç”Ÿæˆã€‚ï¼ˆç›®å‰æœ¨æœ‰æƒ³åˆ°æ›´å¥½çš„åŠæ³•ï¼Œè¯·èµæ•™...ï¼‰<br>
4.å°†Setçš„Keyã€ éªŒè¯ç loginCodeï¼Œæ”¾å…¥redisï¼Œå­˜ä¸ºSetç±»å‹ï¼Œè¿‡æœŸæ—¶é—´ä¸º1åˆ†é’Ÿï¼Œæ­¤å¤„æ˜¯ä¸ºäº†æ­¥éª¤3çš„æ ¡éªŒ<br>
5.å†æ–°å»ºä¸€ä¸ªSetçš„Keyã€ openidï¼Œæ”¾å…¥redisï¼Œè¿‡æœŸæ—¶é—´ä¸º1åˆ†é’Ÿï¼Œæ­¤å¤„æ˜¯ä¸ºäº†æ­¥éª¤2çš„æ ¡éªŒï¼Œ<br>
6.å†æ–°å»ºä¸€ä¸ªHashSetçš„Keyã€loginCodeã€ openidï¼Œæ”¾å…¥redisï¼Œè¿‡æœŸæ—¶é—´ä¸º1åˆ†é’Ÿ,ç„¶åè¾“å…¥éªŒè¯ç ç™»å½•çš„æ—¶å€™ç›´æ¥æ ¹æ®è¿™ä¸ªç¼“å­˜æ¥</p>
<pre><code class="language-C#"> public ResponseMessageText OnTextEvent(RequestMessageText requestMessageText,ResponseMessageText responseMessageText,string openId)
        {
            try
            {
                requestMessageText.StartHandler().Keyword("ç™»å½•", () =&gt;
                {
                    if (cacheClient.ExistsSet(CheckRepeatGetLoginCodeKey, openId))
                        responseMessageText.Content = $"æ‚¨å¥½ï¼šè¯·å‹¿é‡å¤è·å–éªŒè¯ç ";
                    else
                    {
                        string verCode = OnLoginVerCode(openId);
                        responseMessageText.Content = $"æ‚¨å¥½ï¼šæ‚¨çš„ç½‘ç«™ç™»å½•éªŒè¯ç æ˜¯ {verCode} æœ‰æ•ˆæœŸ60ç§’";
                    }
                    return responseMessageText;
                });
                return responseMessageText;
            }
            catch (Exception ex)
            {
                LogUtils.LogError(ex);
                throw;
            }

        }
 private string OnLoginVerCode(string openId)
        {
            string loginCode = StringUtil.RandomNumber(4);
            string cacheKey = "login_wx_code";
            bool existCode = false;
            do
            {
                existCode = cacheClient.ExistsSet(cacheKey, loginCode);
                if (!existCode)
                {
                    TimeSpan expire = TimeSpan.FromMinutes(1);
                    cacheClient.AddSet(cacheKey, loginCode, expire);
                    cacheClient.AddSet(CheckRepeatGetLoginCodeKey, openId, expire);
                    cacheClient.AddHash(CacheKey.WxLoginCodeKey, loginCode, openId, expire);
                }

            }
            while (existCode);
            return loginCode;
        }
</code></pre>
<h2 id="å››æ–°å»ºè®¤è¯apipostè¯·æ±‚">å››ã€æ–°å»ºè®¤è¯api(Postè¯·æ±‚)</h2>
<pre><code class="language-C#">        [HttpPost("handler")]
        public async Task&lt;ContentResult&gt; Handler(string signature, string timestamp, string nonce, string echostr)
        {
            if (!wxCommonHandler.CheckSign(signature, timestamp, nonce,echostr))
            {
                return new ContentResult()
                {
                    Content = "å‚æ•°é”™è¯¯"
                };
            }
            CustomParam customParam = new CustomParam()
            {
                OnSubscribeFunc = wxService.OnSubscribeEvent,
                OnTextFunc = wxService.OnTextEvent
            };
            wxCommonHandler.CreateMessageHandler(Request.Body, customParam);
            return  await wxCommonHandler.ExecuteMessageHandler();
        }
</code></pre>
<p>wxServiceå°±æ˜¯å‰é¢çš„å°è£…çš„æ–¹æ³•</p>
<h2 id="äº”ç™»å½•éªŒè¯">äº”ã€ç™»å½•éªŒè¯</h2>
<p>æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ ¹æ®éªŒè¯ç ï¼Œèƒ½å¦ä»ç¼“å­˜å–åˆ°å¯¹åº”çš„ä¿¡æ¯</p>
<pre><code class="language-C#">           Regex regex = new Regex(RegexPattern.IsNumberPattern);
            if (!regex.IsMatch(code.Trim()) || code.Length != 4)
                throw new ValidationException("code æ— æ•ˆ");
            CacheClient cacheClient = CacheClient.CreateClient();
            string openId= cacheClient.GetHashValue("Wx_Login_Hash_Key", code);
            if (string.IsNullOrEmpty(openId))
                throw new AuthException("éªŒè¯ç æ— æ•ˆ");
            WeXinUserInfo weXinUserInfo = new WeXinUserInfo();
            weXinUserInfo.OpenAuthEnum = OpenAuthEnum.Wexin;
            weXinUserInfo.Nickname = "wx_" + StringUtil.RandomNumber(10);
            weXinUserInfo.OpenID = openId;
            weXinUserInfo.Sex = "ç”·";
            cacheClient.DeleteHashField("Wx_Login_Hash_Key", code);
            return await Task.FromResult(weXinUserInfo);
</code></pre>
<h2 id="å…­æˆæœå±•ç¤º">å…­ã€æˆæœå±•ç¤º</h2>
<p><img src="https://img2024.cnblogs.com/blog/994611/202502/994611-20250209175731517-1995981136.png" alt="" loading="lazy"><br>
<img src="https://img2024.cnblogs.com/blog/994611/202502/994611-20250209175743527-1549148385.png" alt="" loading="lazy"></p>
<p>ç›®å‰ä¸ºæ­¢ï¼Œå¾®ä¿¡å…¬ä¼—å·å·²ç»å¼€å‘å®Œæˆï¼Œå› ä¸ºæˆ‘æ²¡æœ‰è¿‡ç›¸å…³å¼€å‘çš„ç»éªŒï¼Œæ‰€ä»¥å¦‚æœæœ‰ä¸åˆé€‚çš„åœ°æ–¹ï¼Œå¤§å®¶å¯ä»¥æŒ‡å‡ºæ¥ã€‚</p>
<p><strong>åŒæ—¶æˆ‘æœ‰ä¸ªç–‘é—®è¯·æ•™ä¸€ä¸‹å¤§å®¶ï¼Œå°±æ˜¯å‘å¸ƒåˆ°æœåŠ¡å™¨ä¸Šåæˆ‘ç”¨æ˜æ–‡æ¨¡å¼å¯ä»¥æ­£å¸¸å¤„ç†å¾®ä¿¡æ¶ˆæ¯ï¼Œä½†æ˜¯å®‰å…¨æ¨¡å¼å´ä¸è¡Œäº†ï¼Œä¹Ÿæ­£ç¡®çš„é…ç½®äº†ç›¸å…³çš„EncodingAESKey</strong></p>
<blockquote>
<p>ä½œè€…ï¼šç¨‹åºå‘˜å¥¶ç‰› <br><br>
ä¸ªäººå¼€æºç½‘ç«™<a href="https://www.xiandanplay.com" target="_blank" rel="noopener nofollow">ï¼šhttps://www.xiandanplay.com</a><br>
æºç åœ°å€<a href="https://gitee.com/MrHanchichi/xian-dan" target="_blank" rel="noopener nofollow">ï¼šhttps://gitee.com/MrHanchichi/xian-dan</a></p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="4.492122774430555" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-11 14:29">2025-02-09 17:18</span>&nbsp;
<a href="https://www.cnblogs.com/MrHanBlog">ç¬ä¸¶</a>&nbsp;
é˜…è¯»(<span id="post_view_count">49</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18706316" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18706316);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18706316', targetLink: 'https://www.cnblogs.com/MrHanBlog/p/18706316', title: 'ç½‘ç«™é›†æˆå¾®ä¿¡å…¬ä¼—å·ï¼ˆè®¢é˜…å·ï¼‰ç™»å½•' })">ä¸¾æŠ¥</a>
</div>
        