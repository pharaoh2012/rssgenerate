
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lulight/p/19014129" title="发布于 2025-07-30 21:40">
    <span role="heading" aria-level="2">【Container App】Container App无法从Container Registries 拉取镜像 - 报错 403 Forbidden</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1>问题描述</h1>
<p>基于目前对Azure的资源的安全性合规要求，都需要开启防火墙并且关闭公网访问。 当ACR ( Azure Container Registries )启用了防火墙并关闭公网访问后。</p>
<p>引起了一个新的问题：Container App无法拉取ACR中的镜像！</p>
<p><img alt="image" width="666" height="378" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2127802/202507/2127802-20250730210330429-2096399845.png" class="lazyload"></p>
<p>错误信息：</p>
<blockquote>
<p>{"TimeStamp":"2025-07-30 12:58:24.9603413 \u002B0000 UTC","Type":"Warning","ContainerAppName":"xxxxx","RevisionName":"xxxxx--0000001","ReplicaName":"xxxxx--0000001-56db958c8b-k97xk","Msg":"Container \u0027xxxxx\u0027 was terminated with exit code \u0027\u0027 and reason \u0027<strong><span style="color: rgba(255, 0, 0, 1)">ImagePullFailure</span></strong>\u0027. Pull image: xxxxxxx.azurecr.cn/mynodejsalbum:v1 failed with exit code: 1, error: time=\u00222025-07-30T12:58:24Z\u0022 level=info msg=\u0022trying next host\u0022 error=\u0022failed to authorize: failed to fetch anonymous token: unexpected status from GET request to https://xxxxxxx.azurecr.cn/oauth2/token?scope=repository%3Amynodejsalbum%3Apull\u0026service=xxxxxxx.azurecr.cn: <span style="color: rgba(255, 0, 0, 1)"><strong>403 Forbidden</strong></span>\u0022 host=xxxxxxx.azurecr.cn\nctr: failed to resolve reference \u0022xxxxxxx.azurecr.cn/mynodejsalbum:v1\u0022: failed to authorize: failed to fetch anonymous token: unexpected status from GET request to https://xxxxxxx.azurecr.cn/oauth2/token?scope=repository%3Amynodejsalbum%3Apull\u0026service=xxxxxxx.azurecr.cn: 403 Forbidden\n.","Reason":"ContainerTerminated","EventSource":"ContainerAppController","Count":1}</p>
</blockquote>
<h1>问题解答</h1>
<p>这个问题的原因有两点：</p>
<p>1） ACR 中没有设置允许ACA访问的白名单</p>
<p>2） ACA的出口IP地址并不固定。它可能会使用所在数据中心的出口IP段中的某一个IP，如果要指定固定的出口IP，需要使用NAT Gateway来实现！</p>
<p>&nbsp;</p>
<p>基于以上原因，这里推荐使用ACR的Private Endpint来解决访问403问题 (&nbsp;<a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-private-link" target="_blank" rel="noopener nofollow">https://learn.microsoft.com/en-us/azure/container-registry/container-registry-private-link</a>&nbsp;)</p>
<blockquote>
<p>PS: 为何在启用了Azure Trusted Services后，Azure数据中心的服务也无法访问呢？ 原因是目前ACR指支持四种服务可以Bypass访问。ACA不在其中！</p>
<ol>
<li>Azure Container Instances</li>
<li>Microsoft Defender for Cloud</li>
<li>Machine Learning Azure</li>
<li>Container Registry</li>
</ol></blockquote>
<p>&nbsp;</p>
<p>配置Private Endpint的步骤简单，但是需要注意：必须选择与ACA所在的VNET相通的网络(同一个VNET或之间有peering) 。&nbsp;</p>
<p>最好 最好 是启用Private Endpint后，在ACA中使用 curl -v https://&lt;yourACRhost&gt; 来验证是否是私网IP地址，是否可以连通！</p>
<p>如下图测试结果：</p>
<p><img alt="image" width="666" height="190" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2127802/202507/2127802-20250730213808484-1866796768.png" class="lazyload"></p>
<p>&nbsp;</p>
<p>PS：如果在配置Container App的页面中发现无法列出当前ACR的镜像列表，这是因为当前浏览器所在的环境的IP地址无法访问ACR，在ACR中添加当前IP地址访问后就可以解决此问题！</p>
<p><img alt="image" width="666" height="316" loading="lazy" style="border: 2px solid rgba(0, 0, 139, 1)" data-src="https://img2024.cnblogs.com/blog/2127802/202507/2127802-20250730213404306-1016316377.png" class="lazyload"></p>
<p>&nbsp;</p>
<h1>参考资料</h1>
<p>Trusted services ：<a href="https://learn.microsoft.com/en-us/azure/container-registry/allow-access-trusted-services" target="_blank" rel="noopener nofollow">https://learn.microsoft.com/en-us/azure/container-registry/allow-access-trusted-services</a></p>
<p>Connect privately to an Azure container registry using Azure Private Link ： <a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-private-link" target="_blank" rel="noopener nofollow">https://learn.microsoft.com/en-us/azure/container-registry/container-registry-private-link</a></p>
<p>&nbsp;</p>
</div>
<div id="MySignature" role="contentinfo">
    <div style="background: #1c5f55;height: 36px;width: 618px;padding: 14px 5px 0px 3px;">
  <p style="
    font-weight: bold;
    color: white;
">当在复杂的环境中面临问题，格物之道需：浊而静之徐清，安以动之徐生。 云中，恰是如此!</p>
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-30 21:40">2025-07-30 21:40</span>&nbsp;
<a href="https://www.cnblogs.com/lulight">路边两盏灯</a>&nbsp;
阅读(<span id="post_view_count">59</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19014129);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19014129', targetLink: 'https://www.cnblogs.com/lulight/p/19014129', title: '【Container App】Container App无法从Container Registries 拉取镜像 - 报错 403 Forbidden' })">举报</a>
</div>
        