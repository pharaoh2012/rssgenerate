
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zjdxr-up/p/19027647" title="发布于 2025-08-08 10:26">
    <span role="heading" aria-level="2">Influxdb订阅与kapacitor使用梳理</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>转载请注明出处：</p>
<h3>一、订阅功能的核心作用</h3>
<p class="ds-markdown-paragraph">InfluxDB 的订阅是一种&nbsp;数据自动推送机制，当指定数据库的写入操作发生时，InfluxDB 会&nbsp;实时复制数据&nbsp;并推送到预先配置的端点（如 Kapacitor）。</p>
<h4>类比说明：</h4>
<ul>
<li>
<p class="ds-markdown-paragraph">类似于 MySQL 的 Binlog 复制</p>
</li>
<li>
<p class="ds-markdown-paragraph">或 Kafka 的 Producer-Consumer 模型</p>
</li>
</ul>
<h3>二、订阅的工作原理</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://img2024.cnblogs.com/blog/1110857/202508/1110857-20250807223848060-364416446.png" alt="image" loading="lazy"></p>
<ol start="1"><ol start="1">
<li>
<p class="ds-markdown-paragraph">数据路径<br><code>写入请求 → InfluxDB存储引擎 → 订阅分发器 → HTTP推送 → 接收端</code></p>



</li>
<li>
<p class="ds-markdown-paragraph">协议支持</p>
<ul>
<li>
<p class="ds-markdown-paragraph">默认使用 HTTP 协议（可配置 HTTPS）</p>



</li>
<li>
<p class="ds-markdown-paragraph">数据格式与 InfluxDB 行协议（Line Protocol）一致</p>



</li>



</ul>



</li>



</ol></ol>
<h3>三、订阅的配置方法</h3>
<h4>1. 创建订阅</h4>
<div class="cnblogs_code">
<pre>--<span style="color: rgba(0, 0, 0, 1)"> 基本语法
CREATE SUBSCRIPTION </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">&lt;订阅名称&gt;</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> 
ON </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">&lt;数据库&gt;</span><span style="color: rgba(128, 0, 0, 1)">"</span>.<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">&lt;保留策略&gt;</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> 
DESTINATIONS </span>&lt;ALL|ANY&gt; <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">&lt;协议&gt;://&lt;主机&gt;:&lt;端口&gt;/&lt;路径&gt;</span><span style="color: rgba(128, 0, 0, 1)">"</span>

--<span style="color: rgba(0, 0, 0, 1)"> 实际示例（推送到Kapacitor）
CREATE SUBSCRIPTION </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">kapacitor-sub</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> 
ON </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">monitor</span><span style="color: rgba(128, 0, 0, 1)">"</span>.<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rp30</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)"> 
DESTINATIONS ALL </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">http://kapacitor:9092</span><span style="color: rgba(128, 0, 0, 1)">'</span></pre>
</div>
<h4>2. 参数说明</h4>
<div class="markdown-table-wrapper">
<table style="height: 181px; width: 771px">
<thead>
<tr><th>参数</th><th>说明</th><th>示例值</th></tr>
</thead>
<tbody>
<tr>
<td><code>ALL</code></td>
<td>发送到所有目标</td>
<td><code>ALL</code>&nbsp;或&nbsp;<code>ANY</code></td>
</tr>
<tr>
<td><code>ANY</code></td>
<td>发送到任意一个可用目标</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>协议</td>
<td>支持&nbsp;<code>http</code>/<code>https</code>/<code>udp</code></td>
<td><code>http</code></td>
</tr>
<tr>
<td>路径</td>
<td>Kapacitor 需使用&nbsp;<code>/write</code></td>
<td><code>/kapacitor/v1/write</code></td>
</tr>
</tbody>
</table>
<h3>四、订阅的管理与查看</h3>
<h4>1. 查看所有订阅</h4>
<div class="cnblogs_code">
<pre>--<span style="color: rgba(0, 0, 0, 1)"> 查看特定数据库的订阅
SHOW SUBSCRIPTIONS ON </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">monitor</span><span style="color: rgba(128, 0, 0, 1)">"</span>

--<span style="color: rgba(0, 0, 0, 1)"> 输出示例：
name: monitor
retention_policy name            mode destinations
</span>--------------- ----            ---- ------------<span style="color: rgba(0, 0, 0, 1)">
rp30           kapacitor</span>-sub    ALL  [http:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">kapacitor:9092]</span></pre>
</div>
<h4>2. 删除订阅</h4>
<div class="cnblogs_code">
<pre>DROP SUBSCRIPTION <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">kapacitor-sub</span><span style="color: rgba(128, 0, 0, 1)">"</span> ON <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">monitor</span><span style="color: rgba(128, 0, 0, 1)">"</span>.<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rp30</span><span style="color: rgba(128, 0, 0, 1)">"</span></pre>
</div>
<h4>3. 查看订阅状态（需监控端点）</h4>
<div class="cnblogs_code">
<pre>kapacitor stats ingress</pre>
</div>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://img2024.cnblogs.com/blog/1110857/202508/1110857-20250807224143710-525198275.png" alt="image" width="547" height="397" loading="lazy"></p>
<p>&nbsp;</p>
<h3>五、订阅的核心特点</h3>
<h4>1.&nbsp;实时性</h4>
<ul>
<li>
<p class="ds-markdown-paragraph">数据写入 InfluxDB 后&nbsp;毫秒级&nbsp;推送到订阅端</p>
</li>
<li>
<p class="ds-markdown-paragraph">对比查询拉取模式，延迟降低 90% 以上</p>
</li>
</ul>
<h4>2.&nbsp;可靠性</h4>
<div class="markdown-table-wrapper">
<table style="height: 145px; width: 942px">
<thead>
<tr><th>保障机制</th><th>说明</th></tr>
</thead>
<tbody>
<tr>
<td>重试机制</td>
<td>默认重试 3 次（可配置）</td>
</tr>
<tr>
<td>离线缓存</td>
<td>网络中断时缓存 1000 条数据（默认）</td>
</tr>
<tr>
<td>数据去重</td>
<td>通过 UUID 避免重复推送</td>
</tr>
</tbody>
</table>
</div>
<h3>六、Kapacitor日志分析数据写入</h3>
<p>　查看kapacitor得日志：</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://img2024.cnblogs.com/blog/1110857/202508/1110857-20250807224630199-1761663921.png" alt="image" width="947" height="236" loading="lazy"></p>
<h3>（1）数据来源</h3>
<ul>
<li>
<p class="ds-markdown-paragraph">InfluxDB 订阅推送：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">InfluxDB 的&nbsp;<code>monitor.rp30</code>&nbsp;数据通过&nbsp;HTTP POST&nbsp;推送到 Kapacitor 的&nbsp;<code>/write</code>&nbsp;端点。</p>
</li>
<li>
<p class="ds-markdown-paragraph">触发条件：InfluxDB 的&nbsp;<code>CREATE SUBSCRIPTION</code>&nbsp;配置生效。</p>
</li>
</ul>
</li>
</ul>
<h3>（2）数据内容</h3>
<ul>
<li>
<p class="ds-markdown-paragraph">数据库：<code>monitor</code></p>
</li>
<li>
<p class="ds-markdown-paragraph">保留策略：<code>rp30</code></p>
</li>
<li>
<p class="ds-markdown-paragraph">时间精度：<code>ns</code>（纳秒级时间戳）</p>
</li>
<li>
<p class="ds-markdown-paragraph">一致性级别：未指定（默认&nbsp;<code>all</code>）</p>
</li>
</ul>
<h3>（3）Kapacitor 处理</h3>
<ul>
<li>
<p class="ds-markdown-paragraph">成功接收（<code>status=204</code>）：</p>
<ul>
<li>
<p class="ds-markdown-paragraph">Kapacitor 正确接收数据，未返回内容（<code>204 No Content</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3>七、Kapacitor命令分析</h3>
<table style="height: 145px; width: 949px">
<thead>
<tr><th>命令</th><th>作用</th><th>与&nbsp;<code>ingress</code>&nbsp;的关联性</th></tr>
</thead>
<tbody>
<tr>
<td><code>kapacitor stats&nbsp;general</code></td>
<td>查看任务处理状态</td>
<td>若&nbsp;<code>ingress</code>&nbsp;有数据但任务无处理，需检查任务逻辑</td>
</tr>
<tr>
<td><code>kapacitor stats egress</code></td>
<td>查看数据输出（如HTTP告警发送）</td>
<td>确认数据是否被正确处理并转发</td>
</tr>
<tr>
<td><code>influx -execute "SHOW STATS"</code></td>
<td>查看InfluxDB推送统计</td>
<td>对比InfluxDB发送量与Kapacitor接收量</td>
</tr>
</tbody>
</table>
<h3>（1）kapacitor stats egress</h3>
<p>　　典型输出示例：</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">Database   Retention Policy Measurement Points Received
</span>---------  --------------- ----------- ---------------<span style="color: rgba(0, 0, 0, 1)">
monitor    rp30            cpu         </span><span style="color: rgba(128, 0, 128, 1)">1500</span><span style="color: rgba(0, 0, 0, 1)">
_kapacitor autogen         edges       </span><span style="color: rgba(128, 0, 128, 1)">39451</span></pre>
</div>
<table style="height: 181px; width: 1033px">
<thead>
<tr><th>字段</th><th>说明</th></tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td>数据来源的数据库名（如&nbsp;<code>monitor</code>）</td>
</tr>
<tr>
<td>Retention Policy</td>
<td>数据所属的保留策略（如&nbsp;<code>rp30</code>）</td>
</tr>
<tr>
<td>Measurement</td>
<td>指标名称（如&nbsp;<code>cpu</code>）</td>
</tr>
<tr>
<td>Points Received</td>
<td>累计接收的数据点数（持续增长表示数据正常流动）</td>
</tr>
</tbody>
</table>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://img2024.cnblogs.com/blog/1110857/202508/1110857-20250807230308419-860724353.png" alt="image" width="620" height="289" loading="lazy"></p>
<h3>（2）kapacitor stats&nbsp;general</h3>
<div class="cnblogs_code">
<pre>root@kapacitor:/<span style="color: rgba(0, 0, 255, 1)">var</span>/log/<span style="color: rgba(0, 0, 0, 1)">kapacitor# kapacitor stats  general
ClusterID:                    183a5dd5</span>-458f-<span style="color: rgba(128, 0, 128, 1)">4923</span>-8c7c-<span style="color: rgba(0, 0, 0, 1)">d1951e1da259
ServerID:                     675c36aa</span>-e959-4a46-<span style="color: rgba(128, 0, 128, 1)">8713</span>-<span style="color: rgba(0, 0, 0, 1)">cbe86346b01c
Host:                         kapacitor
<strong><span style="background-color: rgba(153, 204, 0, 1)">Tasks:                        </span></strong></span><strong><span style="background-color: rgba(153, 204, 0, 1)"><span style="color: rgba(128, 0, 128, 1)">16</span><span style="color: rgba(0, 0, 0, 1)">
Enabled Tasks:                </span><span style="color: rgba(128, 0, 128, 1)">16</span><span style="color: rgba(0, 0, 0, 1)">
Subscriptions:                </span><span style="color: rgba(128, 0, 128, 1)">4</span></span></strong><span style="color: rgba(0, 0, 0, 1)">
Platform:                     OSS
Version:                      </span><span style="color: rgba(128, 0, 128, 1)">1.5</span>.<span style="color: rgba(128, 0, 128, 1)">9</span><span style="color: rgba(0, 0, 0, 1)">
root@kapacitor:</span>/<span style="color: rgba(0, 0, 255, 1)">var</span>/log/kapacitor#</pre>
</div>
<p>　　可以查看订阅任务得数量</p>
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-08-08 10:27">2025-08-08 10:26</span>&nbsp;
<a href="https://www.cnblogs.com/zjdxr-up">香吧香</a>&nbsp;
阅读(<span id="post_view_count">15</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19027647);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19027647', targetLink: 'https://www.cnblogs.com/zjdxr-up/p/19027647', title: 'Influxdb订阅与kapacitor使用梳理' })">举报</a>
</div>
        