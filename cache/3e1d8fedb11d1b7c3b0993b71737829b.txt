
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/spcodhu/p/18635554" title="发布于 2024-12-27 13:47">
    <span role="heading" aria-level="2">在 Ubuntu 上搭建 MinIO 服务器</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        本文介绍在服务器上单节点单硬盘部署 MinIO，并为其配置域名访问的过程。并给出了 SpringBoot 和 Flask 访问 API 实现文件上传下载的示例。
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>在日常开发时，如果有文件上传下载的需求（比如用户头像），但是又不想使用对象存储，那么自己搭建一个 MinIO 服务器是一个比较简单的解决方案。</p>
</blockquote>
<p>MinIO 是一个基于 Apache License v2.0 开源协议的对象存储服务。它兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等，而一个对象文件可以是任意大小，从 几kb 到最大 5T 不等。</p>
<p>MinIO是一个非常轻量的服务,可以很简单的和其他应用的结合，类似 NodeJS, Redis 或者 MySQL。</p>
<hr>
<p>MinIO 中文网站：<a href="https://www.minio.org.cn/docs/minio/linux/operations/installation.html" target="_blank" rel="noopener nofollow">https://www.minio.org.cn/docs/minio/linux/operations/installation.html</a></p>
<h2 id="TsCjX">部署 MinIO 并修改 minioadmin 的账户密码</h2>
本文主要介绍在 Ububtu 上单节点单硬盘部署 MinIO，步骤如下：
<p>下载 MinIO 服务器</p>
<pre><code class="language-shell">wget https://dl.min.io/server/minio/release/linux-amd64/minio
</code></pre>
<p>为 MinIO 二进制文件添加执行权限</p>
<pre><code class="language-shell">chmod +x minio
</code></pre>
<p>在合适的位置创建一个文件夹，用于存储 MinIO 上传的文件数据</p>
<pre><code class="language-shell"># 在根目录创建 minio-data 文件夹，存储 MinIO 上传的文件数据
mkdir ~/minio-data
</code></pre>
<p>安装 MinIO。将 MinIO 的二进制文件移到 <code>/usr/local/bin/</code>目录下，以使其全局可用</p>
<pre><code class="language-shell">sudo mv minio /usr/local/bin/
</code></pre>
<p>使用持久化环境变量作为 MinIO console 的登录账户和密码。</p>
<p>编辑 <code>.bashrc</code>文件，这里使用 nano。</p>
<pre><code class="language-shell">nano ~/.bashrc
</code></pre>
<p>在文件的最后加上环境变量</p>
<pre><code class="language-shell">export MINIO_ROOT_USER=newrootuser
export MINIO_ROOT_PASSWORD=newrootpassword
</code></pre>
<p>重新加载<code>.bashrc</code>以使更改生效</p>
<pre><code class="language-shell">source ~/.bashrc
</code></pre>
<p>启动 MinIO</p>
<pre><code class="language-shell">nohup minio server --secure ~/minio-data
</code></pre>
<p>这里使用<code>nohup</code>确保会话关闭之后 MinIO 不会停止，也可以使用<code>screen</code>等会话技术，或者将 MinIO 作为一个服务启动。这里不做过多介绍。</p>
<p>启动 MinIO 之后，在浏览器访问 ip+9000 端口即可访问 MinIO 的 Web 控制台。如果访问不了，<strong>请先检查 MinIO 的两个端口是否已经开放</strong>，一个是 MinIO 的 WebUI 端口，这个是随机的；一个是 MinIO 的 API 端口，这个固定是 9000。</p>
<p>在浏览器访问 ip+9000 实际会跳转到 WebUI 的端口。但是在使用 API 上传下载文件需要使用 9000 端口。</p>
<hr>
<h2 id="tNTpk">给 MinIO 配置域名</h2>
如果不想直接暴露 MinIO 的地址和端口，则可以使用 Nginx 给 MinIO 配置域名访问。
<p>在此之前，您需要先准备一个已备案的域名并解析到当前服务器。</p>
<p>步骤如下：</p>
<p>先安装 Nginx （如果没有的话）</p>
<pre><code class="language-shell">sudo apt-get update
sudo apt-get install nginx
</code></pre>
<p>一般不建议直接更改位于<code>/etc/nginx/nginx.conf</code>的 nginx 主配置文件。采用如下的配置方式：</p>
<p>在<code>/etc/nginx/sites-available/</code>创建新的配置文件，可以直接以当前配置的域名未文件名。我这里由于需要配置多个域名，文件名叫做<code>minio.conf</code></p>
<pre><code class="language-shell">cd /etc/nginx/sites-available/
touch minio.conf
</code></pre>
<p>书写配置文件</p>
<pre><code class="language-shell">nano minio.conf
</code></pre>
<p>配置文件示例</p>
<pre><code class="language-xml"># WebUI 配置
server {
    listen 80;
    server_name yourdomain.com; # 替换为您的域名

    location / {
        proxy_pass http://localhost:44366;  # 替换为实际的端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# API 配置
server {
    listen 80;
    server_name api.yourdomain.com; # 替换为您的API域名

    location / {
        proxy_pass http://localhost:9000;   # 替换为实际的端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
</code></pre>
<p>启用新创建的配置文件。将<code>/etc/nginx/sites-available/minio.conf</code>链接到<code>/etc/nginx/sites-enabled/</code>目录</p>
<pre><code class="language-shell">sudo ln -s /etc/nginx/sites-available/minio.conf /etc/nginx/sites-enabled/
</code></pre>
<p>可以先检查一下 nginx，确认没有语法错误</p>
<pre><code class="language-shell">nginx -t
</code></pre>
<p>重启 nginx 服务</p>
<pre><code class="language-shell">sudo systemctl restart nginx
</code></pre>
<p>此时，在本机浏览器上应该可以用域名访问 Minio console 了。</p>
<hr>
<h2 id="BMmUv">MinIO 调用示例</h2>
<h3 id="Pbriv">在 SpringBoot 中调用</h3>
先添加依赖
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.minio&lt;/groupId&gt;
        &lt;artifactId&gt;minio&lt;/artifactId&gt;
        &lt;version&gt;8.4.3&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>然后创建一个服务类来实现文件的上传下载</p>
<pre><code class="language-java">import io.minio.*;
import io.minio.messages.Item;

import java.io.InputStream;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.UUID;

@Service
public class MinIOService {

    private final MinioClient minioClient;

    public MinIOService() {
        try {
            // 配置更改成自己的，建议写在配置文件中
            this.minioClient = MinioClient.builder()
                    .endpoint("http://localhost:9000")
                    .credentials("minioadmin", "minioadmin")
                    .build();
        } catch (MinioException e) {
            throw new RuntimeException("Failed to create MinioClient", e);
        }
    }

    public String uploadFile(String bucketName, String objectName, InputStream stream, long size) {
        try {
            minioClient.putObject(bucketName, objectName, stream, size);
            return "File uploaded successfully.";
        } catch (MinioException | IOException e) {
            throw new RuntimeException("File upload failed.", e);
        }
    }

    public InputStream downloadFile(String bucketName, String objectName) {
        try {
            return minioClient.getObject(bucketName, objectName);
        } catch (MinioException | IOException e) {
            throw new RuntimeException("File download failed.", e);
        }
    }
}
</code></pre>
<p>并为其书写对应的 Controller</p>
<pre><code class="language-java">import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.InputStreamResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;

@RestController
@RequestMapping("/minio")
public class MinIOController {

    @Autowired
    private MinIOService minIOService;

    @PostMapping("/upload")
    public String uploadFile(@RequestParam("file") MultipartFile file) {
        String bucketName = "my-bucket";
        String objectName = UUID.randomUUID().toString();
        try (InputStream stream = file.getInputStream()) {
            return minIOService.uploadFile(bucketName, objectName, stream, file.getSize());
        } catch (IOException e) {
            return "Failed to upload file.";
        }
    }

    @GetMapping("/download/{objectName}")
    public ResponseEntity&lt;Resource&gt; downloadFile(@PathVariable String objectName) {
        String bucketName = "my-bucket";
        InputStream stream = minIOService.downloadFile(bucketName, objectName);
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + objectName + "\"")
                .body(new InputStreamResource(stream));
    }
}
</code></pre>
<h3 id="Ghth8">在 Flask 中调用</h3>
下载依赖
<pre><code class="language-shell">pip install minio
</code></pre>
<p>然后创建一个 Flask 来集成 MinIO</p>
<pre><code class="language-python">from flask import Flask, request, send_file, jsonify
from minio import Minio
from minio.error import S3Error

app = Flask(__name__)

# MinIO配置
minio_client = Minio(
    # 更改成自己的
    "localhost:9000",
    access_key="minioadmin",
    secret_key="minioadmin",
    secure=False
)

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files['file']
    bucket_name = 'my-bucket'
    object_name = file.filename
    try:
        with open('/tmp/' + object_name, 'wb') as f:
            f.write(file.read())
        minio_client.fput_object(bucket_name, object_name, '/tmp/' + object_name)
        return jsonify({'message': 'File uploaded successfully'}), 200
    except S3Error as exc:
        return jsonify({'error': str(exc)}), 500

@app.route('/download/&lt;object_name&gt;', methods=['GET'])
def download_file(object_name):
    bucket_name = 'my-bucket'
    try:
        response = minio_client.get_object(bucket_name, object_name)
        return send_file(
            response.stream,
            as_attachment=True,
            attachment_filename=object_name,
            mimetype=response.headers['content-type']
        )
    except S3Error as exc:
        return jsonify({'error': str(exc)}), 500

if __name__ == '__main__':
    app.run(debug=True)
</code></pre>
<h2 id="itacO">推荐阅读</h2>
MinIO Plus：https://mp.weixin.qq.com/s/kSkC3X-SQqo5GzXt-H66xw

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.5266004735601851" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2024-12-27 13:49">2024-12-27 13:47</span>&nbsp;
<a href="https://www.cnblogs.com/spcodhu">spcodhu</a>&nbsp;
阅读(<span id="post_view_count">190</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18635554" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18635554);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18635554', targetLink: 'https://www.cnblogs.com/spcodhu/p/18635554', title: '在 Ubuntu 上搭建 MinIO 服务器' })">举报</a>
</div>
        