
		<h2>
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wenlf136/p/18822898" title="发布于 2025-04-13 09:02">
    <span role="heading" aria-level="2">麒麟V10部署ROCEv2网卡配置步骤</span>
    

</a>

		</h2>
		<div class="postText"><div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="以下是为麒麟服务器版v10配置rocev2的步骤">以下是为麒麟服务器版V10配置RoCEv2的步骤：</h2>
<h2 id="第一步确认硬件和驱动支持">第一步：确认硬件和驱动支持</h2>
<p>在开始配置之前，首先要确保你的服务器硬件满足要求。通常需要<strong>Mellanox ConnectX系列网卡</strong>（例如mlx5系列），并且已安装最新的OFED驱动包。可以通过以下命令检查驱动状态：</p>
<pre><code class="language-bash">modinfo mlx5_core  # 查看内核模块信息
lspci | grep Mellanox  # 确认网卡型号
</code></pre>
<h2 id="如果发现驱动未正确加载需要从mellanox官网下载对应版本的驱动并安装">如果发现驱动未正确加载，需要从Mellanox官网下载对应版本的驱动并安装。</h2>
<h2 id="第二步切换网卡到rocev2模式">第二步：切换网卡到RoCEv2模式</h2>
<p>默认情况下，RDMA可能运行在RoCEv1模式（基于以太网二层），而RoCEv2需要切换到三层IP模式。使用<code>cma_roce_mode</code>工具调整（假设网卡设备名为<code>mlx5_1</code>）：</p>
<pre><code class="language-bash">cma_roce_mode -d mlx5_1 -p 1 -m 2
</code></pre>
<h2 id="这里的-m-2表示启用rocev2完成后建议通过dmesg--grep-rdma查看内核日志确认模式切换成功">这里的<code>-m 2</code>表示启用RoCEv2。完成后，建议通过<code>dmesg | grep RDMA</code>查看内核日志，确认模式切换成功。</h2>
<h2 id="第三步配置流量控制和优先级">第三步：配置流量控制和优先级</h2>
<p>RoCEv2对网络质量敏感，需配合<strong>DCQCN（动态拥塞控制）</strong>和<strong>PFC（优先级流控制）</strong>。假设网卡接口名为<code>ens1np0</code>，需在系统中设置：</p>
<ol>
<li><strong>开启ECN和优先级</strong>：<br>
将优先级3（通常用于RoCE流量）的ECN功能启用：<pre><code class="language-bash">echo 1 &gt; /sys/class/net/ens1np0/ecn/roce_np/enable/3
echo 1 &gt; /sys/class/net/ens1np0/ecn/roce_rp/enable/3
</code></pre>
</li>
<li><strong>标记CNP报文</strong>：<br>
设置拥塞通知报文（CNP）的DSCP值和802.1p优先级：<pre><code class="language-bash">echo 48 &gt; /sys/class/net/ens1np0/ecn/roce_np/cnp_dscp  # DSCP=48
echo 6 &gt; /sys/class/net/ens1np0/ecn/roce_np/cnp_802p_prio  # 802.1p优先级6
</code></pre>
</li>
</ol>
<hr>
<h2 id="第四步优化网卡队列调度">第四步：优化网卡队列调度</h2>
<p>通过Mellanox的<code>mlnx_qos</code>工具调整QoS策略，确保RoCE流量获得足够的带宽。例如，为优先级3分配更高的权重：</p>
<pre><code class="language-bash">mlnx_qos -i ens1np0 --trust=dscp  # 信任DSCP标记
mlnx_qos -i ens1np0 -f 0,0,0,1,0,0,0,0  # 在优先级3启用PFC
mlnx_qos -i ens1np0 -s ets,ets,ets,ets,ets,ets,strict,strict -t 10,10,10,50,10,10,0,0  # 队列权重分配
</code></pre>
<h2 id="这一步的关键是让优先级3对应rocev2流量的队列获得更高的带宽比例避免其他流量抢占资源">这一步的关键是让优先级3（对应RoCEv2流量）的队列获得更高的带宽比例，避免其他流量抢占资源。</h2>
<h2 id="第五步配置交换机端">第五步：配置交换机端</h2>
<p>如果服务器连接到交换机，需确保交换机配置与网卡一致。例如：</p>
<ul>
<li>在交换机上启用<strong>基于DSCP的PFC</strong>，并针对DSCP=48（即优先级3）开启流控。</li>
<li>确认交换机的ECN功能已启用，并与服务器的DSCP/802.1p映射匹配。<br>
具体配置命令因交换机型号而异，建议参考交换机厂商的文档。</li>
</ul>
<hr>
<h2 id="第六步验证配置">第六步：验证配置</h2>
<p>最后一步是测试RoCEv2是否正常工作。推荐使用<code>ib_send_bw</code>工具进行带宽测试：<br>
<strong>服务端：</strong></p>
<pre><code class="language-bash">ib_send_bw -d mlx5_1 --report_gbits -F -R
</code></pre>
<p><strong>客户端：</strong></p>
<pre><code class="language-bash">ib_send_bw -d mlx5_1 --report_gbits -F -R &lt;服务端IP&gt;
</code></pre>
<h2 id="如果看到稳定的高带宽例如25gbps或100gbps取决于网卡型号说明配置成功若出现丢包或低带宽可以通过ethtool--s-ens1np0检查网卡统计信息或使用wireshark抓包分析ecn和cnp报文">如果看到稳定的高带宽（例如25Gbps或100Gbps，取决于网卡型号），说明配置成功。若出现丢包或低带宽，可以通过<code>ethtool -S ens1np0</code>检查网卡统计信息，或使用Wireshark抓包分析ECN和CNP报文。</h2>
<h2 id="注意事项">注意事项</h2>
<ul>
<li><strong>网络服务重启</strong>：配置完成后，建议重启网络服务使设置生效：<pre><code class="language-bash">systemctl restart NetworkManager  # 或传统network服务
</code></pre>
</li>
<li><strong>内核参数</strong>：如果使用网卡绑定（bonding），需在<code>/etc/modprobe.d/bonding.conf</code>中配置<code>miimon=100 mode=4</code>（802.3ad动态聚合）。</li>
<li><strong>固件升级</strong>：如果遇到兼容性问题，可能需要升级网卡固件。</li>
</ul>
<hr>
<p>通过以上步骤，你应该能在麒麟V10上成功部署RoCEv2。如果在操作中遇到问题，可以优先检查驱动版本和交换机配置是否匹配，这是最常见的故障点。</p>

</div>
<div class="clear"></div>
</div>
		<p class="postfoot">
			posted on 
<span id="post-date" data-last-update-days="0.5502524825219908" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-13 09:02">2025-04-13 09:02</span>&nbsp;
<a href="https://www.cnblogs.com/wenlf136">wenlf136</a>&nbsp;
阅读(<span id="post_view_count">65</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18822898);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18822898', targetLink: 'https://www.cnblogs.com/wenlf136/p/18822898', title: '麒麟V10部署ROCEv2网卡配置步骤' })">举报</a>

		</p>
	