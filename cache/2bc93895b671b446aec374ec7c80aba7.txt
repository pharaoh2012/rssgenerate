
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kqdssheng/p/18748804" title="发布于 2025-03-03 17:42">
    <span role="heading" aria-level="2">Windows 提权-不安全的 GUI 程序</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>本文通过 Google 翻译 <a href="https://juggernaut-sec.com/insecure-gui-applications/" target="_blank" rel="noopener nofollow">Insecure GUI Applications – Windows Privilege Escalation</a> 这篇文章所产生，本人仅是对机器翻译中部分表达别扭的字词进行了校正及个别注释补充。</p>
</blockquote>
<hr>
<h2 id="导航">导航</h2>
<ul>
<li><a href="#id0" rel="noopener nofollow">0 前言</a></li>
<li><a href="#id1" rel="noopener nofollow">1 查找高权限的 GUI 程序</a></li>
<li><a href="#id2" rel="noopener nofollow">2 从不安全的 GUI 程序转移到 CMD 命令窗口</a></li>
<li><a href="#id3" rel="noopener nofollow">3 CVE-2019-1388 – hhupd.exe 案例研究</a></li>
</ul>
<hr>
<h2 id="0前言"><strong><div id="id0">0、前言</div></strong></h2>
<p>在这篇文章中，我们将介绍如何滥用不安全的 GUI 应用程序来实现对 Windows 系统的权限提升。</p>
<p>首先，假设我们在桌面上找到一个应用程序的快捷方式，然后执行该程序。执行后，检查正在运行的进程，发现应用程序是以 Administrator 身份运行的。然后，通过一些操作跳出该应用程序并进入到 Administrator 身份的 shell 中。此外，我们还将查看另一个可以以类似的方式滥用的 GUI 应用程序：hhupd.exe。</p>
<blockquote>
<p>Windows 中的应用程序可以被这样配置：普通用户能够被授予管理员特权来运行特定的 GUI 应用程序，以便程序需要提升的权限来执行某些功能。【注：这类似于 Linux 中针对应用程序的 SUID 特权或 Capabilities 属性。】</p>
</blockquote>
<h2 id="1查找高权限的-gui-程序"><strong><div id="id1">1、查找高权限的 GUI 程序</div></strong></h2>
<p>由于本文所展示的示例均需要在 GUI 图形化界面进行。因此，假设我们已经获得了普通用户 bob 的凭证，并且能够使用远程桌面登录。</p>
<pre><code class="language-bash">sudo xfreerdp /u:bob /p:'P@ssw0rd' /v:172.16.1.250 +clipboard
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044015-994421981.png" alt="" loading="lazy"></p>
<p>现在我们已经在目标机器上站稳了脚跟，同时也看到桌面上有一个 Procmon 程序，而这引起了我们的兴趣。众所周知，Procmon 程序需要以管理员权限运行才能查看所有进程。</p>
<blockquote>
<p>注：Procmon 的历史版本可在<a href="https://process-monitor.cn.uptodown.com/windows/versions" target="_blank" rel="noopener nofollow">此处</a>获得。</p>
</blockquote>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044557-1836363317.png" alt="" loading="lazy"></p>
<p>我们可以执行该程序，然后使用 tasklist 命令检查正在运行的进程，或者通过任务管理器检查正在运行的进程。</p>
<p>启动程序后，可以通过以下命令查看程序正在运行的权限级别：</p>
<pre><code class="language-cmd">tasklist /V | findstr -i "procmon"
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045484-1122412856.png" alt="" loading="lazy"></p>
<p>同样，也可以利用任务管理器来查看此进程的信息。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044317-1939365864.png" alt="" loading="lazy"></p>
<p>Amazing！可以看到该程序正以 Administrator 身份运行，那我们该如何滥用它呢？— 很简单，只需“open”一个 cmd.exe 命令并中断应用程序即可！</p>
<blockquote>
<p>注：我在 win10 的最后一个版本中运行 procmon 程序时，它并不能够正常运行且电脑进程会不断增多使得电脑变得很卡。</p>
</blockquote>
<h2 id="2从不安全的-gui-程序转移到-cmd-命令窗口"><strong><div id="id2">2、从不安全的 GUI 程序转移到 CMD 命令窗口</div></strong></h2>
<p>通常有许多办法可以从 GUI 应用程序去启动 cmd.exe，但在这，我们主要是想通过 Windows 自带的功能去实现。由于父进程（Procmon）是以管理员权限运行的，因此我们可以生成一个以相同级别的权限运行的 cmd.exe 子进程。</p>
<p>GUI 应用程序通常都具有“打开文件”功能，幸运的是 Procmon 是有的！</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044418-638834045.png" alt="" loading="lazy"></p>
<p>单击打开后，将出现另一个窗口来浏览文件。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044217-211680939.png" alt="" loading="lazy"></p>
<p>现在到了最有趣的部分。我们只需在地址栏中键入“cmd.exe”，然后按 Enter。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044620-1423749050.png" alt="" loading="lazy"></p>
<p>此时，就会出现一个拥有管理员权限的 cmd 窗口。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174046010-1304809352.png" alt="" loading="lazy"></p>
<p>然后我们可以使用 <code>whoami /priv</code> 命令确认这是一个高完整性 shell。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174044821-820465319.png" alt="" loading="lazy"></p>
<p>Amazing！我们能够直接在一个应用程序（procmon.exe）中启动另一个程序（cmd.exe），并且二者的进程权限都是一样的！</p>
<h2 id="3cve-2019-1388--hhupdexe-案例研究"><strong><div id="id3">3、CVE-2019-1388 – hhupd.exe 案例研究</div></strong></h2>
<p>在本示例中，依旧假设我们获得了标准用户 bob 的凭证，并且能够通过远程桌面登录目标系统。不过，本次的目标系统不再是 Windows 10 而是 Windows 7 操作系统。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045038-976760610.png" alt="" loading="lazy"></p>
<p>Windows 证书对话框 (hhupd.exe) 中存在权限提升漏洞，它允许攻击者将权限提升至 SYSTEM，该漏洞目前已被记录为 CVE-2019-1388。</p>
<blockquote>
<p>hhupd.exe 被称为 HTML Help 1.32 Update，它由 Microsoft Corporation 开发。</p>
</blockquote>
<p>此 CVE 影响许多 Windows 版本，包括 Windows 7、8、10（最高版本 1903）和 Windows Server 2008 - 2019（最高版本 1903）。受影响版本的详细列表如下：</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045490-1338914423.png" alt="" loading="lazy"></p>
<p>好了，既然知道了哪些版本的 Windows 容易受到攻击，那我们看看这个漏洞是如何对 Windows 7 起作用的。</p>
<blockquote>
<p>根据我的经验，此漏洞需要 Internet Explorer 作为默认浏览器。</p>
</blockquote>
<p>如果 hhupd.exe 尚未在受害者系统上（默认情况下不会），那么我们可以将其<a href="https://github.com/jas502n/CVE-2019-1388" target="_blank" rel="noopener nofollow">副本</a>下载到攻击者机器上，然后开启 HTTP 服务器以供受害者下载。</p>
<pre><code>python3 -m http.server 80
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045480-1453582272.png" alt="" loading="lazy"></p>
<p>现在，我们将 hhupd.exe 下载到受害者桌面上，如下所示：</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045023-1762536173.png" alt="" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045056-160224466.png" alt="" loading="lazy"></p>
<p>现在到了最有趣的部分！我们需要关闭 IE，右键单击 hhupd 应用程序并选择“Run as administrator”。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045405-379617344.png" alt="" loading="lazy"></p>
<p>此时会出现 UAC 弹窗，提示输入管理员密码？但我们并没有管理员的密码，无法进行密码输入操作！而此时，就到了这个漏洞该如何利用的阶段。我们不是管理员并不重要，但我们仍然能够绕过 UAC 并获得 SYSTEM shell！</p>
<blockquote>
<p>尽管我们使用 UAC 作为提升到 SYSTEM 的手段，但从技术上讲，这并不是“UAC Bypass”。要了解有关 UAC 旁路技术的更多信息，请在<a href="https://juggernaut-sec.com/uac-bypass/" target="_blank" rel="noopener nofollow">此处</a>查看关于该主题的文章。</p>
</blockquote>
<p>单击以管理员身份运行之后，点击显示详细信息，然后单击出现有关发布者证书的信息。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045220-1768324494.png" alt="" loading="lazy"></p>
<p>好了，这就是漏洞所在。当我们单击颁发的证书时，它将以 SYSTEM 身份启动一个 IE 实例！</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045227-2093062788.png" alt="" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045448-696858343.png" alt="" loading="lazy"></p>
<p>然后，我们单击 Page 按钮，然后单击 Save As...</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045963-323517393.png" alt="" loading="lazy"></p>
<blockquote>
<p>在 Windows 10 上，有一个齿轮图标取代了“Page”选项卡。</p>
</blockquote>
<p>接着，就像之前在 Procmon 中那样，我们只需要在地址栏中键入“cmd.exe”，它就会从 IE 中跳出并生成一个 SYSTEM shell。</p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045279-960488529.png" alt="" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1503193/202503/1503193-20250303174045825-562459215.png" alt="" loading="lazy"></p>
<p>BOOM！就这样，我们滥用了 GUI 应用程序，并将普通用户权限提升到 SYSTEM！</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="1.0243334081516204" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-03 17:43">2025-03-03 17:42</span>&nbsp;
<a href="https://www.cnblogs.com/kqdssheng">扛枪的书生</a>&nbsp;
阅读(<span id="post_view_count">160</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18748804" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18748804);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18748804', targetLink: 'https://www.cnblogs.com/kqdssheng/p/18748804', title: 'Windows 提权-不安全的 GUI 程序' })">举报</a>
</div>
        