
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Amd794/p/18869122" title="发布于 2025-05-10 01:00">
    <span role="heading" aria-level="2">数据库事务回滚：FastAPI中的存档与读档大法</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<hr>
<p>title: 数据库事务回滚：FastAPI中的存档与读档大法<br>
date: 2025/05/10 00:18:52<br>
updated: 2025/05/10 00:18:52<br>
author: <a href="https://cmdragon.cn" target="_blank" rel="noopener nofollow"> cmdragon </a></p>
<p>excerpt:<br>
事务回滚机制确保数据库操作的原子性，适用于需要保持数据一致性的场景，如银行转账。FastAPI通过SQLAlchemy的session管理实现事务控制，使用上下文管理器处理事务，确保在异常时回滚。Alembic用于数据库版本控制，生成迁移脚本并管理多环境迁移策略。综合应用案例展示了用户注册时的事务处理，包括检查用户名唯一性、创建用户及其关联记录，并在异常时回滚。课后Quiz和常见报错解决提供了实际操作中的指导和问题处理方法。</p>
<p>categories:</p>
<ul>
<li>后端开发</li>
<li>FastAPI</li>
</ul>
<p>tags:</p>
<ul>
<li>事务回滚</li>
<li>FastAPI</li>
<li>SQLAlchemy</li>
<li>Alembic</li>
<li>数据库迁移</li>
<li>Web开发</li>
<li>Python</li>
</ul>
<hr>
<img src="https://static.shutu.cn/shutu/jpeg/open08/2025/05/10/69ec9a799973f9e2614fd4d8e4583abe.jpeg" title="cmdragon_cn.png" alt="cmdragon_cn.png">
<img src="https://api2.cmdragon.cn/upload/cmder/20250304_012821924.jpg" title="cmdragon_cn.png" alt="cmdragon_cn.png">
<p>扫描<a href="https://api2.cmdragon.cn/upload/cmder/20250304_012821924.jpg" target="_blank" rel="noopener nofollow">二维码</a><br>
关注或者微信搜一搜：<code>编程智域 前端至全栈交流与成长</code></p>
<p><a href="https://tools.cmdragon.cn/zh/apps?category=ai_chat" target="_blank" rel="noopener nofollow">探索数千个预构建的 AI 应用，开启你的下一个伟大创意</a>：<a href="https://tools.cmdragon.cn/" target="_blank" rel="noopener nofollow">https://tools.cmdragon.cn/</a></p>
<ol>
<li>理解事务回滚机制</li>
</ol>
<p>1.1 为什么需要事务回滚？<br>
数据库事务回滚就像游戏中的存档机制，当执行某个任务失败时，可以回到任务开始前的状态。在Web开发中，当多个数据库操作需要保持原子性时（例如银行转账操作），事务回滚确保数据的一致性。</p>
<p>1.2 FastAPI中的事务实现<br>
通过SQLAlchemy的session管理实现事务控制：</p>
<pre><code class="language-python">from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 创建数据库连接（使用SQLite示例）
DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Pydantic模型
from pydantic import BaseModel


class UserCreate(BaseModel):
    username: str
    email: str


# 数据库模型
from sqlalchemy import Column, Integer, String
from database import Base


class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True)
    email = Column(String(100))
</code></pre>
<p>1.3 事务操作最佳实践<br>
使用上下文管理器处理事务：</p>
<pre><code class="language-python">def create_user_with_profile(user_data: UserCreate):
    db = SessionLocal()
    try:
        with db.begin():
            # 创建用户
            new_user = User(**user_data.dict())
            db.add(new_user)

            # 创建用户配置（假设需要原子操作）
            db.execute("INSERT INTO profiles (user_id) VALUES (:user_id)",
                       {"user_id": new_user.id})

            return new_user
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=400, detail=str(e))
    finally:
        db.close()
</code></pre>
<ol start="2">
<li>Alembic数据版本控制</li>
</ol>
<p>2.1 迁移脚本生成<br>
安装配置Alembic：</p>
<pre><code class="language-bash">pip install alembic
alembic init migrations
</code></pre>
<p>修改alembic.ini：</p>
<pre><code class="language-ini">sqlalchemy.url = sqlite:///./test.db
</code></pre>
<p>2.2 版本管理操作流程<br>
生成新迁移脚本：</p>
<pre><code class="language-bash">alembic revision -m "add phone_number column"
</code></pre>
<p>手动编辑生成的迁移文件：</p>
<pre><code class="language-python">def upgrade():
    op.add_column('users',
                  Column('phone_number', String(20))
                  )


def downgrade():
    op.drop_column('users', 'phone_number')
</code></pre>
<p>2.3 多环境迁移策略<br>
在CI/CD中处理不同环境：</p>
<pre><code class="language-bash"># 生产环境迁移
ALEMBIC_CONFIG=prod_alembic.ini alembic upgrade head

# 回滚到指定版本
alembic downgrade -1
</code></pre>
<ol start="3">
<li>综合应用案例</li>
</ol>
<p>用户注册事务处理：</p>
<pre><code class="language-python">from fastapi import APIRouter, Depends

router = APIRouter()


@router.post("/register")
async def register_user(user: UserCreate):
    db = SessionLocal()
    try:
        with db.begin():
            # 检查用户名唯一性
            if db.query(User).filter(User.username == user.username).first():
                raise ValueError("Username already exists")

            # 创建用户
            new_user = User(**user.dict())
            db.add(new_user)

            # 创建关联记录
            profile_data = {"user_id": new_user.id, "status": "active"}
            db.execute(
                "INSERT INTO profiles (user_id, status) VALUES (:user_id, :status)",
                profile_data
            )

        return {"message": "Registration successful"}
    except ValueError as ve:
        db.rollback()
        return {"error": str(ve)}
    finally:
        db.close()
</code></pre>
<p>课后Quiz：<br>
Q: 当执行alembic downgrade命令时，系统实际执行什么操作？<br>
A: 系统会按照迁移脚本的downgrade函数定义执行数据库结构回退操作，每个版本的downgrade会逆序执行。</p>
<p>常见报错解决：<br>
问题：alembic.util.exc.CommandError: Can't locate revision identified by 'xxxx'<br>
解决步骤：</p>
<ol>
<li>检查migrations/versions目录是否存在对应版本的迁移文件</li>
<li>执行alembic history查看版本链</li>
<li>若存在断链，可删除alembic_version表后重新初始化</li>
</ol>
<p>预防建议：<br>
• 团队开发时统一管理迁移脚本<br>
• 禁止手动修改数据库版本表<br>
• 每次生成新迁移脚本后立即提交到版本控制系统</p>
<p>（完整示例代码需要安装fastapi, sqlalchemy, alembic等依赖，建议使用Python 3.8+环境，通过uvicorn main:app启动服务）</p>
<p>余下文章内容请点击跳转至 个人博客页面 或者 扫码关注或者微信搜一搜：<code>编程智域 前端至全栈交流与成长</code>，阅读完整的文章：<a href="https://blog.cmdragon.cn/posts/55a63eaa29d3/" target="_blank" rel="noopener nofollow">数据库事务回滚：FastAPI中的存档与读档大法 | cmdragon's Blog</a></p>
<h2 id="往期文章归档">往期文章归档：</h2>
<ul>
<li><a href="https://blog.cmdragon.cn/posts/24a6445f18ef/" target="_blank" rel="noopener nofollow">Alembic迁移脚本：让数据库变身时间旅行者 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/57d1e2810a31/" target="_blank" rel="noopener nofollow">数据库连接池：从银行柜台到代码世界的奇妙旅程 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/336930484b68/" target="_blank" rel="noopener nofollow">点赞背后的技术大冒险：分布式事务与SAGA模式 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/bd59ee70c62e/" target="_blank" rel="noopener nofollow">N+1查询：数据库性能的隐形杀手与终极拯救指南 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/9f5729db84ef/" target="_blank" rel="noopener nofollow">FastAPI与Tortoise-ORM开发的神奇之旅 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/62012cf83e26/" target="_blank" rel="noopener nofollow">DDD分层设计与异步职责划分：让你的代码不再“异步”混乱 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/c195d6c4d0b5/" target="_blank" rel="noopener nofollow">异步数据库事务锁：电商库存扣减的防超卖秘籍 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/f0e851eb1a74/" target="_blank" rel="noopener nofollow">FastAPI中的复杂查询与原子更新指南 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/512d338e0833/" target="_blank" rel="noopener nofollow">深入解析Tortoise-ORM关系型字段与异步查询 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/7649fa5d5b04/" target="_blank" rel="noopener nofollow">FastAPI与Tortoise-ORM模型配置及aerich迁移工具 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/c9824156400c/" target="_blank" rel="noopener nofollow">异步IO与Tortoise-ORM的数据库 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/74b39391a524/" target="_blank" rel="noopener nofollow">FastAPI数据库连接池配置与监控 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/f05753c1a8af/" target="_blank" rel="noopener nofollow">分布式事务在点赞功能中的实现 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/644d88ac6ff1/" target="_blank" rel="noopener nofollow">Tortoise-ORM级联查询与预加载性能优化 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/d7fcb94d965b/" target="_blank" rel="noopener nofollow">使用Tortoise-ORM和FastAPI构建评论系统 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/a344f0dfbdbf/" target="_blank" rel="noopener nofollow">分层架构在博客评论功能中的应用与实现 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/823cb13844de/" target="_blank" rel="noopener nofollow">深入解析事务基础与原子操作原理 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/0df919d7ff39/" target="_blank" rel="noopener nofollow">掌握Tortoise-ORM高级异步查询技巧 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/2c8d6d6e8c53/" target="_blank" rel="noopener nofollow">FastAPI与Tortoise-ORM实现关系型数据库关联 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/4b40fac9a431/" target="_blank" rel="noopener nofollow">Tortoise-ORM与FastAPI集成：异步模型定义与实践 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/ec70904aad68/" target="_blank" rel="noopener nofollow">异步编程与Tortoise-ORM框架 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/7112d376156d/" target="_blank" rel="noopener nofollow">FastAPI数据库集成与事务管理 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/ac94f11d8558/" target="_blank" rel="noopener nofollow">FastAPI与SQLAlchemy数据库集成 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/b64fbd2d819d/" target="_blank" rel="noopener nofollow">FastAPI与SQLAlchemy数据库集成与CRUD操作 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/05564696277e/" target="_blank" rel="noopener nofollow">FastAPI与SQLAlchemy同步数据库集成 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/dc3f1adccf0a/" target="_blank" rel="noopener nofollow">SQLAlchemy 核心概念与同步引擎配置详解 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/5c3e3f847f09/" target="_blank" rel="noopener nofollow">FastAPI依赖注入性能优化策略 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/d1b6b80e8665/" target="_blank" rel="noopener nofollow">FastAPI安全认证中的依赖组合 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/f5d382bc5354/" target="_blank" rel="noopener nofollow">FastAPI依赖注入系统及调试技巧 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/88761b137b82/" target="_blank" rel="noopener nofollow">FastAPI依赖覆盖与测试环境模拟 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/ef1282d9c9b8/" target="_blank" rel="noopener nofollow">FastAPI中的依赖注入与数据库事务管理 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/8b8658ec8dab/" target="_blank" rel="noopener nofollow">FastAPI依赖注入实践：工厂模式与实例复用的优化策略 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/0b359086bd7d/" target="_blank" rel="noopener nofollow">FastAPI依赖注入：链式调用与多级参数传递 | cmdragon's Blog</a></li>
<li><a href="https://blog.cmdragon.cn/posts/ef71d1b7ddfb/" target="_blank" rel="noopener nofollow">FastAPI依赖注入：从基础概念到应用 | cmdragon's Blog</a></li>
<li><a href="https://tools.cmdragon.cn/sitemap_index.xml" target="_blank" rel="noopener nofollow">XML Sitemap</a></li>
<li></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.055964079818287035" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-10 01:01">2025-05-10 01:00</span>&nbsp;
<a href="https://www.cnblogs.com/Amd794">Amd794</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18869122);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18869122', targetLink: 'https://www.cnblogs.com/Amd794/p/18869122', title: '数据库事务回滚：FastAPI中的存档与读档大法' })">举报</a>
</div>
        