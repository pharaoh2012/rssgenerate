
		<h2>
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wenlf136/p/18826300" title="发布于 2025-04-15 10:47">
    <span role="heading" aria-level="2">基于华为交换机的三层Clos架构（Leaf-Spine）配置指南</span>
    

</a>

		</h2>
		<div class="postText"><div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="基于华为交换机的三层clos架构leaf-spine配置指南">基于华为交换机的三层Clos架构（Leaf-Spine）配置指南</h1>
<hr>
<h2 id="目录">目录</h2>
<ol>
<li><a href="#1-%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99" rel="noopener nofollow">设计原则</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4" rel="noopener nofollow">配置步骤</a>
<ul>
<li><a href="#%E6%AD%A5%E9%AA%A41%E7%89%A9%E7%90%86%E8%BF%9E%E6%8E%A5%E4%B8%8E%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE" rel="noopener nofollow">物理连接与基础配置</a></li>
<li><a href="#%E6%AD%A5%E9%AA%A42%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E9%85%8D%E7%BD%AE%E4%BB%A5ospf%E4%B8%BA%E4%BE%8B" rel="noopener nofollow">路由协议配置</a></li>
<li><a href="#%E6%AD%A5%E9%AA%A43vxlanevpn%E9%85%8D%E7%BD%AE%E8%B7%A8leaf%E4%BA%8C%E5%B1%82%E6%89%A9%E5%B1%95" rel="noopener nofollow">VXLAN+EVPN配置</a></li>
<li><a href="#%E6%AD%A5%E9%AA%A44m-lag%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%8C%E5%BD%92%E6%8E%A5%E5%85%A5" rel="noopener nofollow">M-LAG高可用配置</a></li>
<li><a href="#%E6%AD%A5%E9%AA%A45bfd%E5%BF%AB%E9%80%9F%E6%A3%80%E6%B5%8B" rel="noopener nofollow">BFD快速检测</a></li>
</ul>
</li>
<li><a href="#3-%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4" rel="noopener nofollow">验证命令</a></li>
<li><a href="#4-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%8D%8E%E4%B8%BA%E7%89%B9%E5%AE%9A" rel="noopener nofollow">注意事项</a></li>
<li><a href="#5-%E7%A4%BA%E4%BE%8B%E6%8B%93%E6%89%91" rel="noopener nofollow">示例拓扑</a></li>
</ol>
<hr>
<h2 id="1-设计原则">1. 设计原则</h2>
<ul>
<li><strong>非阻塞架构</strong>：全互联拓扑，Leaf与Spine全连接。</li>
<li><strong>华为特性适配</strong>：
<ul>
<li>使用 <strong>M-LAG</strong> 替代传统MLAG实现服务器双活接入。</li>
<li>支持 <strong>BGP EVPN</strong> 作为VXLAN控制平面。</li>
<li>可选 <strong>OSPF</strong>（中小规模）或 <strong>BGP</strong>（大规模+多租户）。</li>
</ul>
</li>
<li><strong>高可靠性</strong>：通过BFD、ECMP、M-LAG实现快速故障切换。</li>
</ul>
<hr>
<h2 id="2-配置步骤">2. 配置步骤</h2>
<h3 id="步骤1物理连接与基础配置">步骤1：物理连接与基础配置</h3>
<h4 id="leaf与spine全互联">Leaf与Spine全互联</h4>
<pre><code class="language-plaintext">Leaf1 &lt;Eth-Trunk1&gt; --&gt; Spine1
Leaf1 &lt;Eth-Trunk2&gt; --&gt; Spine2
...
Leaf2 &lt;Eth-Trunk1&gt; --&gt; Spine1
Leaf2 &lt;Eth-Trunk2&gt; --&gt; Spine2
</code></pre>
<h4 id="eth-trunk配置链路聚合">Eth-Trunk配置（链路聚合）</h4>
<pre><code class="language-bash"># Leaf交换机配置（示例）
sys
interface Eth-Trunk1
  description To_Spine1
  mode lacp-static
  trunkport GigabitEthernet 0/0/1 to 0/0/4  # 4条物理链路聚合
  ip address 10.1.1.1 255.255.255.252
</code></pre>
<hr>
<h3 id="步骤2路由协议配置以ospf为例">步骤2：路由协议配置（以OSPF为例）</h3>
<h4 id="leaf交换机配置">Leaf交换机配置</h4>
<pre><code class="language-bash">sys
ospf 1 router-id 1.1.1.1
  area 0.0.0.0
    network 10.1.1.0 0.0.0.3    # Eth-Trunk1接口网段
    network 192.168.0.0 0.0.255.255  # 服务器网段
ip load-balance ecmp 8  # 启用8路径ECMP
</code></pre>
<h4 id="spine交换机配置">Spine交换机配置</h4>
<pre><code class="language-bash">sys
ospf 1 router-id 2.2.2.2
  area 0.0.0.0
    network 10.1.0.0 0.0.255.255  # Leaf-Spine互联全网段
</code></pre>
<hr>
<h3 id="步骤3vxlanevpn配置跨leaf二层扩展">步骤3：VXLAN+EVPN配置（跨Leaf二层扩展）</h3>
<h4 id="leaf交换机配置-1">Leaf交换机配置</h4>
<pre><code class="language-bash">sys
# 创建BD和VNI映射
bridge-domain 100
  vxlan vni 10010
bridge-domain 200
  vxlan vni 10020

# 配置EVPN实例
evpn vpn-instance EVPN-1
  route-distinguisher 100:1
  vpn-target 100:1 export-extcommunity
  vpn-target 100:1 import-extcommunity

# 绑定BD到EVPN
bridge-domain 100
  evpn binding vpn-instance EVPN-1
bridge-domain 200
  evpn binding vpn-instance EVPN-1

# 配置VXLAN隧道
interface Nve1
  source-address 1.1.1.1  # Leaf的Loopback地址
  vni 10010 head-end peer-list protocol bgp
  vni 10020 head-end peer-list protocol bgp

# 启用BGP EVPN
bgp 65001
  peer SPINE_GROUP as-number 65000
  peer SPINE_GROUP connect-interface LoopBack0
  ipv4-family unicast
    peer SPINE_GROUP enable
  l2vpn-family evpn
    policy vpn-target
    peer SPINE_GROUP enable
</code></pre>
<hr>
<h3 id="步骤4m-lag高可用配置服务器双归接入">步骤4：M-LAG高可用配置（服务器双归接入）</h3>
<h4 id="leaf成对配置">Leaf成对配置</h4>
<pre><code class="language-bash">sys
# 全局启用M-LAG
m-lag global
  m-lag system-mac 0001-0001-0001
  m-lag system-priority 100
  m-lag keepalive ip destination 192.168.100.1 source 192.168.100.2

# 配置M-LAG接口
interface Eth-Trunk10
  portswitch
  m-lag group 10
interface GigabitEthernet0/0/10
  eth-trunk 10
</code></pre>
<hr>
<h3 id="步骤5bfd快速检测">步骤5：BFD快速检测</h3>
<pre><code class="language-bash">sys
bfd  # 全局启用BFD
interface Eth-Trunk1
  bfd min-tx-interval 100 min-rx-interval 100 detect-multiplier 3
</code></pre>
<hr>
<h2 id="3-验证命令">3. 验证命令</h2>
<table>
<thead>
<tr>
<th>功能</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>OSPF邻居状态</td>
<td><code>display ospf peer brief</code></td>
</tr>
<tr>
<td>ECMP路由</td>
<td><code>display ip routing-table verbose</code></td>
</tr>
<tr>
<td>VXLAN隧道</td>
<td><code>display vxlan tunnel</code></td>
</tr>
<tr>
<td>EVPN对端</td>
<td><code>display evpn peer</code></td>
</tr>
<tr>
<td>M-LAG状态</td>
<td><code>display m-lag brief</code></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="4-注意事项华为特定">4. 注意事项（华为特定）</h2>
<ol>
<li><strong>License要求</strong>：
<ul>
<li>VXLAN/EVPN功能需激活对应License（如<code>L3VPN</code>和<code>VXLAN</code>）。</li>
</ul>
</li>
<li><strong>硬件兼容性</strong>：
<ul>
<li>CE6850/CE8850及以上型号支持完整VXLAN特性。</li>
</ul>
</li>
<li><strong>配置同步</strong>：
<ul>
<li>M-LAG双机需通过<code>commit sync</code>同步配置。</li>
</ul>
</li>
<li><strong>堆叠冲突</strong>：
<ul>
<li>M-LAG与iStack/CSS堆叠不可同时启用。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="5-示例拓扑">5. 示例拓扑</h2>
<pre><code>+-------------+         +-------------+
|   Spine1    |---------|   Spine2    |
+-------------+         +-------------+
   |    \                 /    |
   |     \               /     |
   |      \             /      |
+-------------+     +-------------+
|   Leaf1     |-----|   Leaf2     |  (M-LAG Pair)
+-------------+     +-------------+
   ||                     ||
  服务器                 服务器（双归接入）
</code></pre>
<hr>
<blockquote>
<p><strong>提示</strong>：实际部署时需根据硬件型号和软件版本调整命令细节。建议使用华为iMaster NCE或eSight进行自动化编排。</p>
</blockquote>

</div>
<div class="clear"></div>
</div>
		<p class="postfoot">
			posted on 
<span id="post-date" data-last-update-days="0.06423982570717593" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-15 10:47">2025-04-15 10:47</span>&nbsp;
<a href="https://www.cnblogs.com/wenlf136">wenlf136</a>&nbsp;
阅读(<span id="post_view_count">1</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18826300);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18826300', targetLink: 'https://www.cnblogs.com/wenlf136/p/18826300', title: '基于华为交换机的三层Clos架构（Leaf-Spine）配置指南' })">举报</a>

		</p>
	