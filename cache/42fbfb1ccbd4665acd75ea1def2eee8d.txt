
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sanyejun/p/19009064" title="å‘å¸ƒäº 2025-07-28 15:56">
    <span role="heading" aria-level="2">Unity å°„çº¿æ£€æµ‹ä¼˜åŒ–ï¼šä½¿ç”¨ Job System å®ç°é«˜æ€§èƒ½å°„çº¿æ‰¹å¤„ç†</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h2 data-start="87" data-end="94">âœ¨ å‰è¨€</h2>
<p data-start="96" data-end="139">åœ¨ Unity ä¸­ï¼Œå°„çº¿æ£€æµ‹ï¼ˆRaycastï¼‰æ˜¯æ¸¸æˆå¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ï¼Œè¢«å¹¿æ³›ç”¨äºï¼š</p>
<ul data-start="141" data-end="191">
<li data-start="141" data-end="151">
<p data-start="143" data-end="151">ç©å®¶å°„å‡»å‘½ä¸­åˆ¤æ–­</p>
</li>
<li data-start="152" data-end="168">
<p data-start="154" data-end="168">AI æ„ŸçŸ¥ï¼ˆè§†é‡/åœ°å½¢æ¢æµ‹ï¼‰</p>
</li>
<li data-start="169" data-end="175">
<p data-start="171" data-end="175">ç¯å¢ƒäº¤äº’</p>
</li>
<li data-start="176" data-end="184">
<p data-start="178" data-end="184">é¼ æ ‡ç‚¹å‡»é€‰ä¸­</p>
</li>
<li data-start="185" data-end="191">
<p data-start="187" data-end="191">åœ°å½¢è´´åˆ</p>
</li>
</ul>
<p data-start="193" data-end="274">ç„¶è€Œï¼Œ<strong data-start="196" data-end="237">ä¼ ç»Ÿçš„ <code data-start="202" data-end="221">Physics.Raycast()</code> æ˜¯ä¸€ä¸ªåŒæ­¥é˜»å¡çš„ä¸»çº¿ç¨‹æ“ä½œ</strong>ï¼Œå½“å°„çº¿æ•°é‡å˜å¤šæ—¶ï¼ˆ&gt;å‡ åæ¡/å¸§ï¼‰ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œé€ æˆå¸§ç‡æŠ–åŠ¨ç”šè‡³å¡é¡¿ã€‚</p>
<hr data-start="276" data-end="279">
<h2 data-start="281" data-end="306">ğŸš« é—®é¢˜ï¼šä¼ ç»Ÿå°„çº¿æ£€æµ‹åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç“¶é¢ˆ</h2>
<div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary">
<div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">csharp</div>
<div class="sticky top-9">
<div class="absolute end-0 bottom-0 flex h-9 items-center pe-2">
<div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1">å¤åˆ¶</button><span data-state="closed"><button class="flex items-center gap-1 py-1 select-none">ç¼–è¾‘</button></span></div>
</div>
</div>
<div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-csharp"><span class="hljs-keyword">for (<span class="hljs-built_in">int i = <span class="hljs-number">0; i &lt; <span class="hljs-number">100; i++) { Physics.Raycast(...); <span class="hljs-comment">// æ¯æ¬¡è°ƒç”¨éƒ½é˜»å¡ä¸»çº¿ç¨‹ } </span></span></span></span></span></code></div>
</div>
<h3 data-start="397" data-end="406">â— ç»“æœï¼š</h3>
<ul data-start="407" data-end="509">
<li data-start="407" data-end="422">
<p data-start="409" data-end="422">æ¯æ¡å°„çº¿éƒ½åœ¨ä¸»çº¿ç¨‹é€æ¡æ‰§è¡Œ</p>
</li>
<li data-start="423" data-end="465">
<p data-start="425" data-end="465">æ¯æ¬¡ <code data-start="428" data-end="445">Physics.Raycast</code> éƒ½ä» C# è·³åˆ° C++ï¼ˆè·¨è¯­è¨€è°ƒç”¨ï¼‰</p>
</li>
<li data-start="466" data-end="479">
<p data-start="468" data-end="479">æ²¡æœ‰å¹¶è¡Œï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸</p>
</li>
<li data-start="480" data-end="509">
<p data-start="482" data-end="509">100~1000 æ¡å°„çº¿ â†’ ä¸»çº¿ç¨‹çˆ†ç‚¸ â†’ ä¸¥é‡æ‰å¸§</p>
</li>
</ul>
<hr data-start="511" data-end="514">
<h2 data-start="516" data-end="576">âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Unity çš„ <code data-start="537" data-end="553">RaycastCommand</code> + Job System å®ç°â€œå°„çº¿æ‰¹å¤„ç†â€</h2>
<p data-start="578" data-end="602">Unity æä¾›äº†ä¸€ä¸ªä¸“ä¸ºæ­¤ç±»åœºæ™¯è®¾è®¡çš„ç»“æ„ä½“ï¼š</p>
<div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary">
<div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">csharp</div>
<div class="sticky top-9">
<div class="absolute end-0 bottom-0 flex h-9 items-center pe-2">
<div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1">å¤åˆ¶</button><span data-state="closed"><button class="flex items-center gap-1 py-1 select-none">ç¼–è¾‘</button></span></div>
</div>
</div>
<div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-csharp">RaycastCommand </code></div>
</div>
<p data-start="634" data-end="684">å®ƒå…è®¸æˆ‘ä»¬å°†å¤šä¸ªå°„çº¿æ‰“åŒ…ï¼Œ<strong data-start="647" data-end="683">ä¸€æ¬¡æ€§å‘ç»™ Unity Job Systemï¼Œå¹¶è¡Œåœ¨å¤šçº¿ç¨‹ä¸­æ‰§è¡Œ</strong>ã€‚</p>
<hr data-start="686" data-end="689">
<h2 data-start="691" data-end="701">ğŸ§  åŸç†æ¦‚è§ˆ</h2>
<div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary">
<div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">text</div>
<div class="sticky top-9">
<div class="absolute end-0 bottom-0 flex h-9 items-center pe-2">
<div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1">å¤åˆ¶</button><span data-state="closed"><button class="flex items-center gap-1 py-1 select-none">ç¼–è¾‘</button></span></div>
</div>
</div>
<div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-text"> å¤šä¸ªè¯·æ±‚è€…ï¼ˆè„šæœ¬ï¼‰ â†“ RaycastBatchManagerï¼ˆæ”¶é›†è¯·æ±‚ï¼‰ â†“ NativeArray&lt;RaycastCommand&gt;ï¼ˆæ‰¹å¤„ç†ï¼‰ â†“ Job System ScheduleBatch å¹¶è¡Œè°ƒåº¦ â†“ NativeArray&lt;RaycastHit&gt;ï¼ˆç»“æœï¼‰ â†“ ä¸»çº¿ç¨‹æ´¾å‘å›è°ƒ </code></div>
</div>
<hr data-start="989" data-end="992">
<h2 data-start="994" data-end="1009">âš¡ æ€§èƒ½å¯¹æ¯”ï¼ˆå®æµ‹ç»“æœï¼‰</h2>
<div class="_tableContainer_80l1q_1">
<div class="_tableWrapper_80l1q_14 group flex w-fit flex-col-reverse">
<table class="w-fit min-w-(--thread-content-width)" data-start="1011" data-end="1340">
<thead data-start="1011" data-end="1071">
<tr data-start="1011" data-end="1071"><th data-start="1011" data-end="1018" data-col-size="sm">å°„çº¿æ•°é‡</th><th data-start="1018" data-end="1044" data-col-size="sm"><code data-start="1020" data-end="1039">Physics.Raycast()</code> ä¸»çº¿ç¨‹</th><th data-start="1044" data-end="1071" data-col-size="sm"><code data-start="1046" data-end="1062">RaycastCommand</code> å¹¶è¡Œ Job</th></tr>
</thead>
<tbody data-start="1143" data-end="1340">
<tr data-start="1143" data-end="1211">
<td data-start="1143" data-end="1154" data-col-size="sm">10</td>
<td data-col-size="sm" data-start="1154" data-end="1182">çº¦ 0.2 ms</td>
<td data-col-size="sm" data-start="1182" data-end="1211">çº¦ 0.1 ms</td>
</tr>
<tr data-start="1212" data-end="1277">
<td data-start="1212" data-end="1223" data-col-size="sm">100</td>
<td data-col-size="sm" data-start="1223" data-end="1248">çº¦ 2~5 msï¼ˆæ‰å¸§ï¼‰</td>
<td data-col-size="sm" data-start="1248" data-end="1277">çº¦ 0.3~1 ms âœ…</td>
</tr>
<tr data-start="1278" data-end="1340">
<td data-start="1278" data-end="1289" data-col-size="sm">500</td>
<td data-col-size="sm" data-start="1289" data-end="1312">10+ msï¼ˆæ˜æ˜¾å¡é¡¿ï¼‰</td>
<td data-col-size="sm" data-start="1312" data-end="1340">çº¦ 2~3 ms âœ…âœ…</td>
</tr>
</tbody>
</table>
<div class="sticky end-(--thread-content-margin) h-0 self-end select-none">&nbsp;</div>
</div>
</div>
<p data-start="1342" data-end="1363">ï¼ˆæ³¨ï¼šæ•°æ®è§†ç¡¬ä»¶å’Œåœºæ™¯å¤æ‚åº¦ä¸åŒç•¥æœ‰æµ®åŠ¨ï¼‰</p>
<hr data-start="1365" data-end="1368">
<h2 data-start="1370" data-end="1407">ğŸ§± æˆ‘ä»¬æ„å»ºçš„è§£å†³æ–¹æ¡ˆï¼š<code data-start="1386" data-end="1407">RaycastBatchManager</code></h2>
<p data-start="1409" data-end="1451">ä¸ºäº†è§£è€¦ç»“æ„ã€é›†ä¸­ç®¡ç†ï¼Œæˆ‘ä»¬å°è£…äº†ä¸€ä¸ª <strong data-start="1429" data-end="1447">Raycast æ‰¹å¤„ç†è°ƒåº¦å™¨</strong>ï¼Œå…·å¤‡ï¼š</p>
<ul data-start="1453" data-end="1588">
<li data-start="1453" data-end="1469">
<p data-start="1455" data-end="1469">âœ… <strong data-start="1457" data-end="1469">æ¯å¸§æ”¶é›†å°„çº¿è¯·æ±‚</strong></p>
</li>
<li data-start="1470" data-end="1518">
<p data-start="1472" data-end="1518">âœ… <strong data-start="1474" data-end="1518">ä½¿ç”¨ <code data-start="1479" data-end="1511">RaycastCommand.ScheduleBatch()</code> å¹¶è¡Œå¤„ç†</strong></p>
</li>
<li data-start="1519" data-end="1537">
<p data-start="1521" data-end="1537">âœ… <strong data-start="1523" data-end="1537">ç»“æœè‡ªåŠ¨å›è°ƒç»™è¯·æ±‚è€…</strong></p>
</li>
<li data-start="1538" data-end="1560">
<p data-start="1540" data-end="1560">âœ… <strong data-start="1542" data-end="1560">å¯é…ç½®æ¯å¸§æœ€å¤§å¤„ç†é‡ï¼ˆé™æµï¼‰</strong></p>
</li>
<li data-start="1561" data-end="1588">
<p data-start="1563" data-end="1588">âœ… <strong data-start="1565" data-end="1588">å¯è§†åŒ–è°ƒè¯•ï¼šDebug.DrawRay</strong></p>
</li>
</ul>
<h3 data-start="1590" data-end="1601">ğŸ§© ä½¿ç”¨æ–¹å¼</h3>
<div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary">
<div class="flex items-center text-token-text-secondary px-4 py-2 text-xs font-sans justify-between h-9 bg-token-sidebar-surface-primary select-none rounded-t-2xl">csharp</div>
<div class="sticky top-9">
<div class="absolute end-0 bottom-0 flex h-9 items-center pe-2">
<div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><button class="flex gap-1 items-center select-none py-1">å¤åˆ¶</button><span data-state="closed"><button class="flex items-center gap-1 py-1 select-none">ç¼–è¾‘</button></span></div>
</div>
</div>
<div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-csharp">RaycastBatchManager.Instance.RequestRaycast( transform.position, transform.forward, <span class="hljs-number">100f, LayerMask.GetMask(<span class="hljs-string">"Enemy"), hit =&gt; { <span class="hljs-keyword">if (hit.collider != <span class="hljs-literal">null) Debug.Log(<span class="hljs-string">"Hit " + hit.collider.name); }); </span></span></span></span></span></code></div>
</div>
<hr data-start="1858" data-end="1861">
<h2 data-start="1863" data-end="1875">ğŸ›  æŠ€æœ¯ä¼˜åŠ¿æ€»ç»“</h2>
<div class="_tableContainer_80l1q_1">
<div class="_tableWrapper_80l1q_14 group flex w-fit flex-col-reverse">
<table class="w-fit min-w-(--thread-content-width)" data-start="1877" data-end="2455">
<thead data-start="1877" data-end="1961">
<tr data-start="1877" data-end="1961"><th data-start="1877" data-end="1905" data-col-size="sm">ä¼˜ç‚¹</th><th data-start="1905" data-end="1961" data-col-size="sm">è¯´æ˜</th></tr>
</thead>
<tbody data-start="2051" data-end="2455">
<tr data-start="2051" data-end="2121">
<td data-start="2051" data-end="2075" data-col-size="sm">âœ… ä¸»çº¿ç¨‹è½»è´Ÿè½½</td>
<td data-col-size="sm" data-start="2075" data-end="2121">æ‰€æœ‰æ£€æµ‹åœ¨ Job ä¸­å®Œæˆï¼Œé¿å…å¡é¡¿</td>
</tr>
<tr data-start="2122" data-end="2181">
<td data-start="2122" data-end="2141" data-col-size="sm">âœ… æ”¯æŒæˆç™¾ä¸Šåƒå°„çº¿å¹¶å‘</td>
<td data-col-size="sm" data-start="2141" data-end="2181">æé«˜æ‰©å±•æ€§ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡ AI æ„ŸçŸ¥ã€æŠ€èƒ½åˆ¤å®šç­‰</td>
</tr>
<tr data-start="2182" data-end="2247">
<td data-start="2182" data-end="2208" data-col-size="sm">âœ… å›è°ƒè§£è€¦</td>
<td data-col-size="sm" data-start="2208" data-end="2247">ä¸šåŠ¡å±‚æ— éœ€å…³å¿ƒå¤„ç†æµç¨‹ï¼Œåªç®¡å‘å‡ºè¯·æ±‚ + æ”¶åˆ°å‘½ä¸­</td>
</tr>
<tr data-start="2248" data-end="2321">
<td data-start="2248" data-end="2276" data-col-size="sm">âœ… LayerMask è¿‡æ»¤</td>
<td data-col-size="sm" data-start="2276" data-end="2321">æ”¯æŒæ¯æ¡å°„çº¿ç‹¬ç«‹è®¾ç½®è¿‡æ»¤å±‚çº§</td>
</tr>
<tr data-start="2322" data-end="2385">
<td data-start="2322" data-end="2346" data-col-size="sm">âœ… é™æµ/èŠ‚æµä¿æŠ¤</td>
<td data-col-size="sm" data-start="2346" data-end="2385">æ¯å¸§å¯è®¾ç½®æœ€å¤§å°„çº¿æ•°ï¼Œé˜²æ­¢çˆ†é‡è¯·æ±‚æ‹–æ…¢æ•´å¸§</td>
</tr>
<tr data-start="2386" data-end="2455">
<td data-start="2386" data-end="2413" data-col-size="sm">âœ… Debug å¯è§†åŒ–</td>
<td data-col-size="sm" data-start="2413" data-end="2455">æ¯æ¡å°„çº¿å¯è§†åŒ–è°ƒè¯•ï¼Œä¾¿äºå¼€å‘å®šä½é—®é¢˜</td>
</tr>
</tbody>
</table>
<div class="sticky end-(--thread-content-margin) h-0 self-end select-none">&nbsp;</div>
</div>
</div>
<hr data-start="2457" data-end="2460">
<h2 data-start="2462" data-end="2474">ğŸ’¡ åœºæ™¯é€‚ç”¨å»ºè®®</h2>
<div class="_tableContainer_80l1q_1">
<div class="_tableWrapper_80l1q_14 group flex w-fit flex-col-reverse">
<table class="w-fit min-w-(--thread-content-width)" data-start="2476" data-end="2870">
<thead data-start="2476" data-end="2525">
<tr data-start="2476" data-end="2525"><th data-start="2476" data-end="2510" data-col-size="sm">ä½¿ç”¨åœºæ™¯</th><th data-start="2510" data-end="2525" data-col-size="sm">æ˜¯å¦æ¨èä½¿ç”¨å°„çº¿æ‰¹å¤„ç†</th></tr>
</thead>
<tbody data-start="2593" data-end="2870">
<tr data-start="2593" data-end="2644">
<td data-start="2593" data-end="2618" data-col-size="sm">æªæ¢°å°„å‡»ç³»ç»Ÿï¼ˆå­å¼¹å¤šå‘ï¼‰</td>
<td data-col-size="sm" data-start="2618" data-end="2644">âœ…âœ…âœ…</td>
</tr>
<tr data-start="2645" data-end="2697">
<td data-start="2645" data-end="2671" data-col-size="sm">AI æ„ŸçŸ¥ç³»ç»Ÿï¼ˆè§†é‡ã€åœ°å½¢ï¼‰</td>
<td data-col-size="sm" data-start="2671" data-end="2697">âœ…âœ…âœ…</td>
</tr>
<tr data-start="2698" data-end="2746">
<td data-start="2698" data-end="2719" data-col-size="sm">æŠ€èƒ½åˆ¤å®šï¼ˆæ‰‡å½¢å°„çº¿ã€èŒƒå›´ç¢°æ’ï¼‰</td>
<td data-col-size="sm" data-start="2719" data-end="2746">âœ…âœ…</td>
</tr>
<tr data-start="2747" data-end="2805">
<td data-start="2747" data-end="2776" data-col-size="sm">é¼ æ ‡ç‚¹å‡»ï¼ˆå•æ¡ï¼‰</td>
<td data-col-size="sm" data-start="2776" data-end="2805">âŒï¼ˆå•å‘ç”¨ Physics.Raycast å°±è¡Œï¼‰</td>
</tr>
<tr data-start="2806" data-end="2870">
<td data-start="2806" data-end="2836" data-col-size="sm">ECS é¡¹ç›®ï¼ˆå…¨ç”¨ Unity.Physicsï¼‰</td>
<td data-col-size="sm" data-start="2836" data-end="2870">âŒï¼ˆä½¿ç”¨ <code data-start="2843" data-end="2867">CollisionWorld.CastRay</code>ï¼‰</td>
</tr>
</tbody>
</table>
<div class="sticky end-(--thread-content-margin) h-0 self-end select-none">&nbsp;</div>
</div>
</div>
<hr data-start="2872" data-end="2875">
<h2 data-start="2877" data-end="2887">âœ… æ€»ç»“ä¸€å¥è¯</h2>
<blockquote data-start="2889" data-end="3026">
<p data-start="2891" data-end="2953"><strong data-start="2891" data-end="2953">RaycastCommand + Job System æ˜¯ Unity é ECS é¡¹ç›®ä¸­è¿›è¡Œå¤§é‡å°„çº¿æ£€æµ‹çš„æœ€ä¼˜è§£ã€‚</strong></p>
<p data-start="2960" data-end="3026">è‹¥ä½ ä»ç„¶åœ¨ä¸»çº¿ç¨‹ç”¨ <code data-start="2970" data-end="2989">Physics.Raycast()</code> åšå¤§é‡æ£€æµ‹ï¼Œè¯·ç«‹å³åˆ‡æ¢ï¼Œ<strong data-start="3002" data-end="3025">æ€§èƒ½æ”¶ç›Šå·¨å¤§ã€æ¶æ„æ›´åˆç†ã€ä½¿ç”¨éš¾åº¦æä½</strong>ã€‚</p>
</blockquote>
<p>&nbsp;</p>
<p>ã€æ ¸å¿ƒä»£ç ã€‘</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> System;
</span><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> System.Collections.Generic;
</span><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> System.Diagnostics;
</span><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> Unity.Collections;
</span><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> Unity.Jobs;
</span><span style="color: rgba(0, 0, 255, 1)">using</span><span style="color: rgba(0, 0, 0, 1)"> UnityEngine;
</span><span style="color: rgba(0, 0, 255, 1)">using</span> Debug =<span style="color: rgba(0, 0, 0, 1)"> UnityEngine.Debug;

</span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> å°„çº¿æ‰¹å¤„ç†è°ƒåº¦å™¨ï¼šæ”¶é›†å°„çº¿è¯·æ±‚ï¼Œæ‰¹é‡æ‰§è¡Œï¼Œä¸»çº¿ç¨‹å›è°ƒ
</span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> RaycastBatchManager : MonoBehaviour
{
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">static</span> RaycastBatchManager Instance { <span style="color: rgba(0, 0, 255, 1)">get</span>; <span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">; }

    [Header(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ€§èƒ½è®¾ç½®</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)]
    [Tooltip(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ¯å¸§æœ€å¤šå¤„ç†å¤šå°‘æ¡å°„çº¿ï¼ˆé™æµé˜²å¡é¡¿ï¼‰</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)]
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">int</span> maxRaysPerFrame = <span style="color: rgba(128, 0, 128, 1)">100</span><span style="color: rgba(0, 0, 0, 1)">;

    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
    <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> å°„çº¿è¯·æ±‚ç»“æ„
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">struct</span><span style="color: rgba(0, 0, 0, 1)"> RaycastRequest
    {
        </span><span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> Vector3 origin;
        </span><span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> Vector3 direction;
        </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">float</span><span style="color: rgba(0, 0, 0, 1)"> distance;
        </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)"> layerMask;
        </span><span style="color: rgba(0, 0, 255, 1)">public</span> Action&lt;RaycastHit&gt;<span style="color: rgba(0, 0, 0, 1)"> callback;
    }

    </span><span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">readonly</span> List&lt;RaycastRequest&gt; requestQueue = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)">();

    </span><span style="color: rgba(0, 0, 255, 1)">private</span> NativeArray&lt;RaycastCommand&gt;<span style="color: rgba(0, 0, 0, 1)"> commands;
    </span><span style="color: rgba(0, 0, 255, 1)">private</span> NativeArray&lt;RaycastHit&gt;<span style="color: rgba(0, 0, 0, 1)"> results;

    </span><span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> Awake()
    {
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> (Instance != <span style="color: rgba(0, 0, 255, 1)">null</span> &amp;&amp; Instance != <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">)
        {
            Destroy(</span><span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">);
            </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
        }
        Instance </span>= <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">;
    }

    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
    <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> ç”±å¤–éƒ¨è°ƒç”¨ï¼šå‘èµ·ä¸€æ¡å°„çº¿è¯·æ±‚ï¼ˆå»¶è¿Ÿåˆ°æœ¬å¸§ LateUpdate æ‰§è¡Œï¼‰
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">void</span> RequestRaycast(Vector3 origin, Vector3 direction, <span style="color: rgba(0, 0, 255, 1)">float</span> distance, <span style="color: rgba(0, 0, 255, 1)">int</span> layerMask, Action&lt;RaycastHit&gt;<span style="color: rgba(0, 0, 0, 1)"> callback)
    {
        requestQueue.Add(</span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> RaycastRequest
        {
            origin </span>=<span style="color: rgba(0, 0, 0, 1)"> origin,
            direction </span>=<span style="color: rgba(0, 0, 0, 1)"> direction,
            distance </span>=<span style="color: rgba(0, 0, 0, 1)"> distance,
            layerMask </span>=<span style="color: rgba(0, 0, 0, 1)"> layerMask,
            callback </span>=<span style="color: rgba(0, 0, 0, 1)"> callback
        });
    }

    </span><span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> LateUpdate()
    {
        </span><span style="color: rgba(0, 0, 255, 1)">int</span> totalRequests =<span style="color: rgba(0, 0, 0, 1)"> requestQueue.Count;
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> (totalRequests == <span style="color: rgba(128, 0, 128, 1)">0</span>) <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;

        </span><span style="color: rgba(0, 0, 255, 1)">int</span> count =<span style="color: rgba(0, 0, 0, 1)"> Mathf.Min(maxRaysPerFrame, totalRequests);
        Debug.Log(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å½“å‰æ‰¹å¤„ç†å°„çº¿æ•°é‡</span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> count);
        
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ€§èƒ½ç›‘æµ‹</span>
        Stopwatch stopwatch =<span style="color: rgba(0, 0, 0, 1)"> Stopwatch.StartNew();
        
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åˆ†é… NativeArrayï¼ˆä¸´æ—¶ Job ç”¨ï¼‰</span>
        commands = <span style="color: rgba(0, 0, 255, 1)">new</span> NativeArray&lt;RaycastCommand&gt;<span style="color: rgba(0, 0, 0, 1)">(count, Allocator.TempJob);
        results </span>= <span style="color: rgba(0, 0, 255, 1)">new</span> NativeArray&lt;RaycastHit&gt;<span style="color: rgba(0, 0, 0, 1)">(count, Allocator.TempJob);

        </span><span style="color: rgba(0, 0, 255, 1)">for</span> (<span style="color: rgba(0, 0, 255, 1)">int</span> i = <span style="color: rgba(128, 0, 128, 1)">0</span>; i &lt; count; i++<span style="color: rgba(0, 0, 0, 1)">)
        {
            </span><span style="color: rgba(0, 0, 255, 1)">var</span> req =<span style="color: rgba(0, 0, 0, 1)"> requestQueue[i];
            commands[i] </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> RaycastCommand(req.origin, req.direction, req.distance, req.layerMask);

            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ğŸ‘‡ å¯è§†åŒ–ï¼ˆè°ƒè¯•ç”¨ï¼‰
            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">Debug.DrawRay(req.origin, req.direction * req.distance, Color.green, 0.1f);</span>
<span style="color: rgba(0, 0, 0, 1)">        }

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¹¶è¡Œè°ƒåº¦</span>
        JobHandle handle = RaycastCommand.ScheduleBatch(commands, results, <span style="color: rgba(128, 0, 128, 1)">32</span><span style="color: rgba(0, 0, 0, 1)">);
        handle.Complete(); </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> é˜»å¡ç›´åˆ° Job å®Œæˆï¼ˆç¡®ä¿ç»“æœå¯ç”¨ï¼‰

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å›è°ƒç»“æœ</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> (<span style="color: rgba(0, 0, 255, 1)">int</span> i = <span style="color: rgba(128, 0, 128, 1)">0</span>; i &lt; count; i++<span style="color: rgba(0, 0, 0, 1)">)
        {
            requestQueue[i].callback</span>?<span style="color: rgba(0, 0, 0, 1)">.Invoke(results[i]);
        }

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åˆ†å¸§å¤„ç†ï¼Œä¿ç•™æœªå¤„ç†çš„è¯·æ±‚</span>
        requestQueue.RemoveRange(<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">, count);

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å®‰å…¨é‡Šæ”¾ NativeArray</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (commands.IsCreated) commands.Dispose();
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (results.IsCreated) results.Dispose();
        
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ€§èƒ½ç»Ÿè®¡è¾“å‡º</span>
<span style="color: rgba(0, 0, 0, 1)">        stopwatch.Stop();
        UnityEngine.Debug.Log($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[RaycastBatchManager] {count} å°„çº¿è€—æ—¶: {stopwatch.ElapsedMilliseconds} ms</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    }
}</span></pre>
</div>
<p>&nbsp;</p>
<p>ã€æµ‹è¯•ç”¨ä¾‹ã€‘</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">            RaycastBatchManager.Instance.RequestRaycast(
                transform.position,
                transform.forward,
                100f,
                LayerMask.GetMask(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Default</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">),
                hit </span>=&gt;<span style="color: rgba(0, 0, 0, 1)">
                {
                    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (hit.collider != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
                        Debug.Log(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å‘½ä¸­: </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> hit.collider.name);
                    </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">
                        Debug.Log(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æœªå‘½ä¸­</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                });</span></pre>
</div>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-28 15:57">2025-07-28 15:56</span>&nbsp;
<a href="https://www.cnblogs.com/sanyejun">ä¸‰é¡µèŒ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">7</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19009064);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19009064', targetLink: 'https://www.cnblogs.com/sanyejun/p/19009064', title: 'Unity å°„çº¿æ£€æµ‹ä¼˜åŒ–ï¼šä½¿ç”¨ Job System å®ç°é«˜æ€§èƒ½å°„çº¿æ‰¹å¤„ç†' })">ä¸¾æŠ¥</a>
</div>
        