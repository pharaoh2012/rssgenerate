
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/tom-hua/p/19038606" title="发布于 2025-08-14 21:43">
    <span role="heading" aria-level="2">OCI编程高级篇（十三） 直接路径装载分配句柄</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Oracle OCI编程分配直接路径装载用到的句柄，设置句柄的属性，比如要装载表的名称，表的属主，表的字段个数，直接路径装载转换缓冲区的大小等。
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span style="color: rgba(255, 0, 0, 1)">访问<a title="www.tomcoding.com" href="http://www.tomcoding.com/" rel="noopener nofollow"><span style="color: rgba(255, 0, 0, 1)">www.tomcoding.com</span></a><span style="font-family: 宋体">网站，学习</span><span style="font-family: 宋体">Oracle内部数据结构，详细文档说明，下载Oracle的exp/imp，DUL，logminer，ASM工具的源代码，学习高技术含量的内容。</span></span></p>
<p class="p"><span style="font-family: 宋体">直接路径装载最少分配三个句柄，第一个是直接路径上下文句柄</span>OCIDirPathCtx<span style="font-family: 宋体">，这个句柄从父句柄环境句柄</span><span style="font-family: Calibri">envhp</span><span style="font-family: 宋体">分配，每一个要装载的对象都要有一个</span><span style="font-family: Calibri">OCIDirPathCtx</span><span style="font-family: 宋体">，可以分配多个句柄，也可以多个对象共用一个句柄。以</span><span style="font-family: Calibri">OCIDirPathCtx</span><span style="font-family: 宋体">为父句柄，可以分配另外两个句柄，一个是直接路径字段数组句柄</span><span style="font-family: Calibri">OCIDirPathColArray</span><span style="font-family: 宋体">，用于设置表的字段信息和字段数据。另一个是直接路径流句柄</span><span style="font-family: Calibri">OCIDirPathStream</span><span style="font-family: 宋体">，用于把字段数组转换成数据流。</span></p>
<p><span style="font-family: 宋体">我们之前创建过一个表，用于前面的</span>OCI<span style="font-family: 宋体">代码演示，建表语句是</span><span style="font-family: Calibri">CREATE TABLE test_tab (ID NUMBER, NAME CHAR(30), ADDR VARCHAR2(200))</span><span style="font-family: 宋体">。我们还以这个表为例，使用直接路径装载插入数据，看看开始分配句柄和设置句柄属性的过程。表的名称为</span><span style="font-family: Calibri">test_tab</span><span style="font-family: 宋体">，表的</span><span style="font-family: Calibri">schema</span><span style="font-family: 宋体">为</span><span style="font-family: Calibri">scott</span><span style="font-family: 宋体">，下面是代码演示。</span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre>OCIEnv       *envhp =<span style="color: rgba(0, 0, 0, 1)"> NULL;
OCIError     </span>*errhp =<span style="color: rgba(0, 0, 0, 1)"> NULL;
OCIServer    </span>*svrhp =<span style="color: rgba(0, 0, 0, 1)"> NULL;
OCISession   </span>*usrhp =<span style="color: rgba(0, 0, 0, 1)"> NULL;
OCISvcCtx    </span>*svchp =<span style="color: rgba(0, 0, 0, 1)"> NULL;

</span><span style="color: rgba(0, 0, 255, 1)">int</span> dp_load(<span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)">){
    ub4                  buf_sz;
    ub4                  ncol;
    OCIDirPathCtx        </span>*<span style="color: rgba(0, 0, 0, 1)">dpctx;
    OCIDirPathColArray   </span>*<span style="color: rgba(0, 0, 0, 1)">dpca;
    OCIDirPathStream     </span>*<span style="color: rgba(0, 0, 0, 1)">dpstr;


    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 分配直接路径上下文句柄，父句柄是envhp </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIHandleAlloc((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)envhp, (<span style="color: rgba(0, 0, 255, 1)">void</span> **)&amp;<span style="color: rgba(0, 0, 0, 1)">dpctx,
            OCI_HTYPE_DIRPATH_CTX, </span><span style="color: rgba(128, 0, 128, 1)">0</span>, (<span style="color: rgba(0, 0, 255, 1)">void</span> **<span style="color: rgba(0, 0, 0, 1)">)NULL)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 分配直接路径字段数组句柄，父句柄是dpctx </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIHandleAlloc((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)dpctx, (<span style="color: rgba(0, 0, 255, 1)">void</span> **)&amp;<span style="color: rgba(0, 0, 0, 1)">dpca,
            OCI_HTYPE_DIRPATH_COLUMN_ARRAY, </span><span style="color: rgba(128, 0, 128, 1)">0</span>, (<span style="color: rgba(0, 0, 255, 1)">void</span> **<span style="color: rgba(0, 0, 0, 1)">)NULL)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 分配直接路径流句柄，父句柄是dpctx </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIHandleAlloc((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)dpctx, (<span style="color: rgba(0, 0, 255, 1)">void</span> **)&amp;<span style="color: rgba(0, 0, 0, 1)">dpstr,
            OCI_HTYPE_DIRPATH_STREAM, </span><span style="color: rgba(128, 0, 128, 1)">0</span>, (<span style="color: rgba(0, 0, 255, 1)">void</span> **<span style="color: rgba(0, 0, 0, 1)">)NULL)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 设置表的schema，在上下文句柄中设置 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIAttrSet((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *<span style="color: rgba(0, 0, 0, 1)">)dpctx, (ub4)OCI_HTYPE_DIRPATH_CTX,
            (</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">scott</span><span style="color: rgba(128, 0, 0, 1)">"</span>, strlen(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">scott</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">),
            (ub4)OCI_ATTR_SCHEMA_NAME, errhp)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 设置表名称，在上下文句柄中设置 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIAttrSet((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *<span style="color: rgba(0, 0, 0, 1)">)dpctx, (ub4)OCI_HTYPE_DIRPATH_CTX,
            (</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">test_tab</span><span style="color: rgba(128, 0, 0, 1)">"</span>, strlen(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">test_tab</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">),
            (ub4)OCI_ATTR_NAME, errhp)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 设置转换缓冲区的大小为2M </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
    buf_sz </span>= <span style="color: rgba(128, 0, 128, 1)">2</span> * <span style="color: rgba(128, 0, 128, 1)">1024</span> * <span style="color: rgba(128, 0, 128, 1)">1024</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIAttrSet((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *<span style="color: rgba(0, 0, 0, 1)">)dpctx, (ub4)OCI_HTYPE_DIRPATH_CTX,
            (</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)&amp;buf_sz, <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
            (ub4)OCI_ATTR_BUF_SIZE, errhp)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 设置表的字段个数 </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
    ncol </span>= <span style="color: rgba(128, 0, 128, 1)">3</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (check_oci_error(errhp,
        OCIAttrSet((</span><span style="color: rgba(0, 0, 255, 1)">void</span> *<span style="color: rgba(0, 0, 0, 1)">)dpctx, (ub4)OCI_HTYPE_DIRPATH_CTX,
            (</span><span style="color: rgba(0, 0, 255, 1)">void</span> *)&amp;ncol, <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
            (ub4)OCI_ATTR_NUM_COLS, errhp)
        ) </span>&lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> (-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);

    </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 后面需要设置表的字段信息了，我们在下一节中继续 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
    <span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> 未完，待续 ... </span><span style="color: rgba(0, 128, 0, 1)">*/</span>

    <span style="color: rgba(0, 0, 255, 1)">return</span> (<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">);
}</span></pre>
</div>
<p>&nbsp;</p>
<p class="p"><span style="font-family: 宋体">在上面的例子中我们分配了三个句柄，并且在代表对象的直接路径上下文中设置了表的属主，表的名称，表的字段个数，转换缓冲区的大小等属性。</span></p>
<p><span style="font-family: 宋体">在下一节中我们看看怎样设置表的字段属性和字段其他信息，字段的设置有点复杂，我们专门用一节来讲清楚。</span></p>
<p>&nbsp;</p>
</div>
<div id="MySignature" role="contentinfo">
    学习Oracle高级知识，编写高质量代码，尽在www.tomcoding.com
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-08-14 21:43">2025-08-14 21:43</span>&nbsp;
<a href="https://www.cnblogs.com/tom-hua">汤姆花花</a>&nbsp;
阅读(<span id="post_view_count">11</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19038606);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19038606', targetLink: 'https://www.cnblogs.com/tom-hua/p/19038606', title: 'OCI编程高级篇（十三） 直接路径装载分配句柄' })">举报</a>
</div>
        