
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Yiz118/p/18791613" title="发布于 2025-03-25 16:04">
    <span role="heading" aria-level="2">ATT&amp;CK实战系列（三）红日靶场3</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			    <div id="cnblogs_post_description" style="display: none">
        
        ATT&amp;CK实战系列（三）红日靶场3
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span style="font-size: 18pt">本次打靶练习是一个黑盒测试。没有密码，我们的目标是拿到域控制器的权限，并找到其中的重要文件。</span></p>
<p><span style="font-size: 18pt">网络拓扑</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325152638402-122310485.png" alt="" width="655" height="198" loading="lazy"></p>
<p><span style="font-size: 18pt">网卡设置</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325152921726-182011387.png" alt="" width="678" height="405" loading="lazy"></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">centos为出网机，第一次运行，需重新获取桥接模式网卡ip。

需重启网络服务service network restart

其他的不动</span></pre>
</div>
<p><span style="font-size: 18pt" data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;p&quot;,&quot;attributes&quot;:{},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">查看当前攻击机的IP地址</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325152942730-58207128.png" alt="" width="722" height="200" loading="lazy"></p>
<p><span style="font-size: 18pt">扫描目标IP，查看开放的端口</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325152949357-89386156.png" alt="" width="654" height="181" loading="lazy"></p>
<p><span style="font-size: 18pt">访问80端口</span></p>
<p><span style="font-size: 18pt" data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;p&quot;,&quot;attributes&quot;:{},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">Wappalyzer发现网站cms——Joomla</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153010429-15446326.png" alt="" width="699" height="370" loading="lazy"></p>
<div class="cnblogs_code">
<pre>Joomla是一套全球知名的内容管理系统。 <br>Joomla是使用PHP语言加上MySQL数据库所开发的软件系统。<br>可在Linux、 Windows、MacOSX等各种不同的平台上执行。是由Open Source Matters（见扩展阅读）这个开放源码组织进行开发与支持。</pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153117766-594589574.png" alt="" width="618" height="349" loading="lazy"></p>
<p><span style="font-size: 18pt">百度查看历史漏洞</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153134199-948165342.png" alt="" width="590" height="403" loading="lazy"></p>
<p><span style="font-size: 18pt">扫描80端口的目录</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153201790-1459803444.png" alt="" width="590" height="454" loading="lazy"></p>
<p><span style="font-size: 18pt">找到后台</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153212620-27306246.png" alt="" width="737" height="448" loading="lazy"></p>
<p><span style="font-size: 18pt">发现数据库等信息</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153225332-1895243311.png" alt="" width="620" height="314" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153231710-1179427332.png" alt="" width="611" height="435" loading="lazy"></p>
<p>&nbsp;<span style="font-size: 18pt">测试连接数据库，成功。</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153253362-1776423559.png" alt="" width="631" height="463" loading="lazy"></p>
<p><span style="font-size: 18pt">在joomla的官方文档中找到了修改密码的操作</span></p>
<div class="cnblogs_code">
<pre>https://docs.joomla.org/How_do_you_recover_or_reset_your_admin_password%3F</pre>
</div>
<div class="cnblogs_code">
<pre>update am2zu_users set password = "433903e0a9d6a712e00251e44d29bf87:UJ0b9J5fufL3FKfCc0TLsYJBh2PFULvT" where username="administrator";</pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153339802-26202534.png" alt="" width="683" height="314" loading="lazy"></p>
<p><span style="font-size: 18pt">进行修改密码</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153353333-695485231.png" alt="" width="743" height="289" loading="lazy"></p>
<p><span style="font-size: 18pt">修改成功，登录系统</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153408766-1581872335.png" alt="" width="758" height="270" loading="lazy"></p>
<p><span style="font-size: 18pt">上传木马</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153421585-1792667542.png" alt="" width="748" height="335" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153427471-334559907.png" alt="" width="735" height="336" loading="lazy"></p>
<p><span style="font-size: 18pt">连接木马</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153443416-813786260.png" alt="" width="714" height="539" loading="lazy"></p>
<p><span style="font-size: 18pt">新建文件也一样操作</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153455434-1912195060.png" alt="" width="725" height="299" loading="lazy"></p>
<p><span style="font-size: 18pt">写入木马</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153507303-880932912.png" alt="" width="722" height="301" loading="lazy"></p>
<p><span style="font-size: 18pt">成功</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153521104-574264836.png" alt="" width="722" height="413" loading="lazy"></p>
<p><span style="font-size: 18pt">蚁剑连接成功，无法执行命令，ret=127</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153534712-1259745480.png" alt="" width="735" height="494" loading="lazy"></p>
<p><span style="font-size: 18pt">写入phpinfo查看</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153600833-2090973615.png" alt="" width="732" height="340" loading="lazy"></p>
<p><span style="font-size: 18pt">开启了 disable_functions 配置选项，禁用了代码执行的函数</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153613096-539301387.png" alt="" width="727" height="383" loading="lazy"></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">disable_functions是php.ini中的一个设置选项，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数等。执行命令发现ret=127,实际上就是因为被这个限制的原因。
1、黑名单绕过：          
     assert,system,passthru,exec,pcntl_exec,shell_exec,popen,proc_open
2、利用Windows组件DCOM绕过（Linux系统不适用）
3、利用Linux环境变量LD_PRELOAD      
     LD_PRELOAD是Linux系统中的一个环境变量：它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，可以以此功能来使用自己的或是更好的函数，而另一方面，也可以以向别人的程序注入程序，从而达到特定的目的。
4、蚁剑插件或者哥斯拉绕过    </span></pre>
</div>
<p><span style="font-size: 18pt">这里我用自带工具绕过，简单省事。</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153718843-1378796819.png" alt="" width="736" height="371" loading="lazy"></p>
<p><span style="font-size: 18pt">绕过成功，可正常执行命令</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153729324-1124638423.png" alt="" width="749" height="542" loading="lazy"></p>
<p><span style="font-size: 18pt">翻翻找找，看到敏感信息</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153739936-1917716478.png" alt="" width="748" height="428" loading="lazy"></p>
<p><span style="font-size: 18pt">使用wwwuser/wwwuser_123Aqx进行ssh连接，连接成功</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153753403-2139338476.png" alt="" width="740" height="235" loading="lazy"></p>
<p><span style="font-size: 18pt">查看系统版本</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153804688-318874098.png" alt="" width="721" height="207" loading="lazy"></p>
<p><span style="font-size: 18pt">脏牛提权</span></p>
<p><span style="font-size: 18pt">攻击机开启http服务，下载在至目标机器，并进行编译</span></p>
<pre class="code-snippet__js" data-lang="nginx"></pre>
<div class="cnblogs_code">
<pre>gcc -pthread dirty.c -o aaa -lcrypt</pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153817834-956916680.png" alt="" width="726" height="282" loading="lazy"></p>
<p><span style="font-size: 18pt">提权后查看，提前成功。</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153841964-1437672170.png" alt="" width="735" height="84" loading="lazy"></p>
<p><span style="font-size: 18pt">msf生成elf木马</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153854370-816495628.png" alt="" width="748" height="400" loading="lazy"></p>
<p><span style="font-size: 18pt">设置监听</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153907573-602245851.png" alt="" width="744" height="323" loading="lazy"></p>
<p><span style="font-size: 18pt">将攻击机生成的木马下载至目标机器，执行木马（执行成功上图）</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153918354-550652585.png" alt="" width="743" height="316" loading="lazy"></p>
<p><span style="font-size: 18pt">扫描192.168.93.0网段的机器</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153929988-1855004901.png" alt="" width="741" height="359" loading="lazy"></p>
<p><span style="font-size: 18pt">发现三台机器分别是192.168.93.20、192.168.93.30、192.168.93.10</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153942988-1437087585.png" alt="" width="755" height="114" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325153947739-1636496509.png" alt="" width="753" height="67" loading="lazy"></p>
<p><span style="font-size: 18pt">添加路由</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154001345-1202912451.png" alt="" width="755" height="315" loading="lazy"></p>
<p><span style="font-size: 18pt">smb爆破，爆破到密码</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154019110-139372961.png" alt="" width="749" height="431" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154028810-1826243464.png" alt="" width="750" height="330" loading="lazy"></p>
<p><span style="font-size: 18pt">查看当前机器systeminfo，发现域</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154043125-1418540248.png" alt="" width="745" height="396" loading="lazy"></p>
<p><span style="font-size: 18pt">获取域控的IP</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154306256-1111430188.png" alt="" width="743" height="109" loading="lazy"></p>
<p><span style="font-size: 18pt">查看域内主机</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154314981-351747411.png" alt="" width="743" height="180" loading="lazy"></p>
<p><span style="font-size: 18pt">判断zerologon漏洞</span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">CVE-2020-14722是一个windows域控中严重的远程权限提升漏洞。
它是因为微软在Netlogon协议中没有正确使用加密算法而导致的漏洞。
由于微软在进行AES加密运算过程中，使用了AES-CFB8模式并且错误的将IV设置为全零，这使得攻击者在明文(client challenge)、IV等要素可控的情况下，存在较高概率使得产生的密文为全零。</span></pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154349724-874071399.png" alt="" width="761" height="191" loading="lazy"></p>
<p><span style="font-size: 18pt">攻击</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154400965-293340768.png" alt="" width="763" height="216" loading="lazy"></p>
<p><span style="font-size: 18pt">攻击成功，转出hash值</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154411730-279646094.png" alt="" width="769" height="279" loading="lazy"></p>
<p><span style="font-size: 18pt">使用psexec</span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">set RHOSTS 
set SMBUser 
set SMBPass<br></span></pre>
</div>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154440522-475715207.png" alt="" width="774" height="241" loading="lazy"></p>
<p><span style="font-size: 18pt">读取明文密码‌</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154449147-721324101.png" alt="" width="779" height="241" loading="lazy"></p>
<p><span style="font-size: 18pt">继续</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154459389-665314657.png" alt="" width="775" height="125" loading="lazy"></p>
<p><span style="font-size: 18pt">查看session</span></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154511777-437559735.png" alt="" width="775" height="467" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154516917-1941668218.png" alt="" width="772" height="432" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/2176750/202503/2176750-20250325154521491-331368272.png" alt="" width="767" height="508" loading="lazy"></p>
</div>
<div id="MySignature" role="contentinfo">
    
    What、Why、How
</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.011888970416666667" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-25 16:04">2025-03-25 16:04</span>&nbsp;
<a href="https://www.cnblogs.com/Yiz118">奕泽Yiz</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18791613" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18791613);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18791613', targetLink: 'https://www.cnblogs.com/Yiz118/p/18791613', title: 'ATT&amp;amp;CK实战系列（三）红日靶场3' })">举报</a>
</div>
	