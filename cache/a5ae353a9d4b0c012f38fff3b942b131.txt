
	<div class="postTitle">
		<h1><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/cnsharp/p/18913607" title="发布于 2025-06-06 09:53">
    <span role="heading" aria-level="2">.NET SDK样式项目打包时如何将引用项目打进同一个包</span>
    

</a>
</h1>
	</div>
	<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>此篇为上一篇[《.NET SDK样式项目打包时如何将项目引用转为包依赖》](<a href="https://www.cnblogs.com/cnsharp/p/18819771" target="_blank">https://www.cnblogs.com/cnsharp/p/18819771</a> ")的姊妹篇。</p>
<p>通常情况下，我们会将每个项目都生成一个包。但有时也可能一些特殊情况会将项目及其引用项目的相关文件都打进一个包。</p>
<p>在之前的.nuspec文件中，我们可以在<code>&lt;files&gt;</code>节点中声明。SDK样式的项目中要怎么做呢?</p>
<h2 id="变通">变通</h2>
<p>在NuGet Github Issue中有一条<a href="https://github.com/NuGet/Home/issues/3891#issuecomment-569491001" target="_blank" rel="noopener nofollow">评论</a>是这样的，他给出一个workaround.</p>
<pre><code>&lt;Project&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetsForTfmSpecificBuildOutput&gt;$(TargetsForTfmSpecificBuildOutput);CopyProjectReferencesToPackage&lt;/TargetsForTfmSpecificBuildOutput&gt;
  &lt;/PropertyGroup&gt;
  
  &lt;Target Name="CopyProjectReferencesToPackage" DependsOnTargets="BuildOnlySettings;ResolveReferences"&gt;
    &lt;ItemGroup&gt;
      &lt;!-- Filter out unnecessary files --&gt;
      &lt;_ReferenceCopyLocalPaths Include="@(ReferenceCopyLocalPaths-&gt;WithMetadataValue('ReferenceSourceTarget', 'ProjectReference')-&gt;WithMetadataValue('PrivateAssets', 'All'))"/&gt;
    &lt;/ItemGroup&gt;

    &lt;!-- Print batches for debug purposes --&gt;
    &lt;Message Text="Batch for .nupkg: ReferenceCopyLocalPaths = @(_ReferenceCopyLocalPaths), ReferenceCopyLocalPaths.DestinationSubDirectory = %(_ReferenceCopyLocalPaths.DestinationSubDirectory) Filename = %(_ReferenceCopyLocalPaths.Filename) Extension = %(_ReferenceCopyLocalPaths.Extension)" Importance="High" Condition="'@(_ReferenceCopyLocalPaths)' != ''" /&gt;

    &lt;ItemGroup&gt;
      &lt;!-- Add file to package with consideration of sub folder. If empty, the root folder is chosen. --&gt;
      &lt;BuildOutputInPackage Include="@(_ReferenceCopyLocalPaths)" TargetPath="%(_ReferenceCopyLocalPaths.DestinationSubDirectory)"/&gt;
    &lt;/ItemGroup&gt;
  &lt;/Target&gt;
&lt;/Project&gt;
</code></pre>
<p>细看一下，它还打印了debug信息，如果想去掉可以简化为</p>
<pre><code>&lt;Target Name="CopyProjectReferencesToPackage" DependsOnTargets="ResolveReferences"&gt; 
    &lt;ItemGroup&gt; 
      &lt;BuildOutputInPackage Include="@(ReferenceCopyLocalPaths-&amp;gt;WithMetadataValue('ReferenceSourceTarget', 'ProjectReference')-&amp;gt;WithMetadataValue('PrivateAssets', 'All'))" /&gt; 
    &lt;/ItemGroup&gt; 
&lt;/Target&gt; 
</code></pre>
<p>它要求将引用项目设置为PrivateAssets="all"<br>
或者直接通过VS的右键菜单设置属性，结果像下面这样</p>
<pre><code>&lt;ProjectReference Include="..\Core\Core.csproj"&gt;
  &lt;PrivateAssets&gt;All&lt;/PrivateAssets&gt;
&lt;/ProjectReference&gt;
</code></pre>
<h2 id="局限">局限</h2>
<p>假设有一组项目依赖关系如下：<br>
LibraryA -----&gt; Core ----&gt; CoreOfCore</p>
<p>为了实现上述效果，我们需要在LibraryA项目中将Core/CoreOfCore都引用进来。如果依赖项更多，则项目的依赖关系将变得不清晰。</p>
<p>所以该方案的局限就是不太能支持级联。</p>
<h2 id="回归">回归</h2>
<p>这样下来，还是.nuspec好用，可以灵活定义依赖项和文件。<br>
因此，在我最新版的<a href="https://marketplace.visualstudio.com/items?itemName=CnSharpStudio.NuPack" target="_blank" rel="noopener nofollow">NuPack</a> 17.1中，恢复了对.nuspec的支持，并增加了其在SDK style项目中的选项。<br>
下一篇详细介绍相关的情况。</p>

</div>
<div id="MySignature" role="contentinfo">
    <div id="AllanboltSignature">          

 <div>作者：<a href="http://cnsharp.com/" target="_blank">CnSharp工作室</a></div>        

<div>出处：<a href="http://www.cnblogs.com/cnsharp/" target="_blank">http://www.cnblogs.com/cnsharp/</a></div>        

<div>本文版权归CnSharp.com所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.</div>      


</div>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0.2617117448796296" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-06-06 10:05">2025-06-06 09:53</span>&nbsp;
<a href="https://www.cnblogs.com/cnsharp">Cn#工作室</a>&nbsp;
阅读(<span id="post_view_count">132</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18913607);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18913607', targetLink: 'https://www.cnblogs.com/cnsharp/p/18913607', title: '.NET SDK样式项目打包时如何将引用项目打进同一个包' })">举报</a>
</div>
