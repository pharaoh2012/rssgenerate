<!----> <meta itemprop="headline" content="å²è¯—çº§ âš¡ å®‡å®™æœ€å¼º ğŸ† vue3 å‡½æ•°å¼å¼¹çª— ğŸš€"> <meta itemprop="keywords" content="å‰ç«¯,Vue.js"> <meta itemprop="datePublished" content="2025-01-10T07:45:13.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ä¸€è·¯å‘åŒ—wow"> <meta itemprop="url" content="https://juejin.cn/user/3400105472033639"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-7cdd11fb="">
            å²è¯—çº§ âš¡ å®‡å®™æœ€å¼º ğŸ† vue3 å‡½æ•°å¼å¼¹çª— ğŸš€
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-7cdd11fb=""><div class="author-info-box" data-v-7cdd11fb=""><div class="author-name" data-v-7cdd11fb=""><a href="/user/3400105472033639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-1800aadb="" data-v-7cdd11fb=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-1800aadb="">
    ä¸€è·¯å‘åŒ—wow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-7cdd11fb=""><time datetime="2025-01-10T07:45:13.000Z" title="Fri Jan 10 2025 07:45:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-7cdd11fb="">
                    2025-01-10
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-7cdd11fb=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-7cdd11fb=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-7cdd11fb=""></circle></svg> <span class="views-count" data-v-7cdd11fb="">
                    8,494
                  </span> <span class="read-time" data-v-7cdd11fb=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-7cdd11fb=""><rect width="16" height="16" fill="none" data-v-7cdd11fb=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-7cdd11fb=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-7cdd11fb=""></path></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-7cdd11fb=""></div> <!----> <!----></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-7cdd11fb=""><div class="article-viewer markdown-body result"><h2 data-id="heading-0">å‰è¨€</h2>
<p>å‰å‡ å¤©åˆ†äº«äº†ä¸€ä¸ªä¼˜é›…å±•ç¤ºå¤§é‡å¼¹çª—ç»„ä»¶çš„æ–¹å¼ï¼ŒåŸæ–‡ï¼š <a href="https://juejin.cn/post/7454394839461249087" target="_blank" title="https://juejin.cn/post/7454394839461249087">å‡å¦‚ä½ çš„é¡µé¢ä¸Šæœ‰å‡ åä¸ªå¼¹çª—ï¼Œä½ ä¼šæ€æ ·ä¼˜é›…åœ°å±•ç¤ºå®ƒä»¬ï¼ŸğŸ§</a> è¯„è®ºåŒºä¹Ÿæœ‰ä¸€äº›è®¨è®ºï¼šæ¯”å¦‚ä¸æ”¯æŒæ’æ§½ï¼Œè¿˜æœ‰å°±æ˜¯è™½ç„¶ template å˜å¾—ç®€æ´äº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å¼•å…¥ä¸€ä¸ªåŠ¨æ€ç»„ä»¶ <strong>unityModal.vue</strong> ï¼Œå…·æœ‰ä¸€å®šçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚é‚£æˆ‘ä»¬ä»Šå¤©å°±ä¸€ä¸åšäºŒä¸ä¼‘ï¼Œå°è£…ä¸€ä¸ªå®‡å®™æœ€å¼ºçº§åˆ«å‡½æ•°å¼å¼¹çª—æ–¹æ³•ï¼Œ ä½¿ç”¨æ—¶åªéœ€è°ƒç”¨å³å¯ã€‚<br>
æˆ‘å¸Œæœ›è¿™ä¸ªæ–¹æ³•æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>æ”¯æŒæ‡’åŠ è½½ï¼ˆå¼‚æ­¥åŠ è½½å‡½æ•°ï¼‰</li>
<li>propsä¼ å‚</li>
<li>äº‹ä»¶ç»‘å®š</li>
<li>provide inject æ³¨å…¥æ•°æ®</li>
<li>å„ç§è‡ªå®šä¹‰æ’æ§½</li>
<li>æš´éœ²å†…éƒ¨æ–¹æ³•</li>
</ul>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å®ç°å®ƒã€‚</p>
<h2 data-id="heading-1">ä¸€ã€åŸºæœ¬å®ç°</h2>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæœ€åŸºæœ¬çš„å¼¹çª—ç»„ä»¶éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹è¦æ±‚ï¼š</p>
<ul>
<li>èƒ½å¤Ÿæ¥æ”¶çˆ¶ç»„ä»¶ä¼ è¿›æ¥çš„å‚æ•°</li>
<li>èƒ½å¤Ÿç»‘å®šè‡ªå®šä¹‰äº‹ä»¶æ¥æ”¶å­ç»„ä»¶çš„é€šçŸ¥</li>
</ul>
<h4 data-id="heading-2">å¼¹çª—ç»„ä»¶</h4>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬å¼¹çª—ç»„ä»¶ï¼š</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-modal</span> <span class="hljs-attr">v-model:open</span>=<span class="hljs-string">"bindVisible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">ok</span>=<span class="hljs-string">"handleOk"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çˆ¶ç»„ä»¶ä¼ å…¥çš„ propï¼š{{ prop }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a-modal</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useVModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">visible</span>: boolean
  <span class="hljs-attr">title</span>: string
  <span class="hljs-attr">prop</span>: string
}&gt;()

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:visible'</span>, <span class="hljs-string">'loadList'</span>])
<span class="hljs-keyword">const</span> bindVisible = <span class="hljs-title function_">useVModel</span>(props, <span class="hljs-string">'visible'</span>, emit)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleOk</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-comment">// å‡è£…è¯·æ±‚ä¸šåŠ¡æ¥å£...</span>
  bindVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'loadList'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-3">ä½¿ç”¨æ–¹å¼</h4>
<p>æˆ‘æƒ³è¦åœ¨é¡µé¢ä¸­è¿™æ ·ä½¿ç”¨å®ƒï¼šä»…éœ€è¦é€šè¿‡è°ƒç”¨å‡½æ•°çš„å½¢å¼è®©å¼¹çª—æ˜¾ç¤ºï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸ç”¨å†™ï¼Œè¿™æ ·å¼€å‘æ—¶æŠŠæ³¨æ„åŠ›éƒ½èšé›†åœ¨è¿™ä¸ªå‡½æ•°ä¸Šï¼Œé€»è¾‘é«˜åº¦å†…èšã€‚</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onClick"</span>&gt;</span>å¼¹çª—æŒ‰é’®<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-title function_">showModal</span>({
    <span class="hljs-attr">modalComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/home/components/modal.vue'</span>),
    <span class="hljs-attr">title</span>: <span class="hljs-string">'å¼¹çª—æ ‡é¢˜'</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'å¼¹çª—ç»„ä»¶éœ€è¦çš„å‚æ•°'</span>,
    <span class="hljs-attr">onLoadList</span>: <span class="hljs-function">() =&gt;</span> message.<span class="hljs-title function_">success</span>(<span class="hljs-string">'è¡¨å•å·²ç»æäº¤ï¼Œåˆ·æ–°åˆ—è¡¨'</span>)
  })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-4">showModal å…·ä½“å®ç°</h4>
<p>ç¡®å®šäº† showModal çš„ä½¿ç”¨æ–¹å¼ä¹‹åï¼Œæˆ‘ä»¬ç€æ‰‹å»å®ç°å®ƒï¼š</p>
<ol>
<li>é¦–å…ˆå‡½æ•°å¿…é¡»æ¥æ”¶ä¸€ä¸ªå¼¹çª—ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶å¯ä»¥æ˜¯æ‡’åŠ è½½çš„ï¼ˆä¸€ä¸ªå¼‚æ­¥åŠ è½½å‡½æ•°ï¼‰ï¼Œå¦‚æœæ‡’åŠ è½½ï¼Œæˆ‘ä»¬ä¼šç”¨ <strong>defineAsyncComponent</strong> æŠŠå®ƒå®šä¹‰ä¸ºä¸€ä¸ªå¼‚æ­¥ç»„ä»¶ã€‚</li>
<li>å¯ä»¥é€šè¿‡ appendTo å‚æ•°æŒ‡å®šæŒ‚è½½çš„ä½ç½®ï¼ˆé»˜è®¤ä¸º document.body)</li>
<li>æ‹¿åˆ°ä¼ è¿›æ¥çš„å‚æ•°ã€äº‹ä»¶ã€‚</li>
<li>ä½¿ç”¨ <strong>h</strong> å‡½æ•°åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”é€šè¿‡ <strong>render</strong> å‡½æ•°æŠŠèŠ‚ç‚¹æ¸²æŸ“åˆ°éœ€è¦æŒ‚è½½çš„DOMä¸Šã€‚</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineAsyncComponent, h, nextTick, render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

interface <span class="hljs-title class_">IModalOptions</span> {
  <span class="hljs-attr">modalComponent</span>: <span class="hljs-title class_">Component</span> | any
  appendTo?: <span class="hljs-title class_">HTMLElement</span> | string
  [<span class="hljs-attr">name</span>: string]: unknown
}

<span class="hljs-keyword">const</span> getAppendToElement = (<span class="hljs-attr">appendTo</span>: <span class="hljs-title class_">IModalOptions</span>[<span class="hljs-string">'appendTo'</span>]): <span class="hljs-function"><span class="hljs-params">HTMLElement</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">appendToEL</span>: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
  <span class="hljs-keyword">if</span> (appendTo) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> appendTo === <span class="hljs-string">'string'</span>) {
      appendToEL = <span class="hljs-variable language_">document</span>.<span class="hljs-property">querySelector</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(appendTo)
    }
    <span class="hljs-keyword">if</span> (appendTo <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLElement</span>) {
      appendToEL = appendTo
    }
    <span class="hljs-keyword">if</span> (!(appendToEL <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLElement</span>)) {
      appendToEL = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
    }
  }
  <span class="hljs-keyword">return</span> appendToEL
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showModal</span>(<span class="hljs-params">options: IModalOptions</span>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
  <span class="hljs-keyword">const</span> isAsync = <span class="hljs-keyword">typeof</span> options.<span class="hljs-property">modalComponent</span> === <span class="hljs-string">'function'</span>

  <span class="hljs-keyword">const</span> modalComponent = isAsync
    ? <span class="hljs-title function_">defineAsyncComponent</span>(options.<span class="hljs-property">modalComponent</span>)
    : options.<span class="hljs-property">modalComponent</span>

  <span class="hljs-keyword">const</span> <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = {}
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> options) {
    <span class="hljs-keyword">if</span> (![<span class="hljs-string">'modalComponent'</span>, <span class="hljs-string">'appendTo'</span>].<span class="hljs-title function_">includes</span>(key)) props[key] = options[key]
  }

  <span class="hljs-keyword">const</span> vNode = <span class="hljs-title function_">h</span>(modalComponent, {
    <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
    ...props,
    <span class="hljs-string">'onUpdate:visible'</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">close</span>()
      })
    }
  })

  <span class="hljs-title function_">render</span>(vNode, container)
  <span class="hljs-title function_">getAppendToElement</span>(options.<span class="hljs-property">appendTo</span>).<span class="hljs-title function_">appendChild</span>(container)

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">render</span>(<span class="hljs-literal">null</span>, container)
    container.<span class="hljs-property">parentNode</span>?.<span class="hljs-title function_">removeChild</span>(container)
  }
}
</code></pre>
<h2 data-id="heading-5">äºŒã€æ³¨å…¥æ•°æ®</h2>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½ä¼šä½¿ç”¨ provide ç»™ä¸‹çº§ç»„ä»¶æä¾›æ•°æ®ã€‚ä» showModal å‡½æ•°çš„å®ç°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¼¹çª—ç»„ä»¶é»˜è®¤æ˜¯æŒ‚è½½åˆ° document.body ä¸‹çš„ï¼Œè¿™ä¼šä½¿å¼¹çª—ç»„ä»¶è„±ç¦»åŸæœ‰ç»„ä»¶æ ‘ï¼Œå†…éƒ¨å°±æ— æ³•é€šè¿‡ inject æ‹¿åˆ°ä¸Šçº§ç»„ä»¶ provide çš„æ•°æ®äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹é€ ä¸€ä¸‹æˆ‘ä»¬çš„ showModal å‡½æ•°ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineAsyncComponent, getCurrentInstance, h, nextTick, render, createVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// çœç•¥éƒ¨åˆ†ä»£ç ...</span>

<span class="hljs-comment">// start</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProvides</span>(<span class="hljs-params">instance: any</span>) {
  <span class="hljs-keyword">let</span> provides = instance?.<span class="hljs-property">provides</span> || {}
  <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">parent</span>) {
    provides = { ...provides, ...<span class="hljs-title function_">getProvides</span>(instance.<span class="hljs-property">parent</span>) }
  }
  <span class="hljs-keyword">return</span> provides
}
<span class="hljs-comment">// end</span>

<span class="hljs-comment">// ä¿®æ”¹åçš„ useShowModal</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useShowModal</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// start</span>
  <span class="hljs-keyword">const</span> currentInstance = <span class="hljs-title function_">getCurrentInstance</span>() <span class="hljs-keyword">as</span> any
  <span class="hljs-keyword">const</span> provides = <span class="hljs-title function_">getProvides</span>(currentInstance)
  <span class="hljs-comment">// end</span>
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">showModal</span>(<span class="hljs-params">options: IModalOptions</span>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    <span class="hljs-keyword">const</span> isAsync = <span class="hljs-keyword">typeof</span> options.<span class="hljs-property">modalComponent</span> === <span class="hljs-string">'function'</span>

    <span class="hljs-keyword">const</span> modalComponent = isAsync
      ? <span class="hljs-title function_">defineAsyncComponent</span>(options.<span class="hljs-property">modalComponent</span>)
      : options.<span class="hljs-property">modalComponent</span>

    <span class="hljs-keyword">const</span> <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> options) {
      <span class="hljs-keyword">if</span> (![<span class="hljs-string">'modalComponent'</span>, <span class="hljs-string">'appendTo'</span>].<span class="hljs-title function_">includes</span>(key)) props[key] = options[key]
    }

    <span class="hljs-comment">// start</span>
    <span class="hljs-keyword">const</span> vNode = <span class="hljs-title function_">createVNode</span>({
      <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>() <span class="hljs-keyword">as</span> any
        <span class="hljs-keyword">if</span> (instance) {
          instance.<span class="hljs-property">provides</span> = { ...instance.<span class="hljs-property">provides</span>, ...provides }
        }
      },
      <span class="hljs-attr">render</span>: <span class="hljs-function">() =&gt;</span>
        <span class="hljs-title function_">h</span>(modalComponent, {
          <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
          ...props,
          <span class="hljs-string">'onUpdate:visible'</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
              <span class="hljs-title function_">close</span>()
            })
          }
        })
    })
    <span class="hljs-comment">// end</span>

    <span class="hljs-title function_">render</span>(vNode, container)
    <span class="hljs-title function_">getAppendToElement</span>(options.<span class="hljs-property">appendTo</span>).<span class="hljs-title function_">appendChild</span>(container)

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"></span>) {
      <span class="hljs-title function_">render</span>(<span class="hljs-literal">null</span>, container)
      container.<span class="hljs-property">parentNode</span>?.<span class="hljs-title function_">removeChild</span>(container)
    }
  }

  <span class="hljs-keyword">return</span> showModal
}
</code></pre>
<p>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„ showModal æ ¸å¿ƒå®ç°å‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚æ”¹åŠ¨çš„åªæœ‰ä¸¤ç‚¹ï¼š</p>
<ol>
<li>æŠŠ showModal æ”¾åˆ°äº† useShowModal è¿™ä¸ªç»„åˆå¼å‡½æ•°é‡Œé¢å¹¶ä¸”è¿”å›ç»™ä½¿ç”¨è€…ã€‚ç›®çš„æ˜¯å½“ä½¿ç”¨è€…åœ¨ç»„ä»¶å†…è°ƒç”¨ useShowModal çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ <strong>getCurrentInstance</strong> è·å–å½“å‰ç»„ä»¶å®ä¾‹ï¼Œå¹¶æŠŠæ‰€æœ‰ä¸Šçº§ç»„ä»¶ provide çš„æ•°æ®å…¨éƒ¨å–å‡ºæ¥ï¼Œæ·»åŠ åˆ°å¼¹çª—ç»„ä»¶çš„å®ä¾‹ä¸Šã€‚</li>
<li>ä½¿ç”¨ <strong>createVNode</strong> åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œè¿™æ ·å¯ä»¥åœ¨ setup å‡½æ•°ä¸­è·å–åˆ°å¼¹çª—ç»„ä»¶å®ä¾‹ï¼Œå°±å¯ä»¥æ·»åŠ ä¸Šçº§ç»„ä»¶ provide çš„æ•°æ®äº†ã€‚</li>
</ol>
<p>è¿™æ ·ä¸ç®¡æ˜¯åœ¨æ ¹ç»„ä»¶ App.vue é‡Œ provide çš„æ•°æ®ï¼Œè¿˜æ˜¯çˆ¶ç»„ä»¶ provide çš„æ•°æ®ï¼ˆåªè¦æ˜¯ä¸Šçº§ç»„ä»¶éƒ½å¯ä»¥ï¼‰ï¼Œå¼¹çª—å†…éƒ¨ç»Ÿç»Ÿéƒ½èƒ½æ‹¿åˆ°ï¼Œè§£å†³äº†å¼¹çª—è„±ç¦»ç»„ä»¶æ ‘å¼•èµ·çš„æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚</p>
<h2 data-id="heading-6">ä¸‰ã€å®ç°æ’æ§½</h2>
<p>è¿™ä¸ªå¾ˆå¥½è§£å†³ï¼Œå› ä¸ºåœ¨ vue ä¸­ï¼Œæˆ‘ä»¬åœ¨ template é‡Œå†™çš„æ’æ§½ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªä¸ªå‡½æ•°ã€‚åˆšå¥½ h å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å¯ä»¥æ¥æ”¶æ’æ§½å‡½æ•°çš„ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// å®Œæ•´å‚æ•°ç­¾å</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">h</span>(<span class="hljs-params">
  type: string | Component,
  props?: object | <span class="hljs-literal">null</span>,
  children?: Children | Slot | Slots
</span>): <span class="hljs-title class_">VNode</span>

<span class="hljs-comment">// çœç•¥ props</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">h</span>(<span class="hljs-params">type: string | Component, children?: Children | Slot</span>): <span class="hljs-title class_">VNode</span>

type <span class="hljs-title class_">Children</span> = string | number | boolean | <span class="hljs-title class_">VNode</span> | <span class="hljs-literal">null</span> | <span class="hljs-title class_">Children</span>[]

type <span class="hljs-title class_">Slot</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Children</span>

type <span class="hljs-title class_">Slots</span> = { [<span class="hljs-attr">name</span>: string]: <span class="hljs-title class_">Slot</span> }
</code></pre>
<p>é‚£æˆ‘ä»¬åªéœ€è¦ç»™æˆ‘ä»¬çš„ showModal å‡½æ•°å†æ·»åŠ ä¸€ä¸ª slots å‚æ•°å³å¯ã€‚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineAsyncComponent, getCurrentInstance, h, nextTick, render, createVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// æ–°å¢</span>
type <span class="hljs-title class_">RawSlots</span> = {
  [<span class="hljs-attr">name</span>: string]: unknown
  $stable?: boolean
}
interface <span class="hljs-title class_">IModalOptions</span> {
  <span class="hljs-attr">modalComponent</span>: <span class="hljs-title class_">Component</span> | any
  appendTo?: <span class="hljs-title class_">HTMLElement</span> | string
  slots?: <span class="hljs-title class_">RawSlots</span>  <span class="hljs-comment">// æ–°å¢</span>
  [<span class="hljs-attr">name</span>: string]: unknown
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useShowModal</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> vNode = <span class="hljs-title function_">createVNode</span>({
      <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>() <span class="hljs-keyword">as</span> any
        <span class="hljs-keyword">if</span> (instance) {
          instance.<span class="hljs-property">provides</span> = { ...instance.<span class="hljs-property">provides</span>, ...provides }
        }
      },
      <span class="hljs-attr">render</span>: <span class="hljs-function">() =&gt;</span>
        <span class="hljs-title function_">h</span>(
          modalComponent,
          {
            <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
            ...props,
            <span class="hljs-string">'onUpdate:visible'</span>: <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">close</span>()
              })
            }
          },
          options.<span class="hljs-property">slots</span> <span class="hljs-comment">// æ–°å¢</span>
        )
    })
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä¼ å…¥æ’æ§½å‡½æ•°ï¼š</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-modal</span> <span class="hljs-attr">v-model:open</span>=<span class="hljs-string">"bindVisible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">ok</span>=<span class="hljs-string">"handleOk"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çˆ¶ç»„ä»¶ä¼ å…¥çš„ propï¼š{{ prop }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- æ³¨å…¥çš„æ•°æ® --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çˆ¶ç»„ä»¶ provide çš„ä¿¡æ¯ï¼š{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Appæ ¹ç»„ä»¶ provide çš„ä¿¡æ¯ï¼š{{ appMessage }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- æ’æ§½ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"{ type: 'é»˜è®¤æ’æ§½' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"footer"</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"{ type: 'å…·åæ’æ§½' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a-modal</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useVModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">visible</span>: boolean
  <span class="hljs-attr">title</span>: string
  <span class="hljs-attr">prop</span>: string
}&gt;()

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:visible'</span>, <span class="hljs-string">'loadList'</span>])
<span class="hljs-keyword">const</span> bindVisible = <span class="hljs-title function_">useVModel</span>(props, <span class="hljs-string">'visible'</span>, emit)
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'message'</span>)
<span class="hljs-keyword">const</span> appMessage = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'appMessage'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleOk</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-comment">// å‡è£…è¯·æ±‚ä¸šåŠ¡æ¥å£...</span>
  bindVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'loadList'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ä½¿ç”¨</span>
 <span class="hljs-title function_">showModal2</span>({
    <span class="hljs-attr">modalComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/home/components/modal.vue'</span>),
    <span class="hljs-attr">title</span>: <span class="hljs-string">'å¼¹çª—æ ‡é¢˜'</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'å¼¹çª—ç»„ä»¶éœ€è¦çš„å‚æ•°'</span>,
    <span class="hljs-attr">slots</span>: {
      <span class="hljs-attr">default</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>), <span class="hljs-comment">// é»˜è®¤æ’æ§½</span>
      <span class="hljs-attr">footer</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>)  <span class="hljs-comment">// å…·åæ’æ§½</span>
    },
    <span class="hljs-attr">onLoadList</span>: <span class="hljs-function">() =&gt;</span> message.<span class="hljs-title function_">success</span>(<span class="hljs-string">'è¡¨å•å·²ç»æäº¤ï¼Œåˆ·æ–°åˆ—è¡¨'</span>)
  })
</code></pre>
<p>æ•ˆæœï¼š<br></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b07e7651c894ae4b9e49fd6feb01824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6Lev5ZCR5YyXd293:q75.awebp?rk3s=f64ab15b&amp;x-expires=1739721890&amp;x-signature=UyOingvhm%2FG1ipW%2FWuS566W18WY%3D" alt="image.png" loading="lazy"></p>
<h2 data-id="heading-7">å››ã€æš´éœ²æ–¹æ³•</h2>
<p>è¿™é‡Œæš´éœ²æ–¹æ³•çš„æ–¹å¼å…¶å®ä¸å¹³æ—¶æˆ‘ä»¬åœ¨vueç»„ä»¶ä¸­å®ç°åŸç†æ–¹å¼ä¸€æ ·ï¼Œéƒ½æ˜¯ç»™ç»„ä»¶ç»‘å®š refï¼Œç„¶åé€šè¿‡ ref æ‹¿åˆ°ç»„ä»¶å®ä¾‹è¿›è€Œæ“ä½œç»„ä»¶æš´éœ²çš„æ–¹æ³•ï¼Œæ¥çœ‹ä¸€ä¸‹å…·ä½“å®ç°ï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ...</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useShowModal</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">showModal</span>(<span class="hljs-params">options: IModalOptions</span>) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">const</span> isAsync = <span class="hljs-keyword">typeof</span> options.<span class="hljs-property">modalComponent</span> === <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">const</span> innerRef = <span class="hljs-title function_">ref</span>()  <span class="hljs-comment">// æ–°å¢</span>

    <span class="hljs-keyword">const</span> vNode = <span class="hljs-title function_">createVNode</span>({
      <span class="hljs-comment">// ...</span>
      <span class="hljs-attr">render</span>: <span class="hljs-function">() =&gt;</span>
        <span class="hljs-title function_">h</span>(
          modalComponent,
          {
            <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
            ...props,
            <span class="hljs-attr">ref</span>: innerRef,  <span class="hljs-comment">// æ–°å¢</span>
            <span class="hljs-string">'onUpdate:visible'</span>: <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">close</span>()
              })
            }
          },
          options.<span class="hljs-property">slots</span>
        )
    })

    <span class="hljs-comment">// æ–°å¢</span>
    <span class="hljs-keyword">if</span> (!isAsync) {
      <span class="hljs-keyword">return</span> innerRef.<span class="hljs-property">value</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-title function_">watch</span>(
          innerRef,
          <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(innerRef.<span class="hljs-property">value</span>)
          },
          {
            <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>
          }
        )
      })
    }
  }
  <span class="hljs-keyword">return</span> showModal
}
</code></pre>
<p>è¿™é‡Œæˆ‘åŒºåˆ†äº†ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>å¼‚æ­¥ç»„ä»¶ï¼šh å‡½æ•°åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœæ˜¯åŠ¨æ€å¯¼å…¥çš„ç»„ä»¶ï¼Œref çš„ç»‘å®šæ˜¯å¼‚æ­¥çš„ï¼ˆæŒ‚è½½éœ€è¦æ—¶é—´ï¼‰ï¼Œæ²¡æ³•åŒæ­¥åœ°è·å–ç»„ä»¶å®ä¾‹ï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬ ref å€¼çš„å˜åŒ–ï¼Œå½“å€¼å‘ç”Ÿå˜åŒ–æ—¶å°±æ˜¯ä»£è¡¨æŒ‚è½½å®Œæ¯•äº†ï¼Œè¿™ä¸ªæ—¶å€™å† resolve ç»“æœã€‚</li>
<li>åŒæ­¥ç»„ä»¶ï¼šç›´æ¥è¿”å›ç»„ä»¶å®ä¾‹ã€‚</li>
</ol>
<p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>å¦‚æœä½ ä¼ å…¥çš„ç»„ä»¶æ˜¯å¼‚æ­¥åŠ è½½å‡½æ•°ï¼Œè¯·é€šè¿‡ await å»è·å–å¼‚æ­¥ç»„ä»¶å®ä¾‹ã€‚</li>
<li>å¦‚æœåŒæ­¥ç»„ä»¶ï¼Œç›´æ¥æ¥æ”¶ç»„ä»¶å®ä¾‹å³å¯ã€‚</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Modal</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">showModal</span>({
    <span class="hljs-attr">modalComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/home/components/modal.vue'</span>),
    <span class="hljs-attr">title</span>: <span class="hljs-string">'å¼¹çª—æ ‡é¢˜'</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'å¼¹çª—ç»„ä»¶éœ€è¦çš„å‚æ•°'</span>,
    <span class="hljs-attr">slots</span>: {
      <span class="hljs-attr">default</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>),
      <span class="hljs-attr">footer</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>)
    },
    <span class="hljs-attr">onLoadList</span>: <span class="hljs-function">() =&gt;</span> message.<span class="hljs-title function_">success</span>(<span class="hljs-string">'è¡¨å•å·²ç»æäº¤ï¼Œåˆ·æ–°åˆ—è¡¨'</span>)
  })
<span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">getInfo</span>()
</code></pre>
<h2 data-id="heading-8">äº”ã€æ€»ç»“</h2>
<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®‡å®™æœ€å¼ºçº§åˆ«å‡½æ•°å¼å¼¹çª—ç»„ä»¶çš„æ–¹æ³•ï¼Œå®ƒé€‚åº”ç»å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>æ”¯æŒæ‡’åŠ è½½ï¼ˆå¼‚æ­¥åŠ è½½å‡½æ•°ï¼‰</li>
<li>propsä¼ å‚</li>
<li>äº‹ä»¶ç»‘å®š</li>
<li>provide inject æ³¨å…¥æ•°æ®</li>
<li>å„ç§è‡ªå®šä¹‰æ’æ§½</li>
<li>æš´éœ²å†…éƒ¨æ–¹æ³•</li>
</ul>
<h2 data-id="heading-9">å…­ã€æºç </h2>
<h4 data-id="heading-10">modal.vue</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a-modal</span> <span class="hljs-attr">v-model:open</span>=<span class="hljs-string">"bindVisible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">ok</span>=<span class="hljs-string">"handleOk"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çˆ¶ç»„ä»¶ä¼ å…¥çš„ propï¼š{{ prop }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çˆ¶ç»„ä»¶ provide çš„ä¿¡æ¯ï¼š{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Appæ ¹ç»„ä»¶ provide çš„ä¿¡æ¯ï¼š{{ appMessage }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"{ type: 'é»˜è®¤æ’æ§½' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"footer"</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"{ type: 'å…·åæ’æ§½' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a-modal</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useVModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">visible</span>: boolean
  <span class="hljs-attr">title</span>: string
  <span class="hljs-attr">prop</span>: string
}&gt;()

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:visible'</span>, <span class="hljs-string">'loadList'</span>])
<span class="hljs-keyword">const</span> bindVisible = <span class="hljs-title function_">useVModel</span>(props, <span class="hljs-string">'visible'</span>, emit)
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'message'</span>)
<span class="hljs-keyword">const</span> appMessage = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'appMessage'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleOk</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-comment">// å‡è£…è¯·æ±‚ä¸šåŠ¡æ¥å£...</span>
  bindVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'loadList'</span>)
}

<span class="hljs-title function_">defineExpose</span>({
  <span class="hljs-title function_">getInfo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> {
      message,
      appMessage
    }
  }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-11">index.vue</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onClick"</span>&gt;</span>å¼¹çª—<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { provide, h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue'</span>
<span class="hljs-keyword">import</span> useShowModal <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/useShowModal'</span>

<span class="hljs-title function_">provide</span>(<span class="hljs-string">'message'</span>, <span class="hljs-string">'æˆ‘æ˜¯çˆ¶ç»„ä»¶homeé¡µé¢'</span>)
<span class="hljs-keyword">const</span> showModal = <span class="hljs-title function_">useShowModal</span>()
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">Modal</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">showModal</span>({
    <span class="hljs-attr">modalComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/home/components/modal.vue'</span>),
    <span class="hljs-attr">title</span>: <span class="hljs-string">'å¼¹çª—æ ‡é¢˜'</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'å¼¹çª—ç»„ä»¶éœ€è¦çš„å‚æ•°'</span>,
    <span class="hljs-attr">slots</span>: {
      <span class="hljs-attr">default</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>),
      <span class="hljs-attr">footer</span>: <span class="hljs-function">(<span class="hljs-params">arg: any</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, arg.<span class="hljs-property">type</span>)
    },
    <span class="hljs-attr">onLoadList</span>: <span class="hljs-function">() =&gt;</span> message.<span class="hljs-title function_">success</span>(<span class="hljs-string">'è¡¨å•å·²ç»æäº¤ï¼Œåˆ·æ–°åˆ—è¡¨'</span>)
  })
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">getInfo</span>())
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-12">useShowModal.ts</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
  defineAsyncComponent,
  getCurrentInstance,
  h,
  nextTick,
  render,
  createVNode,
  ref,
  watch
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

type <span class="hljs-title class_">RawSlots</span> = {
  [<span class="hljs-attr">name</span>: string]: unknown
  $stable?: boolean
}
interface <span class="hljs-title class_">IModalOptions</span> {
  <span class="hljs-attr">modalComponent</span>: <span class="hljs-title class_">Component</span> | any
  appendTo?: <span class="hljs-title class_">HTMLElement</span> | string
  slots?: <span class="hljs-title class_">RawSlots</span>
  [<span class="hljs-attr">name</span>: string]: unknown
}

<span class="hljs-keyword">const</span> getAppendToElement = (<span class="hljs-attr">appendTo</span>: <span class="hljs-title class_">IModalOptions</span>[<span class="hljs-string">'appendTo'</span>]): <span class="hljs-function"><span class="hljs-params">HTMLElement</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">appendToEL</span>: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
  <span class="hljs-keyword">if</span> (appendTo) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> appendTo === <span class="hljs-string">'string'</span>) {
      appendToEL = <span class="hljs-variable language_">document</span>.<span class="hljs-property">querySelector</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(appendTo)
    }
    <span class="hljs-keyword">if</span> (appendTo <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLElement</span>) {
      appendToEL = appendTo
    }
    <span class="hljs-keyword">if</span> (!(appendToEL <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLElement</span>)) {
      appendToEL = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
    }
  }
  <span class="hljs-keyword">return</span> appendToEL
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProvides</span>(<span class="hljs-params">instance: any</span>) {
  <span class="hljs-keyword">let</span> provides = instance?.<span class="hljs-property">provides</span> || {}
  <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">parent</span>) {
    provides = { ...provides, ...<span class="hljs-title function_">getProvides</span>(instance.<span class="hljs-property">parent</span>) }
  }
  <span class="hljs-keyword">return</span> provides
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useShowModal</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> currentInstance = <span class="hljs-title function_">getCurrentInstance</span>() <span class="hljs-keyword">as</span> any
  <span class="hljs-keyword">const</span> provides = <span class="hljs-title function_">getProvides</span>(currentInstance)

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">showModal</span>(<span class="hljs-params">options: IModalOptions</span>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    <span class="hljs-keyword">const</span> isAsync = <span class="hljs-keyword">typeof</span> options.<span class="hljs-property">modalComponent</span> === <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">const</span> innerRef = <span class="hljs-title function_">ref</span>()

    <span class="hljs-keyword">const</span> modalComponent = isAsync
      ? <span class="hljs-title function_">defineAsyncComponent</span>(options.<span class="hljs-property">modalComponent</span>)
      : options.<span class="hljs-property">modalComponent</span>

    <span class="hljs-keyword">const</span> <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> options) {
      <span class="hljs-keyword">if</span> (![<span class="hljs-string">'modalComponent'</span>, <span class="hljs-string">'appendTo'</span>, <span class="hljs-string">'slots'</span>].<span class="hljs-title function_">includes</span>(key)) props[key] = options[key]
    }

    <span class="hljs-keyword">const</span> vNode = <span class="hljs-title function_">createVNode</span>({
      <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>() <span class="hljs-keyword">as</span> any
        <span class="hljs-keyword">if</span> (instance) {
          instance.<span class="hljs-property">provides</span> = { ...instance.<span class="hljs-property">provides</span>, ...provides }
        }
      },
      <span class="hljs-attr">render</span>: <span class="hljs-function">() =&gt;</span>
        <span class="hljs-title function_">h</span>(
          modalComponent,
          {
            <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
            ...props,
            <span class="hljs-attr">ref</span>: innerRef,
            <span class="hljs-string">'onUpdate:visible'</span>: <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">close</span>()
              })
            }
          },
          options.<span class="hljs-property">slots</span>
        )
    })

    <span class="hljs-title function_">render</span>(vNode, container)
    <span class="hljs-title function_">getAppendToElement</span>(options.<span class="hljs-property">appendTo</span>).<span class="hljs-title function_">appendChild</span>(container)

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"></span>) {
      <span class="hljs-title function_">render</span>(<span class="hljs-literal">null</span>, container)
      container.<span class="hljs-property">parentNode</span>?.<span class="hljs-title function_">removeChild</span>(container)
    }

    <span class="hljs-keyword">if</span> (!isAsync) {
      <span class="hljs-keyword">return</span> innerRef.<span class="hljs-property">value</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-title function_">watch</span>(
          innerRef,
          <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(innerRef.<span class="hljs-property">value</span>)
          },
          {
            <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>
          }
        )
      })
    }
  }

  <span class="hljs-keyword">return</span> showModal
}
</code></pre></div></div>