
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wesleyUP/p/18780477" title="发布于 2025-03-19 10:08">
    <span role="heading" aria-level="2">Shell脚本实现服务器多台免密</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h4 id="简介"><strong>简介</strong></h4>
<p>本脚本（auto_ssh_batch.sh）用于在多台主机之间快速配置SSH免密登录，并支持远程传输脚本/文件及执行命令。通过 <code>pass</code> 文件提供统一认证凭据，通过 <code>nodes</code> 文件定义目标主机列表，实现批量自动化操作。</p>
<h4 id="下载"><strong>下载</strong></h4>
<pre><code class="language-bash">git clone https://gitee.com/wesley_li0/NoPassword.git
</code></pre>
<h4 id="特别说明公司">特别说明（公司）：</h4>
<p>使用非root用户需要创建用户并添加root组，并且配置信任的sudo权限，可以使用命令实现</p>
<p>USER          : 用户名</p>
<p>PASSWORD：密码</p>
<pre><code class="language-bash">USER=your_user &amp;&amp; PASSWORD=your_password &amp;&amp; useradd -m -G root -s /bin/bash "$USER" &amp;&amp; echo "$USER:$PASSWORD" | chpasswd &amp;&amp; echo "$USER ALL=(ALL) NOPASSWD:ALL" &gt;&gt; /etc/sudoers.d/$USER
</code></pre>
<hr>
<h4 id="前提条件"><strong>前提条件</strong></h4>
<ol>
<li><strong>操作系统</strong>：目标主机需为 RHEL/CentOS 7 系统（因依赖 <code>sshpass-1.06-2.el7.x86_64.rpm</code>）。</li>
<li><strong>权限要求</strong>：
<ul>
<li>执行脚本的主机需具有root权限以安装 <code>sshpass</code>。</li>
<li>所有目标主机的SSH服务已启动，且防火墙允许SSH端口（默认22）通信。</li>
<li>所有主机用户名密码一致（免密完成后需改密码不影响免密）</li>
</ul>
</li>
</ol>
<p><strong>文件准备</strong>：确保以下文件及目录结构存在：</p>
<pre><code class="language-plain">/root/NoPassword/             # 脚本存放与用户家目录下
├── auto_ssh_batch.sh         # 主执行脚本
├── bin
│   └── generate_ssh_key.sh   # 待分发的远程执行脚本
├── config
│   └── nodes                 # 存储目标主机IP和节点ID
└── main
    └── sshpass-1.06-2.el7.x86_64.rpm  # sshpass安装包
</code></pre>
<hr>
<h4 id="配置文件格式"><strong>配置文件格式</strong></h4>
<p><code>**nodes**</code>** 文件**<br>
每行定义一个目标主机的IP和节点ID (ID尽量与后续集群自动化脚本ID一致，若无执行集群脚本需求，ID自定义，仅作为输出机器标识使用)，空格分隔：</p>
<pre><code class="language-bash">IP_Address Node_ID User Password
</code></pre>
<p><em>示例：</em></p>
<pre><code class="language-plain">192.168.1.10 1 root root123
192.168.1.11 2 root root123
</code></pre>
<hr>
<h4 id="脚本使用方法"><strong>脚本使用方法</strong></h4>
<h4 id="ssh自定义端口"><strong>SSH自定义端口</strong></h4>
<pre><code>- SSH 端口指定，修改 `auto_ssh_batch.sh` 脚本中的`SSH_PORT`变量
- `SSH_PORT` 该变量用于指定 SSH 链接端口，默认 22 
</code></pre>
<p><strong>放置依赖文件</strong></p>
<pre><code>- 将 `sshpass` 的 RPM 包放入 `main/` 目录（默认已存在）。
- 确保 `generate_ssh_key.sh` 脚本位于 `bin/` 目录。
</code></pre>
<p><strong>赋予执行权限，并执行脚本</strong></p>
<pre><code class="language-bash">sudo chmod +x auto_ssh_batch.sh 
sudo sh auto_ssh_batch.sh



# 脚本运行结束后使用ssh验证
# 默认ssh端口
ssh username@ip

# 指定ssh端口
ssh -p xx username@ip
</code></pre>
<p><strong>-------------------------脚本使用到此结束--------------------</strong></p>
<hr>
<h4 id="脚本执行流程"><strong>脚本执行流程</strong></h4>
<ol>
<li><strong>文件检查</strong><br>
验证 <code>config/pass</code> 和 <code>config/nodes</code> 是否存在，格式是否正确。</li>
<li><strong>初始化环境</strong>
<ul>
<li>生成本地SSH密钥对（如不存在）。</li>
<li>安装 <code>sshpass</code>（若未安装）。</li>
</ul>
</li>
<li><strong>批量操作</strong><br>
遍历 <code>nodes</code> 文件中的每个IP：
<ul>
<li><strong>分发公钥</strong>：使用 <code>sshpass</code> 将公钥复制到目标主机，实现免密登录。</li>
<li><strong>传输文件</strong>：将 <code>generate_ssh_key.sh</code>、<code>pass</code>、<code>nodes</code>、<code>sshpass</code> 上传到目标主机的 <code>/tmp</code>。</li>
<li><strong>远程执行</strong>：在目标主机上运行 <code>generate_ssh_key.sh</code>。</li>
</ul>
</li>
</ol>
<hr>
<h4 id="注意事项"><strong>注意事项</strong></h4>
<ol>
<li><strong>安全性警告</strong>
<ul>
<li>nodes 文件中密码以明文存储，建议仅在受信任环境使用。</li>
<li>脚本使用 <code>-o StrictHostKeyChecking=no</code>，自动信任主机密钥，可能存在中间人攻击风险。</li>
</ul>
</li>
<li><strong>错误处理</strong>
<ul>
<li>若某主机公钥分发失败，脚本会跳过该主机继续执行。</li>
<li>传输文件或远程命令失败时，查看错误输出并检查网络连通性。</li>
</ul>
</li>
<li><strong>日志输出</strong><br>
执行过程中会显示详细日志，包括成功/失败的主机IP及操作状态。</li>
</ol>
<hr>
<p>通过以上步骤，您可快速完成多主机SSH免密登录配置及批量远程操作。</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.17686388467592593" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-19 10:08">2025-03-19 10:08</span>&nbsp;
<a href="https://www.cnblogs.com/wesleyUP">樵夫-</a>&nbsp;
阅读(<span id="post_view_count">38</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18780477" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18780477);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18780477', targetLink: 'https://www.cnblogs.com/wesleyUP/p/18780477', title: 'Shell脚本实现服务器多台免密' })">举报</a>
</div>
        