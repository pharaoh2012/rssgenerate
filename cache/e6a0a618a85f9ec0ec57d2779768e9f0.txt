<!----> <meta itemprop="headline" content="ä¸€ä¸ª 4.7 GB è§†é¢‘æŠŠæµè§ˆå™¨æ‹–è¿› OOM"> <meta itemprop="keywords" content="å‰ç«¯,JavaScript"> <meta itemprop="datePublished" content="2025-07-26T04:03:38.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å‰ç«¯å¾®ç™½"> <meta itemprop="url" content="https://juejin.cn/user/323700845973252"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä¸€ä¸ª 4.7 GB è§†é¢‘æŠŠæµè§ˆå™¨æ‹–è¿› OOM
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/323700845973252/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å‰ç«¯å¾®ç™½
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-07-26T04:03:38.000Z" title="Sat Jul 26 2025 04:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-07-26
                  </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""></circle></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""></path></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""></div> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><p>ä½ ç»™ä¸€å®¶åœ¨çº¿æ•™è‚²å¹³å°åšã€Œè¯¾ç¨‹è§†é¢‘æ‰¹é‡ä¸Šä¼ ã€åŠŸèƒ½ã€‚<br>
éœ€æ±‚å¬èµ·æ¥å¾ˆæœ´ç´ ï¼šè®²å¸ˆåå°ä¸€æ¬¡æ€§æ‹– 20 ä¸ª 4K è§†é¢‘ï¼Œæµè§ˆå™¨è¦ç¨³ã€è¦å¿«ã€è¦èƒ½æ–­ç½‘ç»­ä¼ ã€‚<br>
ä½ ç¬¬ä¸€ç‰ˆç›´æ¥ <code>&lt;input type="file"&gt;</code> + <code>FormData</code>ï¼Œç»“æœä¸Šçº¿å½“å¤©å°±ç‚¸ï¼š</p>
<ul>
<li>è®²å¸ˆ A ä¸Šä¼  4.7 GB çš„ <code>.mov</code>ï¼ŒChrome ç›´æ¥ <strong>å†…å­˜æº¢å‡º</strong> å´©æºƒï¼›</li>
<li>è®²å¸ˆ B ç½‘æ–­äº† 3 åˆ†é’Ÿï¼Œé‡æ–°ä¸Šä¼ å‘ç°è¿›åº¦æ¡å½’é›¶ï¼Œå¿ƒæ€è·Ÿç€å½’é›¶ï¼›</li>
<li>è¿è¥åŒå­¦ç–¯ç‹‚ @ å‰ç«¯ï¼šâ€œä½ ä»¬æ˜¯ä¸æ˜¯æ²¡åšåˆ†ç‰‡ï¼Ÿâ€</li>
</ul>
<hr>
<h2 data-id="heading-0">è§£å†³æ–¹æ¡ˆï¼šä¸‰å±‚é˜²çº¿ï¼ŒæŠŠ 4 GB åˆ‡æˆ 2 MB çš„â€œè–¯ç‰‡â€</h2>
<h3 data-id="heading-1">1. è¡¨é¢ç”¨æ³•ï¼šåˆ†ç‰‡ + å¹¶å‘ï¼Œæµè§ˆå™¨å†ä¹Ÿä¸å¡</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// upload.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;    <span class="hljs-comment">// ğŸ” 2 MB ä¸€ç‰‡ï¼Œå†…å­˜å‹å¥½</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">sliceFile</span>(<span class="hljs-params">file</span>) {
  <span class="hljs-keyword">let</span> cur = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (cur &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-keyword">yield</span> file.<span class="hljs-title function_">slice</span>(cur, cur + <span class="hljs-variable constant_">CHUNK_SIZE</span>);
    cur += <span class="hljs-variable constant_">CHUNK_SIZE</span>;
  }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// uploader.js</span>
<span class="hljs-keyword">import</span> pLimit <span class="hljs-keyword">from</span> <span class="hljs-string">'p-limit'</span>;
<span class="hljs-keyword">const</span> limit = <span class="hljs-title function_">pLimit</span>(<span class="hljs-number">5</span>);               <span class="hljs-comment">// ğŸ” æœ€å¤š 5 å¹¶å‘ï¼Œé˜²æ­¢å æ»¡å¸¦å®½</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">file</span>) {
  <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> <span class="hljs-title function_">calcHash</span>(file);   <span class="hljs-comment">// ğŸ” ç§’ä¼ ã€æ–­ç‚¹ç»­ä¼ éƒ½é å®ƒ</span>
  <span class="hljs-keyword">const</span> tasks = [];
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> <span class="hljs-title function_">sliceFile</span>(file)) {
    tasks.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">limit</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">uploadChunk</span>({ hash, chunk })));
  }
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">mergeChunks</span>(hash, file.<span class="hljs-property">name</span>);  <span class="hljs-comment">// ğŸ” é€šçŸ¥åç«¯åˆå¹¶</span>
}
</code></pre>
<p>é€è¡Œæ‹†è§£ï¼š</p>
<ul>
<li><code>sliceFile</code> ç”¨ <code>file.slice</code> ç”Ÿæˆ Blob ç‰‡æ®µï¼Œ<strong>ä¸å é¢å¤–å†…å­˜</strong>ï¼›</li>
<li><code>p-limit</code> æ§åˆ¶å¹¶å‘ï¼Œé¿å… 100 ä¸ªè¯·æ±‚åŒæ—¶æ‰“çˆ†æµè§ˆå™¨ï¼›</li>
<li><code>calcHash</code> ç”¨ WebWorker ç®— MD5ï¼Œé¡µé¢ä¸å¡é¡¿ï¼ˆåé¢ç»†è®²ï¼‰ã€‚</li>
</ul>
<h3 data-id="heading-2">2. åº•å±‚æœºåˆ¶ï¼šæ–­ç‚¹ç»­ä¼ åˆ°åº•ç»­åœ¨å“ªï¼Ÿ</h3>























<table><thead><tr><th>è§’è‰²</th><th>å­˜å‚¨ä½ç½®</th><th>å†…å®¹</th><th>ç”Ÿå‘½å‘¨æœŸ</th></tr></thead><tbody><tr><td>å‰ç«¯</td><td>IndexedDB</td><td><code>hash â†’ å·²ä¸Šä¼ åˆ†ç‰‡ç´¢å¼•æ•°ç»„</code></td><td>æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…ç¼“å­˜å³å¤±æ•ˆ</td></tr><tr><td>åç«¯</td><td>Redis / MySQL</td><td><code>hash â†’ å·²æ¥æ”¶åˆ†ç‰‡ç´¢å¼•æ•°ç»„</code></td><td>å¯é…ç½® TTLï¼Œæ”¯æŒè·¨ç«¯ç»­ä¼ </td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant F as å‰ç«¯
    participant B as åç«¯

    F-&gt;&gt;B: POST /prepare {hash, totalChunks}
    B--&gt;&gt;F: 200 OK {uploaded:[0,3,7]}

    loop ä¸Šä¼ å‰©ä½™åˆ†ç‰‡
        F-&gt;&gt;B: POST /upload {hash, index, chunkData}
        B--&gt;&gt;F: 200 OK
    end

    F-&gt;&gt;B: POST /merge {hash}
    B--&gt;&gt;F: 200 OK
    Note over B: æŒ‰é¡ºåºå†™ç£ç›˜

</code></pre>
<ol>
<li>å‰ç«¯å…ˆ&nbsp;<code>POST /prepare</code>&nbsp;å¸¦ hash + æ€»åˆ†ç‰‡æ•°ï¼›</li>
<li>åç«¯è¿”å›å·²ä¸Šä¼ ç´¢å¼•&nbsp;<code>[0, 3, 7]</code>ï¼›</li>
<li>å‰ç«¯è·³è¿‡è¿™ 3 ç‰‡ï¼Œåªä¼ å‰©ä½™ï¼›</li>
<li>å…¨éƒ¨å®Œæˆå&nbsp;<code>POST /merge</code>ï¼Œåç«¯æŒ‰é¡ºåºå†™ç£ç›˜ã€‚</li>
</ol>
<h3 data-id="heading-3">3. è®¾è®¡å“²å­¦ï¼šæŠŠâ€œä¸Šä¼ â€åšæˆå¯æ’æ‹”çš„åè®®</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Uploader</span> {
  <span class="hljs-title function_">prepare</span>(<span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PrepareResp</span>&gt;;
  <span class="hljs-title function_">upload</span>(<span class="hljs-attr">chunk</span>: <span class="hljs-title class_">Blob</span>, <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  <span class="hljs-title function_">merge</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;;            <span class="hljs-comment">// ğŸ” è¿”å›æ–‡ä»¶ URL</span>
}
</code></pre>
<p>æˆ‘ä»¬å®ç°äº†ä¸‰å¥—ï¼š</p>
<ul>
<li><code>BrowserUploader</code>ï¼šçº¯å‰ç«¯åˆ†ç‰‡ï¼›</li>
<li><code>TusUploader</code>ï¼šéµå¾ª tus.io åè®®ï¼Œå¤©ç„¶æ–­ç‚¹ç»­ä¼ ï¼›</li>
<li><code>AliOssUploader</code>ï¼šç›´ä¼  OSSï¼Œç”¨ OSS çš„æ–­ç‚¹ SDKã€‚</li>
</ul>

































<table><thead><tr><th>æ–¹æ¡ˆ</th><th>å¹¶å‘æ§åˆ¶</th><th>æ–­ç‚¹ç»­ä¼ </th><th>ç§’ä¼ </th><th>ä»£ç é‡</th></tr></thead><tbody><tr><td>è‡ªç ”</td><td>æ‰‹åŠ¨</td><td>è‡ªå·±å®ç°</td><td>æ‰‹åŠ¨</td><td>300 è¡Œ</td></tr><tr><td>tus</td><td>å†…ç½®</td><td>åè®®çº§</td><td>éœ€åç«¯</td><td>100 è¡Œ</td></tr><tr><td>OSS</td><td>å†…ç½®</td><td>SDK çº§</td><td>è‡ªåŠ¨</td><td>50 è¡Œ</td></tr></tbody></table>
<hr>
<h2 data-id="heading-4">åº”ç”¨æ‰©å±•ï¼šæ‹¿æ¥å³ç”¨çš„é…ç½®ç‰‡æ®µ</h2>
<h3 data-id="heading-5">1. WebWorker ç®— Hashï¼ˆé˜²å¡é¡¿ï¼‰</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// hash.worker.js</span>
importScripts(<span class="hljs-string">'spark-md5.min.js'</span>);
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">{ data: file }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReaderSync</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; file.<span class="hljs-property">size</span>; i += <span class="hljs-variable constant_">CHUNK_SIZE</span>) {
    spark.<span class="hljs-title function_">append</span>(reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file.<span class="hljs-title function_">slice</span>(i, i + <span class="hljs-variable constant_">CHUNK_SIZE</span>)));
  }
  self.<span class="hljs-title function_">postMessage</span>(spark.<span class="hljs-title function_">end</span>());
};
</code></pre>
<h3 data-id="heading-6">2. ç¯å¢ƒé€‚é…</h3>





















<table><thead><tr><th>ç¯å¢ƒ</th><th>é€‚é…ç‚¹</th></tr></thead><tbody><tr><td>æµè§ˆå™¨</td><td>éœ€å…¼å®¹ Safari 14 ä»¥ä¸‹æ—  <code>File.prototype.slice</code>ï¼ˆç”¨ <code>webkitSlice</code> å…œåº•ï¼‰</td></tr><tr><td>Node</td><td>ç”¨ <code>fs.createReadStream</code> åˆ†ç‰‡ï¼ŒHash ç”¨ <code>crypto.createHash('md5')</code></td></tr><tr><td>Electron</td><td>æ¸²æŸ“è¿›ç¨‹ç›´æ¥èµ°æµè§ˆå™¨æ–¹æ¡ˆï¼Œä¸»è¿›ç¨‹å¯å¤ç”¨ Node é€»è¾‘</td></tr></tbody></table>
<hr>
<h2 data-id="heading-7">ä¸¾ä¸€åä¸‰ï¼š3 ä¸ªå˜ä½“åœºæ™¯</h2>
<ol>
<li><strong>ç§’ä¼ </strong><br>
ä¸Šä¼ å‰å…ˆç®— hash â†’ è°ƒåç«¯ <code>/exists?hash=xxx</code> â†’ å·²å­˜åœ¨ç›´æ¥è¿”å› URLï¼Œ0 æµé‡å®Œæˆã€‚</li>
<li><strong>åŠ å¯†ä¸Šä¼ </strong><br>
åœ¨ <code>uploadChunk</code> é‡ŒåŠ ä¸€å±‚ <code>AES-GCM</code> åŠ å¯†ï¼Œåç«¯å­˜åŠ å¯†å—ï¼Œä¸‹è½½æ—¶ç”±å‰ç«¯è§£å¯†ã€‚</li>
<li><strong>P2P ååŒä¸Šä¼ </strong><br>
ç”¨ WebRTC æŠŠåŒå±€åŸŸç½‘å­¦å‘˜çš„æµè§ˆå™¨å˜æˆ CDNï¼Œåˆ†ç‰‡äº’ä¼ åå†ç»Ÿä¸€ä¸ŠæŠ¥ï¼ŒèŠ‚çœ 70% å‡ºå£å¸¦å®½ã€‚</li>
</ol>
<h2 data-id="heading-8">å°ç»“</h2>
<p>å¤§æ–‡ä»¶ä¸Šä¼ çš„æ ¸å¿ƒä¸æ˜¯â€œä¼ â€ï¼Œè€Œæ˜¯â€œæ–­â€ã€‚<br>
æŠŠ 4 GB åˆ‡æˆ 2 MB çš„è–¯ç‰‡ï¼Œå†é…ä¸Šä¸€å¼ èƒ½ç»­å‘½çš„â€œè¿›åº¦è¡¨â€ï¼Œæµè§ˆå™¨å°±èƒ½ç¨³ç¨³åœ°åƒä¸‹ä»»ä½•ä½“ç§¯çš„è§†é¢‘ã€‚</p></div></div>