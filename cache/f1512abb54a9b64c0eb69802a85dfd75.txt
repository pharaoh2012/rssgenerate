
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/fanliang11/p/18907898" title="发布于 2025-06-03 07:32">
    <span role="heading" aria-level="2">凯亚物联网如何搭建信令服务</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h2>一、前言</h2>
<p>凯亚会基于dotnetty 开发gb28181,rtsp,rtmp,httflv，webrtc等流媒体协议，谈到流媒体少不了sip 服务， 那么什么是sip ,如何搭建开发呢？在此篇文章就会进行介绍。</p>
<p>HttpFlv:<a href="http://demo.kayakiot.cn:281/httpflv.html" target="_blank" rel="noopener nofollow">http://demo.kayakiot.cn:281/httpflv.html</a>&nbsp; <a target="_blank">（黑衣人）</a></p>
<p>&nbsp;HttpFlv:<a href="http://demo.kayakiot.cn:281/httpflv1.html" target="_blank" rel="noopener nofollow">http://demo.kayakiot.cn:281/httpflv1.html&nbsp;</a> <a target="_blank">（大红包）</a></p>
<p>HttpFlv:<a href="http://demo.kayakiot.cn:281/httpflv2.html" target="_blank" rel="noopener nofollow">http://demo.kayakiot.cn:281/httpflv2.html&nbsp;</a> <a target="_blank">（鹿鼎记）</a></p>
<p>rtmp:<a target="_blank">rtmp://demo.kayakiot.cn:76/live1/livestream2&nbsp;&nbsp; （黑衣人）</a></p>
<p>rtmp:<a target="_blank">rtmp://demo.kayakiot.cn:76/live1/livestream3&nbsp;&nbsp; （大红包）</a></p>
<p>rtmp:<a target="_blank">rtmp://demo.kayakiot.cn:76/live1/livestream4</a><a target="_blank">（鹿鼎记）</a></p>
<p>注：测试服务器带宽只有8MB,&nbsp;httpflv&nbsp; 缓冲做的没有rtmp好，然后httpflv卡就多刷新几次</p>
<p>&nbsp; 凯亚 (Kayak) 是什么?</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 凯亚(Kayak)是基于.NET8.0软件环境下的surging微服务引擎进行开发的, 平台包含了微服务和物联网平台。支持异步和响应式编程开发，功能包含了物模型,设备,产品,网络组件的统一管理和微服务平台下的注册中心，服务路由，模块，中间服务等管理。还有多协议适配(TCP,MQTT,UDP,CoAP,HTTP,Grpc,websocket,rtmp,httpflv,webservice,等),通过灵活多样的配置适配能够接入不同厂家不同协议等设备。并且通过设备告警,消息通知,数据可视化等功能。能够让你能快速建立起微服务物联网平台系统。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 凯亚物联网平台：<a href="http://demo.kayakiot.cn:3100" target="_blank" rel="noopener nofollow">http://demo.kayakiot.cn:3100</a>（用户名：fanly&nbsp; 密码：123456）</p>
<p>&nbsp; &nbsp; 链路跟踪Skywalking V8:<a href="http://117.72.121.2:8080/" target="_blank" rel="noopener nofollow">http://117.72.121.2:8080/</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; surging 微服务引擎开源地址：<a href="https://github.com/fanliang11/surging" rel="noopener nofollow" target="_blank">https://github.com/fanliang11/surging</a>（后面surging 会移动到<a href="https://github.com/microsurging/" rel="noopener nofollow" target="_blank">microsurging</a>进行维护）</p>
<h2>二、什么是sip 服务</h2>
<div>
<div data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph"><strong>SIP（Session Initiation Protocol）服务是一种用于建立、管理和终止多媒体通信会话的应用层协议，广泛应用于VoIP（Voice over IP）电话、视频会议等场景</strong>‌。其核心功能包括会话控制、用户定位、协议兼容性支持及负载均衡等。‌‌</p>
</div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">‌<strong>SIP服务的基本概念与功能</strong>‌</p>
</div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">SIP协议由IETF制定，基于类似HTTP的文本格式设计，旨在通过IP网络实现多媒体会话管理。其核心功能可归纳为以下三点：</p>
<ol>
<li>
<p class="marklang-paragraph">‌<strong>会话控制</strong>‌: 支持呼叫建立（INVITE）、修改（RE-INVITE）和终止（BYE），确保会话完整性需遵循事务粘性规则（同一会话请求必须由同一服务器处理）。‌‌</p>
</li>
<li>
<p class="marklang-paragraph">‌<strong>用户定位与移动性</strong>‌: 通过代理或重定向机制实现用户当前位置寻址，例如注册服务器记录终端设备IP地址以便路由呼叫。‌‌</p>
</li>
<li>
<p class="marklang-paragraph">‌<strong>协议兼容性</strong>‌: 需与其他协议协同工作，如RTP（实时传输）、LDAP（目录服务）、RADIUS（鉴权）等。‌‌</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">‌<strong>SIP服务器的架构与实现</strong>‌</p>
</div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">SIP服务通常通过服务器系统实现，主流架构分为两类：</p>
<ol>
<li>
<p class="marklang-paragraph">‌<strong>单一服务器集成模式</strong>‌: 所有逻辑功能（如代理、注册、媒体处理）集中于同一物理设备，优势是通信效率高，但扩展性较差。‌‌</p>
</li>
<li>
<p class="marklang-paragraph">‌<strong>分布式功能分离模式</strong>‌: 将不同逻辑功能拆分至独立实例（如负载均衡器、代理服务器、媒体服务器），通过松散耦合提升资源利用率和扩展性，但需额外处理事务粘性。‌‌</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">‌<strong>SIP服务的应用场景</strong>‌</p>
</div>
</div>
</div>
</div>
</div>
<div>
<div class="cos-space-mt-xxl" data-nolog="true" data-show="summary" data-show-ext="{&quot;component_content&quot;:{&quot;component_name&quot;:&quot;markdown&quot;,&quot;component_type&quot;:&quot;abstract&quot;}}">
<div class="cosd-markdown">
<div class="cosd-markdown-content ">
<div class="marklang">
<p class="marklang-paragraph">SIP协议主要应用于以下领域：</p>
<ul>
<li>
<p class="marklang-paragraph">‌<strong>VoIP电话</strong>‌: 替代传统PSTN网络，显著降低通话成本并支持视频等多媒体功能。‌‌</p>
</li>
<li>
<p class="marklang-paragraph">‌<strong>统一通信（UC）</strong>‌: 集成语音、视频、即时消息等业务，例如企业IP PBX系统。‌‌</p>
</li>
<li>
<p class="marklang-paragraph">‌<strong>物联网（IoT）</strong>‌: 为智能设备提供会话管理能力，如远程监控或交互控制</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<h2>三、信令服务注册流程</h2>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603065219505-1405245068.webp" alt="" loading="lazy"></p>
<ol>
<li>客户端发起注册</li>
<li>sip服务器返回401 ,并携带WWW-Authenticate</li>
<li>客户端第二次发起注册,增加Authorization</li>
<li>服务端返回授权成功, 或者失败.</li>
</ol>
<p>&nbsp;</p>
<p>1.客户端发起注册REGISTER</p>
<p>首先客户端发起注册请求,此时没有携带鉴权信息.</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603070659815-637523147.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>2.收到返回401</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603071105649-1986967540.png" alt="" loading="lazy"></p>
<p>&nbsp;3.重新REGISTER</p>
<p>重新注册后，header 就会带Authorization</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603071557100-1897434928.png" alt="" loading="lazy"></p>
<p>返回成功</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603071906265-1406775802.png" alt="" loading="lazy"></p>
<p>&nbsp;然后注册成功可以发送消息到客户端</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603072334819-1854181955.png" alt="" loading="lazy"></p>
<p>以下是用测试工具测试sip 服务</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603072955557-667180383.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>这么多协议性能会有影响吗？这里是启动一天凯亚物联网线上测试，运行一天的视频推流，内存和cpu 占用情况</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202506/192878-20250603072754390-554347699.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03292255631481481" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-06-03 08:25">2025-06-03 07:32</span>&nbsp;
<a href="https://www.cnblogs.com/fanliang11">fanly11</a>&nbsp;
阅读(<span id="post_view_count">27</span>)&nbsp;
评论(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18907898);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18907898', targetLink: 'https://www.cnblogs.com/fanliang11/p/18907898', title: '凯亚物联网如何搭建信令服务' })">举报</a>
</div>
        