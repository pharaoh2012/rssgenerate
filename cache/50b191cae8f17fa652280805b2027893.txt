
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Fzeng/p/18735256" title="å‘å¸ƒäº 2025-02-25 00:44">
    <span role="heading" aria-level="2">SpringBoot 2.x æ¥å…¥éæ ‡å‡†SSEæ ¼å¼å¤§æ¨¡å‹æµå¼å“åº”å®è·µ ğŸš€</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>è¿‘æœŸDeepSeekç­‰å›½äº§å¤§æ¨¡å‹çƒ­åº¦æŒç»­æ”€å‡ï¼Œå…¶å…³æ³¨åº¦ç”šè‡³è¶…è¿‡äº†OpenAIï¼ˆè¢«æˆç§°ä¸ºCloseAIï¼‰ã€‚åœ¨<code>SpringBoot3.x</code>ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹çš„Spring AIè½»æ¾æ¥å…¥ï¼Œä½†å¯¹äºä»åœ¨ä½¿ç”¨<strong>JDK8</strong>å’Œ<strong>SpringBoot2.7.3</strong>çš„ä¼ä¸šçº§åº”ç”¨æ¥è¯´ï¼Œå¾€å¾€éœ€è¦è‡ªå®šä¹‰å®ç°ã€‚ç‰¹åˆ«æ˜¯å½“å¤§æ¨¡å‹å›¢é˜Ÿè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†SSEè§„èŒƒæ—¶ï¼Œæ›´éœ€è¦çµæ´»å¤„ç†ã€‚æœ¬æ–‡å°†åˆ†äº«æˆ‘ä»¬çš„å®æˆ˜è§£å†³æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="-å¼•å…¥gradleä¾èµ–">ğŸ“¦ å¼•å…¥Gradleä¾èµ–</h2>
<p>æ ¸å¿ƒä¾èµ–è¯´æ˜ï¼š</p>
<ul>
<li><code>spring-boot-starter-web</code>ï¼šåŸºç¡€Webæ”¯æŒ</li>
<li><code>spring-boot-starter-webflux</code>ï¼šå“åº”å¼ç¼–ç¨‹æ”¯æŒï¼ˆWebClientæ‰€åœ¨æ¨¡å—ï¼‰</li>
</ul>
<pre><code class="language-groovy">implementation 'org.springframework.boot:spring-boot-starter-web'
implementation 'org.springframework.boot:spring-boot-starter-webflux'
</code></pre>
<hr>
<h2 id="-webclienté…ç½®è¦ç‚¹">ğŸŒ WebClienté…ç½®è¦ç‚¹</h2>
<p>åˆå§‹åŒ–æ—¶ç‰¹åˆ«æ³¨æ„Headeré…ç½®ï¼š</p>
<pre><code class="language-java">@Bean
public WebClient init() {
    return WebClient.builder()
            .baseUrl(baseUrl)
            .defaultHeader(HttpHeaders.AUTHORIZATION, "Bearer " + openAi)
            // âš ï¸ å¿…é¡»è®¾ç½®ä¸ºJSONæ ¼å¼
            .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
            .build();
}
</code></pre>
<blockquote>
<p>ğŸš¨ å…³é”®è¸©å‘ç‚¹ï¼šåˆå§‹è®¾ç½®<code>MediaType.TEXT_EVENT_STREAM_VALUE</code>ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œå¿…é¡»ä½¿ç”¨<code>APPLICATION_JSON_VALUE</code></p>
</blockquote>
<hr>
<h2 id="-æ ¸å¿ƒå¤„ç†é€»è¾‘">ğŸ§  æ ¸å¿ƒå¤„ç†é€»è¾‘</h2>
<h3 id="æµå¼è¯·æ±‚å…¥å£">æµå¼è¯·æ±‚å…¥å£</h3>
<pre><code class="language-java">@GetMapping(value = "/stream/chat", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux&lt;String&gt; streamChatEnhanced(@RequestParam("prompt") String prompt) {
    // è¯·æ±‚ä½“æ„å»º
    String requestBody = String.format("""
        {
            "model": "%s",
            "messages": [{"role": "user", "content": "%s"}],
            "stream": true
        }
        """, model, prompt);
                                       
    return webClient.post()
            // è¯·æ±‚é…ç½®
            .uri("/v1/chat/completions")
            .bodyValue(requestBody)
            .accept(MediaType.TEXT_EVENT_STREAM)
            .retrieve()
            .bodyToFlux(DataBuffer.class)  // ğŸ”‘ å…³é”®é…ç½®ç‚¹
            .transform(this::processStream)
            // é‡è¯•å’Œè¶…æ—¶é…ç½®
            .retryWhen(Retry.backoff(3, Duration.ofSeconds(1)))
            .timeout(Duration.ofSeconds(180));
            // é”™è¯¯å¤„ç†
            .doOnError(e -&gt; log.error("Stream error", e))
            .doFinally(signal -&gt; log.info("Stream completed: {}", signal));
}
</code></pre>
<h3 id="æŠ€æœ¯åŸç†è¯´æ˜">æŠ€æœ¯åŸç†è¯´æ˜</h3>
<p>å½“ä½¿ç”¨<code>bodyToFlux(DataBuffer.class)</code>æ—¶ï¼š</p>
<ul>
<li>âœ… è·å¾—åŸå§‹å­—èŠ‚æµæ§åˆ¶æƒ</li>
<li>âŒ é¿å…è‡ªåŠ¨SSEæ ¼å¼è§£æï¼ˆé€‚ç”¨äºéæ ‡å‡†å“åº”ï¼‰</li>
<li>ğŸ“¡ åŠ¨æ€æ•°æ®æµå¤„ç†ï¼šç±»ä¼¼Java Streamï¼Œä½†æ•°æ®æŒç»­è¿½åŠ </li>
</ul>
<hr>
<h2 id="-éæ ‡å‡†sseæ•°æ®å¤„ç†">ğŸ”§ éæ ‡å‡†SSEæ•°æ®å¤„ç†</h2>
<h3 id="æ ¸å¿ƒå¤„ç†æµç¨‹">æ ¸å¿ƒå¤„ç†æµç¨‹</h3>
<pre><code class="language-java">private Flux&lt;String&gt; processStream(Flux&lt;DataBuffer&gt; dataBufferFlux) {
    return dataBufferFlux
            .transform(DataBufferUtils::join)          // å­—èŠ‚æµåˆå¹¶
            .map(buffer -&gt; {                          // å­—èŠ‚è½¬å­—ç¬¦ä¸²
                String content = buffer.toString(StandardCharsets.UTF_8);
                DataBufferUtils.release(buffer);
                return content;
            })
            .flatMap(content -&gt;                       // å¤„ç†ç²˜åŒ…é—®é¢˜
                Flux.fromArray(content.split("\\r?\\n\\r?\\n")))
            .filter(event -&gt; !event.trim().isEmpty()) // è¿‡æ»¤ç©ºäº‹ä»¶
            .map(event -&gt; {                           // æ ¼å¼æ ‡å‡†åŒ–å¤„ç†
                String trimmed = event.trim();
                if (trimmed.startsWith("data:")) {
                    String substring = trimmed.substring(5);
                    return substring.startsWith(" ") ? substring.substring(1) : substring;
                }
                return trimmed;
            })
            .filter(event -&gt; !event.startsWith("data:")); // äºŒæ¬¡è¿‡æ»¤
}
</code></pre>
<h3 id="ä¸‰å¤§å…³é”®æŠ€æœ¯ç‚¹">ä¸‰å¤§å…³é”®æŠ€æœ¯ç‚¹</h3>
<ol>
<li>
<p><strong>ç²˜åŒ…å¤„ç†</strong><br>
é€šè¿‡<code>split("\\r?\\n\\r?\\n")</code>è§£å†³ç½‘ç»œä¼ è¾“ä¸­çš„æ¶ˆæ¯è¾¹ç•Œé—®é¢˜ï¼Œç¤ºä¾‹åŸå§‹æ•°æ®ï¼š</p>
<pre><code class="language-markdown">data:{response1}\n\ndata:{response2}\n\n
</code></pre>
</li>
<li>
<p><strong>æ ¼å¼å…¼å®¹å¤„ç†</strong><br>
è‡ªåŠ¨å»é™¤æœåŠ¡ç«¯å¯èƒ½è¿”å›çš„<code>data:</code>å‰ç¼€ï¼ŒåŒæ—¶ä¿ç•™Springè‡ªåŠ¨æ·»åŠ SSEå‰ç¼€çš„èƒ½åŠ›</p>
</li>
<li>
<p><strong>åŒé‡è¿‡æ»¤æœºåˆ¶</strong><br>
ç¡®ä¿æœ€ç»ˆè¾“å‡ºä¸åŒ…å«ä»»ä½•æ®‹ç•™çš„SSEæ ¼å¼æ ‡è¯†</p>
</li>
</ol>
<hr>
<h2 id="ï¸-ç‰¹åˆ«æ³¨æ„">âš ï¸ ç‰¹åˆ«æ³¨æ„</h2>
<p>å½“æ¥å£è®¾ç½®<code>produces = MediaType.TEXT_EVENT_STREAM_VALUE</code>æ—¶ï¼š</p>
<ul>
<li>
<p>Spring WebFluxä¼šè‡ªåŠ¨æ·»åŠ <code>data: </code>å‰ç¼€</p>
</li>
<li>
<p>å‰ç«¯æ”¶åˆ°çš„æ ¼å¼ç¤ºä¾‹ï¼š</p>
<pre><code class="language-markdown">data: {å®é™…å†…å®¹}
</code></pre>
</li>
<li>
<p>è‹¥æ‰‹åŠ¨æ·»åŠ </p>
<pre><code>data: 
</code></pre>
<p>å‰ç¼€ä¼šå¯¼è‡´é‡å¤ï¼š</p>
<pre><code class="language-markdown">data: data: {é”™è¯¯å†…å®¹}  // âŒ é”™è¯¯æ ¼å¼
</code></pre>
</li>
</ul>
<hr>
<h2 id="ï¸-å®Œæ•´å®ç°ä»£ç ">ğŸ› ï¸ å®Œæ•´å®ç°ä»£ç </h2>
<pre><code class="language-java">// åŒ…å£°æ˜å’Œå¯¼å…¥...

@Service
@Slf4j
public class OpenAiService {
    // é…ç½®é¡¹å’Œåˆå§‹åŒ–
    private String openAiApiKey = "sk-xxxxxx";
    
    private String baseUrl = "https://openai.com/xxxx";

    private String model = "gpt-4o";

    private WebClient webClient;

    @PostConstruct
    public void init() {
        webClient = WebClient.builder()
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.AUTHORIZATION, "Bearer " + openAiApiKey)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
    }

    @GetMapping(value = "/stream/chat", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux&lt;String&gt; streamChatEnhanced(@RequestParam("prompt") String prompt) {
        // æ„å»ºè¯·æ±‚ä½“
        String requestBody = String.format("""
                {
                    "model": "gpt-4o-mini",
                    "messages": [{"role": "user", "content": "%s"}],
                    "stream": true
                }
                """, prompt);
                                           
        // å‘é€æµå¼è¯·æ±‚
        return webClient.post()
            .uri("/v1/chat/completions")
            .bodyValue(requestBody)
            .retrieve()
            .onStatus(HttpStatusCode::isError, response -&gt;
                    response.bodyToMono(String.class)
                            .flatMap(error -&gt; Mono.error(new RuntimeException("API Error: " + error)))
            )
            .bodyToFlux(DataBuffer.class)
            .transform(this::processStream)
            .retryWhen(Retry.backoff(3, Duration.ofSeconds(1)))
            .timeout(Duration.ofSeconds(180))
            .doOnError(e -&gt; log.error("Stream error", e))
            .doFinally(signal -&gt; log.info("Stream completed: {}", signal));
    }

    private Flux&lt;String&gt; processStream(Flux&lt;DataBuffer&gt; dataBufferFlux) {
        return dataBufferFlux
                // ä½¿ç”¨å­—èŠ‚æµå¤„ç†
                .transform(DataBufferUtils::join)
                .map(buffer -&gt; {
                    String content = buffer.toString(StandardCharsets.UTF_8);
                    DataBufferUtils.release(buffer);
                    return content;
                })
                // æŒ‰ SSE äº‹ä»¶è¾¹ç•Œï¼Œé˜²æ­¢ç²˜åŒ…çš„é—®é¢˜
                .flatMap(content -&gt; Flux.fromArray(content.split("\\r?\\n\\r?\\n")))
                // è¿‡æ»¤ç©ºäº‹ä»¶
                .filter(event -&gt; !event.trim().isEmpty())
                // è§„èŒƒ SSE äº‹ä»¶æ ¼å¼
                .map(event -&gt; {
                    String trimmed = event.trim();

                    // ç”±äºwebfluxè®¾ç½®äº†"produces = MediaType.TEXT_EVENT_STREAM_VALUE",
                    // æ‰€ä»¥åœ¨è¿”å›æ•°æ®æ—¶ä¼šè‡ªåŠ¨æ·»åŠ â€œdata:â€ï¼Œå› æ­¤å¦‚æœè¿”å›çš„æ ¼å¼å¸¦äº†â€œdata:â€éœ€è¦æ‰‹åŠ¨å»é™¤
                    if (trimmed.startsWith("data:")) {
                        trimmed = trimmed.replaceFirst("data:","").trim();
                    }
                    return trimmed;
                })
                .filter(event -&gt; !event.startsWith("data:"));
    }
}
</code></pre>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.5677859528032407" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-25 00:44">2025-02-25 00:44</span>&nbsp;
<a href="https://www.cnblogs.com/Fzeng">fengzeng</a>&nbsp;
é˜…è¯»(<span id="post_view_count">84</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18735256" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18735256);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18735256', targetLink: 'https://www.cnblogs.com/Fzeng/p/18735256', title: 'SpringBoot 2.x æ¥å…¥éæ ‡å‡†SSEæ ¼å¼å¤§æ¨¡å‹æµå¼å“åº”å®è·µ &amp;#128640;' })">ä¸¾æŠ¥</a>
</div>
        