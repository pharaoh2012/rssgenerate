
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zjdxr-up/p/18638008" title="发布于 2024-12-28 21:35">
    <span role="heading" aria-level="2">已有docker镜像构建过程分析</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>转载请注明出处：</p>
<h2>1.使用docker history进行分析　　</h2>
<p>　　<span style="font-size: 16px"><code>docker history</code>&nbsp;命令用于查看指定镜像的历史层信息，它显示了镜像创建过程中的每一层，包括创建时间、创建者、大小和注释等信息。</span></p>
<h3><strong>查看镜像历史</strong></h3>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">docker history myimage:latest</span></pre>
</div>
<p><span style="font-size: 16px">　　使用示例：</span></p>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">root<span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span># docker images <span style="color: rgba(128, 128, 128, 1)">|</span><span style="color: rgba(0, 0, 0, 1)"> grep zj_jdk_test_3
zj_jdk_test_3                                                     latest                                        623478971aeb        </span><span style="color: rgba(128, 0, 0, 1); font-weight: bold">8</span><span style="color: rgba(0, 0, 0, 1)"> weeks ago         280MB
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span><span style="color: rgba(0, 0, 0, 1)">#
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span><span style="color: rgba(0, 0, 0, 1)">#
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span><span style="color: rgba(0, 0, 0, 1)">#
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span><span style="color: rgba(0, 0, 0, 1)">#
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span><span style="color: rgba(0, 0, 0, 1)"># docker history 623478971aeb
</span><span style="color: rgba(0, 0, 255, 1)">IMAGE</span>               CREATED             CREATED <span style="color: rgba(0, 0, 255, 1)">BY</span><span style="color: rgba(0, 0, 0, 1)">                                      SIZE                COMMENT
623478971aeb        </span><span style="color: rgba(128, 0, 0, 1); font-weight: bold">8</span> weeks ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c <span style="color: rgba(0, 0, 255, 1)">set</span> <span style="color: rgba(128, 128, 128, 1)">-</span>x <span style="color: rgba(128, 128, 128, 1)">&amp;&amp;</span>     sed <span style="color: rgba(128, 128, 128, 1)">-</span>i <span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(255, 0, 0, 1)">s#deb.debia…   20.2MB
b427061b275f        2 years ago         /bin/sh -c set -eux;   arch="$(dpkg --print-…   108MB
&lt;missing&gt;           2 years ago         /bin/sh -c #(nop)  ENV JAVA_VERSION=8u342       0B
&lt;missing&gt;           2 years ago         /bin/sh -c #(nop)  ENV LANG=C.UTF-8             0B
&lt;missing&gt;           2 years ago         /bin/sh -c #(nop)  ENV PATH=/usr/local/openj…   0B
&lt;missing&gt;           2 years ago         /bin/sh -c { echo </span><span style="color: rgba(255, 0, 0, 1)">'</span>#<span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh<span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(255, 0, 0, 1)">; echo </span><span style="color: rgba(255, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">echo "$J…   27B
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c #(nop)  ENV JAVA_HOME<span style="color: rgba(128, 128, 128, 1)">=/</span>usr<span style="color: rgba(128, 128, 128, 1)">/</span>local<span style="color: rgba(128, 128, 128, 1)">/</span><span style="color: rgba(0, 0, 0, 1)">…   0B
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c <span style="color: rgba(0, 0, 255, 1)">set</span> <span style="color: rgba(128, 128, 128, 1)">-</span>eux;  apt<span style="color: rgba(128, 128, 128, 1)">-</span>get <span style="color: rgba(0, 0, 255, 1)">update</span>;  apt<span style="color: rgba(128, 128, 128, 1)">-</span>g…   <span style="color: rgba(128, 0, 0, 1); font-weight: bold">11</span><span style="color: rgba(0, 0, 0, 1)">.5MB
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c <span style="color: rgba(0, 0, 255, 1)">set</span> <span style="color: rgba(128, 128, 128, 1)">-</span>ex;  <span style="color: rgba(0, 0, 255, 1)">if</span> ! command <span style="color: rgba(128, 128, 128, 1)">-</span>v gpg <span style="color: rgba(128, 128, 128, 1)">&gt;</span> <span style="color: rgba(128, 128, 128, 1)">/</span>…   <span style="color: rgba(128, 0, 0, 1); font-weight: bold">16</span><span style="color: rgba(0, 0, 0, 1)">.5MB
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c <span style="color: rgba(0, 0, 255, 1)">set</span> <span style="color: rgba(128, 128, 128, 1)">-</span>eux;  apt<span style="color: rgba(128, 128, 128, 1)">-</span>get <span style="color: rgba(0, 0, 255, 1)">update</span>;  apt<span style="color: rgba(128, 128, 128, 1)">-</span>g…   <span style="color: rgba(128, 0, 0, 1); font-weight: bold">15</span><span style="color: rgba(0, 0, 0, 1)">.9MB
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c #(nop)  CMD <span style="color: rgba(255, 0, 0, 1)">[</span><span style="color: rgba(255, 0, 0, 1)">"bash"</span><span style="color: rgba(255, 0, 0, 1)">]</span><span style="color: rgba(0, 0, 0, 1)">                 0B
</span><span style="color: rgba(128, 128, 128, 1)">&lt;</span>missing<span style="color: rgba(128, 128, 128, 1)">&gt;</span>           <span style="color: rgba(128, 0, 0, 1); font-weight: bold">2</span> years ago         <span style="color: rgba(128, 128, 128, 1)">/</span>bin<span style="color: rgba(128, 128, 128, 1)">/</span>sh <span style="color: rgba(128, 128, 128, 1)">-</span>c #(nop) <span style="color: rgba(0, 0, 255, 1)">ADD</span> <span style="color: rgba(0, 0, 255, 1)">file</span><span style="color: rgba(0, 0, 0, 1)">:dfd7e3791fa0512f0…   108MB
root</span><span style="color: rgba(0, 128, 0, 1)">@controller1</span>:<span style="color: rgba(128, 128, 128, 1)">~</span>#</span></pre>
</div>
<h3><strong>显示完整输出</strong></h3>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">docker history <span style="color: rgba(0, 128, 128, 1)">--</span><span style="color: rgba(0, 128, 128, 1)">no-trunc myimage:latest</span></span></pre>
</div>
<ul>
<li><span style="font-size: 16px">镜像历史信息包括每一层的创建指令和大小，有助于了解镜像的构建过程和内容。</span></li>
</ul>
<h2>2.使用dive进行分析</h2>
<h3>Dive 的主要功能：</h3>
<ul>
<li><span style="font-size: 16px">分层分析：查看 Docker 镜像的每一层，了解每层的文件及其占用的空间。</span></li>
<li><span style="font-size: 16px">空间利用率：计算镜像中有效空间的占比，给出效率评分。</span></li>
<li><span style="font-size: 16px">浪费空间检测：识别重复文件、未使用的依赖或冗余数据。</span></li>
<li><span style="font-size: 16px">手动优化建议：根据分析结果手动调整&nbsp;<code>Dockerfile</code>&nbsp;以优化镜像大小。</span></li>
</ul>
<h3>安装 dive</h3>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">docker pull wagoodman/<span style="color: rgba(0, 0, 0, 1)">dive:latest
docker run </span>--rm -it -v /<span style="color: rgba(0, 0, 255, 1)">var</span>/run/docker.sock:/<span style="color: rgba(0, 0, 255, 1)">var</span>/run/docker.sock wagoodman/dive:latest &lt;your_image&gt;</span></pre>
</div>
<p><span style="font-size: 16px">　　启动之后：</span></p>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">root@controller1:~# docker images |<span style="color: rgba(0, 0, 0, 1)"> grep dive
wagoodman</span>/dive                                                    latest                                        cf2f0c72f085        <span style="color: rgba(128, 0, 128, 1)">10</span> months ago       <span style="color: rgba(128, 0, 128, 1)">51</span><span style="color: rgba(0, 0, 0, 1)">.7MB
root@controller1:</span>~#</span></pre>
</div>
<p><span style="font-size: 16px">　　或者通过以下命令安装：</span></p>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">snap install dive</span></pre>
</div>
<p><span style="font-size: 16px">　　通过以下命令来分析&nbsp;<span class="words-blog hl-git-1" data-tit="Docker" data-pretit="docker">Docker&nbsp;镜像：</span></span></p>
<div class="cnblogs_code">
<pre><span style="font-size: 16px">dive nginx:latest</span></pre>
</div>
<p><span style="font-size: 16px">　　运行后效果如图：</span></p>
<p><img src="https://img2024.cnblogs.com/blog/1110857/202412/1110857-20241228211827384-1424485050.png" alt="" loading="lazy"></p>
<p>&nbsp;　　<span style="font-size: 16px">启动 dive 后，分为两部分：</span></p>
<p><span style="font-size: 16px">　　　　左侧（层结构）：展示 Docker 镜像的每一层，显示每一层的命令（如 COPY、RUN）和镜像层的大小。<span style="color: rgba(255, 0, 0, 1)"><strong>可以通过上下箭头在不同层之间切换。</strong></span></span></p>
<p><span style="font-size: 16px">　　　　右侧（文件系统内容）：展示每一层中具体添加、修改或删除的文件和目录。你可以看到镜像每一层对文件系统的影响，以及文件变化和大小。</span></p>
<p><span style="font-size: 16px">　　　　Layer Details：介绍了这一层的命令</span></p>
<p><span style="font-size: 16px">　　　　Images Details：介绍镜像的名字、占用空间、镜像中未使用的文件和重复使用文件的大小、镜像使用效率（未使用的文件和重复使用文件的大小/镜像占用总空间）</span></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="1.5519971412314815" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2024-12-28 21:35">2024-12-28 21:35</span>&nbsp;
<a href="https://www.cnblogs.com/zjdxr-up">香吧香</a>&nbsp;
阅读(<span id="post_view_count">103</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18638008" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18638008);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18638008', targetLink: 'https://www.cnblogs.com/zjdxr-up/p/18638008', title: '已有docker镜像构建过程分析' })">举报</a>
</div>
        