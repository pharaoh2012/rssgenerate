
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/dechinphy/p/18764562/kt158" title="å‘å¸ƒäº 2025-03-12 15:34">
    <span role="heading" aria-level="2">KTransformerså®æˆ˜DeepSeek-R1-1.58bité‡åŒ–æ¨¡å‹</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312153237084-1607921954.png" alt="KTransformerså®æˆ˜DeepSeek-R1-1.58bité‡åŒ–æ¨¡å‹" class="desc_img">
        æœ¬æ–‡ä»‹ç»äº†å›½äº§çš„å¤§æ¨¡å‹æ¨ç†å·¥å…·KTransformersåœ¨æœ¬åœ°æˆåŠŸè¿è¡Œçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œåœ¨å®¹å™¨åŒ–éƒ¨ç½²çš„åŸºç¡€ä¸Šï¼Œç»“åˆOpen WebUIåšäº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„å¤§æ¨¡å‹æœåŠ¡ã€‚
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="æŠ€æœ¯èƒŒæ™¯">æŠ€æœ¯èƒŒæ™¯</h1>
<p>åœ¨<a href="https://www.cnblogs.com/dechinphy/p/18719866/ktransformer#docker%E5%AE%89%E8%A3%85" target="_blank">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡KTransformerså¤§æ¨¡å‹é«˜æ€§èƒ½åŠ è½½å·¥å…·çš„å®‰è£…å’Œä½¿ç”¨æ–¹æ³•ã€‚ä½†æ˜¯å½“æ—¶å› ä¸ºæ˜¯åœ¨ä¸€ä¸ªæ¯”è¾ƒè€æ—§çš„ç¡¬ä»¶ä¸Šé¢è¿›è¡Œæµ‹è¯•ï¼Œå…¶å®å¹¶æ²¡æœ‰çœŸæ­£çš„è¿è¡Œèµ·æ¥ã€‚ç°åœ¨è¡¥ä¸€ä¸ªåœ¨KTransformersä¸‹è¿è¡ŒDeepSeek-R1çš„1.58bité‡åŒ–æ¨¡å‹çš„å®æˆ˜æµ‹è¯•ã€‚</p>
<h1 id="è½¯ç¡¬ä»¶è®¾æ–½">è½¯ç¡¬ä»¶è®¾æ–½</h1>
<ol>
<li>æ˜¾å¡ï¼šNVIDIA GeForce RTX 4080ï¼ˆåªéœ€1å¼ ï¼‰</li>
<li>CPUï¼šIntel(R) Xeon(R) Silver 4310 CPU @ 2.10GHzï¼ˆä¸æ”¯æŒAVX512ï¼‰</li>
<li>å†…å­˜ï¼š640GBï¼ˆæœªå®Œå…¨å æ»¡ï¼‰</li>
<li>è¿è¡Œç¯å¢ƒï¼šUbuntu + Docker</li>
</ol>
<h1 id="å¯åŠ¨æŒ‡ä»¤">å¯åŠ¨æŒ‡ä»¤</h1>
<p>å…·ä½“çš„éƒ¨ç½²æ–¹æ³•ï¼Œä¸»è¦è¿˜æ˜¯å‚è€ƒ<a href="https://www.cnblogs.com/dechinphy/p/18719866/ktransformer" target="_blank">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè®²è§£ã€‚ä»¥Dockerå®‰è£…çš„æ–¹å¼ç›´æ¥è¿›å…¥å®æˆ˜ã€‚</p>
<h2 id="dockerå®¹å™¨åˆ›å»ºæŒ‡ä»¤">Dockerå®¹å™¨åˆ›å»ºæŒ‡ä»¤</h2>
<p>åœ¨è¿˜æ²¡æœ‰é…ç½®å¥½çš„æƒ…å†µä¸‹ï¼Œå…ˆå¯åŠ¨è¿™ä¸ªæ—§ç‰ˆæœ¬çš„é•œåƒï¼š</p>
<pre><code class="language-bash">$ docker run -it --gpus '"device=2,3"' -v /home/dechin/:/models --name ktransformers -itd docker.1ms.run/approachingai/ktransformers:0.2.1 nvidia-smi
</code></pre>
<p>è¿™é‡ŒåŠ è½½äº†2å¼ æ˜¾å¡åˆ°å®¹å™¨ç¯å¢ƒä¸­ï¼Œæ³¨æ„ä¸€å®šè¦æŠŠæ¨¡å‹è·¯å¾„æ˜ å°„åˆ°å®¹å™¨çš„ç›¸åº”ç›®å½•ä¸‹ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¸‹è½½ä¸‹æ¥çš„å®¹å™¨é•œåƒæ˜¯0.2.1çš„ç‰ˆæœ¬ï¼Œå¦‚æœç›´æ¥è¿è¡Œï¼Œæœ‰å¯èƒ½å‡ºç°<code>CUDA OOM</code>å’Œ<code>Illegal instruction (core dumped)</code>æŠ¥é”™ã€‚æ‰€ä»¥æœ€å¥½æ˜¯ä»githubçš„ä¸»åˆ†æ”¯ä¸‹è½½ä¸‹æ¥æœ€æ–°çš„ä»£ç ï¼Œé…ç½®ç¯å¢ƒ<code>export USE_NUMA=1</code>ä¹‹åè¿è¡Œ<code>bash install.sh</code>é‡æ–°ç¼–è¯‘ä¸€éã€‚åœ¨æœ€æ–°çš„ä»£ç ä¸­ï¼Œä¸ä¼šå‘ç”Ÿ<code>CUDA OOM</code>æŠ¥é”™ã€‚</p>
<h2 id="dockerå®¹å™¨è¿è¡ŒæŒ‡ä»¤">Dockerå®¹å™¨è¿è¡ŒæŒ‡ä»¤</h2>
<pre><code class="language-bash">$ docker start ktransformers
$ docker exec -it ktransformers /bin/bash
</code></pre>
<p>è¿™æ ·å°±å¯ä»¥è¿›å…¥åˆ°Dockerå®¹å™¨çš„å‘½ä»¤è¡Œç•Œé¢ã€‚</p>
<h2 id="ktransformerså¯åŠ¨æŒ‡ä»¤">KTransformerså¯åŠ¨æŒ‡ä»¤</h2>
<p>åœ¨å®¹å™¨ä¸­æˆ‘ä»¬è¿›å…¥åˆ°ktransformersè·¯å¾„ä¸‹ï¼Œå°±å¯ä»¥æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">python3 -m ktransformers.local_chat --gguf_path /models/llm/models/DeepSeek-R1-IQ1_S --model_path /models/llm/models/DeepSeek-R1 --cpu_infer 36 -f true --port 11434 --max_new_tokens 1000
</code></pre>
<p>å¦‚æœè½¯ä»¶ç‰ˆæœ¬æ²¡é—®é¢˜çš„è¯ï¼Œä¸Šè¿°å‘½ä»¤ä¼šè¿è¡ŒæˆåŠŸå¹¶è¿›å…¥åˆ°ä¸€ä¸ªæœ¬åœ°Chatçš„æ¨¡å¼ã€‚ä½†æ˜¯ç»è¿‡å®é™…æµ‹è¯•ï¼Œé»˜è®¤çš„0.2.1çš„ç‰ˆæœ¬è¿˜æ˜¯æœ‰é—®é¢˜ã€‚æˆ‘å»ºè®®ç›´æ¥cloneæœ€æ–°åˆ†æ”¯ä»£ç ï¼Œç›´æ¥è¿è¡Œ<code>bash install.sh</code>è¿›è¡Œå®‰è£…ã€‚</p>
<h1 id="local-chatæµ‹è¯•ç»“æœ">Local Chatæµ‹è¯•ç»“æœ</h1>
<p>ç®€å•æé—®ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250311105937133-951930973.png">
</div>
<p>æµ‹è¯•ç»å…¸AIé—®é¢˜ï¼ˆæ›´å¤šç±»ä¼¼é—®é¢˜å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/dechinphy/p/18741066/ds-test" target="_blank">è¿™ç¯‡æ–‡ç« </a>ï¼‰ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250311155735780-1398868193.png">
</div>
<p>å¹³å‡tokensé€Ÿåº¦å¤§æ¦‚å°±æ˜¯åœ¨<code>6T/s</code>äº†ï¼Œä»å®é™…ä½“éªŒæ¥è¯´çš„è¯ï¼Œå‹‰å¼ºèƒ½æ¥å—ã€‚æ›´å¤šçš„ç¤ºä¾‹å°±ä¸æ”¾äº†ï¼Œéœ€è¦è®°ä½çš„æ˜¯ï¼Œå¦‚æœtokensé…ç½®çš„ä¸å¤Ÿå¤šï¼Œè¾“å‡ºæœ‰å¯èƒ½ä¼šå—é™ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250311155753586-1977898091.png">
</div>
<h1 id="ktransformersæœåŠ¡">KTransformersæœåŠ¡</h1>
<p>ä¸Šé¢ä»‹ç»çš„æ˜¯ä½¿ç”¨<code>local_chat</code>çš„æ¨¡å¼ï¼Œä½†æ˜¯å¦‚æœè¦æœ‰æ›´å¥½çš„ä½¿ç”¨ä½“éªŒçš„è¯ï¼Œè¿˜æ˜¯éœ€è¦ç”¨æœåŠ¡æ¨¡å¼ï¼š</p>
<pre><code class="language-bash">ktransformers --gguf_path /models/llm/models/DeepSeek-R1-IQ1_S --model_path /models/llm/models/DeepSeek-R1 --cpu_infer 36 --force_think --host 0.0.0.0 --port 8080 --max_new_tokens 4096 --model_name DeepSeek-R1 --fast_safetensors true --dynamic_temperature true --use_cuda_graph
</code></pre>
<p>å®¹å™¨å†…å¯åŠ¨æˆåŠŸä»¥åï¼Œå¯ä»¥åœ¨å®¿ä¸»æœºæµ‹è¯•ä¸€ä¸ªOpenAIæ ¼å¼çš„è¯·æ±‚ï¼ˆå¦‚æœæ˜¯Ollamaæ ¼å¼çš„è¯·æ±‚ï¼Œéœ€è¦é¢å¤–è£…ä¸€äº›è½¯ä»¶ï¼Œé»˜è®¤ä¸å¸¦Ollamaæ ¼å¼è¯·æ±‚çš„æ”¯æŒï¼‰ï¼š</p>
<pre><code class="language-bash">curl -X 'POST' \
  'http://localhost:11434/v1/chat/completions' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "messages": [
    {
      "content": "Who are you?",
      "role": "user"
    }
  ],
  "model": "DeepSeek-R1",
  "stream": false
}'
</code></pre>
<p>å¦‚æœå¾—åˆ°ä¸€ä¸ªè¿™æ ·çš„è¾“å‡ºï¼š</p>
<pre><code class="language-bash">{"id":"xxx","choices":[{"finish_reason":"stop","index":0,"logprobs":null,"message":{"content":"&lt;think&gt;\nI'm DeepSeek-R1, an artificial intelligence created by DeepSeek. I'm at your service. I'm an open AI, so feel free to ask me anything. I'll do my best to provide valuable answers. If you have any questions, go ahead. I'm here to help!\n&lt;/think&gt;\n\nI'm DeepSeek-R1, an artificial intelligence created by DeepSeek. I'm at your service. I'm an open AI, so feel free to ask me anything. I'll do my best to provide valuable answers. If you have any questions, go ahead. I'm here to help!","refusal":null,"role":"assistant","audio":null,"function_call":null,"tool_calls":null}}],"created":1741763162,"model":"DeepSeek-R1","object":"chat.completion","service_tier":null,"system_fingerprint":null,"usage":{"completion_tokens":126,"prompt_tokens":7,"total_tokens":133,"completion_tokens_details":null,"prompt_tokens_details":null}}
</code></pre>
<p>é‚£å°±è¡¨ç¤ºæœåŠ¡å¯åŠ¨æˆåŠŸäº†ï¼Œå…¶ä¸­<code>content</code>éƒ¨åˆ†å°±æ˜¯æ¨¡å‹ç”Ÿæˆçš„ç­”å¤ã€‚æœåŠ¡éƒ¨ç½²æˆåŠŸä»¥åï¼Œå°±å¯ä»¥ç»§ç»­è€ƒè™‘ä½¿ç”¨ä¸€äº›WebUIçš„æœåŠ¡ï¼Œè®©KTransformersæ¨¡å‹çš„ä½¿ç”¨æ›´åŠ å‹å¥½ã€‚</p>
<h2 id="æ—¥å¿—è¾“å‡º">æ—¥å¿—è¾“å‡º</h2>
<p>å¦‚æœä½ ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„Dockeré•œåƒéƒ¨ç½²çš„KTransformerï¼Œé‚£ä¹ˆé»˜è®¤çš„æ—¥å¿—è·¯å¾„åœ¨<code>/opt/conda/lib/python3.10/site-packages/ktransformers/logs/lexllama.log</code>ï¼Œå¯ä»¥ç›´æ¥<code>tail -f</code>æŸ¥çœ‹ã€‚ä¸çŸ¥é“ä¸ºä½•ï¼Œåœ¨å¯åŠ¨æœåŠ¡æ—¶é…ç½®çš„<code>log_dir</code>å’Œ<code>log_file</code>éƒ½æ²¡æœ‰ç”Ÿæ•ˆã€‚</p>
<h1 id="webæœåŠ¡">WebæœåŠ¡</h1>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªåƒDeepSeekå®˜ç½‘é‚£ç§å¯ä»¥Chatçš„ç½‘ç«™ï¼Œæˆ–è€…æ˜¯ç±»ä¼¼äºä¹‹å‰çš„æ–‡ç« ä¸­ä»‹ç»è¿‡çš„<a href="https://www.cnblogs.com/dechinphy/p/18715481/ds-pa" target="_blank">PageAssist</a>è¿™æ ·çš„æ’ä»¶ï¼Œå°±éœ€è¦éƒ¨ç½²ä¸€ä¸ªWebUIçš„æœåŠ¡ã€‚ä½†æ˜¯å¦‚æœå‚è€ƒKTransformerså®˜ç½‘çš„åšæ³•ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312134635258-239934669.png">
</div>
<p>æˆ‘åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæœ€åä¸€æ­¥ä¼šå‡ºç°å¤§é‡çš„<code>ninja</code>è¿›ç¨‹ï¼š</p>
<pre><code class="language-bash">$ ps -ef | grep "[n]inja" | grep -v "grep" | wc -l
25349
</code></pre>
<p>è€Œä¸”æ•°é‡ä¼šä¸æ–­å¢é•¿ï¼Œå› æ­¤æˆ‘ä¸ªäººçš„å»ºè®®æ˜¯æš‚æ—¶å…ˆä¸è¦ä½¿ç”¨KTransformersè‡ªå¸¦çš„è¿™ä¸ªWebæœåŠ¡ï¼Œå¯ä»¥è¯•ä¸€è¯•å¦ä¸€ä¸ªå¼€æºWebæœåŠ¡ï¼š<code>Open WebUI</code>ã€‚</p>
<h2 id="open-webui">Open WebUI</h2>
<p>Open WebUIæœ‰ä¸¤ç§å®‰è£…æ–¹æ³•ï¼Œä¸€ç§æ¯”è¾ƒç®€å•çš„ç›´æ¥åœ¨æœ¬æœºä½¿ç”¨pythonè¿›è¡Œå®‰è£…ï¼š</p>
<pre><code class="language-bash">conda create -n open-webui python=3.11 -y
conda activate open-webui
pip install open-webui
open-webui serve
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œopen-webuiå¯¹äºpythonçš„ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œæ‰€ä»¥ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒåˆ›å»ºä¸€ä¸ªæ–°çš„pythonç¯å¢ƒæ˜¯æœ€å¥½çš„ã€‚æˆåŠŸå¯åŠ¨æœåŠ¡ä¹‹åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š<code>http://localhost:8080</code>è¿›å…¥åˆ°Open WebUIçš„ä¸»ç•Œé¢ã€‚</p>
<p>è€ƒè™‘åˆ°å®‰è£…çš„é€»è¾‘ï¼Œè¿™é‡Œå…ˆä»‹ç»ç¬¬äºŒç§å®‰è£…<code>open-webui</code>çš„æ–¹æ³•ï¼Œå†è¿›å…¥åˆ°æ¼”ç¤ºæˆæœã€‚ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨dockeræ¥å®‰è£…ï¼Œä¹Ÿæ˜¯æˆ‘ä¸ªäººæ¯”è¾ƒæ¨èçš„ä¸€ä¸ªæ–¹æ¡ˆï¼š</p>
<pre><code class="language-bash">docker pull ghcr.io/open-webui/open-webui:main
docker run -d -p 3000:8080 -v open-webui:/app/backend/data --name open-webui ghcr.io/open-webui/open-webui:main
</code></pre>
<p>å¯ä»¥æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œä»¥ç¡®è®¤æœåŠ¡éƒ¨ç½²çš„è¿›åº¦ï¼š</p>
<pre><code class="language-bash">docker logs -f open-webui
</code></pre>
<p>å› ä¸ºè¿™é‡Œä½¿ç”¨äº†ç«¯å£æ˜ å°„ï¼Œæ‰€ä»¥åœ¨æœ¬åœ°å¯åŠ¨webæœåŠ¡æ—¶ä½¿ç”¨çš„è·¯å¾„åº”è¯¥ä¸º<code>http://localhost:3000</code>ã€‚ç„¶åè¿™ä¸¤ç§æ–¹æ¡ˆçš„éƒ¨ç½²ï¼Œéƒ½å¯ä»¥è¿›å…¥åˆ°ä¸»é¡µï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312122602930-193593690.png">
</div>
<p>ç‚¹å‡»<code>å¼€å§‹ä½¿ç”¨</code>ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312122644001-1799396283.png">
</div>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªè´¦å·åˆ†é…çš„ç•Œé¢ï¼Œå¯¹äºå¤šç”¨æˆ·çš„ä½¿ç”¨éå¸¸å‹å¥½ï¼Œå¯ä»¥ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ¨ç½²ä¸€ä¸ªOpen WebUIæœåŠ¡ï¼ˆæ³¨æ„å®‰å…¨æ€§é…ç½®é—®é¢˜ï¼‰ï¼Œç„¶åæœ¬åœ°å¤šç”¨æˆ·ç›´æ¥åœ¨åŒä¸€ä¸ªIPä¸‹åˆ›å»ºè‡ªå·±çš„ä½¿ç”¨è´¦å·å³å¯ã€‚</p>
<p>è¿›å…¥ä»¥åï¼Œåœ¨è®¾ç½®ç•Œé¢ï¼Œé…ç½®KTransformersä¸ºå¤–éƒ¨è¿æ¥ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312151855720-1340080707.png">
</div>
<p>ç„¶åå°±å¯ä»¥åƒPageAssistå’ŒDeepSeekçš„å®˜ç½‘é‚£æ ·ï¼Œå»ä½¿ç”¨æœ¬åœ°ä½¿ç”¨KTransformersè¿›è¡Œæ¨ç†çš„DeepSeek-R1æ¨¡å‹äº†ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312125926051-11430915.png">
</div>
<p>è¿˜æœ‰å…¶ä»–æ›´å¤šçš„ä¸€äº›æµ‹è¯•ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312134927829-1223958725.png">
</div>
<p>è™½ç„¶å’±ç”¨çš„æ˜¯ä¸€ä¸ª1.58bitçš„è¿·ä½ é‡åŒ–ç‰ˆï¼Œä½†æ¯•ç«Ÿä¹Ÿæ˜¯å…¨é‡å‚æ•°çš„DeepSeekï¼Œæ•ˆæœä¸Šç¡®å®æ˜æ˜¾æ¯”70Bçš„è’¸é¦ç‰ˆè¦å¥½ä¸€äº›ã€‚</p>
<h1 id="ç©ºé—´å ç”¨">ç©ºé—´å ç”¨</h1>
<p>å› ä¸ºKTransformersä¸»æ‰“çš„æ˜¯ä½¿ç”¨CPUæŒ‡ä»¤é›†åŠ é€Ÿçš„æ¨ç†æ–¹æ³•ï¼Œæ‰€ä»¥å¯¹äºGPUçš„éœ€æ±‚æ²¡æœ‰å¾ˆé«˜ï¼ˆ<code>nvidia-smi</code>ï¼‰ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312111837313-1248655369.png">
</div>
<p>å†…å­˜æ–¹é¢ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå äº†å¾ˆå¤šçš„ç£ç›˜I/Oï¼ˆ<code>docker stats</code>ï¼‰ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312112307391-1545368821.png">
</div>
<p>æˆ‘åªèƒ½æ‰‹åŠ¨é…ç½®ä¸€ä¸‹å°½é‡ä¸é€‚ç”¨ç£ç›˜I/Oï¼š</p>
<pre><code class="language-bash">sysctl vm.swappiness=0
</code></pre>
<p>è¿™æ ·å¤§éƒ¨åˆ†çš„å†…å­˜æ¶ˆè€—éƒ½è¢«æ”¾åˆ°cacheé‡Œé¢ï¼ˆ<code>free -h</code>ï¼‰ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312145920164-1655494827.png">
</div>
<h1 id="slackboté…ç½®">SlackBoté…ç½®</h1>
<p>åœ¨<a href="https://www.cnblogs.com/dechinphy/p/18750795/slackbot" target="_blank">å‰é¢ä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬æåˆ°å¯ä»¥å°†Ollamaå¯¹æ¥SlackBotï¼Œåšä¸€ä¸ªSlackå¤§æ¨¡å‹èŠå¤©æœºå™¨äººã€‚è¿™é‡Œå¯¹ç…§OpenAIçš„è¯·æ±‚æ ¼å¼ï¼Œæˆ‘ä»¬åšä¸€ä¸ªå¯¹åº”çš„è°ƒæ•´ï¼Œä½¿å¾—SlackBotå¯ä»¥å¯¹æ¥ä¸ŠKTransformeræ­å»ºçš„æ¨ç†æ¨¡å‹ï¼š</p>
<pre><code class="language-python">import os
import re
import time
from datetime import datetime
import requests
from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆå§‹åŒ– Slack åº”ç”¨
app = App(
    token=os.environ["SLACK_BOT_TOKEN"],
    signing_secret=os.environ["SLACK_SIGNING_SECRET"]
)

# OpenAI é…ç½®
# OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_ENDPOINT = "http://xxx.xxx.xxx.xxx:11434/v1/chat/completions"
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "DeepSeek-R1")

class PerformanceMetrics:
    def __init__(self):
        self.start_time = None
        self.total_tokens = 0
        self.total_duration = 0.0
    
    def start_timing(self):
        self.start_time = time.time()
    
    def add_response(self, openai_response: dict):
        """æ›´æ–°æ€§èƒ½ç»Ÿè®¡"""
        self.total_duration = time.time() - self.start_time
        self.total_tokens = openai_response.get('usage', {}).get('total_tokens', 0)
    
    def get_metrics(self) -&gt; str:
        if self.total_duration &gt; 0:
            speed = self.total_tokens / self.total_duration
        else:
            speed = 0
        
        return (
            f"\n\n_æ€§èƒ½ç»Ÿè®¡ï¼šç”Ÿæˆ {self.total_tokens} tokens | "
            f"é€Ÿåº¦ {speed:.1f} tokens/s | "
            f"æ€»è€—æ—¶ {self.total_duration:.1f}s_"
        )

def query_openai(prompt: str) -&gt; dict:
    """å‘ OpenAI å‘é€è¯·æ±‚å¹¶è·å–å“åº”"""
    headers = {
        "accept": "application/json",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": OPENAI_MODEL,
        "messages": [{
            "role": "user",
            "content": f"è¯·å…ˆè¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼ˆç”¨THINKING:å¼€å¤´ï¼‰ï¼Œå†è¾“å‡ºæœ€ç»ˆç­”æ¡ˆï¼ˆç”¨ANSWER:å¼€å¤´ï¼‰ï¼Œè¾“å‡ºç»“æœä¸­çš„`è¯·ç”¨å¼•å·'æ›¿ä»£ï¼š\n\n{prompt}"
        }],
        "stream": "false",
    }

    try:
        metrics = PerformanceMetrics()
        metrics.start_timing()
        
        response = requests.post(OPENAI_ENDPOINT, headers=headers, json=payload, timeout=60*60*6)
        response.raise_for_status()
        
        json_response = response.json()
        metrics.add_response(json_response)
        json_response["metrics"] = metrics
        
        return json_response
    except requests.exceptions.RequestException as e:
        return {"error": f"OpenAI è¯·æ±‚å¤±è´¥: {str(e)}"}
    except Exception as e:
        return {"error": f"å¤„ç†å“åº”æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"}

def format_slack_response(raw_response: str) -&gt; str:
    """å°†åŸå§‹å“åº”åˆ†å‰²ä¸ºæ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆç­”æ¡ˆ"""
    # ç»Ÿä¸€å¤„ç†å¯èƒ½çš„é”™è¯¯ä¿¡æ¯
    if 'error' in raw_response:
        return f"âš ï¸ é”™è¯¯ï¼š{raw_response['error']}"
    
    content = raw_response['choices'][0]['message']['content']
    
    thinking_match = re.search(r"THINKING:(.*?)(ANSWER:|\Z)", content, re.DOTALL)
    answer_match = re.search(r"ANSWER:(.*)", content, re.DOTALL)

    thinking = thinking_match.group(1).strip() if thinking_match else "æœªæä¾›æ€è€ƒè¿‡ç¨‹"
    answer = answer_match.group(1).strip() if answer_match else content

    return (
        f"*ğŸ¤” æ€è€ƒè¿‡ç¨‹*ï¼š\n```{thinking}```\n\n"
        f"*ğŸ’¡ æœ€ç»ˆå›ç­”*ï¼š\n```{answer}```"
    )

@app.event("app_mention")
def handle_openai_query(event, say):
    """å¤„ç† Slack æåŠäº‹ä»¶"""
    say(text=f"AIæ¨¡å‹æ­£åœ¨æ€è€ƒï¼ˆ{OPENAI_MODEL}ï¼‰ï¼Œè¯·ç¨å€™...")
    
    # ç§»é™¤æœºå™¨äººæåŠæ ‡è®°
    query = event["text"].replace(f'&lt;@{app.client.auth_test()["user_id"]}&gt;', '').strip()
    
    # è·å– OpenAI å“åº”
    response = query_openai(query)
    
    if 'error' in response:
        say(text=response['error'], channel=event["channel"])
        return
    
    # æ ¼å¼åŒ–æ¶ˆæ¯
    message_content = format_slack_response(response)
    
    # æ·»åŠ æ€§èƒ½ç»Ÿè®¡
    if 'metrics' in response:
        message_content += response['metrics'].get_metrics()
    
    # å‘é€æœ€ç»ˆå“åº”
    say(text=message_content, channel=event["channel"])

if __name__ == "__main__":
    SocketModeHandler(app, os.environ["SLACK_APP_TOKEN"]).start()
</code></pre>
<p>è¿è¡Œæ•ˆæœå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312153630742-163814792.png">
</div>
<p>ç”Ÿæˆä»£ç ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312153635394-2007202293.png">
</div>
<p>å®é™…ä¸ŠSlackBotè¿˜å¯ä»¥åˆ©ç”¨ä¼šè¯ä¿®æ”¹çš„åŠŸèƒ½ï¼Œç”Ÿæˆæµå¼çš„ç­”å¤ï¼Œä½†æ˜¯å¦‚æœé«˜é¢‘çš„è°ƒç”¨SlackBotçš„APIï¼Œæœ‰å¯èƒ½ä¼šè¢«å®˜æ–¹é™æµã€‚æ‰€ä»¥ï¼Œä¸å»ºè®®è¿™ä¹ˆç”¨ã€‚</p>
<h1 id="å…¼å®¹page-assist">å…¼å®¹Page-Assist</h1>
<p>å…³äºPage-Assistæ’ä»¶çš„å®‰è£…å’Œä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://www.cnblogs.com/dechinphy/p/18715481/ds-pa" target="_blank">è¿™ç¯‡æ–‡ç« </a>ã€‚<br>
å¦‚æœæœ¬åœ°å·²ç»æœ‰äº†Page-Assistï¼Œä¸æƒ³é€šè¿‡Open-WebUIæ¥è®¿é—®KTransformersæ¨ç†å¤§æ¨¡å‹ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åœ¨Page-Assistçš„è®¾ç½®é‡Œæ‰¾åˆ°<code>OpenAIå…¼å®¹API</code>ï¼Œé€‰æ‹©OpenAIæä¾›å•†ï¼Œç„¶åæŒ‰ç…§è‡ªå·±çš„å‘½åå¡«ä¸€ä¸ªæœ¬åœ°æä¾›å•†å’Œurlï¼ˆæ³¨æ„ï¼<code>è¿™é‡Œæ˜¯httpï¼Œä¸æ˜¯httpsï¼</code>ï¼‰ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312160439830-634659279.png">
</div>
<p>æŠŠè‡ªå·±çš„è·¯å¾„é…ç½®è¿›å»ï¼Œå¦‚æœèƒ½å¤ŸæˆåŠŸè¿ä¸Šçš„è¯ï¼Œä¼šå¼¹æ¡†è®©ä½ é€‰æ‹©æ¨¡å‹åŠ å…¥æœ¬åœ°æ¨¡å‹åˆ—è¡¨ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312160540111-1997000234.png">
</div>
<p>ç„¶åå°±å¯ä»¥è½»æ¾å¼€å¯å¯¹è¯ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312160615461-433585129.png">
</div>
<p>è¿™æ ·ä¸€æ¥ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æœ¬åœ°çš„embeddingæ¨¡å‹å®ç°è”ç½‘æœç´¢åŠŸèƒ½ï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312161903076-441447318.png">
</div>
<p>å¯ä»¥å¯¹ç…§ä¸€ä¸‹æ•°æ®æ¥æºï¼š</p>
<div align="center">
	<img src="https://img2024.cnblogs.com/blog/2277440/202503/2277440-20250312161924691-426649766.png">
</div>
<h1 id="é‡è¦æç¤º">é‡è¦æç¤º</h1>
<ol>
<li><code>KTransformerså®˜æ–¹ä¸æ”¯æŒå¤šç”¨æˆ·</code>åŒæ—¶ä½¿ç”¨ï¼Œé‡‡ç”¨çš„æ˜¯é˜Ÿåˆ—é˜»å¡æ¨¡å¼ã€‚</li>
<li>éƒ¨åˆ†è€æ—§å‹å·çš„æ˜¾å¡è¿è¡ŒKTransformerså¯èƒ½æŠ¥é”™<code>TORCH_USE_CUDA_DSA</code>ï¼Œæ²¡æœ‰å¤ªå¥½çš„è§£å†³æ–¹æ¡ˆã€‚</li>
<li>å¦‚æœCPUä¸æ”¯æŒAVX512æŒ‡ä»¤é›†ï¼Œæ— æ³•å……åˆ†å‘æŒ¥KTransformersçš„æ€§èƒ½ã€‚</li>
<li>å¦‚æœåœ¨Dockerå®¹å™¨ä¸­å¯¹KTransformersçš„ç‰ˆæœ¬åšäº†æ›´æ–°ï¼Œè®°å¾—æŠŠæ›´æ–°commitåˆ°é•œåƒä¸­ã€‚</li>
<li>å®¹å™¨å†…éƒ¨çš„æ¥å£ç›‘å¬ï¼Œå¿…é¡»æ˜¯<code>0.0.0.0</code>ï¼Œæˆ–è€…åŒ¹é…è‡ªå·±çš„IPæ®µã€‚</li>
</ol>
<h1 id="æ€»ç»“æ¦‚è¦">æ€»ç»“æ¦‚è¦</h1>
<p>æœ¬æ–‡ä»‹ç»äº†å›½äº§çš„å¤§æ¨¡å‹æ¨ç†å·¥å…·KTransformersåœ¨æœ¬åœ°æˆåŠŸè¿è¡Œçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œåœ¨å®¹å™¨åŒ–éƒ¨ç½²çš„åŸºç¡€ä¸Šï¼Œç»“åˆOpen WebUIåšäº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„å¤§æ¨¡å‹æœåŠ¡ã€‚</p>
<h1 id="ç‰ˆæƒå£°æ˜">ç‰ˆæƒå£°æ˜</h1>
<p>æœ¬æ–‡é¦–å‘é“¾æ¥ä¸ºï¼š<a href="https://www.cnblogs.com/dechinphy/p/kt158.html" target="_blank">https://www.cnblogs.com/dechinphy/p/kt158.html</a></p>
<p>ä½œè€…IDï¼šDechinPhy</p>
<p>æ›´å¤šåŸè‘—æ–‡ç« ï¼š<a href="https://www.cnblogs.com/dechinphy/" target="_blank">https://www.cnblogs.com/dechinphy/</a></p>
<p>è¯·åšä¸»å–å’–å•¡ï¼š<a href="https://www.cnblogs.com/dechinphy/gallery/image/379634.html" target="_blank">https://www.cnblogs.com/dechinphy/gallery/image/379634.html</a></p>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<ol>
<li><a href="https://kvcache-ai.github.io/ktransformers/en/api/server/website.html" target="_blank" rel="noopener nofollow">https://kvcache-ai.github.io/ktransformers/en/api/server/website.html</a></li>
<li><a href="https://ollama.cadn.net.cn/api.html" target="_blank" rel="noopener nofollow">https://ollama.cadn.net.cn/api.html</a></li>
<li><a href="https://docs.openwebui.com/getting-started/quick-start/" target="_blank" rel="noopener nofollow">https://docs.openwebui.com/getting-started/quick-start/</a></li>
</ol>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.1923195869351852" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-12 17:40">2025-03-12 15:34</span>&nbsp;
<a href="https://www.cnblogs.com/dechinphy">DECHIN</a>&nbsp;
é˜…è¯»(<span id="post_view_count">98</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18764562" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18764562);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18764562', targetLink: 'https://www.cnblogs.com/dechinphy/p/18764562/kt158', title: 'KTransformerså®æˆ˜DeepSeek-R1-1.58bité‡åŒ–æ¨¡å‹' })">ä¸¾æŠ¥</a>
</div>
        