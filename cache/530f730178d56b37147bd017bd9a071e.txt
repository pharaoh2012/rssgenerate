
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/developer-tianyiyun/p/19028962" title="发布于 2025-08-08 17:47">
    <span role="heading" aria-level="2">Ansible部署Node_exporter</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Ansible是基于Python开发的自动化运维工具，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>本文分享自天翼云开发者社区《<a href="https://www.ctyun.cn/developer/article/460951390470213" rel="noopener nofollow">Ansible部署Node_exporter</a>》，作者：SummerSnow</p>
<p>一、简介</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;Ansible是基于Python开发的自动化运维工具，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;Exporter是Prometheus的指标数据收集组件，而node_exporter就是我们常用的其中之一，它主要用于采集类UNIX内核的硬件以及系统指标，如磁盘、cpu、内存等信息。</p>
<p>二、环境说明</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">#操作系统版本
[root@XXXXX][</span>~<span style="color: rgba(0, 0, 0, 1)">]
$cat </span>/etc/redhat-<span style="color: rgba(0, 0, 0, 1)">release 
CentOS Linux release </span><span style="color: rgba(128, 0, 128, 1)">7.7</span>.<span style="color: rgba(128, 0, 128, 1)">1908</span><span style="color: rgba(0, 0, 0, 1)"> (Core)

#Ansible版本
ansible </span><span style="color: rgba(128, 0, 128, 1)">2.9</span>.<span style="color: rgba(128, 0, 128, 1)">25</span><span style="color: rgba(0, 0, 0, 1)">
#node</span>-<span style="color: rgba(0, 0, 0, 1)">exporter版本
node_exporter</span>-<span style="color: rgba(128, 0, 128, 1)">1.2</span>.<span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">
#环境说明：本操作未涉及容器化部署，同时在centos 7环境进行部署</span></pre>
</div>
<p>三、安装Ansible</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">#上传已经准备好的的安装包（内网环境）
[root@XXXXX </span>~] tar -<span style="color: rgba(0, 0, 0, 1)">zxvf ansible.tar.gz

#使用下面的命令进行安装（yum本地安装）
[root@XXXXX </span>~]# yum localinstall *.rpm -<span style="color: rgba(0, 0, 0, 1)">y

#查看ansible版本
[root@XXX][</span>~<span style="color: rgba(0, 0, 0, 1)">]
$ansible </span>--<span style="color: rgba(0, 0, 0, 1)">version
ansible </span><span style="color: rgba(128, 0, 128, 1)">2.9</span>.<span style="color: rgba(128, 0, 128, 1)">25</span><span style="color: rgba(0, 0, 0, 1)">
  config file </span>= /etc/ansible/<span style="color: rgba(0, 0, 0, 1)">ansible.cfg
  configured module search path </span>= [u<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">/root/.ansible/plugins/modules</span><span style="color: rgba(128, 0, 0, 1)">'</span>, u<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">/usr/share/ansible/plugins/modules</span><span style="color: rgba(128, 0, 0, 1)">'</span>]</pre>
</div>
<p>四、使用Ansible部署node_exporter</p>
<p>1）填写需要部署的主机清单host</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">#如果机器之间已经做了免密，那就去掉ansible_ssh_pass改配置，多台机器直接追加就行
[root@XXXXXX][</span>~<span style="color: rgba(0, 0, 0, 1)">]
$vim host
[node]
XX.XX ansible_ssh_user</span>=XXX ansible_ssh_pass=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">XXXXXX</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
XX.XX ansible_ssh_user</span>=XXX ansible_ssh_pass=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">XXXXXX</span><span style="color: rgba(128, 0, 0, 1)">"</span></pre>
</div>
<p>2）编写Ansible的剧本文件node_exporter.yml</p>
<div class="cnblogs_code">
<pre>---
-<span style="color: rgba(0, 0, 0, 1)"> hosts: node
  gather_facts: yes
  become: yes
  become_method: sudo
  become_user: root
  tasks: 
    </span>-<span style="color: rgba(0, 0, 0, 1)"> name: 添加prometheus用户
      user:
        name: prometheus
        password: </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{{ 'XXXXX' | password_hash('sha512') }}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
        home: </span>/home/<span style="color: rgba(0, 0, 0, 1)">prometheus

    </span>-<span style="color: rgba(0, 0, 0, 1)"> name: 创建node_exporter_script目录
      file:
        path: </span>/home/prometheus/<span style="color: rgba(0, 0, 0, 1)">node_exporter_script
        state: directory
        mode: </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">0755</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">
        owner: prometheus
        group: prometheus

    </span>-<span style="color: rgba(0, 0, 0, 1)"> name: 创建node_exporter_textfile目录
      file:
        path: </span>/home/prometheus/<span style="color: rgba(0, 0, 0, 1)">node_exporter_textfile
        state: directory
        mode: </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">0755</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">
        owner: prometheus
        group: prometheus

    </span>-<span style="color: rgba(0, 0, 0, 1)"> name: 安装CentOS7的node_exporter
      unarchive: src</span>=node_exporter-<span style="color: rgba(128, 0, 128, 1)">1.2</span>.<span style="color: rgba(128, 0, 128, 1)">2</span>.linux-amd64.tar.gz dest=/home/prometheus mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">0755</span><span style="color: rgba(128, 0, 0, 1)">'</span> owner=prometheus group=<span style="color: rgba(0, 0, 0, 1)">prometheus
      when:
        </span>- ansible_distribution == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">CentOS</span><span style="color: rgba(128, 0, 0, 1)">"</span>
        - ansible_distribution_major_version == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">7</span><span style="color: rgba(128, 0, 0, 1)">"</span>

    -<span style="color: rgba(0, 0, 0, 1)"> name: 添加CentOS7的node_exporter服务
      copy: src</span>=prometheus_node_exporter.service dest=/usr/lib/systemd/system/<span style="color: rgba(0, 0, 0, 1)">prometheus_node_exporter.service
      when:
        </span>- ansible_distribution == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">CentOS</span><span style="color: rgba(128, 0, 0, 1)">"</span>
        - ansible_distribution_major_version == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">7</span><span style="color: rgba(128, 0, 0, 1)">"</span>
    
    -<span style="color: rgba(0, 0, 0, 1)"> name: 开启centos7的prometheus_node_exporter服务并设置开机自启动
      systemd:
        name: prometheus_node_exporter
        daemon_reload: yes
        state: restarted
        enabled: yes
      when:
        </span>- ansible_distribution == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">CentOS</span><span style="color: rgba(128, 0, 0, 1)">"</span>
        - ansible_distribution_major_version == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">7</span><span style="color: rgba(128, 0, 0, 1)">"</span></pre>
</div>
<p>3）编写node-exporter的注册服务文件</p>
<div class="cnblogs_code">
<pre>[root@XXX][~<span style="color: rgba(0, 0, 0, 1)">]
$vim prometheus_node_exporter.service
[Unit]
Description</span>=<span style="color: rgba(0, 0, 0, 1)">Prometheus node_exporter
Requires</span>=network.target remote-<span style="color: rgba(0, 0, 0, 1)">fs.target
After</span>=network.target remote-<span style="color: rgba(0, 0, 0, 1)">fs.target

[Service]
Type</span>=<span style="color: rgba(0, 0, 0, 1)">simple
User</span>=<span style="color: rgba(0, 0, 0, 1)">prometheus
Group</span>=<span style="color: rgba(0, 0, 0, 1)">prometheus
ExecStart</span>=/home/prometheus/node_exporter-<span style="color: rgba(128, 0, 128, 1)">1.2</span>.<span style="color: rgba(128, 0, 128, 1)">2</span>.linux-amd64/node_exporter --collector.textfile.directory=/home/prometheus/<span style="color: rgba(0, 0, 0, 1)">node_exporter_textfile
ExecReload</span>=/bin/kill -<span style="color: rgba(0, 0, 0, 1)">HUP $MAINPID
KillMode</span>=<span style="color: rgba(0, 0, 0, 1)">process
Restart</span>=on-<span style="color: rgba(0, 0, 0, 1)">failure
RestartSec</span>=<span style="color: rgba(0, 0, 0, 1)">5s

[Install]
WantedBy</span>=multi-user.target</pre>
</div>
<p>4）命令执行</p>
<div class="cnblogs_code">
<pre>[root@XXX ~<span style="color: rgba(0, 0, 0, 1)">]
$ansible</span>-playbook node_exporter.yml -i host</pre>
</div>
<p>5）服务验证</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">#验证目标端口是否开启
[root@XXXXX </span>~<span style="color: rgba(0, 0, 0, 1)">]
$telnet 目标主机 </span><span style="color: rgba(128, 0, 128, 1)">9100</span></pre>
</div>
<p>至此，使用Ansible部署node-exporter完成。</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-08-08 17:48">2025-08-08 17:47</span>&nbsp;
<a href="https://www.cnblogs.com/developer-tianyiyun">天翼云开发者社区</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19028962);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19028962', targetLink: 'https://www.cnblogs.com/developer-tianyiyun/p/19028962', title: 'Ansible部署Node_exporter' })">举报</a>
</div>
        