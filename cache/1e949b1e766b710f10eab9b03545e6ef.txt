
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/aslanvon/p/18928233" title="å‘å¸ƒäº 2025-06-14 13:27">
    <span role="heading" aria-level="2">æ™ºèƒ½æŒ‡é’ˆ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åœ¨ C++ ä¸­ï¼Œæ™ºèƒ½æŒ‡é’ˆï¼ˆsmart pointersï¼‰æ˜¯ç”¨äºç®¡ç†åŠ¨æ€åˆ†é…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ç±»æ¨¡æ¿ã€‚å®ƒä»¬æ—¨åœ¨å¸®åŠ©å¼€å‘è€…è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œé¿å…å¸¸è§çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå¹¶ç®€åŒ–èµ„æºç®¡ç†ã€‚C++ æ ‡å‡†åº“æä¾›äº†ä¸‰ç§ä¸»è¦ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼š<code>std::unique_ptr</code>ã€<code>std::shared_ptr</code> å’Œ <code>std::weak_ptr</code>ã€‚æ¯ç§ç±»å‹éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ã€‚</p>
<h1 id="æ™ºèƒ½æŒ‡é’ˆçš„ä½œç”¨">æ™ºèƒ½æŒ‡é’ˆçš„ä½œç”¨</h1>
<ol>
<li><strong>è‡ªåŠ¨å†…å­˜ç®¡ç†</strong>ï¼šæ™ºèƒ½æŒ‡é’ˆèƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾æ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œä»è€Œé¿å…äº†æ‰‹åŠ¨è°ƒç”¨ <code>delete</code> å¯èƒ½å¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚</li>
<li><strong>æ‰€æœ‰æƒè¯­ä¹‰</strong>ï¼š
<ul>
<li><code>std::unique_ptr</code> å®ç°ç‹¬å æ‰€æœ‰æƒï¼ˆexclusive ownershipï¼‰ï¼Œå³ä¸€ä¸ªå¯¹è±¡åªèƒ½ç”±ä¸€ä¸ª <code>std::unique_ptr</code> æ‰€æœ‰ã€‚</li>
<li><code>std::shared_ptr</code> æ”¯æŒå…±äº«æ‰€æœ‰æƒï¼ˆshared ownershipï¼‰ï¼Œå…è®¸å¤šä¸ª <code>std::shared_ptr</code> å…±åŒæ‹¥æœ‰åŒä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li><code>std::weak_ptr</code> ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå®ƒæä¾›äº†ä¸€ç§éæ‹¥æœ‰çš„å¼•ç”¨æ–¹å¼æ¥è§‚å¯Ÿ <code>std::shared_ptr</code> ç®¡ç†çš„å¯¹è±¡ã€‚</li>
</ul>
</li>
</ol>
<h1 id="å¦‚ä½•ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ">å¦‚ä½•ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</h1>
<h2 id="1-stdunique_ptr">1. <code>std::unique_ptr</code></h2>
<ul>
<li><strong>ä½œç”¨</strong>ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªæŒ‡é’ˆå¯ä»¥æŒ‡å‘æŸä¸ªå¯¹è±¡ï¼Œå½“è¯¥ <code>std::unique_ptr</code> è¶…å‡ºä½œç”¨åŸŸæˆ–è¢«æ˜¾å¼åˆ é™¤æ—¶ï¼Œå…¶æ‰€ç®¡ç†çš„å¯¹è±¡ä¼šè¢«è‡ªåŠ¨é”€æ¯ã€‚</li>
<li><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</li>
</ul>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;memory&gt; // åŒ…å«æ™ºèƒ½æŒ‡é’ˆç›¸å…³çš„å¤´æ–‡ä»¶

int main() {
    // åˆ›å»ºä¸€ä¸ª unique_ptr æŒ‡å‘ä¸€ä¸ªæ–°çš„ int å¯¹è±¡
    std::unique_ptr&lt;int&gt; smartPtr = std::make_unique&lt;int&gt;(10);
    
    if (smartPtr) {
        std::cout &lt;&lt; "Value: " &lt;&lt; *smartPtr &lt;&lt; std::endl;
    }

    // ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ deleteï¼Œç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾
    return 0;
}
</code></pre>
<ul>
<li><strong>è½¬ç§»æ‰€æœ‰æƒ</strong>ï¼š</li>
</ul>
<pre><code class="language-cpp">auto anotherPtr = std::move(smartPtr); // å°†æ‰€æœ‰æƒä» smartPtr è½¬ç§»åˆ° anotherPtr
// æ­¤æ—¶ smartPtr å·²ç»ä¸å†æ‹¥æœ‰ä»»ä½•å¯¹è±¡ï¼ŒanotherPtr æ‹¥æœ‰åŸå§‹å¯¹è±¡
</code></pre>
<h2 id="2-stdshared_ptr">2. <code>std::shared_ptr</code></h2>
<ul>
<li><strong>ä½œç”¨</strong>ï¼šå…è®¸å¤šä¸ª <code>std::shared_ptr</code> åŒæ—¶æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”åªæœ‰å½“æœ€åä¸€ä¸ª <code>std::shared_ptr</code> è¢«é”€æ¯æ—¶ï¼Œè¯¥å¯¹è±¡æ‰ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</li>
</ul>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;memory&gt;

int main() {
    std::shared_ptr&lt;int&gt; sp1 = std::make_shared&lt;int&gt;(20);
    
    {
        std::shared_ptr&lt;int&gt; sp2 = sp1; // å¢åŠ å¼•ç”¨è®¡æ•°
        std::cout &lt;&lt; "sp1 use count: " &lt;&lt; sp1.use_count() &lt;&lt; std::endl; // è¾“å‡º 2
    } // sp2 è¶…å‡ºä½œç”¨åŸŸï¼Œå¼•ç”¨è®¡æ•°å‡å°‘

    std::cout &lt;&lt; "sp1 use count after sp2 is destroyed: " &lt;&lt; sp1.use_count() &lt;&lt; std::endl; // è¾“å‡º 1
    
    return 0;
}
</code></pre>
<h2 id="3-stdweak_ptr">3. <code>std::weak_ptr</code></h2>
<h3 id="ä¸»è¦ä½œç”¨">ä¸»è¦ä½œç”¨ï¼š</h3>
<h3 id="1-è§£å†³å¾ªç¯å¼•ç”¨reference-cycleé—®é¢˜">1. <strong>è§£å†³å¾ªç¯å¼•ç”¨ï¼ˆreference cycleï¼‰é—®é¢˜</strong></h3>
<p>å½“ä¸¤ä¸ªæˆ–å¤šä¸ª <code>shared_ptr</code> ç›¸äº’å¼•ç”¨æ—¶ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆå› ä¸ºå¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸º0ï¼‰ã€‚ç”¨ <code>weak_ptr</code> æ‰“ç ´è¿™ç§å¾ªç¯å¼•ç”¨æ˜¯å®ƒæœ€ä¸»è¦çš„ç”¨é€”ã€‚</p>
<pre><code class="language-cpp">struct B;
struct A {
    std::shared_ptr&lt;B&gt; b_ptr;
};
struct B {
    std::weak_ptr&lt;A&gt; a_ptr;  // ç”¨ weak_ptr é¿å…å¾ªç¯å¼•ç”¨
};
</code></pre>
<h3 id="2-ä¸´æ—¶è®¿é—®å…±äº«èµ„æºä¸å»¶é•¿èµ„æºç”Ÿå‘½å‘¨æœŸ">2. <strong>ä¸´æ—¶è®¿é—®å…±äº«èµ„æºï¼Œä¸å»¶é•¿èµ„æºç”Ÿå‘½å‘¨æœŸ</strong></h3>
<p>æœ‰æ—¶ä½ å¸Œæœ›è®¿é—®æŸä¸ªèµ„æºï¼Œä½†ä¸å¸Œæœ›å› ä¸ºä½ è®¿é—®å®ƒå°±å»¶é•¿å®ƒçš„ç”Ÿå‘½ï¼Œè¿™æ—¶å€™å°±ç”¨ <code>weak_ptr</code>ã€‚</p>
<pre><code class="language-cpp">std::shared_ptr&lt;int&gt; sp = std::make_shared&lt;int&gt;(42);
std::weak_ptr&lt;int&gt; wp = sp; // ä¸å¢åŠ å¼•ç”¨è®¡æ•°

if (auto spt = wp.lock()) {  // lock() è¿”å› shared_ptrï¼Œå¦‚æœèµ„æºå·²é‡Šæ”¾åˆ™è¿”å›ç©ºæŒ‡é’ˆ
    std::cout &lt;&lt; *spt &lt;&lt; '\n';
} else {
    std::cout &lt;&lt; "èµ„æºå·²ç»è¢«é‡Šæ”¾\n";
}
</code></pre>
<h2 id="weak_ptr-å’Œ-shared_ptrå…³ç³»"><code>weak_ptr</code> å’Œ <code>shared_ptr</code>å…³ç³»</h2>
<p><code>weak_ptr</code> å’Œ <code>shared_ptr</code> æ˜¯ C++ æ™ºèƒ½æŒ‡é’ˆåº“ä¸­çš„ä¸¤ä¸ªç´§å¯†ç›¸å…³çš„ç±»å‹ï¼Œå®ƒä»¬çš„å…³ç³»å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ç†è§£ï¼š</p>
<ol>
<li>
<h3 id="weak_ptr-æ˜¯å¯¹-shared_ptr-çš„ä¸€ç§éæ‹¥æœ‰å¼•ç”¨"><strong><code>weak_ptr</code> æ˜¯å¯¹ <code>shared_ptr</code> çš„ä¸€ç§â€œéæ‹¥æœ‰â€å¼•ç”¨</strong></h3>
</li>
</ol>
<ul>
<li><code>shared_ptr</code> ç®¡ç†èµ„æºçš„<strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œå¹¶ç»´æŠ¤<strong>å¼•ç”¨è®¡æ•°ï¼ˆuse_countï¼‰</strong>ã€‚</li>
<li><code>weak_ptr</code> è§‚å¯Ÿç”± <code>shared_ptr</code> ç®¡ç†çš„èµ„æºï¼Œä½†<strong>ä¸å‚ä¸å¼•ç”¨è®¡æ•°</strong>ï¼Œä¹Ÿä¸ä¼šå½±å“èµ„æºçš„é‡Šæ”¾æ—¶é—´ã€‚</li>
</ul>
<pre><code class="language-cpp">std::shared_ptr&lt;int&gt; sp = std::make_shared&lt;int&gt;(10);
std::weak_ptr&lt;int&gt; wp = sp;  // wp ä¸å¢åŠ å¼•ç”¨è®¡æ•°
</code></pre>
<hr>
<h3 id="2-weak_ptr-å¯ä»¥ä»-shared_ptr-æ„é€ è€Œæ¥åä¹‹ä¸èƒ½ç›´æ¥æ„é€ ">2. <strong><code>weak_ptr</code> å¯ä»¥ä» <code>shared_ptr</code> æ„é€ è€Œæ¥ï¼Œåä¹‹ä¸èƒ½ç›´æ¥æ„é€ </strong></h3>
<ul>
<li>âœ… ä» <code>shared_ptr</code> åˆ›å»º <code>weak_ptr</code>ï¼ˆä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰ï¼š</li>
</ul>
<pre><code class="language-cpp">std::shared_ptr&lt;MyClass&gt; sp = std::make_shared&lt;MyClass&gt;();
std::weak_ptr&lt;MyClass&gt; wp = sp;
</code></pre>
<ul>
<li>âŒ ä¸èƒ½ç›´æ¥ä» <code>weak_ptr</code> è·å¾—è£¸æŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œéœ€è¦å…ˆè°ƒç”¨ <code>.lock()</code> è·å– <code>shared_ptr</code>ï¼š</li>
</ul>
<pre><code class="language-cpp">if (auto spt = wp.lock()) {
    // ä½¿ç”¨ spt è®¿é—®å¯¹è±¡
}
</code></pre>
<hr>
<h3 id="3-å…±äº«ç›¸åŒçš„å¼•ç”¨æ§åˆ¶å—control-block">3. <strong>å…±äº«ç›¸åŒçš„å¼•ç”¨æ§åˆ¶å—ï¼ˆcontrol blockï¼‰</strong></h3>
<ul>
<li><code>shared_ptr</code> å’Œç”±å®ƒç”Ÿæˆçš„ <code>weak_ptr</code> éƒ½å…±äº«åŒä¸€ä¸ªæ§åˆ¶å—ã€‚
<ul>
<li>æ§åˆ¶å—ä¸­åŒ…å«ï¼š
<ul>
<li><code>use_count</code>ï¼šå½“å‰æœ‰å¤šå°‘ä¸ª <code>shared_ptr</code> æ‹¥æœ‰èµ„æºã€‚</li>
<li><code>weak_count</code>ï¼šå½“å‰æœ‰å¤šå°‘ä¸ª <code>weak_ptr</code> å¼•ç”¨æ§åˆ¶å—ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å½“ <code>use_count == 0</code> æ—¶ï¼Œèµ„æºè¢«é‡Šæ”¾ï¼›</li>
<li>å½“ <code>use_count == 0 &amp;&amp; weak_count == 0</code> æ—¶ï¼Œæ§åˆ¶å—æœ¬èº«ä¹Ÿè¢«é”€æ¯ã€‚</li>
</ul>
<hr>
<h3 id="4-å…¸å‹åº”ç”¨åœºæ™¯è§£å†³å¾ªç¯å¼•ç”¨">4. <strong>å…¸å‹åº”ç”¨åœºæ™¯ï¼šè§£å†³å¾ªç¯å¼•ç”¨</strong></h3>
<p>åœ¨ä¸¤ä¸ªç±»ç›¸äº’å¼•ç”¨æ—¶ï¼Œå¦‚æœéƒ½ç”¨ <code>shared_ptr</code>ï¼Œå°±å¯èƒ½å‘ç”Ÿèµ„æºæ— æ³•é‡Šæ”¾çš„é—®é¢˜ï¼ˆå¾ªç¯å¼•ç”¨ï¼‰ã€‚è¿™æ—¶ï¼Œåº”è¯¥è®©å…¶ä¸­ä¸€æ–¹ä½¿ç”¨ <code>weak_ptr</code>ã€‚</p>
<pre><code class="language-cpp">struct Node {
    std::shared_ptr&lt;Node&gt; next;
    std::weak_ptr&lt;Node&gt; prev;  // é˜²æ­¢å¾ªç¯å¼•ç”¨
};
</code></pre>
<hr>
<h3 id="æ€»ç»“ä¸€å¥è¯">æ€»ç»“ä¸€å¥è¯ï¼š</h3>
<blockquote>
<p><code>shared_ptr</code> æ˜¯èµ„æºçš„â€œæ‰€æœ‰è€…â€ï¼Œ<code>weak_ptr</code> æ˜¯èµ„æºçš„â€œæ—è§‚è€…â€ï¼›<code>weak_ptr</code> ä¾èµ– <code>shared_ptr</code> å­˜åœ¨ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ã€‚</p>
</blockquote>
<hr>
<p>å¦‚æœä½ å¸Œæœ›ä¸€ä¸ªå¯¹è±¡å…±äº«èµ„æº â†’ ç”¨ <code>shared_ptr</code>ï¼› å¦‚æœä½ å¸Œæœ›è®¿é—®ä½†ä¸æ‹¥æœ‰èµ„æºï¼ˆé¿å…å¾ªç¯å¼•ç”¨æˆ–å»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼‰â†’ ç”¨ <code>weak_ptr</code>ã€‚</p>
<h3 id="ä½¿ç”¨-weak_ptr-çš„å‡ ä¸ªå…³é”®ç‚¹">ä½¿ç”¨ weak_ptr çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>weak_ptr&lt;T&gt;</code></td>
<td>ä¸æ‹¥æœ‰èµ„æºï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•°</td>
</tr>
<tr>
<td><code>.lock()</code></td>
<td>å°è¯•è·å–èµ„æºçš„ <code>shared_ptr</code>ï¼Œå¯èƒ½ä¸ºç©º</td>
</tr>
<tr>
<td><code>.expired()</code></td>
<td>åˆ¤æ–­èµ„æºæ˜¯å¦å·²ç»è¢«é”€æ¯</td>
</tr>
<tr>
<td><code>.use_count()</code></td>
<td>è¿”å›å½“å‰èµ„æºè¢«å¤šå°‘ä¸ª <code>shared_ptr</code> æ‹¥æœ‰</td>
</tr>
</tbody>
</table>
<h1 id="æ™ºèƒ½æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸ">æ™ºèƒ½æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸ</h1>
<p><strong><code>shared_ptr</code>ã€<code>weak_ptr</code> å’Œ <code>unique_ptr</code> è¿™äº›æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æœ¬èº«åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šç«‹åˆ»è¢«ææ„ã€‚</strong>æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æœ¬èº«ï¼ˆ<code>shared_ptr</code>ã€<code>weak_ptr</code>ã€<code>unique_ptr</code>ï¼‰åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶éƒ½ä¼š<strong>ç«‹åˆ»ææ„</strong>ï¼›æ˜¯å¦é‡Šæ”¾èµ„æºï¼Œå–å†³äºå®ƒæ˜¯å¦æ‹¥æœ‰èµ„æºï¼Œä»¥åŠèµ„æºçš„å¼•ç”¨è®¡æ•°æ˜¯å¦å½’é›¶ã€‚</p>
<hr>
<h2 id="å…³é”®ç‚¹æ€»ç»“">å…³é”®ç‚¹æ€»ç»“ï¼š</h2>
<table>
<thead>
<tr>
<th>æ™ºèƒ½æŒ‡é’ˆç±»å‹</th>
<th>æŒ‡é’ˆå¯¹è±¡ï¼ˆè‡ªèº«ï¼‰ç¦»å¼€ä½œç”¨åŸŸæ˜¯å¦ç«‹åˆ»ææ„ï¼Ÿ</th>
<th>èµ„æºæ˜¯å¦ä¸€å®šè¢«é‡Šæ”¾ï¼Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>unique_ptr</code></td>
<td>âœ… æ˜¯ï¼Œç«‹åˆ»ææ„</td>
<td>âœ… æ˜¯ï¼Œç«‹å³é‡Šæ”¾èµ„æº</td>
</tr>
<tr>
<td><code>shared_ptr</code></td>
<td>âœ… æ˜¯ï¼Œç«‹åˆ»ææ„</td>
<td>âš ï¸ ä»…å½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶é‡Šæ”¾èµ„æº</td>
</tr>
<tr>
<td><code>weak_ptr</code></td>
<td>âœ… æ˜¯ï¼Œç«‹åˆ»ææ„</td>
<td>âŒ å¦ï¼Œä¸å½±å“èµ„æºæ˜¯å¦é‡Šæ”¾ï¼ˆä¸æ‹¥æœ‰èµ„æºï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="-unique_ptr">ğŸ”¹ <code>unique_ptr</code></h3>
<ul>
<li><strong>æ‹¥æœ‰å”¯ä¸€èµ„æº</strong>ï¼Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼š
<ul>
<li>æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æœ¬èº«è¢«ææ„ âœ…</li>
<li>æ‰€ç®¡ç†çš„èµ„æºä¹Ÿç«‹å³ <code>delete</code> âœ…</li>
</ul>
</li>
</ul>
<pre><code class="language-cpp">{
    std::unique_ptr&lt;int&gt; up = std::make_unique&lt;int&gt;(10);
} // up è¢«é”€æ¯ï¼Œå¯¹è±¡ç«‹å³é‡Šæ”¾
</code></pre>
<hr>
<h3 id="-shared_ptr">ğŸ”¹ <code>shared_ptr</code></h3>
<ul>
<li><strong>æ‹¥æœ‰å…±äº«èµ„æº</strong>ï¼Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼š
<ul>
<li>æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æœ¬èº«ææ„ âœ…</li>
<li>èµ„æºåªæœ‰åœ¨æ‰€æœ‰ <code>shared_ptr</code> éƒ½é”€æ¯ï¼ˆå¼•ç”¨è®¡æ•° = 0ï¼‰æ—¶æ‰è¢«é‡Šæ”¾ âš ï¸</li>
</ul>
</li>
</ul>
<pre><code class="language-cpp">{
    std::shared_ptr&lt;int&gt; sp1 = std::make_shared&lt;int&gt;(20);
    {
        std::shared_ptr&lt;int&gt; sp2 = sp1; // use_count = 2
    } // sp2 ææ„ï¼Œä½†èµ„æºè¿˜æ²¡é‡Šæ”¾
} // sp1 ææ„ï¼Œuse_count = 0ï¼Œèµ„æºé‡Šæ”¾
</code></pre>
<hr>
<h3 id="-weak_ptr">ğŸ”¹ <code>weak_ptr</code></h3>
<ul>
<li><strong>ä¸æ‹¥æœ‰èµ„æº</strong>ï¼Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼š
<ul>
<li><code>weak_ptr</code> å¯¹è±¡ç«‹åˆ»ææ„ âœ…</li>
<li>å®ƒè§‚å¯Ÿçš„èµ„æºä¸ä¼šå—å½±å“ âŒ</li>
</ul>
</li>
</ul>
<pre><code class="language-cpp">{
    std::weak_ptr&lt;int&gt; wp;
    {
        std::shared_ptr&lt;int&gt; sp = std::make_shared&lt;int&gt;(30);
        wp = sp;
    } // sp ææ„ï¼Œèµ„æºé‡Šæ”¾
} // wp ææ„ï¼Œä½†æ²¡å½±å“èµ„æºé‡Šæ”¾æ—¶æœº
</code></pre>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ C++ ç¤ºä¾‹ç¨‹åºï¼Œ<strong>æ¸…æ™°æ¼”ç¤ºäº† <code>shared_ptr</code>ã€<code>weak_ptr</code> å’Œ <code>unique_ptr</code> åœ¨ä½•æ—¶è¢«é”€æ¯</strong>ï¼ˆå¯¹è±¡ææ„ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„ç±»ï¼Œæ‰“å°æ„é€ ä¸ææ„ï¼Œä»¥ä¾¿è§‚å¯ŸæŒ‡é’ˆä½•æ—¶é‡Šæ”¾èµ„æºï¼š</p>
<hr>
<h3 id="-ç¤ºä¾‹ä»£ç å«æ³¨é‡Š">âœ… ç¤ºä¾‹ä»£ç ï¼ˆå«æ³¨é‡Šï¼‰ï¼š</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;memory&gt;

class MyClass {
public:
    MyClass(int val) : value(val) {
        std::cout &lt;&lt; "MyClass(" &lt;&lt; value &lt;&lt; ") constructed.\n";
    }
    ~MyClass() {
        std::cout &lt;&lt; "MyClass(" &lt;&lt; value &lt;&lt; ") destructed.\n";
    }

private:
    int value;
};

void demo_shared_ptr() {
    std::cout &lt;&lt; "\n[shared_ptr demo]\n";
    std::shared_ptr&lt;MyClass&gt; sp1 = std::make_shared&lt;MyClass&gt;(1);
    {
        std::shared_ptr&lt;MyClass&gt; sp2 = sp1;
        std::cout &lt;&lt; "shared_ptr use_count: " &lt;&lt; sp1.use_count() &lt;&lt; "\n";
    } // sp2 ç¦»å¼€ä½œç”¨åŸŸï¼Œuse_count å‡ 1
    std::cout &lt;&lt; "shared_ptr use_count: " &lt;&lt; sp1.use_count() &lt;&lt; "\n";
} // sp1 ç¦»å¼€ä½œç”¨åŸŸï¼Œå¯¹è±¡ææ„

void demo_weak_ptr() {
    std::cout &lt;&lt; "\n[weak_ptr demo]\n";
    std::weak_ptr&lt;MyClass&gt; wp;
    {
        std::shared_ptr&lt;MyClass&gt; sp = std::make_shared&lt;MyClass&gt;(2);
        wp = sp;
        std::cout &lt;&lt; "Inside scope, expired? " &lt;&lt; std::boolalpha &lt;&lt; wp.expired() &lt;&lt; "\n";
    } // sp è¢«é”€æ¯ï¼Œèµ„æºè¢«é‡Šæ”¾
    std::cout &lt;&lt; "Outside scope, expired? " &lt;&lt; std::boolalpha &lt;&lt; wp.expired() &lt;&lt; "\n";
    if (auto locked = wp.lock()) {
        std::cout &lt;&lt; "locked shared_ptr is valid\n";
    } else {
        std::cout &lt;&lt; "locked shared_ptr is null\n";
    }
}

void demo_unique_ptr() {
    std::cout &lt;&lt; "\n[unique_ptr demo]\n";;

    std::unique_ptr&lt;MyClass&gt; up1 = std::make_unique&lt;MyClass&gt;(3);
    std::cout &lt;&lt; "up1 owns the resource\n";

    // std::unique_ptr&lt;MyClass&gt; up2 = up1; // âŒ é”™è¯¯ï¼šä¸èƒ½æ‹·è´
    std::unique_ptr&lt;MyClass&gt; up2 = std::move(up1); // âœ… ç§»åŠ¨æ‰€æœ‰æƒ

    if (!up1) {
        std::cout &lt;&lt; "up1 is now null after move\n";
    }
    if (up2) {
        std::cout &lt;&lt; "up2 owns the resource after move\n";
    }

    // ç”¨ reset() é‡Šæ”¾å½“å‰å¯¹è±¡
    up2.reset();  // è°ƒç”¨ææ„å‡½æ•°ï¼Œé‡Šæ”¾ MyClass(3)
    std::cout &lt;&lt; "up2.reset() called, resource released\n";

    // ç”¨ reset(new T) æ›¿æ¢ä¸ºæ–°çš„å¯¹è±¡
    up2.reset(new MyClass(4));
    std::cout &lt;&lt; "up2 now owns a new object\n";

    // ç¦»å¼€ä½œç”¨åŸŸåï¼Œup2 è‡ªåŠ¨é‡Šæ”¾æ–°å¯¹è±¡ MyClass(4)
}


int main() {
    demo_shared_ptr();
    demo_weak_ptr();
    demo_unique_ptr();
    std::cout &lt;&lt; "\n[Program End]\n";
    return 0;
}

</code></pre>
<hr>
<h3 id="-è¾“å‡ºç¤ºä¾‹è¯´æ˜èµ„æºé‡Šæ”¾æ—¶æœº">ğŸ§¾ è¾“å‡ºç¤ºä¾‹ï¼ˆè¯´æ˜èµ„æºé‡Šæ”¾æ—¶æœºï¼‰ï¼š</h3>
<pre><code class="language-text">[shared_ptr demo]
MyClass(1) constructed.
shared_ptr use_count: 2
shared_ptr use_count: 1
MyClass(1) destructed.

[weak_ptr demo]
MyClass(2) constructed.
Inside scope, expired? false
MyClass(2) destructed.
Outside scope, expired? true
locked shared_ptr is null

[unique_ptr demo with move and reset]
MyClass(3) constructed.
up1 owns the resource
up1 is now null after move
up2 owns the resource after move
MyClass(3) destructed.
up2.reset() called, resource released
MyClass(4) constructed.
up2 now owns a new object
MyClass(4) destructed.

[Program End]
</code></pre>
<hr>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li><strong><code>std::unique_ptr</code></strong>ï¼šé€‚ç”¨äºå•ä¸€æ‰€æœ‰æƒçš„æƒ…å†µï¼Œæ˜¯æœ€è½»é‡çº§çš„é€‰æ‹©ï¼Œæ€§èƒ½æœ€ä¼˜ã€‚</li>
<li><strong><code>std::shared_ptr</code></strong>ï¼šé€‚ç”¨äºéœ€è¦å¤šä¸ªæŒ‡é’ˆå…±äº«åŒä¸€èµ„æºçš„åœºæ™¯ï¼Œä½†è¦æ³¨æ„æ½œåœ¨çš„æ€§èƒ½å¼€é”€å’Œå¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</li>
<li><strong><code>std::weak_ptr</code></strong>ï¼šé€šå¸¸ä¸ <code>std::shared_ptr</code> ç»“åˆä½¿ç”¨ï¼Œç”¨æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œæˆ–è€…ä»…ä½œä¸ºä¸´æ—¶å¼•ç”¨è€Œä¸å½±å“å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>

</div>
<div id="MySignature" role="contentinfo">
    <p>æœªç»ä½œè€…åŒæ„è¯·å‹¿è½¬è½½</p>
<p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ä½œè€…ï¼š<a href="https://www.cnblogs.com/aslanvon/" target="_blank">aixueforever</a>ï¼ŒåŸæ–‡é“¾æ¥ï¼š<a href="https://www.cnblogs.com/aslanvon/p/18928233" target="_blank">https://www.cnblogs.com/aslanvon/p/18928233</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-06-14 13:27">2025-06-14 13:27</span>&nbsp;
<a href="https://www.cnblogs.com/aslanvon">aixueforever</a>&nbsp;
é˜…è¯»(<span id="post_view_count">44</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18928233);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18928233', targetLink: 'https://www.cnblogs.com/aslanvon/p/18928233', title: 'æ™ºèƒ½æŒ‡é’ˆ' })">ä¸¾æŠ¥</a>
</div>
        