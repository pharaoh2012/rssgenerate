
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/data-analytics/p/18870557" title="å‘å¸ƒäº 2025-05-11 10:10">
    <span role="heading" aria-level="2">ã€SQL å‘¨å‘¨ç»ƒã€‘çˆ¬å–çŸ­è§†é¢‘å‘ç°æ•°æ®ç¼ºå¤±ï¼Œå¦‚ä½•ç”¨ SQL å¡«å……</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250511100814771-2074239221.png" alt="ã€SQL å‘¨å‘¨ç»ƒã€‘çˆ¬å–çŸ­è§†é¢‘å‘ç°æ•°æ®ç¼ºå¤±ï¼Œå¦‚ä½•ç”¨ SQL å¡«å……" class="desc_img">
        çˆ¬è™«çˆ¬å–æŠ–éŸ³å’Œå¿«æ‰‹çš„çŸ­è§†é¢‘æ•°æ®æ—¶ï¼Œå¦‚æœé‡åˆ°æ•°æ®ç¼ºå¤±çš„æƒ…å†µï¼Œå¦‚ä½•ä½¿ç”¨ SQL è¯­å¥å®Œæˆæ•°æ®çš„è¡¥å…¨ â€”â€” å‰å‘å¡«å……ã€åå‘å¡«å……ã€å¹³å‡æ•°å¡«å……ã€åˆ†ä½æ•°å¡«å……
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯â€œè’‹ç‚¹æ•°åˆ†â€ï¼Œå¤šå¹´ä»¥æ¥ä¸€ç›´ä»äº‹æ•°æ®åˆ†æå·¥ä½œã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œä¸å¤§å®¶æŒç»­åˆ†äº«å…³äºæ•°æ®åˆ†æçš„å­¦ä¹ å†…å®¹ã€‚</p>
<p>æœ¬æ–‡æ˜¯ç¬¬ 5 ç¯‡ï¼Œä¹Ÿæ˜¯ã€SQL å‘¨å‘¨ç»ƒã€‘ç³»åˆ—çš„ç¬¬ 4 ç¯‡ã€‚è¯¥ç³»åˆ—æ˜¯æŒ‘é€‰æˆ–è‡ªåˆ›å…·æœ‰ä¸€äº›éš¾åº¦çš„ SQL é¢˜ç›®ï¼Œä¸€å‘¨è‡³å°‘æ›´æ–°ä¸€ç¯‡ã€‚åç»­åˆ›ä½œçš„å†…å®¹ï¼Œåˆæ­¥è§„åˆ’çš„æ–¹å‘åŒ…æ‹¬ï¼š</p>
<h2 id="åç»­å†…å®¹è§„åˆ’">åç»­å†…å®¹è§„åˆ’</h2>
<p>1.åˆ©ç”¨ <strong>Streamlit</strong> å®ç° <code>Hive å…ƒæ•°æ®å±•ç¤º</code>ã€<code>SQL ç¼–è¾‘å™¨</code>ã€ ç»“åˆ<code>Docker æ²™ç®±å®ç°æ•°æ®åˆ†æ Agent</code><br>
2.æ—¶é—´åºåˆ—å¼‚å¸¸è¯†åˆ«ã€å¼‚åŠ¨å½’å› ç®—æ³•<br>
3.ç•™å­˜ç‡æ‹Ÿåˆã€é¢„æµ‹ã€å»ºæ¨¡<br>
4.å­¦ä¹  <code>AB å®éªŒ</code>ã€å¤æ‚å®éªŒè®¾è®¡ç­‰<br>
5.<code>è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ </code>ã€è‡ªåŠ¨åŒ–ç‰¹å¾å·¥ç¨‹<br>
6.<code>å› æœæ¨æ–­</code>å­¦ä¹ <br>
7. â€¦â€¦</p>
<p><strong>æ¬¢è¿å…³æ³¨</strong>ï¼Œä¸€èµ·å­¦ä¹ ã€‚</p>
<h2 id="ç¬¬-4-æœŸé¢˜ç›®">ç¬¬ 4 æœŸé¢˜ç›®</h2>
<p>é¢˜ç›®æ¥æºï¼šè‡ªåˆ›é¢˜ç›®ï¼Œæ›¾ç»åœ¨å·¥ä½œä¸­é‡åˆ°è¿‡è¯¥é—®é¢˜</p>
<h3 id="ä¸€é¢˜ç›®ä»‹ç»">ä¸€ã€é¢˜ç›®ä»‹ç»</h3>
<p>å…¬å¸å¸‚åœºéƒ¨æ‰¾åˆ°ä¸€äº›è¾¾äººåœ¨æŠ–éŸ³ã€å¿«æ‰‹ç­‰å¹³å°è¿›è¡ŒçŸ­è§†é¢‘è¥é”€ï¼Œéœ€è¦ç›‘æµ‹è§†é¢‘çš„ç‚¹èµé‡ã€‚å…¬å¸å†…æœ‰ä¸€ä½ä¸“èŒçš„çˆ¬è™«å·¥ç¨‹å¸ˆï¼Œä»–çš„é¡¹ç›®ä¹Ÿå¾ˆå¤šã€‚å› æ­¤å¾ˆéš¾å¯¹è¯¥é¡¹ç›®çˆ¬è™«æ•°æ®æä¾›é«˜è´¨é‡çš„ç»´æŠ¤ï¼Œä¼šå‡ºç°ä¸€äº›å­—æ®µç¼ºå¤±çš„æƒ…å†µã€‚</p>
<p>æˆ‘ä»¬å°†é—®é¢˜ç®€åŒ–ï¼Œæœ‰ä¸€å¼ è¡¨è®°å½•äº†çˆ¬è™«æŠ“å–çš„çŸ­è§†é¢‘ç‚¹èµé‡æ•°æ®ï¼Œå…¶ä¸­éƒ¨åˆ†æ—¥æœŸçš„ç‚¹èµé‡æ˜¯ç¼ºå¤±çš„ã€‚è¯·ä½ åˆ©ç”¨ SQL å°†è¿™äº›æ•°æ®è¡¥é½ï¼Œå³â€œæ’å€¼â€ã€‚</p>
<table>
<thead>
<tr>
<th>åˆ—å</th>
<th>æ•°æ®ç±»å‹</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>video_id</td>
<td>string</td>
<td>çŸ­è§†é¢‘id</td>
</tr>
<tr>
<td>dt</td>
<td>string</td>
<td>æ—¥æœŸ</td>
</tr>
<tr>
<td>likes_num</td>
<td>int</td>
<td>ç‚¹èµé‡ï¼ˆç”¨æ¥å¯¹æ¯”ç»“æœï¼Œä¸è¦ç›´æ¥ç”¨ï¼‰</td>
</tr>
<tr>
<td>show_likes_num</td>
<td>int</td>
<td>å±•ç¤ºç‚¹èµé‡ï¼ˆç”¨æ¥è¡¥å…¨æ•°æ®ï¼‰</td>
</tr>
</tbody>
</table>
<p>ç”¨ SQL å®ç°å‡ ç§æ¯”è¾ƒç®€å•çš„æ’å€¼æ–¹æ³•ï¼Œå¤æ‚çš„æ–¹æ³•å¯ä»¥åˆ©ç”¨ <code>Hive</code> ä¸­çš„ <code>transform</code> å‡½æ•°è°ƒç”¨ <code>Python</code> è„šæœ¬æ¥å®ç°ï¼ˆåé¢å“ªæœŸä¼šæ ¹æ®è¿™ä¸ªç‚¹æ°´ä¸€ç¯‡æ–‡ç« ï¼‰</p>
<p>æœ¬æ–‡å®ç°çš„ç®€å•è¡¥å…¨æ–¹æ³•æœ‰ï¼š</p>
<p>1.å‰å‘å¡«å……ï¼Œä½¿ç”¨å‰é¢æœ€è¿‘çš„ä¸€ä¸ªéç©ºå€¼æ¥å¡«å……<br>
2.åå‘å¡«å……ï¼Œä½¿ç”¨åé¢æœ€è¿‘çš„ä¸€ä¸ªéç©ºå€¼æ¥å¡«å……<br>
3.ç›¸é‚»çš„å¹³å‡æ•°å¡«å……ï¼Œä½¿ç”¨å‰åæœ€è¿‘çš„éç©ºå€¼ï¼Œå–ä¸¤ä¸ªæ•°çš„å¹³å‡æ•°å¡«å……<br>
4.ç›¸é‚»çš„åˆ†ä½æ•°å¡«å……ï¼Œä½¿ç”¨å‰åæœ€è¿‘çš„éç©ºå€¼ï¼Œç¼ºå¤±å€¼æ ¹æ®åˆ†ä½æ•°æ¥å¡«å……</p>
<p>é¢å¤–è¯´æ˜ï¼šè¿™å››ç§æ–¹æ³•éƒ½ä¾èµ–äºç¼ºå¤±å€¼é‚»è¿‘çš„å‰åéç©ºå€¼ï¼Œéœ€è¦å­˜åœ¨è¿™æ ·çš„éç©ºå€¼ã€‚<br>
å¦‚æœè¯¥éç©ºå€¼ä¸å­˜åœ¨ï¼Œæ¯”å¦‚çŸ­è§†é¢‘ç¬¬ä¸€å¤©å‘å¸ƒå°±æ²¡æœ‰çˆ¬å–åˆ°ç‚¹èµé‡ â€”â€” è¿™æ ·æ²¡æœ‰åŠæ³•ï¼Œæ‰¾åˆ°å®ƒä¹‹å‰çš„éç©ºç‚¹èµé‡ã€‚æˆ‘æœ¬æ–‡çš„å¤„ç†æ–¹æ³•æ˜¯å°†å®ƒâ€œè§†ä¸ºâ€å‰ä¸€å¤©å‘å¸ƒï¼Œæˆ–è€…è¯´å¢åŠ ä¸€ä¸ªå‰ä¸€æ¡ç‚¹èµé‡ä¸ºé›¶çš„æ•°æ®ï¼ˆè¿˜æœ‰å…¶ä»–çš„å¤„ç†æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œåªæå‡ºä¸€ç§ï¼‰ã€‚</p>
<p>è¿™æ¡å¢åŠ çš„æ•°æ®ä¸éœ€è¦æ˜¾å¼å­˜åœ¨ï¼Œåªä¸è¿‡æ˜¯åœ¨æ•°æ®å¤„ç†æ—¶å…œåº•çš„é€»è¾‘ç­‰æ•ˆäºå®ƒã€‚è€Œå¦‚æœçŸ­è§†é¢‘ç¼ºå°‘çš„æ˜¯æœ€åå‡ å¤©çš„æ•°æ®ï¼Œæ¯”å¦‚æŸä¸€å¤©å¼€å§‹åé¢ä¸€ç›´ç¼ºå¤±æ•°æ®ï¼Œè¿™æ ·å°±å°†æœ€åä¸€ä¸ªæœ‰æ•°æ®çš„ç‚¹èµé‡â€œé¡ºå»¶â€ä¸‹å»ã€‚è¿™ 4 ç§å¡«å……æ–¹æ³•ï¼Œéƒ½ç”¨è¿™æ ·çš„é€»è¾‘å…œåº•ã€‚</p>
<h3 id="äºŒé¢˜ç›®æ€è·¯">äºŒã€é¢˜ç›®æ€è·¯</h3>
<p>æƒ³è¦ç­”é¢˜çš„åŒå­¦ï¼Œå¯ä»¥å…ˆæ€è€ƒç­”æ¡ˆğŸ¤”ã€‚<br>
.â€¦â€¦</p>
<p>.â€¦â€¦</p>
<p>.â€¦â€¦</p>
<p>æˆ‘æ¥è°ˆè°ˆæˆ‘çš„æ€è·¯ï¼š<br>
1.å‰å‘å¡«å……ï¼Œä½¿ç”¨å‰é¢æœ€è¿‘çš„éç©ºå€¼æ¥å¡«å……ã€‚ä½¿ç”¨ <code>last_value</code> çª—å£å‡½æ•°æ¥å®ç°ï¼Œæ³¨æ„ <code>last_value</code> æ”¯æŒä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º <code>true</code> åˆ™åœ¨å¯»æ‰¾çš„æ—¶å€™è·³è¿‡ <code>null</code>ï¼›æ³¨æ„ <code>rows</code> çš„èŒƒå›´ï¼Œå¦å¤–å¦‚æœå‰é¢å®åœ¨æ‰¾ä¸åˆ°é <code>null</code> å€¼ï¼Œç”¨ <code>0</code> æ¥å…œåº•ã€‚</p>
<p>2.åå‘å¡«å……ï¼Œä½¿ç”¨åé¢æœ€è¿‘çš„éç©ºå€¼æ¥å¡«å……ã€‚ä½¿ç”¨ <code>first_value</code> çª—å£å‡½æ•°æ¥å®ç°ï¼ŒåŒæ · <code>first_value</code> ä¹Ÿæ˜¯æ”¯æŒä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º <code>true</code> åˆ™åœ¨å¯»æ‰¾çš„æ—¶å€™è·³è¿‡ <code>null</code>ï¼›è¿™ä¸ª <code>rows</code> çš„èŒƒå›´æ›´è¦æ³¨æ„ã€‚å¦‚æœåé¢å®åœ¨æ‰¾ä¸åˆ°é <code>null</code> å€¼ï¼Œç”¨å‰ä¸€ä¸ªé <code>null</code> å€¼å…œåº•ã€‚æ‰€ä»¥è¿™é‡Œè¦åŒæ—¶å¾€å‰å¾€åæŸ¥æ‰¾ã€‚</p>
<p>3.ç›¸é‚»çš„å¹³å‡æ•°å¡«å……ï¼Œèåˆäº†å‰ä¸¤ç§æ–¹æ³•ï¼Œå‰å‘å’Œåå‘æ•°æ®éƒ½è¦å¯»æ‰¾ï¼Œæ‰¾åˆ°åæ±‚å¹³å‡å€¼ï¼Œè¿™é‡Œè¦æ›´åŠ å°å¿ƒçš„å¤„ç†æ‰¾ä¸åˆ°çš„æƒ…å†µã€‚</p>
<p>4.ç›¸é‚»çš„åˆ†ä½æ•°å¡«å……ï¼Œæ˜¯ä¸Šä¸€ç§æ–¹æ³•çš„æ”¹è¿›ã€‚æ¯”å¦‚ 2 ä¸ªæœ‰æ•ˆçš„ç‚¹èµé‡ä¸­é—´ç¼ºå°‘äº† 3 å¤©çš„æ•°æ®ï¼Œå¦‚æœè¿™ 3 å¤©çš„æ•°æ®éƒ½ç”¨è¿™ 2 ä¸ªæœ‰æ•ˆå€¼çš„å¹³å‡å€¼æ¥å¡«å……ï¼Œåˆ™ç›¸å½“äºè¿™å‡ å¤©çš„ç‚¹èµæ•°æ²¡æœ‰å˜åŒ–ï¼Œè¿™é€»è¾‘ä¸å¤ªç°å®ã€‚</p>
<p>é‡‡ç”¨åˆ†ä½æ•°çš„æ–¹æ³•ä¿æŒçº¿æ€§å¢é•¿çš„å…³ç³»å»å¡«å……ï¼Œæ¯”ä¸Šä¸€ç§æ–¹æ³•æ›´å¥½ã€‚æ³¨æ„å¦‚æœçœŸçš„æ˜¯è¿™ 2 ä¸ªæœ‰æ•ˆç‚¹èµé‡æ•°æ®ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯å‡è®¾è¿™å‡ å¤©ç‚¹èµé‡æ•°æ®åœæ­¢å˜åŒ–ã€‚å¹³å‡æ•°å’Œåˆ†ä½æ•°å¡«å……ï¼Œè®¡ç®—çš„ç»“æœæ˜¯èƒ½â€œå…¼å®¹â€è¿™ç§æƒ…å†µã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ç”¨ <code>NumPy</code> å’Œ <code>Scipy</code> ç”Ÿæˆæ¨¡æ‹Ÿçš„æ•°æ®é›†ï¼š</p>
<h3 id="ä¸‰ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®">ä¸‰ã€ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</h3>
<p>åªå…³å¿ƒ SQL ä»£ç çš„åŒå­¦ï¼Œå¯ä»¥è·³è½¬åˆ°ç¬¬å››èŠ‚ï¼ˆæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨ <code>Hive</code> è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨ <code>Hive</code> çš„è¯­æ³•ï¼‰</p>
<p>æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®šä¹‰æ¨¡æ‹Ÿé€»è¾‘éœ€è¦çš„<code>å¸¸é‡</code>ï¼Œå®šä¹‰éšæœºæ•°å‘ç”Ÿå™¨ï¼š</li>
</ol>
<pre><code class="language-python">import numpy as np
from scipy import stats
import pandas as pd
import datetime

SEED = 2025
rng = np.random.default_rng(SEED)

# å¼€å§‹æ—¥æœŸ
START_DATETIME = datetime.datetime(2025, 5, 1)
# çŸ­è§†é¢‘æ•°é‡
VIDEO_NUM = 100
# ä¸€èˆ¬æœ€é«˜ç‚¹èµé‡
GENERAL_HIGHEST_LIKES_NUM = 1_000_000
# ä¸€èˆ¬æœ€ä½ç‚¹èµé‡
GENERAL_LOWEST_LIKES_NUM = 1
</code></pre>
<ol start="2">
<li>ä½¿ç”¨ <code>Gompertz</code> å‡½æ•°æ¨¡æ‹ŸçŸ­è§†é¢‘ç‚¹èµé‡æ¯æ—¥å˜åŒ–ã€‚å¤§å®¶ä¸€èˆ¬éƒ½çŸ¥é“ç”¨ <code>S å‹æ›²çº¿</code>æ¨¡æ‹Ÿè¿™ç±»å¢é•¿ä½†æœ‰ä¸Šé™çš„æ•°æ®ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ <code>Logistic</code> å‡½æ•°ã€‚æˆ‘è¿™é‡Œç”¨ <code>Gompertz</code> å‡½æ•°çº¯ç²¹æ˜¯ä»¥å‰æ²¡ç”¨è¿‡ï¼Œå°å°é²œã€‚å·¥ä½œä¸­è‚¯å®šæ˜¯ç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æ‹Ÿåˆæ•ˆæœæ¥å¯¹æ¯”ã€‚ç½‘ä¸Šèƒ½æœåˆ°å¤§é‡æ–‡ç« ä»æ•°å­¦è§’åº¦å¯¹ä¸¤è€…è¿›è¡Œå¯¹æ¯”ã€‚æˆ‘è¿™é‡Œå·æ‡’å°±ä¸ç ”ç©¶äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæœç´¢ï¼š</li>
</ol>
<pre><code class="language-python"># å‚è€ƒæ­£æ€åˆ†å¸ƒ 3-sigmaï¼Œè½¬æ¢åˆ°å¯¹æ•°æ­£æ€åˆ†å¸ƒçš„èŒƒå›´
sigma = np.log(GENERAL_HIGHEST_LIKES_NUM / GENERAL_LOWEST_LIKES_NUM) / 6

# å¦‚æœåœ¨ JupyterLab ä¸­åˆ†ä¸ºä¸åŒå•å…ƒæ ¼æ‰§è¡Œï¼Œ
# å¿…é¡»é‡ç½®éšæœºæ•°ç”Ÿæˆå™¨ï¼Œå¦åˆ™ä¸èƒ½å¤ç°åŒæ ·ç»“æœ
# rng = np.random.default_rng(SEED)
K_arr = stats.lognorm.rvs(
    s=sigma,
    loc=0,
    scale=np.sqrt(GENERAL_HIGHEST_LIKES_NUM * GENERAL_LOWEST_LIKES_NUM),
    size=VIDEO_NUM,
    random_state=rng,
)
K_arr = np.round(K_arr, 0)

# å‚æ•° a éšæœºç”Ÿæˆ
a_arr = rng.uniform(low=0.85, high=0.95, size=VIDEO_NUM)
# å‚æ•° b éšæœºç”Ÿæˆ
b_arr = rng.uniform(low=0.75, high=0.85, size=VIDEO_NUM)
# å‚æ•° t0 éšæœºç”Ÿæˆ
t0_arr = rng.choice([7,8,9,10,11,12], size=VIDEO_NUM, replace=True, p=[0.05,0.1,0.25,0.35,0.2,0.05])

# å®šä¹‰ Gompertz å‡½æ•°ï¼Œä¸ºä»€ä¹ˆä¸é€‰å¸¸è§çš„ Logistic å‡½æ•°
# çº¯ç²¹ä¸ºäº†å¤šå°è¯•å°è¯•ä»¥å‰æ²¡ç©è¿‡çš„
def gompertz_func(t, K=100000, a=0.9, b=0.8, t0=10):
    return K * np.power(a, np.power(b, t-t0))
</code></pre>
<p><code>Gompertz</code> å‡½æ•°å…¶ä¸­çš„ <span class="math inline">\(K\)</span> ä»£è¡¨æé™å€¼ï¼Œåœ¨æˆ‘æ¨¡æ‹Ÿçš„åœºæ™¯å°±æ˜¯å„ä¸ªçŸ­è§†é¢‘ç‚¹èµçš„ä¸Šé™ã€‚å› æ­¤æˆ‘é‡‡ç”¨å¯¹æ•°æ­£æ€åˆ†å¸ƒæ¨¡æ‹Ÿè¿™ä¸ª <span class="math inline">\(K\)</span>ï¼Œæˆ‘åœ¨ç¬¬ 1 èŠ‚çš„ä»£ç ä¸­å®šä¹‰äº†ä¸€èˆ¬æœ€é«˜/ä½çš„ç‚¹èµé‡ï¼Œå…¶å®å°±æ˜¯å€Ÿé‰´æ­£æ€åˆ†å¸ƒçš„ 3-sigma æ–¹æ³•ã€‚åªä¸è¿‡ <span class="math inline">\(\ln(x)\)</span> æœä»æ­£æ€åˆ†å¸ƒï¼Œå– <span class="math inline">\([\mu - 3\sigma, \mu + 3\sigma]\)</span> ï¼›é‚£ä¹ˆ <span class="math inline">\(x\)</span> å°±åº”è¯¥å– <span class="math inline">\([e^{\mu-3\sigma}, e^{\mu+3\sigma}]\)</span>ï¼Œæˆ‘ä»¬å°†å…¶åˆ†åˆ«è®°ä¸º <span class="math inline">\(a\)</span> å’Œ <span class="math inline">\(b\)</span>ï¼Œåˆ™ <span class="math inline">\(\sigma = \frac{\ln{b} - \ln{a}}{6}\)</span>ï¼Œè€Œ <span class="math inline">\(\mu = \frac{\ln{a} + \ln{b}}{2}\)</span>ã€‚</p>
<p>åœ¨ <code>scipy.stats.lognorm</code> ä¸­ï¼Œ<code>s</code> æ˜¯å½¢çŠ¶å‚æ•°ï¼Œå¯¹åº”æ­£æ€åˆ†å¸ƒçš„æ ‡å‡†å·® <span class="math inline">\(\sigma\)</span>ã€‚<code>scale</code> æ˜¯å°ºåº¦å‚æ•°ï¼Œå¯¹åº”æ­£æ€åˆ†å¸ƒçš„æŒ‡æ•°å‡å€¼ <span class="math inline">\(e^{\mu}\)</span>ã€‚æ ¹æ®ä¸Šé¢çš„æ¨å¯¼ç»“æœã€‚<span class="math inline">\(\text{s} = \frac{\ln{b}-\ln{a}}{6}\)</span>ï¼Œ<span class="math inline">\(\text{scale} = \sqrt{ab}\)</span>ã€‚è¿™å°±æ˜¯æˆ‘ä»£ç ä¸­å¯¹æ•°æ­£æ€åˆ†å¸ƒå‚æ•°åˆ¶å®šçš„é€»è¾‘ã€‚</p>
<p>æ ¹æ® <code>Gompertz</code> å‡½æ•°çš„å®šä¹‰ï¼Œå‚æ•° <span class="math inline">\(a\)</span> å’Œ <span class="math inline">\(b\)</span> éƒ½æ˜¯åœ¨ <span class="math inline">\((0, 1)\)</span> ä¹‹é—´ï¼Œæˆ‘è‡ªå·±æ‰‹åŠ¨æµ‹è¯•ç»˜å›¾ï¼Œè§‰å¾— <span class="math inline">\(a\)</span> åœ¨ 0.9 é™„è¿‘ï¼Œ<span class="math inline">\(b\)</span> åœ¨ 0.8 é™„è¿‘ï¼Œå‡½æ•°å½¢çŠ¶æ¯”è¾ƒé è°±ã€‚å®é™…å·¥ä½œä¸­ï¼Œæ˜¯åº”è¯¥ç”¨æ•°æ®æ¥æ‹Ÿåˆå»æ¨ç®—å‚æ•°çš„å–å€¼</p>
<ol start="3">
<li>å®šä¹‰éšæœºç¼ºå¤±æ•°æ®çš„æ ‡è¯†ï¼Œæ³¨æ„ç‚¹èµé‡æ˜¯æ•´æ•°ï¼Œå››èˆäº”å…¥åè½¬ä¸ºæ•´æ•°ã€‚å°†å‰é¢ç”Ÿæˆçš„æ•°æ®è½¬ä¸º <code>pd.DataFrame</code>ï¼Œå¹¶è¾“å‡ºä¸º <code>csv</code> æ–‡ä»¶ï¼š</li>
</ol>
<pre><code class="language-python">days = np.arange(1, 31)

# å®šä¹‰éšæœºç¼ºå¤±ï¼›1 - è¡¨ç¤ºç¼ºå¤±æ•°æ®
random_missing_flag = rng.choice([0, 1], size=VIDEO_NUM * len(days), p=[0.7, 0.3])

video_data = { 'video_id': [], 'dt': [], 'likes_num': [], 'random_miss': random_missing_flag}

for i, (k, a, b, t0) in enumerate(zip(K_arr, a_arr, b_arr, t0_arr)):
    # è§†é¢‘ id æ•°å­—éƒ¨åˆ†ä¸ä½äº 3 ä½ï¼Œè¡¥é›¶
    video_data['video_id'].extend([f'video_{i:03}']*len(days))
    video_data['dt'].extend(days)
    video_data['likes_num'].extend(gompertz_func(days, k, a, b, t0))    

df = pd.DataFrame(video_data)

# å››èˆäº”å…¥å¹¶è½¬ä¸ºæ•´å‹
df['likes_num'] = np.round(df['likes_num'], 0).astype(int)
df['dt'] = df['dt'].apply(lambda d: START_DATETIME + datetime.timedelta(days=(d-1)))
df['show_likes_num'] = df.apply(lambda r: np.nan if r['random_miss'] == 1 else r['likes_num'], axis = 1)
df.drop(['random_miss'], axis=1, inplace=True)

out_csv_path = "dwd_short_videos_likes_num_missing_data_from_crawler.csv"
df.to_csv(out_csv_path, header=False, index=False, encoding='utf-8-sig')
</code></pre>
<ol start="4">
<li>å¦‚æœè¡¨å­˜åœ¨åˆ™åˆ é™¤ï¼Œåˆ›å»ºæ–°çš„ <code>Hive</code> è¡¨ï¼Œå¹¶å°†æ•°æ® <code>load</code> åˆ°è¡¨ä¸­ï¼š</li>
</ol>
<pre><code class="language-python">from pyhive import hive

# é…ç½®è¿æ¥å‚æ•°
host_ip = "127.0.0.1"
port = 10000
username = "è’‹ç‚¹æ•°åˆ†"

with hive.Connection(host=host_ip, port=port) as conn:
    cursor = conn.cursor()
    
    hive_table_name = "data_exercise.dwd_short_videos_likes_num_missing_data_from_crawler"

    drop_table_sql = f"""
    drop table if exists {hive_table_name}
    """

    print(drop_table_sql)
    cursor.execute(drop_table_sql)

    create_table_sql = f"""
    create table if not exists {hive_table_name} (
        video_id string comment "çŸ­è§†é¢‘id",
        dt string comment "æ—¥æœŸ",
        likes_num int comment "ç‚¹èµé‡ï¼ˆç”¨æ¥å¯¹æ¯”ç»“æœï¼‰",
        show_likes_num int comment "å±•ç¤ºç‚¹èµé‡ï¼ˆç”¨æ¥è¡¥å…¨æ•°æ®ï¼‰"
    ) 
    comment "çŸ­è§†é¢‘ç‚¹èµé‡ç¼ºå¤±æ•°æ®ï¼Œç”¨æ¥ç»ƒä¹  SQL è¡¥å…¨æ•°æ® | author: è’‹ç‚¹æ•°åˆ† | æ–‡ç« ç¼–å·ï¼š0a94d809"
    row format delimited fields terminated by ","
    stored as textfile
    """

    print(create_table_sql)
    cursor.execute(create_table_sql)

    import os

    load_data_sql = f"""
    load data local inpath "{os.path.abspath(out_csv_path)}"
    overwrite into table {hive_table_name}
    """

    print(load_data_sql)
    cursor.execute(load_data_sql)

    cursor.close()
</code></pre>
<blockquote>
<p>æˆ‘é€šè¿‡ä½¿ç”¨ <code>PyHive</code> åŒ…å®ç° Python æ“ä½œ <code>Hive</code>ã€‚æˆ‘ä¸ªäººç”µè„‘éƒ¨ç½²äº† <code>Hadoop</code> åŠ <code>Hive</code>ï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯è®¤è¯ï¼Œä¼ä¸šé‡Œä¸€èˆ¬å¸¸ç”¨ <code>Kerberos</code> æ¥è¿›è¡Œå¤§æ•°æ®é›†ç¾¤çš„è®¤è¯ã€‚</p>
</blockquote>
<h3 id="å››sql-è§£ç­”">å››ã€SQL è§£ç­”</h3>
<p>1.å‰å‘å¡«å……çš„ sql è¯­å¥ï¼Œå¦‚æœä½¿ç”¨ <code>last_value</code> åˆ™ <code>rows</code> çš„èŒƒå›´æ˜¯ <code>between unbounded preceding and 1 preceding</code>ã€‚å¦‚æœçœç•¥è¿™éƒ¨åˆ†ï¼Œåªä¿ç•™ <code>order by dt asc</code>ï¼Œåˆ™é»˜è®¤ä¸º <code>between unbounded preceding and current row</code> ä»æœ€ç»ˆæ•ˆæœæ¥è¯´æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å‰è€…å†™æ³•è¡¨è¿°æ›´å‡†ç¡®</p>
<pre><code class="language-sql">with calc_exist_likes_num as (
    select
       video_id, dt, likes_num, show_likes_num
    -- æ‰¾å‰é¢çš„éç©ºç‚¹èµé‡
    -- æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¸º true è¡¨ç¤ºè·³è¿‡ null
    , last_value(show_likes_num, true) over(partition by video_id order by dt asc 
            rows between unbounded preceding and 1 preceding) as last_exist_likes_num
    from data_exercise.dwd_short_videos_likes_num_missing_data_from_crawler
)

select
  video_id, dt, likes_num, show_likes_num
-- nvl åªæ”¯æŒ 2 ä¸ªå‚æ•°ï¼›ä½¿ç”¨ coalesce 
-- æŒ‰ç…§é¡ºåºï¼Œè¿”å›ç¬¬ä¸€ä¸ªé Null çš„å€¼
-- æ ¹æ®æˆ‘å†™çš„å…œåº•é€»è¾‘ï¼Œå¦‚æœå‘å‰å¯»æ‰¾éç©ºæ•°å€¼æ²¡æœ‰ï¼Œåˆ™ç”¨ 0 å…œåº•
, coalesce(show_likes_num, last_exist_likes_num, 0) as forward_fill
from calc_exist_likes_num
</code></pre>
<p>éƒ¨åˆ†ç»“æœéªŒè¯ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250511100937657-1446556077.png" alt="" loading="lazy"></p>
<p>2.åå‘å¡«å……çš„ sql è¯­å¥ï¼Œå¦‚æœä½¿ç”¨ <code>first_value</code> åˆ™ <code>rows</code> çš„èŒƒå›´æ˜¯ <code>between 1 following and unbounded following</code>ã€‚æ³¨æ„ <code>first_value</code> å’Œ <code>last_value</code> éƒ½æ˜¯è·Ÿ <code>order by dt</code> çš„é¡ºåºæœ‰å…³ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ <code>desc</code> é™åºæ¥åˆ‡æ¢å¦ä¸€ä¸ªå‡½æ•°ã€‚</p>
<pre><code class="language-sql">with calc_exist_likes_num as (
    select
       video_id, dt, likes_num, show_likes_num
    -- å‰åé‚»è¿‘çš„ç¬¬ä¸€ä¸ªéç©ºç‚¹èµé‡
    -- æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¸º trueï¼Œè¡¨ç¤ºè·³è¿‡ null
    , last_value(show_likes_num, true) over(partition by video_id order by dt asc
            rows between unbounded preceding and 1 preceding) as last_exist_likes_num
    
    , first_value(show_likes_num, true) over(partition by video_id order by dt asc
        rows between 1 following and unbounded following) as next_exist_likes_num
    from data_exercise.dwd_short_videos_likes_num_missing_data_from_crawler
)

select
  video_id, dt, likes_num, show_likes_num
-- nvl åªæ”¯æŒ 2 ä¸ªå‚æ•°ï¼›ä½¿ç”¨ coalesce 
-- æŒ‰ç…§é¡ºåºï¼Œè¿”å›ç¬¬ä¸€ä¸ªé Null çš„å€¼
-- æ ¹æ®æˆ‘å†™çš„å…œåº•é€»è¾‘ï¼Œå¦‚æœå‘åå¯»æ‰¾éç©ºæ•°å€¼æ²¡æœ‰ï¼Œåˆ™ç”¨å‰é¢çš„ç¬¬ä¸€ä¸ªéç©ºå…œåº•ï¼Œæœ€åç”¨ 0 å…œåº•
, coalesce(show_likes_num, next_exist_likes_num, last_exist_likes_num, 0) as backward_fill
from calc_exist_likes_num
</code></pre>
<p>éƒ¨åˆ†ç»“æœéªŒè¯ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250511100928147-1124110576.png" alt="" loading="lazy"></p>
<p>3.ç›¸é‚»å¹³å‡æ•°å¡«å……çš„ sql è¯­å¥ï¼Œå¯»æ‰¾å‰åç›¸é‚»çš„éç©ºå€¼é€»è¾‘ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚å¯¹å‰åç›¸é‚»çš„éç©ºå€¼æ±‚å¹³å‡ï¼Œæ³¨æ„è¿™é‡Œçš„å…œåº•é€»è¾‘ã€‚é¦–å…ˆä¸Šä¸€ä¸ªéç©ºç‚¹èµé‡å¦‚æœä¸å­˜åœ¨ï¼Œé‚£å°±å¡«å……é›¶ï¼Œå› æ­¤æ±‚å¹³å‡çš„åˆ†æ¯è¿™éƒ¨åˆ†çš„ â€œ1â€ å¿…ç„¶å­˜åœ¨ï¼›å¦‚æœä¸‹ä¸€ä¸ªéç©ºç‚¹èµé‡ä¸å­˜åœ¨ï¼Œå¯ä»¥å°†å…¶å½“æˆé›¶ï¼Œé‚£ä¹ˆåˆ†æ¯æ±‚å¹³å‡æ—¶ï¼Œå®ƒå°±ä¸èµ·ä½œç”¨ï¼Œå®ƒçš„åˆ†æ¯éƒ¨åˆ†æ˜¯ â€œ0â€ï¼›æœ€åç»“æœæ³¨æ„å››èˆäº”å…¥ï¼ˆå¦‚æœå†™æˆæ˜¾å¼çš„åˆ¤æ–­é€»è¾‘ä¹Ÿå¯ä»¥ï¼Œéœ€è¦å¼•å…¥ <code>if</code> æˆ– <code>case when</code> è¯­å¥ï¼‰ã€‚</p>
<p>æ³¨æ„ç»“æœè¦å–æ•´ï¼Œæˆ‘è¿™é‡Œä¸å–æ•´ï¼Œæ˜¯ä¸ºäº†è·Ÿå¤§å®¶å±•ç¤ºç»“æœæ—¶å»åå‘éªŒè¯ï¼š</p>
<pre><code class="language-sql">with calc_exist_likes_num as (
    select
       video_id, dt, likes_num, show_likes_num
    -- å‰åé‚»è¿‘çš„ç¬¬ä¸€ä¸ªéç©ºç‚¹èµé‡
    -- æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¸º trueï¼Œè¡¨ç¤ºè·³è¿‡ null
    , last_value(show_likes_num, true) over(partition by video_id order by dt asc
            rows between unbounded preceding and 1 preceding) as last_exist_likes_num
    
    , first_value(show_likes_num, true) over(partition by video_id order by dt asc
        rows between 1 following and unbounded following) as next_exist_likes_num
    from data_exercise.dwd_short_videos_likes_num_missing_data_from_crawler
)

select
  video_id, dt, likes_num, show_likes_num
-- å¦‚æœä¸€å¼€å§‹çš„æ•°æ®æ²¡æœ‰ï¼Œå°±æŒ‰ç…§é›¶è®¡ç®—ï¼›å› æ­¤â€œä¸Šä¸€ä¸ªç‚¹èµé‡å¿…ç„¶å­˜åœ¨â€
-- å¦‚æœä¸‹ä¸€ä¸ªç‚¹èµé‡ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±æŒ‰ç…§é›¶è®¡ç®—ï¼Œå®é™…å°±ç­‰äºä¸ç®—
-- æ³¨æ„å››èˆäº”å…¥å–æ•´ï¼Œæˆ‘è¿™é‡Œä¸å–æ•´ï¼Œæ˜¯ä¸ºäº†ç»™å¤§å®¶æ›´æ–¹ä¾¿çš„éªŒè¯ç»“æœ
, nvl(show_likes_num,  (nvl(last_exist_likes_num, 0) + nvl(next_exist_likes_num,0)) 
    / (1 + if(next_exist_likes_num is not null, 1, 0))
 ) as half_fill_likes_num
from calc_exist_likes_num
</code></pre>
<p>éƒ¨åˆ†ç»“æœéªŒè¯ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250511100917445-38223862.png" alt="" loading="lazy"></p>
<p>4.ç›¸é‚»åˆ†ä½æ•°å¡«å……çš„ sql è¯­å¥ï¼ŒåŸºæœ¬é€»è¾‘è·Ÿå¹³å‡æ•°ä¸€æ ·ï¼›ä½†æ˜¯ä¸æ˜¯ç®€å•æ±‚å¹³å‡ï¼Œè€Œæ˜¯éœ€è¦è®¡ç®—æ¯ä¸ªç¼ºå¤±å€¼æ‰€åœ¨çš„åˆ†ä½æ•°ä½ç½®ï¼Œæ¥â€œçº¿æ€§æ’å€¼â€ã€‚è¿™é‡Œç¨å¾®æ¨å¯¼ä¸€ä¸‹å†å†™ sqlï¼šæˆ‘å°†ç¼ºå¤±å€¼çš„ä¸Šä¸€ä¸ªé‚»è¿‘éç©ºå€¼è®°ä¸º <code>s</code>ï¼Œä¸‹ä¸€ä¸ªé‚»è¿‘éç©ºå€¼è®°ä¸º <code>e</code>ï¼›å› ä¸ºæ˜¯åˆ†ä½æ•°ï¼Œè¿˜è¦è€ƒè™‘ä½ç½®ï¼Œå°†ä¸Šä¸€ä¸ªé‚»è¿‘éç©ºå€¼çš„åºå·è®°ä¸º <code>m</code>ï¼Œä¸‹ä¸€ä¸ªé‚»è¿‘éç©ºå€¼è®°ä¸º <code>n</code>ï¼Œè¿™ä¸ªç¼ºå¤±å€¼çš„ä½ç½®è®°å½•ä¸º <code>i</code>ã€‚åˆ™æ ¹æ®æ¨å¯¼å®ƒçš„ä½ç½®åˆ†ä½æ•°åº”è¯¥æ˜¯ <code>(i-m)/(m-n)</code>ï¼Œæˆ‘ä»¬å†æ¨å¯¼å®ƒçš„å€¼åº”è¯¥æ˜¯ <code>s + (e-s)*(i-m)/(m-n)</code> åŒ–ç®€åä¸º <code>s*(n-i)+e*(i-m)</code>ã€‚åœ¨ sql ä¸­ï¼Œæˆ‘åˆ©ç”¨æ—¥æœŸå……å½“åºå·ï¼Œåºå·ä¹‹é—´çš„å‡æ³•ç»“æœï¼Œæˆ‘ç”¨ <code>datediff</code> å‡½æ•°æ¥å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sql">with calc_exist_likes_num as (
    select
      video_id, dt, likes_num, show_likes_num
    -- æ³¨æ„å°† first_value å’Œ last_value çš„ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º true è¡¨ç¤ºè·³è¿‡ null
    , last_value(show_likes_num, true) over(partition by video_id 
            order by dt rows between unbounded preceding and 1 preceding) as last_exist_likes_num
    , first_value(show_likes_num, true) over(partition by video_id 
            order by dt rows between 1 following and unbounded following) as next_exist_likes_num
    -- å–å‡ºå‰åå­˜åœ¨çš„ç‚¹èµé‡å¯¹åº”çš„æ—¥æœŸç«¯ç‚¹
    -- æ³¨æ„è¦æ ¹æ®ç‚¹èµé‡åŒæ—¶å°†æ—¥æœŸè®¾ä¸º null
    , last_value(if(show_likes_num is null, null, dt), true) over(partition by video_id 
            order by dt rows between unbounded preceding and 1 preceding) as last_exist_likes_dt
    , first_value(if(show_likes_num is null, null, dt), true) over(partition by video_id 
            order by dt rows between 1 following and unbounded following) as next_exist_likes_dt
    , min(dt) over(partition by video_id) as base_dt
    from data_exercise.dwd_short_videos_likes_num_missing_data_from_crawler
)

select
  video_id, dt, likes_num, show_likes_num
-- æ¨å¯¼è§è¯´æ˜ï¼Œæ­¤å¤„ä¸å››èˆäº”å…¥ä¹Ÿæ˜¯ä¸ºäº†éªŒè¯ç»“æœ
, nvl(show_likes_num, if( e is null, s, (s * n_i + e * i_m) / (n_i + i_m))) as percentile_fill_likes_num
from (
    select
      video_id, dt, likes_num, show_likes_num
    , nvl(last_exist_likes_num,0) as s
    , next_exist_likes_num as e
    , if(last_exist_likes_num is not null, datediff(dt, last_exist_likes_dt), datediff(dt, base_dt)+1) as i_m
    , datediff(next_exist_likes_dt, dt) as n_i
    from calc_exist_likes_num
) t
-- ç»è¿‡ä¸€é€šå¤„ç†ï¼Œå‘ç°åŸæ¥çš„é¡ºåºè¢«ç ´åï¼Œé‡æ–°æ’åº
order by video_id asc, dt asc
</code></pre>
<p>æ³¨æ„é‡Œé¢çš„å…œåº•é€»è¾‘ï¼Œæ¯”å¦‚å–ä¸€ä¸ª <code>min(dt)</code> ä½œä¸ºå¦‚æœæ‰¾åˆ°å‰é¢çš„éç©ºå€¼ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºæ›´æ—©æ—¥æœŸçš„å‰ä¸€å¤©ï¼Œæ±‚ <code>i_m</code> å³ i-m æ—¶ <code>datediff(dt, base_dt)+1</code> çš„ <code>+1</code> å°±æ˜¯è¿™ä¹ˆæ¥çš„ã€‚å¦‚æœ <code>e</code> ä¸å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªéç©ºå€¼æ‰¾ä¸åˆ°ï¼Œç›´æ¥ç”¨ä¸Šä¸€ä¸ªéç©ºå€¼â€œé¡ºå»¶â€ä¸‹å»ã€‚</p>
<p>éƒ¨åˆ†ç»“æœéªŒè¯ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250511100903698-627648885.png" alt="" loading="lazy"></p>
<hr>
<p>ğŸ˜ğŸ˜ğŸ˜<br>
<strong>æˆ‘ç°åœ¨æ­£åœ¨æ±‚èŒæ•°æ®ç±»å·¥ä½œ</strong>ï¼ˆä¸»è¦æ˜¯æ•°æ®åˆ†ææˆ–æ•°æ®ç§‘å­¦ï¼‰ï¼›å¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼Œæ³è¯·æ‚¨ä¸æˆ‘è”ç³»ï¼Œå³æ—¶åˆ°å²—ï¼Œä¸é™åŸå¸‚ã€‚</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.33703822799537037" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-11 10:10">2025-05-11 10:10</span>&nbsp;
<a href="https://www.cnblogs.com/data-analytics">è’‹ç‚¹æ•°åˆ†</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18870557);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18870557', targetLink: 'https://www.cnblogs.com/data-analytics/p/18870557', title: 'ã€SQL å‘¨å‘¨ç»ƒã€‘çˆ¬å–çŸ­è§†é¢‘å‘ç°æ•°æ®ç¼ºå¤±ï¼Œå¦‚ä½•ç”¨ SQL å¡«å……' })">ä¸¾æŠ¥</a>
</div>
        