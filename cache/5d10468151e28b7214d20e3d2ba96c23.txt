
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/huangxincheng/p/18882285" title="å‘å¸ƒäº 2025-05-18 15:42">
    <span role="heading" aria-level="2">.NETå¤–æŒ‚ç³»åˆ—ï¼š1. harmony åŸºæœ¬åŸç†å’Œéª¨æ¶åˆ†æ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="ä¸€èƒŒæ™¯">ä¸€ï¼šèƒŒæ™¯</h2>
<h3 id="1-è®²æ•…äº‹">1. è®²æ•…äº‹</h3>
<p>ä¸ºä»€ä¹ˆè¦å¼€è¿™ä¹ˆä¸€ä¸ªç³»åˆ—ï¼Œæ˜¯å› ä¸ºä»–å¯ä»¥å¯¹ <code>.NET SDK</code> ä¸­çš„æ–¹æ³•è¿›è¡Œå¤–æŒ‚ï¼Œè¿™ç§æŠ€æœ¯å¯¹è§£å†³ç¨‹åºçš„ä¸€äº›ç–‘éš¾æ‚ç—‡ç‰¹åˆ«æœ‰ç”¨ï¼Œåœ¨<code>.NETé«˜çº§è°ƒè¯•</code> é¢†åŸŸä¸‹å¤§æ˜¾ç¥å¨ï¼Œåœ¨æˆ‘çš„è®­ç»ƒè¥é‡Œä¹Ÿæ˜¯èŠ±äº†ä¸€äº›ç¯‡å¹…æ¥è¯´è¿™ä¸ªï¼Œä»Šå¤©æˆ‘å‡†å¤‡ç”¨10ç¯‡å·¦å³æ¥è¯¦ç»†èŠä¸€èŠï¼Œä¾›å­¦å‘˜å’ŒåŒè¡Œä»¬æ¬£èµï¼Œè¯¦ç»†çš„æ–‡æ¡£å‚è€ƒï¼š<a href="https://harmony.pardeike.net/articles/intro.html" target="_blank" rel="noopener nofollow">https://harmony.pardeike.net/articles/intro.html</a></p>
<h2 id="äºŒharmony-è§£è¯»">äºŒï¼šharmony è§£è¯»</h2>
<h3 id="1-æ¦‚å¿µ">1. æ¦‚å¿µ</h3>
<p>Harmony æ˜¯ä¸€ä¸ªç”¨äºåœ¨è¿è¡Œæ—¶ä¿®è¡¥ã€æ›¿æ¢å’Œè£…é¥° .NET æ–¹æ³•çš„åº“ï¼Œå…¼å®¹ä¸»æµå¹³å°ï¼Œæ¯”å¦‚ PCã€Macã€Linuxçš„32ä½å’Œ64ä½ç³»ç»Ÿã€‚å®ƒçš„æ³¨å…¥æ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202505/214741-20250519100147908-2108477098.png" alt="" loading="lazy"></p>
<p>è¿™å¼ å›¾å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¯¹ä½ æƒ³è¦ hook çš„æ–¹æ³•ï¼Œharmony ä¼šå¯¹åº”ç”Ÿæˆä¸€ä¸ªåŠ¨æ€æ–¹æ³•ï¼Œç„¶åå°† éœ€è¦hookçš„åŸæ–¹æ³•çš„ilä»£ç å…¨éƒ¨copyèµ°ï¼ŒåŒæ—¶æ ¹æ®ä½ çš„é…ç½®æƒ…å†µï¼Œåœ¨<code>ilä»£ç ä¹‹å‰</code>å’Œ<code>ilä»£ç ä¹‹å</code> é…ç½®ä¸€ä¸ª AOP é€»è¾‘ï¼Œå½“ç„¶æœ‰éœ€è¦çš„è¯ï¼Œè¿˜å¯ä»¥å¯¹åŸæ–¹æ³•çš„ il ä»£ç å€ŸåŠ© Transpilers ç»„ä»¶è¿›è¡Œä¿®æ”¹ï¼Œæ€»ä¹‹éå¸¸å¼ºå¤§ã€‚</p>
<h3 id="2-harmony-æœ‰å“ªäº›æ³¨å…¥ç‚¹">2. harmony æœ‰å“ªäº›æ³¨å…¥ç‚¹</h3>
<p>ç”¨ harmony åšå¤–æŒ‚ï¼Œè‚¯å®šè¦çŸ¥é“æ³¨å…¥çš„ä¸€äº›ç‚¹ä½ï¼Œå¸¸è§çš„æœ‰ï¼š</p>
<ol>
<li>å‰ç¼€è¡¥ä¸ï¼ˆPrefixï¼‰å’Œåç¼€è¡¥ä¸ï¼ˆPostfixï¼‰</li>
</ol>
<p>å‰ç¼€è¡¥ä¸å’Œåç¼€è¡¥ä¸éå¸¸å¥½ç†è§£ï¼Œå°±æ˜¯æˆ‘ä»¬ç†è§£çš„ AOP åŠŸèƒ½ï¼Œå‰è€…åœ¨åŸå§‹æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œï¼Œåè€…æ˜¯åœ¨åŸå§‹æ–¹æ³•æ‰§è¡Œåæ‰§è¡Œã€‚</p>
<ol start="2">
<li>è½¬è¯‘å™¨è¡¥ä¸ï¼ˆTranspilerï¼‰</li>
</ol>
<p>å¦‚æœåŸºæœ¬çš„ AOP åŠŸèƒ½ä¸èƒ½æ»¡è¶³ï¼Œè¿™æ—¶å€™å°±å¿…é¡»æ›´ç²¾ç»†åŒ–çš„æ§åˆ¶ï¼Œå¯¹ï¼Œå°±æ˜¯ç›´æ¥ä¿®æ”¹ copy ä¹‹åçš„ il ä»£ç ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒğŸ‚ğŸ‘ƒäº†ï¼Œ</p>
<ol start="3">
<li>ç»ˆç»“å™¨è¡¥ä¸ï¼ˆFinalizerï¼‰</li>
</ol>
<p>å¦‚æœæ„å»ºå‡ºæ¥çš„<code>AOPè¡¥ä¸é€»è¾‘</code>ä¼šæŠ›å¼‚å¸¸çš„è¯ï¼Œä½ åˆä¸æƒ³è®©è¿™äº›å¼‚å¸¸æ±¡æŸ“æ­£å¸¸çš„ä¸šåŠ¡ä»£ç é€»è¾‘ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨ <code>ç»ˆç»“å™¨è¡¥ä¸</code> äº†ï¼Œç›¸å½“äºå¯¹å¤–å±è”½äº†äººå®¶ä¸å…³å¿ƒçš„ä¸œè¥¿ï¼Œå“ˆå“ˆï¼Œå¦åˆ™å®¹æ˜“é€ æˆææ…Œã€‚</p>
<ol start="4">
<li>åå‘è¡¥ä¸ï¼ˆReverse Patchï¼‰</li>
</ol>
<p>å¦‚æœè¯´ AOP æ˜¯çºµå‘æ‰©å±•ï¼Œé‚£<code>åå‘è¡¥ä¸</code>å°±æ˜¯æ¨ªå‘æ‰©å±•ï¼Œå®ƒçš„åŸç†å°±æ˜¯åœ¨ DynamicMethod æ–¹æ³•ä¹‹å‰ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç (Proxy)ï¼Œåç»­å†è·Ÿå¤§å®¶è¯¦ç»†èŠã€‚</p>
<h2 id="ä¸‰æ¡ˆä¾‹åœºæ™¯ä»‹ç»">ä¸‰ï¼šæ¡ˆä¾‹åœºæ™¯ä»‹ç»</h2>
<h3 id="1-æ¡ˆä¾‹èƒŒæ™¯">1. æ¡ˆä¾‹èƒŒæ™¯</h3>
<p>è¯´äº†è¿™ä¹ˆè¯´ï¼Œè¿˜æ˜¯è¯´ä¸€äº›æ¯”è¾ƒå®é™…çš„æ¡ˆä¾‹å¯èƒ½å¤§å®¶æ›´æ„Ÿå…´è¶£ï¼Œæˆ‘çš„ä¸€ä¸ª .NET ç¨‹åºå¹³æ—¶éƒ½æ˜¯å¥½å¥½çš„ï¼Œä¸çŸ¥é“ä¸ºå•¥çº¿ç¨‹çªç„¶å°±æš´æ¶¨åˆ°äº†1000+ï¼Œç°åœ¨å¾ˆæƒ¶æï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆé€»è¾‘å¯¼è‡´çš„ï¼Œæˆ‘ç”¨ windbg è§‚å¯Ÿåå‘ç°æ˜¯éƒ½æ˜¯æ™®é€šçš„ <code>Thread</code> ç±»ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-C#">
0:013&gt; !t
ThreadCount:      1004
UnstartedThread:  0
BackgroundThread: 2
PendingThread:    0
DeadThread:       1
Hosted Runtime:   no
                                                                                                            Lock  
 DBG   ID     OSID ThreadOBJ           State GC Mode     GC Alloc Context                  Domain           Count Apt Exception
   0    1     5358 0000024A2661D790    2a020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  11    2      66c 0000024A26687150    2b220 Preemptive  0000024A2AC04F88:0000024A2AC062B8 0000024a26613dc0 -00001 MTA (Finalizer) 
XXXX    4        0 0000028ABF061250  1039820 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 Ukn (Threadpool Worker) 
  14    5     4f2c 0000028ABF0656C0  302b220 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA (Threadpool Worker) 
  16    7     4ed8 0000028ABF069F40  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  17    8     44d8 0000028ABF08B110  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  18    9     4738 0000028ABD4BC640  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  19   10     201c 0000028ABD4BEAC0  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  20   11     49b0 0000028ABD4C0F80  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  21   12     43c8 0000028ABF08E1F0  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  22   13     5020 0000028ABF077170  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  23   14     3c48 0000028ABF07C820  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  24   15     4384 0000028ABF060BB0  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  ...
  1016 1003     5db4 0000028ABF7F9CD0  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 
  1017 1004     5db8 0000028ABF7FC190  202b020 Preemptive  0000000000000000:0000000000000000 0000024a26613dc0 -00001 MTA 

</code></pre>
<p>äººå¯¹ä¸€äº›æœªçŸ¥çš„ä¸œè¥¿ä¸€èˆ¬éƒ½å¾ˆç„¦è™‘æƒ¶æï¼Œé‚£æ€ä¹ˆåå‘æ‰¾åˆ°æ˜¯ä»€ä¹ˆä»£ç å¯¼è‡´çš„å‘¢ï¼Ÿå¤§å®¶å¯ä»¥ä»”ç»†æƒ³ä¸€æƒ³ï¼Œæ—¢ç„¶æœ‰äººå¼€äº† <code>Thread</code>, é‚£å¿…ç„¶è¦è°ƒç”¨ç›¸åº”çš„ Start æ–¹æ³•ï¼Œæ‰€ä»¥æ€è·¯å°±å¾ˆç®€å•äº†ï¼Œå¤–æŒ‚ <code>Thread.Start</code> æ–¹æ³•å°±å¥½ï¼Œå…ˆç”¨ ilspy è§‚å¯Ÿæºç ã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202505/214741-20250519100147906-945977573.png" alt="" loading="lazy"></p>
<p>ä»å›¾ä¸­çœ‹å½“å‰çš„ Start æœ‰å››ä¸ªé‡è½½ï¼Œé‚£åˆ°åº•æ³¨å…¥å“ªä¸€ä¸ªå‘¢ï¼Ÿå¯ä»¥å…¨tmæ³¨å…¥äº†ï¼Œä½†ç”±äºæ˜¯ç¬¬ä¸€ç¯‡å°±ä¸è¦æçš„é‚£ä¹ˆå¤æ‚ï¼ŒæŒ‘ä¸€ä¸ª <code>æ— å‚æ„é€ å‡½æ•°</code>ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-C#">
namespace Example_19_6
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // åˆ›å»º Harmony å®ä¾‹
            var harmony = new Harmony("com.example.threadhook");

            // åº”ç”¨è¡¥ä¸
            harmony.PatchAll();

            Task.Factory.StartNew(() =&gt; { Test(); });

            Console.ReadLine();
        }

        static void Test()
        {
            // æµ‹è¯•çº¿ç¨‹
            var thread = new Thread(() =&gt; Console.WriteLine("çº¿ç¨‹æ­£åœ¨è¿è¡Œ"));
            thread.Start();
        }
    }

    [HarmonyPatch(typeof(Thread), "Start", new Type[] { })]
    public class ThreadStartHook
    {
        // å‰ç¼€è¡¥ä¸ - åœ¨åŸå§‹æ–¹æ³•æ‰§è¡Œå‰è¿è¡Œ
        public static void Prefix(Thread __instance)
        {
            Console.WriteLine("----------------------------");
            Console.WriteLine($"å³å°†å¯åŠ¨çº¿ç¨‹: {__instance.ManagedThreadId}");
            Console.WriteLine(Environment.StackTrace);
            Console.WriteLine("----------------------------");
        }
    }
}

</code></pre>
<p>å¦ä¸­çš„ä»£ç ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼š</p>
<ol>
<li>
<p>ThreadStartHook<br>
è¿™ä¸ªæ˜¯æ³¨å…¥çš„ä¸»ä½“ç±»ï¼Œ<code>[HarmonyPatch(typeof(Thread), "Start", new Type[] { })]</code> è¡¨ç¤ºå¯¹æ— å‚çš„ <code>Thread.Start</code> è¿›è¡Œå¤–æŒ‚ã€‚</p>
</li>
<li>
<p>Prefix<br>
è¿™ä¸ªæ˜¯æœ¬æ¬¡é—®é¢˜çš„æ ¸å¿ƒä»£ç ï¼Œå®ƒåœ¨ <code>Thread.Start</code> å‡½æ•°è°ƒç”¨ä¹‹å‰æ‰§è¡Œï¼Œå…¶ä¸­ <code>__instance</code> æ˜¯å½“å‰ Thread çš„ this æŒ‡é’ˆï¼Œä¸ºäº†èƒ½å¤Ÿæ•è·æ˜¯è°è°ƒç”¨çš„ï¼Œæˆ‘ä»¬ç”¨ <code>Environment.StackTrace</code> æ˜¾ç¤ºå½“å‰çš„è°ƒç”¨æ ˆå³å¯ï¼Œå¦‚æœè¾“å‡ºäº†é‚£å°±çœŸç›¸å¤§ç™½ï¼Œè¿™é‡Œæˆ‘æ˜¯è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå¤§å®¶å¯ä»¥è¾“å‡ºåˆ°æ–‡ä»¶ã€‚</p>
</li>
<li>
<p>PatchAll<br>
æœ‰äº† patch(ThreadStartHook) ç±»ä¹‹åï¼Œå½“è°ƒç”¨ <code>harmony.PatchAll()</code> æ—¶ï¼Œharmonyå°±ä¼šåœ¨å½“å‰ç¨‹åºé›†ä¸­æœç´¢æ‰€æœ‰çš„æ ‡è®°ä¸º <code>HarmonyPatch</code> ç‰¹æ€§çš„ç±»ï¼Œç„¶åæ„å»ºç›¸åº”çš„å®¹çº³ä¸‡ç‰©çš„ DynamicMethodã€‚</p>
</li>
</ol>
<p>ä»£ç é€»è¾‘ç›¸ä¿¡å¤§æ¦‚éƒ½æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥å°†ç¨‹åºè·‘èµ·æ¥ï¼Œè§‚å¯Ÿ Console è¾“å‡ºã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202505/214741-20250519100147919-1957681115.png" alt="" loading="lazy"></p>
<p>ä»å¦ä¸­çœ‹ï¼Œå°¼ç›ï¼ŒåŸæ¥æ˜¯ä»£ç  <code>Example_19_6.Program.Test() </code>å¯¼è‡´çš„ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–¹æ³•åœ¨æºç ä¸­è§‚å¯Ÿä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</p>
<h3 id="2-åº•å±‚åŸç†æµ…æ">2. åº•å±‚åŸç†æµ…æ</h3>
<p>åˆ°è¿™é‡Œæˆ‘ç›¸ä¿¡æœ‰å¾ˆå¤šäººéƒ½æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œå¯¹ <code>thread.Start();</code> æ–¹æ³•çš„æ³¨å…¥ç‚¹åœ¨å“ªé‡Œï¼Ÿè¦æƒ³æ‰¾åˆ°è¿™ä¸ªç­”æ¡ˆï¼Œå¯ä»¥ç®€å•ç²—æš´çœ‹æ±‡ç¼–å³å¯ã€‚</p>
<pre><code class="language-C#">
0:013&gt; !name2ee System_Private_CoreLib!System.Threading.Thread.Start 
Module:      00007ff7fe8c4000
Assembly:    System.Private.CoreLib.dll
Token:       0000000006003691
MethodDesc:  00007ff7feaa1458
Name:        System.Threading.Thread.Start(System.Object)
Not JITTED yet. Use !bpmd -md 00007FF7FEAA1458 to break on run.
-----------------------
Token:       0000000006003693
MethodDesc:  00007ff7feaa1488
Name:        System.Threading.Thread.Start(System.Object, Boolean, Boolean)
Not JITTED yet. Use !bpmd -md 00007FF7FEAA1488 to break on run.
-----------------------
Token:       0000000006003694
MethodDesc:  00007ff7feaa14a0
Name:        System.Threading.Thread.Start()
JITTED Code Address: 00007ff85bd0e440
-----------------------
Token:       0000000006003697
MethodDesc:  00007ff7feaa14e8
Name:        System.Threading.Thread.Start(Boolean, Boolean)
JITTED Code Address: 00007ff85bd0e470

0:013&gt; !U 00007ff85bd0e440
preJIT generated code
System.Threading.Thread.Start()
ilAddr is 00007FF85C11E870 pImport is 000001BAD0805BF0
Begin 00007FF85BD0E440, size 12

/_/src/libraries/System.Private.CoreLib/src/System/Threading/Thread.cs @ 226:
&gt;&gt;&gt; 00007ff8`5bd0e440 e9cb22fba2      jmp     00007ff7`fecc0710
00007ff8`5bd0e445 8f00            pop     qword ptr [rax]
00007ff8`5bd0e447 ba01000000      mov     edx,1
00007ff8`5bd0e44c 4533c0          xor     r8d,r8d
00007ff8`5bd0e44f 48ff20          jmp     qword ptr [rax]

0:013&gt; !U 00007ff7`fecc0710
Normal JIT generated code
DynamicClass.System.Threading.Thread.Start_Patch1(System.Threading.Thread)
Can only work with dynamic not implemented

</code></pre>
<p>å½“ä½ çœ‹åˆ°å¦ä¸­çš„ <code>jmp 00007ff7fecc0710</code> ä»£ç ä¹‹åï¼Œæˆ‘ç›¸ä¿¡ä½ ä¸€åˆ‡éƒ½æ˜ç™½äº†ï¼Œè¿™æ˜¯å…¸å‹çš„é’©å­ä»£ç ï¼Œè¿™è¦æ˜¯è¢«<code>æ€æ¯’è½¯ä»¶</code>çŸ¥é“äº†ï¼Œç»å¯¹æ˜¯å®šæ–©ä¸èµ¦ï¼ ç”»ä¸ªç®€å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/214741/202505/214741-20250519100147927-1707602947.png" alt="" loading="lazy"></p>
<h2 id="å››æ€»ç»“">å››ï¼šæ€»ç»“</h2>
<p>ä½œä¸ºä¸€ä¸ª.NETé«˜çº§è°ƒè¯•å¸ˆï¼Œçµæ´»è¿ç”¨<code>.NETå¤–æŒ‚</code>æ˜¯ä¸€ä¸ªåŸºæœ¬åŠŸï¼Œæœ‰äº†å®ƒæˆ‘å°±å¯ä»¥è½»æ¾çš„ç»™ <code>.NET SDK</code> åŠ ä¸Šæ—¥å¿—ï¼Œä»æ­¤ä»¥ååƒé¹°çœ¼ä¸€æ ·ï¼Œæ´å¯Ÿè‹ç©¹ã€‚<br>
<img src="https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg" width="700" height="300" alt="å›¾ç‰‡åç§°" align="center"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="8.43722951121412" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-19 10:02">2025-05-18 15:42</span>&nbsp;
<a href="https://www.cnblogs.com/huangxincheng">ä¸€çº¿ç å†œ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">1305</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">6</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18882285);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18882285', targetLink: 'https://www.cnblogs.com/huangxincheng/p/18882285', title: '.NETå¤–æŒ‚ç³»åˆ—ï¼š1. harmony åŸºæœ¬åŸç†å’Œéª¨æ¶åˆ†æ' })">ä¸¾æŠ¥</a>
</div>
        