
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zengbiaobiao2016/p/18720036" title="发布于 2025-02-17 15:22">
    <span role="heading" aria-level="2">Docker容器访问挂载文件权限问题</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="docker容器访问挂载文件权限问题">Docker容器访问挂载文件权限问题</h1>
<h2 id="问题描述">问题描述</h2>
<p>在使用docker-compose部署项目时，yaml文件如下：</p>
<pre><code class="language-yaml">version: '3'
services:
  purchasing-contract-consumer:
    image: my-registry.com/consumer:latest
    environment:
      - TZ=Asia/Shanghai
      - app_env=prod
    restart: always
    working_dir: /app
    command: python app.py
    volumes:
      - type: bind
        source: /home/admin/deploy/consumer/application.log
        target: /app/application.log
</code></pre>
<p>启动应用时，报错：</p>
<pre><code>PermissionError: [Errno 13] Permission denied: '/app/application.log'
</code></pre>
<h2 id="原因分析">原因分析</h2>
<p>在我的应用中，需要在容器中对application.log文件进行写入，这个文件被挂载到宿主机上。因为我的宿主机系统是CentOS，默认启用了SELinux。在SELinux策略下，容器进程的类型是container_t类型，而宿主机上的文件默认是user_home_t类型，二者类型不匹配，容器进程无法访问宿主机上挂载的文件。</p>
<h2 id="解决方案">解决方案</h2>
<p>方案1，禁用SELinux，不推荐。</p>
<p>临时禁用SELinux方案如下：</p>
<pre><code class="language-shell">sudo setenforce 0
</code></pre>
<p>方案2，在宿主机上修改application.log文件类型为svirt_sandbox_file_t</p>
<pre><code class="language-shell">chcon -t svirt_sandbox_file_t application.log

</code></pre>
<p>如果需要永久修改application.log文件类型</p>
<pre><code class="language-shell">semanage fcontext -a -t svirt_sandbox_file_t "application.log"
restorecon application.log
</code></pre>
<p>将文件类型修改成svirt_sandbox_file_t之后，因为docker容器进程是container_t类型，SELinux允许container_t类型的进程访问svirt_sandbox_file_t类型的文件。</p>
<p>方案3，挂载时使用:Z，这将把挂载的文件设置成container_file_t类型，确保容器进程可以访问挂载文件。更新后的yaml文件如下。(推荐)</p>
<pre><code class="language-yaml">version: '3'
services:
  purchasing-contract-consumer:
    image: my-registry.com/consumer:latest
    environment:
      - TZ=Asia/Shanghai
      - app_env=prod
    restart: always
    working_dir: /app
    command: python app.py
    volumes:
      -  /home/admin/deploy/consumer/application.log:/app/application.log:Z
</code></pre>
<p>运行后，查看SELinux上下文类型</p>
<pre><code class="language-shell">[admin@myhost consumer]$ ls -lZ
-rw-rw-r--. admin admin system_u:object_r:container_file_t:s0:c716,c748 application.log
drwxr-xr-x. root  root  system_u:object_r:container_file_t:s0:c97,c362 config
-rwxr-xr-x. admin admin unconfined_u:object_r:user_home_t:s0 docker-compose.yml
-rw-rw-r--. admin admin unconfined_u:object_r:user_home_t:s0 qtsb-mail.tar
-rwxrwxr-x. admin admin unconfined_u:object_r:user_home_t:s0 start.sh

</code></pre>
<p>使用:Z挂载的文件类型是container_file_t，可以被容器进程访问。默认文件类型是user_home_t，无法被容器进程访问。</p>
<p>在使用方案3解决问题时，不能显示指定bing mount。如下</p>
<pre><code class="language-yaml">    volumes:
      - type: bind
        source: /home/admin/deploy/consumer/application.log
        target: /app/application.log:Z #无效，容器无法修改宿主机上application.log的SELinux类型

    volumes:
      -  /home/admin/deploy/consumer/application.log:/app/application.log:Z #有效，容器成功修改宿主机上application.log的SELinux类型

</code></pre>
<hr>
<p>示例代码在<a href="https://gitee.com/zengbiaobiao/java-virtual-thread.git" target="_blank" rel="noopener nofollow">Gitee</a>上同步，你也可以访问<a href="http://zengbiaobiao.com" target="_blank" rel="noopener nofollow">曾彪彪的个人博客</a>点击查看作者更多文章</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03858942070717593" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-02-17 15:25">2025-02-17 15:22</span>&nbsp;
<a href="https://www.cnblogs.com/zengbiaobiao2016">曾彪彪</a>&nbsp;
阅读(<span id="post_view_count">33</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18720036" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18720036);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18720036', targetLink: 'https://www.cnblogs.com/zengbiaobiao2016/p/18720036', title: 'Docker容器访问挂载文件权限问题' })">举报</a>
</div>
        