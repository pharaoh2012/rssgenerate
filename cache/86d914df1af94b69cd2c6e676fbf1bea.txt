
    <a name="top"></a>
    <h2><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kerrycode/p/18782081" title="发布于 2025-03-20 10:07">
    <span role="heading" aria-level="2">SQL Server如何跟踪自动统计信息更新?</span>
    

</a>
</h2>
    <small>
<span id="post-date" data-last-update-days="0.011186132524305555" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-03-20 10:42">2025-03-20 10:07</span>&nbsp;
<a href="https://www.cnblogs.com/kerrycode">潇湘隐者</a>&nbsp;
阅读(<span id="post_view_count">0</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18782081" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18782081);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18782081', targetLink: 'https://www.cnblogs.com/kerrycode/p/18782081', title: 'SQL Server如何跟踪自动统计信息更新?' })">举报</a>
</small>
    <div class="entry">
        <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="margin: 0; background: none left top / auto no-repeat scroll padding-box border-box rgba(0, 0, 0, 0); width: auto; font-family: Optima-Regular, Optima, PingFangSC-regular, PingFangTC-regular, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif; font-size: 14px; color: rgba(0, 0, 0, 1); line-height: 1.5em; word-spacing: 0; letter-spacing: 0; word-break: break-all; overflow-wrap: break-word; text-align: left; padding: 12px"><p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">SQL Server数据库中，我们都清楚统计信息对于优化器来说非常重要。一般情况下，我们会开启"自动更新统计信息"(Auto Update Statistics)这个选项，以便数据库能自动更新过期/过时的统计信息，因为过期/过时的统计信息可能会导致数据库生成一个糟糕的执行计划，SQL性能将会大打折扣，举一个例子，我们大脑做一些决策的时候，严重依赖所获取做决策信息的真实性与准确性，如果你所获得的信息是错误的，那么十有八九你会做出一个严重错误的决定。例如，如果当下环境中，你获取的信息：”买房稳赚不赔;买房会抗通胀......“是过时/错误的信息，那么你就会为当下的决策付出惨痛代价。</p>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">"自动更新统计信息"固然是不错的一个功能，但是很多人对它内部的原理知之甚少。对于"自动更新统计信息"是否开启也是有一些争论的。如果你监控发现一个SQL的执行计划经常出现变化，除了参数嗅探外等因素外，那么你要考虑一下可能是因为SQL语句中所涉及的表的统计信息自动更新导致。个人曾遇到一个案例，SQL语句的执行计划在凌晨2点变了，而且是性能变差，具体原因是在这个时间段，有一个作业会归档清理数据，导致触发自动统计信息更新，而它使用的是自动采样比例，而由于采样比例过低，导致优化器生成了一个较差的执行计划。如果你不用扩展事件去跟踪、分析的话，那么真的很难搞清楚为什么出现这种玄幻的现象。</p>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">下面是一个SQL执行计划经常出现变化的例子的截图，来自SolarWinds的DPA。
<img src="https://img2024.cnblogs.com/blog/73542/202503/73542-20250319224404111-1167436969.jpg" alt="" style="display: block; margin: 0 auto; max-width: 100%"></p>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">下面介绍一下，如何使用扩展事件跟踪统计信息自动更新。可以在做一些深入分析时用到。</p>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">创建扩展事件stat_auto_update_event</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0"><code class="hljs" style="overflow-x: auto; padding: 16px; color: rgba(51, 51, 51, 1); background: rgba(248, 248, 248, 1); font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px"><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">EVENT</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SESSION</span>&nbsp;[stat_auto_update_event]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SERVER</span>&nbsp;<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">EVENT</span>&nbsp;sqlserver.auto_stats(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ACTION</span>(sqlserver.sql_text,sqlserver.username,sqlserver.database_name))<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;TARGET&nbsp;package0.event_file(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SET</span>&nbsp;filename=N<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'E:\extevntlog\stat_auto_update_event'</span>,max_rollover_files=(<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">60</span>)),<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;TARGET&nbsp;package0.ring_buffer<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">WITH</span>&nbsp;(MAX_MEMORY=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">4096</span>&nbsp;KB,EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,MAX_DISPATCH_LATENCY=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">30</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SECONDS</span>,MAX_EVENT_SIZE=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">0</span>&nbsp;KB,MEMORY_PARTITION_MODE=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">NONE</span>,TRACK_CAUSALITY=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">OFF</span>,STARTUP_STATE=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GO</span><br></code></pre>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">启动会话,扩展事件就能捕获数据库中"自动更新统计信息"的一些事件了。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0"><code class="hljs" style="overflow-x: auto; padding: 16px; color: rgba(51, 51, 51, 1); background: rgba(248, 248, 248, 1); font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px"><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ALTER</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">EVENT</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SESSION</span>&nbsp;[stat_auto_update_event]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SERVER</span><br>STATE&nbsp;=&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">START</span>;<br></code></pre>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">此时，你就可以用下面SQL查看/分析"自动更新统计信息"的一些详细信息了。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0"><code class="hljs" style="overflow-x: auto; padding: 16px; color: rgba(51, 51, 51, 1); background: rgba(248, 248, 248, 1); font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px">IF&nbsp;OBJECT_ID('tempdb..<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event')&nbsp;IS&nbsp;NOT&nbsp;NULL</span><br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DROP</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">TABLE</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event;</span><br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">TABLE</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event</span><br>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ID</span>]&nbsp;<span class="hljs-built_in" style="color: rgba(0, 134, 179, 1); line-height: 26px">INT</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">IDENTITY</span>(<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1</span>,&nbsp;<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">NOT</span>&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[stat_update_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CONSTRAINT</span>&nbsp;[pk_stat_auto_update_event]&nbsp;PRIMARY&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">KEY</span>&nbsp;CLUSTERED&nbsp;(&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ID</span>]&nbsp;)<br>);<br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INSERT</span>&nbsp;&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;[stat_update_dtl]&nbsp;)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span>&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CONVERT</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>,&nbsp;[event_data])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[stat_update_dtl]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">sys</span>].[fn_xe_file_target_read_file](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'E:\extevntlog\stat_update_event*.xel'</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>)<br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;PRIMARY&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event([stat_update_dtl]);</span><br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl_path]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;[<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event]([stat_update_dtl])</span><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">USING</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FOR</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">VALUE</span>;<br><br><br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">WITH</span>&nbsp;cte_stat&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;(<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span><br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="database_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'INT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[database_id],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/@timestamp)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'DATETIME2(7)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_time],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/@name)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_name],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="index_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[index_id],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="object_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[object_id],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="job_type"]/text)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[job_type],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="sample_percentage"]/value)[1]'</span>,<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'INT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[sample_pct],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="status"]/text)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">status</span>],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="duration"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;/&nbsp;<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1000000.</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">duration</span>],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="statistics_list"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[statistics_list]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;[<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event]&nbsp;AS&nbsp;[sw]&nbsp;&nbsp;</span><br>)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB_NAME([cte_stat].[database_id])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[database_name]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DATEADD</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">HOUR</span>,&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DATEDIFF</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">HOUR</span>,&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GETUTCDATE</span>(),&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GETDATE</span>()),&nbsp;[cte_stat].[event_time])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_time]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[event_name]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_NAME([cte_stat].[object_id],[cte_stat].[database_id])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;object_name,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[index_id]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[job_type]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">status</span>]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[sample_pct],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">duration</span>]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[statistics_list]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;cte_stat<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ORDER</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">BY</span>&nbsp;[cte_stat].[event_time];<br></code></pre>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">上面扩展事件是跟踪整个数据库实例下的所有"自动更新统计信息"事件，会存在一定的开销，如果我只想跟踪某个对象，那么可以在创建扩展事件时进行过滤处理，如下所示，我只跟踪表test的"自动更新统计信息"，那么就可以通过下面脚本添加扩展事件</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0"><code class="hljs" style="overflow-x: auto; padding: 16px; color: rgba(51, 51, 51, 1); background: rgba(248, 248, 248, 1); font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px"><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">EVENT</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SESSION</span>&nbsp;[test_auto_update_event]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SERVER</span>&nbsp;<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">EVENT</span>&nbsp;sqlserver.auto_stats(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SET</span>&nbsp;collect_database_name=(<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">0</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ACTION</span><br>&nbsp;&nbsp;&nbsp;&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sqlserver.client_app_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,sqlserver.sql_text&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,sqlserver.tsql_stack&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,sqlserver.username<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,sqlserver.database_name<br>&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">WHERE</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[object_id]&nbsp;=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">45243216</span><span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">/*&nbsp;order&nbsp;of&nbsp;conditions&nbsp;matters&nbsp;-&nbsp;pick&nbsp;the&nbsp;most&nbsp;selective&nbsp;first&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AND</span>&nbsp;[database_id]&nbsp;=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">5</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AND</span>&nbsp;[package0].[not_equal_uint64]([<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">status</span>],&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'Loading&nbsp;stats&nbsp;without&nbsp;updating'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;TARGET&nbsp;package0.event_file(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SET</span>&nbsp;filename=N<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'E:\extevntlog\test_auto_update_event'</span>,max_rollover_files=(<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">60</span>)),<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ADD</span>&nbsp;TARGET&nbsp;package0.ring_buffer<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">WITH</span>&nbsp;(MAX_MEMORY=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">4096</span>&nbsp;KB,EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,MAX_DISPATCH_LATENCY=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">30</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SECONDS</span>,MAX_EVENT_SIZE=<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">0</span>&nbsp;KB,MEMORY_PARTITION_MODE=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">NONE</span>,TRACK_CAUSALITY=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">OFF</span>,STARTUP_STATE=<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GO</span><br></code></pre>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">注意：要根据实际情况调整相关值，例如[database_id]、[object_id]的值。</p>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">手动构造一些条件，触发表test自动更新统计信息，此时，你可以使用ssms工具查看扩展事件捕获的一些数据了，如下截图所示：</p>
<figure data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center"><img src="https://img2024.cnblogs.com/blog/73542/202503/73542-20250319224403912-1543250444.jpg" alt="" style="display: block; margin: 0 auto; max-width: 100%; border: 3px none rgba(0, 0, 0, 0.4); border-radius: 0; object-fit: fill; box-shadow: 0 0 rgba(0, 0, 0, 0)"></figure>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">当然，你也可以使用下面SQL语句进行查询</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0"><code class="hljs" style="overflow-x: auto; padding: 16px; color: rgba(51, 51, 51, 1); background: rgba(248, 248, 248, 1); font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px">IF&nbsp;OBJECT_ID('tempdb..<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event')&nbsp;IS&nbsp;NOT&nbsp;NULL</span><br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DROP</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">TABLE</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event;</span><br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">TABLE</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event</span><br>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ID</span>]&nbsp;<span class="hljs-built_in" style="color: rgba(0, 134, 179, 1); line-height: 26px">INT</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">IDENTITY</span>(<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1</span>,&nbsp;<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">NOT</span>&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[stat_update_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CONSTRAINT</span>&nbsp;[pk_stat_auto_update_event]&nbsp;PRIMARY&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">KEY</span>&nbsp;CLUSTERED&nbsp;(&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ID</span>]&nbsp;)<br>);<br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INSERT</span>&nbsp;&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;[stat_update_dtl]&nbsp;)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span>&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CONVERT</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>,&nbsp;[event_data])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[stat_update_dtl]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">sys</span>].[fn_xe_file_target_read_file](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'E:\extevntlog\test_auto_update_event*.xel'</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>,&nbsp;<span class="hljs-literal" style="color: rgba(0, 128, 128, 1); line-height: 26px">NULL</span>)<br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;PRIMARY&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event([stat_update_dtl]);</span><br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">CREATE</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl_path]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ON</span>&nbsp;[<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event]([stat_update_dtl])</span><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">USING</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">XML</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">INDEX</span>&nbsp;[xml_idx_stat_dtl]&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FOR</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">VALUE</span>;<br><br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">WITH</span>&nbsp;cte_stat&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;(<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span><br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="database_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'INT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[database_id],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/@timestamp)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'DATETIME2(7)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_time],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/@name)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_name],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="index_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[index_id],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="object_id"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[object_id],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="job_type"]/text)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[job_type],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="sample_percentage"]/value)[1]'</span>,<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'INT'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[sample_pct],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="status"]/text)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">status</span>],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="duration"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'BIGINT'</span>)&nbsp;/&nbsp;<span class="hljs-number" style="color: rgba(0, 128, 128, 1); line-height: 26px">1000000.</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">duration</span>],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/data[@name="statistics_list"]/value)[1]'</span>,&nbsp;<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[statistics_list],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/action[@name="sql_text"]/value)[1]'</span>,<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[sql_text],<br>[sw].[stat_update_dtl].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">value</span>](<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'(/event/action[@name="client_app_name"]/value)[1]'</span>,<span class="hljs-string" style="color: rgba(221, 17, 68, 1); line-height: 26px">'VARCHAR(MAX)'</span>)&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[client_app_name]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;[<span class="hljs-comment" style="color: rgba(153, 153, 136, 1); font-style: italic; line-height: 26px">#stat_auto_update_event]&nbsp;AS&nbsp;[sw]&nbsp;&nbsp;</span><br>)<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">SELECT</span>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DB_NAME([cte_stat].[database_id])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[database_name]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DATEADD</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">HOUR</span>,&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">DATEDIFF</span>(<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">HOUR</span>,&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GETUTCDATE</span>(),&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">GETDATE</span>()),&nbsp;[cte_stat].[event_time])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;[event_time]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[event_name]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_NAME([cte_stat].[object_id],[cte_stat].[database_id])&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">AS</span>&nbsp;object_name,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[index_id]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[job_type]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">status</span>]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[sample_pct],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">duration</span>]&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[statistics_list],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cte_stat].[sql_text],<br>&nbsp;&nbsp;[cte_stat].[client_app_name]<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">FROM</span>&nbsp;cte_stat<br><span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">ORDER</span>&nbsp;<span class="hljs-keyword" style="color: rgba(51, 51, 51, 1); font-weight: bold; line-height: 26px">BY</span>&nbsp;[cte_stat].[event_time];<br></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 10px 0; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center"><img src="https://img2024.cnblogs.com/blog/73542/202503/73542-20250319224404739-461846181.jpg" alt="" style="display: block; margin: 0 auto; max-width: 100%; border: 3px none rgba(0, 0, 0, 0.4); border-radius: 0; object-fit: fill; box-shadow: 0 0 rgba(0, 0, 0, 0)"></figure>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">关于扩展信息捕获的aut_stat数据，status状态一般有下面一些值(状态)，其中Loading stats without updating通常指的是加载统计信息而不进行更新操作</p>
<ul data-tool="mdnice编辑器" style="list-style-type: disc; margin: 8px 0; padding: 0 0 0 25px; color: rgba(0, 0, 0, 1)">
<li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">Loading stats without updating</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">Other</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">Loading and updating stats</section></li></ul>
<p data-tool="mdnice编辑器" style="color: rgba(0, 0, 0, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; text-indent: 0; margin: 0; padding: 8px 0">那么使用扩展事件追踪统计自动统计信息更新，有哪一些用途呢？ 下面是我简单的一些总结，不仅仅局限于此，你也可以扩展其用途。</p>
<ul data-tool="mdnice编辑器" style="list-style-type: disc; margin: 8px 0; padding: 0 0 0 25px; color: rgba(0, 0, 0, 1)">
<li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">追踪分析自动统计信息的采样比例</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">分析SQL语句执行计划变化的原因。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">为手工更新统计信息的频率与表对象提供数据支撑</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">研究自动统计信息更新触发的一些机制。</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin: 30px 0 15px; padding: 0; display: block"><span class="prefix" style="display: none"></span><span class="content" style="font-size: 24px; color: rgba(0, 0, 0, 1); line-height: 1.5em; letter-spacing: 0; text-align: left; font-weight: bold; display: block">参考资料</span><span class="suffix" style="display: none"></span></h1>
<ul data-tool="mdnice编辑器" style="list-style-type: disc; margin: 8px 0; padding: 0 0 0 25px; color: rgba(0, 0, 0, 1)">
<li><section style="margin-top: 5px; margin-bottom: 5px; color: rgba(1, 1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0; text-align: left; font-weight: normal">https://dba.stackexchange.com/questions/331860/use-extended-events-to-track-autoupdate-statistics-on-a-specific-table</section></li></ul>
</section>
</div>
<div id="MySignature" role="contentinfo">
    <div id="KerryCodeSignature">
<div>
<img src="https://images.cnblogs.com/cnblogs_com/kerrycode/1913302/o_240731062102_kerrycode.png" height="120" width="500">
</div>
<div>
<b>扫描上面二维码关注我</b>
</div>
<div>如果你真心觉得文章写得不错，而且对你有所帮助，那就不妨帮忙“推荐"一下，您的“推荐”和”打赏“将是我最大的写作动力！</div>
<div>本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接.</div>
</div>
</div>
<div class="clear"></div>

        <div class="clear"></div>
        
</div>
    <ul class="postmetadata">
        <vc:categories-tags blog-app="kerrycode" blog-id="57955" post-id="18782081"></vc:categories-tags>
    </ul>
