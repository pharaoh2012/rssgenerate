
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/vivotech/p/18976396" title="å‘å¸ƒäº 2025-07-10 10:33">
    <span role="heading" aria-level="2">vivo Pulsar ä¸‡äº¿çº§æ¶ˆæ¯å¤„ç†å®è·µï¼ˆ3ï¼‰-KoPæŒ‡æ ‡å¼‚å¸¸ä¿®å¤</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Apache Pulsaré€šè¿‡KoPå…¼å®¹Kafkaåè®®ï¼Œä½¿Kafkaåº”ç”¨èƒ½æ— ç¼è¿ç§»è‡³Pulsarï¼Œä¿ç•™å…¶ç”Ÿæ€ä¼˜åŠ¿ï¼Œå¹¶æå‡æ€§èƒ½ã€å…¼å®¹æ€§å’Œå¯æ‰©å±•æ€§ã€‚vivoåœ¨ä½¿ç”¨Pulsar KoPçš„è¿‡ç¨‹ä¸­é‡åˆ°è¿‡ä¸€äº›é—®é¢˜ï¼Œæœ¬ç¯‡ä¸»è¦åˆ†äº«ä¸€ä¸ªåˆ†åŒºæ¶ˆè´¹æŒ‡æ ‡ç¼ºå¤±çš„é—®é¢˜ã€‚
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<blockquote data-pm-slice="0 0 []">
<p>ä½œè€…ï¼švivo äº’è”ç½‘å¤§æ•°æ®å›¢é˜Ÿ- Chen Jianbo</p>
<p>æœ¬æ–‡æ˜¯ã€Švivo Pulsarä¸‡äº¿çº§æ¶ˆæ¯å¤„ç†å®è·µã€‹ç³»åˆ—æ–‡ç« ç¬¬3ç¯‡ã€‚</p>
<p>Pulsaræ˜¯ApacheåŸºé‡‘ä¼šçš„å¼€æºåˆ†å¸ƒå¼æµå¤„ç†å¹³å°å’Œæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒå®ç°äº†Kafkaçš„åè®®ï¼Œå¯ä»¥è®©ä½¿ç”¨Kafka APIçš„åº”ç”¨ç›´æ¥è¿ç§»è‡³Pulsarï¼Œè¿™ä½¿å¾—Pulsaråœ¨Kafkaç”Ÿæ€ç³»ç»Ÿä¸­æ›´åŠ å®¹æ˜“è¢«æ¥å—å’Œä½¿ç”¨ã€‚KoPæä¾›äº†ä»Kafkaåˆ°Pulsarçš„æ— ç¼è½¬æ¢ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨Kafka APIæ“ä½œPulsaré›†ç¾¤ï¼Œä¿ç•™äº†Kafkaçš„å¹¿æ³›ç”¨æˆ·åŸºç¡€å’Œä¸°å¯Œç”Ÿæ€ç³»ç»Ÿã€‚å®ƒä½¿å¾—Pulsarå¯ä»¥æ›´å¥½åœ°ä¸Kafkaè¿›è¡Œæ•´åˆï¼Œæä¾›æ›´å¥½çš„æ¶ˆæ¯ä¼ è¾“æ€§èƒ½ã€æ›´å¼ºçš„å…¼å®¹æ€§åŠå¯æ‰©å±•æ€§ã€‚vivoåœ¨ä½¿ç”¨Pulsar KoPçš„è¿‡ç¨‹ä¸­é‡åˆ°è¿‡ä¸€äº›é—®é¢˜ï¼Œæœ¬ç¯‡ä¸»è¦åˆ†äº«ä¸€ä¸ªåˆ†åŒºæ¶ˆè´¹æŒ‡æ ‡ç¼ºå¤±çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>&nbsp;</p>
<p>ç³»åˆ—æ–‡ç« ï¼š</p>
<ol>
<li>
<p data-number="1"><a href="https://mp.weixin.qq.com/s?__biz=MzI4NjY4MTU5Nw==&amp;mid=2247501335&amp;idx=1&amp;sn=3701be0b8b7b789e29c1ca53ba142e9d&amp;scene=21#wechat_redirect" data-type="link" data-id="link374729" rel="noopener nofollow">vivo Pulsarä¸‡äº¿çº§æ¶ˆæ¯å¤„ç†å®è·µï¼ˆ1ï¼‰-æ•°æ®å‘é€åŸç†è§£æå’Œæ€§èƒ½è°ƒä¼˜</a></p>
</li>
<li>
<p data-number="2"><a href="https://mp.weixin.qq.com/s?__biz=MzI4NjY4MTU5Nw==&amp;mid=2247501426&amp;idx=1&amp;sn=76c04879cfa2c6b38a731b5c49f19d3a&amp;scene=21#wechat_redirect" data-type="link" data-id="link374729" rel="noopener nofollow">&nbsp;vivo Pulsarä¸‡äº¿çº§æ¶ˆæ¯å¤„ç†å®è·µï¼ˆ2ï¼‰-ä»0åˆ°1å»ºè®¾PulsaræŒ‡æ ‡ç›‘æ§é“¾è·¯</a></p>
</li>
</ol>
<p>&nbsp;</p>
<p>æ–‡ç« å¤ªé•¿ï¼Ÿ1åˆ†é’Ÿçœ‹å›¾æŠ“ä½æ ¸å¿ƒè§‚ç‚¹ğŸ‘‡</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/f8/f8e4ea72e6b629f6442897eb3978d5da.gif&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/f8/f8e4ea72e6b629f6442897eb3978d5da.gif" class="lazyload"></p>
<h1>ä¸€ã€é—®é¢˜èƒŒæ™¯</h1>
<p>åœ¨ä¸€æ¬¡ç‰ˆæœ¬ç°åº¦å‡çº§ä¸­ï¼Œæˆ‘ä»¬å‘ç°æŸä¸ªä½¿ç”¨KoPçš„ä¸šåŠ¡topicçš„æ¶ˆè´¹é€Ÿç‡å‡ºç°äº†æ˜¾è‘—ä¸‹é™ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/30/304579a316d7af6084d5764ccc382428.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/30/304579a316d7af6084d5764ccc382428.png" class="lazyload"></p>
<p>ä»€ä¹ˆåŸå› å¯¼è‡´æ­£å¸¸çš„å‡çº§é‡å¯æœåŠ¡å™¨ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç›´æ¥æŸ¥çœ‹ä¸ŠæŠ¥é‡‡é›†çš„æ•°æ®æŠ¥æ–‡ï¼š</p>
<pre class="highlighter-hljs"><code>kop_server_MESSAGE_OUT{group="",partition="0",tenant="kop",topic="persistent://kop-tenant/kop-ns/service-raw-stats"}&nbsp;3
kop_server_BYTES_OUT{group="",partition="0",tenant="kop",topic="persistent://kop-tenant/kop-ns/service-raw-stats"}&nbsp;188</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒKoPæ¶ˆè´¹æŒ‡æ ‡kop_server_MESSAGE</p>
<p>_OUTã€kop_server_BYTES_OUTæ˜¯æœ‰ä¸ŠæŠ¥çš„ï¼Œä½†æŒ‡æ ‡æ•°æ®é‡Œçš„groupæ ‡ç­¾å˜æˆäº†ç©ºä¸²ï¼ˆç¼ºå°‘æ¶ˆè´¹ç»„åç§°ï¼‰ï¼Œåˆ†åŒºçš„æ¶ˆè´¹æŒ‡æ ‡å°±æ— æ³•å±•ç¤ºäº†ã€‚æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†æ¶ˆè´¹ç»„åç§°ç¼ºå¤±ï¼Ÿ</p>
<p>&nbsp;</p>
<h1>äºŒã€é—®é¢˜åˆ†æ</h1>
<p><strong>1ã€æ‰¾åˆ°é—®é¢˜ä»£ç </strong></p>
<p>æˆ‘ä»¬å»æ‰¾ä¸‹è¿™ä¸ªæ¶ˆè´¹ç»„åç§°æ˜¯åœ¨å“ªé‡Œè·å–çš„ï¼Œæ˜¯å¦é€»è¾‘å­˜åœ¨ä»€ä¹ˆé—®é¢˜ã€‚æ ¹æ®druidä¸­çš„kop_subscriptionå¯¹åº”çš„æ¶ˆè´¹æŒ‡æ ‡kop_server_</p>
<p>MESSAGE_OUTã€kop_server_BYTES_OUTï¼Œæ‰¾åˆ°ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="highlighter-hljs"><code>private&nbsp;void&nbsp;handleEntries(final&nbsp;List&lt;Entry&gt; entries,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;TopicPartition topicPartition,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;FetchRequest.PartitionData partitionData,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;KafkaTopicConsumerManager tcm,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;ManagedCursor cursor,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;AtomicLong cursorOffset,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;final&nbsp;boolean&nbsp;readCommitted) {
....
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// å¤„ç†æ¶ˆè´¹æ•°æ®æ—¶ï¼Œè·å–æ¶ˆè´¹ç»„åç§°
&nbsp; &nbsp; &nbsp; &nbsp; CompletableFuture&lt;String&gt; groupNameFuture = requestHandler
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .getCurrentConnectedGroup()
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .computeIfAbsent(clientHost, clientHost -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CompletableFuture&lt;String&gt; future =&nbsp;new&nbsp;CompletableFuture&lt;&gt;();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;String&nbsp;groupIdPath&nbsp;=&nbsp;GroupIdUtils.groupIdPathFormat(clientHost, header.clientId());
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requestHandler.getMetadataStore()
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .get(requestHandler.getGroupIdStoredPath() + groupIdPath)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .thenAccept(getResultOpt -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(getResultOpt.isPresent()) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;GetResult&nbsp;getResult&nbsp;=&nbsp;getResultOpt.get();
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; future.complete(new&nbsp;String(getResult.getValue() ==&nbsp;null
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?&nbsp;new&nbsp;byte[0] : getResult.getValue(), StandardCharsets.UTF_8));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;else&nbsp;{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// ä»zkèŠ‚ç‚¹ /client_group_id/xxx è·å–ä¸åˆ°æ¶ˆè´¹ç»„ï¼Œæ¶ˆè´¹ç»„å°±æ˜¯ç©ºçš„
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; future.complete("");
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }).exceptionally(ex -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; future.completeExceptionally(ex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;null;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; returnfuture;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });

&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// this part is heavyweight, and we should not execute in the ManagedLedger Ordered executor thread
&nbsp; &nbsp; &nbsp; &nbsp; groupNameFuture.whenCompleteAsync((groupName, ex) -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(ex !=&nbsp;null) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.error("Get groupId failed.", ex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; groupName =&nbsp;"";
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
.....
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// è·å¾—æ¶ˆè´¹ç»„åç§°åï¼Œè®°å½•æ¶ˆè´¹ç»„å¯¹åº”çš„æ¶ˆè´¹æŒ‡æ ‡
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decodeResult.updateConsumerStats(topicPartition,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entries.size(),
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; groupName,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statsLogger);</code></pre>
<p>ä»£ç çš„é€»è¾‘æ˜¯ï¼Œä»requestHandlerçš„currentConnectedGroup(map)ä¸­é€šè¿‡hostè·å–groupNameï¼Œä¸å­˜åœ¨åˆ™é€šè¿‡MetadataStoreï¼ˆå¸¦ç¼“å­˜çš„zkå­˜å‚¨å¯¹è±¡ï¼‰è·å–ï¼Œå¦‚æœzkç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œå†å‘èµ·zkè¯»è¯·æ±‚ï¼ˆè·¯å¾„ä¸º/client_group_id/host-clientIdï¼‰ã€‚è¯»å–åˆ°æ¶ˆè´¹ç»„åç§°åï¼Œç”¨å®ƒæ¥æ›´æ–°æ¶ˆè´¹ç»„æŒ‡æ ‡ã€‚ä»å¤ç°çš„é›†ç¾¤ç¡®å®šèµ°çš„æ˜¯è¿™ä¸ªåˆ†æ”¯ï¼Œå³æ˜¯ä»metadataStore(å¸¦ç¼“å­˜çš„zkå®¢æˆ·ç«¯)è·å–ä¸åˆ°å¯¹åº”zkèŠ‚ç‚¹/client_group_id/xxxã€‚</p>
<p>&nbsp;</p>
<p><strong>2ã€æŸ¥æ‰¾å¯èƒ½å¯¼è‡´zkèŠ‚ç‚¹/client_group_id/xxxèŠ‚ç‚¹è·å–ä¸åˆ°çš„åŸå› </strong></p>
<p>æœ‰ä¸¤ç§å¯èƒ½æ€§ï¼šä¸€æ˜¯æ²¡å†™è¿›å»ï¼ŒäºŒæ˜¯å†™è¿›å»ä½†æ˜¯è¢«åˆ é™¤äº†ã€‚</p>
<pre class="highlighter-hljs"><code>&nbsp; &nbsp;&nbsp;@Override
&nbsp; &nbsp;&nbsp;protected&nbsp;void&nbsp;handleFindCoordinatorRequest(KafkaHeaderAndRequest findCoordinator,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CompletableFuture&lt;AbstractResponse&gt; resultFuture) {
...
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// Store group name to metadata store for current client, use to collect consumer metrics.
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;storeGroupId(groupId, groupIdPath)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .whenComplete((stat, ex) -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(ex !=&nbsp;null) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// /client_group_id/xxxèŠ‚ç‚¹å†™å…¥å¤±è´¥
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.warn("Store groupId failed, the groupId might already stored.", ex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;findBroker(TopicName.get(pulsarTopicName))
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .whenComplete((node, throwable) -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ....
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });
...</code></pre>
<p>ä»ä»£ç çœ‹åˆ°ï¼ŒclientIdä¸groupIdçš„å…³è”å…³ç³»æ˜¯é€šè¿‡handleFindCoordinatorRequestï¼ˆFindCoordinatorï¼‰å†™è¿›å»çš„ï¼Œè€Œä¸”åªæœ‰è¿™ä¸ªæ–¹æ³•å…¥å£ã€‚ç”±äºæ²¡æœ‰æ‰¾åˆ°warnæ—¥å¿—ï¼Œæ’é™¤äº†ç¬¬ä¸€ç§æ²¡å†™è¿›å»çš„å¯èƒ½æ€§ã€‚çœ‹çœ‹åˆ é™¤çš„é€»è¾‘ï¼š</p>
<pre class="highlighter-hljs"><code>protected&nbsp;void&nbsp;close(){
&nbsp; &nbsp;&nbsp;if&nbsp;(isActive.getAndSet(false)) {
&nbsp; &nbsp; &nbsp; &nbsp; ...
&nbsp; &nbsp; &nbsp; &nbsp; currentConnectedClientId.forEach(clientId -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;String&nbsp;path = groupIdStoredPath +&nbsp;GroupIdUtils.groupIdPathFormat(clientHost, clientId);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// åˆ é™¤zkä¸Šçš„ /client_group_id/xxx èŠ‚ç‚¹
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; metadataStore.delete(path,&nbsp;Optional.empty())
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .whenComplete((__, ex) -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(ex !=&nbsp;null) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(ex.getCause()&nbsp;instanceof&nbsp;MetadataStoreException.NotFoundException) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(log.isDebugEnabled()) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("The groupId store path doesn't exist. Path: [{}]", path);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.error("Delete groupId failed. Path: [{}]", path, ex);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(log.isDebugEnabled()) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("Delete groupId success. Path: [{}]", path);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; }
}</code></pre>
<p>åˆ é™¤æ˜¯åœ¨requsetHandler.closeæ–¹æ³•ä¸­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´è¿æ¥æ–­å¼€å°±ä¼šè§¦å‘zkèŠ‚ç‚¹åˆ é™¤ã€‚</p>
<p>ä½†æœ‰å‡ ä¸ª<strong>ç–‘é—®ï¼š</strong></p>
<ul>
<li>
<p>/client_group_id/xxx åˆ°åº•æ˜¯å¹²å˜›ç”¨çš„ï¼Ÿæ¶ˆè´¹æŒ‡æ ‡ä¸ºä»€ä¹ˆè¦ä¾èµ–å®ƒ</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆè¦åœ¨handleFindCoordinatorRequestå†™å…¥ï¼Ÿ</p>
</li>
<li>
<p>èŠ‚ç‚¹/client_group_id/xxxä¸ºä»€ä¹ˆè¦åˆ é™¤ï¼Œè€Œä¸”æ˜¯åœ¨è¿æ¥æ–­å¼€æ—¶åˆ é™¤ï¼Œåˆ é™¤æ—¶æœºæ˜¯å¦æœ‰é—®é¢˜ï¼Ÿ</p>
</li>
</ul>
<p>é¦–å…ˆå›ç­”ç¬¬1ä¸ªé—®é¢˜ï¼Œé€šè¿‡é˜…è¯»ä»£ç å¯ä»¥çŸ¥é“ï¼Œ/client_group_id/xxx è¿™ä¸ªzkèŠ‚ç‚¹æ˜¯ç”¨äºåœ¨ä¸åŒbrokerå®ä¾‹é—´äº¤æ¢æ•°æ®ç”¨çš„(ç›¸å½“redis cache)ï¼Œç”¨äºä¸´æ—¶å­˜æ”¾IP+clientIdä¸groupIdçš„æ˜ å°„å…³ç³»ã€‚ç”±äºfetchæ¥å£ï¼ˆæ‹‰å–æ•°æ®ï¼‰çš„requestæ²¡æœ‰groupIdçš„ï¼Œåªèƒ½ä¾èµ–åŠ å…¥Groupè¿‡ç¨‹ä¸­çš„å…ƒæ•°æ®ï¼Œåœ¨fetchæ¶ˆè´¹æ—¶æ‰èƒ½çŸ¥é“å½“å‰æ‹‰æ•°æ®çš„consumeræ˜¯å“ªä¸ªæ¶ˆè´¹ç»„çš„ã€‚</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/98/98e8fd0e9b565bda9ad638fde500453b.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/98/98e8fd0e9b565bda9ad638fde500453b.png" class="lazyload"></p>
<p>&nbsp;</p>
<p><strong>3ã€å¤ç°</strong></p>
<p>è‹¥è¦è§£å†³é—®é¢˜ï¼Œæœ€å¥½èƒ½å¤Ÿç¨³å®šåœ°å¤ç°å‡ºé—®é¢˜ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šé—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œå¹¶ä¸”ç¡®è®¤ä¿®å¤æ˜¯å¦å®Œæˆã€‚</p>
<p>å› ä¸ºèŠ‚ç‚¹æ˜¯åœ¨requsetHandle.closeæ–¹æ³•ä¸­æ‰§è¡Œåˆ é™¤ï¼ŒbrokerèŠ‚ç‚¹å…³é—­ä¼šè§¦å‘è¿æ¥å…³é—­ï¼Œè¿›è€Œè§¦å‘åˆ é™¤ã€‚å‡è®¾ï¼šå®¢æˆ·ç«¯é€šè¿‡brokerAå‘èµ·FindCoordinatorè¯·æ±‚ï¼Œå†™å…¥zkèŠ‚ç‚¹/client_group</p>
<p>_id/xxxï¼ŒåŒæ—¶è¯·æ±‚è¿”å›brokerBä½œä¸ºCoordinatorï¼Œåç»­ä¸brokerBè¿›è¡ŒjoinGroupã€syncGroupç­‰äº¤äº’ç¡®å®šæ¶ˆè´¹å…³ç³»ï¼Œå®¢æˆ·ç«¯åœ¨brokerAã€brokerBã€brokerCéƒ½æœ‰åˆ†åŒºæ¶ˆè´¹ã€‚è¿™æ—¶é‡å¯brokerAï¼Œåˆ†åŒºå‡è¡¡åˆ°BrokerCä¸Šï¼Œä½†æ­¤æ—¶/client_group_id/xxxå› å…³é—­brokerè€Œæ–­å¼€è¿æ¥è¢«åˆ é™¤ï¼Œconsumeræ¶ˆè´¹åˆšè½¬ç§»åˆ°topic1-partition-1çš„åˆ†åŒºå°±æ— æ³•è·å–åˆ°groupIdã€‚</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/cd/cdffe20b8cea8bc8cdbef12b1e84a6bb.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/cd/cdffe20b8cea8bc8cdbef12b1e84a6bb.png" class="lazyload"></p>
<p>æŒ‰ç…§å‡è®¾ï¼Œæœ‰3ä¸ªbrokerï¼Œå¼€å¯ç”Ÿäº§å’Œæ¶ˆè´¹ï¼Œé€šè¿‡åœ¨FindCoordinatorè¿”å›å‰è·å–node.leader()çš„è¿”å›èŠ‚ç‚¹BrokerBï¼Œå…³é—­brokerAåï¼ŒbrokerCå‡ºç°æ–­ç‚¹å¤ç°ï¼Œå†å…³é—­brokerCï¼ŒbrokerAä¹Ÿä¼šå¤ç°ï¼ˆå‡è®¾åˆ†åŒºåœ¨brokerAä¸brokerCä¹‹é—´è½¬ç§»ï¼‰ã€‚</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/4c/4c0b2db443a5f7658384eb6b271e46b7.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/4c/4c0b2db443a5f7658384eb6b271e46b7.png" class="lazyload"></p>
<p>å¤ç°è¦å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>
<p data-number="1">brokeræ•°é‡è¦è¶³å¤Ÿå¤š(ä¸å°äº3ä¸ªï¼‰</p>
</li>
<li>
<p data-number="2">&nbsp;brokerå†…éƒ¨æœ‰zkç¼“å­˜metadataCacheé»˜è®¤ä¸º5åˆ†é’Ÿï¼Œå¯ä»¥æŠŠæ—¶é—´è°ƒå°ä¸º1æ¯«ç§’ï¼Œç›¸å½“äºæ²¡æœ‰cache</p>
</li>
<li>
<p data-number="3">&nbsp;findCoordinatorè¿”å›çš„å¿…é¡»æ˜¯å…¶ä»–brokerçš„IP</p>
</li>
<li>
<p data-number="4">&nbsp;é‡å¯çš„å¿…é¡»æ˜¯æ¥æ”¶åˆ°findCoordinatorè¯·æ±‚é‚£å°brokerï¼Œè€Œä¸æ˜¯çœŸæ­£çš„coordinatorï¼Œè¿™æ—¶ä¼šä»zkåˆ é™¤èŠ‚ç‚¹</p>
</li>
<li>
<p data-number="5">åˆ†åŒºè½¬ç§»åˆ°å…¶ä»–brokerï¼Œè¿™æ—¶æ–°çš„brokerä¼šé‡æ–°è¯»å–zkèŠ‚ç‚¹æ•°æ®</p>
</li>
</ol>
<p>åˆ°æ­¤ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ¸…æ¥šäº†é—®é¢˜åŸå› ï¼šè¿æ¥å…³é—­å¯¼è‡´zkèŠ‚ç‚¹è¢«åˆ é™¤äº†ï¼Œåˆ«çš„brokerèŠ‚ç‚¹éœ€è¦æ—¶å°±è¯»å–ä¸åˆ°äº†ã€‚é‚£æ€ä¹ˆè§£å†³ï¼Ÿ</p>
<p>&nbsp;</p>
<h1>ä¸‰ã€é—®é¢˜è§£å†³</h1>
<p><strong>æ–¹æ¡ˆä¸€</strong></p>
<p>æ—¢ç„¶çŸ¥é“æŠŠæ¶ˆè´¹è€…ä¸FindCoordinatorçš„è¿æ¥è¿›è¡Œç»‘å®šä¸åˆé€‚çš„ï¼Œé‚£ä¹ˆæ˜¯å¦åº”è¯¥æŠŠFindCoordinatorå†™å…¥zkèŠ‚ç‚¹æ¢æˆç”±JoinGroupå†™å…¥ï¼Œæ–­è¿å³åˆ é™¤ã€‚</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/d0/d08470f5d1d0d3d2c14931425f7acc2d.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/d0/d08470f5d1d0d3d2c14931425f7acc2d.png" class="lazyload"></p>
<p>consumerç»Ÿä¸€ç”±Coordinatorç®¡ç†ï¼Œç”±äºFindCoordinatoræ¥å£ä¸ä¸€å®šæ˜¯Coordinatorå¤„ç†çš„ï¼Œå¦‚æœæ¢æˆç”±Coordinatorå¤„ç†çš„JoinGroupæ¥å£æ˜¯å¦å°±å¯ä»¥äº†ï¼Œè¿™æ ·consumeræ–­å¼€ä¸Coordinatorçš„è¿æ¥å°±åº”è¯¥åˆ é™¤æ•°æ®ã€‚ä½†å®ç°éªŒè¯æ—¶å´å‘ç°ï¼Œå®¢æˆ·ç«¯åœ¨æ–­è¿åä¹Ÿä¸ä¼šå†é‡è¿ï¼Œæ‰€ä»¥æ²¡æ³•é‡æ–°å†™å…¥zkï¼Œä¸ç¬¦åˆé¢„æœŸã€‚</p>
<p>&nbsp;</p>
<p><strong>æ–¹æ¡ˆäºŒ</strong></p>
<p>è¿˜æ˜¯ç”±FindCoordinatorå†™å…¥zkèŠ‚ç‚¹ï¼Œä½†åˆ é™¤æ”¹ä¸ºGroupCoordinatorç›‘å¬consumeræ–­å¼€è§¦å‘ã€‚</p>
<p>å› ä¸ºconsumerç»Ÿä¸€ç”±Coordinatorç®¡ç†ï¼Œå®ƒèƒ½ç›‘å¬åˆ°consumeråŠ å…¥æˆ–è€…ç¦»å¼€ã€‚GroupCoordinatorçš„removeMemberAndUpdateGroupæ–¹æ³•æ˜¯coordinatorå¯¹consumeræˆå‘˜ç®¡ç†ã€‚</p>
<pre class="highlighter-hljs"><code>private&nbsp;void&nbsp;removeMemberAndUpdateGroup(GroupMetadata&nbsp;group,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemberMetadata member) {
&nbsp; &nbsp;&nbsp;group.remove(member.memberId());
&nbsp; &nbsp;&nbsp;switch&nbsp;(group.currentState()) {
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;case&nbsp;Dead:
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;case&nbsp;Empty:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return;
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;case&nbsp;Stable:
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;case&nbsp;CompletingRebalance:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maybePrepareRebalance(group);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;break;
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;case&nbsp;PreparingRebalance:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; joinPurgatory.checkAndComplete(new&nbsp;GroupKey(group.groupId()));
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;break;
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;default:
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;break;
&nbsp; &nbsp; }
&nbsp; &nbsp;&nbsp;// åˆ é™¤ /client_group_id/xxx èŠ‚ç‚¹
&nbsp; &nbsp; deleteClientIdGroupMapping(group, member.clientHost(), member.clientId());
}</code></pre>
<p>&nbsp;</p>
<p>è°ƒç”¨å…¥å£æœ‰ä¸¤ä¸ªï¼Œå…¶ä¸­handleLeaveGroupæ˜¯ä¸»åŠ¨ç¦»å¼€ï¼ŒonExpireHeartbeatæ˜¯è¶…æ—¶è¢«åŠ¨ç¦»å¼€ï¼Œå®¢æˆ·ç«¯æ­£å¸¸é€€å‡ºæˆ–è€…å®•æœºéƒ½å¯ä»¥è°ƒç”¨removeMemberAndUpdateGroupæ–¹æ³•è§¦å‘åˆ é™¤ã€‚</p>
<pre class="highlighter-hljs"><code>public&nbsp;CompletableFuture&lt;Errors&gt;&nbsp;handleLeaveGroup(
&nbsp; &nbsp; String groupId,
&nbsp; &nbsp; String memberId
) {
&nbsp; &nbsp;&nbsp;return&nbsp;validateGroupStatus(groupId, ApiKeys.LEAVE_GROUP).map(error -&gt;
&nbsp; &nbsp; &nbsp; &nbsp; CompletableFuture.completedFuture(error)
&nbsp; &nbsp; ).orElseGet(() -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;groupManager.getGroup(groupId).map(group&nbsp;-&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;group.inLock(() -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(group.is(Dead) || !group.has(memberId)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;CompletableFuture.completedFuture(Errors.UNKNOWN_MEMBER_ID);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;else&nbsp;{
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// è§¦å‘åˆ é™¤æ¶ˆè´¹è€…consumer
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; removeMemberAndUpdateGroup(group, member);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;CompletableFuture.completedFuture(Errors.NONE);
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });
&nbsp; &nbsp; &nbsp; &nbsp; })
&nbsp; &nbsp; &nbsp; &nbsp; ....
&nbsp; &nbsp; });
}</code></pre>
<p>&nbsp;</p>
<pre class="highlighter-hljs"><code>void&nbsp;onExpireHeartbeat(GroupMetadata&nbsp;group,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MemberMetadata member,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;long&nbsp;heartbeatDeadline) {
&nbsp; &nbsp;&nbsp;group.inLock(() -&gt; {
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(!shouldKeepMemberAlive(member, heartbeatDeadline)) {
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info("Member {} in group {} has failed, removing it from the group",
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; member.memberId(),&nbsp;group.groupId());
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// è§¦å‘åˆ é™¤æ¶ˆè´¹è€…consumer
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; removeMemberAndUpdateGroup(group, member);
&nbsp; &nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;null;
&nbsp; &nbsp; });
}</code></pre>
<p>ä½†è¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œæ—¥å¿—è¿ç»´å…³é—­brokerä¹Ÿä¼šè§¦å‘ä¸€ä¸ªonExpireHeartbeatäº‹ä»¶åˆ é™¤zkèŠ‚ç‚¹ï¼Œä¸æ­¤åŒæ—¶å®¢æˆ·ç«¯å‘ç°Coordinatoræ–­å¼€äº†ä¼šé©¬ä¸Šè§¦å‘FindCoordinatorå†™å…¥æ–°çš„zkèŠ‚ç‚¹ï¼Œä½†å¦‚æœåˆ é™¤æ™šäºå†™å…¥çš„è¯ï¼Œä¼šå¯¼è‡´è¯¯åˆ é™¤æ–°å†™å…¥çš„èŠ‚ç‚¹ã€‚æˆ‘ä»¬å¹²è„†åœ¨å…³é—­brokeræ—¶ï¼Œä½¿ç”¨ShutdownHookåŠ ä¸ŠshuttingdownçŠ¶æ€é˜²æ­¢å…³é—­brokeræ—¶åˆ é™¤zkèŠ‚ç‚¹ï¼Œåªæœ‰å®¢æˆ·ç«¯æ–­å¼€æ—¶æ‰åˆ é™¤ã€‚</p>
<p>è¿™ä¸ªæ–¹æ¡ˆä¿®æ”¹ä¸Šçº¿åŠä¸ªæœˆåï¼Œè¿˜æ˜¯å‡ºç°äº†ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆè´¹æŒ‡æ ‡æ— æ³•ä¸ŠæŠ¥çš„æƒ…å†µã€‚åæ¥å®šä½å‘ç°ï¼Œå¦‚æœå®¢æˆ·ç«¯å› FullGCå‡ºç°å¡é¡¿æƒ…å†µï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šå…ˆäºbrokerè§¦å‘è¶…æ—¶ï¼Œä¹Ÿå°±æ˜¯å…ˆè¶…æ—¶çš„å®¢æˆ·ç«¯æ–°å†™å…¥çš„æ•°æ®è¢«åç›‘å¬åˆ°è¶…æ—¶çš„brokerè¯¯åˆ é™¤äº†ã€‚å› ä¸ºå†™å…¥ä¸åˆ é™¤å¹¶ä¸æ˜¯ç”±åŒä¸€ä¸ªèŠ‚ç‚¹å¤„ç†ï¼Œæ‰€ä»¥æ— æ³•åœ¨è¿›ç¨‹çº§åˆ«åšå¹¶å‘æ§åˆ¶ï¼Œè€Œä¸”ä¹Ÿæ— æ³•åˆ¤æ–­å“ªæ¬¡åˆ é™¤å¯¹åº”å“ªæ¬¡çš„å†™å…¥ï¼Œæ‰€ä»¥ç”¨zkä¹Ÿæ˜¯å¾ˆéš¾å®ç°å¹¶å‘æ§åˆ¶ã€‚</p>
<p>&nbsp;</p>
<p><strong>æ–¹æ¡ˆä¸‰</strong></p>
<p>å…¶å®è¿™å¹¶ä¸æ˜¯æ–°çš„æ–¹æ¡ˆï¼Œåªæ˜¯åœ¨æ–¹æ¡ˆäºŒåŸºç¡€ä¸Šä¼˜åŒ–ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬å¾ˆéš¾æ§åˆ¶å¥½å†™å…¥ä¸åˆ é™¤çš„å…ˆåé¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥åšæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼Œç±»ä¼¼äºäº¤æ˜“ç³»ç»Ÿé‡Œçš„å¯¹è´¦ã€‚å› ä¸ºGroupCoordinatoræ˜¯è´Ÿè´£ç®¡ç†consumeræˆå‘˜çš„ï¼Œç»´æŠ¤ç€consumerçš„å®æ—¶çŠ¶æ€ï¼Œå°±ç®—zkèŠ‚ç‚¹è¢«è¯¯åˆ é™¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»consumeræˆå‘˜ä¿¡æ¯ä¸­æ¢å¤ï¼Œé‡æ–°å†™å…¥zkèŠ‚ç‚¹ã€‚</p>
<pre class="highlighter-hljs"><code>private&nbsp;void&nbsp;checkZkGroupMapping(){ &nbsp;
&nbsp; &nbsp;&nbsp;for&nbsp;(GroupMetadata&nbsp;group&nbsp;: groupManager.currentGroups()) { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;for&nbsp;(MemberMetadata memberMetadata :&nbsp;group.allMemberMetadata()) { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String clientPath = GroupIdUtils.groupIdPathFormat(memberMetadata.clientHost(), memberMetadata.clientId()); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String zkGroupClientPath = kafkaConfig.getGroupIdZooKeeperPath() + clientPath; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// æŸ¥æ‰¾zkä¸­æ˜¯å¦å­˜åœ¨èŠ‚ç‚¹
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; metadataStore.get(zkGroupClientPath).thenAccept(resultOpt -&gt; { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;if&nbsp;(!resultOpt.isPresent()) { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// ä¸å­˜åœ¨åˆ™è¿›è¡Œè¡¥å¿ä¿®å¤
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; metadataStore.put(zkGroupClientPath, memberMetadata.groupId().getBytes(UTF\_8), Optional.empty()) &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .thenAccept(stat -&gt; { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info("repaired clientId and group mapping: {}({})", &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; zkGroupClientPath, memberMetadata.groupId()); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }) &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .exceptionally(ex -&gt; { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.warn("repaired clientId and group mapping failed: {}({})", &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; zkGroupClientPath, memberMetadata.groupId()); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;null; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }).exceptionally(ex -&gt; { &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.warn("repaired clientId and group mapping failed: {} ", zkGroupClientPath, ex); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;return&nbsp;null; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }); &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;
&nbsp; &nbsp; } &nbsp;
}</code></pre>
<p>ç»è¿‡æ–¹æ¡ˆä¸‰çš„ä¼˜åŒ–ä¸Šçº¿ï¼Œå³ä½¿æ˜¯å†å²å­˜åœ¨é—®é¢˜çš„æ¶ˆè´¹ç»„ï¼Œä¸ªåˆ«åˆ†åŒºæ¶ˆè´¹æµé‡æŒ‡æ ‡ç¼ºå°‘groupå­—æ®µçš„é—®é¢˜ä¹Ÿå¾—åˆ°äº†ä¿®å¤ã€‚å…·ä½“æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img alt="å›¾ç‰‡" data-pm-attrs="{&quot;src&quot;:&quot;https://static001.geekbang.org/infoq/e7/e729d5dbc1791dee7e507efb3c603ede.png&quot;,&quot;alt&quot;:&quot;å›¾ç‰‡&quot;,&quot;title&quot;:null,&quot;style&quot;:[{&quot;key&quot;:&quot;width&quot;,&quot;value&quot;:&quot;75%&quot;},{&quot;key&quot;:&quot;bordertype&quot;,&quot;value&quot;:&quot;none&quot;}],&quot;href&quot;:null,&quot;fromPaste&quot;:true,&quot;pastePass&quot;:true}" data-src="https://static001.geekbang.org/infoq/e7/e729d5dbc1791dee7e507efb3c603ede.png" class="lazyload"></p>
<p>&nbsp;</p>
<h1>å››ã€æ€»ç»“</h1>
<p>ç»è¿‡å¤šä¸ªç‰ˆæœ¬çš„ä¼˜åŒ–å’Œçº¿ä¸ŠéªŒè¯ï¼Œæœ€ç»ˆé€šè¿‡æ–¹æ¡ˆä¸‰æ¯”è¾ƒå®Œç¾çš„è§£å†³äº†è¿™ä¸ªæ¶ˆè´¹æŒ‡æ ‡é—®é¢˜ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¹¶å‘é—®é¢˜å¾€å¾€éš¾ä»¥æ¨¡æ‹Ÿå’Œå¤ç°ï¼Œæˆ‘ä»¬ä¹Ÿåœ¨å°è¯•å¤šä¸ªç‰ˆæœ¬åæ‰æ‰¾åˆ°æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚å¦‚æœæ‚¨åœ¨è¿™æ–¹é¢æœ‰æ›´å¥½çš„ç»éªŒæˆ–æƒ³æ³•ï¼Œæ¬¢è¿æå‡ºï¼Œæˆ‘ä»¬å…±åŒæ¢è®¨å’Œäº¤æµã€‚</p>
</div>
<div id="MySignature" role="contentinfo">
    åˆ†äº« vivo äº’è”ç½‘æŠ€æœ¯å¹²è´§ä¸æ²™é¾™æ´»åŠ¨ï¼Œæ¨èæœ€æ–°è¡Œä¸šåŠ¨æ€ä¸çƒ­é—¨ä¼šè®®ã€‚
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-10 10:34">2025-07-10 10:33</span>&nbsp;
<a href="https://www.cnblogs.com/vivotech">vivoäº’è”ç½‘æŠ€æœ¯</a>&nbsp;
é˜…è¯»(<span id="post_view_count">102</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18976396);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18976396', targetLink: 'https://www.cnblogs.com/vivotech/p/18976396', title: 'vivo Pulsar ä¸‡äº¿çº§æ¶ˆæ¯å¤„ç†å®è·µï¼ˆ3ï¼‰-KoPæŒ‡æ ‡å¼‚å¸¸ä¿®å¤' })">ä¸¾æŠ¥</a>
</div>
        