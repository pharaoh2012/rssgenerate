
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/SmalBox/p/19055858" title="å‘å¸ƒäº 2025-08-24 20:48">
    <span role="heading" aria-level="2">ã€æ¸²æŸ“æµæ°´çº¿ã€‘[é€ç‰‡å…ƒé˜¶æ®µ]-[æ·±åº¦æµ‹è¯•]ä»¥UnityURPä¸ºä¾‹</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250824205418856-2035852705.png" alt="ã€æ¸²æŸ“æµæ°´çº¿ã€‘[é€ç‰‡å…ƒé˜¶æ®µ]-[æ·±åº¦æµ‹è¯•]ä»¥UnityURPä¸ºä¾‹" class="desc_img">
        æœ¬æ–‡æ·±å…¥è§£æUnity URPç®¡çº¿ä¸­çš„æ·±åº¦æµ‹è¯•æœºåˆ¶ï¼Œé‡ç‚¹ä»‹ç»å…¶æŠ€æœ¯æ¼”è¿›å†ç¨‹å’Œç°ä»£URPä½“ç³»ä¸‹çš„æ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆã€‚æ–‡ç« è¯¦ç»†å¯¹æ¯”äº†ä¼ ç»Ÿæ·±åº¦æµ‹è¯•ã€URPåˆæœŸç‰ˆæœ¬å’Œç°ä»£URPä½“ç³»åœ¨æ·±åº¦å¤„ç†ä¸Šçš„å·®å¼‚ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„Shaderä»£ç ç¤ºä¾‹ï¼ˆåŒ…æ‹¬URP_ZTestExample.shaderã€WaterDepth.shaderç­‰ï¼‰ï¼Œå±•ç¤ºå¦‚ä½•å®ç°æ°´ä½“äº¤äº’ã€æ™¯æ·±ç‰¹æ•ˆç­‰æ ¸å¿ƒåº”ç”¨åœºæ™¯ã€‚åŒæ—¶ï¼Œæ–‡ç« è¿˜ç»™å‡ºäº†æ·±åº¦æµ‹è¯•çš„ä¼˜åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬æ ¼å¼é€‰æ‹©ã€æ¸²æŸ“ç­–ç•¥ã€é™æ€åˆæ‰¹ç­‰æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œå¹¶å¼ºè°ƒé€šè¿‡FrameDebuggerç­‰å·¥å…·è¿›è¡ŒéªŒè¯è°ƒè¯•çš„é‡è¦æ€§ã€‚æœ€
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<ul>
<li>æ·±åº¦æµ‹è¯•æ˜¯é€šè¿‡æ¯”è¾ƒå½“å‰ç‰‡å…ƒæ·±åº¦å€¼ä¸æ·±åº¦ç¼“å†²åŒºå€¼å†³å®šæ˜¯å¦ä¸¢å¼ƒè¯¥ç‰‡å…ƒã€‚URPè‡ª2018å¹´éšUnity 2019.1æ¨å‡ºåï¼Œé€æ­¥æ›¿ä»£äº†ä¼ ç»Ÿå†…ç½®ç®¡çº¿ï¼Œå…¶æ·±åº¦æµ‹è¯•æœºåˆ¶åœ¨ç§»åŠ¨ç«¯å’ŒPCå¹³å°å‡é‡‡ç”¨æ›´é«˜æ•ˆçš„GPUæŒ‡ä»¤ä¼˜åŒ–ã€‚</li>
</ul>
<blockquote>
<p><a href="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" target="_blank" rel="noopener nofollow">ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘</a><strong>ä¸“æ -ç›´è¾¾</strong></p>
</blockquote>
<h1 id="æŠ€æœ¯æ¼”è¿›å†ç¨‹">æŠ€æœ¯æ¼”è¿›å†ç¨‹</h1>
<h2 id="ä¼ ç»Ÿæ·±åº¦æµ‹è¯•é˜¶æ®µ2017å¹´å‰"><strong>ä¼ ç»Ÿæ·±åº¦æµ‹è¯•é˜¶æ®µ</strong>ï¼ˆ2017å¹´å‰ï¼‰</h2>
<ul>
<li>åŸºäºBuilt-in RPçš„æ·±åº¦ç¼“å†²æœºåˆ¶</li>
<li>ç¡¬ç¼–ç å®ç°Z-bufferç®—æ³•</li>
<li>ç¼ºä¹è·¨å¹³å°ç»Ÿä¸€ç®¡ç†</li>
</ul>
<h2 id="urpåˆæœŸç‰ˆæœ¬2017-2020"><strong>URPåˆæœŸç‰ˆæœ¬</strong>ï¼ˆ2017-2020ï¼‰</h2>
<ul>
<li>å¼•å…¥å¯ç¼–ç¨‹æ¸²æŸ“ç®¡çº¿æ¶æ„</li>
<li>å®ç°è½»é‡çº§æ·±åº¦é¢„é€šé“(DepthPrepass)</li>
<li>æ”¯æŒ_CameraDepthTextureè‡ªåŠ¨ç”Ÿæˆ</li>
</ul>
<h2 id="ç°ä»£urpä½“ç³»2021è‡³ä»Š"><strong>ç°ä»£URPä½“ç³»</strong>ï¼ˆ2021è‡³ä»Šï¼‰</h2>
<ul>
<li>æ·±åº¦ä¸æ³•çº¿å›¾è”åˆæ¸²æŸ“(DepthNormalsPass)</li>
<li>å¤šå¹³å°æ·±åº¦æ ¼å¼ä¼˜åŒ–(k_DepthStencilFormat)</li>
<li>æ¨¡æ¿æµ‹è¯•æ·±åº¦é›†æˆ(Stencil Opæšä¸¾)</li>
</ul>
<h1 id="æ·±åº¦æµ‹è¯•å‘½ä»¤ä½¿ç”¨æ ·ä¾‹">æ·±åº¦æµ‹è¯•å‘½ä»¤ä½¿ç”¨æ ·ä¾‹</h1>
<h2 id="ç°ä»£urpä¼˜åŒ–">â€Œ<strong>ç°ä»£URPä¼˜åŒ–</strong>â€Œ</h2>
<ul>
<li>ç»“åˆSRP Batcherå‡å°‘SetPass Callsï¼Œæ·±åº¦æµ‹è¯•ä¸æ¨¡æ¿æµ‹è¯•å¹¶è¡Œå¤„ç†æå‡æ€§èƒ½</li>
<li>é€šè¿‡Zå€¼æ¯”è¾ƒå®ç°ä¸‰ç»´ç©ºé—´é®æŒ¡å…³ç³»</li>
<li>å¯é…ç½®Less/Equal/Greaterç­‰æ¯”è¾ƒæ¨¡å¼â€Œ</li>
</ul>
<h2 id="urp_ztestexampleshader"><strong>URP_ZTestExample.shader</strong></h2>
<ul>
<li>é€šè¿‡Propertiesé¢æ¿å¯åŠ¨æ€é…ç½®8ç§ZTestæ¨¡å¼</li>
<li>æ”¯æŒæ·±åº¦å†™å…¥(ZWrite)å¼€å…³æ§åˆ¶</li>
<li>å®Œæ•´åŒ…å«URPæ ‡å‡†HLSLè¯­æ³•ç»“æ„</li>
<li>ä½¿ç”¨CBUFFERå®ç°æè´¨å‚æ•°åºåˆ—åŒ–</li>
<li>é»˜è®¤æ¸²æŸ“é˜Ÿåˆ—è®¾ç½®ä¸ºGeometry(2000)</li>
</ul>
<h2 id="å…³é”®å‚æ•°è¯´æ˜">å…³é”®å‚æ•°è¯´æ˜</h2>
<ul>
<li><code>_ZTestMode</code>å¯¹åº”æ·±åº¦æµ‹è¯•æšä¸¾å€¼ï¼š
<ul>
<li>1&nbsp;2&nbsp;3</li>
<li>4(é»˜è®¤) 5</li>
<li>6&nbsp;7&nbsp;8:Always</li>
</ul>
</li>
<li><code>_ZWrite</code>æ§åˆ¶æ·±åº¦ç¼“å†²å†™å…¥(0=Off,1=On)</li>
<li>åŒ…å«åŸºç¡€çº¹ç†é‡‡æ ·å’Œé¢œè‰²æ··åˆåŠŸèƒ½</li>
</ul>
<h2 id="urp_ztestexampleshader-1">URP_ZTestExample.shader</h2>
<pre><code class="language-c">Shader "Custom/URP_ZTestExample"
{
    Properties
    {
        _MainTex("Base Texture", 2D) = "white" {}
        _Color("Tint Color", Color) = (1,1,1,1)
        [Enum(UnityEngine.Rendering.CompareFunction)]
        _ZTestMode("ZTest Mode", Int) = 4 // é»˜è®¤LEqual
        [Toggle]_ZWrite("ZWrite", Float) = 1
    }

    SubShader
    {
        Tags {
            "RenderType"="Opaque"
            "RenderPipeline"="UniversalRenderPipeline"
            "Queue"="Geometry"
        }

        Pass
        {
            // ShaderLabå‘½ä»¤é…ç½®
            ZTest [_ZTestMode]
            ZWrite [_ZWrite]
            Cull Back
            Blend Off
            
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            
            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"

            CBUFFER_START(UnityPerMaterial)
                float4 _Color;
                int _ZTestMode;
                float _ZWrite;
            CBUFFER_END

            TEXTURE2D(_MainTex);
            SAMPLER(sampler_MainTex);

            struct Attributes
            {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            struct Varyings
            {
                float4 positionHCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            Varyings vert(Attributes IN)
            {
                Varyings OUT;
                OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                return OUT;
            }

            half4 frag(Varyings IN) : SV_Target
            {
                half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv) * _Color;
                return col;
            }
            ENDHLSL
        }
    }
}

</code></pre>
<h2 id="å‘½ä»¤é€‰é¡¹">å‘½ä»¤é€‰é¡¹</h2>
<p>é€šè¿‡ShaderLabå‘½ä»¤<code>ZTest</code>å¯è®¾ç½®æ·±åº¦æµ‹è¯•æ¯”è¾ƒè§„åˆ™ï¼Œæ”¯æŒä»¥ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li><code>Less</code>ï¼šæ·±åº¦å°äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡ï¼ˆé»˜è®¤å€¼ï¼‰â€Œ</li>
<li><code>Greater</code>ï¼šæ·±åº¦å¤§äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡</li>
<li><code>LEqual</code>ï¼šæ·±åº¦å°äºç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡</li>
<li><code>GEqual</code>ï¼šæ·±åº¦å¤§äºç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡</li>
<li><code>Equal</code>ï¼šæ·±åº¦ç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡</li>
<li><code>NotEqual</code>ï¼šæ·±åº¦ä¸ç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡</li>
<li><code>Always</code>ï¼šå§‹ç»ˆé€šè¿‡ï¼ˆç­‰åŒäºå…³é—­æ·±åº¦æµ‹è¯•ï¼‰â€Œ</li>
</ul>
<h1 id="urpæ·±åº¦æµ‹è¯•æ¸²æŸ“ç®¡çº¿æ·±åº¦ç›¸å…³å˜é‡">URPæ·±åº¦æµ‹è¯•æ¸²æŸ“ç®¡çº¿æ·±åº¦ç›¸å…³å˜é‡</h1>
<h2 id="æ ¸å¿ƒæ·±åº¦çº¹ç†å˜é‡"><strong>æ ¸å¿ƒæ·±åº¦çº¹ç†å˜é‡</strong></h2>
<h3 id="_cameradepthtexture">â€Œ_CameraDepthTexture</h3>
<ul>
<li>
<p>åœºæ™¯æ·±åº¦çº¹ç†ï¼Œå­˜å‚¨éçº¿æ€§æ·±åº¦å€¼ï¼ˆ0-1èŒƒå›´ï¼‰</p>
</li>
<li>
<p>å¯ç”¨è¦æ±‚ï¼šURP Assetä¸­å‹¾é€‰ â€Œ<strong>Depth Texture</strong>â€Œ é€‰é¡¹</p>
</li>
<li>
<p>ç€è‰²å™¨å£°æ˜ï¼š</p>
<pre><code class="language-c">hlsl
#include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"
</code></pre>
</li>
</ul>
<h3 id="_cameraopaquetexture"><code>_CameraOpaqueTexture</code></h3>
<ul>
<li>ä¸é€æ˜é€šé“åçš„å±å¹•å›¾åƒï¼ˆå«æ·±åº¦ä¿¡æ¯ï¼‰</li>
<li>å¯ç”¨è¦æ±‚ï¼šURP Assetä¸­å‹¾é€‰ â€Œ<strong>Opaque Texture</strong>â€Œ é€‰é¡¹</li>
<li>å…¸å‹åº”ç”¨ï¼šé€æ˜ç‰©ä½“æŠ˜å°„/æ¯›ç»ç’ƒæ•ˆæœ</li>
</ul>
<h2 id="è¾…åŠ©æ·±åº¦ç›¸å…³åŠŸèƒ½"><strong>è¾…åŠ©æ·±åº¦ç›¸å…³åŠŸèƒ½</strong></h2>
<h3 id="æ·±åº¦é‡å»ºå‡½æ•°éœ€åŒ…å«corehlsl">æ·±åº¦é‡å»ºå‡½æ•°ï¼ˆéœ€åŒ…å«&nbsp;<code>Core.hlsl</code>ï¼‰</h3>
<pre><code class="language-c">hlsl
float linearDepth = LinearEyeDepth(depthSample, _ZBufferParams); // è½¬æ¢ä¸ºçº¿æ€§æ·±åº¦
float normalizedDepth = Linear01Depth(depthSample, _ZBufferParams); // [0,1]å½’ä¸€åŒ–
</code></pre>
<h3 id="æ·±åº¦é™é‡‡æ ·æ§åˆ¶urp-assetè®¾ç½®">æ·±åº¦é™é‡‡æ ·æ§åˆ¶ï¼ˆURP Assetè®¾ç½®ï¼‰</h3>
<ul>
<li><code>Opaque Downsampling</code>ï¼šè°ƒæ•´ä¸é€æ˜çº¹ç†åˆ†è¾¨ç‡ï¼ˆNone/2x/4xï¼‰</li>
</ul>
<h2 id="æ³¨æ„äº‹é¡¹"><strong>æ³¨æ„äº‹é¡¹</strong></h2>
<ul>
<li>é»˜è®¤ä¸ç”Ÿæˆ&nbsp;<code>_CameraDepthNormalsTexture</code>ï¼Œéœ€é€šè¿‡ â€Œ<strong>Renderer Feature</strong>â€Œ æ‰‹åŠ¨å®ç°</li>
<li>ç§»åŠ¨å¹³å°éœ€è°¨æ…ä½¿ç”¨æ·±åº¦çº¹ç†ï¼Œå¯èƒ½å½±å“æ€§èƒ½</li>
<li>æ·±åº¦æµ‹è¯•æ¨¡å¼é€šè¿‡&nbsp;<code>ZTest</code>&nbsp;æŒ‡ä»¤åŠ¨æ€è°ƒæ•´ï¼ˆå¦‚&nbsp;<code>ZTest Greater</code>ï¼‰</li>
</ul>
<h1 id="æ ¸å¿ƒåº”ç”¨åœºæ™¯">æ ¸å¿ƒåº”ç”¨åœºæ™¯</h1>
<h2 id="æ°´ä½“äº¤äº’æ•ˆæœ"><strong>æ°´ä½“äº¤äº’æ•ˆæœ</strong></h2>
<h3 id="å®ç°åŸç†">å®ç°åŸç†</h3>
<ul>
<li>é€šè¿‡æ·±åº¦å·®è®¡ç®—æ°´é¢æ·¹æ²¡åŒºåŸŸ</li>
</ul>
<h3 id="å…³é”®æŠ€æœ¯">å…³é”®æŠ€æœ¯</h3>
<ul>
<li>è§‚å¯Ÿç©ºé—´åæ ‡è½¬æ¢</li>
</ul>
<h3 id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>åŠé€æ˜é˜Ÿåˆ—+æ·±åº¦å†™å…¥å…³é—­</li>
</ul>
<h3 id="ä»£ç ä¸¾ä¾‹-waterdepthshader">ä»£ç ä¸¾ä¾‹ WaterDepth.shader</h3>
<ul>
<li>å®ç°é€æ˜æ°´ä½“çš„æ·±åº¦æ•ˆæœï¼ŒåŒ…å«æ·±åº¦çº¹ç†é‡‡æ ·å’Œé€æ˜åº¦è®¡ç®—ã€‚</li>
<li>åŒ…å«æ·±åº¦çº¹ç†å£°æ˜å’Œé‡‡æ ·</li>
<li>æ”¯æŒUVå˜æ¢å’Œæè´¨å‚æ•°åºåˆ—åŒ–</li>
<li>ä¿æŒåŸShaderçš„é€æ˜æ··åˆæ•ˆæœ</li>
</ul>
<pre><code class="language-c">Shader "Custom/WaterDepth"
{
    Properties
    {
        [MainTexture] _MainTex("Base (RGB)", 2D) = "white" {}
        _DepthFactor("Depth Factor", Range(0,1)) = 0.5
    }

    SubShader
    {
        Tags 
        {
            "Queue"="Transparent"
            "RenderType"="Transparent"
            "RenderPipeline"="UniversalRenderPipeline"
        }

        Pass
        {
            ZWrite Off
            Blend SrcAlpha OneMinusSrcAlpha

            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"

            TEXTURE2D(_MainTex);
            SAMPLER(sampler_MainTex);

            CBUFFER_START(UnityPerMaterial)
                float4 _MainTex_ST;
                float _DepthFactor;
            CBUFFER_END

            struct Attributes
            {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            struct Varyings
            {
                float4 positionHCS : SV_POSITION;
                float4 screenPos : TEXCOORD0;
                float2 uv : TEXCOORD1;
            };

            Varyings vert(Attributes IN)
            {
                Varyings OUT;
                OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.screenPos = ComputeScreenPos(OUT.positionHCS);
                OUT.uv = TRANSFORM_TEX(IN.uv, _MainTex);
                return OUT;
            }

            half4 frag(Varyings IN) : SV_Target
            {
                float2 screenUV = IN.screenPos.xy / IN.screenPos.w;
                float depth = SampleSceneDepth(screenUV);
                depth = LinearEyeDepth(depth, _ZBufferParams);
                float sceneZ = depth - IN.screenPos.w;
                float waterDepth = saturate(sceneZ * _DepthFactor);

                half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
                col.a = waterDepth;
                return col;
            }
            ENDHLSL
        }
    }
}
</code></pre>
<h2 id="é®æŒ¡å‰”é™¤ä¼˜åŒ–"><strong>é®æŒ¡å‰”é™¤ä¼˜åŒ–</strong></h2>
<h3 id="å®ç°åŸç†-1">å®ç°åŸç†</h3>
<ul>
<li>Early-ZæŠ€æœ¯é¢„åˆ¤</li>
</ul>
<h3 id="å…³é”®æŠ€æœ¯-1">å…³é”®æŠ€æœ¯</h3>
<ul>
<li>DepthPrepassä¼˜å…ˆæœºåˆ¶</li>
</ul>
<h3 id="æ€§èƒ½ä¼˜åŒ–-1">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>å®ä¾‹åŒ–æ‰¹å¤„ç†</li>
</ul>
<h3 id="ä»£ç ä¸¾ä¾‹-depthoffieldshader">ä»£ç ä¸¾ä¾‹ <strong>DepthOfField.shader</strong></h3>
<ul>
<li>å®ç°URPåå¤„ç†æ™¯æ·±æ•ˆæœ</li>
<li>åŒ…å«æ·±åº¦çº¹ç†é‡‡æ ·</li>
<li>æ”¯æŒç„¦ç‚¹è·ç¦»å’Œæ¨¡ç³Šå¼ºåº¦è°ƒèŠ‚</li>
<li>ä¿æŒåŸShaderçš„æ™¯æ·±è®¡ç®—é€»è¾‘</li>
<li>é‡‡ç”¨URPçš„æ·±åº¦é‡‡æ ·API</li>
</ul>
<pre><code class="language-c">Shader "Hidden/DepthOfField"
{
    SubShader
    {
        Tags { "RenderType"="Opaque" "RenderPipeline"="UniversalRenderPipeline" }
        
        Cull Off 
        ZWrite Off 
        ZTest Always

        Pass
        {
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"

            TEXTURE2D(_MainTex);
            SAMPLER(sampler_MainTex);

            CBUFFER_START(UnityPerMaterial)
                float _FocusDistance;
                float _BlurSize;
            CBUFFER_END

            struct Attributes
            {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            struct Varyings
            {
                float4 positionHCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            Varyings vert(Attributes IN)
            {
                Varyings OUT;
                OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                return OUT;
            }

            half4 frag(Varyings IN) : SV_Target
            {
                float depth = SampleSceneDepth(IN.uv);
                depth = Linear01Depth(depth, _ZBufferParams);
                
                float blur = saturate(abs(depth - _FocusDistance) * _BlurSize);
                half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
                col.rgb = lerp(col.rgb, col.rgb * 0.5, blur);
                return col;
            }
            ENDHLSL
        }
    }
}

</code></pre>
<h2 id="æ™¯æ·±ç‰¹æ•ˆç³»ç»Ÿ"><strong>æ™¯æ·±ç‰¹æ•ˆç³»ç»Ÿ</strong></h2>
<h3 id="å®ç°åŸç†-2">å®ç°åŸç†</h3>
<ul>
<li>çº¿æ€§æ·±åº¦å€¼æ’å€¼è®¡ç®—</li>
</ul>
<h3 id="å…³é”®æŠ€æœ¯-2">å…³é”®æŠ€æœ¯</h3>
<ul>
<li>SAMPLE_DEPTH_TEXTUREå®</li>
</ul>
<h3 id="æ€§èƒ½ä¼˜åŒ–-2">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>é™é‡‡æ ·+é«˜æ–¯æ¨¡ç³Šè¿­ä»£</li>
</ul>
<h3 id="ä»£ç ä¸¾ä¾‹-stencildepthshader">ä»£ç ä¸¾ä¾‹ <strong>StencilDepth.shader</strong></h3>
<ul>
<li>å®ç°URPæ¨¡æ¿æµ‹è¯•åŠŸèƒ½</li>
<li>æ”¯æŒæ¨¡æ¿ç¼“å†²æµ‹è¯•</li>
<li>ä¿ç•™åŸShaderçš„çº¹ç†é‡‡æ ·åŠŸèƒ½</li>
<li>é‡‡ç”¨CBUFFERç®¡ç†æè´¨å‚æ•°</li>
</ul>
<pre><code class="language-c">Shader "Custom/StencilDepth"
{
    Properties
    {
        [MainTexture] _MainTex("Texture", 2D) = "white" {}
        _StencilRef("Stencil Ref", Int) = 1
    }

    SubShader
    {
        Tags 
        {
            "Queue"="Geometry"
            "RenderPipeline"="UniversalRenderPipeline"
        }

        Stencil
        {
            Ref [_StencilRef]
            Comp Less
            Pass Replace
        }

        Pass
        {
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"

            TEXTURE2D(_MainTex);
            SAMPLER(sampler_MainTex);

            CBUFFER_START(UnityPerMaterial)
                float4 _MainTex_ST;
                int _StencilRef;
            CBUFFER_END

            struct Attributes
            {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            struct Varyings
            {
                float4 positionHCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            Varyings vert(Attributes IN)
            {
                Varyings OUT;
                OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = TRANSFORM_TEX(IN.uv, _MainTex);
                return OUT;
            }

            half4 frag(Varyings IN) : SV_Target
            {
                return SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
            }
            ENDHLSL
        }
    }
}

</code></pre>
<h1 id="æ·±åº¦æµ‹è¯•ä¼˜åŒ–å»ºè®®"><strong>æ·±åº¦æµ‹è¯•ä¼˜åŒ–å»ºè®®</strong></h1>
<h2 id="æ ¼å¼é€‰æ‹©"><strong>æ ¼å¼é€‰æ‹©</strong></h2>
<ul>
<li>ç§»åŠ¨ç«¯ä½¿ç”¨16-bitæ·±åº¦(k_DepthBufferBits)</li>
<li>PCç«¯æ¨è32-bitç²¾åº¦</li>
</ul>
<h2 id="æ¸²æŸ“ç­–ç•¥"><strong>æ¸²æŸ“ç­–ç•¥</strong></h2>
<h3 id="é™æ€åœºæ™¯å¯ç”¨depthprepass">é™æ€åœºæ™¯å¯ç”¨DepthPrepass</h3>
<ul>
<li>
<p>â€Œ<strong>URP Asseté…ç½®</strong>â€Œ</p>
<p>å¯ç”¨æ·±åº¦çº¹ç†ç”Ÿæˆï¼š</p>
<p><code>Project Settings &gt; Graphics &gt; URP Global Settings</code>&nbsp;â†’ å‹¾é€‰â€Œ<strong>Depth Texture</strong>â€Œé€‰é¡¹ã€‚</p>
</li>
<li>
<p>â€Œ<strong>Renderer Dataè®¾ç½®</strong>â€Œ</p>
<p>åœ¨ä½¿ç”¨çš„Renderer Assetï¼ˆå¦‚<code>UniversalRenderer_Forward</code>)ä¸­ï¼š</p>
<p>â†’ æ·»åŠ â€Œ<strong>SSAOæ•ˆæœ</strong>â€Œï¼ˆScreen Space Ambient Occlusionï¼‰</p>
<p>â†’ å°†SSAOçš„â€Œ<strong>Sourceå±æ€§è®¾ä¸ºDepth</strong>â€Œ</p>
<p>æ­¤æ“ä½œå¼ºåˆ¶URPå¯ç”¨DepthPrepassé€šé“æ¸²æŸ“é™æ€ç‰©ä½“æ·±åº¦åˆ°<code>_CameraDepthTexture</code>ã€‚</p>
<ul>
<li>â€Œ<strong>æ€§èƒ½å½±å“</strong>â€ŒDepthPrepasså¢åŠ Draw Callï¼Œå»ºè®®é™æ€ç‰©ä½“ä½¿ç”¨â€Œ<strong>Batchingé™æ€åˆæ‰¹</strong></li>
<li><strong>å¯ç”¨é™æ€åˆæ‰¹å…¨å±€è®¾ç½®â€Œ</strong>
<ul>
<li>â€Œ<strong>è·¯å¾„</strong>â€Œï¼š<code>Edit &gt; Project Settings &gt; Player</code></li>
<li>â€Œ<strong>æ“ä½œ</strong>â€Œï¼šåœ¨<code>Other Settings</code>é¢æ¿ä¸­å‹¾é€‰â€Œ<strong>Static Batching</strong>â€Œé€‰é¡¹</li>
<li>â€Œ<strong>ä½œç”¨</strong>â€Œï¼šå…è®¸Unityåœ¨æ„å»ºæ—¶åˆå¹¶é™æ€ç‰©ä½“çš„ç½‘æ ¼æ•°æ®ï¼Œå‡å°‘è¿è¡Œæ—¶Draw Callæ•°é‡</li>
</ul>
</li>
<li><strong>æ ‡è®°é™æ€ç‰©ä½“â€Œ</strong>
<ul>
<li>é€‰ä¸­åœºæ™¯ä¸­çš„é™æ€ç‰©ä½“</li>
<li>åœ¨Inspectorçª—å£å³ä¸Šè§’ç‚¹å‡»â€Œ<strong>Static</strong>â€Œä¸‹æ‹‰èœå•</li>
<li>å‹¾é€‰â€Œ<strong>Batching Static</strong>â€Œé€‰é¡¹ï¼ˆè‹¥ä»…éœ€åˆæ‰¹å¯ä¸å‹¾é€‰å…¶ä»–Staticé€‰é¡¹ï¼‰</li>
<li>â€Œ<strong>æ³¨æ„</strong>â€Œï¼šæ ‡è®°ä¸ºé™æ€çš„ç‰©ä½“å°†æ— æ³•åœ¨è¿è¡Œæ—¶ç§»åŠ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´åˆæ‰¹å¤±æ•ˆ</li>
</ul>
</li>
<li><strong>Shaderå…¼å®¹æ€§æ£€æŸ¥â€Œ</strong>
<ul>
<li>â€Œ<strong>è¦æ±‚</strong>â€Œï¼šé™æ€ç‰©ä½“éœ€ä½¿ç”¨â€Œ<strong>ç›¸åŒShaderå˜ä½“</strong>â€Œï¼Œä¸”æè´¨å±æ€§ç»“æ„ä¸€è‡´</li>
<li>â€Œ<strong>éªŒè¯</strong>â€Œï¼šé€šè¿‡<code>Frame Debugger</code>æ£€æŸ¥åˆæ‰¹æ•ˆæœï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨â€Œ<strong>SRP Batch</strong>â€Œæˆ–â€Œ<strong>Static Batch</strong>â€Œæ¡ç›®</li>
<li><strong>SRP Batcherä¼˜å…ˆçº§</strong>â€Œï¼šè‹¥åŒæ—¶å¯ç”¨SRP Batcherï¼Œå…¶ä¼˜å…ˆçº§é«˜äºé™æ€åˆæ‰¹ï¼Œéœ€ç¡®ä¿Shaderä»£ç å…¼å®¹SRP Batcherï¼ˆå¦‚é¿å…ä½¿ç”¨MaterialPropertyBlockï¼‰</li>
<li>â€Œ<strong>GPU Instancing</strong>â€Œï¼šå¯¹é‡å¤é™æ€ç‰©ä½“ï¼ˆå¦‚æ¤è¢«ï¼‰å¯å¯ç”¨GPU Instancingï¼Œè¿›ä¸€æ­¥å‡å°‘Draw Call</li>
</ul>
</li>
<li><strong>æ€§èƒ½éªŒè¯ä¸è°ƒè¯•â€Œ</strong>
<ul>
<li>â€Œ<strong>å·¥å…·</strong>â€Œï¼šä½¿ç”¨<code>Window &gt; Analysis &gt; Frame Debugger</code>
<ul>
<li>æ£€æŸ¥â€Œ<strong>DepthPrepass</strong>â€Œé€šé“çš„Draw Callæ•°é‡</li>
<li>ç¡®è®¤é™æ€ç‰©ä½“æ˜¯å¦åˆå¹¶ä¸ºâ€Œ<strong>StaticBatch</strong>â€Œæ¡ç›®</li>
</ul>
</li>
<li>â€Œ<strong>æŒ‡æ ‡</strong>â€Œï¼šé‡ç‚¹å…³æ³¨â€Œ<strong>SetPass Call</strong>â€Œçš„å‡å°‘æƒ…å†µï¼Œè€Œéä»…Draw Callæ•°é‡</li>
</ul>
</li>
<li><strong>æ³¨æ„äº‹é¡¹</strong>
<ul>
<li>â€Œ<strong>å¹³å°å·®å¼‚</strong>â€Œï¼šOpenGLç­‰å¹³å°éœ€å¤„ç†æ·±åº¦å€¼èŒƒå›´ï¼ˆ<code>UNITY_REVERSED_Z</code>ï¼‰</li>
<li>â€Œ<strong>åŠ¨æ€ç‰©ä½“</strong>â€Œï¼šè‹¥åœºæ™¯å«åŠ¨æ€ç‰©ä½“ï¼Œéœ€é€šè¿‡CopyDepthæ¨¡å¼å•ç‹¬å¤„ç†å…¶æ·±åº¦ï¼Œé¿å…ä¸é™æ€åˆæ‰¹å†²çª</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="åŠ¨æ€ç‰©ä½“ä½¿ç”¨copydepthæ¨¡å¼">åŠ¨æ€ç‰©ä½“ä½¿ç”¨CopyDepthæ¨¡å¼</h3>
<ul>
<li>
<p>â€Œ<strong>Shaderé˜Ÿåˆ—è¦æ±‚</strong>â€Œ</p>
<p>åŠ¨æ€ç‰©ä½“Shaderéœ€ä½¿ç”¨â€Œ<strong>ä¸é€æ˜æ¸²æŸ“é˜Ÿåˆ—</strong>â€Œï¼š</p>
<pre><code class="language-c">Tags {
  "Queue"="Geometry"  // åŠé€æ˜é˜Ÿåˆ—æ— æ³•ä½¿ç”¨æ·±åº¦å›¾
  "RenderType"="Opaque"
}
</code></pre>
</li>
<li>
<p>â€Œ<strong>æ·±åº¦é‡‡æ ·å£°æ˜</strong>â€Œ</p>
<p>åœ¨åŠ¨æ€ç‰©ä½“çš„Shaderä¸­æ˜¾å¼å£°æ˜æ·±åº¦çº¹ç†ï¼š</p>
<pre><code class="language-c">hlsl
TEXTURE2D(_CameraDepthTexture);
SAMPLER(sampler_CameraDepthTexture);
</code></pre>
</li>
<li>
<p>â€Œ<strong>æ‘„åƒæœºè®¾ç½®</strong>â€Œ</p>
<p>ç¡®ä¿åŠ¨æ€ç‰©ä½“æ‰€åœ¨æ‘„åƒæœºçš„æ¸²æŸ“è·¯å¾„ï¼š</p>
<pre><code class="language-c">csharpCopy Code
var cameraData = camera.GetUniversalAdditionalCameraData();
cameraData.requiresDepthTexture = true;// å¼ºåˆ¶æ·±åº¦çº¹ç†å¯ç”¨
</code></pre>
</li>
<li>
<p>â€Œ<strong>RenderPassä¼˜å…ˆçº§</strong>â€Œ</p>
<p>DepthPrepassé»˜è®¤åœ¨â€Œ<strong>é˜´å½±æ¸²æŸ“åæ‰§è¡Œ</strong>â€Œï¼Œä¼˜å…ˆäºCopyDepth Passã€‚åŠ¨æ€ç‰©ä½“æ·±åº¦é€šè¿‡åç»­çš„CopyDepth Passå¤åˆ¶åˆ°åŒä¸€<code>_CameraDepthTexture</code>ã€‚</p>
</li>
</ul>
<h3 id="éªŒè¯ä¸è°ƒè¯•"><strong>éªŒè¯ä¸è°ƒè¯•â€Œ</strong></h3>
<ul>
<li>
<p>â€Œ<strong>Frame Debuggeræ£€æŸ¥</strong>â€Œ</p>
<p>å¼€å¯<code>Window &gt; Analysis &gt; Frame Debugger</code>ï¼š</p>
<p>â†’ ç¡®è®¤å­˜åœ¨â€Œ<strong>DepthPrepass</strong>â€Œé€šé“ï¼ˆé™æ€ç‰©ä½“æ·±åº¦ï¼‰</p>
<p>â†’ æ£€æŸ¥â€Œ<strong>CopyDepth</strong>â€Œé€šé“æ˜¯å¦å¤„ç†åŠ¨æ€ç‰©ä½“æ·±åº¦</p>
</li>
<li>
<p>â€Œ<strong>æ·±åº¦å€¼æµ‹è¯•</strong>â€Œ</p>
<p>åœ¨Shaderä¸­è¾“å‡ºçº¿æ€§æ·±åº¦éªŒè¯ï¼š</p>
<pre><code class="language-c">hlsl
float depth = SampleSceneDepth(uv);
depth = Linear01Depth(depth, _ZBufferParams);
return float4(depth.xxx, 1); // ç°åº¦å›¾æ˜¾ç¤ºæ·±åº¦
</code></pre>
</li>
</ul>
<h3 id="æ³¨æ„äº‹é¡¹-1"><strong>æ³¨æ„äº‹é¡¹</strong></h3>
<ul>
<li>â€Œ<strong>å¹³å°å…¼å®¹æ€§</strong>â€ŒOpenGLå¹³å°éœ€ç‰¹æ®Šå¤„ç†æ·±åº¦å€¼èŒƒå›´ï¼ˆ<code>UNITY_REVERSED_Z</code>å®åˆ¤æ–­ï¼‰ã€‚â€Œ</li>
</ul>
<h2 id="å†…å­˜æ§åˆ¶"><strong>å†…å­˜æ§åˆ¶</strong></h2>
<ul>
<li>æŒ‰éœ€å¼€å¯_CameraDepthTexture</li>
<li>é¿å…å¤šPassé‡å¤é‡‡æ ·</li>
</ul>
<hr>
<blockquote>
<p><a href="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" target="_blank" rel="noopener nofollow">ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘</a><strong>ä¸“æ -ç›´è¾¾</strong></p>
</blockquote>
<p>ï¼ˆæ¬¢è¿<em>ç‚¹èµç•™è¨€</em>æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.004861111111111111" data-date-updated="2025-08-24 20:55">2025-08-24 20:48</span>&nbsp;
<a href="https://www.cnblogs.com/SmalBox">SmalBox</a>&nbsp;
é˜…è¯»(<span id="post_view_count">6</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19055858);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19055858', targetLink: 'https://www.cnblogs.com/SmalBox/p/19055858', title: 'ã€æ¸²æŸ“æµæ°´çº¿ã€‘[é€ç‰‡å…ƒé˜¶æ®µ]-[æ·±åº¦æµ‹è¯•]ä»¥UnityURPä¸ºä¾‹' })">ä¸¾æŠ¥</a>
</div>
        