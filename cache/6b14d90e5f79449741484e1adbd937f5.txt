
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/shuchen007/p/18660983" title="发布于 2025-01-09 09:04">
    <span role="heading" aria-level="2">【BUG排查记】HttpUtil和SpringSecurity结合的坑</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<h1 class="heading-1 ace-line old-record-id-QYEQdCWaNoBlvXxXhQicwBugnhe"><span style="background-color: rgba(204, 255, 255, 1)">一、背景</span></h1>
<div class="ace-line ace-line old-record-id-UYwNdypmKonxmvxpEZKc9Vjpnhg">　　　最近为了做微服务高可用和优化上线流程，我参与了一个微服务的改造开发。</div>
<div class="ace-line ace-line old-record-id-XBntdhQvmoBuM8xz0C5cXYfHnvh">　　　主要包括redis切换哨兵模式、接入高可用xxljob集群、配置和升级脚本优化。</div>
<div class="ace-line ace-line old-record-id-HuUGdils9oxwLtxLrgRcxYbInlc">
<h1 class="heading-1"><span style="background-color: rgba(204, 255, 255, 1)">二、问题描述</span></h1>
<div>
<div class="ace-line ace-line old-record-id-PnL7d3RRUo6NlVxogjJcg1Z2n1g">&nbsp;&nbsp;项目改造提测后，测试发现一个依赖远程http调用的功能不可用</div>
</div>
</div>
<div class="ace-line ace-line old-record-id-ZZwBdHm3coIgZNxz2etcwftWnDh">
<h1 class="heading-1"><span style="background-color: rgba(204, 255, 255, 1)">三、问题分析</span></h1>
<div>
<div class="ace-line text-indent ace-line old-record-id-ZYmIdElojoPbJOxhp9ycPMrJnJb">&nbsp;&nbsp;查看被调用方日志发现通用Token解析错误如下图</div>
<div class="image-uploaded gallery old-record-id-FouNdT98EohNhoxvVcFcwLg2nFe" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;605ff4d4-c184-46f5-99e2-79a5f16c3e80&quot;,&quot;height&quot;:86,&quot;width&quot;:860,&quot;currHeight&quot;:86,&quot;currWidth&quot;:860,&quot;natrualHeight&quot;:86,&quot;natrualWidth&quot;:860,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FN6cbb8mp9oyqdxxEj0mcmvo8npR%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;N6cbb8mp9oyqdxxEj0mcmvo8npR&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:83376,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-FouNdT98EohNhoxvVcFcwLg2nFe" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;751415cc-64a7-48ad-bc91-c8bfad34f9e3&quot;,&quot;height&quot;:86,&quot;width&quot;:860,&quot;currHeight&quot;:86,&quot;currWidth&quot;:860,&quot;natrualHeight&quot;:86,&quot;natrualWidth&quot;:860,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FN6cbb8mp9oyqdxxEj0mcmvo8npR%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;N6cbb8mp9oyqdxxEj0mcmvo8npR&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:83376,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109110905889-626493354.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line ace-line old-record-id-HpkvdnWIOonMfGxQ5mJcxJeonYc">&nbsp;</div>
<div class="ace-line ace-line old-record-id-HpkvdnWIOonMfGxQ5mJcxJeonYc">说明调用时传入了错误的Token，查看调用方代码：</div>
</div>
</div>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)"># 使用hutool工具发起远程http请求
HashMap</span>&lt;String, String&gt; headers =<span style="color: rgba(0, 0, 0, 1)"> getHeader(modelSyncGitDto);
HttpRequest request </span>=<span style="color: rgba(0, 0, 0, 1)"> HttpUtil.createRequest(Method.POST, url);
HttpResponse execute </span>=<span style="color: rgba(0, 0, 0, 1)"> request
        .addHeaders(headers)
        .timeout(</span>2000<span style="color: rgba(0, 0, 0, 1)">)
        .body(JSONUtil.toJsonStr(modelSyncGitDto))
        .execute();
# 通用工具生成jwt token放入header
</span><span style="color: rgba(0, 0, 255, 1)">private</span> HashMap&lt;String, String&gt;<span style="color: rgba(0, 0, 0, 1)"> getHeader(ModelSyncGitDto modelSyncGitDto){
    String userJwtToken </span>= JwtUtils.getJwtToken(filterConfig.getAcSecret(),<span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">,modelSyncGitDto.getComputerUserName(),modelSyncGitDto.getOsName());
    HashMap</span>&lt;String, String&gt; headers = <span style="color: rgba(0, 0, 255, 1)">new</span> HashMap&lt;&gt;(200<span style="color: rgba(0, 0, 0, 1)">);
    headers.put(</span>"Token"<span style="color: rgba(0, 0, 0, 1)">, userJwtToken);
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> headers;
}</span></pre>
</div>
<p>&nbsp;</p>
<div class="ace-line text-indent ace-line old-record-id-ZKz8dxpfNo81RMxZEkucZTugnvg">以上调用代码无问题，继续排查被调用方解析token的代码</div>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)"># 被调用方获取token
String token </span>=<span style="color: rgba(0, 0, 0, 1)"> CookieUtils.resolveCookie(request, tokenKey);
</span><span style="color: rgba(0, 0, 255, 1)">if</span> (Objects.isNull(token) ||<span style="color: rgba(0, 0, 0, 1)"> token.isBlank()){
    token </span>=<span style="color: rgba(0, 0, 0, 1)"> request.getHeader(tokenKey);
}
</span><span style="color: rgba(0, 0, 255, 1)">if</span> (Objects.isNull(token) ||<span style="color: rgba(0, 0, 0, 1)"> token.isBlank()){
    token </span>=<span style="color: rgba(0, 0, 0, 1)"> request.getParameter(tokenKey);
}
</span><span style="color: rgba(0, 0, 255, 1)">return</span> token;</pre>
</div>
<p>&nbsp;</p>
<div class="ace-line text-indent ace-line old-record-id-MrHGdWjejo4tUdxlHwHcYOvEnXf">发现被调用方优先从cookie获取代码，未从header获取对应Token；</div>
<div class="ace-line text-indent ace-line old-record-id-RwWndsunroicwRx4e4eccVtfnUf">调用方未设置cookie，怀疑是请求后response缓存带的。增加调用方日志查看</div>
<div class="cnblogs_code">
<pre>log.info("http请求返回，cookie={}", execute.getCookies());</pre>
</div>
<div class="image-uploaded gallery old-record-id-XzVNdhPQKo7fjGxDxTWctOcnnhh" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;c0b34add-9b27-44cc-a208-1578b933e300&quot;,&quot;height&quot;:35,&quot;width&quot;:755,&quot;currHeight&quot;:35,&quot;currWidth&quot;:755,&quot;natrualHeight&quot;:35,&quot;natrualWidth&quot;:755,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FKaCibCITsoimMwxeciEctIV0nKh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;KaCibCITsoimMwxeciEctIV0nKh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:5906,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-XzVNdhPQKo7fjGxDxTWctOcnnhh" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;5e648d26-58ee-488f-a061-ee9d362b4e7b&quot;,&quot;height&quot;:35,&quot;width&quot;:755,&quot;currHeight&quot;:35,&quot;currWidth&quot;:755,&quot;natrualHeight&quot;:35,&quot;natrualWidth&quot;:755,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FKaCibCITsoimMwxeciEctIV0nKh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;KaCibCITsoimMwxeciEctIV0nKh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:5906,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109110918880-187737579.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line text-indent ace-line old-record-id-ObqmdmbU4oEWG5xI06Sc2aMRn4d">请求返回后在response设置了cookie，但每次请求都是<em>createRequest，理论不会携带cookie。添加disableCookie验证一下：</em></div>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)"># 创建request增加禁用cookie
HttpRequest request </span>=<span style="color: rgba(0, 0, 0, 1)"> HttpUtil.createRequest(Method.POST, url);
HttpResponse execute </span>=<span style="color: rgba(0, 0, 0, 1)"> request
        .disableCookie()
        .addHeaders(headers)
        .timeout(</span>2000<span style="color: rgba(0, 0, 0, 1)">)
        .body(JSONUtil.toJsonStr(modelSyncGitDto))
        .execute();</span></pre>
</div>
<p>&nbsp;</p>
<div class="ace-line ace-line old-record-id-GERPdh0zyoDSZrx7ogVcHOc0njd">发布后恢复正常，说明请求携带了cookie信息。</div>
<div class="ace-line ace-line old-record-id-P2Bjdt5O7oCEAIxdBfYcGADbnJc">后期查看文档hutool的HttpUtil的确有这么一个缓存cookie的问题，参考</div>
<div class="image-uploaded gallery old-record-id-ETkXdmibeoXdoQxJL3wcmxUtnfd" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;cc55058f-c799-4937-8e85-07231d9a19b1&quot;,&quot;height&quot;:1893,&quot;width&quot;:1686,&quot;currHeight&quot;:1893,&quot;currWidth&quot;:1686,&quot;natrualHeight&quot;:1893,&quot;natrualWidth&quot;:1686,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FRNv8b8sCwoDDFbxmakOcd50xnZc%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;RNv8b8sCwoDDFbxmakOcd50xnZc&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:286529,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-ETkXdmibeoXdoQxJL3wcmxUtnfd" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;fb0a26eb-4b86-4050-9170-9911354f22c7&quot;,&quot;height&quot;:1893,&quot;width&quot;:1686,&quot;currHeight&quot;:1893,&quot;currWidth&quot;:1686,&quot;natrualHeight&quot;:1893,&quot;natrualWidth&quot;:1686,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FRNv8b8sCwoDDFbxmakOcd50xnZc%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;RNv8b8sCwoDDFbxmakOcd50xnZc&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:286529,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109110935039-795472700.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line ace-line old-record-id-FIbNdIRZVoz8oxxEttDcAQ2ynye"><a href="https://github.com/dromara/hutool/issues/583" target="_blank" rel="noopener nofollow">https://github.com/dromara/hutool/issues/583</a></div>
<h1 class="heading-1 ace-line old-record-id-V8OMdV6pooi8NJxhROecsE6QnXb">&nbsp;</h1>
<h1 class="heading-1 ace-line old-record-id-V8OMdV6pooi8NJxhROecsE6QnXb"><span style="background-color: rgba(204, 255, 255, 1)">四、梅开二度</span></h1>
<div class="ace-line text-indent ace-line old-record-id-BiTydgwb1oMSLvx8dphcW2sPnwg">　　提交代码并告诉测试妹纸“修复好了”。测试验证的确无问题，但遭到测试妹纸的灵魂拷问：</div>
<div class="ace-line ace-line old-record-id-ZdRCd9uL5oV6P8x4exwc259engg">“线上为啥没问题，这次版本不允许夹杂额外代码上线”。</div>
<div class="ace-line text-indent ace-line old-record-id-EzMFdF8SnoEXgGx5DYwckAggnxb">　　的确，还是要找到问题的原因。</div>
<h2 class="heading-2 ace-line old-record-id-PzxmdWAinosuszxAIJlcUqPunJC">4.1 配置对比</h2>
<div class="ace-line text-indent ace-line old-record-id-CeJzdTV8iofAv9x2QZkcQu41nkb">通过对比线上配置，发现被调用方的common依赖引入了</div>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">server:
  servlet:
    session:
      # session超时时间，不能小于1分钟
      timeout: 481m
      # 浏览器 Cookie 中 SessionID 名称
      cookie:
        name: Token
        path: </span>/<span style="color: rgba(0, 0, 0, 1)">
      tracking</span>-modes: COOKIE</pre>
</div>
<p>&nbsp;</p>
<div class="ace-line ace-line old-record-id-RZgDdsRnZoq1Btx97aacIgPLnbe">以上配置指定了cookie key为Token，且过期时间为8小时；去掉被调用方以上配置，调用方请求打印cookie如下；</div>
<div class="ace-line ace-line old-record-id-C4Zzd7QhXoOaGzxoublcGaLCnue"><em><strong>无server.servlet.session配置：</strong></em></div>
<div class="image-uploaded gallery old-record-id-VkDOdTwy5oxB8hxxJYMcdf4NnCe" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;af63c812-d42d-4b4d-ae3c-c40978f2b203&quot;,&quot;height&quot;:33,&quot;width&quot;:497,&quot;currHeight&quot;:33,&quot;currWidth&quot;:497,&quot;natrualHeight&quot;:33,&quot;natrualWidth&quot;:497,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FG2kabhmAcoLImDxCbbCc9e9vn4L%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;G2kabhmAcoLImDxCbbCc9e9vn4L&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:10265,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-VkDOdTwy5oxB8hxxJYMcdf4NnCe" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;fc1d6bbd-5601-423b-9834-c5ed5cd8d81a&quot;,&quot;height&quot;:33,&quot;width&quot;:497,&quot;currHeight&quot;:33,&quot;currWidth&quot;:497,&quot;natrualHeight&quot;:33,&quot;natrualWidth&quot;:497,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FG2kabhmAcoLImDxCbbCc9e9vn4L%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;G2kabhmAcoLImDxCbbCc9e9vn4L&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:10265,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109110946038-640852371.png" alt=""></div>
</div>
</div>
<div class="ace-line text-indent ace-line old-record-id-Kt6wduf9Ho3wDNxRgqycDZy8nBy">说明被调用方spring security默认会将Cookie设置在当前应用所在的域下放置SESSION。</div>
<h2 class="heading-2 ace-line old-record-id-QREfdYIfIorLuRxdQJ0c9Z0hnFc">4.2 二次请求</h2>
<div class="ace-line ace-line old-record-id-XxiNdR6GQoqyd3x0zUbcllDpnDd"><em><strong>无server.servlet.session配置：</strong></em></div>
<div class="image-uploaded gallery old-record-id-WFKidtvBhoYNhpxat5rcRqdVnrh" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;868be059-4ce4-4bf8-98d8-70f6c41c2e9a&quot;,&quot;height&quot;:59,&quot;width&quot;:1622,&quot;currHeight&quot;:59,&quot;currWidth&quot;:1622,&quot;natrualHeight&quot;:59,&quot;natrualWidth&quot;:1622,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FAIHJbUwdVoSsyBxAm6QctN5Gngh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;AIHJbUwdVoSsyBxAm6QctN5Gngh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:20630,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-WFKidtvBhoYNhpxat5rcRqdVnrh" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;814b16b5-d731-4eb8-add5-5ae5ccbaaf5a&quot;,&quot;height&quot;:59,&quot;width&quot;:1622,&quot;currHeight&quot;:59,&quot;currWidth&quot;:1622,&quot;natrualHeight&quot;:59,&quot;natrualWidth&quot;:1622,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FAIHJbUwdVoSsyBxAm6QctN5Gngh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;AIHJbUwdVoSsyBxAm6QctN5Gngh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:20630,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109111001097-269097180.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line ace-line old-record-id-GilqdbVqLoygGmxsYckcosGYnte">cookie中返回了SEESION和Token，初步怀疑是缓存返回导致；</div>
<h2 class="heading-2 ace-line old-record-id-FH89dR94loJSmCxssYWcAMD4nJf">4.2 日志对比</h2>
<div class="ace-line text-indent ace-line old-record-id-C4mWdogsWoqgPBx0kyGccjv2nDd">相同代码，通过对比其他环境调用方打印的日志，方向无论有无<em><strong>server.servlet.session</strong></em>配置，返回的response都为空</div>
<div class="image-uploaded gallery old-record-id-RZBydLhSMo0VRjxY0IHcWQ7AnZf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;d395e62c-f6ec-4dd6-bbfa-2b700b3805ed&quot;,&quot;height&quot;:36,&quot;width&quot;:359,&quot;currHeight&quot;:36,&quot;currWidth&quot;:359,&quot;natrualHeight&quot;:36,&quot;natrualWidth&quot;:359,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FXZ6hbrW8YoAtV6xNfaAcWRIynGh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;XZ6hbrW8YoAtV6xNfaAcWRIynGh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:2461,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-RZBydLhSMo0VRjxY0IHcWQ7AnZf" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;62afa5b6-6883-4393-bcbd-30b2b26ae0fd&quot;,&quot;height&quot;:36,&quot;width&quot;:359,&quot;currHeight&quot;:36,&quot;currWidth&quot;:359,&quot;natrualHeight&quot;:36,&quot;natrualWidth&quot;:359,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FXZ6hbrW8YoAtV6xNfaAcWRIynGh%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;XZ6hbrW8YoAtV6xNfaAcWRIynGh&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:2461,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109111016060-120697125.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line text-indent ace-line old-record-id-TlzbdciF1oHW2uxxpBFcYBZAnlb">说明还是代码配置问题。</div>
<h2 class="heading-2 ace-line old-record-id-A933d6OXJowlhBxTkZzcH4vHnfh">4.3 终极原因</h2>
<div class="ace-line text-indent ace-line old-record-id-CYMhdfanXo3E2txszkLcMdspnb5">当调用方请求被调用方时，配置的ip不是localhost、127.0.0.1、节点IP时，请求调用返回的response都不会携带cookie。</div>
<div class="image-uploaded gallery old-record-id-CvdtdNYbooanXIxyPKgcLdJQnth" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;a6232d9b-5fe5-4bfd-841c-187b86fbdffe&quot;,&quot;height&quot;:30,&quot;width&quot;:345,&quot;currHeight&quot;:30,&quot;currWidth&quot;:345,&quot;natrualHeight&quot;:30,&quot;natrualWidth&quot;:345,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FSJKybzBStoc0YxxnjtAcoq5nnib%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;SJKybzBStoc0YxxnjtAcoq5nnib&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:1971,&quot;comments&quot;:[]}]}">
<div data-page-id="S1KBdMIgRoG7cSxMeWgc4xTHngb" data-lark-html-role="root" data-docx-has-block-data="true">
<div class="image-uploaded gallery old-record-id-CvdtdNYbooanXIxyPKgcLdJQnth" data-type="image" data-ace-gallery-json="{&quot;items&quot;:[{&quot;uuid&quot;:&quot;81a13ced-0043-4098-b11f-110c85b4a829&quot;,&quot;height&quot;:30,&quot;width&quot;:345,&quot;currHeight&quot;:30,&quot;currWidth&quot;:345,&quot;natrualHeight&quot;:30,&quot;natrualWidth&quot;:345,&quot;pluginName&quot;:&quot;imageUpload&quot;,&quot;scale&quot;:1,&quot;src&quot;:&quot;https%3A%2F%2Finternal-api-drive-stream.feishu.cn%2Fspace%2Fapi%2Fbox%2Fstream%2Fdownload%2Fpreview%2FSJKybzBStoc0YxxnjtAcoq5nnib%2F%3Fpreview_type%3D16&quot;,&quot;file_token&quot;:&quot;SJKybzBStoc0YxxnjtAcoq5nnib&quot;,&quot;image_type&quot;:&quot;image/png&quot;,&quot;size&quot;:1971,&quot;comments&quot;:[]}]}"><img src="https://img2024.cnblogs.com/blog/1076066/202501/1076066-20250109111023784-942334188.png" alt="">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="ace-line ace-line old-record-id-G3hFdlmmIoMkjLxeGc7cQ0fbnih">HttpUtil通过配置请求ip，cookie跨域导致cookie无法保存，也无法携带。</div>
<div class="ace-line text-indent ace-line old-record-id-JAJJdByCfoltQsxMLMkczxVBnub">线上httpUtl发起的请求ip为另一台服务器nginx地址，返回的response无cookie。</div>
<h1 class="heading-1 ace-line old-record-id-Wf26dfO8MoK9ZXxb6qycMWvznUe"><span style="background-color: rgba(204, 255, 255, 1)">五、总结</span></h1>
<div class="ace-line text-indent ace-line old-record-id-BToUdN5X0osf2wxJUxcc1l03nnf">以上问题原因为2个导致：</div>
<ol class="list-number1" start="1">
<li class="ace-line ace-line old-record-id-NIoGdXRtDor2wsxtvqvcsEztnxe" data-list="number">本版本hutool的HttpUtil请求缓存了上一次请求的cookie，并在下一次携带；</li>
<li class="ace-line ace-line old-record-id-ZQwzdneh8oMnBcx5r6ncb8oWnwh" data-list="number">Spring Security 默认会将Cookie设置在当前应用所在的域下，即localhost。请求方也为localhost所在节点，由于http同源策略，导致返回的response中存在cookie。</li>
</ol>
<div class="ace-line ace-line old-record-id-Ikpedb8GBo8aPFxkG5VcyQban2d">&nbsp;</div>
<div class="ace-line ace-line old-record-id-STfQdSg75oyYX6xID7Ec1VUgnng">&nbsp;</div>
</div>
</div>
<div id="MySignature" role="contentinfo">
    <b>1、将通过毅力完成的事转化为习惯。<br>
2、清心寡欲、方能高枕无忧。<br>
  3、纸上得来终觉浅，绝知此事要躬行。<br>

<p id="signName">种一棵树最好的时间是 十年前。    其次是， 现在！</p></b>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.31857392587037037" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-09 11:10">2025-01-09 09:04</span>&nbsp;
<a href="https://www.cnblogs.com/shuchen007">书晨007</a>&nbsp;
阅读(<span id="post_view_count">153</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18660983" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18660983);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18660983', targetLink: 'https://www.cnblogs.com/shuchen007/p/18660983', title: '【BUG排查记】HttpUtil和SpringSecurity结合的坑' })">举报</a>
</div>
        