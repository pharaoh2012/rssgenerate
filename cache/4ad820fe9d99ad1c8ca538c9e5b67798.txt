
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/april-code/p/18814698" title="å‘å¸ƒäº 2025-04-08 14:48">
    <span role="heading" aria-level="2">è®°å½•-å†…ç½‘éƒ¨ç½²vllmåˆ†å¸ƒå¼æ¨ç†DeepSeekR1:70b</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>å‰æ®µæ—¶é—´æ¥åˆ°éœ€æ±‚è¦åœ¨å†…ç½‘éƒ¨ç½²DeepSeekR1:70bï¼Œç”±äºæ‰‹é‡Œçš„æœåŠ¡å™¨å’Œæ˜¾å¡æ¯”è¾ƒå·®ï¼ˆå››å° å››å—Tesla T4- 16gæ˜¾å­˜çš„æœåŠ¡å™¨ï¼‰ï¼Œå…ˆåå°è¯•äº†ollamaã€vllmã€llamacppç­‰ï¼Œæœ€åé€‰æ‹©ç”¨vllmçš„åˆ†å¸ƒå¼æ¨ç†æ¥éƒ¨ç½²ã€‚</p>
<h2 id="éœ€è¦å‡†å¤‡çš„èµ„æº">éœ€è¦å‡†å¤‡çš„èµ„æº</h2>
<ol>
<li>vllmçš„dockeré•œåƒï¼ˆå¯ä»¥ä»docker hub ä¸‹è½½ï¼Œä½¿ç”¨docker save -oå‘½ä»¤ä¿å­˜æ‹¿åˆ°å†…ç½‘æœåŠ¡å™¨ä¸­ï¼‰</li>
<li>run_cluster.shè„šæœ¬ï¼ˆç”¨æ¥å¯åŠ¨dockeré•œåƒå’Œè¿›è¡Œrayé€šä¿¡ï¼Œä¸‹é¢ä¼šè´´ä¸Šæˆ‘ç›®å‰åœ¨ç”¨çš„ç‰ˆæœ¬ï¼‰</li>
<li>æ¨¡å‹æ–‡ä»¶ï¼ˆhuggingfaceä¸‹è½½ï¼Œå›½å†…å¯ä»¥ç”¨hf-mirroré•œåƒç«™ï¼‰ï¼Œéœ€è¦ä¸‹è½½åˆ°æ‰€æœ‰åˆ†å¸ƒå¼æœºå™¨çš„ç£ç›˜ä¸­ï¼Œæœ€å¥½ä¿æŒå­˜å‚¨è·¯å¾„ä¸€è‡´ã€‚</li>
<li>nvidiaé©±åŠ¨ã€cudaç­‰æ˜¯å¿…å¤‡çš„ï¼Œä¸æäº†</li>
</ol>
<h2 id="éƒ¨ç½²è¿‡ç¨‹">éƒ¨ç½²è¿‡ç¨‹</h2>
<ol>
<li>
<p>è½½å…¥vllmçš„dockeré•œåƒ<br>
docker load -i vllm.tar</p>
</li>
<li>
<p>ç¼–å†™è„šæœ¬vi run_cluster.sh<br>
æ‰€æœ‰æœºå™¨éƒ½ä½¿ç”¨å¦‚ä¸‹è„šæœ¬</p>
</li>
</ol>
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ä»£ç </summary>
<pre><code>``#!/bin/bash

# Check for minimum number of required arguments
if [ $# -lt 4 ]; then
    echo "Usage: $0 docker_image head_node_address --head|--worker path_to_hf_home [additional_args...]"
    exit 1
fi

DOCKER_IMAGE="$1"
HEAD_NODE_ADDRESS="$2"
NODE_TYPE="$3"  # Should be --head or --worker
PATH_TO_HF_HOME="$4"
shift 4

# Additional arguments are passed directly to the Docker command
ADDITIONAL_ARGS=("$@")

# Validate node type
if [ "${NODE_TYPE}" != "--head" ] &amp;&amp; [ "${NODE_TYPE}" != "--worker" ]; then
    echo "Error: Node type must be --head or --worker"
    exit 1
fi

# Define a function to cleanup on EXIT signal
cleanup() {
    docker stop node
    docker rm node
}
trap cleanup EXIT

# Command setup for head or worker node
RAY_START_CMD="ray start --block"
if [ "${NODE_TYPE}" == "--head" ]; then
    RAY_START_CMD+=" --head --port=6379"
else
    RAY_START_CMD+=" --address=${HEAD_NODE_ADDRESS}:6379"
fi

# Run the docker command with the user specified parameters and additional arguments
#docker run \
   # -d \
    #   --entrypoint /bin/bash \

docker run \
    --entrypoint /bin/bash \
    --network host \
    --name node \
    --shm-size 10.24g \
    --gpus all \
    -v "${PATH_TO_HF_HOME}:/root/.cache/huggingface" \
    "${ADDITIONAL_ARGS[@]}" \
    "${DOCKER_IMAGE}" -c "${RAY_START_CMD}"
</code></pre>
</details>
<ol start="3">
<li>
<p>æŸ¥çœ‹ç½‘å¡ä¿¡æ¯<br>
è¾“å…¥ip a<br>
æ‰¾åˆ°è¿™å°æœºå™¨å¯¹åº”çš„ç¼–å·ï¼Œç”¨åœ¨ä¹‹åçš„å¯åŠ¨å‘½ä»¤ä¸­<br>
<img src="https://img2024.cnblogs.com/blog/2715357/202503/2715357-20250306165551224-1930537653.png" alt="" loading="lazy"></p>
</li>
<li>
<p>å¯åŠ¨è„šæœ¬ï¼ˆæ¯å°æœºå™¨éƒ½éœ€è¦å¯åŠ¨ï¼Œé€‰æ‹©ä»»æ„ä¸€å°ä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–ä¸ºå·¥ä½œèŠ‚ç‚¹ï¼‰<br>
å¯åŠ¨å‘½ä»¤ï¼šï¼ˆ --headä¸ºä¸»æœº  --workerä¸ºå…¶ä»–æœºå™¨ä½¿ç”¨ï¼Œå‘½ä»¤ä¸­çš„ipéƒ½éœ€è¦å¡«å†™ä¸»æœºçš„ipï¼‰<br>
<strong>ä¸»æœºè„šæœ¬</strong> bash run_cluster.sh    vllm/vllm-openai:v0.6.4.post1  ä¸»æœºip --head /data/vllm_model -v /data/vllm_model/:/model/ -e GLOO_SOCKET_IFNAME=ens13f0 -e NCCL_SOCKET_IFNAME=ens13f0<br>
<strong>å·¥ä½œæœºè„šæœ¬</strong> bash run_cluster.sh    vllm/vllm-openai:v0.6.4.post1  ä¸»æœºip --worker /data/vllm_model -v /data/vllm_model/:/model/ -e GLOO_SOCKET_IFNAME=ens13f0 -e NCCL_SOCKET_IFNAME=ens13f0<br>
<strong>åå°è¿è¡Œ</strong> ä¹Ÿå¯ä»¥é€šè¿‡nohupåå°è¿è¡Œï¼Œå¦‚ï¼šnohup bash run_cluster.sh    vllm/vllm-openai:v0.6.4.post1  ä¸»æœºip --worker /data/vllm_model -v /data/vllm_model/:/model/ -e GLOO_SOCKET_IFNAME=ens13f0 -e NCCL_SOCKET_IFNAME=ens13f0 &gt;/ray_file 2&gt;&amp;1 &amp;</p>
</li>
</ol>
<p>/data/vllm_modelä¸ºä½ æ¨¡å‹æ–‡ä»¶çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾åˆ™å¯åŠ¨æˆåŠŸ<br>
<img src="https://img2024.cnblogs.com/blog/2715357/202503/2715357-20250306170522154-889370253.png" alt="" loading="lazy"></p>
<ol start="5">
<li>
<p>æ‰€æœ‰éƒ½æˆåŠŸå¯åŠ¨åå¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€å°æœºå™¨çš„sshä¼šè¯ï¼Œå› ä¸ºå·²ç»é€šä¿¡ï¼Œæ‰€ä»¥å“ªå°æœºå™¨éƒ½å¯ä»¥å¯åŠ¨vllmã€‚æ³¨æ„ä¸è¦å…³é—­ä»»ä½•ä¸€å°æœºå™¨çš„run_clusterå¯åŠ¨çš„é¡µé¢ï¼Œ<br>
ä½¿ç”¨docker ps æŸ¥çœ‹è¿è¡Œçš„é•œåƒ<br>
è¿›å…¥é•œåƒå†…éƒ¨<br>
è¾“å…¥docker exec -it é•œåƒå· /bin/bashè¿›å…¥<br>
è¾“å…¥ray statuså¯ä»¥æŸ¥çœ‹å½“å‰é€šä¿¡çŠ¶æ€<br>
<img src="https://img2024.cnblogs.com/blog/2715357/202504/2715357-20250408111127947-2131626644.png" alt="" loading="lazy"></p>
</li>
<li>
<p>ç›´æ¥åœ¨dockerä¸­å¯åŠ¨vllm<br>
å‘½ä»¤ï¼švllm serve /model/DeepSeek-R1-Distill-Llama-70B     --tensor-parallel-size 4     --pipeline-parallel-size 4    --dtype=float16</p>
</li>
</ol>
<p>æ³¨ï¼šæˆ‘çš„vllmè¿è¡Œå‘½ä»¤ä¸­tensor-parallelå¯¹åº”æ¯å°æœåŠ¡å™¨çš„gpuæ•°ï¼Œpipeline-parallel-sizeå¯¹åº”æœåŠ¡å™¨æ•°ï¼Œ--dtype=float16è¿™ä¸ªç”±äºTesla T4è®¡ç®—ç²¾åº¦çš„é—®é¢˜éœ€è¦æ·»åŠ è¿™ä¸ªé…ç½®é™ä½æ¨¡å‹çš„ç²¾åº¦ï¼Œå¦‚æœæ˜¾å¡è®¡ç®—èƒ½åŠ›8.0ä»¥ä¸Šå¯ä»¥ä¸åŠ è¿™ä¸ªé…ç½®ã€‚å…³äºåˆ†å¸ƒå¼å¹¶è¡Œçš„å‚æ•°è¿™é‡Œåšä¸»æ²¡æœ‰æ·±ç©¶å«ä¹‰ï¼Œå¦‚æœæœ‰æ›´å¥½çš„ä½¿ç”¨æ–¹å¼ä¹Ÿå¯ä»¥äº¤æµä¸‹ã€‚</p>
<h2 id="å‚æ•°å«ä¹‰">å‚æ•°å«ä¹‰</h2>
<p>ğŸ”¹ --tensor-parallel-size<br>
è¿™ä¸ªå‚æ•°è¡¨ç¤º å¼ é‡å¹¶è¡Œï¼ˆTensor Parallelismï¼‰ çš„è§„æ¨¡ã€‚</p>
<p>å°†ä¸€ä¸ªç¥ç»ç½‘ç»œçš„ æƒé‡çŸ©é˜µ åˆ‡åˆ†åˆ°å¤šä¸ª GPU ä¸Šã€‚</p>
<p>é€šå¸¸ç”¨äºåˆ‡åˆ† Transformer ä¸­çš„ attention æˆ– FFN å±‚çš„æƒé‡ã€‚</p>
<p>ä¾‹å¦‚è®¾ç½®ä¸º 4ï¼Œæ„å‘³ç€ä¸€ä¸ª attention å±‚çš„è®¡ç®—ä¼šè¢«åˆ†æˆ 4 ä»½ï¼Œåœ¨ 4 ä¸ª GPU ä¸Šå¹¶è¡Œè¿›è¡Œã€‚</p>
<p>é€‚ç”¨äºå…·æœ‰è¾ƒå¤§æƒé‡çŸ©é˜µçš„æ¨¡å‹ï¼Œå¦‚ LLaMAã€GPT ç­‰ï¼Œèƒ½å……åˆ†åˆ©ç”¨å¤šä¸ª GPU çš„æ˜¾å­˜å’Œè®¡ç®—èµ„æºã€‚</p>
<p>ğŸ”¹ --pipeline-parallel-size<br>
è¿™ä¸ªå‚æ•°è¡¨ç¤º æµæ°´çº¿å¹¶è¡Œï¼ˆPipeline Parallelismï¼‰ çš„è§„æ¨¡ã€‚</p>
<p>å°†æ•´ä¸ªæ¨¡å‹çš„ ä¸åŒå±‚ åˆ†é…åˆ°ä¸åŒçš„ GPU ä¸Šï¼Œå½¢æˆä¸€ä¸ªâ€œæµæ°´çº¿â€ã€‚</p>
<p>æ¯ä¸ª GPU å¤„ç†æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åæŠŠç»“æœä¼ ç»™ä¸‹ä¸€ä¸ª GPUã€‚</p>
<p>è®¾ç½®ä¸º 2 è¡¨ç¤ºæ¨¡å‹è¢«åˆ†æˆ 2 æ®µï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ª GPU ä¸Šä¾æ¬¡è¿è¡Œã€‚</p>
<p>é€‚ç”¨äºæ¨¡å‹å±‚æ•°è¾ƒå¤šæ—¶è¿›ä¸€æ­¥æ‰©å±•æ¨¡å‹åˆ°æ›´å¤š GPU ä¸Šã€‚</p>

</div>
<div id="MySignature" role="contentinfo">
    <p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href="https://www.cnblogs.com/april-code/" target="_blank">æ—¥æŠ¥åˆçº§å¼€å‘å·¥ç¨‹å¸ˆ</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href="https://www.cnblogs.com/april-code/p/18814698" target="_blank">https://www.cnblogs.com/april-code/p/18814698</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.7630294105254629" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-08 14:49">2025-04-08 14:48</span>&nbsp;
<a href="https://www.cnblogs.com/april-code">æ—¥æŠ¥åˆçº§å¼€å‘å·¥ç¨‹å¸ˆ</a>&nbsp;
é˜…è¯»(<span id="post_view_count">199</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18814698" rel="nofollow">ç¼–è¾‘</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18814698);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18814698', targetLink: 'https://www.cnblogs.com/april-code/p/18814698', title: 'è®°å½•-å†…ç½‘éƒ¨ç½²vllmåˆ†å¸ƒå¼æ¨ç†DeepSeekR1:70b' })">ä¸¾æŠ¥</a>
</div>
        