
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zylAK/p/18884621" title="å‘å¸ƒäº 2025-05-19 17:47">
    <span role="heading" aria-level="2">âœ¨ç”Ÿç‰©å¤§è¯­è¨€æ¨¡å‹Evo2â€”â€”è§£ç åŸºå› å¯†ç çš„AIé©å‘½ğŸš€</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        æœ¬æ–‡æ·±å…¥è§£æç”Ÿç‰©å¤§è¯­è¨€æ¨¡å‹Evo2çš„Embeddingé­”æ³•â€”â€”é€šè¿‡æå–åŸºå› åºåˆ—çš„è¯­ä¹‰ç‰¹å¾ï¼Œç»“åˆæ·±åº¦ç¥ç»ç½‘ç»œï¼ˆDNNï¼‰ï¼ŒæˆåŠŸå°†BRCA1å•æ ¸è‹·é…¸çªå˜æ•ˆåº”é¢„æµ‹çš„AUROCä»0.7å·¦å³æå‡è‡³0.9å·¦å³ã€‚ä»NVIDIA NIMäº‘ç«¯éƒ¨ç½²åˆ°Auto-dlæœ¬åœ°ç¯å¢ƒæ­å»ºï¼Œä»Embeddingæ‰¹é‡æå–åˆ°DNNæ¨¡å‹ä¼˜åŒ–ï¼Œæä¾›å¼€ç®±å³ç”¨çš„ä»£ç ä¸é¿å‘æŒ‡å—ï¼Œä¸ºç”Ÿç‰©è®¡ç®—ç ”ç©¶è€…æ‰“å¼€"AI+åŸºå› "çš„åˆ›æ–°åº”ç”¨èŒƒå¼ã€‚
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h3>ğŸŒŸ 2025ï¼šç”Ÿç‰©AIçš„"DeepSeekæ—¶åˆ»"</h3>
<p>å½“æ•´ä¸ªä¸­æ–‡äº’è”ç½‘ä¸ºå›½äº§å¤§è¯­è¨€æ¨¡å‹DeepSeekæ¬¢å‘¼æ—¶ï¼Œç”Ÿå‘½ç§‘å­¦ç•Œæ­£æ‚„ç„¶æ€èµ·ä¸€åœºé™é»˜é©å‘½â€”â€”ç”±Arc Instituteé¢†è¡”ï¼Œæ–¯å¦ç¦ã€UC Berkeleyã€å“¥å¤§ã€UCSFæºæ‰‹è‹±ä¼Ÿè¾¾ç­‰é¡¶å°–AIä¼ä¸šï¼Œå…±åŒæ¨å‡ºç™¾äº¿å‚æ•°çº§ç”Ÿç‰©è¯­ä¹‰ç†è§£å¼•æ“Evo2ï¼è¿™ä¸ªèƒ½ç›´æ¥"è¯»æ‡‚"æ ¸è‹·é…¸è¯­è¨€çš„ç¥å¥‡æ¨¡å‹ï¼Œæ­£åœ¨é‡æ–°å®šä¹‰æˆ‘ä»¬å¯¹åŸºå› å¯†ç çš„è®¤çŸ¥æ–¹å¼ğŸ§¬</p>
<p>&nbsp;</p>
<p class="ds-markdown-paragraph">ğŸŒŸæ¨¡å‹äº®ç‚¹é€Ÿè§ˆï¼š</p>
<ul>
<li>
<p class="ds-markdown-paragraph">ğŸ§¬ ç›´æ¥è§£ææ ¸è‹·é…¸åºåˆ—çš„"ç”Ÿç‰©è¯­è¨€"</p>
</li>
<li>
<p class="ds-markdown-paragraph">ğŸš€ æ”¯æŒ8192é•¿åº¦ï¼ˆbaseæ¨¡å‹ï¼‰1 ç™¾ä¸‡ï¼ˆå®Œæ•´æ¨¡å‹ï¼‰è¶…é•¿åŸºå› ç‰‡æ®µå¤„ç†</p>
</li>
<li>
<p class="ds-markdown-paragraph">ğŸŒ è·¨ç‰©ç§åŸºå› ç†è§£èƒ½åŠ›å‡çº§</p>
</li>
<li>
<p class="ds-markdown-paragraph">ğŸ”“ å®Œå…¨å¼€æºï¼æ”¯æŒNVIDIA NIMäº‘ç«¯éƒ¨ç½²å’Œæœ¬åœ°è¿è¡Œ</p>
</li>
</ul>
<p class="ds-markdown-paragraph">ï¼ˆğŸ‘‰å°è´´å£«ï¼šæƒ³äº†è§£Evo1åˆ°Evo2çš„æ¶æ„é©å‘½ï¼Ÿå¿«åœ¨è¯„è®ºåŒºå‚¬æ›´æŠ€æœ¯è§£æä¸“é¢˜ï¼ï¼‰</p>
<p class="ds-markdown-paragraph">&nbsp;</p>
<p class="ds-markdown-paragraph">ğŸ”æœ¬æœŸå®æˆ˜ç›®æ ‡ï¼š</p>
<p>ã€€ã€€ğŸ› ï¸ ä»é›¶å¼€å§‹çš„ä¿å§†çº§æ•™ç¨‹</p>
<p>ã€€ã€€ğŸš€ç”¨Embedding+DNNå®ç°BRCA1çªå˜æ•ˆåº”é¢„æµ‹</p>
<p class="ds-markdown-paragraph">ã€€ã€€ğŸ“Šæ€§èƒ½é£è·ƒï¼šç›¸è¾ƒäºä»…ç”¨scoreå‡½æ•°å·®å€¼é¢„æµ‹çš„0.7 AUROCï¼ˆFairçº§ï¼‰ï¼ŒEmbedding+DNNæ–¹æ¡ˆç›´å†²0.9 AUROCï¼ˆGoodçº§ï¼‰ğŸ“ˆ</p>
<p>&nbsp;</p>
<p>&nbsp;âœ¨ å°è´´å£«ï¼š</p>
<p>æˆ‘ä»é›¶å¼€å§‹ï¼Œç§Ÿç”¨æ–°çš„Auto-dlæœåŠ¡å™¨ï¼Œæ­å»ºç¯å¢ƒï¼Œé‡è·‘codeï¼Œä»¥ä¿è¯æ¯ä¸ªæ–°æ‰‹å°ç™½éƒ½èƒ½æœ‰æˆåŠŸæ„Ÿåœ°ä¸€æ¬¡æ€§è¿è¡ŒæˆåŠŸï¼Œä¸äº§ç”Ÿä»»ä½•æŠ¥é”™ã€‚å·²å‡†å¤‡å¥½å¼€ç®±å³ç”¨çš„Auto-dlé•œåƒï¼Œè¯„è®ºåŒº@zylAKï¼ˆæˆ‘çš„åšå®¢å›­æ˜µç§°ï¼‰å³åˆ»è·å–ğŸš€ å¦‚æœè§‰å¾—å¸–å­ä¸é”™æ¬¢è¿è½¬å‘zylAKçš„å¸–å­ç»™å°ä¼™ä¼´ä»¬ï¼Œä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘æ›´æ–°çš„åŠ¨åŠ›ã€‚å¦‚æœè¿˜æƒ³äº†è§£Evo2æ›´å¤šçš„åº”ç”¨ï¼Œä¾‹å¦‚å¦‚ä½•è®¾è®¡æ–°çš„æ ¸é…¸åºåˆ—ã€å¦‚ä½•è·å¾—å¯è§£é‡Šçš„å¤§è¯­è¨€æ¨¡å‹ç†è§£ç­‰ï¼Œéƒ½å¯ä»¥åœ¨è¯„è®ºåŒºå‚¬æ›´ã€‚</p>
<p>&nbsp;</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œä»¥Auto-dläº‘æœåŠ¡å™¨ä¸ºä¾‹ï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p>
<p>ä¸€ã€å‰æœŸå‡†å¤‡ï¼š<br>1.1 äº‘æœåŠ¡å™¨é…ç½®ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519153719421-699431769.png" alt="" width="304" height="102" loading="lazy"></p>
<p>&nbsp;</p>
<p>1.2 å¼€å¯Auto-dlçš„å­¦æœ¯åŠ é€Ÿå¹¶ä»githubä¸Šä¸‹è½½Evo2é¡¹ç›®æ–‡ä»¶ï¼Œæ¿€æ´»ï¼š<br>å‘½ä»¤è¡Œæ˜¯ï¼š</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)">1</span> source /etc/<span style="color: rgba(0, 0, 0, 1)">network_turbo #å¼€å¯å­¦æœ¯åŠ é€Ÿ<br>
</span><span style="color: rgba(0, 128, 128, 1)">2</span> git clone https:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">github.com/ArcInstitute/evo2.git #ä¸‹è½½Evo2é¡¹ç›®æ–‡ä»¶<br></span>
<span style="color: rgba(0, 128, 128, 1)">3</span> <span style="color: rgba(0, 0, 0, 1)">cd evo2 #è¿›å…¥é¡¹ç›®è·¯å¾„<br></span></pre>
<pre><span style="color: rgba(0, 128, 128, 1)">4 git clone https://github.com/Zymrael/vortex.git</span><span class="pl-c1"> #æ‰‹åŠ¨å®‰è£…vortexä¾èµ–</span></pre>
<pre><span style="color: rgba(0, 128, 128, 1)">5</span> python setup.py <span style="color: rgba(0, 0, 255, 1)">install</span> #é¡¹ç›®æ¿€æ´»</pre>
</div>
<p>&nbsp;</p>
<p>1.3 ä»hugging faceé•œåƒç«™hf-mirrorä¸Šä¸‹è½½å¯¹åº”Evo2æ¨¡å‹ï¼Œå¹¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä»¥ä¾›åç»­è°ƒç”¨ã€‚ç›®å‰4090æœºå™¨çš„é…ç½®å¯ä»¥è¿è¡Œ1bå’Œ7bçš„æ¨¡å‹ï¼ˆå®Œæ•´å’Œbaseç‰ˆå‡å¯ï¼‰ï¼Œ40bæ¨¡å‹å¯èƒ½éœ€è¦å†…å­˜æ›´é«˜çš„æœºå™¨ä¸”éœ€è¦å¤šå¡GPUéƒ¨ç½²ï¼Œè¿™ä¸€æœŸæš‚ä¸è®¨è®ºã€‚ä¸‰ç§å‚æ•°é‡çš„æ¨¡å‹æ•ˆæœç›¸å·®ä¸é‚£ä¹ˆæ˜æ˜¾ã€‚<br>å‘½ä»¤è¡Œæ˜¯ï¼š</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)">1</span> cd /root/autodl-tmp/evo2/<span style="color: rgba(0, 0, 0, 1)">evo2_models #åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­å•ç‹¬åˆ›å»ºä¸€ä¸ªevo2_modelæ–‡ä»¶å¤¹ç”¨äºä¿å­˜ä¸‹è½½çš„æ¨¡å‹ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡è°ƒç”¨æ—¶é‡æ–°ä¸‹è½½äº†
</span><span style="color: rgba(0, 128, 128, 1)">2</span> 
<span style="color: rgba(0, 128, 128, 1)">3</span> #è®¾ç½®huggingface-<span style="color: rgba(0, 0, 0, 1)">cliä¸‹è½½çš„é•œåƒç½‘å€
</span><span style="color: rgba(0, 128, 128, 1)">4</span> export HF_ENDPOINT=https:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">hf-mirror.com</span>
<span style="color: rgba(0, 128, 128, 1)">5</span> 
<span style="color: rgba(0, 128, 128, 1)">6</span> <span style="color: rgba(0, 0, 0, 1)">#ä¸‹è½½evo2_1b_baseæ¨¡å‹ä¸ºä¾‹
</span><span style="color: rgba(0, 128, 128, 1)">7</span> huggingface-cli download --resume-download arcinstitute/evo2_1b_base --local-dir /root/autodl-tmp/evo2/evo2_models</pre>
</div>
<p>æ­£ç¡®çš„ä¸‹è½½è¿è¡Œæ—¶ä¼šæœ‰å¦‚ä¸‹çš„è¾“å‡ºï¼ˆè¿›åº¦æ¡é€æ¸å¢åŠ ï¼‰</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519161115806-813906910.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
<p>äºŒã€æ¨¡å‹åŠ è½½ä¸Embeddingsæå–</p>
<p>2.1 å¯¼å…¥é¡¹ç›®éœ€è¦ç”¨åˆ°çš„æ‰€æœ‰packages</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 0, 255, 1)">from</span> Bio <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> SeqIO
</span><span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> gzip
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> matplotlib.pyplot as plt
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> numpy as np
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> pandas as pd
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> os
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> seaborn as sns
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> <span style="color: rgba(0, 0, 255, 1)">from</span> sklearn.metrics <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> roc_auc_score
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> numpy as np
</span><span style="color: rgba(0, 128, 128, 1)">10</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 128, 128, 1)">11</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn
</span><span style="color: rgba(0, 128, 128, 1)">12</span> <span style="color: rgba(0, 0, 255, 1)">from</span> torch.utils.data <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> DataLoader, TensorDataset
</span><span style="color: rgba(0, 128, 128, 1)">13</span> <span style="color: rgba(0, 0, 255, 1)">from</span> sklearn.model_selection <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> train_test_split
</span><span style="color: rgba(0, 128, 128, 1)">14</span> <span style="color: rgba(0, 0, 255, 1)">from</span> sklearn.metrics <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> roc_auc_score
</span><span style="color: rgba(0, 128, 128, 1)">15</span> <span style="color: rgba(0, 0, 255, 1)">from</span> torch.optim.lr_scheduler <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> ReduceLROnPlateau
</span><span style="color: rgba(0, 128, 128, 1)">16</span> <span style="color: rgba(0, 0, 255, 1)">from</span> pathlib <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> Path
</span><span style="color: rgba(0, 128, 128, 1)">17</span> <span style="color: rgba(0, 0, 255, 1)">from</span> tqdm.notebook <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> tqdm
</span><span style="color: rgba(0, 128, 128, 1)">18</span> <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> transformer_engine.pytorch as te
</span><span style="color: rgba(0, 128, 128, 1)">19</span> <span style="color: rgba(0, 0, 255, 1)">from</span> transformer_engine.common <span style="color: rgba(0, 0, 255, 1)">import</span> recipe</pre>
</div>
<p>&nbsp;å¯èƒ½ä¼šå‡ºç°æŠ¥é”™ï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519162030634-373452541.png" alt="" loading="lazy"></p>
<p>&nbsp;ä½†å®Œå…¨ä¸å½±å“åç»­ä»£ç è¿è¡Œã€‚å¦‚æœåæœŸflash-attnåŒ…å‡çº§é€ æˆå†²çªï¼Œå¯ä»¥æŒ‡å®šå®‰è£…2.7.4ç‰ˆæœ¬ã€‚</p>
<p>&nbsp;</p>
<p>2.2 åŠ è½½æ¨¡å‹</p>
<div class="cnblogs_code">
<pre>os.chdir(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">/root/autodl-tmp/evo2/evo2</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
model_path </span>= <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">/root/autodl-tmp/evo2/evo2_models/evo2_1b_base/evo2_1b_base.pt</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 0, 255, 1)">from</span> evo2.models <span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> Evo2
model </span>= Evo2(model_name=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">evo2_1b_base</span><span style="color: rgba(128, 0, 0, 1)">'</span>,local_path=model_path)</pre>
</div>
<p>&nbsp;</p>
<p>2.3 åŠ è½½å¹¶è§£æè¾“å…¥æ•°æ®â€”â€”BRCA1æ•°æ®ï¼ŒåŒ…æ‹¬åºåˆ—æ•°æ®ï¼Œçªå˜ä½ç‚¹ï¼Œçªå˜æ•ˆåº”åˆ†ç±»ã€‚è¯¦ç»†è¯´æ˜è¯·è§Evo2é¡¹ç›®æ¡ˆä¾‹ä»‹ç»ï¼šhttps://github.com/ArcInstitute/evo2/tree/main/notebooks/brca1</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1 </span>os.chdir('/root/autodl-tmp/evo2')<br>   brca1_df =<span> pd.read_excel(</span></pre>
<pre><span style="color: rgba(0, 128, 128, 1)"> 2</span>     os.path.join(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">notebooks</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">brca1</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">41586_2018_461_MOESM3_ESM.xlsx</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span>     header=2<span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span> <span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span> brca1_df =<span style="color: rgba(0, 0, 0, 1)"> brca1_df[[
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">chromosome</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">position (hg19)</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">reference</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">alt</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">function.score.mean</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">func.class</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span> <span style="color: rgba(0, 0, 0, 1)">]]
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> 
<span style="color: rgba(0, 128, 128, 1)"> 9</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹åˆ—åé‡å‘½å</span>
<span style="color: rgba(0, 128, 128, 1)">10</span> brca1_df.rename(columns=<span style="color: rgba(0, 0, 0, 1)">{
</span><span style="color: rgba(0, 128, 128, 1)">11</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">chromosome</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">chrom</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">12</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">position (hg19)</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">pos</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">13</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">reference</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ref</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">14</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">alt</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">alt</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">15</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">function.score.mean</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">score</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">16</span>     <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">func.class</span><span style="color: rgba(128, 0, 0, 1)">'</span>: <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">class</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">17</span> }, inplace=<span style="color: rgba(0, 0, 0, 1)">True)
</span><span style="color: rgba(0, 128, 128, 1)">18</span> 
<span style="color: rgba(0, 128, 128, 1)">19</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å°†çªå˜æ•ˆåº”å‘½åä¸ºäºŒåˆ†ç±»æ ‡ç­¾</span>
<span style="color: rgba(0, 128, 128, 1)">20</span> brca1_df[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">class</span><span style="color: rgba(128, 0, 0, 1)">'</span>] = brca1_df[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">class</span><span style="color: rgba(128, 0, 0, 1)">'</span>].replace([<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">FUNC</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">INT</span><span style="color: rgba(128, 0, 0, 1)">'</span>], <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">FUNC/INT</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">21</span> 
<span style="color: rgba(0, 128, 128, 1)">22</span> WINDOW_SIZE = 8192
<span style="color: rgba(0, 128, 128, 1)">23</span> 
<span style="color: rgba(0, 128, 128, 1)">24</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è¯»å–17å·æŸ“è‰²ä½“å‚è€ƒåŸºå› ç»„åºåˆ—</span>
<span style="color: rgba(0, 128, 128, 1)">25</span> with gzip.open(os.path.join(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">notebooks</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">brca1</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">GRCh37.p13_chr17.fna.gz</span><span style="color: rgba(128, 0, 0, 1)">'</span>), <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rt</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">) as handle:
</span><span style="color: rgba(0, 128, 128, 1)">26</span>     <span style="color: rgba(0, 0, 255, 1)">for</span> record <span style="color: rgba(0, 0, 255, 1)">in</span> SeqIO.parse(handle, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">fasta</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
</span><span style="color: rgba(0, 128, 128, 1)">27</span>         seq_chr17 =<span style="color: rgba(0, 0, 0, 1)"> str(record.seq)
</span><span style="color: rgba(0, 128, 128, 1)">28</span>         <span style="color: rgba(0, 0, 255, 1)">break</span>
<span style="color: rgba(0, 128, 128, 1)">29</span> 
<span style="color: rgba(0, 128, 128, 1)">30</span> <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> parse_sequences(pos, ref, alt):
</span><span style="color: rgba(0, 128, 128, 1)">31</span>     <span style="color: rgba(128, 0, 0, 1)">"""</span>
<span style="color: rgba(0, 128, 128, 1)">32</span> <span style="color: rgba(128, 0, 0, 1)">    è§£æå‚è€ƒåºåˆ—ï¼ˆæœªçªå˜åºåˆ—ï¼‰å’Œçªå˜åºåˆ—
</span><span style="color: rgba(0, 128, 128, 1)">33</span>     <span style="color: rgba(128, 0, 0, 1)">"""</span>
<span style="color: rgba(0, 128, 128, 1)">34</span>     p = pos - 1 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> Convert to 0-indexed position</span>
<span style="color: rgba(0, 128, 128, 1)">35</span>     full_seq =<span style="color: rgba(0, 0, 0, 1)"> seq_chr17
</span><span style="color: rgba(0, 128, 128, 1)">36</span> 
<span style="color: rgba(0, 128, 128, 1)">37</span>     ref_seq_start = max(0, p - WINDOW_SIZE//2<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">38</span>     ref_seq_end = min(len(full_seq), p + WINDOW_SIZE//2<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">39</span>     ref_seq =<span style="color: rgba(0, 0, 0, 1)"> seq_chr17[ref_seq_start:ref_seq_end]
</span><span style="color: rgba(0, 128, 128, 1)">40</span>     snv_pos_in_ref = min(WINDOW_SIZE//2<span style="color: rgba(0, 0, 0, 1)">, p)
</span><span style="color: rgba(0, 128, 128, 1)">41</span>     var_seq = ref_seq[:snv_pos_in_ref] + alt + ref_seq[snv_pos_in_ref+1<span style="color: rgba(0, 0, 0, 1)">:]
</span><span style="color: rgba(0, 128, 128, 1)">42</span> 
<span style="color: rgba(0, 128, 128, 1)">43</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ•°æ®åˆç†æ€§æ£€æŸ¥</span>
<span style="color: rgba(0, 128, 128, 1)">44</span>     <span style="color: rgba(0, 0, 255, 1)">assert</span> len(var_seq) ==<span style="color: rgba(0, 0, 0, 1)"> len(ref_seq)
</span><span style="color: rgba(0, 128, 128, 1)">45</span>     <span style="color: rgba(0, 0, 255, 1)">assert</span> ref_seq[snv_pos_in_ref] ==<span style="color: rgba(0, 0, 0, 1)"> ref
</span><span style="color: rgba(0, 128, 128, 1)">46</span>     <span style="color: rgba(0, 0, 255, 1)">assert</span> var_seq[snv_pos_in_ref] ==<span style="color: rgba(0, 0, 0, 1)"> alt
</span><span style="color: rgba(0, 128, 128, 1)">47</span> 
<span style="color: rgba(0, 128, 128, 1)">48</span>     <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> ref_seq, var_seq
</span><span style="color: rgba(0, 128, 128, 1)">49</span> 
<span style="color: rgba(0, 128, 128, 1)">50</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç»™å‚è€ƒåºåˆ—ä¸€ä¸ªç´¢å¼•å€¼</span>
<span style="color: rgba(0, 128, 128, 1)">51</span> ref_seqs =<span style="color: rgba(0, 0, 0, 1)"> []
</span><span style="color: rgba(0, 128, 128, 1)">52</span> ref_seq_to_index =<span style="color: rgba(0, 0, 0, 1)"> {}
</span><span style="color: rgba(0, 128, 128, 1)">53</span> 
<span style="color: rgba(0, 128, 128, 1)">54</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è§£æåºåˆ—å¹¶å­˜å‚¨ç´¢å¼•å€¼</span>
<span style="color: rgba(0, 128, 128, 1)">55</span> ref_seq_indexes =<span style="color: rgba(0, 0, 0, 1)"> []
</span><span style="color: rgba(0, 128, 128, 1)">56</span> var_seqs =<span style="color: rgba(0, 0, 0, 1)"> []
</span><span style="color: rgba(0, 128, 128, 1)">57</span> 
<span style="color: rgba(0, 128, 128, 1)">58</span> <span style="color: rgba(0, 0, 255, 1)">for</span> _, row <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> brca1_df.iterrows():
</span><span style="color: rgba(0, 128, 128, 1)">59</span>     ref_seq, var_seq = parse_sequences(row[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">pos</span><span style="color: rgba(128, 0, 0, 1)">'</span>], row[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ref</span><span style="color: rgba(128, 0, 0, 1)">'</span>], row[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">alt</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">])
</span><span style="color: rgba(0, 128, 128, 1)">60</span> 
<span style="color: rgba(0, 128, 128, 1)">61</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç»™å½“å‰å¾ªç¯åˆ°çš„å‚è€ƒåºåˆ—è·å–/åˆ›å»ºç´¢å¼•</span>
<span style="color: rgba(0, 128, 128, 1)">62</span>     <span style="color: rgba(0, 0, 255, 1)">if</span> ref_seq <span style="color: rgba(0, 0, 255, 1)">not</span> <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> ref_seq_to_index:
</span><span style="color: rgba(0, 128, 128, 1)">63</span>         ref_seq_to_index[ref_seq] =<span style="color: rgba(0, 0, 0, 1)"> len(ref_seqs)
</span><span style="color: rgba(0, 128, 128, 1)">64</span> <span style="color: rgba(0, 0, 0, 1)">        ref_seqs.append(ref_seq)
</span><span style="color: rgba(0, 128, 128, 1)">65</span>     
<span style="color: rgba(0, 128, 128, 1)">66</span> <span style="color: rgba(0, 0, 0, 1)">    ref_seq_indexes.append(ref_seq_to_index[ref_seq])
</span><span style="color: rgba(0, 128, 128, 1)">67</span> <span style="color: rgba(0, 0, 0, 1)">    var_seqs.append(var_seq)
</span><span style="color: rgba(0, 128, 128, 1)">68</span> 
<span style="color: rgba(0, 128, 128, 1)">69</span> ref_seq_indexes = np.array(ref_seq_indexes)</pre>
</div>
<p>&nbsp;</p>
<p>2.4 ä»¥BCRA1åºåˆ—ä¸ºè¾“å…¥ï¼Œæå–å…¨éƒ¨å…¨éƒ¨å±‚çš„Embeddingå¹¶ä¿å­˜ä¸‹æ¥</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== é…ç½®å‚æ•° ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> device =<span style="color: rgba(0, 0, 0, 1)"> next(model.model.parameters()).device
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> candidate_layers = [f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">blocks.{i}.pre_norm</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(25<span style="color: rgba(0, 0, 0, 1)">)]
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span> batch_size = 8  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´</span>
<span style="color: rgba(0, 128, 128, 1)"> 5</span> save_dir = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)"> 6</span> os.makedirs(save_dir, exist_ok=<span style="color: rgba(0, 0, 0, 1)">True)
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span> 
<span style="color: rgba(0, 128, 128, 1)"> 8</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== æ‰¹é‡åµŒå…¥æå–  ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 9</span> <span style="color: rgba(0, 0, 255, 1)">def</span> process_sequences(seq_list, layer_name, desc, prefix=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ref</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
</span><span style="color: rgba(0, 128, 128, 1)">10</span>     <span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">æ‰¹é‡å¤„ç†åºåˆ—åµŒå…¥å¹¶ç¡®ä¿æ–‡ä»¶ä¿å­˜</span><span style="color: rgba(128, 0, 0, 1)">"""</span>
<span style="color: rgba(0, 128, 128, 1)">11</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç”Ÿæˆæ ‡å‡†åŒ–æ–‡ä»¶å</span>
<span style="color: rgba(0, 128, 128, 1)">12</span>     sanitized_layer = layer_name.replace(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">.</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">_</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">13</span>     memmap_path = os.path.join(save_dir, f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{prefix}_{sanitized_layer}.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">14</span>     
<span style="color: rgba(0, 128, 128, 1)">15</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åˆ›å»ºå†…å­˜æ˜ å°„æ–‡ä»¶å¹¶ç«‹å³ä¿å­˜å¤´ä¿¡æ¯</span>
<span style="color: rgba(0, 128, 128, 1)">16</span>     emb_mmap =<span style="color: rgba(0, 0, 0, 1)"> np.lib.format.open_memmap(
</span><span style="color: rgba(0, 128, 128, 1)">17</span> <span style="color: rgba(0, 0, 0, 1)">        memmap_path, 
</span><span style="color: rgba(0, 128, 128, 1)">18</span>         dtype=<span style="color: rgba(0, 0, 0, 1)">np.float32,
</span><span style="color: rgba(0, 128, 128, 1)">19</span>         mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">w+</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">20</span>         shape=(len(seq_list), 1920<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">21</span> <span style="color: rgba(0, 0, 0, 1)">    )
</span><span style="color: rgba(0, 128, 128, 1)">22</span>     
<span style="color: rgba(0, 128, 128, 1)">23</span>     <span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)">24</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åˆ†æ‰¹å¤„ç†</span>
<span style="color: rgba(0, 128, 128, 1)">25</span>         <span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> tqdm(range(0, len(seq_list), batch_size), desc=desc, leave=<span style="color: rgba(0, 0, 0, 1)">False):
</span><span style="color: rgba(0, 128, 128, 1)">26</span>             batch_seqs = seq_list[i:i+<span style="color: rgba(0, 0, 0, 1)">batch_size]
</span><span style="color: rgba(0, 128, 128, 1)">27</span>             
<span style="color: rgba(0, 128, 128, 1)">28</span>             <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> Tokenizeå¹¶å¡«å……</span>
<span style="color: rgba(0, 128, 128, 1)">29</span>             batch_tokens =<span style="color: rgba(0, 0, 0, 1)"> []
</span><span style="color: rgba(0, 128, 128, 1)">30</span>             <span style="color: rgba(0, 0, 255, 1)">for</span> seq <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> batch_seqs:
</span><span style="color: rgba(0, 128, 128, 1)">31</span>                 tokens =<span style="color: rgba(0, 0, 0, 1)"> model.tokenizer.tokenize(seq)
</span><span style="color: rgba(0, 128, 128, 1)">32</span>                 batch_tokens.append(torch.tensor(tokens, dtype=<span style="color: rgba(0, 0, 0, 1)">torch.long))
</span><span style="color: rgba(0, 128, 128, 1)">33</span>             
<span style="color: rgba(0, 128, 128, 1)">34</span>             max_len = max(len(t) <span style="color: rgba(0, 0, 255, 1)">for</span> t <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> batch_tokens)
</span><span style="color: rgba(0, 128, 128, 1)">35</span>             padded_tokens =<span style="color: rgba(0, 0, 0, 1)"> torch.stack([
</span><span style="color: rgba(0, 128, 128, 1)">36</span>                 torch.nn.functional.pad(t, (0, max_len - len(t))) <span style="color: rgba(0, 0, 255, 1)">for</span> t <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> batch_tokens
</span><span style="color: rgba(0, 128, 128, 1)">37</span> <span style="color: rgba(0, 0, 0, 1)">            ]).to(device)
</span><span style="color: rgba(0, 128, 128, 1)">38</span>             
<span style="color: rgba(0, 128, 128, 1)">39</span>             <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å‰å‘ä¼ æ’­</span>
<span style="color: rgba(0, 128, 128, 1)">40</span> <span style="color: rgba(0, 0, 0, 1)">            with torch.no_grad():
</span><span style="color: rgba(0, 128, 128, 1)">41</span>                 _, emb_dict =<span style="color: rgba(0, 0, 0, 1)"> model.forward(
</span><span style="color: rgba(0, 128, 128, 1)">42</span> <span style="color: rgba(0, 0, 0, 1)">                    padded_tokens,
</span><span style="color: rgba(0, 128, 128, 1)">43</span>                     return_embeddings=<span style="color: rgba(0, 0, 0, 1)">True,
</span><span style="color: rgba(0, 128, 128, 1)">44</span>                     layer_names=<span style="color: rgba(0, 0, 0, 1)">[layer_name]
</span><span style="color: rgba(0, 128, 128, 1)">45</span> <span style="color: rgba(0, 0, 0, 1)">                )
</span><span style="color: rgba(0, 128, 128, 1)">46</span>             
<span style="color: rgba(0, 128, 128, 1)">47</span>             <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å†™å…¥å†…å­˜æ˜ å°„æ–‡ä»¶</span>
<span style="color: rgba(0, 128, 128, 1)">48</span>             batch_emb = emb_dict[layer_name].float().mean(dim=1<span style="color: rgba(0, 0, 0, 1)">).cpu().numpy()
</span><span style="color: rgba(0, 128, 128, 1)">49</span>             emb_mmap[i:i+len(batch_emb)] =<span style="color: rgba(0, 0, 0, 1)"> batch_emb
</span><span style="color: rgba(0, 128, 128, 1)">50</span>             
<span style="color: rgba(0, 128, 128, 1)">51</span>             <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç«‹å³åˆ·æ–°å†™å…¥ç£ç›˜</span>
<span style="color: rgba(0, 128, 128, 1)">52</span> <span style="color: rgba(0, 0, 0, 1)">            emb_mmap.flush()
</span><span style="color: rgba(0, 128, 128, 1)">53</span>             
<span style="color: rgba(0, 128, 128, 1)">54</span>     <span style="color: rgba(0, 0, 255, 1)">finally</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)">55</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¡®ä¿æ–‡ä»¶å…³é—­</span>
<span style="color: rgba(0, 128, 128, 1)">56</span>         <span style="color: rgba(0, 0, 255, 1)">del</span><span style="color: rgba(0, 0, 0, 1)"> emb_mmap
</span><span style="color: rgba(0, 128, 128, 1)">57</span>     
<span style="color: rgba(0, 128, 128, 1)">58</span>     <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> memmap_path
</span><span style="color: rgba(0, 128, 128, 1)">59</span> 
<span style="color: rgba(0, 128, 128, 1)">60</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== ä¸»æµç¨‹ ==========</span>
<span style="color: rgba(0, 128, 128, 1)">61</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> é¢„å…ˆç”Ÿæˆå…¨å±€ç´¢å¼•æ–‡ä»¶ (åªéœ€ä¿å­˜ä¸€æ¬¡)</span>
<span style="color: rgba(0, 128, 128, 1)">62</span> np.save(os.path.join(save_dir, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ref_idx.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">), ref_seq_indexes)
</span><span style="color: rgba(0, 128, 128, 1)">63</span> 
<span style="color: rgba(0, 128, 128, 1)">64</span> <span style="color: rgba(0, 0, 255, 1)">for</span> layer_name <span style="color: rgba(0, 0, 255, 1)">in</span> tqdm(candidate_layers, desc=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ğŸ” Processing Layers</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
</span><span style="color: rgba(0, 128, 128, 1)">65</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¤„ç†å‚è€ƒåºåˆ— (ç”Ÿæˆ ref_blocks_0_pre_norm.npy)</span>
<span style="color: rgba(0, 128, 128, 1)">66</span>     _ =<span style="color: rgba(0, 0, 0, 1)"> process_sequences(
</span><span style="color: rgba(0, 128, 128, 1)">67</span> <span style="color: rgba(0, 0, 0, 1)">        ref_seqs, 
</span><span style="color: rgba(0, 128, 128, 1)">68</span> <span style="color: rgba(0, 0, 0, 1)">        layer_name,
</span><span style="color: rgba(0, 128, 128, 1)">69</span>         f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ğŸ§¬ Ref {layer_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">70</span>         prefix=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ref</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)">71</span> <span style="color: rgba(0, 0, 0, 1)">    )
</span><span style="color: rgba(0, 128, 128, 1)">72</span>     
<span style="color: rgba(0, 128, 128, 1)">73</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¤„ç†å˜å¼‚åºåˆ— (ç”Ÿæˆ var_blocks_0_pre_norm.npy)</span>
<span style="color: rgba(0, 128, 128, 1)">74</span>     _ =<span style="color: rgba(0, 0, 0, 1)"> process_sequences(
</span><span style="color: rgba(0, 128, 128, 1)">75</span> <span style="color: rgba(0, 0, 0, 1)">        var_seqs,
</span><span style="color: rgba(0, 128, 128, 1)">76</span> <span style="color: rgba(0, 0, 0, 1)">        layer_name,
</span><span style="color: rgba(0, 128, 128, 1)">77</span>         f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ğŸ§¬ Var {layer_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">78</span>         prefix=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">var</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)">79</span>     )</pre>
</div>
<p>æ­£ç¡®è¿è¡Œåæœ‰å¦‚ä¸‹è¾“å‡ºæ˜¾ç¤ºï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519170247866-509314315.png" alt="" width="657" height="115" loading="lazy"></p>
<p>&nbsp;</p>
<p>ä¸‰ã€åŸºäºä¿å­˜çš„Embeddingså¼€å‘ä¸‹æ¸¸çš„çªå˜æ•ˆåº”é¢„æµ‹å™¨ï¼š</p>
<p>3.1 Embeddingæ•°æ®åŠ è½½å‡½æ•°çš„å®šä¹‰</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== æ–°å¢é…ç½®å‚æ•° ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> embed_dir = Path(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> layers_to_train = [f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">blocks.{i}.pre_norm</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(25)]  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> éœ€è¦è®­ç»ƒçš„å±‚åˆ—è¡¨ï¼Œå…¨éƒ¨çš„25å±‚</span>
<span style="color: rgba(0, 128, 128, 1)"> 4</span> results_dir = Path(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">training_results</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span> results_dir.mkdir(exist_ok=<span style="color: rgba(0, 0, 0, 1)">True)
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span> 
<span style="color: rgba(0, 128, 128, 1)"> 7</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== æ•°æ®åŠ è½½å‡½æ•° ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 8</span> <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> load_layer_data(layer_name):
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span>     <span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">åŠ è½½æŒ‡å®šå±‚çš„åµŒå…¥æ•°æ®å’Œæ ‡ç­¾</span><span style="color: rgba(128, 0, 0, 1)">"""</span>
<span style="color: rgba(0, 128, 128, 1)">10</span>     sanitized = layer_name.replace(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">.</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">_</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">11</span>     
<span style="color: rgba(0, 128, 128, 1)">12</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åŠ è½½åµŒå…¥æ•°æ®ï¼ˆå†…å­˜æ˜ å°„æ¨¡å¼ï¼‰</span>
<span style="color: rgba(0, 128, 128, 1)">13</span>     ref_emb = np.load(embed_dir/f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ref_{sanitized}.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span>, mmap_mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">r</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">14</span>     var_emb = np.load(embed_dir/f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">var_{sanitized}.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span>, mmap_mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">r</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">15</span>     ref_idx = np.load(embed_dir/<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ref_idx.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">16</span>     
<span style="color: rgba(0, 128, 128, 1)">17</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ‹¼æ¥ç‰¹å¾</span>
<span style="color: rgba(0, 128, 128, 1)">18</span>     X = np.concatenate([ref_emb[ref_idx], var_emb], axis=1<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">19</span>     
<span style="color: rgba(0, 128, 128, 1)">20</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è·å–æ ‡ç­¾ï¼ˆä»åŸå§‹æ•°æ®æ¡†ï¼‰</span>
<span style="color: rgba(0, 128, 128, 1)">21</span>     y = brca1_df[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">class</span><span style="color: rgba(128, 0, 0, 1)">'</span>].map({<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">FUNC/INT</span><span style="color: rgba(128, 0, 0, 1)">'</span>:0, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">LOF</span><span style="color: rgba(128, 0, 0, 1)">'</span>:1<span style="color: rgba(0, 0, 0, 1)">}).values
</span><span style="color: rgba(0, 128, 128, 1)">22</span>     
<span style="color: rgba(0, 128, 128, 1)">23</span>     <span style="color: rgba(0, 0, 255, 1)">return</span> X, y</pre>
</div>
<p>&nbsp;</p>
<p>3.2 Embeddingsæ•°æ®æ­£ç¡®æ€§æ£€éªŒã€‚ä¸»è¦æ˜¯éªŒè¯æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæ˜¯å¦ç¬¦åˆEvo2_1b_baseæ¨¡å‹ä¸­é—´å±‚çš„ç»´åº¦ï¼ˆ1920ç»´ï¼‰</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¤ºä¾‹ï¼Œæ£€æŸ¥ç¬¬24å±‚æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 255, 1)">assert</span> os.path.exists(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings/ref_blocks_24_pre_norm.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> <span style="color: rgba(0, 0, 255, 1)">assert</span> os.path.exists(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings/var_blocks_24_pre_norm.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span> 
<span style="color: rgba(0, 128, 128, 1)"> 5</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> éªŒè¯åµŒå…¥ç»´åº¦</span>
<span style="color: rgba(0, 128, 128, 1)"> 6</span> ref_emb = np.load(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings/ref_blocks_24_pre_norm.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span>, mmap_mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">r</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span> var_emb = np.load(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">extract_embeddings/var_blocks_24_pre_norm.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span>, mmap_mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">r</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å‚è€ƒåºåˆ—åµŒå…¥ç»´åº¦: {ref_emb.shape}</span><span style="color: rgba(128, 0, 0, 1)">"</span>)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åº”ä¸º (N_ref, 1920)</span>
<span style="color: rgba(0, 128, 128, 1)"> 9</span> <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å˜å¼‚åºåˆ—åµŒå…¥ç»´åº¦: {var_emb.shape}</span><span style="color: rgba(128, 0, 0, 1)">"</span>)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åº”ä¸º (N_ref, 1920)</span>
<span style="color: rgba(0, 128, 128, 1)">10</span> 
<span style="color: rgba(0, 128, 128, 1)">11</span> <span style="color: rgba(0, 0, 255, 1)">for</span> layer_name <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> layers_to_train:
</span><span style="color: rgba(0, 128, 128, 1)">12</span>     <span style="color: rgba(0, 0, 255, 1)">print</span><span style="color: rgba(0, 0, 0, 1)">(layer_name)
</span><span style="color: rgba(0, 128, 128, 1)">13</span>     X, y =<span style="color: rgba(0, 0, 0, 1)"> load_layer_data(layer_name)
</span><span style="color: rgba(0, 128, 128, 1)">14</span>     <span style="color: rgba(0, 0, 255, 1)">print</span>(X.shape)</pre>
</div>
<p>&nbsp;</p>
<p><strong>3.3 ï¼ˆé‡è¦ï¼‰å®šä¹‰åˆ†ç¦»å™¨DNNçš„ç»“æ„ï¼ˆä»¿ç…§åŸæ–‡ä¸­çš„DNNç»“æ„ï¼‰</strong></p>
<p></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== æ¨¡å‹æ¶æ„ ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> BRCA1Classifier(nn.Module):
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span>     <span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">(self, input_dim):
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span>         super().<span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">()
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span>         self.net =<span style="color: rgba(0, 0, 0, 1)"> nn.Sequential(
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span>             nn.Linear(input_dim, 512<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span> <span style="color: rgba(0, 0, 0, 1)">            nn.ReLU(),
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span>             nn.BatchNorm1d(512<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span>             nn.Dropout(0.3<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">10</span>             
<span style="color: rgba(0, 128, 128, 1)">11</span>             nn.Linear(512, 128<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">12</span> <span style="color: rgba(0, 0, 0, 1)">            nn.ReLU(),
</span><span style="color: rgba(0, 128, 128, 1)">13</span>             nn.BatchNorm1d(128<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">14</span>             nn.Dropout(0.3<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">15</span>             
<span style="color: rgba(0, 128, 128, 1)">16</span>             nn.Linear(128, 32<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">17</span> <span style="color: rgba(0, 0, 0, 1)">            nn.ReLU(),
</span><span style="color: rgba(0, 128, 128, 1)">18</span>             nn.BatchNorm1d(32<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">19</span>             
<span style="color: rgba(0, 128, 128, 1)">20</span>             nn.Linear(32, 1<span style="color: rgba(0, 0, 0, 1)">),
</span><span style="color: rgba(0, 128, 128, 1)">21</span> <span style="color: rgba(0, 0, 0, 1)">            nn.Sigmoid()
</span><span style="color: rgba(0, 128, 128, 1)">22</span> <span style="color: rgba(0, 0, 0, 1)">        )
</span><span style="color: rgba(0, 128, 128, 1)">23</span>         
<span style="color: rgba(0, 128, 128, 1)">24</span>     <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
</span><span style="color: rgba(0, 128, 128, 1)">25</span>         <span style="color: rgba(0, 0, 255, 1)">return</span> self.net(x)</pre>
</div>
<p>&nbsp;</p>
<p><strong>3.4 ï¼ˆé‡è¦ï¼‰è®­ç»ƒæµç¨‹å®šä¹‰</strong></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)">  1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== è®­ç»ƒæµç¨‹ ==========</span>
<span style="color: rgba(0, 128, 128, 1)">  2</span> <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> train_for_layer(layer_name):
</span><span style="color: rgba(0, 128, 128, 1)">  3</span>     <span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">å•å±‚è®­ç»ƒæµç¨‹</span><span style="color: rgba(128, 0, 0, 1)">"""</span>
<span style="color: rgba(0, 128, 128, 1)">  4</span>     <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n=== å¼€å§‹è®­ç»ƒå±‚ {layer_name} ===</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">  5</span>     
<span style="color: rgba(0, 128, 128, 1)">  6</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åŠ è½½æ•°æ®</span>
<span style="color: rgba(0, 128, 128, 1)">  7</span>     X, y =<span style="color: rgba(0, 0, 0, 1)"> load_layer_data(layer_name)
</span><span style="color: rgba(0, 128, 128, 1)">  8</span>     
<span style="color: rgba(0, 128, 128, 1)">  9</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ•°æ®åˆ’åˆ†</span>
<span style="color: rgba(0, 128, 128, 1)"> 10</span>     X_temp, X_test, y_temp, y_test =<span style="color: rgba(0, 0, 0, 1)"> train_test_split(
</span><span style="color: rgba(0, 128, 128, 1)"> 11</span>         X, y, test_size=0.2, random_state=42, stratify=<span style="color: rgba(0, 0, 0, 1)">y
</span><span style="color: rgba(0, 128, 128, 1)"> 12</span> <span style="color: rgba(0, 0, 0, 1)">    )
</span><span style="color: rgba(0, 128, 128, 1)"> 13</span>     X_train, X_val, y_train, y_val =<span style="color: rgba(0, 0, 0, 1)"> train_test_split(
</span><span style="color: rgba(0, 128, 128, 1)"> 14</span>         X_temp, y_temp, test_size=0.25, random_state=42, stratify=<span style="color: rgba(0, 0, 0, 1)">y_temp
</span><span style="color: rgba(0, 128, 128, 1)"> 15</span> <span style="color: rgba(0, 0, 0, 1)">    )
</span><span style="color: rgba(0, 128, 128, 1)"> 16</span>     
<span style="color: rgba(0, 128, 128, 1)"> 17</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è½¬æ¢ä¸ºPyTorch Dataset</span>
<span style="color: rgba(0, 128, 128, 1)"> 18</span>     train_dataset = TensorDataset(torch.FloatTensor(X_train), torch.FloatTensor(y_train).unsqueeze(1<span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 19</span>     val_dataset = TensorDataset(torch.FloatTensor(X_val), torch.FloatTensor(y_val).unsqueeze(1<span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 20</span>     test_dataset = TensorDataset(torch.FloatTensor(X_test), torch.FloatTensor(y_test).unsqueeze(1<span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 21</span>     
<span style="color: rgba(0, 128, 128, 1)"> 22</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== è®­ç»ƒé…ç½® ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 23</span>     device = torch.device(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> torch.cuda.is_available() <span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cpu</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 24</span>     model = BRCA1Classifier(X.shape[1<span style="color: rgba(0, 0, 0, 1)">]).to(device)
</span><span style="color: rgba(0, 128, 128, 1)"> 25</span> 
<span style="color: rgba(0, 128, 128, 1)"> 26</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span>
<span style="color: rgba(0, 128, 128, 1)"> 27</span>     optimizer = torch.optim.Adam(model.parameters(), lr=3e-4<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 28</span>     criterion =<span style="color: rgba(0, 0, 0, 1)"> nn.BCELoss()
</span><span style="color: rgba(0, 128, 128, 1)"> 29</span> 
<span style="color: rgba(0, 128, 128, 1)"> 30</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å­¦ä¹ ç‡è°ƒåº¦å™¨</span>
<span style="color: rgba(0, 128, 128, 1)"> 31</span>     scheduler =<span style="color: rgba(0, 0, 0, 1)"> ReduceLROnPlateau(
</span><span style="color: rgba(0, 128, 128, 1)"> 32</span> <span style="color: rgba(0, 0, 0, 1)">        optimizer, 
</span><span style="color: rgba(0, 128, 128, 1)"> 33</span>         mode=<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">max</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">, 
</span><span style="color: rgba(0, 128, 128, 1)"> 34</span>         factor=0.5<span style="color: rgba(0, 0, 0, 1)">, 
</span><span style="color: rgba(0, 128, 128, 1)"> 35</span>         patience=20<span style="color: rgba(0, 0, 0, 1)">, 
</span><span style="color: rgba(0, 128, 128, 1)"> 36</span>         min_lr=1e-6
<span style="color: rgba(0, 128, 128, 1)"> 37</span> <span style="color: rgba(0, 0, 0, 1)">    )
</span><span style="color: rgba(0, 128, 128, 1)"> 38</span>     
<span style="color: rgba(0, 128, 128, 1)"> 39</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ•°æ®åŠ è½½å™¨</span>
<span style="color: rgba(0, 128, 128, 1)"> 40</span>     train_loader = DataLoader(train_dataset, batch_size=128, shuffle=<span style="color: rgba(0, 0, 0, 1)">True)
</span><span style="color: rgba(0, 128, 128, 1)"> 41</span>     val_loader = DataLoader(val_dataset, batch_size=128<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 42</span>     test_loader = DataLoader(test_dataset, batch_size=128<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 43</span> 
<span style="color: rgba(0, 128, 128, 1)"> 44</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== è®­ç»ƒå¾ªç¯ ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 45</span>     best_auc =<span style="color: rgba(0, 0, 0, 1)"> 0
</span><span style="color: rgba(0, 128, 128, 1)"> 46</span>     patience_counter =<span style="color: rgba(0, 0, 0, 1)"> 0
</span><span style="color: rgba(0, 128, 128, 1)"> 47</span>     max_patience = 100
<span style="color: rgba(0, 128, 128, 1)"> 48</span> 
<span style="color: rgba(0, 128, 128, 1)"> 49</span>     <span style="color: rgba(0, 0, 255, 1)">for</span> epoch <span style="color: rgba(0, 0, 255, 1)">in</span> range(500<span style="color: rgba(0, 0, 0, 1)">):
</span><span style="color: rgba(0, 128, 128, 1)"> 50</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è®­ç»ƒé˜¶æ®µ</span>
<span style="color: rgba(0, 128, 128, 1)"> 51</span> <span style="color: rgba(0, 0, 0, 1)">        model.train()
</span><span style="color: rgba(0, 128, 128, 1)"> 52</span>         train_loss =<span style="color: rgba(0, 0, 0, 1)"> 0
</span><span style="color: rgba(0, 128, 128, 1)"> 53</span>         <span style="color: rgba(0, 0, 255, 1)">for</span> inputs, labels <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> train_loader:
</span><span style="color: rgba(0, 128, 128, 1)"> 54</span>             inputs, labels =<span style="color: rgba(0, 0, 0, 1)"> inputs.to(device), labels.to(device)
</span><span style="color: rgba(0, 128, 128, 1)"> 55</span>             
<span style="color: rgba(0, 128, 128, 1)"> 56</span> <span style="color: rgba(0, 0, 0, 1)">            optimizer.zero_grad()
</span><span style="color: rgba(0, 128, 128, 1)"> 57</span>             outputs =<span style="color: rgba(0, 0, 0, 1)"> model(inputs)
</span><span style="color: rgba(0, 128, 128, 1)"> 58</span>             loss =<span style="color: rgba(0, 0, 0, 1)"> criterion(outputs, labels)
</span><span style="color: rgba(0, 128, 128, 1)"> 59</span>         
<span style="color: rgba(0, 128, 128, 1)"> 60</span>             <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¢¯åº¦è£å‰ª</span>
<span style="color: rgba(0, 128, 128, 1)"> 61</span>             torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=1.0<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 62</span>         
<span style="color: rgba(0, 128, 128, 1)"> 63</span> <span style="color: rgba(0, 0, 0, 1)">            loss.backward()
</span><span style="color: rgba(0, 128, 128, 1)"> 64</span> <span style="color: rgba(0, 0, 0, 1)">            optimizer.step()
</span><span style="color: rgba(0, 128, 128, 1)"> 65</span>             train_loss += loss.item() *<span style="color: rgba(0, 0, 0, 1)"> inputs.size(0)
</span><span style="color: rgba(0, 128, 128, 1)"> 66</span>     
<span style="color: rgba(0, 128, 128, 1)"> 67</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> éªŒè¯é˜¶æ®µ</span>
<span style="color: rgba(0, 128, 128, 1)"> 68</span> <span style="color: rgba(0, 0, 0, 1)">        model.eval()
</span><span style="color: rgba(0, 128, 128, 1)"> 69</span>         val_loss =<span style="color: rgba(0, 0, 0, 1)"> 0
</span><span style="color: rgba(0, 128, 128, 1)"> 70</span>         y_true, y_pred =<span style="color: rgba(0, 0, 0, 1)"> [], []
</span><span style="color: rgba(0, 128, 128, 1)"> 71</span> <span style="color: rgba(0, 0, 0, 1)">        with torch.no_grad():
</span><span style="color: rgba(0, 128, 128, 1)"> 72</span>             <span style="color: rgba(0, 0, 255, 1)">for</span> inputs, labels <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> val_loader:
</span><span style="color: rgba(0, 128, 128, 1)"> 73</span>                 inputs, labels =<span style="color: rgba(0, 0, 0, 1)"> inputs.to(device), labels.to(device)
</span><span style="color: rgba(0, 128, 128, 1)"> 74</span>                 outputs =<span style="color: rgba(0, 0, 0, 1)"> model(inputs)
</span><span style="color: rgba(0, 128, 128, 1)"> 75</span>                 val_loss += criterion(outputs, labels).item() *<span style="color: rgba(0, 0, 0, 1)"> inputs.size(0)
</span><span style="color: rgba(0, 128, 128, 1)"> 76</span> <span style="color: rgba(0, 0, 0, 1)">                y_true.extend(labels.cpu().numpy())
</span><span style="color: rgba(0, 128, 128, 1)"> 77</span> <span style="color: rgba(0, 0, 0, 1)">                y_pred.extend(outputs.cpu().numpy())
</span><span style="color: rgba(0, 128, 128, 1)"> 78</span>     
<span style="color: rgba(0, 128, 128, 1)"> 79</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è®¡ç®—æŒ‡æ ‡</span>
<span style="color: rgba(0, 128, 128, 1)"> 80</span>         train_loss /=<span style="color: rgba(0, 0, 0, 1)"> len(train_loader.dataset)
</span><span style="color: rgba(0, 128, 128, 1)"> 81</span>         val_loss /=<span style="color: rgba(0, 0, 0, 1)"> len(val_loader.dataset)
</span><span style="color: rgba(0, 128, 128, 1)"> 82</span>         val_auc =<span style="color: rgba(0, 0, 0, 1)"> roc_auc_score(y_true, y_pred)
</span><span style="color: rgba(0, 128, 128, 1)"> 83</span>     
<span style="color: rgba(0, 128, 128, 1)"> 84</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å­¦ä¹ ç‡è°ƒæ•´</span>
<span style="color: rgba(0, 128, 128, 1)"> 85</span> <span style="color: rgba(0, 0, 0, 1)">        scheduler.step(val_auc)
</span><span style="color: rgba(0, 128, 128, 1)"> 86</span>     
<span style="color: rgba(0, 128, 128, 1)"> 87</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ—©åœæœºåˆ¶</span>
<span style="color: rgba(0, 128, 128, 1)"> 88</span>         <span style="color: rgba(0, 0, 255, 1)">if</span> val_auc &gt;<span style="color: rgba(0, 0, 0, 1)"> best_auc:
</span><span style="color: rgba(0, 128, 128, 1)"> 89</span>             best_auc =<span style="color: rgba(0, 0, 0, 1)"> val_auc
</span><span style="color: rgba(0, 128, 128, 1)"> 90</span>             patience_counter =<span style="color: rgba(0, 0, 0, 1)"> 0
</span><span style="color: rgba(0, 128, 128, 1)"> 91</span>             torch.save(model.state_dict(), <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">best_model.pth</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 92</span>         <span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 93</span>             patience_counter += 1
<span style="color: rgba(0, 128, 128, 1)"> 94</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> patience_counter &gt;=<span style="color: rgba(0, 0, 0, 1)"> max_patience:
</span><span style="color: rgba(0, 128, 128, 1)"> 95</span>                 <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ—©åœè§¦å‘äºç¬¬{epoch}è½®</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 96</span>                 <span style="color: rgba(0, 0, 255, 1)">break</span>
<span style="color: rgba(0, 128, 128, 1)"> 97</span>     
<span style="color: rgba(0, 128, 128, 1)"> 98</span>         <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ‰“å°è¿›åº¦</span>
<span style="color: rgba(0, 128, 128, 1)"> 99</span>         <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Epoch {epoch+1}: </span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)">100</span>               f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Train Loss: {train_loss:.4f} | </span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)">101</span>               f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Val Loss: {val_loss:.4f} | </span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 128, 128, 1)">102</span>               f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Val AUROC: {val_auc:.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">103</span>         
<span style="color: rgba(0, 128, 128, 1)">104</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== æœ€ç»ˆè¯„ä¼° ==========</span>
<span style="color: rgba(0, 128, 128, 1)">105</span>     model.load_state_dict(torch.load(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">best_model.pth</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)">106</span> <span style="color: rgba(0, 0, 0, 1)">    model.eval()
</span><span style="color: rgba(0, 128, 128, 1)">107</span>     y_test_true, y_test_pred =<span style="color: rgba(0, 0, 0, 1)"> [], []
</span><span style="color: rgba(0, 128, 128, 1)">108</span> <span style="color: rgba(0, 0, 0, 1)">    with torch.no_grad():
</span><span style="color: rgba(0, 128, 128, 1)">109</span>         <span style="color: rgba(0, 0, 255, 1)">for</span> inputs, labels <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> test_loader:
</span><span style="color: rgba(0, 128, 128, 1)">110</span>             inputs, labels =<span style="color: rgba(0, 0, 0, 1)"> inputs.to(device), labels.to(device)
</span><span style="color: rgba(0, 128, 128, 1)">111</span>             outputs =<span style="color: rgba(0, 0, 0, 1)"> model(inputs)
</span><span style="color: rgba(0, 128, 128, 1)">112</span> <span style="color: rgba(0, 0, 0, 1)">            y_test_true.extend(labels.cpu().numpy())
</span><span style="color: rgba(0, 128, 128, 1)">113</span> <span style="color: rgba(0, 0, 0, 1)">            y_test_pred.extend(outputs.cpu().numpy())
</span><span style="color: rgba(0, 128, 128, 1)">114</span> 
<span style="color: rgba(0, 128, 128, 1)">115</span>     test_auc =<span style="color: rgba(0, 0, 0, 1)"> roc_auc_score(y_test_true, y_test_pred)
</span><span style="color: rgba(0, 128, 128, 1)">116</span>     <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\næœ€ç»ˆæµ‹è¯•é›†AUROC: {test_auc:.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">117</span>     
<span style="color: rgba(0, 128, 128, 1)">118</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¿å­˜ç»“æœ</span>
<span style="color: rgba(0, 128, 128, 1)">119</span>     sanitized = layer_name.replace(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">.</span><span style="color: rgba(128, 0, 0, 1)">'</span>, <span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">_</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">120</span>     torch.save(model.state_dict(), results_dir/f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">best_model_{sanitized}.pth</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">121</span>     np.save(results_dir/f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">test_pred_{sanitized}.npy</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, y_test_pred)
</span><span style="color: rgba(0, 128, 128, 1)">122</span>     
<span style="color: rgba(0, 128, 128, 1)">123</span>     <span style="color: rgba(0, 0, 255, 1)">return</span> test_auc</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>3.5 æ‰§è¡Œè®­ç»ƒæµç¨‹</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ========== ä¸»æ‰§è¡Œæµç¨‹ ==========</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span>     results =<span style="color: rgba(0, 0, 0, 1)"> {}
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span>     <span style="color: rgba(0, 0, 255, 1)">for</span> layer <span style="color: rgba(0, 0, 255, 1)">in</span> tqdm(layers_to_train, desc=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Training Layers</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span>         <span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span>             auc =<span style="color: rgba(0, 0, 0, 1)"> train_for_layer(layer)
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span>             results[layer] =<span style="color: rgba(0, 0, 0, 1)"> auc
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span>         <span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> Exception as e:
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span>             <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è®­ç»ƒå±‚ {layer} æ—¶å‡ºé”™: {str(e)}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">10</span>             results[layer] =<span style="color: rgba(0, 0, 0, 1)"> None
</span><span style="color: rgba(0, 128, 128, 1)">11</span>     
<span style="color: rgba(0, 128, 128, 1)">12</span>     <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¿å­˜æœ€ç»ˆç»“æœ</span>
<span style="color: rgba(0, 128, 128, 1)">13</span>     with open(results_dir/<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">summary.txt</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">w</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">) as f:
</span><span style="color: rgba(0, 128, 128, 1)">14</span>         <span style="color: rgba(0, 0, 255, 1)">for</span> layer, auc <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> results.items():
</span><span style="color: rgba(0, 128, 128, 1)">15</span>             f.write(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{layer}: {auc:.4f}\n</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<p>è¿è¡ŒæˆåŠŸåä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519171121782-2028203774.png" alt="" width="570" height="460" loading="lazy"></p>
<p>&nbsp;æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥summary.txtè·å–è®­ç»ƒæœ€ä¼˜çš„è®­ç»ƒç»“æœæ˜¯åˆ©ç”¨å“ªä¸€å±‚Embeddingã€‚æˆ‘è®­ç»ƒçš„ç»“æœæ˜¾ç¤ºç¬¬12å±‚embeddingè®­ç»ƒå¾—åˆ°çš„DNNé¢„æµ‹å™¨æ•ˆæœæœ€å¥½ï¼Œå°ä¼™ä¼´ä¼´ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å°è¯•ä¸åŒçš„æ¨¡å‹ä¸‹ï¼Œä¸åŒçš„DNNç»“æ„ï¼Œå“ªä¸€å±‚èƒ½è·å¾—æœ€å¥½çš„é¢„æµ‹æ•ˆæœã€‚</p>
<p><img src="https://img2024.cnblogs.com/blog/1463277/202505/1463277-20250519172442978-1111004721.png" alt="" width="191" height="421" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.18625611739699074" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-19 17:48">2025-05-19 17:47</span>&nbsp;
<a href="https://www.cnblogs.com/zylAK">zylAK</a>&nbsp;
é˜…è¯»(<span id="post_view_count">0</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18884621);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18884621', targetLink: 'https://www.cnblogs.com/zylAK/p/18884621', title: 'âœ¨ç”Ÿç‰©å¤§è¯­è¨€æ¨¡å‹Evo2â€”â€”è§£ç åŸºå› å¯†ç çš„AIé©å‘½&amp;#128640;' })">ä¸¾æŠ¥</a>
</div>
        