<!----> <meta itemprop="headline" content="我把大型团队项目从 vite 前端迁移到了 rsbuild，收益如何？"> <meta itemprop="keywords" content="Vite,前端,前端工程化"> <meta itemprop="datePublished" content="2024-10-15T12:12:29.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="o翔哥o"> <meta itemprop="url" content="https://juejin.cn/user/650530414137534"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-7cdd11fb="">
            我把大型团队项目从 vite 前端迁移到了 rsbuild，收益如何？
            <!----> <!----></h1> <div class="container team-follow" data-v-127e663e="" data-v-7cdd11fb=""><div class="left" data-v-127e663e=""><a href="/team/7325320140008980520/posts" data-v-127e663e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43f8fd2cfa3d465092b126b7596ccc4e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=876&amp;h=874&amp;s=174537&amp;e=png&amp;b=fdfcfc" class="icon" data-v-127e663e=""></a> <div class="content" data-v-127e663e=""><div style="display: flex" data-v-127e663e=""><a href="/team/7325320140008980520/posts" data-v-127e663e=""><p class="title-line" data-v-127e663e=""><span title="快手基础平台前端" class="title" data-v-127e663e="">快手基础平台前端</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-127e663e=""></p></a></div> <div class="meta-box team" data-v-127e663e="" data-v-7cdd11fb=""><time datetime="2024-10-15T12:12:29.000Z" title="Tue Oct 15 2024 12:12:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-127e663e="" data-v-7cdd11fb="">
                2024-10-15
              </time> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-127e663e="" data-v-7cdd11fb=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-127e663e="" data-v-7cdd11fb=""></path><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-127e663e="" data-v-7cdd11fb=""></circle></svg> <span class="views-count" style="display:none;" data-v-127e663e="" data-v-7cdd11fb="">
                13,089
              </span> <span class="read-time" data-v-127e663e="" data-v-7cdd11fb=""><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-127e663e="" data-v-7cdd11fb=""><rect width="16" height="16" fill="none" data-v-127e663e="" data-v-7cdd11fb=""></rect><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-127e663e="" data-v-7cdd11fb=""></circle><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-127e663e="" data-v-7cdd11fb=""></path></svg>
                阅读6分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-090b3d46="" data-v-127e663e=""><span data-v-090b3d46="" data-v-127e663e=""><i class="byte-icon byte-icon--plus" data-v-127e663e=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"></path><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"></path></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-7cdd11fb=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-7cdd11fb=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""> </div> <!----> <span class="position ellipsis" data-v-7cdd11fb="">
              前端研发工程师 @快手
            </span></div> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-7cdd11fb=""><div class="article-viewer markdown-body result"><h2 data-id="heading-0">背景</h2>
<p>我们团队的项目一直是使用 vite 作为打包工具的，由于 vite 开发环境和生产环境的打包策略不同（开发环境按需打包，生产环境全量打包），所以存在开发环境和线上环境打包产物表现不一致的风险。其中 css 顺序导致的样式权重不一致的问题尤为容易发生，目前在需求开发过程中，已多次遇到本地开发环境 css 样式符合 UI 稿，发布到测试环境或者线上之后就出现了差异的场景。</p>
<p>基于上述背景，我们期望迁移至一款开发和生产环境打包产物一致的工具。</p>
<h2 data-id="heading-1">方案调研</h2>
<p>除上述背景外，我们期望的打包工具还应该满足以下特性：</p>
<ul>
<li>开发和生产环境打包产物一致</li>
<li>打包性能优异</li>
<li>生态良好、项目足够稳定</li>
<li>迁移成本较低</li>
</ul>
<p>要满足打包性能优异的特性，除 vite 外，我们的打包工具范围最终锁定在由 rust 开发项目内：</p>



































<table><thead><tr><th></th><th>Turbopack</th><th>Farm</th><th>Rsbuild（基于rspack）</th></tr></thead><tbody><tr><td>产物一致性</td><td>❌ 不一致</td><td>✅ 一致</td><td>✅ 一致</td></tr><tr><td>打包性能</td><td>✅ 快</td><td>✅ 快</td><td>✅ 快</td></tr><tr><td>生态及稳定性</td><td>❌ 全新生态，生态链较差</td><td>✅ 兼容 vite 插件(先试验了下 farm，遇到的坑太多了且解决不了，根据 github 的用户数以及 npm 下载量，感觉目前尚未达到稳定可用状态)</td><td>✅ 兼容 webpack 插件且已有众多线上项目验证</td></tr><tr><td>迁移成本</td><td>❌ 高(没有对应的插件)</td><td>❌ 高(踩坑太多且无解决思路，应该是farm本身的坑)</td><td>✅ 中</td></tr></tbody></table>
<p>经过调研和实践，最终选定 rsbuild 作为最终的工具。</p>
<h2 data-id="heading-2">最终收益</h2>
<ul>
<li>
<p>打包时长：300s 左右 &gt; 60s 左右，性能提升大概 400% 左右</p>
<ul>
<li>迁移前 vite 打包时长：292s <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bc14706ab7e4cfbb85712383fd98a75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb-e_lOWTpW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735597535&amp;x-signature=oR4cVzp6lFcqDLWPDgut1rsEv1Q%3D" width="600" loading="lazy"></li>
<li>迁移后 rsbuild 打包时长：66s <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f0b809a9aa541f9a4d306b1a66ad960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb-e_lOWTpW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735597535&amp;x-signature=MF%2BMFs0Hr10s13fUynNINocCaHc%3D" width="600" loading="lazy"></li>
</ul>
</li>
<li>
<p>流水线构建时长：360s 左右 &gt; 130s 左右，减少 150%（整条流水线上除了打包之外，还有拉代码仓库、代码质量检测、安装依赖、上传 CDN 等其他工作，而构建工具只是减少了打包这一阶段的工作时长，但打包依然是占最大头的，所以收益还是很明显）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bf58f8efc244763ac9a7f49f129de9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb-e_lOWTpW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1735597535&amp;x-signature=xyJq0sIEM3lqksicWXdozEc5w4g%3D" alt="" loading="lazy"></p>
</li>
<li>
<p>冷启动时长：</p>
<ul>
<li>首页面渲染：10s 左右 &gt; 25s 左右（这里指的是从执行 <code>npm run dev</code> 到页面渲染出内容的时长）</li>
<li>其他页面首次切换：5s 左右 &gt; 1s 内（vite 由于资源是按需加载，在加载其他页面时需要对新页面资源进行 esbuild 构建，所以会慢）</li>
</ul>
<p>可以看到首屏冷启动时长性能有比较大的劣化，这是因为 vite 是根据页面按需资源打包，而 rsbuild 是全量打包。（但全量打包目前应该是解决开发和生产产物不一致的必要条件，为解决我们的背景问题必不可少）</p>
<p>冷启动时长综合对比，如果在开发过程中切换页面比较多的话，最终的等待时长 rspack 会胜于 vite；如果只关注于一个页面的开发，vite 这方面占优</p>
</li>
<li>
<p>热更新：0.5s 内 &gt; 1.5s 内（都是很低的数值，体感没有差别）</p>
</li>
<li>
<p>资源分包数：以我们项目的首屏为例，可以看到 rsbuild 的分包策略要优于 vite（打包总体积几乎无变化的情况下，分包数少了很多）：</p>
<ul>
<li>css 文件数: 38项 &gt; 9 项</li>
<li>js 文件数：81项 &gt; 55 项</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">迁移过程及踩坑</h2>
<h3 data-id="heading-4">安装相关依赖</h3>
<p>安装 rsbuild 核心包：</p>
<pre><code class="hljs language-sql" lang="sql">yarn <span class="hljs-keyword">add</span> <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>core <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>babel <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>less <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>sass <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>vue <span class="hljs-variable">@rsbuild</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>vue<span class="hljs-operator">-</span>jsx <span class="hljs-operator">-</span>D
</code></pre>
<p>其他插件根据自己项目的需要进行安装，可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.dev%2Fzh%2Fplugins%2Flist%2Findex" target="_blank" title="https://rsbuild.dev/zh/plugins/list/index" ref="nofollow noopener noreferrer">rsbuild 官网</a>找到。常用的有：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@rsbuild</span>/plugin-babel
<span class="hljs-variable">@rsbuild</span>/plugin-less
<span class="hljs-variable">@rsbuild</span>/plugin-sass
<span class="hljs-variable">@rsbuild</span>/plugin-vue
<span class="hljs-variable">@rsbuild</span>/plugin-vue-jsx
</code></pre>
<h3 data-id="heading-5">更改打包配置文件</h3>
<p>下面是以我们的项目为例（一些敏感代码没有在上面展示），将 <code>vite.config.ts</code> 迁移到 <code>rsbuild.config.ts</code> ，可以进行参考：</p>
<ul>
<li>
<p>vite.config.ts：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineConfig, loadEnv, <span class="hljs-title class_">UserConfigExport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Inspect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-inspect'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>;
<span class="hljs-keyword">import</span> { codeInspectorPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'code-inspector-plugin'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">isProduction</span> = env =&gt; env === <span class="hljs-string">'production'</span>;
<span class="hljs-keyword">const</span> cdn = <span class="hljs-string">'https://xxx.com/xyz/'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ mode }: { <span class="hljs-attr">mode</span>: <span class="hljs-built_in">string</span> }): <span class="hljs-function"><span class="hljs-params">UserConfigExport</span> =&gt;</span>
    <span class="hljs-title function_">defineConfig</span>({
        <span class="hljs-attr">base</span>: <span class="hljs-title function_">isProduction</span>(mode) ? cdn : <span class="hljs-string">'/'</span>,
        <span class="hljs-attr">plugins</span>: [
            <span class="hljs-title function_">vue</span>(),
            <span class="hljs-title function_">vueJsx</span>(),
            <span class="hljs-title function_">codeInspectorPlugin</span>({
                <span class="hljs-attr">bundler</span>: <span class="hljs-string">'vite'</span>,
            }), <span class="hljs-comment">// 开发环境 Meta + shift 切换开启/关闭，点击 dom 跳转源代码</span>
            <span class="hljs-title class_">AutoImport</span>({
                <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>],
                <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/auto-import.d.ts'</span>,
            }),
        ],
        <span class="hljs-attr">resolve</span>: {
            <span class="hljs-attr">alias</span>: [
                {
                    <span class="hljs-attr">find</span>: <span class="hljs-string">'@'</span>,
                    <span class="hljs-attr">replacement</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>),
                },
            ],
        },
        <span class="hljs-attr">server</span>: {
            <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,
            <span class="hljs-attr">port</span>: <span class="hljs-number">4000</span>,
            <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">proxy</span>: {
                <span class="hljs-string">'/api/'</span>: {
                    <span class="hljs-attr">target</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_HOST</span>, <span class="hljs-comment">// 转发域名</span>
                    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-attr">headers</span>: {
                        <span class="hljs-attr">referer</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_REFERER</span>,
                        <span class="hljs-attr">host</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_HOST</span>,
                        <span class="hljs-title class_">Cookie</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_COOKIE</span>, <span class="hljs-comment">// 转发</span>
                    },
                },
            },
        }
    });
</code></pre>
</li>
<li>
<p>rsbuild.config.ts：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/core'</span>;
<span class="hljs-keyword">import</span> { pluginVue } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/plugin-vue'</span>;
<span class="hljs-keyword">import</span> { pluginVueJsx } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/plugin-vue-jsx'</span>;
<span class="hljs-keyword">import</span> { pluginBabel } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/plugin-babel'</span>;
<span class="hljs-keyword">import</span> { pluginLess } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/plugin-less'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/rspack'</span>;
<span class="hljs-keyword">import</span> { codeInspectorPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'code-inspector-plugin'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;


<span class="hljs-keyword">const</span> <span class="hljs-title function_">isProduction</span> = env =&gt; env === <span class="hljs-string">'production'</span>;
<span class="hljs-keyword">const</span> cdn = <span class="hljs-string">'https://xxxx.com/xyz/'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_APP_HOST</span>, <span class="hljs-variable constant_">VITE_APP_COOKIE</span>, <span class="hljs-variable constant_">VITE_APP_REFERER</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ env }</span>) =&gt;</span> ({
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">assetPrefix</span>: <span class="hljs-title function_">isProduction</span>(env) ? cdn : <span class="hljs-string">'/'</span>,
        <span class="hljs-attr">distPath</span>: {
            <span class="hljs-attr">root</span>: <span class="hljs-string">'dist'</span>,
            <span class="hljs-attr">html</span>: <span class="hljs-string">'./'</span>,
            <span class="hljs-attr">js</span>: <span class="hljs-string">'./'</span>,
            <span class="hljs-attr">jsAsync</span>: <span class="hljs-string">'./'</span>,
            <span class="hljs-attr">css</span>: <span class="hljs-string">'assets'</span>,
            <span class="hljs-attr">cssAsync</span>: <span class="hljs-string">'assets'</span>,
            <span class="hljs-attr">svg</span>: <span class="hljs-string">'assets'</span>,
            <span class="hljs-attr">font</span>: <span class="hljs-string">'assets'</span>,
            <span class="hljs-attr">image</span>: <span class="hljs-string">'assets'</span>,
            <span class="hljs-attr">media</span>: <span class="hljs-string">'assets'</span>,
        },
        <span class="hljs-attr">sourceMap</span>: {
            <span class="hljs-attr">js</span>: <span class="hljs-title function_">isProduction</span>(env) ? <span class="hljs-string">'source-map'</span> : <span class="hljs-string">'cheap-module-source-map'</span>,
            <span class="hljs-attr">css</span>: <span class="hljs-literal">true</span>,
        },
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-title function_">pluginLess</span>({
            <span class="hljs-attr">lessLoaderOptions</span>: {
                <span class="hljs-attr">lessOptions</span>: {
                    <span class="hljs-attr">javascriptEnabled</span>: <span class="hljs-literal">false</span>,
                },
                <span class="hljs-attr">implementation</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'less'</span>),
            },
        }),
        <span class="hljs-title function_">pluginBabel</span>({
            <span class="hljs-attr">include</span>: <span class="hljs-regexp">/.(?:jsx|tsx)$/</span>,
        }),
        <span class="hljs-title function_">pluginVue</span>(),
        <span class="hljs-title function_">pluginVueJsx</span>(),
    ],
    <span class="hljs-attr">tools</span>: {
        <span class="hljs-attr">htmlPlugin</span>: {
            <span class="hljs-attr">template</span>: <span class="hljs-string">'./index.html'</span>,
        },
        <span class="hljs-attr">rspack</span>: {
            <span class="hljs-attr">plugins</span>: [
                <span class="hljs-title class_">AutoImport</span>({
                    <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>],
                    <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/auto-import.d.ts'</span>,
                }),
                <span class="hljs-title function_">codeInspectorPlugin</span>({
                    <span class="hljs-attr">bundler</span>: <span class="hljs-string">'rspack'</span>,
                }),
            ],
            <span class="hljs-attr">module</span>: {
                <span class="hljs-attr">rules</span>: [
                    {
                        <span class="hljs-attr">resourceQuery</span>: <span class="hljs-regexp">/raw/</span>,
                        <span class="hljs-attr">type</span>: <span class="hljs-string">'asset/source'</span>,
                    },
                ],
            },
        },
    },
    <span class="hljs-attr">source</span>: {
        <span class="hljs-attr">alias</span>: {
            <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>),
        },
        <span class="hljs-attr">define</span>: {
            <span class="hljs-string">'import.meta.env.VITE_APP_HOST'</span>: <span class="hljs-string">`'<span class="hljs-subst">${VITE_APP_HOST}</span>'`</span>,
        },
    },
    <span class="hljs-attr">server</span>: {
        <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-number">4000</span>,
        <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">proxy</span>: {
            <span class="hljs-string">'/api/'</span>: {
                <span class="hljs-attr">target</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_HOST</span>, <span class="hljs-comment">// 转发域名</span>
                <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">headers</span>: {
                    <span class="hljs-attr">referer</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_REFERER</span>,
                    <span class="hljs-attr">host</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_HOST</span>,
                    <span class="hljs-title class_">Cookie</span>: <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()).<span class="hljs-property">VITE_APP_COOKIE</span>, <span class="hljs-comment">// 转发</span>
                },
            },
        },
    },
}));
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">修改对应指令</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rsbuild dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rsbuild build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rsbuild preview"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// others...</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// ...others</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-7">修改 index.html</h3>
<p>移除掉 <code>index.html</code> 之前的 <code>&lt;script src="main.ts"&gt;&lt;/script&gt;</code> 引入代码。</p>
<h3 data-id="heading-8">踩坑</h3>
<h4 data-id="heading-9">import.meta 不兼容</h4>
<p><code>import.meta</code> 是浏览器 module 模块中独有的语法，rsbuild 在 <code>rsbuild.config.js</code> 中可以使用 <code>import.meta</code>，但是在项目源代码中并不支持，所以我们需要对原本代码中的 <code>import.meta</code> 进行适配。</p>
<p>以我们项目为例，大部分代码中的 <code>import.meta.XXX</code> 都是在本地的 <code>.env.local</code> 文件中定义的，我们可以借助 <code>source.define</code> 去进行全局的声明：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rsbuild/core'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_APP_HOST</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ env }</span>) =&gt;</span> ({
    <span class="hljs-attr">source</span>: {
        <span class="hljs-attr">define</span>: {
            <span class="hljs-string">'import.meta.env.VITE_APP_HOST'</span>: <span class="hljs-string">`'<span class="hljs-subst">${VITE_APP_HOST}</span>'`</span>,
        },
    },
}));
</code></pre>
<p>另外我们项目还用到了 <code>import.meta.url</code> 去引入资源，这种需要改为 import 方式去引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 改之前：</span>
<span class="hljs-keyword">const</span> href = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'../assets/icon.png'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>).<span class="hljs-property">href</span>;

<span class="hljs-comment">// 改之后：</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">IconPNG</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../assets/icon.png'</span>;
<span class="hljs-keyword">const</span> href = <span class="hljs-title class_">IconPNG</span>;
</code></pre>
<h4 data-id="heading-10">:deep 和 &amp; 兼容问题</h4>
<p>目前已知 @rsbuild/plugin-less 插件对于在 :deep 内部使用 less 的 &amp; 符号会有问题，例如：</p>
<ul>
<li>case1: 生效</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.container</span> {
    <span class="hljs-selector-class">.content</span> {
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-tag">_title</span> {
            <span class="hljs-attribute">font-weight</span>: bold;
        }
    }
}
</code></pre>
<ul>
<li>case2: 生效</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.container</span> {
    :<span class="hljs-selector-tag">deep</span>(.content) {
        <span class="hljs-selector-class">.content_title</span> {
            <span class="hljs-attribute">font-weight</span>: bold;
        }
    }
}
</code></pre>
<ul>
<li>case3: 不生效</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.container</span> {
    :<span class="hljs-selector-tag">deep</span>(.content) {
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-tag">_title</span> {
            <span class="hljs-attribute">font-weight</span>: bold;
        }
    }
}
</code></pre>
<p>后面会去 github 提个 issue，我们项目内部这种使用情况很少，所以暂时手动修改为不使用 <code>&amp;</code>。</p>
<h4 data-id="heading-11">css 中使用 v-bind 不支持三元运算符</h4>
<p>不支持在 css 中 v-bind 使用三元运算符，可以改成在 js 中使用三元运算符替代</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 改之前：</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">v-bind</span>(title ? <span class="hljs-string">'24px'</span> : <span class="hljs-string">'48px'</span>);
}

<span class="hljs-comment">// 改之后：</span>
<span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">containerHeight</span> = <span class="hljs-selector-tag">title</span> ? '<span class="hljs-number">24px</span>' : '<span class="hljs-number">48px</span>'; <span class="hljs-comment">// js中写</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">v-bind</span>(containerHeight);
}
</code></pre>
<h2 data-id="heading-12">结论</h2>
<p>我们的项目目前有 2500+ 文件、30w+ 行代码，算是一个很大的项目了。对于这样一个大型项目而言，从 vite 迁移 rsbuild 的过程中遇到的坑可以算很少了，而且迁移后的收益很明显，足以证明 rsbuild 及 rspack 是一个十分优秀的项目，且完全可以在生产环境中去应用了。</p>
<p>对于 webpack 构建的项目，我相信收益会更加明显，有折腾想法的朋友可以年底迁移一波作为 KPI 试试</p>
<blockquote>
<p>最后的最后，快手基础平台团队招前端，欢迎在平台私信我投简历~</p>
</blockquote></div></div>