
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kqdssheng/p/18989007" title="发布于 2025-07-17 10:11">
    <span role="heading" aria-level="2">域渗透指南</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>来说是非者，便是是非人。</p>
</blockquote>
<h2 id="导航">导航</h2>
<ul>
<li><a href="#id0" rel="noopener nofollow">零 - 前言</a></li>
<li><a href="#id1" rel="noopener nofollow">壹 - 突破点</a></li>
<li><a href="#id2" rel="noopener nofollow">贰 - 权限提升</a></li>
<li><a href="#id3" rel="noopener nofollow">叁 - 横向移动</a></li>
<li><a href="#id4" rel="noopener nofollow">肆 - 会话维持</a></li>
<li><a href="#id5" rel="noopener nofollow">伍 - 辅助工具</a></li>
</ul>
<hr>
<h2 id="-零---前言-"><strong><div id="id0"> 零 - 前言 </div></strong></h2>
<p>域提权与 Windows 提权的不同之处在于：Windows 提权的前提是 <strong>必须先获得目标机器的立足点</strong>（即 Shell），然后再枚举机器自身弱点，最终获得机器的本地 SYSTEM 或管理员权限；而域提权则 <strong>可以是在获得任意域主机立足点的情况下进行、也可以是在获得任意普通域用户凭证但无法登录域主机的情况下进行</strong>，然后再枚举域环境的弱点，最终获得域控机器的本地 SYSTEM 或域管理员权限。</p>
<h2 id="-壹---突破点-"><strong><div id="id1"> 壹 - 突破点 </div></strong></h2>
<h4 id="rce-漏洞">RCE 漏洞</h4>
<ol>
<li>扫描目标网络的所有域主机，检查能否发现一些  Windows 系统的经典 RCE 漏洞（如 ms17-010 漏洞）。【命令：<code>nmap --script='smb-vuln-*' -p 445 192.168.56.0/24</code> 或 <code>nxc smb 192.168.56.0/24 -M ms17-010</code>】</li>
<li>聚焦于应用服务器，结合系统上运行的应用服务（如 FTP、IIS），看看这些应用组件是否存在 RCE 漏洞。</li>
<li>聚焦于 WEB 服务器，检查网站中是否存在 <strong>命令注入、SQL 注入、XXE 注入、SSRF、远程包含、本地包含+文件上传</strong> 等可直接或间接获得 web shell 的漏洞。</li>
</ol>
<h4 id="凭证爆破">凭证爆破</h4>
<ol>
<li>尝试使用 impacket-lookupsid 或 enum4linux-ng 工具 <strong>匿名枚举域用户</strong>，或借助 <a href="https://github.com/ropnop/kerbrute" target="_blank" rel="noopener nofollow">kerbrute</a> 工具进行用户名爆破。【命令：<code>impacket-lookupsid skylark.com/guest@192.168.56.50</code> 或 <code>enum4linux-ng -A -u "" -p "" 192.168.56.50</code> 或 <code>./kerbrute_linux_386 userenum -d skylark.com --dc 192.168.56.50 user.txt</code>】</li>
<li>根据得到的域用户列表，借助 <a href="https://github.com/TarlogicSecurity/kerbrute" target="_blank" rel="noopener nofollow">kerbrute.py</a> 工具检测 <strong>禁用预认证的用户</strong>。若检测到了，便可以进行 AS-REP 哈希的爆破，<em>进而就有可能获得域用户的凭证</em>。 【命令：<code>python kerbrute.py -domain skylark.com -user user.txt -dc-ip 192.168.56.50</code>】</li>
<li>若未检测到禁用预认证的用户，则使用 nxc 结合已获得的用户名列表进行 <strong>密码喷洒</strong>。若用户名列表特别长，那么优先使用命令 1 进行；若用户名列表并不长，那么命令 1 和命令 2 随意。【命令 1：<code>nxc smb 192.168.56.50 -u user.txt -p pass.txt -d skylark.com --continue-on-success | grep +</code> 、命令 2：<code>nxc smb 192.168.56.50 -u user.txt -p pass.txt -d skylark.com --no-bruteforce --continue-on-success | grep +</code>】</li>
<li>若在 Web 检测中发现了 SSRF 的漏洞，那便可以借助 Responder 进行 NTLMv2 哈希的 <strong>哈希爆破</strong>，<em>进而就有可能获得域用户的凭证</em>。</li>
<li>此外，若处在局域网中的话，也可以使用 Responder 尝试进行 NTLMv2 哈希的捕获，万一就有意外惊喜。【命令：<code>responder -I eth0</code>】</li>
</ol>
<blockquote>
<p>注：若经过以上 RCE 漏洞中的步骤最终获得了立足点，而为了可以供一些工具远程使用该用户的权限，则可以使用 rubeus.exe 导出域主机上当前用户的 TGT 票据。<code>Rubeus.exe tgtdeleg /nowrap &gt;ticket.txt</code></p>
</blockquote>
<h2 id="-贰---权限提升-"><strong><div id="id2"> 贰 - 权限提升 </div></strong></h2>
<h4 id="委派">委派</h4>
<ol>
<li>检查当前用户对域控是否具有 <strong>约束委派</strong> 权限。【命令：<code>impacket-findDelegation skylark.com/user:'password@123' -dc-ip 192.168.56.50</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18952409#id3" target="_blank">更多参考</a>】</li>
<li>检查当前用户对域控是否具有 <strong>基于资源的委派</strong> 权限。【命令：<code>impacket-rbcd skylark.com/user:'password@123' -dc-ip 192.168.56.50 -action read -delegate-to DC2012$</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18952409#id4" target="_blank">更多参考</a>】</li>
<li>若检查发现当前用户没有对域控的委派权限，但存在其它用户对域控或对其它服务器具备委派权限，则 <strong>暂时先跳过</strong> 委派部分的利用，待后续提权不成功之后再回来。</li>
</ol>
<h4 id="ntlm-中继-强制认证">NTLM 中继-强制认证</h4>
<ol>
<li>检查域控机器是否是主备式的、存在 NTLM 强制认证漏洞、存在 remove-mic 漏洞，<strong>若不满足以上任意一个条件则直接跳过以下步骤</strong>。【命令：<code>nxc smb 192.168.56.51 -u user -p 'password@123' -d skylark.com -M coerce_plus</code> 和 <code>nxc smb 192.168.56.51 -u user -p 'password@123' -d skylark.com -M remove-mic</code>】</li>
<li>优先尝试 <strong>NTLM 中继-委派</strong> 攻击。【<a href="https://www.cnblogs.com/kqdssheng/p/18985420#id1" target="_blank">更多参考</a>】</li>
<li>若域控操作系统是 Windows 2016+，则尝试 <strong>NTLM 中继-影子凭证</strong> 攻击。【<a href="https://www.cnblogs.com/kqdssheng/p/18985420#id3" target="_blank">更多参考</a>】</li>
<li>若域控还提供证书颁发和 Web 申请证书的服务，则尝试 <strong>NTLM 中继-ADCS 证书申请</strong> 攻击。【<a href="https://www.cnblogs.com/kqdssheng/p/18985420#id2" target="_blank">更多参考</a>】</li>
</ol>
<h4 id="提权漏洞">提权漏洞</h4>
<ol>
<li>ZeroLogon 漏洞。【命令：<code>nxc smb 192.168.56.50 -M zerologon</code>】【<a href="https://blog.csdn.net/Captain_RB/article/details/120643838" target="_blank" rel="noopener nofollow">更多参考</a>】</li>
<li>PrintNightmare 漏洞。【命令：<code>nxc smb 192.168.56.50 -u 'user' -p 'password@123' -d skylark.com-M printnightmare</code> 检测法很有效，<code>impacket-rpcdump 192.168.56.50 | egrep 'MS-RPRN|MS-PAR'</code> 检测法似乎不是很准确。】【<a href="https://www.cnblogs.com/kqdssheng/p/18753135" target="_blank">更多参考</a>】</li>
<li>CertiFried 漏洞。【命令：<code>nxc ldap 192.168.56.50 -u 'user' -p 'password@123' -d skylark.com-M adcs</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18916959" target="_blank">更多参考</a>】</li>
<li>noPAC 漏洞。【命令：<code>nxc smb -u 'user' -p 'password@123' -d skylark.com 192.168.56.50 -M nopac</code>】【<a href="https://cblog.gm7.org/docs/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E/#cve-2021-1675cve-2021-34527printnightmare" target="_blank" rel="noopener nofollow">更多参考</a>】</li>
</ol>
<blockquote>
<p>注：域提权漏洞并不总是支持远程（凭证、票据）提权，这时候就只能在获得立足点的环境（shell）下进行利用了。</p>
</blockquote>
<h2 id="-叁---横向移动-"><strong><div id="id3"> 叁 - 横向移动 </div></strong></h2>
<p>在一系列域提权操作不成功之后，还可以借助一些技巧进行横向移动，以期望能发现一些惊喜。</p>
<ol>
<li>检查是否存在 <strong>可进行 kerberoasting 攻击的域服务帐户</strong>，若存在的话则继续检查其所属组的情况（若是域管理组的话自然最好，通常来说服务所运行的账户总是有一定价值的。），以决定是否值得花费大量工夫去破解哈希。【命令：<code>impacket-GetUserSPNs skylark.com/user:'password@123' -dc-ip 192.168.56.50</code>】【<a href="https://www.cnblogs.com/kqdssheng/p/18891731" target="_blank">更多参考</a>】</li>
<li>使用 <strong>已有的凭证（账户密码、账户哈希、TGT 票据）去遍历域中所有的主机</strong>，以期望能够发现该凭证在某域主机上拥有本地管理员的权限。【命令：<code>nxc smb 192.168.56.0/24 -u 'user' -p 'password@123' -d skylark.com</code> | grep Pwn】</li>
<li>检查当前域主机的系统情况，看看是否能够查找到可以进行 <strong>Windows 本地提权</strong> 的方法。若能够本地提权的话，就又能多一些查找域提权的方法。【<a href="https://www.cnblogs.com/kqdssheng/p/18844363" target="_blank">更多参考</a>】</li>
<li>在本地提权能够成功的前提下，还可以进行 <strong>令牌模拟和 LSASS 进程转储</strong>，以期望能够发现一些曾在本机登录过的其它用户的令牌或哈希信息。【<a href="https://www.cnblogs.com/kqdssheng/p/18901139" target="_blank">更多参考 1</a>、<a href="https://www.cnblogs.com/kqdssheng/p/18922628" target="_blank">更多参考 2</a>】</li>
</ol>
<h2 id="-肆---会话维持-"><strong><div id="id4"> 肆 - 会话维持 </div></strong></h2>
<p>在完全控制了域控机器之后，可以采取以下措施来维持对 DC 机器的持续访问控制。</p>
<ol>
<li>转储 krbtgt 账户和 DC 机器账户的哈希，这样便可以通过离线制作金票银票，来发起对域控的票据传递攻击。同时，也是因为这两个账户的密码基本上并不会像域账户那样被随意修改。【<a href="https://www.cnblogs.com/kqdssheng/p/18894663" target="_blank">更多参考</a>】</li>
<li></li>
</ol>
<h2 id="-伍---辅助工具-"><strong><div id="id5"> 伍 - 辅助工具 </div></strong></h2>
<ol>
<li><a href="https://github.com/SpecterOps/BloodHound" target="_blank" rel="noopener nofollow">BloodHound CE</a>【<a href="https://www.kali.org/tools/bloodhound/" target="_blank" rel="noopener nofollow">安装参考 1</a>、<a href="https://breachar.medium.com/install-bloodhound-ce-under-kali-linux-2024-4-2a68feebdb62" target="_blank" rel="noopener nofollow">安装参考 2</a>】</li>
<li><a href="https://github.com/SpecterOps/BloodHound-Legacy/" target="_blank" rel="noopener nofollow">BloodHound Legacy</a>【<a href="http://www.luckysec.cn/posts/7ebaa71c.html" target="_blank" rel="noopener nofollow">安装参考</a>】</li>
<li><a href="https://github.com/lefayjey/linWinPwn" target="_blank" rel="noopener nofollow">linWinPwn </a></li>
</ol>
<blockquote>
<p>注意：BloodHound CE 版本的采集器和 Legacy 版本的采集器不通用，查询语法规则亦如此。</p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-07-17 10:11">2025-07-17 10:11</span>&nbsp;
<a href="https://www.cnblogs.com/kqdssheng">扛枪的书生</a>&nbsp;
阅读(<span id="post_view_count">46</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18989007);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18989007', targetLink: 'https://www.cnblogs.com/kqdssheng/p/18989007', title: '域渗透指南' })">举报</a>
</div>
        