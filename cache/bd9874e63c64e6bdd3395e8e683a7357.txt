
		<h2>
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ydswin/p/18675228" title="发布于 2025-01-16 16:25">
    <span role="heading" aria-level="2">Chrony：让你的服务器时间精准到微秒级的神器！</span>
    

</a>

		</h2>
		<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>在现代计算机系统中，时间同步是至关重要的。无论是分布式系统、数据库集群，还是日志记录，时间不一致都可能导致严重的问题。而 <strong>Chrony</strong>，作为一款高性能的时间同步工具，正在成为越来越多系统管理员的首选。它不仅比传统的 <code>ntpd</code> 更快、更精准，还能在网络不稳定的情况下保持出色的表现。今天，我们就来深入探讨 Chrony 的强大功能，以及如何用它来让你的服务器时间精准到微秒级！</p>
<hr>
<h2 id="为什么需要-chrony"><strong>为什么需要 Chrony？</strong></h2>
<p>在分布式系统中，时间同步的重要性不言而喻。如果服务器之间的时间不一致，可能会导致以下问题：</p>
<ul>
<li>日志时间错乱，难以排查问题。</li>
<li>数据库事务冲突，数据一致性被破坏。</li>
<li>分布式锁失效，系统出现不可预知的错误。</li>
</ul>
<p>而 Chrony 正是为了解决这些问题而生的。它通过以下特性脱颖而出：</p>
<ul>
<li><strong>快速同步</strong>：在网络条件良好的情况下，Chrony 可以在几秒内完成时间同步。</li>
<li><strong>高精度</strong>：支持微秒级的时间同步，满足高精度需求。</li>
<li><strong>适应性强</strong>：即使在网络波动或高延迟的环境中，Chrony 也能保持稳定同步。</li>
<li><strong>低资源占用</strong>：适合资源受限的设备，如嵌入式系统或虚拟机。</li>
</ul>
<hr>
<h2 id="chrony-的核心优势"><strong>Chrony 的核心优势</strong></h2>
<h3 id="1-比-ntpd-更快更精准">1. <strong>比 ntpd 更快、更精准</strong></h3>
<p>Chrony 的设计目标之一就是比传统的 <code>ntpd</code> 更快地完成时间同步。它通过智能算法和 <code>iburst</code> 选项，在初始同步时发送多个请求，从而大幅缩短同步时间。</p>
<h3 id="2-适应网络波动">2. <strong>适应网络波动</strong></h3>
<p>如果你的服务器位于网络不稳定的环境中（比如云服务器或移动设备），Chrony 的表现会更加出色。它能够动态调整同步策略，减少网络波动对时间同步的影响。</p>
<h3 id="3-支持离线模式">3. <strong>支持离线模式</strong></h3>
<p>即使在没有网络连接的情况下，Chrony 也能依靠本地时钟的漂移率来保持时间的准确性。这对于需要离线运行的系统来说非常实用。</p>
<h3 id="4-低资源占用">4. <strong>低资源占用</strong></h3>
<p>Chrony 的资源占用非常低，适合在嵌入式设备或虚拟机中运行。它不会对系统性能造成明显影响。</p>
<hr>
<h2 id="如何配置-chrony"><strong>如何配置 Chrony？</strong></h2>
<p>Chrony 的配置文件通常位于 <code>/etc/chrony.conf</code>，以下是一个简单的配置示例：</p>
<pre><code class="language-bash"># 使用阿里云的NTP服务器作为时间源
# `iburst` 选项表示在初始同步时发送多个请求，加快同步速度
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst

# 使用本地时钟作为备用时间源
# `stratum 10` 表示本地时钟的层级为10（层级越高，优先级越低）
local stratum 10

# 允许192.168.1.0/24网段的主机访问chrony服务
# 可以用于允许内网设备同步时间
allow 192.168.1.0/24

# 拒绝所有其他主机访问chrony服务
# 这是一个安全措施，确保只有允许的网段可以访问
deny all

# 启用RTC（硬件时钟）同步
# 这会将系统时间同步到硬件时钟，确保重启后时间仍然准确
rtcsync

# 设置时间步进调整
# 如果时间偏差超过1.0秒，chrony会立即调整时间
# 在前3次调整中允许步进调整
makestep 1.0 3

# 指定时钟漂移文件的路径
# 该文件用于记录系统时钟的漂移率，帮助chrony更准确地调整时间
driftfile /var/lib/chrony/drift

# 指定日志文件的存储目录
# chrony会将日志文件（如measurements.log、statistics.log等）存储在此目录
logdir /var/log/chrony

# 配置日志记录行为
# `measurements`：记录时间测量的日志
# `statistics`：记录统计信息的日志
# `tracking`：记录时间跟踪信息的日志
log measurements statistics tracking

# 指定NTP认证密钥文件的路径
# 如果需要使用NTP认证功能，可以在此指定密钥文件
keyfile /etc/chrony.keys

# 允许本地主机通过chronyc命令行工具管理chrony
# 这是一个安全措施，确保只有本地用户可以管理chrony
cmdallow 127.0.0.1

# 设置NTP服务器的轮询间隔
# `minpoll 6` 表示最小轮询间隔为2^6=64秒
# `maxpoll 8` 表示最大轮询间隔为2^8=256秒
server ntp2.aliyun.com minpoll 6 maxpoll 8

# 设置NTP服务器的优先级
# `prefer` 表示优先使用该服务器
server ntp3.aliyun.com prefer
</code></pre>
<p>配置完成后，启动 Chrony 服务：</p>
<pre><code class="language-bash">sudo systemctl start chronyd
sudo systemctl enable chronyd
</code></pre>
<hr>
<h2 id="chrony-的常用命令"><strong>Chrony 的常用命令</strong></h2>
<p>Chrony 提供了一个强大的命令行工具 <code>chronyc</code>，用于监控和管理时间同步。以下是一些常用命令：</p>
<h3 id="1-查看时间服务器状态"><strong>1. 查看时间服务器状态</strong></h3>
<pre><code class="language-bash">chronyc sources -v
</code></pre>
<ul>
<li>显示当前配置的时间服务器及其状态。</li>
<li><code>^*</code> 表示当前正在使用的服务器。</li>
<li><code>^+</code> 表示可用的备用服务器。</li>
</ul>
<p>示例输出：</p>
<pre><code>MS Name/IP address         Stratum Poll Reach LastRx Last sample
===============================================================================
^* ntp.aliyun.com                2   6   377    46    +12us[-123us] +/-   23ms
^+ ntp1.aliyun.com               2   6   377    45    -10us[-145us] +/-   25ms
</code></pre>
<hr>
<h3 id="2-查看同步状态"><strong>2. 查看同步状态</strong></h3>
<pre><code class="language-bash">chronyc tracking
</code></pre>
<ul>
<li>显示当前系统的时钟同步状态，包括时间偏差、频率偏移等。</li>
</ul>
<p>示例输出：</p>
<pre><code>Reference ID    : 123.456.789.101 (ntp.aliyun.com)
Stratum         : 3
Ref time (UTC)  : Tue Jan 16 12:34:56 2025
System time     : 0.000123 seconds slow of NTP time
Last offset     : +0.000045 seconds
RMS offset      : 0.000012 seconds
Frequency       : 1.234 ppm slow
Residual freq   : +0.001 ppm
Skew            : 0.012 ppm
Root delay      : 0.023456 seconds
Root dispersion : 0.001234 seconds
Update interval : 64.2 seconds
Leap status     : Normal
</code></pre>
<hr>
<h3 id="3-手动同步时间"><strong>3. 手动同步时间</strong></h3>
<pre><code class="language-bash">chronyc makestep
</code></pre>
<ul>
<li>强制立即同步系统时间，适用于时间偏差较大的情况。</li>
</ul>
<hr>
<h3 id="4-检查客户端访问"><strong>4. 检查客户端访问</strong></h3>
<pre><code class="language-bash">chronyc clients
</code></pre>
<ul>
<li>显示当前连接到 Chrony 的客户端信息。</li>
</ul>
<p>示例输出：</p>
<pre><code>Hostname                      NTP   Drop Int IntL Last
===============================================================================
192.168.1.100                 2      0   6   -    45
192.168.1.101                 2      0   6   -    50
</code></pre>
<hr>
<h3 id="5-查看时间服务器的详细信息"><strong>5. 查看时间服务器的详细信息</strong></h3>
<pre><code class="language-bash">chronyc sourcestats -v
</code></pre>
<ul>
<li>显示时间服务器的统计信息，包括延迟、偏差等。</li>
</ul>
<p>示例输出：</p>
<pre><code>Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
===============================================================================
ntp.aliyun.com             12   7   100     +0.001      0.012    +45us    12us
ntp1.aliyun.com            10   6   100     -0.002      0.015    -30us    15us
</code></pre>
<hr>
<h3 id="6-添加或删除时间服务器"><strong>6. 添加或删除时间服务器</strong></h3>
<ul>
<li>添加时间服务器：<pre><code class="language-bash">chronyc add server ntp2.aliyun.com
</code></pre>
</li>
<li>删除时间服务器：<pre><code class="language-bash">chronyc delete ntp2.aliyun.com
</code></pre>
</li>
</ul>
<hr>
<h3 id="7-检查-chrony-的活动状态"><strong>7. 检查 Chrony 的活动状态</strong></h3>
<pre><code class="language-bash">chronyc activity
</code></pre>
<ul>
<li>显示当前 Chrony 的活动状态，包括正在使用的服务器数量。</li>
</ul>
<p>示例输出：</p>
<pre><code>200 OK
4 sources online
0 sources offline
0 sources doing burst (return to online)
0 sources doing burst (return to offline)
0 sources with unknown address
</code></pre>
<hr>
<h3 id="8-手动调整时间"><strong>8. 手动调整时间</strong></h3>
<pre><code class="language-bash">chronyc settime "2025-1-16 12:34:56"
</code></pre>
<ul>
<li>手动设置系统时间（需谨慎使用）。</li>
</ul>
<hr>
<h3 id="9-检查-chrony-的版本"><strong>9. 检查 Chrony 的版本</strong></h3>
<pre><code class="language-bash">chronyc -v
</code></pre>
<ul>
<li>显示 Chrony 的版本信息。</li>
</ul>
<hr>
<h3 id="10-重启-chrony-服务"><strong>10. 重启 Chrony 服务</strong></h3>
<pre><code class="language-bash">sudo systemctl restart chronyd
</code></pre>
<ul>
<li>重启 Chrony 服务以应用配置更改。</li>
</ul>
<hr>
<h2 id="chrony-vs-ntpd谁更适合你"><strong>Chrony vs. ntpd：谁更适合你？</strong></h2>
<table>
<thead>
<tr>
<th>特性</th>
<th>Chrony</th>
<th>ntpd</th>
</tr>
</thead>
<tbody>
<tr>
<td>同步速度</td>
<td>更快</td>
<td>较慢</td>
</tr>
<tr>
<td>网络适应性</td>
<td>适应网络波动</td>
<td>对网络稳定性要求较高</td>
</tr>
<tr>
<td>资源占用</td>
<td>低</td>
<td>较高</td>
</tr>
<tr>
<td>配置复杂度</td>
<td>简单</td>
<td>较复杂</td>
</tr>
<tr>
<td>离线模式支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody>
</table>
<p>如果你的系统需要快速、精准的时间同步，并且可能面临网络不稳定的情况，那么 Chrony 无疑是更好的选择。</p>
<hr>
<h2 id="总结"><strong>总结</strong></h2>
<p>Chrony 是一款强大而灵活的时间同步工具，能够为你的服务器提供高精度的时间同步服务。无论是数据中心、云服务器，还是嵌入式设备，Chrony 都能轻松应对。通过简单的配置和管理，你可以让系统时间精准到微秒级，彻底告别时间不一致带来的烦恼！</p>
<p>如果你还没有尝试过 Chrony，现在就动手安装吧！相信它会成为你系统管理工具箱中的又一利器。</p>

</div>
<div id="MySignature" role="contentinfo">
    <p>本文来自博客园，作者：<a href="https://www.cnblogs.com/ydswin/" target="_blank">dashery</a>，转载请注明原文链接：<a href="https://www.cnblogs.com/ydswin/p/18675228" target="_blank">https://www.cnblogs.com/ydswin/p/18675228</a></p>
</div>
<div class="clear"></div>

		<p class="postfoot">
			posted on 
<span id="post-date" data-last-update-days="0.5572983164490741" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-01-16 21:19">2025-01-16 16:25</span>&nbsp;
<a href="https://www.cnblogs.com/ydswin">dashery</a>&nbsp;
阅读(<span id="post_view_count">171</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=18675228" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18675228);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18675228', targetLink: 'https://www.cnblogs.com/ydswin/p/18675228', title: 'Chrony：让你的服务器时间精准到微秒级的神器！' })">举报</a>

		</p>
	