
<table cellspacing="0" cellpadding="0"><tbody><tr><td class="t_f" id="postmessage_53661799">
<i class="pstatus"> 本帖最后由 zwb83925462 于 2025-8-30 14:10 编辑 </i><br>
<br>
鉴于帖子https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=2052017的评论区很多人都说操作太复杂,<br>
故在此处提供一个简化步骤,会用到一些第三方工具,比如nodejs,还有浏览器扩展油猴脚本或者脚本猫,<br>
本教程提供的文件没有加入恶意代码,请放心使用,里面的cbox.exe和dll文件都是大佬的原版文件,并未修改过一个字节,运行库则是微软带签名的原版.<br>
步骤主体分为两个部分,第一步是在浏览器上下载好加密视频文件,以.ts结尾;第二步是利用批处理文件在命令行执行解密指令,所有的准备工作只需要执行一次,准备完成后,下次只需要执行操作步骤<br>
首先是<font size="5">第一步</font>的<font size="5">准备工作</font>:在浏览器(只在Chrome浏览器的136版本下测试过)安装可以执行油猴脚本的扩展,比如<font size="4">TamperMonkey</font>或者<font size="4">脚本猫</font>,然后新建脚本并将以下代码覆盖到脚本窗口<br>
<div style="padding:15px 0;"><div style="font-size:12px;">[JavaScript] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: javascript; gutter: true">// ==UserScript==
// @name:en-US         CCTV-HLS-Client
// @name               CCTV客户端视频解析
// @description:en-US  parse cctv video to hls url.
// @description        将CCTV视频解析成HLS地址.
// @namespace          https://greasyfork.org/users/135090
// @version            1.5.0
// @author             [ZWB](https://greasyfork.org/zh-CN/users/863179)
// @license            CC
// @grant              none
// @run-at             document-end
// @match              https://*.cctv.com/2*/VID*.shtml*
// @match              https://*.cctv.cn/2*/VID*.shtml*
// @match              https://vdn.apps.cntv.cn/api/getHttpVideoInfo*
// @icon               https://tv.cctv.cn/favicon.ico
// ==/UserScript==

(function () {
    if (location.hostname.indexOf(".cctv.com") &gt; 0 || location.hostname.indexOf(".cctv.cn") &gt; 0) {
        var base = "https://vdn.apps.cntv.cn";
        var pathname = "/api/getHttpVideoInfo.do";
        var apihref = base + pathname + `?client=flash&amp;im=0&amp;pid=${guid}`;
        // 跳转到api页
        location.href = (apihref);
    }

    if (location.hostname.indexOf("vdn.apps.cntv.cn") &gt; -1) {
        var data = JSON.parse(document.body.textContent); //解析成JSON对象
        var title = data?.title; //视频标题
        var hlsUrl = data?.manifest?.hls_enc2_url.replaceAll("main", "2000"); //普通视频
        var tsnlen = hlsUrl.split("/").length - 2; //在api页获取guid值在播放链接中的索引
        var tsn = hlsUrl.split("/")[tsnlen]; //根据索引得到guid值,其实也可以用var tsn = location.search.split('&amp;')[2].slice(4);
        console.info("guid:"+tsn);
        title = title ? title.replaceAll(" ","_") : tsn + "_guid.ts"; //标题空格用_代替
        document.title = title; //网页标题由视频标题提供
        if (data?.play_channel.indexOf("4K") &gt; 0) {
            hlsUrl = data?.hls_url.replaceAll("main", "4000"); //4K频道只有一种清晰度可选,直接使用此清晰度
        }
        var hlsfull = hlsUrl.replaceAll('&amp;','%26'); //防止复制到命令行的地址产生歧义
        document.body.innerHTML = `&lt;h2&gt;&lt;a href="${hlsfull}" alt=""&gt;${hlsfull}&lt;/a&gt;&lt;/h2&gt;&lt;hr&gt;`;
        // 创建实时更新的进度-代码块开始&gt;
        var txtctt = document.createElement("h2");
        txtctt.textContent = title;
        document.body.appendChild(txtctt);
        downloadM3U8Video(hlsUrl, title.concat(".ts"), {
            onProgress: (current, total) =&gt; {
                var cotp = `${Math.round((current / total) * 100)}`;
                txtctt.textContent = title + "---下载进程" + cotp + "%";
                console.info(`进度: ${current}/${total} (${cotp}%)`);
            }
        });
        // 创建实时更新的进度-代码块结束&lt;
    }

    async function downloadM3U8Video(m3u8Url, outputFilename = 'video.ts', options = {}) {
        try {
            // 1. 获取并解析M3U8文件
            const response = await fetch(m3u8Url);
            if (!response.ok) throw new Error(`无法访问 M3U8: ${response.status}`);
            const m3u8Content = await response.text();
            const lines = m3u8Content.split('\n');
            const baseUrl = m3u8Url.substring(0, m3u8Url.lastIndexOf("/") + 1);

            // &amp;#128049;猫抓扩展直接调用cbox时需要填写的参数设置&gt;&gt; cbox:"${url}" "%PUBLIC%\Downloads\cctv_${now}.MP4"
            //if (outputFilename.length &gt; 4) return; // 要用[o(≡°ェ°≡)m]猫抓扩展直接调用cbox时,请解除本行注释,&amp;#128070;

            if (!confirm('开始下载'+outputFilename)) {return;} // 不想要被询问,想直接用浏览器下载时,请注释本行
            // 1.1 解析TS分片URL
            const segments = [];
            for (const line of lines) {
                if (line &amp;&amp; !line.startsWith('#') &amp;&amp; (line.endsWith('.ts') || line.match(/\.ts\?/))) {
                    const segmentUrl = line.startsWith('http') ? line : new URL(line, baseUrl).href;
                    segments.push(segmentUrl);
                }
            }

            if (segments.length === 0) throw new Error('在 M3U8 文件中未找到分片.');
            console.log(`找到 ${segments.length} 个ts分片.`);

            // 2. 下载所有分片,采用流式合并
            console.log('正在下载分片...');
            const blobs = [];
            const { onProgress } = options;

            for (let i = 0; i &lt; segments.length; i++) {
                try {
                    const segmentResponse = await fetch(segments[i]);
                    if (!segmentResponse.ok) throw new Error(`无法访问分片: ${segmentResponse.status}`);

                    const blob = await segmentResponse.blob();
                    blobs.push(blob);

                    // 调用进度回调
                    if (typeof onProgress === 'function') {
                        onProgress(i + 1, segments.length);
                    }
                } catch (error) {
                    console.error(`下载分片时出现错误 ${segments[i]}:`, error);
                    throw error; // 可以选择继续或抛出错误
                }
            }

            // 3. 下载合并完成后的视频
            console.log('正在创建完整视频的下载链接...');
            const mergedBlob = new Blob(blobs, { type: 'video/mp2t' });
            const url = URL.createObjectURL(mergedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFilename;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();

            // 4. 清理临时链接
            setTimeout(() =&gt; {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            console.log('下载完成!');
            return true;
        } catch (error) {
            console.error('下载完整视频时发生错误:', error);
            throw error;
        }
    }
})();
</pre></div><br>
此代码实现了在浏览到CCTV视频页时自动跳转到API页面并提示是否用浏览器开始下载加密版视频,&lt;1.5.0版脚本修复了1.4.8版不支持猫抓扩展嗅探的bug,并增加了更详细的注释&gt;<br>
如果不想要用浏览器下载的,点击取消即可,然后复制页面中链接去其他工具下载,如果安装了猫抓扩展的用户也可以点击取消,然后在扩展上找到嗅探出的链接,然后解析下载<br>
如果提示不出现的,可能是浏览器不兼容这个提示语句,可选择把下面这一行代码注释掉<br>
if (!confirm('开始下载'+outputFilename)) {return;} <br>
脚本安装好后即<font size="5">完成第一步准备工作</font>,温馨提示:<br>
大佬放出的cbox.exe暂时不支持解密4K频道的视频,因此4K频道暂时用未加密的源,所以<font size="5">4K频道</font>的视频暂时<font size="5">用不到第二步</font>.不过由于mime类型是video/mp2t,所以<font size="5">需要mp4的</font>只能<font size="5">自行转码</font>.<br>
<br>
<font size="5">第一步</font>的准备工作结束后,接下来是<font size="5">真正的操作步骤</font>,在浏览器访问CCTV视频播放页,如果支持,则会自动跳转到API页,并开始下载,页面上会显示进度.<br>
且API页面还会出现M3U8地址,不喜欢在浏览器下载视频的点击取消后也能够复制m3u8地址去cbox里下载,所以建议暂时不要关闭这个API页,因为第二步还有用.以上时第一步的所有内容,往下看将开启第二步.<br>
<br>
<font size="6">开始第二步前的提示,楼主的4楼有等效于本楼第二步的步骤,不想下载nodejs运行时的请直接移步4楼</font><br>
&lt;&lt;&lt;PS:调用nodejs的方式虽然公开了源代码,方便用户根据需要修改,但是并不是每个人都会修改,且自行下载运行时也比较麻烦,批处理运行也不够优雅,所以楼主的二楼提供了不需要nodejs运行时的程序,<font size="6">4楼已置顶</font>,&gt;&gt;&gt;<br>
<br>
接下来是<font face="黑体"><font size="5">第二步</font></font><font face="Arial"><font size="3">的<font size="5">准备工作</font>:用批处理或者图形化界面基于大佬提供的cbox执行解密操作,鉴于大佬提供的文件比较分散,我整合了一下,做成了一个自解压包,解压时需要在目标文件夹选择一个新建的空文件夹：</font></font><br>
<font face="Arial"><font size="3">链接: https://pan.baidu.com/s/1f7M2eu2m3gYvj5JtdarS1Q?pwd=52pj</font></font><br>
<font face="Arial"><font size="3">如果会直接用cbox的可以将nodejs相关的文件和+Run.cmd文件删除,如果嫌手搓命令行麻烦的则需要自行下载node.exe放入</font></font><font face="Arial"><font size="3">+Run.cmd</font></font><font face="Arial"><font size="3">所在的文件夹,然后运行+Run.cmd按提示操作</font></font><br>
<font face="Arial"><font size="3">node.exe文件64位的地址样式</font></font><font face="Arial"><font size="3">https://registry.npmmirror.com/-/binary/node</font></font><font face="Arial"><font size="3">/.../win-x64/node.exe,</font></font><br>
<font face="Arial"><font size="3">node.exe文件32位的地址样式</font></font><font face="Arial"><font size="3">https://registry.npmmirror.com/-/binary/node</font></font><font face="Arial"><font size="3">/.../win-x86/node.exe</font></font><font face="Arial"><font size="3">,</font></font><br>
<font face="Arial"><font size="3">...表示版本号,请在 https://registry.npmmirror.com/binary.html?path=node/&nbsp;&nbsp;中自行选择下载的版本,</font></font><font face="Arial"><font size="3">如果系统版本比较低的则需要下载适合的低版本.</font></font><br>
<br>
<font face="Arial"><font size="4"><u>第二步的准备工作结束</u></font></font><font face="Arial"><font size="3">后就是</font></font><font face="Arial"><font size="5">真正的操作步骤</font></font><font face="Arial"><font size="3">.</font></font><font face="Arial"><font size="3">确保node.exe支持自己的系统.</font></font><br>
<font face="Arial"><font size="3">运行+Run.cmd会提示"</font></font><font face="Arial"><font size="3">请输入TS文件路径或HLS地址</font></font><font face="Arial"><font size="3">",这时可以去把网页上的m3u8复制粘贴上去,也可以去下载目录下把第一步下载好要解密的文件拖到命令行窗口,</font></font><br>
<font face="Arial"><font size="3">然后按下回车等待命令执行完毕.</font></font><font face="Arial"><font size="3">"由于大佬的cbox的参数只支持ascii字符,</font></font><font face="Arial"><font size="3">所以转换后的文件名默认为节目的pid,以避免文件名重复."</font></font><br>
<font face="Arial"><font size="3">到此一个文件的解密已经结束,命令行窗口会提示让你输入下一个需要解密的视频文件地址.</font></font><br>
<br>
<br>
<font face="Arial"><font size="3">下次再用就只需要执行真正的操作步骤即可,祝您使用愉快.暂时只有百度网盘的账号,其他网盘就看有没有人愿意转存了</font></font></td></tr></tbody></table>


