
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaokang-coding/p/18894717" title="å‘å¸ƒäº 2025-05-24 21:26">
    <span role="heading" aria-level="2">ã€ŒC++é»‘é­”æ³•ã€futureä¸promiseï¼šä¸åŠ é”çš„å¼‚æ­¥ç¼–ç¨‹ï¼ŒåŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚</p>
<p>ä½ æ˜¯å¦æ›¾ç»ä¸ºäº†è®©ç¨‹åºåŒæ—¶åšå¤šä»¶äº‹è€Œç»å°½è„‘æ±ï¼Ÿæ˜¯å¦è¢«å¤šçº¿ç¨‹ç¼–ç¨‹çš„å„ç§é”ã€æ¡ä»¶å˜é‡æå¾—å¤´æ˜è„‘èƒ€ï¼Ÿä»Šå¤©ï¼Œæˆ‘è¦å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†æ­¦å™¨ï¼Œè®©ä½ è½»æ¾é©¾é©­å¼‚æ­¥ç¼–ç¨‹çš„æµ·æ´‹ï¼</p>
<h2 id="å‰è¨€ä¸ºä»€ä¹ˆè¦å­¦futureå’Œpromise">å‰è¨€ï¼šä¸ºä»€ä¹ˆè¦å­¦futureå’Œpromiseï¼Ÿ</h2>
<p>æœ‹å‹ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä½ åœ¨é¤å…ç‚¹äº†ä¸€ä»½éœ€è¦20åˆ†é’Ÿæ‰èƒ½åšå¥½çš„å¤æ‚èœå“ã€‚ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li>ååœ¨é‚£é‡Œç›¯ç€å¨æˆ¿é—¨å£ï¼Œç­‰å¾…20åˆ†é’Ÿï¼ˆåŒæ­¥ç­‰å¾…ï¼‰</li>
<li>æœåŠ¡å‘˜ç»™äº†ä½ ä¸ªå–é¤ç ï¼Œèœå“å¥½äº†ä¼šé€šçŸ¥ä½ ï¼ŒåŒæ—¶ä½ å¯ä»¥åˆ·åˆ·æ‰‹æœºæˆ–èŠèŠå¤©ï¼ˆå¼‚æ­¥ç­‰å¾…ï¼‰</li>
</ol>
<p>æ˜¾ç„¶ï¼Œç¬¬äºŒç§æ–¹å¼æ›´é«˜æ•ˆï¼Œå¯¹å§ï¼Ÿ</p>
<p>åœ¨C++ç¼–ç¨‹ä¸­ï¼Œ<code>future</code>å’Œ<code>promise</code>å°±åƒæ˜¯è¿™ä¸ª"å–é¤ç +é€šçŸ¥"ç³»ç»Ÿï¼Œè®©ä½ çš„ç¨‹åºèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚å®ƒä»¬æ˜¯C++11å¼•å…¥çš„ç°ä»£å¹¶å‘ç¼–ç¨‹å·¥å…·ï¼Œæ¯”ä¼ ç»Ÿçš„çº¿ç¨‹ã€äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ›´åŠ ç®€å•æ˜“ç”¨ã€‚</p>
<h2 id="ä¸€å¼‚æ­¥ä»»åŠ¡æ˜¯ä¸ªå•¥é€šä¿—åœ°è¯´å°±æ˜¯åå°è¿è¡Œ">ä¸€ã€å¼‚æ­¥ä»»åŠ¡æ˜¯ä¸ªå•¥ï¼Ÿé€šä¿—åœ°è¯´å°±æ˜¯"åå°è¿è¡Œ"</h2>
<p>åœ¨è§£é‡Š<code>future</code>å’Œ<code>promise</code>ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠä»€ä¹ˆæ˜¯å¼‚æ­¥ä»»åŠ¡ã€‚</p>
<p><strong>å¼‚æ­¥ä»»åŠ¡</strong>å°±æ˜¯æŒ‡é‚£äº›å¯ä»¥åœ¨"åå°"æ‰§è¡Œï¼Œä¸éœ€è¦ä¸»çº¿ç¨‹ç­‰å¾…çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li>ä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶</li>
<li>å¤æ‚è®¡ç®—ï¼ˆå¦‚å›¾åƒå¤„ç†ï¼‰</li>
<li>è®¿é—®è¿œç¨‹æœåŠ¡å™¨</li>
</ul>
<p>æƒ³è±¡ä¸€ä¸‹ä½ çš„ç”µè„‘åœ¨ä¸‹è½½æ¸¸æˆçš„åŒæ—¶ï¼Œä½ è¿˜èƒ½ç»§ç»­åˆ·è§†é¢‘ã€èŠå¤©ï¼Œè¿™å°±æ˜¯å¼‚æ­¥çš„é­…åŠ›ï¼</p>
<h2 id="äºŒfutureæœªæ¥ä¼šå¾—åˆ°çš„ç»“æœ">äºŒã€futureï¼šæœªæ¥ä¼šå¾—åˆ°çš„ç»“æœ</h2>
<p><code>future</code>å¯ä»¥ç†è§£ä¸º"æœªæ¥çš„ç»“æœ"ï¼Œå®ƒå°±åƒä¸€å¼ ç”µå½±ç¥¨æ ¹ï¼š</p>
<ul>
<li>ä½ ç°åœ¨æ‹¿ç€ç¥¨æ ¹ï¼ˆfutureï¼‰</li>
<li>ç”µå½±ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰æ­£åœ¨åå°å‡†å¤‡ä¸­</li>
<li>å½“ç”µå½±å‡†å¤‡å¥½äº†ï¼Œä½ å¯ä»¥ç”¨ç¥¨æ ¹è¿›åœºï¼ˆè·å–ç»“æœï¼‰</li>
</ul>
<p>ç”¨ä»£ç è¯´è¯ï¼š</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;future&gt;
#include &lt;thread&gt;
#include &lt;chrono&gt;

int compute_answer() {
    // å‡è£…è¿™æ˜¯ä¸ªå¤æ‚è®¡ç®—
    std::cout &lt;&lt; "å¼€å§‹è®¡ç®—ç»ˆæé—®é¢˜çš„ç­”æ¡ˆ..." &lt;&lt; std::endl;
    std::this_thread::sleep_for(std::chrono::seconds(2)); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    std::cout &lt;&lt; "è®¡ç®—å®Œæˆï¼" &lt;&lt; std::endl;
    return 42; // è¿”å›ç»“æœ
}

int main() {
    // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼Œç«‹å³è¿”å›ä¸€ä¸ªfuture
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ä¸€ä¸ªè€—æ—¶ä»»åŠ¡" &lt;&lt; std::endl;
    std::future&lt;int&gt; answer_future = std::async(compute_answer);

    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šå“‡ï¼Œä¸ç”¨ç­‰å¾…ï¼Œæˆ‘å¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…ï¼" &lt;&lt; std::endl;

    // åšä¸€äº›å…¶ä»–å·¥ä½œ...
    std::this_thread::sleep_for(std::chrono::seconds(1));
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šæˆ‘åœ¨å¼‚æ­¥ä»»åŠ¡è®¡ç®—çš„åŒæ—¶åšäº†äº›å…¶ä»–äº‹" &lt;&lt; std::endl;

    // å½“éœ€è¦ç»“æœæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å®ƒ
    // å¦‚æœç»“æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¿™ä¼šé˜»å¡ç›´åˆ°ç»“æœå¯ç”¨
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šå¥½äº†ï¼Œç°åœ¨æˆ‘éœ€è¦çŸ¥é“ç­”æ¡ˆäº†ï¼Œç­‰å¾…ç»“æœ..." &lt;&lt; std::endl;
    int answer = answer_future.get();

    std::cout &lt;&lt; "ç»ˆæç­”æ¡ˆæ˜¯ï¼š" &lt;&lt; answer &lt;&lt; std::endl;

    return 0;
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p>
<pre><code class="language-plain">ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ä¸€ä¸ªè€—æ—¶ä»»åŠ¡
å¼€å§‹è®¡ç®—ç»ˆæé—®é¢˜çš„ç­”æ¡ˆ...
ä¸»çº¿ç¨‹ï¼šå“‡ï¼Œä¸ç”¨ç­‰å¾…ï¼Œæˆ‘å¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…ï¼
ä¸»çº¿ç¨‹ï¼šæˆ‘åœ¨å¼‚æ­¥ä»»åŠ¡è®¡ç®—çš„åŒæ—¶åšäº†äº›å…¶ä»–äº‹
è®¡ç®—å®Œæˆï¼
ä¸»çº¿ç¨‹ï¼šå¥½äº†ï¼Œç°åœ¨æˆ‘éœ€è¦çŸ¥é“ç­”æ¡ˆäº†ï¼Œç­‰å¾…ç»“æœ...
ç»ˆæç­”æ¡ˆæ˜¯ï¼š42
</code></pre>
<p>çœ‹åˆ°äº†å—ï¼Ÿä¸»çº¿ç¨‹å¯åŠ¨äº†è®¡ç®—ï¼Œä½†å¹¶ä¸ç«‹å³ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ã€‚åªæœ‰å½“çœŸæ­£éœ€è¦ç»“æœæ—¶ï¼ˆè°ƒç”¨<code>get()</code>ï¼‰ï¼Œæ‰ä¼šç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆã€‚</p>
<h2 id="ä¸‰promiseæˆ‘ä¿è¯ä¼šç»™ä½ ç»“æœ">ä¸‰ã€promiseï¼šæˆ‘ä¿è¯ä¼šç»™ä½ ç»“æœ</h2>
<p>å¦‚æœè¯´<code>future</code>æ˜¯é¢†å–ç»“æœçš„å‡­è¯ï¼Œé‚£ä¹ˆ<code>promise</code>å°±æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼š"æˆ‘ä¿è¯ä¼šåœ¨æŸä¸ªæ—¶åˆ»è®¾ç½®ä¸€ä¸ªå€¼"ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹å¥½æ­æ¡£ï¼š</p>
<ul>
<li><code>promise</code>è´Ÿè´£åœ¨æŸä¸ªæ—¶åˆ»è®¾ç½®ç»“æœ</li>
<li><code>future</code>è´Ÿè´£åœ¨éœ€è¦æ—¶è·å–ç»“æœ</li>
</ul>
<p>è¿™å°±åƒä½ å’Œæœ‹å‹çš„çº¦å®šï¼š</p>
<ul>
<li>ä½ ï¼šæˆ‘æ‰¿è¯ºä¼šå‘Šè¯‰ä½ è€ƒè¯•æˆç»©ï¼ˆpromiseï¼‰</li>
<li>æœ‹å‹ï¼šæˆ‘ä¼šç­‰ä½ å‘Šè¯‰æˆ‘ï¼ˆfutureï¼‰</li>
</ul>
<p>æ¥çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;future&gt;
#include &lt;thread&gt;
#include &lt;chrono&gt;

void producer(std::promise&lt;int&gt; my_promise) {
    std::cout &lt;&lt; "ç”Ÿäº§è€…ï¼šæˆ‘è¦å¼€å§‹ç”Ÿäº§ä¸€ä¸ªé‡è¦çš„å€¼äº†..." &lt;&lt; std::endl;

    // å‡è£…æˆ‘ä»¬åœ¨åšä¸€äº›å¤æ‚çš„è®¡ç®—
    std::this_thread::sleep_for(std::chrono::seconds(2));

    int result = 42;
    std::cout &lt;&lt; "ç”Ÿäº§è€…ï¼šè®¡ç®—å®Œæˆï¼Œè®¾ç½®ç»“æœåˆ°promise" &lt;&lt; std::endl;

    // è®¾ç½®promiseçš„å€¼ï¼Œè¿™ä¼šé€šçŸ¥ç›¸å…³çš„future
    my_promise.set_value(result);
}

int main() {
    // åˆ›å»ºä¸€ä¸ªpromise
    std::promise&lt;int&gt; answer_promise;

    // ä»promiseè·å–ä¸€ä¸ªfuture
    std::future&lt;int&gt; answer_future = answer_promise.get_future();

    // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä¼ å…¥promise
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹" &lt;&lt; std::endl;
    std::thread producer_thread(producer, std::move(answer_promise));

    // ä¸»çº¿ç¨‹ç»§ç»­åšå…¶ä»–äº‹æƒ…
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šæˆ‘å¯ä»¥åšè‡ªå·±çš„äº‹ï¼Œä¸ç”¨ç­‰å¾…..." &lt;&lt; std::endl;
    std::this_thread::sleep_for(std::chrono::seconds(1));

    // å½“éœ€è¦ç»“æœæ—¶
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šç°åœ¨æˆ‘éœ€è¦ç»“æœäº†ï¼Œç­‰å¾…future..." &lt;&lt; std::endl;
    int answer = answer_future.get();
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šæ”¶åˆ°ç»“æœï¼š" &lt;&lt; answer &lt;&lt; std::endl;

    // åˆ«å¿˜äº†ç­‰å¾…çº¿ç¨‹ç»“æŸ
    producer_thread.join();

    return 0;
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p>
<pre><code class="language-plain">ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹
ç”Ÿäº§è€…ï¼šæˆ‘è¦å¼€å§‹ç”Ÿäº§ä¸€ä¸ªé‡è¦çš„å€¼äº†...
ä¸»çº¿ç¨‹ï¼šæˆ‘å¯ä»¥åšè‡ªå·±çš„äº‹ï¼Œä¸ç”¨ç­‰å¾…...
ä¸»çº¿ç¨‹ï¼šç°åœ¨æˆ‘éœ€è¦ç»“æœäº†ï¼Œç­‰å¾…future...
ç”Ÿäº§è€…ï¼šè®¡ç®—å®Œæˆï¼Œè®¾ç½®ç»“æœåˆ°promise
ä¸»çº¿ç¨‹ï¼šæ”¶åˆ°ç»“æœï¼š42
</code></pre>
<p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨<code>promise</code>å’Œ<code>future</code>åœ¨çº¿ç¨‹é—´ä¼ é€’ç»“æœã€‚ç”Ÿäº§è€…çº¿ç¨‹é€šè¿‡<code>promise</code>è®¾ç½®å€¼ï¼Œä¸»çº¿ç¨‹é€šè¿‡<code>future</code>è·å–å€¼ã€‚</p>
<h2 id="å››futureçš„å‡ ç§è·å–æ–¹å¼">å››ã€futureçš„å‡ ç§è·å–æ–¹å¼</h2>
<p>é™¤äº†é€šè¿‡<code>promise</code>è·å–<code>future</code>ï¼ŒC++11è¿˜æä¾›äº†å…¶ä»–ä¾¿æ·æ–¹å¼ï¼š</p>
<h3 id="1-é€šè¿‡asyncè·å–future">1. é€šè¿‡asyncè·å–future</h3>
<p><code>std::async</code>æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œå®ƒè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹å¹¶è¿”å›<code>future</code>ï¼š</p>
<pre><code class="language-cpp">std::future&lt;int&gt; result = std::async([]() {
    return 42;
});
</code></pre>
<h3 id="2-é€šè¿‡packaged_taskè·å–future">2. é€šè¿‡packaged_taskè·å–future</h3>
<p><code>std::packaged_task</code>åŒ…è£…äº†ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶å…è®¸ä½ è·å–å…¶<code>future</code>ï¼š</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;future&gt;
#include &lt;thread&gt;

int main() {
    // åˆ›å»ºä¸€ä¸ªpackaged_taskï¼ŒåŒ…è£…ä¸€ä¸ªlambdaå‡½æ•°
    std::packaged_task&lt;int(int, int)&gt; task([](int a, int b) {
        std::cout &lt;&lt; "è®¡ç®— " &lt;&lt; a &lt;&lt; " + " &lt;&lt; b &lt;&lt; std::endl;
        std::this_thread::sleep_for(std::chrono::seconds(1)); // æ¨¡æ‹Ÿè€—æ—¶è®¡ç®—
        return a + b;
    });

    // è·å–future
    std::future&lt;int&gt; result = task.get_future();

    // åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡
    std::thread task_thread(std::move(task), 10, 32);

    // ä¸»çº¿ç¨‹åšå…¶ä»–äº‹æƒ…...
    std::cout &lt;&lt; "ä¸»çº¿ç¨‹ï¼šç­‰å¾…è®¡ç®—ç»“æœ..." &lt;&lt; std::endl;

    // è·å–ç»“æœ
    int sum = result.get();
    std::cout &lt;&lt; "ç»“æœæ˜¯ï¼š" &lt;&lt; sum &lt;&lt; std::endl;

    task_thread.join();
    return 0;
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p>
<pre><code class="language-plain">ä¸»çº¿ç¨‹ï¼šç­‰å¾…è®¡ç®—ç»“æœ...
è®¡ç®— 10 + 32
ç»“æœæ˜¯ï¼š42
</code></pre>
<h2 id="äº”å®ç”¨åŠŸèƒ½futureçš„è¶…æ—¶ç­‰å¾…">äº”ã€å®ç”¨åŠŸèƒ½ï¼šfutureçš„è¶…æ—¶ç­‰å¾…</h2>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æƒ³æ— é™æœŸåœ°ç­‰å¾…å¼‚æ­¥ä»»åŠ¡ã€‚<code>future</code>æä¾›äº†å¸¦è¶…æ—¶çš„ç­‰å¾…åŠŸèƒ½ï¼š</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;future&gt;
#include &lt;chrono&gt;

int long_calculation() {
    std::this_thread::sleep_for(std::chrono::seconds(3));
    return 42;
}

int main() {
    auto future = std::async(std::launch::async, long_calculation);

    // è®¾ç½®1ç§’è¶…æ—¶
    auto status = future.wait_for(std::chrono::seconds(1));

    if (status == std::future_status::ready) {
        std::cout &lt;&lt; "ä»»åŠ¡å·²å®Œæˆï¼Œç»“æœæ˜¯ï¼š" &lt;&lt; future.get() &lt;&lt; std::endl;
    } else if (status == std::future_status::timeout) {
        std::cout &lt;&lt; "ç­‰å¾…è¶…æ—¶ï¼ä»»åŠ¡è¿˜æ²¡å®Œæˆ" &lt;&lt; std::endl;

        // æˆ‘ä»¬ä»ç„¶å¯ä»¥ç»§ç»­ç­‰å¾…å®Œæˆ
        std::cout &lt;&lt; "ç»§ç»­ç­‰å¾…..." &lt;&lt; std::endl;
        std::cout &lt;&lt; "æœ€ç»ˆç»“æœï¼š" &lt;&lt; future.get() &lt;&lt; std::endl;
    }

    return 0;
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p>
<pre><code class="language-plain">ç­‰å¾…è¶…æ—¶ï¼ä»»åŠ¡è¿˜æ²¡å®Œæˆ
ç»§ç»­ç­‰å¾…...
æœ€ç»ˆç»“æœï¼š42
</code></pre>
<h2 id="å…­å¼‚å¸¸å¤„ç†å½“å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶">å…­ã€å¼‚å¸¸å¤„ç†ï¼šå½“å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶</h2>
<p>å¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼šè¢«æ•è·å¹¶å­˜å‚¨åœ¨<code>future</code>ä¸­ï¼Œå½“ä½ è°ƒç”¨<code>get()</code>æ—¶ä¼šé‡æ–°æŠ›å‡ºï¼š</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;future&gt;
#include &lt;stdexcept&gt;

int may_throw() {
    std::this_thread::sleep_for(std::chrono::seconds(1));
    throw std::runtime_error("å“å‘€ï¼Œå‡ºé”™äº†ï¼");
    return 42;
}

int main() {
    auto future = std::async(may_throw);

    try {
        int result = future.get();
        std::cout &lt;&lt; "ç»“æœï¼š" &lt;&lt; result &lt;&lt; std::endl;
    } catch (const std::exception&amp; e) {
        std::cout &lt;&lt; "æ•è·åˆ°å¼‚å¸¸ï¼š" &lt;&lt; e.what() &lt;&lt; std::endl;
    }

    return 0;
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p>
<pre><code class="language-plain">æ•è·åˆ°å¼‚å¸¸ï¼šå“å‘€ï¼Œå‡ºé”™äº†ï¼
</code></pre>
<p>è¿™ç§è®¾è®¡éå¸¸ä¼˜é›…â€”â€”æ— è®ºå¼‚æ­¥ä»»åŠ¡æ˜¯æˆåŠŸè¿”å›å€¼è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½èƒ½é€šè¿‡åŒä¸€ä¸ª<code>future</code>æ¥å£å¤„ç†ã€‚</p>
<h2 id="ä¸ƒå®é™…åº”ç”¨æ¡ˆä¾‹å¹¶è¡Œè®¡ç®—æ±‚å’Œ">ä¸ƒã€å®é™…åº”ç”¨æ¡ˆä¾‹ï¼šå¹¶è¡Œè®¡ç®—æ±‚å’Œ</h2>
<p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªæ›´å®ç”¨çš„ä¾‹å­æ¥å·©å›ºç†è§£ï¼šå¹¶è¡Œè®¡ç®—å¤§æ•°ç»„çš„å’Œã€‚</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;vector&gt;
#include &lt;numeric&gt;
#include &lt;future&gt;
#include &lt;chrono&gt;

// è®¡ç®—æ•°ç»„éƒ¨åˆ†å’Œçš„å‡½æ•°
long long partial_sum(const std::vector&lt;int&gt;&amp; data, size_t start, size_t end) {
    return std::accumulate(data.begin() + start, data.begin() + end, 0LL);
}

int main() {
    // åˆ›å»ºä¸€ä¸ªå¤§æ•°ç»„
    const size_t size = 100000000; // 1äº¿ä¸ªå…ƒç´ 
    std::vector&lt;int&gt; data(size, 1); // å…¨æ˜¯1çš„æ•°ç»„

    auto start_time = std::chrono::high_resolution_clock::now();

    // å•çº¿ç¨‹è®¡ç®—
    long long single_result = std::accumulate(data.begin(), data.end(), 0LL);

    auto single_end = std::chrono::high_resolution_clock::now();
    auto single_duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(single_end - start_time);

    std::cout &lt;&lt; "å•çº¿ç¨‹ç»“æœ: " &lt;&lt; single_result &lt;&lt; " (è€—æ—¶: " 
        &lt;&lt; single_duration.count() &lt;&lt; "ms)" &lt;&lt; std::endl;

    // ä½¿ç”¨4ä¸ªçº¿ç¨‹å¹¶è¡Œè®¡ç®—
    auto multi_start = std::chrono::high_resolution_clock::now();

    const size_t num_threads = 4;
    const size_t block_size = size / num_threads;

    std::vector&lt;std::future&lt;long long&gt;&gt; futures;

    for (size_t i = 0; i &lt; num_threads; ++i) {
        size_t start = i * block_size;
        size_t end = (i == num_threads - 1) ? size : (i + 1) * block_size;

        // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
        futures.push_back(std::async(std::launch::async, 
            partial_sum, std::ref(data), start, end));
    }

    // æ”¶é›†ç»“æœ
    long long multi_result = 0;
    for (auto&amp; f : futures) {
        multi_result += f.get();
    }

    auto multi_end = std::chrono::high_resolution_clock::now();
    auto multi_duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(multi_end - multi_start);

    std::cout &lt;&lt; "å¤šçº¿ç¨‹ç»“æœ: " &lt;&lt; multi_result &lt;&lt; " (è€—æ—¶: " 
        &lt;&lt; multi_duration.count() &lt;&lt; "ms)" &lt;&lt; std::endl;

    std::cout &lt;&lt; "åŠ é€Ÿæ¯”: " &lt;&lt; static_cast&lt;double&gt;(single_duration.count()) / multi_duration.count() &lt;&lt; "x" &lt;&lt; std::endl;

    return 0;
}
</code></pre>
<p><strong>å¯èƒ½çš„è¾“å‡ºç»“æœ</strong>ï¼ˆå–å†³äºä½ çš„ç¡¬ä»¶ï¼‰ï¼š</p>
<pre><code class="language-plain">å•çº¿ç¨‹ç»“æœ: 100000000 (è€—æ—¶: 570ms)
å¤šçº¿ç¨‹ç»“æœ: 100000000 (è€—æ—¶: 171ms)
åŠ é€Ÿæ¯”: 3.33333x
</code></pre>
<p>çœ‹åˆ°æ²¡ï¼Ÿå¤šçº¿ç¨‹ç‰ˆæœ¬æ˜æ˜¾æ›´å¿«ï¼è¿™æ­£æ˜¯<code>future</code>çš„ä»·å€¼æ‰€åœ¨â€”â€”è®©å¹¶è¡Œç¼–ç¨‹å˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚</p>
<h2 id="å…«æ€»ç»“ä¸ºä»€ä¹ˆfutureå’Œpromiseè¿™ä¹ˆé¦™">å…«ã€æ€»ç»“ï¼šä¸ºä»€ä¹ˆfutureå’Œpromiseè¿™ä¹ˆé¦™ï¼Ÿ</h2>
<p>ç°åœ¨ï¼Œä½ å·²ç»äº†è§£äº†C++11ä¸­<code>future</code>å’Œ<code>promise</code>çš„åŸºæœ¬ç”¨æ³•ã€‚å®ƒä»¬çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ol>
<li><strong>ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹</strong>ï¼šæ¯”ç›´æ¥ç®¡ç†çº¿ç¨‹ã€äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ç®€å•å¾—å¤š</li>
<li><strong>æ¸…æ™°çš„æ‰€æœ‰æƒæ¨¡å‹</strong>ï¼š<code>promise</code>è´Ÿè´£ç”Ÿäº§å€¼ï¼Œ<code>future</code>è´Ÿè´£æ¶ˆè´¹å€¼</li>
<li><strong>å¼‚å¸¸ä¼ é€’</strong>ï¼šå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™ç­‰å¾…çš„<code>future</code></li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šå¯ä»¥è®¾ç½®ç­‰å¾…è¶…æ—¶ï¼Œé¿å…æ— é™é˜»å¡</li>
<li><strong>ä¸ç°ä»£C++å®Œç¾èåˆ</strong>ï¼šé…åˆlambdaã€æ™ºèƒ½æŒ‡é’ˆç­‰ç°ä»£ç‰¹æ€§ä½¿ç”¨æ›´åŠ ä¼˜é›…</li>
</ol>
<p>è®°ä½è¿™ä¸ªç±»æ¯”å°±è¡Œï¼š<code>promise</code>å°±åƒä¸€ä¸ª"æ‰¿è¯ºç»™ä½ ç»“æœçš„äºº"ï¼Œ<code>future</code>å°±åƒ"ç­‰å¾…ç»“æœçš„å‡­è¯"ã€‚</p>
<p>ä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ç¨‹åºä¸­æ‰§è¡Œè€—æ—¶æ“ä½œåˆä¸æƒ³é˜»å¡ä¸»çº¿ç¨‹æ—¶ï¼Œå°±æƒ³åˆ°<code>future</code>å’Œ<code>promise</code>å§ï¼å®ƒä»¬ä¼šè®©ä½ çš„ä»£ç æ›´åŠ ç°ä»£ã€é«˜æ•ˆï¼Œè¿˜èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„å¨åŠ›ã€‚</p>
<p>æœ€åä¸€ä¸ªå°æç¤ºï¼šè™½ç„¶C++11çš„<code>future</code>å’Œ<code>promise</code>å·²ç»å¾ˆå¼ºå¤§ï¼Œä½†å¦‚æœä½ è¿½æ±‚æ›´é«˜çº§çš„å¼‚æ­¥ç¼–ç¨‹ï¼Œå¯ä»¥è€ƒè™‘çœ‹çœ‹C++20çš„åç¨‹(coroutine)ç‰¹æ€§ï¼Œé‚£åˆæ˜¯å¦ä¸€ä¸ªè®©äººå…´å¥‹çš„è¯é¢˜äº†ï½</p>
<hr>
<h2 id="å†™åœ¨æœ€åè¿™åªæ˜¯å¼‚æ­¥ç¼–ç¨‹æ—…ç¨‹çš„å¼€å§‹">å†™åœ¨æœ€åï¼šè¿™åªæ˜¯å¼‚æ­¥ç¼–ç¨‹æ—…ç¨‹çš„å¼€å§‹...</h2>
<p>å˜¿ï¼Œæœ‹å‹ï¼çœ‹åˆ°è¿™é‡Œï¼Œä½ å·²ç»æŒæ¡äº†C++å¼‚æ­¥ç¼–ç¨‹çš„ä¸€æŠŠåˆ©å™¨äº†ï¼ä½†ç¼–ç¨‹ä¸–ç•Œå°±åƒå®‡å®™ä¸€æ ·æµ©ç€šæ— è¾¹ï¼Œæˆ‘ä»¬çš„æ¢ç´¢æ‰åˆšåˆšå¼€å§‹ï½</p>
<p><strong>å­¦åˆ°äº†æ–°çŸ¥è¯†ï¼Ÿæœ‰ç–‘é—®ï¼Ÿæœ‰å¿ƒå¾—ï¼Ÿ</strong><br>
ğŸ‘‰ å¿«åˆ°è¯„è®ºåŒºå’Œå¤§å®¶åˆ†äº«å§ï¼æˆ‘ä¼šäº²è‡ªè§£ç­”ä½ çš„æ¯ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p><strong>å¦‚æœè¿™ç¯‡æ–‡ç« è®©ä½ æœ‰æ‰€æ”¶è·...</strong><br>
è¯·ç‚¹èµã€æ”¶è—ã€å…³æ³¨å“¦ï¼Œè¿™å¯¹æˆ‘æ¥è¯´ï¼Œå°±åƒå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶æ”¶åˆ°çš„ä¸€ä¸ª<code>promise.set_value()</code>ä¸€æ ·çè´µï¼è½¬å‘ç»™ä½ çš„ç¨‹åºçŒ¿/åª›æœ‹å‹ï¼Œä»–ä»¬ä¸€å®šä¹Ÿä¼šæ„Ÿè°¢ä½ åˆ†äº«è¿™ä¸ªç¼–ç¨‹"é»‘é­”æ³•"ï¼</p>
<p><strong>æƒ³è¦æ›´å¤šç¼–ç¨‹"ç¥å™¨"å—ï¼Ÿ</strong></p>
<p>å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œè·Ÿç€å°åº·å­¦ç¼–ç¨‹ã€ï¼Œè¿™é‡Œæœ‰ï¼š</p>
<p>ğŸš€ <strong>å¤šçº¿ç¨‹ç¼–ç¨‹å®æˆ˜ç§˜ç±</strong> â€”â€” è®©ä½ çš„ç¨‹åºé£èµ·æ¥ï¼ŒCPUæ ¸å¿ƒå…¨åˆ©ç”¨ï¼<br>
ğŸ” <strong>C++é¢è¯•é¢˜æ·±åº¦è§£æ</strong> â€”â€” é¢è¯•å®˜ï¼šè¿™æ°´å¹³ï¼Œå¿…é¡»ç»™offerï¼<br>
ğŸ› ï¸ <strong>ç°ä»£C++é«˜çº§æŠ€å·§</strong> â€”â€” C++11/14/17/20æ–°ç‰¹æ€§å…¨è§£æï¼Œä»£ç ç«‹å‡50%ï¼<br>
ğŸ§© <strong>STLæºç æ¢ç§˜</strong> â€”â€” çœ‹å¤§ç¥æ˜¯æ€ä¹ˆå†™ä»£ç çš„ï¼Œå­¦å°±è¦å­¦æœ€å¥½çš„ï¼<br>
ğŸ’» <strong>å®æˆ˜é¡¹ç›®åˆ†äº«</strong> â€”â€” çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œå®æˆ˜å‡ºçœŸçŸ¥ï¼</p>
<p>ğŸ‘‡ <strong>æ‰«ç å³å¯å…³æ³¨</strong>ã€‚</p>
<p><img src="https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png" alt="" loading="lazy"></p>
<p><strong>å“ˆï¼Œæƒ³ä¸æƒ³å’Œä¸€ç¾¤å¿—åŒé“åˆçš„C++çˆ±å¥½è€…ä¸€èµ·äº¤æµï¼Ÿ</strong></p>
<p>æ‰«æä¸‹æ–¹äºŒç»´ç ï¼ŒåŠ å…¥æˆ‘ä»¬çš„æŠ€æœ¯äº¤æµç¾¤ï¼</p>
<p>ç¾¤é‡Œæœ‰ä»€ä¹ˆï¼Ÿæœ‰å¤§å‚C++å¼€å‘å·¥ç¨‹å¸ˆåé•‡ï¼Œæœ‰çƒ­å¿ƒçš„åŒè¡Œäº’å¸®äº’åŠ©...</p>
<p>é‡åˆ° bug å¡ä½äº†ï¼Ÿä»£ç æ€§èƒ½ä¼˜åŒ–ä¸ä¸Šå»ï¼Ÿé¢è¯•å‡†å¤‡æ²¡æ–¹å‘ï¼Ÿ</p>
<p>åˆ«ç€æ€¥ï¼Œä¸€ä¸ªæ¶ˆæ¯å‘å‡ºå»ï¼Œç¾¤é‡Œçš„å¤§ä½¬ä»¬ç«‹é©¬å¸®ä½ è§£å†³ï¼</p>
<p><img src="https://files.mdnice.com/user/48364/971ccaa3-8f57-4e33-8bc9-d0863eeade81.png" alt="" loading="lazy"></p>
<p>è®°ä½ï¼Œåœ¨ç¼–ç¨‹çš„ä¸–ç•Œé‡Œï¼Œä½ ä»ä¸å­¤å•ã€‚æˆ‘ä»¬çš„<code>future</code>å·²ç»è¿æ¥ï¼Œå°±ç­‰ä½ çš„<code>get()</code>æ¥è·å–çŸ¥è¯†çš„æœå®äº†ï¼</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.6227688202719908" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-05-24 21:26">2025-05-24 21:26</span>&nbsp;
<a href="https://www.cnblogs.com/xiaokang-coding">æ±Ÿå°åº·</a>&nbsp;
é˜…è¯»(<span id="post_view_count">63</span>)&nbsp;
è¯„è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18894717);return false;">æ”¶è—</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18894717', targetLink: 'https://www.cnblogs.com/xiaokang-coding/p/18894717', title: 'ã€ŒC++é»‘é­”æ³•ã€futureä¸promiseï¼šä¸åŠ é”çš„å¼‚æ­¥ç¼–ç¨‹ï¼ŒåŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•ï¼' })">ä¸¾æŠ¥</a>
</div>
        