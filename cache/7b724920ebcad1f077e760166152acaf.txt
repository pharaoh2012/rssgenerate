
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/www-htz-pw/p/19054691/gu-zhang-chu-lioracle-biao-kong-jian-yi-chang-zeng" title="发布于 2025-08-23 18:55">
    <span role="heading" aria-level="2">故障处理：Oracle表空间异常增长后又恢复正常的故障模拟与分析</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<blockquote>
<p>我们的文章会在微信公众号<a href="https://mp.weixin.qq.com/s/Gkmr9MArgh_4vMXhVvQULA" rel="noopener nofollow">IT民工的龙马人生</a>和<a href="http://www.htz.pw" rel="noopener nofollow">博客网站</a> ( <a href="http://www.htz.pw" rel="noopener nofollow">www.htz.pw</a> )同步更新 ，欢迎关注收藏，也欢迎大家转载，但是请在文章开始地方标注文章出处，谢谢！<br>
由于博客中有大量代码，通过页面浏览效果更佳。</p>
</blockquote>
<p>今天谈谈很早之前朋友问到的一个案例，表空间使用率异常增加，新增对象都是临时字段，并且段名是很奇怪，由数字和.构成，如（11.123）这种方式。这个案例相对来说比较极端，客户采用的文件系统，并且数据文件为自动扩张，最后出现空间耗尽，数据文件无法收缩的现象。今天就好大家一起来模拟一下这种现象：</p>
<h2><a id="%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>环境准备</h2>
<p>由于是自己的环境，也为了保证后续的操作不报错，所以这里看起了归档日志强制删除的脚本。</p>
<pre><code class="language-plain_text">[oracle@oracleadg sql]$ sh ./arch_delete_force_all.sh 
2025-08-23 21:46:09: Using ORACLE_SID=htz191, interval=10 seconds.
2025-08-23 21:46:09: Press Ctrl+C to stop the script.
2025-08-23 21:46:09: Starting RMAN archived log cleanup.
2025-08-23 21:46:14: Cleanup finished. Sleeping for 10 seconds.
2025-08-23 21:46:24: Starting RMAN archived log cleanup.
2025-08-23 21:46:28: Cleanup finished. Sleeping for 10 seconds.
2025-08-23 21:46:38: Starting RMAN archived log cleanup.
</code></pre>
<h2><a id="%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%A1%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>创建测试表</h2>
<pre><code class="language-plain_text">create table htz as select * from dba_objects;
多次执行下面语句
insert into htz as select * from htz;
commit;
</code></pre>
<p>确保测试表足够的大，下面是我环境中的htz表的大小。</p>
<pre><code class="language-plain_text">SQL&gt; @segment_size.sql
Enter Search owner Name (i.e. SCOTT|ALL) : 
Enter Search Segment Name (i.e. DEPT|ALL) : 
Enter Search Tablespace Name (i.e. DEPT|ALL) : system
Enter Display rows Name (i.e. 20) : 

                                                                         Name                                    Total
OWNER                SEGMENT_NAME                        SEGMENT_TYPE    Partition                             size(M)
-------------------- ----------------------------------- --------------- ----------------------------------- ---------
SYS                  HTZ                                 TABLE                                                   11518
SYS                  IDL_UB1$                            TABLE                                                     398
SYS                  SYS_LOB0000022516C00008$$           LOBSEGMENT                                                192
SYS                  C_TOID_VERSION#                     CLUSTER                                                    49
SYS                  SOURCE$                             TABLE                                                      40
</code></pre>
<p>我这里是11G左右的大小。</p>
<h2><a id="%E7%A1%AE%E8%AE%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>确认数据库状态</h2>
<pre><code class="language-plain_text">SQL&gt; @db_status.sql

                                              flashback  Switchover           Database                                  Force
OPEN_MODE            LOG_MODE                 On         Status               Role                 PROTECTION_MODE      Loggin
-------------------- ------------------------ ---------- -------------------- -------------------- -------------------- ------
READ WRITE           ARCHIVELOG               YES        NOT ALLOWED          LOGICAL STANDBY      MAXIMUM PERFORMANCE  YES
</code></pre>
<h2><a id="%E7%A1%AE%E8%AE%A4%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%9A%84%E5%AE%B9%E9%87%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>确认表空间的容量</h2>
<pre><code class="language-plain_text">
SQL&gt; @db_size.sql
*******************tablespace size**************************

Tablespace                                                    Size (MB)  Free (MB)     % Free     % Used
------------------------------------------------------------ ---------- ---------- ---------- ----------
TEST                                                               1024       1023        100         .1
TEMP                                                                224        190         85      15.18
UNDOTBS1                                                            995     542.75         55      45.45
UNDOTBS2                                                             25    13.1875         53      47.25
USERS                                                             18.75     2.0625         11         89
SYSAUX                                                             1140     59.625          5      94.77
SYSTEM                                                            12688    15.1875          0      99.88
</code></pre>
<h2><a id="%E5%8F%96%E6%B6%88%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>取消归档日志自动删除</h2>
<p>将前面的归档日志自动删除脚本取消执行，因为后面我们要用到归档日志文件去解析，查看logmnr中的SQL语句。</p>
<h2><a id="%E5%BC%80%E5%90%AF%E8%A1%A8%E7%A9%BA%E9%97%B4%E8%87%AA%E5%8A%A8%E6%89%A9%E5%AE%B9%E8%84%9A%E6%9C%AC" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>开启表空间自动扩容脚本</h2>
<p>因为后续的操作要生成11G的表，可能出现表空间容灾不够，所以开启表空间自动扩容脚本。</p>
<pre><code class="language-plain_text">[oracle@oracleadg sql]$ watch -n 2 ./tbscale -l TEST:50


Every 2.0s: ./tbscale -l TEST:50                                                                                                                                                                                                        Sat Aug 23 22:13:44 2025

[INFO] 2025/08/23 22:13:44 This script will connect to the database using 'sqlplus / as sysdba'. Please ensure OS authentication is configured correctly.
[INFO] 2025/08/23 22:13:44 Database status: OPEN
[INFO] 2025/08/23 22:13:44 Threshold mode: Only checking tablespaces and thresholds specified by -l
[INFO] 2025/08/23 22:13:44 ========== Processing tablespace: TEST (threshold 50.00%) ==========
[INFO] 2025/08/23 22:13:44 Tablespace [TEST] free space 48.34% &lt; threshold 50.00%, expansion required.
[INFO] 2025/08/23 22:13:44 Underlying storage has sufficient space for tablespace [TEST] (Available 99065.52 MB &gt;= Needed 1024 MB)
[INFO] 2025/08/23 22:13:44 Expansion SQL: ALTER TABLESPACE TEST ADD DATAFILE '/oracle/app/oracle/oradata/HTZ19TWO/datafile/TEST_14.dbf' SIZE 1G AUTOEXTEND ON NEXT 100M MAXSIZE 32767M;
[INFO] 2025/08/23 22:14:02 Successfully added a new datafile to tablespace [TEST].
[INFO] 2025/08/23 22:14:02 Script execution finished.
</code></pre>
<h2><a id="%E5%88%9B%E5%BB%BA%E6%96%B0%E8%A1%A8" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>创建新表</h2>
<p>这里要保证htz表足够的大，这样才方便后续的实验和观察，否者还没有观察到，SQL语句就执行完了。</p>
<pre><code class="language-plain_text">SQL&gt; create table htz1 tablespace test as select /*+ parallel(a 5) */ * from htz a;
</code></pre>
<h2><a id="%E7%A1%AE%E8%AE%A4%E5%AF%B9%E8%B1%A1%E5%A4%A7%E5%B0%8F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>确认对象大小</h2>
<pre><code class="language-plain_text">SQL&gt; @segment_size.sql
Enter Search owner Name (i.e. SCOTT|ALL) :
Enter Search Segment Name (i.e. DEPT|ALL) :
Enter Search Tablespace Name (i.e. DEPT|ALL) : TEST
Enter Display rows Name (i.e. 20) :

                                                                         Name                                    Total
OWNER                SEGMENT_NAME                        SEGMENT_TYPE    Partition                             size(M)
-------------------- ----------------------------------- --------------- ----------------------------------- ---------
SYS                  11.130                              TEMPORARY                                                5760
</code></pre>
<p>这里看到生成一个临时段，对应段名为：11.130，现象跟之前朋友说的案例一模一样。</p>
<h2><a id="%E5%8F%96%E6%B6%88%E5%88%9B%E5%BB%BA%E8%A1%A8%E8%AF%AD%E5%8F%A5" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>取消创建表语句</h2>
<p>取消创建表语句的执行。</p>
<pre><code class="language-plain_text">SQL&gt; create table htz1 tablespace test as select /*+ parallel(a 5) */ * from htz a;

^Ccreate table htz1 tablespace test as select /*+ parallel(a 5) */ * from htz a
                                                                        *
ERROR at line 1:
ORA-01013: user requested cancel of current operation
</code></pre>
<p>这里直接终止命令的运行。</p>
<h2><a id="%E6%9F%A5%E7%9C%8B%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%AF%B9%E8%B1%A1" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>查看表空间对象</h2>
<p>已经没有任何对象了</p>
<pre><code class="language-plain_text">SQL&gt; @segment_size.sql
Enter Search owner Name (i.e. SCOTT|ALL) :
Enter Search Segment Name (i.e. DEPT|ALL) :
Enter Search Tablespace Name (i.e. DEPT|ALL) : TEST
Enter Display rows Name (i.e. 20) :

no rows selected
</code></pre>
<p>表空间的使用率也降下来了。</p>
<pre><code class="language-plain_text">SQL&gt; @db_size.sql
*******************tablespace size**************************

Tablespace                                                    Size (MB)  Free (MB)     % Free     % Used
------------------------------------------------------------ ---------- ---------- ---------- ----------
TEST                                                              11264      11253        100         .1
TEMP                                                                224        190         85      15.18
UNDOTBS1                                                            995     542.75         55      45.45
UNDOTBS2                                                             25    13.1875         53      47.25
USERS                                                             18.75     2.0625         11         89
SYSTEM                                                            13618   945.1875          7      93.06
SYSAUX                                                             1140    51.5625          5      95.48
</code></pre>
<p>上面的现象跟朋友说的一模一样了，临时段，表空间使用率增加后又恢复正常。</p>
<h2><a id="%E8%A7%A3%E6%9E%90%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>解析归档日志</h2>
<pre><code class="language-plain_text">SQL&gt; @logmnr_arch.sql '2025-08-23 23:03:57' '2025-08-23 23:04:53' 'Y'
Starting LogMiner...
LogMiner started successfully.
</code></pre>
<p>这里通过脚本来解析归档日志，查询解析记录，可以得到下面这条唯一的SQL语句。</p>
<pre><code class="language-plain_text">SQL_REDO
--------------------------------------------------------------------------------
update "SYS"."SEG$" set "TYPE#" = '3', "BLOCKS" = '8', "EXTENTS" = '1', "INIEXTS
" = '8', "MINEXTS" = '1', "MAXEXTS" = '2147483645', "EXTSIZE" = '128', "EXTPCT"
= '0', "USER#" = '0', "LISTS" = '0', "GROUPS" = '0', "BITMAPRANGES" = '214748364
5', "CACHEHINT" = '0', "SCANHINT" = '0', "HWMINCR" = '77446', "SPARE1" = '419456
1' where "FILE#" = '13' and "BLOCK#" = '130' and "TYPE#" = '3' and "TS#" = '6' a
nd "BLOCKS" = '8' and "EXTENTS" = '1' and "INIEXTS" = '8' and "MINEXTS" = '1' an
d "MAXEXTS" = '2147483645' and "EXTSIZE" = '128' and "EXTPCT" = '0' and "USER#"
= '0' and "LISTS" = '0' and "GROUPS" = '0' and "BITMAPRANGES" = '2147483645' and
 "CACHEHINT" = '0' and "SCANHINT" = '0' and "HWMINCR" = '77446' and "SPARE1" = '
4325633' and "SPARE2" IS NULL and ROWID = 'AAAAAIAABAAAMgSAAj';
</code></pre>
<p>前面的13.130这个名字就是由FILE#.BLOCK#构成的。</p>
<h2><a id="%E7%BB%93%E6%9D%9F" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>结束</h2>
<p>到这里面我们基本演示朋友说到这个案例的现象，在这个现象背后其实有一个Oracle的基础知识就是create table  as select 这种方式创建表时，Oracle是先创建临时段，临时段创建成功后，Oracle才会去做rename的操作和表定义的信息，这里可以通过去解析归档日志可以获得更多详细的信息。</p>
<p>------------------作者介绍-----------------------<br>
姓名：黄廷忠<br>
现就职：Oracle中国高级服务团队<br>
曾就职：OceanBase、云和恩墨、东方龙马等<br>
电话、微信、QQ：18081072613<br>
<a href="http://www.htz.pw" rel="noopener nofollow">个人博客:</a> (<a href="http://www.htz.pw" rel="noopener nofollow">http://www.htz.pw</a>)<br>
<a href="https://blog.csdn.net/wwwhtzpw" rel="noopener nofollow">CSDN地址:</a> (<a href="https://blog.csdn.net/wwwhtzpw" rel="noopener nofollow">https://blog.csdn.net/wwwhtzpw</a>)<br>
<a href="https://www.cnblogs.com/www-htz-pw">博客园地址:</a> (<a href="https://www.cnblogs.com/www-htz-pw">https://www.cnblogs.com/www-htz-pw</a>)<br>
<img alt="" data-src="http://htzaliyun.cdhtz.com/uPic/Y44TWC.png" class="lazyload"></p>
<hr>

</div>
<div id="MySignature" role="contentinfo">
    提供ORACLE技术支持(系统优化，故障处理，安装升级，数据恢复等） TEL:18081072613，微信、QQ同手机号。
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.03888888888888889" data-date-updated="2025-08-23 19:51">2025-08-23 18:55</span>&nbsp;
<a href="https://www.cnblogs.com/www-htz-pw">认真就输</a>&nbsp;
阅读(<span id="post_view_count">29</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19054691);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19054691', targetLink: 'https://www.cnblogs.com/www-htz-pw/p/19054691/gu-zhang-chu-lioracle-biao-kong-jian-yi-chang-zeng', title: '故障处理：Oracle表空间异常增长后又恢复正常的故障模拟与分析' })">举报</a>
</div>
        