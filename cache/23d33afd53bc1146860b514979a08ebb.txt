
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/fanliang11/p/18832641" title="发布于 2025-04-18 12:28">
    <span role="heading" aria-level="2">.net clr 8年才修复的BUG，你让我损失太多了</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1 class="postTitle">一、概述</h1>
<p>&nbsp;&nbsp;&nbsp; .NET社区修复问题可谓是龟速，一个BUG在.NET 7.0+版本才修复，你让我损失了几万块，我现在还记得客户那种质疑的表情，你了解那种尬尴的气氛吗？你让我一度怀疑dotnetty,我从来不去怀疑框架，运行时，每次碰到问题，我先提醒使用者先去找自己的问题，现在让我改变了这个看法。</p>
<p>&nbsp;&nbsp; 凯亚 (Kayak) 是什么?</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 凯亚(Kayak)是基于.NET6.0软件环境下的surging微服务引擎进行开发的, 平台包含了微服务和物联网平台。支持异步和响应式编程开发，功能包含了物模型,设备,产品,网络组件的统一管理和微服务平台下的注册中心，服务路由，模块，中间服务等管理。还有多协议适配(TCP,MQTT,UDP,CoAP,HTTP,Grpc,websocket,rtmp,httpflv,webservice,等),通过灵活多样的配置适配能够接入不同厂家不同协议等设备。并且通过设备告警,消息通知,数据可视化等功能。能够让你能快速建立起微服务物联网平台系统。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 凯亚物联网平台：<a href="http://117.72.121.2:3100" rel="noopener nofollow" target="_blank">http://117.72.121.2:3100</a>（用户名：fanly&nbsp; 密码：123456）</p>
<p>&nbsp; &nbsp; 链路跟踪Skywalking V8:<a href="http://117.72.121.2:8080/" rel="noopener nofollow" target="_blank">http://117.72.121.2:8080/</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; surging 微服务引擎开源地址：<a href="https://github.com/fanliang11/surging" rel="noopener nofollow" target="_blank">https://github.com/fanliang11/surging</a>（后面surging 会移动到<a href="https://github.com/microsurging/" rel="noopener nofollow" target="_blank">microsurging</a>进行维护）</p>
<p>&nbsp;</p>
<h2 class="postTitle">二、压测分析</h2>
<p>通过jmeter分析，高并发是没问题的，带宽一直是跑满的。</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418115940817-830891046.png" alt="" loading="lazy"></p>
<p>&nbsp;内存也没问题</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418120122382-1830830173.png" alt=""></p>
<p>但是你会发现，运行11天后内存就增长到1g多，每天要增长100多mb</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418120457778-1430232116.png" alt="" loading="lazy"></p>
<h2>&nbsp;三、用dump 分析</h2>
<p>用vs 分析指出是dotnetty 的 ManualResetEventSlim 导致的，但是我看了代码没有问题啊，让我思绪有些混乱，就让我手足无措，甚至想下载dotnetty 把ManualResetEventSlim去掉试试，后面我发现<a class="AppHeader-context-item" href="https://github.com/mono/mono" data-analytics-event="{&quot;category&quot;:&quot;SiteHeaderComponent&quot;,&quot;action&quot;:&quot;context_region_crumb&quot;,&quot;label&quot;:&quot;mono&quot;,&quot;screen_size&quot;:&quot;full&quot;}" data-view-component="true" rel="noopener nofollow"><span class="AppHeader-context-item-label  ">mono</span></a>社区有人讨论ManualResetEventSlim内存泄漏的问题，还是2020年提出的，一直没解决，后面2023年有人重提这个问题，有人回复这个问题是由于<code class="notranslate">Queue</code>删除队列没有把元素的引用一起删除导致的内存泄漏，而后在.NET 7.0把这个问题修复了。</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418120901968-1691646403.png" alt="" loading="lazy"></p>
<p>&nbsp;原帖讨论：<a href="https://github.com/mono/mono/issues/19665" target="_blank" rel="noopener nofollow">https://github.com/mono/mono/issues/19665</a></p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418121640857-1183456389.png" alt="" loading="lazy"></p>
<p>&nbsp;有人找到原因，在.NET CORE3.1 问题依旧存在</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418121820064-1438361032.png" alt="" loading="lazy"></p>
<p>&nbsp;2023年重提这个问题</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418122223898-821652105.png" alt="" loading="lazy"></p>
<p>&nbsp;然后给出回复是.NET7.0 已经修复</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418122332543-394519771.png" alt="" loading="lazy"></p>
<p>&nbsp;然后surging和kayak 升级到.NET 8.0 ,启用几十个组件和协议，内存在70，80MB左右。后续观察内存是否还会增长</p>
<p><img src="https://img2024.cnblogs.com/blog/192878/202504/192878-20250418122706066-1712203500.png" alt="" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.7411216538541666" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2025-04-18 12:28">2025-04-18 12:28</span>&nbsp;
<a href="https://www.cnblogs.com/fanliang11">fanly11</a>&nbsp;
阅读(<span id="post_view_count">901</span>)&nbsp;
评论(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(18832641);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '18832641', targetLink: 'https://www.cnblogs.com/fanliang11/p/18832641', title: '.net clr 8年才修复的BUG，你让我损失太多了' })">举报</a>
</div>
        