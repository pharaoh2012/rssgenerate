
<table cellspacing="0" cellpadding="0"><tbody><tr><td class="t_f" id="postmessage_52506233">
<i class="pstatus"> 本帖最后由 cangou 于 2025-3-3 17:18 编辑 </i><br>
<br>
<strong><strong>【原创教程】OpenWRT安装MOSDNS实现智能DNS解析 | 附配置详解</strong></strong><hr class="l"><strong><strong>&amp;#128204; 工具简介</strong></strong><strong>MOSDNS</strong> 是一款轻量级DNS转发/分流工具，支持DoH/DoT、域名规则分流、缓存加速等，适合在OpenWRT路由器上实现国内外域名解析优化。<hr class="l"><strong><strong>&amp;#9196; 一、安装MOSDNS</strong></strong><strong>适用环境</strong>：OpenWRT 21.02+（x86/ARM架构均支持）<strong><strong>1. 下载对应架构的IPK文件</strong></strong>访问MOSDNS GitHub Releases页面：<br>
<font style="color:rgba(124, 58, 237, 0.7)"><a rel="nofollow noopener" href="https://github.com/kkkgo/mosdns/releases" target="_blank">https://github.com/kkkgo/mosdns/releases</a></font><br>
根据路由器CPU架构选择对应版本（常见架构）：<ul><li>x86_64：mosdns_xx.x.x_linux_amd64.ipk</li><li>aarch64：mosdns_xx.x.x_linux_arm64.ipk<br>
</li></ul>（截图位置：GitHub下载页面示意图）<strong><strong>2. 上传IPK文件至路由器</strong></strong>使用WinSCP或SSH工具将IPK文件上传至/tmp目录：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">scp mosdns_xx.x.x_linux_amd64.ipk [email]root@192.168.1.1[/email]:/tmp/</pre></div><strong><strong>3. SSH安装</strong></strong>登录路由器SSH，执行以下命令：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">opkg update
opkg install /tmp/mosdns_xx.x.x_linux_amd64.ipk</pre></div>（截图位置：SSH安装成功界面）<hr class="l"><strong><strong>&amp;#9881;&amp;#65039; 二、基础配置</strong></strong><strong><strong>1. 创建配置文件</strong></strong>编辑配置文件/etc/mosdns/config.yaml：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
yaml<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true"># 基础监听设置
listen:
  - protocol: udp
    addr: ":5353"  # 监听端口（避免与Dnsmasq冲突）
  - protocol: tcp
    addr: ":5353"

# 上游DNS服务器
upstream:
  - tag: local_dns
    addr: "udp://223.5.5.5"  # 国内DNS
  - tag: foreign_dns
    addr: "tcp://8.8.8.8"    # 国外DNS

# 缓存设置
cache:
  size: 2000
  lazy_cache_ttl: 86400

# 域名分流规则
rules:
  - type: query_matcher
    args:
      - type: geosite
        keyword: cn
    server: local_dns
  - server: foreign_dns</pre></div><strong><strong>2. 设置开机启动</strong></strong>创建Init脚本/etc/init.d/mosdns：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

start_service() {
    procd_open_instance
    procd_set_param command /usr/bin/mosdns -c /etc/mosdns/config.yaml
    procd_set_param respawn
    procd_close_instance
}</pre></div>赋予执行权限：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">chmod +x /etc/init.d/mosdns
/etc/init.d/mosdns enable
/etc/init.d/mosdns start</pre></div>（截图位置：配置文件与服务状态截图）<hr class="l"><strong><strong>&amp;#128295; 三、OpenWRT联动设置</strong></strong><strong><strong>1. 修改Dnsmasq配置</strong></strong>编辑/etc/dnsmasq.conf，指向MOSDNS：<font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font>no-resolvserver=127.0.0.1<font style="color:rgb(106, 115, 125)">#5353&nbsp;&nbsp;# 使用MOSDNS作为上游</font><strong><strong>2. 重启服务</strong></strong><font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">/etc/init.d/dnsmasq restart
/etc/init.d/mosdns restart</pre></div><hr class="l"><strong><strong>&amp;#128736;&amp;#65039; 四、验证与使用</strong></strong><strong><strong>1. 检查服务状态</strong></strong><font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">netstat -tuln | grep 5353  # 确认端口监听
logread | grep mosdns      # 查看日志</pre></div><strong><strong>2. 测试解析</strong></strong><font style="color:rgb(48, 49, 51)"><font style="background-color:rgb(242, 243, 245)"><font style="font-size:14px"><br>
bash<br>
复制代码</font></font></font><div style="padding:15px 0;"><div style="font-size:12px;">[Asm] <em class="viewsource" style="cursor:pointer;font-size:12px;color:#369 !important;">纯文本查看</em> <em class="copycode" style="cursor:pointer;font-size:12px;color:#369 !important;">复制代码</em></div><pre class="brush: asm; gutter: true">nslookup google.com 127.0.0.1 -port=5353</pre></div>（截图位置：nslookup测试结果）<hr class="l"><strong><strong>&amp;#10071; 常见问题</strong></strong><ul type="1" class="litype_1"><li><strong>端口冲突</strong>：若Dnsmasq已占用53端口，需确保MOSDNS监听其他端口（如5353）。</li><li><strong>规则不生效</strong>：检查geosite:cn数据集是否缺失，可从 <font style="color:rgba(124, 58, 237, 0.7)"><a rel="nofollow noopener" href="https://github.com/v2fly/domain-list-community" target="_blank">v2fly/domain-list-community</a></font> 下载。</li><li><strong>性能优化</strong>：根据内存调整cache.size值，避免占用过高。<br>
</li></ul><hr class="l"><strong><strong>&amp;#128279; 相关资源</strong></strong><ul><li>MOSDNS官方文档：<font style="color:rgba(124, 58, 237, 0.7)"><a rel="nofollow noopener" href="https://github.com/kkkgo/mosdns/wiki" target="_blank">https://github.com/kkkgo/mosdns/wiki</a></font></li><li>OpenWRT Wiki：<font style="color:rgb(124, 58, 237)"><a rel="nofollow noopener" href="https://openwrt.org/docs" target="_blank">https://openwrt.org/docs</a></font><br>
</li></ul><hr class="l"><strong>&amp;#10067; 互动提问</strong><br>
你在使用MOSDNS时遇到过哪些问题？欢迎回帖讨论！</td></tr></tbody></table>


